<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyramid.authentication &mdash; The Pyramid Web Framework v1.5</title>
    
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="The Pyramid Web Framework v1.5" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<link rel="stylesheet" href="http://static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head>
  <body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.5</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pyramid.authentication</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="n">utf_8_decode</span>
<span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="n">utf_8_encode</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="kn">as</span> <span class="nn">time_mod</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">webob.cookies</span> <span class="kn">import</span> <span class="n">CookieProfile</span>

<span class="kn">from</span> <span class="nn">pyramid.compat</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="nb">long</span><span class="p">,</span>
    <span class="n">text_type</span><span class="p">,</span>
    <span class="n">binary_type</span><span class="p">,</span>
    <span class="n">url_unquote</span><span class="p">,</span>
    <span class="n">url_quote</span><span class="p">,</span>
    <span class="n">bytes_</span><span class="p">,</span>
    <span class="n">ascii_native_</span><span class="p">,</span>
    <span class="n">native_</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.interfaces</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IAuthenticationPolicy</span><span class="p">,</span>
    <span class="n">IDebugLogger</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Authenticated</span><span class="p">,</span>
    <span class="n">Everyone</span><span class="p">,</span>
    <span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyramid.util</span> <span class="kn">import</span> <span class="n">strings_differ</span>

<span class="n">VALID_TOKEN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^[A-Za-z][A-Za-z0-9+_-]*$&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CallbackAuthenticationPolicy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Abstract class &quot;&quot;&quot;</span>

    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">callback</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">methodname</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">queryUtility</span><span class="p">(</span><span class="n">IDebugLogger</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>
            <span class="n">classname</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span>
            <span class="n">methodname</span> <span class="o">=</span> <span class="n">classname</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">methodname</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">methodname</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_principal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">princid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">princid</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Authenticated</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">):</span>
            <span class="n">princid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">princid</span>

    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the authenticated userid or ``None``.</span>

<span class="sd">        If no callback is registered, this will be the same as</span>
<span class="sd">        ``unauthenticated_userid``.</span>

<span class="sd">        If a ``callback`` is registered, this will return the userid if</span>
<span class="sd">        and only if the callback returns a value that is not ``None``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
        <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unauthenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;call to unauthenticated_userid returned None; returning None&#39;</span><span class="p">,</span>
                <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_principal</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;use of userid </span><span class="si">%r</span><span class="s"> is disallowed by any built-in Pyramid &#39;</span>
                 <span class="s">&#39;security policy, returning None&#39;</span> <span class="o">%</span> <span class="n">userid</span><span class="p">),</span>
                <span class="s">&#39;authenticated_userid&#39;</span> <span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;there was no groupfinder callback; returning </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">userid</span><span class="p">,),</span>
                <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">userid</span>
        <span class="n">callback_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback_ok</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># is not None!</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;groupfinder callback returned </span><span class="si">%r</span><span class="s">; returning </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">callback_ok</span><span class="p">,</span> <span class="n">userid</span><span class="p">),</span>
                <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">userid</span>
        <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="s">&#39;groupfinder callback returned None; returning None&#39;</span><span class="p">,</span>
            <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
            <span class="n">request</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A list of effective principals derived from request.</span>

<span class="sd">        This will return a list of principals including, at least,</span>
<span class="sd">        :data:`pyramid.security.Everyone`. If there is no authenticated</span>
<span class="sd">        userid, or the ``callback`` returns ``None``, this will be the</span>
<span class="sd">        only principal:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            return [Everyone]</span>

<span class="sd">        If the ``callback`` does not return ``None`` and an authenticated</span>
<span class="sd">        userid is found, then the principals will include</span>
<span class="sd">        :data:`pyramid.security.Authenticated`, the ``authenticated_userid``</span>
<span class="sd">        and the list of principals returned by the ``callback``:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            extra_principals = callback(userid, request)</span>
<span class="sd">            return [Everyone, Authenticated, userid] + extra_principals</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
        <span class="n">effective_principals</span> <span class="o">=</span> <span class="p">[</span><span class="n">Everyone</span><span class="p">]</span>
        <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unauthenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;unauthenticated_userid returned </span><span class="si">%r</span><span class="s">; returning </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">userid</span><span class="p">,</span> <span class="n">effective_principals</span><span class="p">),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_principal</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;unauthenticated_userid returned disallowed </span><span class="si">%r</span><span class="s">; returning </span><span class="si">%r</span><span class="s"> &#39;</span>
                 <span class="s">&#39;as if it was None&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">effective_principals</span><span class="p">)),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;groupfinder callback is None, so groups is []&#39;</span><span class="p">,</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;groupfinder callback returned </span><span class="si">%r</span><span class="s"> as groups&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">groups</span><span class="p">,),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># is None!</span>
            <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;returning effective principals: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">effective_principals</span><span class="p">,),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>

        <span class="n">effective_principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Authenticated</span><span class="p">)</span>
        <span class="n">effective_principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
        <span class="n">effective_principals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

        <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="s">&#39;returning effective principals: </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">effective_principals</span><span class="p">,),</span>
            <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
            <span class="n">request</span>
             <span class="p">)</span>
        <span class="k">return</span> <span class="n">effective_principals</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthenticationPolicy</span><span class="p">)</span>
<div class="viewcode-block" id="RepozeWho1AuthenticationPolicy"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RepozeWho1AuthenticationPolicy">[docs]</a><span class="k">class</span> <span class="nc">RepozeWho1AuthenticationPolicy</span><span class="p">(</span><span class="n">CallbackAuthenticationPolicy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A :app:`Pyramid` :term:`authentication policy` which</span>
<span class="sd">    obtains data from the :mod:`repoze.who` 1.X WSGI &#39;API&#39; (the</span>
<span class="sd">    ``repoze.who.identity`` key in the WSGI environment).</span>

<span class="sd">    Constructor Arguments</span>

<span class="sd">    ``identifier_name``</span>

<span class="sd">       Default: ``auth_tkt``.  The :mod:`repoze.who` plugin name that</span>
<span class="sd">       performs remember/forget.  Optional.</span>

<span class="sd">    ``callback``</span>

<span class="sd">        Default: ``None``.  A callback passed the :mod:`repoze.who` identity</span>
<span class="sd">        and the :term:`request`, expected to return ``None`` if the user</span>
<span class="sd">        represented by the identity doesn&#39;t exist or a sequence of principal</span>
<span class="sd">        identifiers (possibly empty) representing groups if the user does</span>
<span class="sd">        exist.  If ``callback`` is None, the userid will be assumed to exist</span>
<span class="sd">        with no group principals.</span>

<span class="sd">    Objects of this class implement the interface described by</span>
<span class="sd">    :class:`pyramid.interfaces.IAuthenticationPolicy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_name</span><span class="o">=</span><span class="s">&#39;auth_tkt&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifier_name</span> <span class="o">=</span> <span class="n">identifier_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>

    <span class="k">def</span> <span class="nf">_get_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;repoze.who.identity&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;repoze.who.plugins&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plugins</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">plugins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">identifier</span>

<div class="viewcode-block" id="RepozeWho1AuthenticationPolicy.authenticated_userid"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RepozeWho1AuthenticationPolicy.authenticated_userid">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the authenticated userid or ``None``.</span>

<span class="sd">        If no callback is registered, this will be the same as</span>
<span class="sd">        ``unauthenticated_userid``.</span>

<span class="sd">        If a ``callback`` is registered, this will return the userid if</span>
<span class="sd">        and only if the callback returns a value that is not ``None``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">identity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;repoze.who identity is None, returning None&#39;</span><span class="p">,</span>
                <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">userid</span> <span class="o">=</span> <span class="n">identity</span><span class="p">[</span><span class="s">&#39;repoze.who.userid&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="s">&#39;repoze.who.userid is None, returning None&#39;</span> <span class="o">%</span> <span class="n">userid</span><span class="p">,</span>
                <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_principal</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;use of userid </span><span class="si">%r</span><span class="s"> is disallowed by any built-in Pyramid &#39;</span>
                 <span class="s">&#39;security policy, returning None&#39;</span> <span class="o">%</span> <span class="n">userid</span><span class="p">),</span>
                <span class="s">&#39;authenticated_userid&#39;</span><span class="p">,</span>
                <span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">userid</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># is not None!</span>
            <span class="k">return</span> <span class="n">userid</span>
</div>
<div class="viewcode-block" id="RepozeWho1AuthenticationPolicy.unauthenticated_userid"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RepozeWho1AuthenticationPolicy.unauthenticated_userid">[docs]</a>    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the ``repoze.who.userid`` key from the detected identity.&quot;&quot;&quot;</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">identity</span><span class="p">[</span><span class="s">&#39;repoze.who.userid&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="RepozeWho1AuthenticationPolicy.effective_principals"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RepozeWho1AuthenticationPolicy.effective_principals">[docs]</a>    <span class="k">def</span> <span class="nf">effective_principals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A list of effective principals derived from the identity.</span>

<span class="sd">        This will return a list of principals including, at least,</span>
<span class="sd">        :data:`pyramid.security.Everyone`. If there is no identity, or</span>
<span class="sd">        the ``callback`` returns ``None``, this will be the only principal.</span>

<span class="sd">        If the ``callback`` does not return ``None`` and an identity is</span>
<span class="sd">        found, then the principals will include</span>
<span class="sd">        :data:`pyramid.security.Authenticated`, the ``authenticated_userid``</span>
<span class="sd">        and the list of principals returned by the ``callback``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">effective_principals</span> <span class="o">=</span> <span class="p">[</span><span class="n">Everyone</span><span class="p">]</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">identity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;repoze.who identity was None; returning </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                 <span class="n">effective_principals</span><span class="p">),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># is None!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;security policy groups callback returned None; returning </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                 <span class="n">effective_principals</span><span class="p">),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>

        <span class="n">userid</span> <span class="o">=</span> <span class="n">identity</span><span class="p">[</span><span class="s">&#39;repoze.who.userid&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;repoze.who.userid was None; returning </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                 <span class="n">effective_principals</span><span class="p">),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_principal</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;unauthenticated_userid returned disallowed </span><span class="si">%r</span><span class="s">; returning </span><span class="si">%r</span><span class="s"> &#39;</span>
                 <span class="s">&#39;as if it was None&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">effective_principals</span><span class="p">)),</span>
                <span class="s">&#39;effective_principals&#39;</span><span class="p">,</span>
                <span class="n">request</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">effective_principals</span>

        <span class="n">effective_principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Authenticated</span><span class="p">)</span>
        <span class="n">effective_principals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
        <span class="n">effective_principals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">effective_principals</span>
</div>
<div class="viewcode-block" id="RepozeWho1AuthenticationPolicy.remember"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RepozeWho1AuthenticationPolicy.remember">[docs]</a>    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store the ``principal`` as ``repoze.who.userid``.</span>
<span class="sd">        </span>
<span class="sd">        The identity to authenticated to :mod:`repoze.who`</span>
<span class="sd">        will contain the given principal as ``userid``, and</span>
<span class="sd">        provide all keyword arguments as additional identity</span>
<span class="sd">        keys. Useful keys could be ``max_age`` or ``userdata``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identifier</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">kw</span>
        <span class="n">identity</span><span class="p">[</span><span class="s">&#39;repoze.who.userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="o">.</span><span class="n">remember</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RepozeWho1AuthenticationPolicy.forget"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RepozeWho1AuthenticationPolicy.forget">[docs]</a>    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Forget the current authenticated user.</span>

<span class="sd">        Return headers that, if included in a response, will delete the</span>
<span class="sd">        cookie responsible for tracking the current user.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identifier</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_identity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="o">.</span><span class="n">forget</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
</div></div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthenticationPolicy</span><span class="p">)</span>
<div class="viewcode-block" id="RemoteUserAuthenticationPolicy"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RemoteUserAuthenticationPolicy">[docs]</a><span class="k">class</span> <span class="nc">RemoteUserAuthenticationPolicy</span><span class="p">(</span><span class="n">CallbackAuthenticationPolicy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A :app:`Pyramid` :term:`authentication policy` which</span>
<span class="sd">    obtains data from the ``REMOTE_USER`` WSGI environment variable.</span>

<span class="sd">    Constructor Arguments</span>

<span class="sd">    ``environ_key``</span>

<span class="sd">        Default: ``REMOTE_USER``.  The key in the WSGI environ which</span>
<span class="sd">        provides the userid.</span>

<span class="sd">    ``callback``</span>

<span class="sd">        Default: ``None``.  A callback passed the userid and the request,</span>
<span class="sd">        expected to return None if the userid doesn&#39;t exist or a sequence of</span>
<span class="sd">        principal identifiers (possibly empty) representing groups if the</span>
<span class="sd">        user does exist.  If ``callback`` is None, the userid will be assumed</span>
<span class="sd">        to exist with no group principals.</span>

<span class="sd">    ``debug``</span>

<span class="sd">        Default: ``False``.  If ``debug`` is ``True``, log messages to the</span>
<span class="sd">        Pyramid debug logger about the results of various authentication</span>
<span class="sd">        steps.  The output from debugging is useful for reporting to maillist</span>
<span class="sd">        or IRC channels when asking for support.</span>

<span class="sd">    Objects of this class implement the interface described by</span>
<span class="sd">    :class:`pyramid.interfaces.IAuthenticationPolicy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ_key</span><span class="o">=</span><span class="s">&#39;REMOTE_USER&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ_key</span> <span class="o">=</span> <span class="n">environ_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

<div class="viewcode-block" id="RemoteUserAuthenticationPolicy.unauthenticated_userid"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RemoteUserAuthenticationPolicy.unauthenticated_userid">[docs]</a>    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The ``REMOTE_USER`` value found within the ``environ``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ_key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RemoteUserAuthenticationPolicy.remember"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RemoteUserAuthenticationPolicy.remember">[docs]</a>    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A no-op. The ``REMOTE_USER`` does not provide a protocol for</span>
<span class="sd">        remembering the user. This will be application-specific and can</span>
<span class="sd">        be done somewhere else or in a subclass.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="RemoteUserAuthenticationPolicy.forget"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.RemoteUserAuthenticationPolicy.forget">[docs]</a>    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A no-op. The ``REMOTE_USER`` does not provide a protocol for</span>
<span class="sd">        forgetting the user. This will be application-specific and can</span>
<span class="sd">        be done somewhere else or in a subclass.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
</div></div>
<span class="n">_marker</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthenticationPolicy</span><span class="p">)</span>
<div class="viewcode-block" id="AuthTktAuthenticationPolicy"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy">[docs]</a><span class="k">class</span> <span class="nc">AuthTktAuthenticationPolicy</span><span class="p">(</span><span class="n">CallbackAuthenticationPolicy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A :app:`Pyramid` :term:`authentication policy` which</span>
<span class="sd">    obtains data from a Pyramid &quot;auth ticket&quot; cookie.</span>

<span class="sd">    .. warning::</span>

<span class="sd">       The default hash algorithm used in this policy is MD5 and has known</span>
<span class="sd">       hash collision vulnerabilities. The risk of an exploit is low.</span>
<span class="sd">       However, for improved authentication security, use</span>
<span class="sd">       ``hashalg=&#39;sha512&#39;``.</span>

<span class="sd">    Constructor Arguments</span>

<span class="sd">    ``secret``</span>

<span class="sd">       The secret (a string) used for auth_tkt cookie signing.  This value</span>
<span class="sd">       should be unique across all values provided to Pyramid for various</span>
<span class="sd">       subsystem secrets (see :ref:`admonishment_against_secret_sharing`).</span>
<span class="sd">       Required.</span>

<span class="sd">    ``callback``</span>

<span class="sd">       Default: ``None``.  A callback passed the userid and the</span>
<span class="sd">       request, expected to return ``None`` if the userid doesn&#39;t</span>
<span class="sd">       exist or a sequence of principal identifiers (possibly empty) if</span>
<span class="sd">       the user does exist.  If ``callback`` is ``None``, the userid</span>
<span class="sd">       will be assumed to exist with no principals.  Optional.</span>

<span class="sd">    ``cookie_name``</span>

<span class="sd">       Default: ``auth_tkt``.  The cookie name used</span>
<span class="sd">       (string).  Optional.</span>

<span class="sd">    ``secure``</span>

<span class="sd">       Default: ``False``.  Only send the cookie back over a secure</span>
<span class="sd">       conn.  Optional.</span>

<span class="sd">    ``include_ip``</span>

<span class="sd">       Default: ``False``.  Make the requesting IP address part of</span>
<span class="sd">       the authentication data in the cookie.  Optional.</span>

<span class="sd">       For IPv6 this option is not recommended. The ``mod_auth_tkt``</span>
<span class="sd">       specification does not specify how to handle IPv6 addresses, so using</span>
<span class="sd">       this option in combination with IPv6 addresses may cause an</span>
<span class="sd">       incompatible cookie. It ties the authentication ticket to that</span>
<span class="sd">       individual&#39;s IPv6 address.</span>

<span class="sd">    ``timeout``</span>

<span class="sd">       Default: ``None``.  Maximum number of seconds which a newly</span>
<span class="sd">       issued ticket will be considered valid.  After this amount of</span>
<span class="sd">       time, the ticket will expire (effectively logging the user</span>
<span class="sd">       out).  If this value is ``None``, the ticket never expires.</span>
<span class="sd">       Optional.</span>

<span class="sd">    ``reissue_time``</span>

<span class="sd">       Default: ``None``.  If this parameter is set, it represents the number</span>
<span class="sd">       of seconds that must pass before an authentication token cookie is</span>
<span class="sd">       automatically reissued as the result of a request which requires</span>
<span class="sd">       authentication.  The duration is measured as the number of seconds</span>
<span class="sd">       since the last auth_tkt cookie was issued and &#39;now&#39;.  If this value is</span>
<span class="sd">       ``0``, a new ticket cookie will be reissued on every request which</span>
<span class="sd">       requires authentication.</span>

<span class="sd">       A good rule of thumb: if you want auto-expired cookies based on</span>
<span class="sd">       inactivity: set the ``timeout`` value to 1200 (20 mins) and set the</span>
<span class="sd">       ``reissue_time`` value to perhaps a tenth of the ``timeout`` value</span>
<span class="sd">       (120 or 2 mins).  It&#39;s nonsensical to set the ``timeout`` value lower</span>
<span class="sd">       than the ``reissue_time`` value, as the ticket will never be reissued</span>
<span class="sd">       if so.  However, such a configuration is not explicitly prevented.</span>

<span class="sd">       Optional.</span>

<span class="sd">    ``max_age``</span>

<span class="sd">       Default: ``None``.  The max age of the auth_tkt cookie, in</span>
<span class="sd">       seconds.  This differs from ``timeout`` inasmuch as ``timeout``</span>
<span class="sd">       represents the lifetime of the ticket contained in the cookie,</span>
<span class="sd">       while this value represents the lifetime of the cookie itself.</span>
<span class="sd">       When this value is set, the cookie&#39;s ``Max-Age`` and</span>
<span class="sd">       ``Expires`` settings will be set, allowing the auth_tkt cookie</span>
<span class="sd">       to last between browser sessions.  It is typically nonsensical</span>
<span class="sd">       to set this to a value that is lower than ``timeout`` or</span>
<span class="sd">       ``reissue_time``, although it is not explicitly prevented.</span>
<span class="sd">       Optional.</span>

<span class="sd">    ``path``</span>

<span class="sd">       Default: ``/``. The path for which the auth_tkt cookie is valid.</span>
<span class="sd">       May be desirable if the application only serves part of a domain.</span>
<span class="sd">       Optional.</span>

<span class="sd">    ``http_only``</span>

<span class="sd">       Default: ``False``. Hide cookie from JavaScript by setting the</span>
<span class="sd">       HttpOnly flag. Not honored by all browsers.</span>
<span class="sd">       Optional.</span>

<span class="sd">    ``wild_domain``</span>

<span class="sd">       Default: ``True``. An auth_tkt cookie will be generated for the</span>
<span class="sd">       wildcard domain. If your site is hosted as ``example.com`` this</span>
<span class="sd">       will make the cookie available for sites underneath ``example.com``</span>
<span class="sd">       such as ``www.example.com``.</span>
<span class="sd">       Optional.</span>

<span class="sd">    ``parent_domain``</span>

<span class="sd">       Default: ``False``. An auth_tkt cookie will be generated for the</span>
<span class="sd">       parent domain of the current site. For example if your site is</span>
<span class="sd">       hosted under ``www.example.com`` a cookie will be generated for</span>
<span class="sd">       ``.example.com``. This can be useful if you have multiple sites</span>
<span class="sd">       sharing the same domain. This option supercedes the ``wild_domain``</span>
<span class="sd">       option.</span>
<span class="sd">       Optional.</span>

<span class="sd">       This option is available as of :app:`Pyramid` 1.5.</span>

<span class="sd">    ``domain``</span>

<span class="sd">       Default: ``None``. If provided the auth_tkt cookie will only be</span>
<span class="sd">       set for this domain. This option is not compatible with ``wild_domain``</span>
<span class="sd">       and ``parent_domain``.</span>
<span class="sd">       Optional.</span>

<span class="sd">       This option is available as of :app:`Pyramid` 1.5.</span>

<span class="sd">    ``hashalg``</span>

<span class="sd">       Default: ``md5`` (the literal string).</span>

<span class="sd">       Any hash algorithm supported by Python&#39;s ``hashlib.new()`` function</span>
<span class="sd">       can be used as the ``hashalg``.</span>

<span class="sd">       Cookies generated by different instances of AuthTktAuthenticationPolicy</span>
<span class="sd">       using different ``hashalg`` options are not compatible. Switching the</span>
<span class="sd">       ``hashalg`` will imply that all existing users with a valid cookie will</span>
<span class="sd">       be required to re-login.</span>

<span class="sd">       A warning is emitted at startup if an explicit ``hashalg`` is not</span>
<span class="sd">       passed.  This is for backwards compatibility reasons.</span>

<span class="sd">       This option is available as of :app:`Pyramid` 1.4.</span>

<span class="sd">       Optional.</span>

<span class="sd">       .. note::</span>

<span class="sd">          ``md5`` is the default for backwards compatibility reasons. However,</span>
<span class="sd">          if you don&#39;t specify ``md5`` as the hashalg explicitly, a warning is</span>
<span class="sd">          issued at application startup time.  An explicit value of ``sha512``</span>
<span class="sd">          is recommended for improved security, and ``sha512`` will become the</span>
<span class="sd">          default in a future Pyramid version.</span>

<span class="sd">    ``debug``</span>

<span class="sd">        Default: ``False``.  If ``debug`` is ``True``, log messages to the</span>
<span class="sd">        Pyramid debug logger about the results of various authentication</span>
<span class="sd">        steps.  The output from debugging is useful for reporting to maillist</span>
<span class="sd">        or IRC channels when asking for support.</span>

<span class="sd">    Objects of this class implement the interface described by</span>
<span class="sd">    :class:`pyramid.interfaces.IAuthenticationPolicy`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">secret</span><span class="p">,</span>
                 <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">cookie_name</span><span class="o">=</span><span class="s">&#39;auth_tkt&#39;</span><span class="p">,</span>
                 <span class="n">secure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">include_ip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">reissue_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_age</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span>
                 <span class="n">http_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">wild_domain</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">hashalg</span><span class="o">=</span><span class="n">_marker</span><span class="p">,</span>
                 <span class="n">parent_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">domain</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="k">if</span> <span class="n">hashalg</span> <span class="ow">is</span> <span class="n">_marker</span><span class="p">:</span>
            <span class="n">hashalg</span> <span class="o">=</span> <span class="s">&#39;md5&#39;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s">&#39;The MD5 hash function used by default by the &#39;</span>
                <span class="s">&#39;AuthTktAuthenticationPolicy is known to be &#39;</span>
                <span class="s">&#39;susceptible to collision attacks.  It is the current default &#39;</span>
                <span class="s">&#39;for backwards compatibility reasons, but we recommend that &#39;</span>
                <span class="s">&#39;you use the SHA512 algorithm instead for improved security.  &#39;</span>
                <span class="s">&#39;Pass ``hashalg=</span><span class="se">\&#39;</span><span class="s">sha512</span><span class="se">\&#39;</span><span class="s">`` to the &#39;</span>
                <span class="s">&#39;AuthTktAuthenticationPolicy constructor to do so.</span><span class="se">\n\n</span><span class="s">Note &#39;</span>
                <span class="s">&#39;that a change to the hash algorithms will invalidate existing &#39;</span>
                <span class="s">&#39;auth tkt cookies set by your application.  If backwards &#39;</span>
                <span class="s">&#39;compatibility of existing auth tkt cookies is of greater &#39;</span>
                <span class="s">&#39;concern than the risk posed by the potential for a hash &#39;</span>
                <span class="s">&#39;collision, you</span><span class="se">\&#39;</span><span class="s">ll want to continue using MD5 explicitly.  &#39;</span>
                <span class="s">&#39;To do so, pass ``hashalg=</span><span class="se">\&#39;</span><span class="s">md5</span><span class="se">\&#39;</span><span class="s">`` in your application to &#39;</span>
                <span class="s">&#39;the AuthTktAuthenticationPolicy constructor.   When you do so &#39;</span>
                <span class="s">&#39;this warning will not be emitted again.  The default &#39;</span>
                <span class="s">&#39;algorithm used in this policy will change in the future, so &#39;</span>
                <span class="s">&#39;setting an explicit hashalg will futureproof your &#39;</span>
                <span class="s">&#39;application.&#39;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">AuthTktCookieHelper</span><span class="p">(</span>
            <span class="n">secret</span><span class="p">,</span>
            <span class="n">cookie_name</span><span class="o">=</span><span class="n">cookie_name</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">,</span>
            <span class="n">include_ip</span><span class="o">=</span><span class="n">include_ip</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">reissue_time</span><span class="o">=</span><span class="n">reissue_time</span><span class="p">,</span>
            <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span>
            <span class="n">http_only</span><span class="o">=</span><span class="n">http_only</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">wild_domain</span><span class="o">=</span><span class="n">wild_domain</span><span class="p">,</span>
            <span class="n">hashalg</span><span class="o">=</span><span class="n">hashalg</span><span class="p">,</span>
            <span class="n">parent_domain</span><span class="o">=</span><span class="n">parent_domain</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

<div class="viewcode-block" id="AuthTktAuthenticationPolicy.unauthenticated_userid"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy.unauthenticated_userid">[docs]</a>    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The userid key within the auth_tkt cookie.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AuthTktAuthenticationPolicy.remember"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy.remember">[docs]</a>    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Accepts the following kw args: ``max_age=&lt;int-seconds&gt;,</span>
<span class="sd">        ``tokens=&lt;sequence-of-ascii-strings&gt;``.</span>

<span class="sd">        Return a list of headers which will set appropriate cookies on</span>
<span class="sd">        the response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span><span class="o">.</span><span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AuthTktAuthenticationPolicy.forget"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy.forget">[docs]</a>    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A list of headers which will delete appropriate cookies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie</span><span class="o">.</span><span class="n">forget</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</div></div>
<span class="k">def</span> <span class="nf">b64encode</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">bytes_</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">b64decode</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">bytes_</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<span class="c"># this class licensed under the MIT license (stolen from Paste)</span>
<span class="k">class</span> <span class="nc">AuthTicket</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents an authentication token.  You must pass in</span>
<span class="sd">    the shared secret, the userid, and the IP address.  Optionally you</span>
<span class="sd">    can include tokens (a list of strings, representing role names),</span>
<span class="sd">    &#39;user_data&#39;, which is arbitrary data available for your own use in</span>
<span class="sd">    later scripts.  Lastly, you can override the cookie name and</span>
<span class="sd">    timestamp.</span>

<span class="sd">    Once you provide all the arguments, use .cookie_value() to</span>
<span class="sd">    generate the appropriate authentication ticket.</span>

<span class="sd">    Usage::</span>

<span class="sd">        token = AuthTicket(&#39;sharedsecret&#39;, &#39;username&#39;,</span>
<span class="sd">            os.environ[&#39;REMOTE_ADDR&#39;], tokens=[&#39;admin&#39;])</span>
<span class="sd">        val = token.cookie_value()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="p">(),</span> <span class="n">user_data</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cookie_name</span><span class="o">=</span><span class="s">&#39;auth_tkt&#39;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">hashalg</span><span class="o">=</span><span class="s">&#39;md5&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userid</span> <span class="o">=</span> <span class="n">userid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span> <span class="o">=</span> <span class="n">cookie_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secure</span> <span class="o">=</span> <span class="n">secure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashalg</span> <span class="o">=</span> <span class="n">hashalg</span>

    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">calculate_digest</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashalg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cookie_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%08x%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digest</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                           <span class="n">url_quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userid</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">+</span> <span class="s">&#39;!&#39;</span>
        <span class="n">v</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_data</span>
        <span class="k">return</span> <span class="n">v</span>

<span class="c"># this class licensed under the MIT license (stolen from Paste)</span>
<span class="k">class</span> <span class="nc">BadTicket</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a ticket can&#39;t be parsed.  If we get far enough to</span>
<span class="sd">    determine what the expected digest should have been, expected is set.</span>
<span class="sd">    This should not be shown by default, but can be useful for debugging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<span class="c"># this function licensed under the MIT license (stolen from Paste)</span>
<span class="k">def</span> <span class="nf">parse_ticket</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">ticket</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s">&#39;md5&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the ticket, returning (timestamp, userid, tokens, user_data).</span>

<span class="sd">    If the ticket cannot be parsed, a ``BadTicket`` exception will be raised</span>
<span class="sd">    with an explanation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="n">ticket</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="n">digest_size</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hashalg</span><span class="p">)</span><span class="o">.</span><span class="n">digest_size</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">ticket</span><span class="p">[:</span><span class="n">digest_size</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticket</span><span class="p">[</span><span class="n">digest_size</span><span class="p">:</span><span class="n">digest_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadTicket</span><span class="p">(</span><span class="s">&#39;Timestamp is not a hex integer: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">userid</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ticket</span><span class="p">[</span><span class="n">digest_size</span> <span class="o">+</span> <span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadTicket</span><span class="p">(</span><span class="s">&#39;userid is not followed by !&#39;</span><span class="p">)</span>
    <span class="n">userid</span> <span class="o">=</span> <span class="n">url_unquote</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;!&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">tokens</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># pragma: no cover (never generated)</span>
        <span class="c"># @@: Is this the right order?</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="n">calculate_digest</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span>
                                <span class="n">userid</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">hashalg</span><span class="p">)</span>

    <span class="c"># Avoid timing attacks (see</span>
    <span class="c"># http://seb.dbzteam.org/crypto/python-oauth-timing-hmac.pdf)</span>
    <span class="k">if</span> <span class="n">strings_differ</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">digest</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadTicket</span><span class="p">(</span><span class="s">&#39;Digest signature is not correct&#39;</span><span class="p">,</span>
                        <span class="n">expected</span><span class="o">=</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">digest</span><span class="p">))</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span>

<span class="c"># this function licensed under the MIT license (stolen from Paste)</span>
<span class="k">def</span> <span class="nf">calculate_digest</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span>
                     <span class="n">hashalg</span><span class="o">=</span><span class="s">&#39;md5&#39;</span><span class="p">):</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">userid</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hashalg</span><span class="p">)</span>

    <span class="c"># Check to see if this is an IPv6 address</span>
    <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">ip</span><span class="p">:</span>
        <span class="n">ip_timestamp</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="n">ip_timestamp</span> <span class="o">=</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">ip_timestamp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># encode_ip_timestamp not required, left in for backwards compatibility</span>
        <span class="n">ip_timestamp</span> <span class="o">=</span> <span class="n">encode_ip_timestamp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

    <span class="n">hash_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ip_timestamp</span> <span class="o">+</span> <span class="n">secret</span> <span class="o">+</span> <span class="n">userid</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span> <span class="o">+</span>
            <span class="n">tokens</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\0</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">user_data</span><span class="p">)</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">hash_obj2</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">hashalg</span><span class="p">)</span>
    <span class="n">hash_obj2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bytes_</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span> <span class="o">+</span> <span class="n">secret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hash_obj2</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c"># this function licensed under the MIT license (stolen from Paste)</span>
<span class="k">def</span> <span class="nf">encode_ip_timestamp</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
    <span class="n">ip_chars</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">))))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="p">((</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
          <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
          <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
          <span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
    <span class="n">ts_chars</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">chr</span><span class="p">,</span> <span class="n">ts</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">ip_chars</span> <span class="o">+</span> <span class="n">ts_chars</span><span class="p">)</span>

<div class="viewcode-block" id="AuthTktCookieHelper"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktCookieHelper">[docs]</a><span class="k">class</span> <span class="nc">AuthTktCookieHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper class for use in third-party authentication policy</span>
<span class="sd">    implementations.  See</span>
<span class="sd">    :class:`pyramid.authentication.AuthTktAuthenticationPolicy` for the</span>
<span class="sd">    meanings of the constructor arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parse_ticket</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">parse_ticket</span><span class="p">)</span> <span class="c"># for tests</span>
    <span class="n">AuthTicket</span> <span class="o">=</span> <span class="n">AuthTicket</span> <span class="c"># for tests</span>
    <span class="n">BadTicket</span> <span class="o">=</span> <span class="n">BadTicket</span> <span class="c"># for tests</span>
    <span class="n">now</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># for tests</span>

    <span class="n">userid_type_decoders</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;int&#39;</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
        <span class="s">&#39;unicode&#39;</span><span class="p">:</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">utf_8_decode</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="c"># bw compat for old cookies</span>
        <span class="s">&#39;b64unicode&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">utf_8_decode</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;b64str&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">userid_type_encoders</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="nb">long</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="n">text_type</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;b64unicode&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">utf_8_encode</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])),</span>
        <span class="n">binary_type</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;b64str&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">cookie_name</span><span class="o">=</span><span class="s">&#39;auth_tkt&#39;</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">include_ip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reissue_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_age</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">http_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">wild_domain</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">hashalg</span><span class="o">=</span><span class="s">&#39;md5&#39;</span><span class="p">,</span> <span class="n">parent_domain</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="n">_SimpleSerializer</span><span class="p">()</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_profile</span> <span class="o">=</span> <span class="n">CookieProfile</span><span class="p">(</span>
            <span class="n">cookie_name</span> <span class="o">=</span> <span class="n">cookie_name</span><span class="p">,</span>
            <span class="n">secure</span> <span class="o">=</span> <span class="n">secure</span><span class="p">,</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="n">max_age</span><span class="p">,</span>
            <span class="n">httponly</span> <span class="o">=</span> <span class="n">http_only</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span>
            <span class="n">serializer</span><span class="o">=</span><span class="n">serializer</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span> <span class="o">=</span> <span class="n">cookie_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secure</span> <span class="o">=</span> <span class="n">secure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_ip</span> <span class="o">=</span> <span class="n">include_ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reissue_time</span> <span class="o">=</span> <span class="n">reissue_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="n">max_age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wild_domain</span> <span class="o">=</span> <span class="n">wild_domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_domain</span> <span class="o">=</span> <span class="n">parent_domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hashalg</span> <span class="o">=</span> <span class="n">hashalg</span>

    <span class="k">def</span> <span class="nf">_get_cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">cur_domain</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">domain</span>

        <span class="n">domains</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">:</span>
            <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_domain</span> <span class="ow">and</span> <span class="n">cur_domain</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">cur_domain</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_domain</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wild_domain</span><span class="p">:</span>
                    <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">cur_domain</span><span class="p">)</span>

        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookie_profile</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kw</span><span class="p">[</span><span class="s">&#39;domains&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domains</span>
        <span class="k">if</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s">&#39;max_age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_age</span>
            
        <span class="n">headers</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_headers</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">headers</span>

<div class="viewcode-block" id="AuthTktCookieHelper.identify"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktCookieHelper.identify">[docs]</a>    <span class="k">def</span> <span class="nf">identify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dictionary with authentication information, or ``None``</span>
<span class="sd">        if no valid auth_tkt is attached to ``request``&quot;&quot;&quot;</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span>
        <span class="n">cookie</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cookie</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_ip</span><span class="p">:</span>
            <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remote_addr</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">timestamp</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">user_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_ticket</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">remote_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hashalg</span><span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">BadTicket</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="c"># service tests</span>

        <span class="k">if</span> <span class="n">now</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="ow">and</span> <span class="p">(</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="p">):</span>
            <span class="c"># the auth_tkt data has expired</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">userid_typename</span> <span class="o">=</span> <span class="s">&#39;userid_type:&#39;</span>
        <span class="n">user_data_info</span> <span class="o">=</span> <span class="n">user_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_data_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">datum</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">userid_typename</span><span class="p">):</span>
                <span class="n">userid_type</span> <span class="o">=</span> <span class="n">datum</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">userid_typename</span><span class="p">):]</span>
                <span class="n">decoder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userid_type_decoders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">userid_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">decoder</span><span class="p">:</span>
                    <span class="n">userid</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>

        <span class="n">reissue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reissue_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">reissue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_authtkt_reissued&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reissue_time</span> <span class="p">):</span>
                <span class="c"># work around https://github.com/Pylons/pyramid/issues#issue/108</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">tokens</span><span class="p">))</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_age</span><span class="p">,</span>
                                        <span class="n">tokens</span><span class="o">=</span><span class="n">tokens</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">reissue_authtkt</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_authtkt_reissue_revoked&#39;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                            <span class="n">response</span><span class="o">.</span><span class="n">headerlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="n">request</span><span class="o">.</span><span class="n">add_response_callback</span><span class="p">(</span><span class="n">reissue_authtkt</span><span class="p">)</span>
                <span class="n">request</span><span class="o">.</span><span class="n">_authtkt_reissued</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REMOTE_USER_TOKENS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REMOTE_USER_DATA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="n">environ</span><span class="p">[</span><span class="s">&#39;AUTH_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;cookie&#39;</span>

        <span class="n">identity</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">identity</span><span class="p">[</span><span class="s">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span>
        <span class="n">identity</span><span class="p">[</span><span class="s">&#39;userid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">userid</span>
        <span class="n">identity</span><span class="p">[</span><span class="s">&#39;tokens&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">identity</span><span class="p">[</span><span class="s">&#39;userdata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_data</span>
        <span class="k">return</span> <span class="n">identity</span>
</div>
<div class="viewcode-block" id="AuthTktCookieHelper.forget"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktCookieHelper.forget">[docs]</a>    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a set of expires Set-Cookie headers, which will destroy</span>
<span class="sd">        any existing auth_tkt cookie when attached to a response&quot;&quot;&quot;</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_authtkt_reissue_revoked</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cookies</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AuthTktCookieHelper.remember"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.AuthTktCookieHelper.remember">[docs]</a>    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot; Return a set of Set-Cookie headers; when set into a response,</span>
<span class="sd">        these headers will represent a valid authentication ticket.</span>

<span class="sd">        ``max_age``</span>
<span class="sd">          The max age of the auth_tkt cookie, in seconds.  When this value is</span>
<span class="sd">          set, the cookie&#39;s ``Max-Age`` and ``Expires`` settings will be set,</span>
<span class="sd">          allowing the auth_tkt cookie to last between browser sessions.  If</span>
<span class="sd">          this value is ``None``, the ``max_age`` value provided to the</span>
<span class="sd">          helper itself will be used as the ``max_age`` value.  Default:</span>
<span class="sd">          ``None``.</span>

<span class="sd">        ``tokens``</span>
<span class="sd">          A sequence of strings that will be placed into the auth_tkt tokens</span>
<span class="sd">          field.  Each string in the sequence must be of the Python ``str``</span>
<span class="sd">          type and must match the regex ``^[A-Za-z][A-Za-z0-9+_-]*$``.</span>
<span class="sd">          Tokens are available in the returned identity when an auth_tkt is</span>
<span class="sd">          found in the request and unpacked.  Default: ``()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span>

        <span class="n">environ</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_ip</span><span class="p">:</span>
            <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remote_addr</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0&#39;</span>

        <span class="n">user_data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">encoding_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">userid_type_encoders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">userid</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">encoding_data</span><span class="p">:</span>
            <span class="n">encoding</span><span class="p">,</span> <span class="n">encoder</span> <span class="o">=</span> <span class="n">encoding_data</span>
            <span class="n">userid</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
            <span class="n">user_data</span> <span class="o">=</span> <span class="s">&#39;userid_type:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">encoding</span>

        <span class="n">new_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">ascii_native_</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid token </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">,))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">VALID_TOKEN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">token</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Invalid token </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">,))</span>
            <span class="n">new_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new_tokens</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_authtkt_reissued&#39;</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">_authtkt_reissue_revoked</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">ticket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AuthTicket</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
            <span class="n">userid</span><span class="p">,</span>
            <span class="n">remote_addr</span><span class="p">,</span>
            <span class="n">tokens</span><span class="o">=</span><span class="n">tokens</span><span class="p">,</span>
            <span class="n">user_data</span><span class="o">=</span><span class="n">user_data</span><span class="p">,</span>
            <span class="n">cookie_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cookie_name</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">secure</span><span class="p">,</span>
            <span class="n">hashalg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hashalg</span>
            <span class="p">)</span>

        <span class="n">cookie_value</span> <span class="o">=</span> <span class="n">ticket</span><span class="o">.</span><span class="n">cookie_value</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cookies</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">cookie_value</span><span class="p">,</span> <span class="n">max_age</span><span class="p">)</span>
</div></div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthenticationPolicy</span><span class="p">)</span>
<div class="viewcode-block" id="SessionAuthenticationPolicy"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.SessionAuthenticationPolicy">[docs]</a><span class="k">class</span> <span class="nc">SessionAuthenticationPolicy</span><span class="p">(</span><span class="n">CallbackAuthenticationPolicy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A :app:`Pyramid` authentication policy which gets its data from the</span>
<span class="sd">    configured :term:`session`.  For this authentication policy to work, you</span>
<span class="sd">    will have to follow the instructions in the :ref:`sessions_chapter` to</span>
<span class="sd">    configure a :term:`session factory`.</span>

<span class="sd">    Constructor Arguments</span>

<span class="sd">    ``prefix``</span>

<span class="sd">       A prefix used when storing the authentication parameters in the</span>
<span class="sd">       session. Defaults to &#39;auth.&#39;. Optional.</span>

<span class="sd">    ``callback``</span>

<span class="sd">       Default: ``None``.  A callback passed the userid and the</span>
<span class="sd">       request, expected to return ``None`` if the userid doesn&#39;t</span>
<span class="sd">       exist or a sequence of principal identifiers (possibly empty) if</span>
<span class="sd">       the user does exist.  If ``callback`` is ``None``, the userid</span>
<span class="sd">       will be assumed to exist with no principals.  Optional.</span>

<span class="sd">    ``debug``</span>

<span class="sd">        Default: ``False``.  If ``debug`` is ``True``, log messages to the</span>
<span class="sd">        Pyramid debug logger about the results of various authentication</span>
<span class="sd">        steps.  The output from debugging is useful for reporting to maillist</span>
<span class="sd">        or IRC channels when asking for support.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s">&#39;auth.&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userid_key</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">&#39;userid&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

<div class="viewcode-block" id="SessionAuthenticationPolicy.remember"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.SessionAuthenticationPolicy.remember">[docs]</a>    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store a principal in the session.&quot;&quot;&quot;</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">userid_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="SessionAuthenticationPolicy.forget"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.SessionAuthenticationPolicy.forget">[docs]</a>    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove the stored principal from the session.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">userid_key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">userid_key</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userid_key</span><span class="p">)</span>

</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IAuthenticationPolicy</span><span class="p">)</span>
<div class="viewcode-block" id="BasicAuthAuthenticationPolicy"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.BasicAuthAuthenticationPolicy">[docs]</a><span class="k">class</span> <span class="nc">BasicAuthAuthenticationPolicy</span><span class="p">(</span><span class="n">CallbackAuthenticationPolicy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A :app:`Pyramid` authentication policy which uses HTTP standard basic</span>
<span class="sd">    authentication protocol to authenticate users.  To use this policy you will</span>
<span class="sd">    need to provide a callback which checks the supplied user credentials</span>
<span class="sd">    against your source of login data.</span>

<span class="sd">    Constructor Arguments</span>

<span class="sd">    ``check``</span>

<span class="sd">       A callback function passed a username, password and request, in that</span>
<span class="sd">       order as positional arguments.  Expected to return ``None`` if the</span>
<span class="sd">       userid doesn&#39;t exist or a sequence of principal identifiers (possibly</span>
<span class="sd">       empty) if the user does exist.</span>

<span class="sd">    ``realm``</span>

<span class="sd">       Default: ``&quot;Realm&quot;``.  The Basic Auth Realm string.  Usually displayed to</span>
<span class="sd">       the user by the browser in the login dialog.</span>

<span class="sd">    ``debug``</span>

<span class="sd">        Default: ``False``.  If ``debug`` is ``True``, log messages to the</span>
<span class="sd">        Pyramid debug logger about the results of various authentication</span>
<span class="sd">        steps.  The output from debugging is useful for reporting to maillist</span>
<span class="sd">        or IRC channels when asking for support.</span>

<span class="sd">    **Issuing a challenge**</span>

<span class="sd">    Regular browsers will not send username/password credentials unless they</span>
<span class="sd">    first receive a challenge from the server.  The following recipe will</span>
<span class="sd">    register a view that will send a Basic Auth challenge to the user whenever</span>
<span class="sd">    there is an attempt to call a view which results in a Forbidden response::</span>

<span class="sd">        from pyramid.httpexceptions import HTTPUnauthorized</span>
<span class="sd">        from pyramid.security import forget</span>
<span class="sd">        from pyramid.view import forbidden_view_config</span>

<span class="sd">        @forbidden_view_config()</span>
<span class="sd">        def basic_challenge(request):</span>
<span class="sd">            response = HTTPUnauthorized()</span>
<span class="sd">            response.headers.update(forget(request))</span>
<span class="sd">            return response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">realm</span><span class="o">=</span><span class="s">&#39;Realm&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check</span> <span class="o">=</span> <span class="n">check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realm</span> <span class="o">=</span> <span class="n">realm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

<div class="viewcode-block" id="BasicAuthAuthenticationPolicy.unauthenticated_userid"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.BasicAuthAuthenticationPolicy.unauthenticated_userid">[docs]</a>    <span class="k">def</span> <span class="nf">unauthenticated_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The userid parsed from the ``Authorization`` request header.&quot;&quot;&quot;</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_credentials</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">credentials</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">credentials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="BasicAuthAuthenticationPolicy.remember"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.BasicAuthAuthenticationPolicy.remember">[docs]</a>    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">principal</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A no-op. Basic authentication does not provide a protocol for</span>
<span class="sd">        remembering the user. Credentials are sent on every request.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="BasicAuthAuthenticationPolicy.forget"><a class="viewcode-back" href="../../api/authentication.html#pyramid.authentication.BasicAuthAuthenticationPolicy.forget">[docs]</a>    <span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns challenge headers. This should be attached to a response</span>
<span class="sd">        to indicate that credentials are required.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;WWW-Authenticate&#39;</span><span class="p">,</span> <span class="s">&#39;Basic realm=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">realm</span><span class="p">)]</span>
</div>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c"># Username arg is ignored.  Unfortunately _get_credentials winds up</span>
        <span class="c"># getting called twice when authenticated_userid is called.  Avoiding</span>
        <span class="c"># that, however, winds up duplicating logic from the superclass.</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_credentials</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">credentials</span><span class="p">:</span>
            <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">credentials</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">authorization</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Authorization&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">authorization</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">authmeth</span><span class="p">,</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">authorization</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># not enough values to unpack</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">authmeth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;basic&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">authbytes</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">binascii</span><span class="o">.</span><span class="n">Error</span><span class="p">):</span> <span class="c"># can&#39;t decode</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># try utf-8 first, then latin-1; see discussion in</span>
        <span class="c"># https://github.com/Pylons/pyramid/issues/898</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">authbytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">authbytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;latin-1&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># not enough values to unpack</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span>
</div>
<span class="k">class</span> <span class="nc">_SimpleSerializer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bstruct</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">native_</span><span class="p">(</span><span class="n">bstruct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appstruct</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">bytes_</span><span class="p">(</span><span class="n">appstruct</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.5</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../../copyright.html">Copyright</a> 2008-2014, Agendaless Consulting.
      Last updated on Nov 09, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>