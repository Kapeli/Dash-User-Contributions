<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Adding Authorization &mdash; The Pyramid Web Framework v1.5</title>
    
    <link rel="stylesheet" href="../../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="The Pyramid Web Framework v1.5" href="../../index.html" />
    <link rel="up" title="ZODB + Traversal Wiki Tutorial" href="index.html" />
    <link rel="next" title="Adding Tests" href="tests.html" />
    <link rel="prev" title="Defining Views" href="definingviews.html" />
<link rel="stylesheet" href="http://static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../../_static/pyramid.ico"/>

  </head>
  <body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../../index.html">
      		<img class="logo" src="../../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tests.html" title="Adding Tests"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="definingviews.html" title="Defining Views"
             accesskey="P">previous</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.5</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">ZODB + Traversal Wiki Tutorial</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="adding-authorization">
<h1>Adding Authorization<a class="headerlink" href="#adding-authorization" title="Permalink to this headline">¶</a></h1>
<p><span>Pyramid</span> provides facilities for <a class="reference internal" href="../../glossary.html#term-authentication"><em class="xref std std-term">authentication</em></a> and
<a class="reference internal" href="../../glossary.html#term-authorization"><em class="xref std std-term">authorization</em></a>.  We'll make use of both features to provide security
to our application.  Our application currently allows anyone with access to
the server to view, edit, and add pages to our wiki.  We'll change that
to allow only people who are members of a <em>group</em> named <tt class="docutils literal"><span class="pre">group:editors</span></tt>
to add and edit wiki pages but we'll continue allowing
anyone with access to the server to view pages.</p>
<p>We will also add a login page and a logout link on all the
pages.  The login page will be shown when a user is denied
access to any of the views that require a permission, instead of
a default &quot;403 Forbidden&quot; page.</p>
<p>We will implement the access control with the following steps:</p>
<ul class="simple">
<li>Add users and groups (<tt class="docutils literal"><span class="pre">security.py</span></tt>, a new module).</li>
<li>Add an <a class="reference internal" href="../../glossary.html#term-acl"><em class="xref std std-term">ACL</em></a> (<tt class="docutils literal"><span class="pre">models.py</span></tt>).</li>
<li>Add an <a class="reference internal" href="../../glossary.html#term-authentication-policy"><em class="xref std std-term">authentication policy</em></a> and an <a class="reference internal" href="../../glossary.html#term-authorization-policy"><em class="xref std std-term">authorization policy</em></a>
(<tt class="docutils literal"><span class="pre">__init__.py</span></tt>).</li>
<li>Add <a class="reference internal" href="../../glossary.html#term-permission"><em class="xref std std-term">permission</em></a> declarations to the <tt class="docutils literal"><span class="pre">edit_page</span></tt> and <tt class="docutils literal"><span class="pre">add_page</span></tt>
views (<tt class="docutils literal"><span class="pre">views.py</span></tt>).</li>
</ul>
<p>Then we will add the login and logout feature:</p>
<ul class="simple">
<li>Add <tt class="docutils literal"><span class="pre">login</span></tt> and <tt class="docutils literal"><span class="pre">logout</span></tt> views (<tt class="docutils literal"><span class="pre">views.py</span></tt>).</li>
<li>Add a login template (<tt class="docutils literal"><span class="pre">login.pt</span></tt>).</li>
<li>Make the existing views return a <tt class="docutils literal"><span class="pre">logged_in</span></tt> flag to the renderer (<tt class="docutils literal"><span class="pre">views.py</span></tt>).</li>
<li>Add a &quot;Logout&quot; link to be shown when logged in and viewing or editing a page
(<tt class="docutils literal"><span class="pre">view.pt</span></tt>, <tt class="docutils literal"><span class="pre">edit.pt</span></tt>).</li>
</ul>
<div class="section" id="access-control">
<h2>Access Control<a class="headerlink" href="#access-control" title="Permalink to this headline">¶</a></h2>
<div class="section" id="add-users-and-groups">
<h3>Add users and groups<a class="headerlink" href="#add-users-and-groups" title="Permalink to this headline">¶</a></h3>
<p>Create a new <tt class="docutils literal"><span class="pre">tutorial/tutorial/security.py</span></tt> module with the
following content:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">USERS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;editor&#39;</span><span class="p">:</span><span class="s">&#39;editor&#39;</span><span class="p">,</span>
          <span class="s">&#39;viewer&#39;</span><span class="p">:</span><span class="s">&#39;viewer&#39;</span><span class="p">}</span>
<span class="n">GROUPS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;editor&#39;</span><span class="p">:[</span><span class="s">&#39;group:editors&#39;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">groupfinder</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">userid</span> <span class="ow">in</span> <span class="n">USERS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">GROUPS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>
</td></tr></table></div>
<p>The <tt class="docutils literal"><span class="pre">groupfinder</span></tt> function accepts a userid and a request and
returns one of these values:</p>
<ul class="simple">
<li>If the userid exists in the system, it will return a
sequence of group identifiers (or an empty sequence if the user
isn't a member of any groups).</li>
<li>If the userid <em>does not</em> exist in the system, it will
return <tt class="docutils literal"><span class="pre">None</span></tt>.</li>
</ul>
<p>For example, <tt class="docutils literal"><span class="pre">groupfinder('editor',</span> <span class="pre">request</span> <span class="pre">)</span></tt> returns <tt class="docutils literal"><span class="pre">['group:editor']</span></tt>,
<tt class="docutils literal"><span class="pre">groupfinder('viewer',</span> <span class="pre">request)</span></tt> returns <tt class="docutils literal"><span class="pre">[]</span></tt>, and <tt class="docutils literal"><span class="pre">groupfinder('admin',</span>
<span class="pre">request)</span></tt> returns <tt class="docutils literal"><span class="pre">None</span></tt>.  We will use <tt class="docutils literal"><span class="pre">groupfinder()</span></tt> as an
<a class="reference internal" href="../../glossary.html#term-authentication-policy"><em class="xref std std-term">authentication policy</em></a> &quot;callback&quot; that will provide the
<a class="reference internal" href="../../glossary.html#term-principal"><em class="xref std std-term">principal</em></a> or principals for a user.</p>
<p>In a production system, user and group
data will most often come from a database, but here we use &quot;dummy&quot;
data to represent user and groups sources.</p>
</div>
<div class="section" id="add-an-acl">
<h3>Add an ACL<a class="headerlink" href="#add-an-acl" title="Permalink to this headline">¶</a></h3>
<p>Open <tt class="docutils literal"><span class="pre">tutorial/tutorial/models.py</span></tt> and add the following import
statement at the head:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Allow</span><span class="p">,</span>
    <span class="n">Everyone</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>Add the following lines to the <tt class="docutils literal"><span class="pre">Wiki</span></tt> class:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Wiki</span><span class="p">(</span><span class="n">PersistentMapping</span><span class="p">):</span>
    <span class="n">__name__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__parent__</span> <span class="o">=</span> <span class="bp">None</span>
<span class="hll">    <span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">                <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span> <span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>We import <a class="reference internal" href="../../api/security.html#pyramid.security.Allow" title="pyramid.security.Allow"><tt class="xref py py-data docutils literal"><span class="pre">Allow</span></tt></a>, an action that
means that permission is allowed, and
<a class="reference internal" href="../../api/security.html#pyramid.security.Everyone" title="pyramid.security.Everyone"><tt class="xref py py-data docutils literal"><span class="pre">Everyone</span></tt></a>, a special <a class="reference internal" href="../../glossary.html#term-principal"><em class="xref std std-term">principal</em></a>
that is associated to all requests.  Both are used in the
<a class="reference internal" href="../../glossary.html#term-ace"><em class="xref std std-term">ACE</em></a> entries that make up the ACL.</p>
<p>The ACL is a list that needs to be named <cite>__acl__</cite> and be an
attribute of a class.  We define an <a class="reference internal" href="../../glossary.html#term-acl"><em class="xref std std-term">ACL</em></a> with two
<a class="reference internal" href="../../glossary.html#term-ace"><em class="xref std std-term">ACE</em></a> entries: the first entry allows any user the <cite>view</cite>
permission, and the second entry allows the <tt class="docutils literal"><span class="pre">group:editors</span></tt>
principal the <cite>edit</cite> permission.</p>
<p>The <tt class="docutils literal"><span class="pre">Wiki</span></tt> class that contains the ACL is the <a class="reference internal" href="../../glossary.html#term-resource"><em class="xref std std-term">resource</em></a>
constructor for the <a class="reference internal" href="../../glossary.html#term-root"><em class="xref std std-term">root</em></a> resource, which is
a <tt class="docutils literal"><span class="pre">Wiki</span></tt> instance.  The ACL is
provided to each view in the <a class="reference internal" href="../../glossary.html#term-context"><em class="xref std std-term">context</em></a> of the request, as
the <tt class="docutils literal"><span class="pre">context</span></tt> attribute.</p>
<p>It's only happenstance that we're assigning this ACL at class scope.  An ACL
can be attached to an object <em>instance</em> too; this is how &quot;row level security&quot;
can be achieved in <span>Pyramid</span> applications.  We actually need only <em>one</em>
ACL for the entire system, however, because our security requirements are
simple, so this feature is not demonstrated.  See
<a class="reference internal" href="../../narr/security.html#assigning-acls"><em>Assigning ACLs to your Resource Objects</em></a> for more information about what an
<a class="reference internal" href="../../glossary.html#term-acl"><em class="xref std std-term">ACL</em></a> represents.</p>
</div>
<div class="section" id="add-authentication-and-authorization-policies">
<h3>Add Authentication and Authorization Policies<a class="headerlink" href="#add-authentication-and-authorization-policies" title="Permalink to this headline">¶</a></h3>
<p>Open <tt class="docutils literal"><span class="pre">tutorial/__init__.py</span></tt> and
add these import statements:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
<span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
<span class="kn">from</span> <span class="nn">.security</span> <span class="kn">import</span> <span class="n">groupfinder</span>
</pre></div>
</td></tr></table></div>
<p>Now add those policies to the configuration:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="hll">    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span>
</span><span class="hll">        <span class="s">&#39;sosecret&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">groupfinder</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s">&#39;sha512&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">authz_policy</span> <span class="o">=</span> <span class="n">ACLAuthorizationPolicy</span><span class="p">()</span>
</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">root_factory</span><span class="o">=</span><span class="n">root_factory</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">authz_policy</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines need to be added.)</p>
<p>We are enabling an <tt class="docutils literal"><span class="pre">AuthTktAuthenticationPolicy</span></tt>, it is based in an
auth ticket that may be included in the request, and an
<tt class="docutils literal"><span class="pre">ACLAuthorizationPolicy</span></tt> that uses an ACL to determine the allow or deny
outcome for a view.</p>
<p>Note that the <a class="reference internal" href="../../api/authentication.html#pyramid.authentication.AuthTktAuthenticationPolicy" title="pyramid.authentication.AuthTktAuthenticationPolicy"><tt class="xref py py-class docutils literal"><span class="pre">pyramid.authentication.AuthTktAuthenticationPolicy</span></tt></a>
constructor accepts two arguments: <tt class="docutils literal"><span class="pre">secret</span></tt> and <tt class="docutils literal"><span class="pre">callback</span></tt>.  <tt class="docutils literal"><span class="pre">secret</span></tt> is
a string representing an encryption key used by the &quot;authentication ticket&quot;
machinery represented by this policy: it is required.  The <tt class="docutils literal"><span class="pre">callback</span></tt> is the
<tt class="docutils literal"><span class="pre">groupfinder()</span></tt> function that we created before.</p>
</div>
<div class="section" id="add-permission-declarations">
<h3>Add permission declarations<a class="headerlink" href="#add-permission-declarations" title="Permalink to this headline">¶</a></h3>
<p>Open <tt class="docutils literal"><span class="pre">tutorial/tutorial/views.py</span></tt>.  Add a <tt class="docutils literal"><span class="pre">permission='edit'</span></tt> parameter
to the <tt class="docutils literal"><span class="pre">&#64;view_config</span></tt> decorator for <tt class="docutils literal"><span class="pre">add_page()</span></tt> and
<tt class="docutils literal"><span class="pre">edit_page()</span></tt>, for example:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/edit.pt&#39;</span><span class="p">,</span>
<span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>(Only the highlighted line, along with its preceding comma,
needs to be added.)</p>
<p>The result is that only users who possess the <tt class="docutils literal"><span class="pre">edit</span></tt>
permission at the time of the request may invoke those two views.</p>
<p>Add a <tt class="docutils literal"><span class="pre">permission='view'</span></tt> parameter to the <tt class="docutils literal"><span class="pre">&#64;view_config</span></tt>
decorator for <tt class="docutils literal"><span class="pre">view_wiki()</span></tt> and <tt class="docutils literal"><span class="pre">view_page()</span></tt>, like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/view.pt&#39;</span><span class="p">,</span>
<span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>(Only the highlighted line, along with its preceding comma,
needs to be added.)</p>
<p>This allows anyone to invoke these two views.</p>
<p>We are done with the changes needed to control access.  The
changes that follow will add the login and logout feature.</p>
</div>
</div>
<div class="section" id="login-logout">
<h2>Login, Logout<a class="headerlink" href="#login-logout" title="Permalink to this headline">¶</a></h2>
<div class="section" id="add-login-and-logout-views">
<h3>Add Login and Logout Views<a class="headerlink" href="#add-login-and-logout-views" title="Permalink to this headline">¶</a></h3>
<p>We'll add a <tt class="docutils literal"><span class="pre">login</span></tt> view which renders a login form and processes
the post from the login form, checking credentials.</p>
<p>We'll also add a <tt class="docutils literal"><span class="pre">logout</span></tt> view callable to our application and
provide a link to it.  This view will clear the credentials of the
logged in user and redirect back to the front page.</p>
<p>Add the following import statements to the
head of <tt class="docutils literal"><span class="pre">tutorial/tutorial/views.py</span></tt>:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">view_config</span><span class="p">,</span>
<span class="hll">    <span class="n">forbidden_view_config</span><span class="p">,</span>
</span>    <span class="p">)</span>

<span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">remember</span><span class="p">,</span>
</span><span class="hll">    <span class="n">forget</span><span class="p">,</span>
</span><span class="hll">
</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.security</span> <span class="kn">import</span> <span class="n">USERS</span>
</span></pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines, with other necessary modifications,
need to be added.)</p>
<p><a class="reference internal" href="../../api/view.html#pyramid.view.forbidden_view_config" title="pyramid.view.forbidden_view_config"><tt class="xref py py-meth docutils literal"><span class="pre">forbidden_view_config()</span></tt></a> will be used
to customize the default 403 Forbidden page.
<a class="reference internal" href="../../api/security.html#pyramid.security.remember" title="pyramid.security.remember"><tt class="xref py py-meth docutils literal"><span class="pre">remember()</span></tt></a> and
<a class="reference internal" href="../../api/security.html#pyramid.security.forget" title="pyramid.security.forget"><tt class="xref py py-meth docutils literal"><span class="pre">forget()</span></tt></a> help to create and
expire an auth ticket cookie.</p>
<p>Now add the <tt class="docutils literal"><span class="pre">login</span></tt> and <tt class="docutils literal"><span class="pre">logout</span></tt> views:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/login.pt&#39;</span><span class="p">)</span>
<span class="nd">@forbidden_view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/login.pt&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;login&#39;</span><span class="p">)</span>
    <span class="n">referrer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
    <span class="k">if</span> <span class="n">referrer</span> <span class="o">==</span> <span class="n">login_url</span><span class="p">:</span>
        <span class="n">referrer</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="c"># never use the login form itself as came_from</span>
    <span class="n">came_from</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;came_from&#39;</span><span class="p">,</span> <span class="n">referrer</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">login</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">login</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;login&#39;</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">USERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">came_from</span><span class="p">,</span>
                             <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Failed login&#39;</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">,</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">application_url</span> <span class="o">+</span> <span class="s">&#39;/login&#39;</span><span class="p">,</span>
        <span class="n">came_from</span> <span class="o">=</span> <span class="n">came_from</span><span class="p">,</span>
        <span class="n">login</span> <span class="o">=</span> <span class="n">login</span><span class="p">,</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">,</span>
        <span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">forget</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
                     <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p><tt class="docutils literal"><span class="pre">login()</span></tt> has two decorators:</p>
<ul class="simple">
<li>a <tt class="docutils literal"><span class="pre">&#64;view_config</span></tt> decorator which associates it with the
<tt class="docutils literal"><span class="pre">login</span></tt> route and makes it visible when we visit <tt class="docutils literal"><span class="pre">/login</span></tt>,</li>
<li>a <tt class="docutils literal"><span class="pre">&#64;forbidden_view_config</span></tt> decorator which turns it into
a <a class="reference internal" href="../../glossary.html#term-forbidden-view"><em class="xref std std-term">forbidden view</em></a>. <tt class="docutils literal"><span class="pre">login()</span></tt> will be invoked
when a user tries to execute a view callable for which they lack
authorization.  For example, if a user has not logged in
and tries to add or edit a Wiki page, they will be shown the
login form before being allowed to continue.</li>
</ul>
<p>The order of these two <a class="reference internal" href="../../glossary.html#term-view-configuration"><em class="xref std std-term">view configuration</em></a> decorators
is unimportant.</p>
<p><tt class="docutils literal"><span class="pre">logout()</span></tt> is decorated with a <tt class="docutils literal"><span class="pre">&#64;view_config</span></tt> decorator
which associates it with the <tt class="docutils literal"><span class="pre">logout</span></tt> route.  It will be
invoked when we visit <tt class="docutils literal"><span class="pre">/logout</span></tt>.</p>
</div>
<div class="section" id="add-the-login-pt-template">
<h3>Add the <tt class="docutils literal"><span class="pre">login.pt</span></tt> Template<a class="headerlink" href="#add-the-login-pt-template" title="Permalink to this headline">¶</a></h3>
<p>Create <tt class="docutils literal"><span class="pre">tutorial/tutorial/templates/login.pt</span></tt> with the following
content:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span>
<span class="cp">  &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;en&quot;</span>
      <span class="na">xmlns:tal=</span><span class="s">&quot;http://xml.zope.org/namespaces/tal&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Login - Pyramid tutorial wiki (based on TurboGears
    20-Minute Wiki)<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content=</span><span class="s">&quot;python web application&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;pyramid web application&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;shortcut icon&quot;</span>
        <span class="na">href=</span><span class="s">&quot;/static/favicon.ico&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
        <span class="na">href=</span><span class="s">&quot;/static/pylons.css&quot;</span>
        <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--[if lte IE 6]&gt;</span>
<span class="c">  &lt;link rel=&quot;stylesheet&quot;</span>
<span class="c">        href=&quot;/static/ie6.css&quot;</span>
<span class="c">        type=&quot;text/css&quot; media=&quot;screen&quot; charset=&quot;utf-8&quot; /&gt;</span>
<span class="c">  &lt;![endif]--&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrap&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;top-small&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;top-small align-center&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          <span class="nt">&lt;img</span> <span class="na">width=</span><span class="s">&quot;220&quot;</span> <span class="na">height=</span><span class="s">&quot;50&quot;</span> <span class="na">alt=</span><span class="s">&quot;pyramid&quot;</span>
        <span class="na">src=</span><span class="s">&quot;/static/pyramid-small.png&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;middle&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;middle align-right&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;left&quot;</span> <span class="na">class=</span><span class="s">&quot;app-welcome align-left&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;b&gt;</span>Login<span class="nt">&lt;/b&gt;&lt;br/&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">tal:replace=</span><span class="s">&quot;message&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;right&quot;</span> <span class="na">class=</span><span class="s">&quot;app-welcome align-right&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;${url}&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;came_from&quot;</span> <span class="na">value=</span><span class="s">&quot;${came_from}&quot;</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;login&quot;</span> <span class="na">value=</span><span class="s">&quot;${login}&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span>
                 <span class="na">value=</span><span class="s">&quot;${password}&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value=</span><span class="s">&quot;Log In&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The above template is referred in the login view that we just added
in <tt class="docutils literal"><span class="pre">views.py</span></tt>.</p>
</div>
<div class="section" id="return-a-logged-in-flag-to-the-renderer">
<h3>Return a logged_in flag to the renderer<a class="headerlink" href="#return-a-logged-in-flag-to-the-renderer" title="Permalink to this headline">¶</a></h3>
<p>Add a  <tt class="docutils literal"><span class="pre">logged_in</span></tt> parameter to the return value of
<tt class="docutils literal"><span class="pre">view_page()</span></tt>, <tt class="docutils literal"><span class="pre">edit_page()</span></tt> and  <tt class="docutils literal"><span class="pre">add_page()</span></tt>,
like this:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">,</span>
            <span class="n">edit_url</span> <span class="o">=</span> <span class="n">edit_url</span><span class="p">,</span>
<span class="hll">            <span class="n">logged_in</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authenticated_userid</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>(Only the highlighted line and a trailing comma on the preceding
line need to be added.)</p>
<p>The <a class="reference internal" href="../../api/request.html#pyramid.request.Request.authenticated_userid" title="pyramid.request.Request.authenticated_userid"><tt class="xref py py-meth docutils literal"><span class="pre">pyramid.request.Request.authenticated_userid()</span></tt></a> will be <tt class="docutils literal"><span class="pre">None</span></tt> if
the user is not authenticated, or a user id if the user is authenticated.</p>
</div>
<div class="section" id="add-a-logout-link-when-logged-in">
<h3>Add a &quot;Logout&quot; link when logged in<a class="headerlink" href="#add-a-logout-link-when-logged-in" title="Permalink to this headline">¶</a></h3>
<p>Open <tt class="docutils literal"><span class="pre">tutorial/tutorial/templates/edit.pt</span></tt> and
<tt class="docutils literal"><span class="pre">tutorial/tutorial/templates/view.pt</span></tt>  and add this within the
<tt class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">id=&quot;right&quot;</span> <span class="pre">class=&quot;app-welcome</span> <span class="pre">align-right&quot;&gt;</span></tt> div:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;span</span> <span class="na">tal:condition=</span><span class="s">&quot;logged_in&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${request.application_url}/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div>
<p>The attribute <tt class="docutils literal"><span class="pre">tal:condition=&quot;logged_in&quot;</span></tt> will make the element be
included when <tt class="docutils literal"><span class="pre">logged_in</span></tt> is any user id. The link will invoke
the logout view.  The above element will not be included if <tt class="docutils literal"><span class="pre">logged_in</span></tt>
is <tt class="docutils literal"><span class="pre">None</span></tt>, such as when a user is not authenticated.</p>
</div>
</div>
<div class="section" id="seeing-our-changes">
<h2>Seeing Our Changes<a class="headerlink" href="#seeing-our-changes" title="Permalink to this headline">¶</a></h2>
<p>Our <tt class="docutils literal"><span class="pre">tutorial/tutorial/__init__.py</span></tt> will look something like this
when we're done:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid_zodbconn</span> <span class="kn">import</span> <span class="n">get_connection</span>

<span class="hll"><span class="kn">from</span> <span class="nn">pyramid.authentication</span> <span class="kn">import</span> <span class="n">AuthTktAuthenticationPolicy</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">pyramid.authorization</span> <span class="kn">import</span> <span class="n">ACLAuthorizationPolicy</span>
</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">appmaker</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.security</span> <span class="kn">import</span> <span class="n">groupfinder</span>
</span>
<span class="k">def</span> <span class="nf">root_factory</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_connection</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">appmaker</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">root</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="hll">    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span>
</span><span class="hll">        <span class="s">&#39;sosecret&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">groupfinder</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s">&#39;sha512&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">authz_policy</span> <span class="o">=</span> <span class="n">ACLAuthorizationPolicy</span><span class="p">()</span>
</span>    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">root_factory</span><span class="o">=</span><span class="n">root_factory</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span>
</span><span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">authz_policy</span><span class="p">)</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">&#39;pyramid_chameleon&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines need to be added.)</p>
<p>Our <tt class="docutils literal"><span class="pre">tutorial/tutorial/models.py</span></tt> will look something like this
when we're done:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">persistent</span> <span class="kn">import</span> <span class="n">Persistent</span>
<span class="kn">from</span> <span class="nn">persistent.mapping</span> <span class="kn">import</span> <span class="n">PersistentMapping</span>

<span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">Allow</span><span class="p">,</span>
</span><span class="hll">    <span class="n">Everyone</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span>
</span>
<span class="k">class</span> <span class="nc">Wiki</span><span class="p">(</span><span class="n">PersistentMapping</span><span class="p">):</span>
    <span class="n">__name__</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__parent__</span> <span class="o">=</span> <span class="bp">None</span>
<span class="hll">    <span class="n">__acl__</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="n">Everyone</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">),</span>
</span><span class="hll">                <span class="p">(</span><span class="n">Allow</span><span class="p">,</span> <span class="s">&#39;group:editors&#39;</span><span class="p">,</span> <span class="s">&#39;edit&#39;</span><span class="p">)</span> <span class="p">]</span>
</span>
<span class="k">class</span> <span class="nc">Page</span><span class="p">(</span><span class="n">Persistent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">appmaker</span><span class="p">(</span><span class="n">zodb_root</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;app_root&#39;</span> <span class="ow">in</span> <span class="n">zodb_root</span><span class="p">:</span>
        <span class="n">app_root</span> <span class="o">=</span> <span class="n">Wiki</span><span class="p">()</span>
        <span class="n">frontpage</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="s">&#39;This is the front page&#39;</span><span class="p">)</span>
        <span class="n">app_root</span><span class="p">[</span><span class="s">&#39;FrontPage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frontpage</span>
        <span class="n">frontpage</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">&#39;FrontPage&#39;</span>
        <span class="n">frontpage</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">app_root</span>
        <span class="n">zodb_root</span><span class="p">[</span><span class="s">&#39;app_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app_root</span>
        <span class="kn">import</span> <span class="nn">transaction</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">zodb_root</span><span class="p">[</span><span class="s">&#39;app_root&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines need to be added.)</p>
<p>Our <tt class="docutils literal"><span class="pre">tutorial/tutorial/views.py</span></tt> will look something like this
when we're done:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">docutils.core</span> <span class="kn">import</span> <span class="n">publish_parts</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPFound</span>

<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">view_config</span><span class="p">,</span>
<span class="hll">    <span class="n">forbidden_view_config</span><span class="p">,</span>
</span>    <span class="p">)</span>

<span class="hll"><span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">remember</span><span class="p">,</span>
</span><span class="hll">    <span class="n">forget</span><span class="p">,</span>
</span><span class="hll">    <span class="p">)</span>
</span><span class="hll">
</span>
<span class="hll"><span class="kn">from</span> <span class="nn">.security</span> <span class="kn">import</span> <span class="n">USERS</span>
</span><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Page</span>

<span class="c"># regular expression used to find WikiWords</span>
<span class="n">wikiwords</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;\b([A-Z]\w+[A-Z]+\w+)&quot;</span><span class="p">)</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span>
<span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">view_wiki</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;FrontPage&#39;</span><span class="p">))</span>

<span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Page&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/view.pt&#39;</span><span class="p">,</span>
<span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s">&#39;view&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">view_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">wiki</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">__parent__</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wiki</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">wiki</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
            <span class="n">view_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_url</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">application_url</span> <span class="o">+</span> <span class="s">&#39;/add_page/&#39;</span> <span class="o">+</span> <span class="n">word</span> 
            <span class="k">return</span> <span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">add_url</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">publish_parts</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">writer_name</span><span class="o">=</span><span class="s">&#39;html&#39;</span><span class="p">)[</span><span class="s">&#39;html_body&#39;</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">wikiwords</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">check</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">edit_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;edit_page&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">context</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="p">,</span> <span class="n">edit_url</span> <span class="o">=</span> <span class="n">edit_url</span><span class="p">,</span>
<span class="hll">                <span class="n">logged_in</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authenticated_userid</span><span class="p">)</span>
</span>
<span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/edit.pt&#39;</span><span class="p">,</span>
<span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">pagename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">subpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">pagename</span>
        <span class="n">page</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">context</span>
        <span class="n">context</span><span class="p">[</span><span class="n">pagename</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
    <span class="n">save_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;add_page&#39;</span><span class="p">,</span> <span class="n">pagename</span><span class="p">)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">Page</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">pagename</span>
    <span class="n">page</span><span class="o">.</span><span class="n">__parent__</span> <span class="o">=</span> <span class="n">context</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">save_url</span><span class="o">=</span><span class="n">save_url</span><span class="p">,</span>
<span class="hll">                <span class="n">logged_in</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">authenticated_userid</span><span class="p">)</span>
</span>
<span class="nd">@view_config</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;edit_page&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Page&#39;</span><span class="p">,</span>
             <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/edit.pt&#39;</span><span class="p">,</span>
<span class="hll">             <span class="n">permission</span><span class="o">=</span><span class="s">&#39;edit&#39;</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">edit_page</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">page</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                <span class="n">save_url</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;edit_page&#39;</span><span class="p">),</span>
<span class="hll">                <span class="n">logged_in</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">authenticated_userid</span><span class="p">)</span>
</span>
<span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span>
</span><span class="hll">             <span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/login.pt&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="nd">@forbidden_view_config</span><span class="p">(</span><span class="n">renderer</span><span class="o">=</span><span class="s">&#39;templates/login.pt&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">login_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;login&#39;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">referrer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">referrer</span> <span class="o">==</span> <span class="n">login_url</span><span class="p">:</span>
</span><span class="hll">        <span class="n">referrer</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="c"># never use the login form itself as came_from</span>
</span><span class="hll">    <span class="n">came_from</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;came_from&#39;</span><span class="p">,</span> <span class="n">referrer</span><span class="p">)</span>
</span><span class="hll">    <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="hll">    <span class="n">login</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="hll">    <span class="n">password</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</span><span class="hll">    <span class="k">if</span> <span class="s">&#39;form.submitted&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
</span><span class="hll">        <span class="n">login</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;login&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">USERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="o">==</span> <span class="n">password</span><span class="p">:</span>
</span><span class="hll">            <span class="n">headers</span> <span class="o">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
</span><span class="hll">            <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">came_from</span><span class="p">,</span>
</span><span class="hll">                             <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">)</span>
</span><span class="hll">        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Failed login&#39;</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
</span><span class="hll">        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">,</span>
</span><span class="hll">        <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">application_url</span> <span class="o">+</span> <span class="s">&#39;/login&#39;</span><span class="p">,</span>
</span><span class="hll">        <span class="n">came_from</span> <span class="o">=</span> <span class="n">came_from</span><span class="p">,</span>
</span><span class="hll">        <span class="n">login</span> <span class="o">=</span> <span class="n">login</span><span class="p">,</span>
</span><span class="hll">        <span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">,</span>
</span><span class="hll">        <span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="nd">@view_config</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s">&#39;.models.Wiki&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;logout&#39;</span><span class="p">)</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class="hll">    <span class="n">headers</span> <span class="o">=</span> <span class="n">forget</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">HTTPFound</span><span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">resource_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
</span><span class="hll">                     <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">)</span>
</span></pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines need to be added.)</p>
<p>Our <tt class="docutils literal"><span class="pre">tutorial/tutorial/templates/edit.pt</span></tt> template will look
something like this when we're done:</p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span>
<span class="cp">  &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;en&quot;</span>
      <span class="na">xmlns:tal=</span><span class="s">&quot;http://xml.zope.org/namespaces/tal&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>${page.__name__} - Pyramid tutorial wiki (based on
      TurboGears 20-Minute Wiki)<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content=</span><span class="s">&quot;python web application&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;pyramid web application&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;shortcut icon&quot;</span>
        <span class="na">href=</span><span class="s">&quot;/static/favicon.ico&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
        <span class="na">href=</span><span class="s">&quot;/static/pylons.css&quot;</span>
        <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--[if lte IE 6]&gt;</span>
<span class="c">  &lt;link rel=&quot;stylesheet&quot;</span>
<span class="c">        href=&quot;/static/ie6.css&quot;</span>
<span class="c">        type=&quot;text/css&quot; media=&quot;screen&quot; charset=&quot;utf-8&quot; /&gt;</span>
<span class="c">  &lt;![endif]--&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrap&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;top-small&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;top-small align-center&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          <span class="nt">&lt;img</span> <span class="na">width=</span><span class="s">&quot;220&quot;</span> <span class="na">height=</span><span class="s">&quot;50&quot;</span> <span class="na">alt=</span><span class="s">&quot;pyramid&quot;</span>
        <span class="na">src=</span><span class="s">&quot;/static/pyramid-small.png&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;middle&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;middle align-right&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;left&quot;</span> <span class="na">class=</span><span class="s">&quot;app-welcome align-left&quot;</span><span class="nt">&gt;</span>
          Editing <span class="nt">&lt;b&gt;&lt;span</span> <span class="na">tal:replace=</span><span class="s">&quot;page.__name__&quot;</span><span class="nt">&gt;</span>Page Name
            Goes Here<span class="nt">&lt;/span&gt;&lt;/b&gt;&lt;br/&gt;</span>
          You can return to the
          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${request.application_url}&quot;</span><span class="nt">&gt;</span>FrontPage<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;right&quot;</span> <span class="na">class=</span><span class="s">&quot;app-welcome align-right&quot;</span><span class="nt">&gt;</span>
<span class="hll">          <span class="nt">&lt;span</span> <span class="na">tal:condition=</span><span class="s">&quot;logged_in&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${request.application_url}/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
</span><span class="hll">          <span class="nt">&lt;/span&gt;</span>
</span>        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;${save_url}&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span> <span class="na">tal:content=</span><span class="s">&quot;page.data&quot;</span> <span class="na">rows=</span><span class="s">&quot;10&quot;</span>
                    <span class="na">cols=</span><span class="s">&quot;60&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">name=</span><span class="s">&quot;form.submitted&quot;</span> <span class="na">value=</span><span class="s">&quot;Save&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines need to be added.)</p>
<p>Our <tt class="docutils literal"><span class="pre">tutorial/tutorial/templates/view.pt</span></tt> template will look
something like this when we're done:</p>
<div class="highlight-xml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span>
<span class="cp">  &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;</span>
<span class="nt">&lt;html</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="na">xml:lang=</span><span class="s">&quot;en&quot;</span>
      <span class="na">xmlns:tal=</span><span class="s">&quot;http://xml.zope.org/namespaces/tal&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>${page.__name__} - Pyramid tutorial wiki (based on
    TurboGears 20-Minute Wiki)<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html;charset=UTF-8&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content=</span><span class="s">&quot;python web application&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;pyramid web application&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;shortcut icon&quot;</span>
        <span class="na">href=</span><span class="s">&quot;/static/favicon.ico&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span>
        <span class="na">href=</span><span class="s">&quot;/static/pylons.css&quot;</span>
        <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--[if lte IE 6]&gt;</span>
<span class="c">  &lt;link rel=&quot;stylesheet&quot;</span>
<span class="c">        href=&quot;/static/ie6.css&quot;</span>
<span class="c">        type=&quot;text/css&quot; media=&quot;screen&quot; charset=&quot;utf-8&quot; /&gt;</span>
<span class="c">  &lt;![endif]--&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;wrap&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;top-small&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;top-small align-center&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          <span class="nt">&lt;img</span> <span class="na">width=</span><span class="s">&quot;220&quot;</span> <span class="na">height=</span><span class="s">&quot;50&quot;</span> <span class="na">alt=</span><span class="s">&quot;pyramid&quot;</span>
        <span class="na">src=</span><span class="s">&quot;/static/pyramid-small.png&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;middle&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;middle align-right&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;left&quot;</span> <span class="na">class=</span><span class="s">&quot;app-welcome align-left&quot;</span><span class="nt">&gt;</span>
          Viewing <span class="nt">&lt;b&gt;&lt;span</span> <span class="na">tal:replace=</span><span class="s">&quot;page.__name__&quot;</span><span class="nt">&gt;</span>Page Name
            Goes Here<span class="nt">&lt;/span&gt;&lt;/b&gt;&lt;br/&gt;</span>
          You can return to the
          <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${request.application_url}&quot;</span><span class="nt">&gt;</span>FrontPage<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;right&quot;</span> <span class="na">class=</span><span class="s">&quot;app-welcome align-right&quot;</span><span class="nt">&gt;</span>
<span class="hll">          <span class="nt">&lt;span</span> <span class="na">tal:condition=</span><span class="s">&quot;logged_in&quot;</span><span class="nt">&gt;</span>
</span><span class="hll">            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;${request.application_url}/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
</span><span class="hll">          <span class="nt">&lt;/span&gt;</span>
</span>        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;bottom&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">tal:replace=</span><span class="s">&quot;structure content&quot;</span><span class="nt">&gt;</span>
          Page text goes here.
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;p&gt;</span>
          <span class="nt">&lt;a</span> <span class="na">tal:attributes=</span><span class="s">&quot;href edit_url&quot;</span> <span class="na">href=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
            Edit this page
          <span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</td></tr></table></div>
<p>(Only the highlighted lines need to be added.)</p>
</div>
<div class="section" id="viewing-the-application-in-a-browser">
<h2>Viewing the Application in a Browser<a class="headerlink" href="#viewing-the-application-in-a-browser" title="Permalink to this headline">¶</a></h2>
<p>We can finally examine our application in a browser (See
<a class="reference internal" href="installation.html#wiki-start-the-application"><em>Start the Application</em></a>).  Launch a browser and visit
each of the following URLs, check that the result is as expected:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">http://localhost:6543/</span></tt> invokes the
<tt class="docutils literal"><span class="pre">view_wiki</span></tt> view.  This always redirects to the <tt class="docutils literal"><span class="pre">view_page</span></tt> view
of the <tt class="docutils literal"><span class="pre">FrontPage</span></tt> Page resource.  It is executable by any user.</li>
<li><tt class="docutils literal"><span class="pre">http://localhost:6543/FrontPage</span></tt> invokes
the <tt class="docutils literal"><span class="pre">view_page</span></tt> view of the <tt class="docutils literal"><span class="pre">FrontPage</span></tt> Page resource. This is because
it's the <a class="reference internal" href="../../glossary.html#term-default-view"><em class="xref std std-term">default view</em></a> (a view without a <tt class="docutils literal"><span class="pre">name</span></tt>) for <tt class="docutils literal"><span class="pre">Page</span></tt>
resources.  It is executable by any user.</li>
<li><tt class="docutils literal"><span class="pre">http://localhost:6543/FrontPage/edit_page</span></tt>
invokes the edit view for the FrontPage object.  It is executable by
only the <tt class="docutils literal"><span class="pre">editor</span></tt> user.  If a different user (or the anonymous
user) invokes it, a login form will be displayed.  Supplying the
credentials with the username <tt class="docutils literal"><span class="pre">editor</span></tt>, password <tt class="docutils literal"><span class="pre">editor</span></tt> will
display the edit page form.</li>
<li><tt class="docutils literal"><span class="pre">http://localhost:6543/add_page/SomePageName</span></tt>
invokes the add view for a page.  It is executable by only
the <tt class="docutils literal"><span class="pre">editor</span></tt> user.  If a different user (or the anonymous user)
invokes it, a login form will be displayed.  Supplying the
credentials with the username <tt class="docutils literal"><span class="pre">editor</span></tt>, password <tt class="docutils literal"><span class="pre">editor</span></tt> will
display the edit page form.</li>
<li>After logging in (as a result of hitting an edit or add page
and submitting the login form with the <tt class="docutils literal"><span class="pre">editor</span></tt>
credentials), we'll see a Logout link in the upper right hand
corner.  When we click it, we're logged out, and redirected
back to the front page.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adding Authorization</a><ul>
<li><a class="reference internal" href="#access-control">Access Control</a><ul>
<li><a class="reference internal" href="#add-users-and-groups">Add users and groups</a></li>
<li><a class="reference internal" href="#add-an-acl">Add an ACL</a></li>
<li><a class="reference internal" href="#add-authentication-and-authorization-policies">Add Authentication and Authorization Policies</a></li>
<li><a class="reference internal" href="#add-permission-declarations">Add permission declarations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#login-logout">Login, Logout</a><ul>
<li><a class="reference internal" href="#add-login-and-logout-views">Add Login and Logout Views</a></li>
<li><a class="reference internal" href="#add-the-login-pt-template">Add the <tt class="docutils literal"><span class="pre">login.pt</span></tt> Template</a></li>
<li><a class="reference internal" href="#return-a-logged-in-flag-to-the-renderer">Return a logged_in flag to the renderer</a></li>
<li><a class="reference internal" href="#add-a-logout-link-when-logged-in">Add a &quot;Logout&quot; link when logged in</a></li>
</ul>
</li>
<li><a class="reference internal" href="#seeing-our-changes">Seeing Our Changes</a></li>
<li><a class="reference internal" href="#viewing-the-application-in-a-browser">Viewing the Application in a Browser</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="definingviews.html"
                        title="previous chapter">Defining Views</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="tests.html"
                        title="next chapter">Adding Tests</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="tests.html" title="Adding Tests"
             >next</a> |</li>
        <li class="right" >
          <a href="definingviews.html" title="Defining Views"
             >previous</a> |</li>
    	<li><a href="../../index.html">The Pyramid Web Framework v1.5</a> &raquo;</li>
          <li><a href="index.html" >ZODB + Traversal Wiki Tutorial</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../../copyright.html">Copyright</a> 2008-2014, Agendaless Consulting.
      Last updated on Nov 09, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>