<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Unit, Integration, and Functional Testing &mdash; The Pyramid Web Framework v1.5</title>
    
    <link rel="stylesheet" href="../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="The Pyramid Web Framework v1.5" href="../index.html" />
    <link rel="next" title="Resources" href="resources.html" />
    <link rel="prev" title="Virtual Hosting" href="vhosting.html" />
<link rel="stylesheet" href="http://static.pylonsproject.org/fonts/nobile/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://static.pylonsproject.org/fonts/neuton/stylesheet.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../_static/pyramid.ico"/>

  </head>
  <body>







<div class="header-small">
	
	<div class="logo-small">
		<a href="../index.html">
      		<img class="logo" src="../_static/pyramid-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resources.html" title="Resources"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="vhosting.html" title="Virtual Hosting"
             accesskey="P">previous</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.5</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="unit-integration-and-functional-testing">
<span id="testing-chapter"></span><span id="index-0"></span><h1>Unit, Integration, and Functional Testing<a class="headerlink" href="#unit-integration-and-functional-testing" title="Permalink to this headline">¶</a></h1>
<p><em>Unit testing</em> is, not surprisingly, the act of testing a &quot;unit&quot; in your
application.  In this context, a &quot;unit&quot; is often a function or a method of a
class instance.  The unit is also referred to as a &quot;unit under test&quot;.</p>
<p>The goal of a single unit test is to test <strong>only</strong> some permutation of the
&quot;unit under test&quot;.  If you write a unit test that aims to verify the result
of a particular codepath through a Python function, you need only be
concerned about testing the code that <em>lives in the function body itself</em>.
If the function accepts a parameter that represents a complex application
&quot;domain object&quot; (such as a resource, a database connection, or an SMTP
server), the argument provided to this function during a unit test <em>need not
be</em> and likely <em>should not be</em> a &quot;real&quot; implementation object.  For example,
although a particular function implementation may accept an argument that
represents an SMTP server object, and the function may call a method of this
object when the system is operating normally that would result in an email
being sent, a unit test of this codepath of the function does <em>not</em> need to
test that an email is actually sent.  It just needs to make sure that the
function calls the method of the object provided as an argument that <em>would</em>
send an email if the argument happened to be the &quot;real&quot; implementation of an
SMTP server object.</p>
<p>An <em>integration test</em>, on the other hand, is a different form of testing in
which the interaction between two or more &quot;units&quot; is explicitly tested.
Integration tests verify that the components of your application work
together.  You <em>might</em> make sure that an email was actually sent in an
integration test.</p>
<p>A <em>functional test</em> is a form of integration test in which the application is
run &quot;literally&quot;.  You would <em>have to</em> make sure that an email was actually
sent in a functional test, because it tests your code end to end.</p>
<p>It is often considered best practice to write each type of tests for any
given codebase.  Unit testing often provides the opportunity to obtain better
&quot;coverage&quot;: it's usually possible to supply a unit under test with arguments
and/or an environment which causes <em>all</em> of its potential codepaths to be
executed.  This is usually not as easy to do with a set of integration or
functional tests, but integration and functional testing provides a measure of
assurance that your &quot;units&quot; work together, as they will be expected to when
your application is run in production.</p>
<p>The suggested mechanism for unit and integration testing of a <span>Pyramid</span>
application is the Python <a class="reference external" href="http://docs.python.org/3/library/unittest.html#module-unittest" title="(in Python v3.4)"><tt class="xref py py-mod docutils literal"><span class="pre">unittest</span></tt></a> module.  Although this module is
named <a class="reference external" href="http://docs.python.org/3/library/unittest.html#module-unittest" title="(in Python v3.4)"><tt class="xref py py-mod docutils literal"><span class="pre">unittest</span></tt></a>, it is actually capable of driving both unit and
integration tests.  A good <a class="reference external" href="http://docs.python.org/3/library/unittest.html#module-unittest" title="(in Python v3.4)"><tt class="xref py py-mod docutils literal"><span class="pre">unittest</span></tt></a> tutorial is available within <a class="reference external" href="http://www.diveintopython.net/unit_testing/index.html">Dive
Into Python</a> by Mark
Pilgrim.</p>
<p><span>Pyramid</span> provides a number of facilities that make unit, integration,
and functional tests easier to write.  The facilities become particularly
useful when your code calls into <span>Pyramid</span> -related framework functions.</p>
<div class="section" id="test-set-up-and-tear-down">
<span id="test-setup-and-teardown"></span><span id="index-1"></span><h2>Test Set Up and Tear Down<a class="headerlink" href="#test-set-up-and-tear-down" title="Permalink to this headline">¶</a></h2>
<p><span>Pyramid</span> uses a &quot;global&quot; (actually <a class="reference internal" href="../glossary.html#term-thread-local"><em class="xref std std-term">thread local</em></a>) data structure
to hold two items: the current <a class="reference internal" href="../glossary.html#term-request"><em class="xref std std-term">request</em></a> and the current
<a class="reference internal" href="../glossary.html#term-application-registry"><em class="xref std std-term">application registry</em></a>.  These data structures are available via the
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_request" title="pyramid.threadlocal.get_current_request"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.threadlocal.get_current_request()</span></tt></a> and
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_registry" title="pyramid.threadlocal.get_current_registry"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.threadlocal.get_current_registry()</span></tt></a> functions, respectively.
See <a class="reference internal" href="threadlocals.html#threadlocals-chapter"><em>Thread Locals</em></a> for information about these functions and the
data structures they return.</p>
<p>If your code uses these <tt class="docutils literal"><span class="pre">get_current_*</span></tt> functions or calls <span>Pyramid</span>
code which uses <tt class="docutils literal"><span class="pre">get_current_*</span></tt> functions, you will need to call
<a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a> in your test setup and you will need to call
<a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.tearDown()</span></tt></a> in your test teardown.
<a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">setUp()</span></tt></a> pushes a registry onto the <a class="reference internal" href="../glossary.html#term-thread-local"><em class="xref std std-term">thread
local</em></a> stack, which makes the <tt class="docutils literal"><span class="pre">get_current_*</span></tt> functions work.  It returns a
<a class="reference internal" href="../glossary.html#term-configurator"><em class="xref std std-term">Configurator</em></a> object which can be used to perform extra configuration
required by the code under test.  <a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">tearDown()</span></tt></a> pops the
thread local stack.</p>
<p>Normally when a Configurator is used directly with the <tt class="docutils literal"><span class="pre">main</span></tt> block of
a Pyramid application, it defers performing any &quot;real work&quot; until its
<tt class="docutils literal"><span class="pre">.commit</span></tt> method is called (often implicitly by the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.make_wsgi_app" title="pyramid.config.Configurator.make_wsgi_app"><tt class="xref py py-meth docutils literal"><span class="pre">pyramid.config.Configurator.make_wsgi_app()</span></tt></a> method).  The
Configurator returned by <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">setUp()</span></tt></a> is an
<em>autocommitting</em> Configurator, however, which performs all actions
implied by methods called on it immediately.  This is more convenient
for unit-testing purposes than needing to call
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.commit" title="pyramid.config.Configurator.commit"><tt class="xref py py-meth docutils literal"><span class="pre">pyramid.config.Configurator.commit()</span></tt></a> in each test after adding
extra configuration statements.</p>
<p>The use of the <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">setUp()</span></tt></a> and
<a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">tearDown()</span></tt></a> functions allows you to supply each unit
test method in a test case with an environment that has an isolated registry
and an isolated request for the duration of a single test.  Here's an example
of using this feature:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">pyramid</span> <span class="kn">import</span> <span class="n">testing</span>

<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">testing</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>The above will make sure that
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_registry" title="pyramid.threadlocal.get_current_registry"><tt class="xref py py-func docutils literal"><span class="pre">get_current_registry()</span></tt></a> called within a test
case method of <tt class="docutils literal"><span class="pre">MyTest</span></tt> will return the <a class="reference internal" href="../glossary.html#term-application-registry"><em class="xref std std-term">application registry</em></a>
associated with the <tt class="docutils literal"><span class="pre">config</span></tt> Configurator instance.  Each test case
method attached to <tt class="docutils literal"><span class="pre">MyTest</span></tt> will use an isolated registry.</p>
<p>The <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">setUp()</span></tt></a> and <a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">tearDown()</span></tt></a>
functions accepts various arguments that influence the environment of the
test.  See the <a class="reference internal" href="../api/testing.html#testing-module"><em>pyramid.testing</em></a> API for information about the extra
arguments supported by these functions.</p>
<p>If you also want to make <a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_request" title="pyramid.threadlocal.get_current_request"><tt class="xref py py-func docutils literal"><span class="pre">get_current_request()</span></tt></a> return something
other than <tt class="docutils literal"><span class="pre">None</span></tt> during the course of a single test, you can pass a
<a class="reference internal" href="../glossary.html#term-request"><em class="xref std std-term">request</em></a> object into the <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a> within the
<tt class="docutils literal"><span class="pre">setUp</span></tt> method of your test:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">pyramid</span> <span class="kn">import</span> <span class="n">testing</span>

<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">setUp</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">testing</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<p>If you pass a <a class="reference internal" href="../glossary.html#term-request"><em class="xref std std-term">request</em></a> object into <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a>
within your test case's <tt class="docutils literal"><span class="pre">setUp</span></tt>, any test method attached to the
<tt class="docutils literal"><span class="pre">MyTest</span></tt> test case that directly or indirectly calls
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_request" title="pyramid.threadlocal.get_current_request"><tt class="xref py py-func docutils literal"><span class="pre">get_current_request()</span></tt></a> will receive the request
object.  Otherwise, during testing,
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_request" title="pyramid.threadlocal.get_current_request"><tt class="xref py py-func docutils literal"><span class="pre">get_current_request()</span></tt></a> will return <tt class="docutils literal"><span class="pre">None</span></tt>.
We use a &quot;dummy&quot; request implementation supplied by
<a class="reference internal" href="../api/testing.html#pyramid.testing.DummyRequest" title="pyramid.testing.DummyRequest"><tt class="xref py py-class docutils literal"><span class="pre">pyramid.testing.DummyRequest</span></tt></a> because it's easier to construct
than a &quot;real&quot; <span>Pyramid</span> request object.</p>
<div class="section" id="test-setup-using-a-context-manager">
<h3>Test setup using a context manager<a class="headerlink" href="#test-setup-using-a-context-manager" title="Permalink to this headline">¶</a></h3>
<p>An alternative style of setting up a test configuration is to use the
<cite>with</cite> statement and <a class="reference internal" href="../api/testing.html#pyramid.testing.testConfig" title="pyramid.testing.testConfig"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.testConfig()</span></tt></a> to create a
context manager. The context manager will call
<a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a> before the code under test and
<a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.tearDown()</span></tt></a> afterwards.</p>
<p>This style is useful for small self-contained tests. For example:</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_my_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyramid</span> <span class="kn">import</span> <span class="n">testing</span>
        <span class="k">with</span> <span class="n">testing</span><span class="o">.</span><span class="n">testConfig</span><span class="p">()</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="s">&#39;/bar/{id}&#39;</span><span class="p">)</span>
            <span class="n">my_function_which_needs_route_bar</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="what">
<h3>What?<a class="headerlink" href="#what" title="Permalink to this headline">¶</a></h3>
<p>Thread local data structures are always a bit confusing, especially when
they're used by frameworks.  Sorry.  So here's a rule of thumb: if you don't
<em>know</em> whether you're calling code that uses the
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_registry" title="pyramid.threadlocal.get_current_registry"><tt class="xref py py-func docutils literal"><span class="pre">get_current_registry()</span></tt></a> or
<a class="reference internal" href="../api/threadlocal.html#pyramid.threadlocal.get_current_request" title="pyramid.threadlocal.get_current_request"><tt class="xref py py-func docutils literal"><span class="pre">get_current_request()</span></tt></a> functions, or you don't care
about any of this, but you still want to write test code, just always call
<a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a> in your test's <tt class="docutils literal"><span class="pre">setUp</span></tt> method and
<a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.tearDown()</span></tt></a> in your tests' <tt class="docutils literal"><span class="pre">tearDown</span></tt> method.  This
won't really hurt anything if the application you're testing does not call
any <tt class="docutils literal"><span class="pre">get_current*</span></tt> function.</p>
</div>
</div>
<div class="section" id="using-the-configurator-and-pyramid-testing-apis-in-unit-tests">
<span id="index-2"></span><h2>Using the <tt class="docutils literal"><span class="pre">Configurator</span></tt> and <tt class="docutils literal"><span class="pre">pyramid.testing</span></tt> APIs in Unit Tests<a class="headerlink" href="#using-the-configurator-and-pyramid-testing-apis-in-unit-tests" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">Configurator</span></tt> API and the <a class="reference internal" href="../api/testing.html#module-pyramid.testing" title="pyramid.testing"><tt class="xref py py-mod docutils literal"><span class="pre">pyramid.testing</span></tt></a> module provide a number
of functions which can be used during unit testing.  These functions make
<a class="reference internal" href="../glossary.html#term-configuration-declaration"><em class="xref std std-term">configuration declaration</em></a> calls to the current <a class="reference internal" href="../glossary.html#term-application-registry"><em class="xref std std-term">application
registry</em></a>, but typically register a &quot;stub&quot; or &quot;dummy&quot; feature in place of the
&quot;real&quot; feature that the code would call if it was being run normally.</p>
<p>For example, let's imagine you want to unit test a <span>Pyramid</span> view
function.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPForbidden</span>

<span class="k">def</span> <span class="nf">view_fn</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s">&#39;edit&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">HTTPForbidden</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;greeting&#39;</span><span class="p">:</span><span class="s">&#39;hello&#39;</span><span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This code implies that you have defined a renderer imperatively in a
relevant <a class="reference internal" href="../api/config.html#pyramid.config.Configurator" title="pyramid.config.Configurator"><tt class="xref py py-class docutils literal"><span class="pre">pyramid.config.Configurator</span></tt></a> instance,
otherwise it would fail when run normally.</p>
</div>
<p>Without doing anything special during a unit test, the call to
<a class="reference internal" href="../api/request.html#pyramid.request.Request.has_permission" title="pyramid.request.Request.has_permission"><tt class="xref py py-meth docutils literal"><span class="pre">has_permission()</span></tt></a> in this view function will
always return a <tt class="docutils literal"><span class="pre">True</span></tt> value.  When a <span>Pyramid</span> application starts
normally, it will populate a <a class="reference internal" href="../glossary.html#term-application-registry"><em class="xref std std-term">application registry</em></a> using
<a class="reference internal" href="../glossary.html#term-configuration-declaration"><em class="xref std std-term">configuration declaration</em></a> calls made against a <a class="reference internal" href="../glossary.html#term-configurator"><em class="xref std std-term">Configurator</em></a>.
But if this application registry is not created and populated (e.g. by
initializing the configurator with an authorization policy), like when you
invoke application code via a unit test, <span>Pyramid</span> API functions will tend
to either fail or return default results.  So how do you test the branch of the
code in this view function that raises
<a class="reference internal" href="../api/httpexceptions.html#pyramid.httpexceptions.HTTPForbidden" title="pyramid.httpexceptions.HTTPForbidden"><tt class="xref py py-exc docutils literal"><span class="pre">HTTPForbidden</span></tt></a>?</p>
<p>The testing API provided by <span>Pyramid</span> allows you to simulate various
application registry registrations for use under a unit testing framework
without needing to invoke the actual application configuration implied by its
<tt class="docutils literal"><span class="pre">main</span></tt> function.  For example, if you wanted to test the above <tt class="docutils literal"><span class="pre">view_fn</span></tt>
(assuming it lived in the package named <tt class="docutils literal"><span class="pre">my.package</span></tt>), you could write a
<a class="reference external" href="http://docs.python.org/3/library/unittest.html#unittest.TestCase" title="(in Python v3.4)"><tt class="xref py py-class docutils literal"><span class="pre">unittest.TestCase</span></tt></a> that used the testing API.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">pyramid</span> <span class="kn">import</span> <span class="n">testing</span>

<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">testing</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_view_fn_forbidden</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="n">HTTPForbidden</span>
        <span class="kn">from</span> <span class="nn">my.package</span> <span class="kn">import</span> <span class="n">view_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">testing_securitypolicy</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="s">&#39;hank&#39;</span><span class="p">,</span>
                                           <span class="n">permissive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyResource</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">HTTPForbidden</span><span class="p">,</span> <span class="n">view_fn</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_view_fn_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">my.package</span> <span class="kn">import</span> <span class="n">view_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">testing_securitypolicy</span><span class="p">(</span><span class="n">userid</span><span class="o">=</span><span class="s">&#39;hank&#39;</span><span class="p">,</span>
                                           <span class="n">permissive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">()</span>
        <span class="n">request</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyResource</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">view_fn</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;greeting&#39;</span><span class="p">:</span><span class="s">&#39;hello&#39;</span><span class="p">})</span>
</pre></div>
</td></tr></table></div>
<p>In the above example, we create a <tt class="docutils literal"><span class="pre">MyTest</span></tt> test case that inherits from
<a class="reference external" href="http://docs.python.org/3/library/unittest.html#unittest.TestCase" title="(in Python v3.4)"><tt class="xref py py-class docutils literal"><span class="pre">unittest.TestCase</span></tt></a>.  If it's in our <span>Pyramid</span> application, it will
be found when <tt class="docutils literal"><span class="pre">setup.py</span> <span class="pre">test</span></tt> is run.  It has two test methods.</p>
<p>The first test method, <tt class="docutils literal"><span class="pre">test_view_fn_forbidden</span></tt> tests the <tt class="docutils literal"><span class="pre">view_fn</span></tt> when
the authentication policy forbids the current user the <tt class="docutils literal"><span class="pre">edit</span></tt> permission.
Its third line registers a &quot;dummy&quot; &quot;non-permissive&quot; authorization policy
using the <a class="reference internal" href="../api/config.html#pyramid.config.Configurator.testing_securitypolicy" title="pyramid.config.Configurator.testing_securitypolicy"><tt class="xref py py-meth docutils literal"><span class="pre">testing_securitypolicy()</span></tt></a> method,
which is a special helper method for unit testing.</p>
<p>We then create a <a class="reference internal" href="../api/testing.html#pyramid.testing.DummyRequest" title="pyramid.testing.DummyRequest"><tt class="xref py py-class docutils literal"><span class="pre">pyramid.testing.DummyRequest</span></tt></a> object which simulates a
WebOb request object API.  A <a class="reference internal" href="../api/testing.html#pyramid.testing.DummyRequest" title="pyramid.testing.DummyRequest"><tt class="xref py py-class docutils literal"><span class="pre">pyramid.testing.DummyRequest</span></tt></a> is a request
object that requires less setup than a &quot;real&quot; <span>Pyramid</span> request.  We call
the function being tested with the manufactured request.  When the function is
called, <a class="reference internal" href="../api/request.html#pyramid.request.Request.has_permission" title="pyramid.request.Request.has_permission"><tt class="xref py py-meth docutils literal"><span class="pre">pyramid.request.Request.has_permission()</span></tt></a> will call the &quot;dummy&quot;
authentication policy we've registered through
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.testing_securitypolicy" title="pyramid.config.Configurator.testing_securitypolicy"><tt class="xref py py-meth docutils literal"><span class="pre">testing_securitypolicy()</span></tt></a>, which denies
access.  We check that the view function raises a
<a class="reference internal" href="../api/httpexceptions.html#pyramid.httpexceptions.HTTPForbidden" title="pyramid.httpexceptions.HTTPForbidden"><tt class="xref py py-exc docutils literal"><span class="pre">HTTPForbidden</span></tt></a> error.</p>
<p>The second test method, named <tt class="docutils literal"><span class="pre">test_view_fn_allowed</span></tt>, tests the alternate
case, where the authentication policy allows access.  Notice that we pass
different values to
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.testing_securitypolicy" title="pyramid.config.Configurator.testing_securitypolicy"><tt class="xref py py-meth docutils literal"><span class="pre">testing_securitypolicy()</span></tt></a> to obtain this
result.  We assert at the end of this that the view function returns a value.</p>
<p>Note that the test calls the <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a> function in its
<tt class="docutils literal"><span class="pre">setUp</span></tt> method and the <a class="reference internal" href="../api/testing.html#pyramid.testing.tearDown" title="pyramid.testing.tearDown"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.tearDown()</span></tt></a> function in its
<tt class="docutils literal"><span class="pre">tearDown</span></tt> method.  We assign the result of <a class="reference internal" href="../api/testing.html#pyramid.testing.setUp" title="pyramid.testing.setUp"><tt class="xref py py-func docutils literal"><span class="pre">pyramid.testing.setUp()</span></tt></a>
as <tt class="docutils literal"><span class="pre">config</span></tt> on the unittest class.  This is a <a class="reference internal" href="../glossary.html#term-configurator"><em class="xref std std-term">Configurator</em></a> object
and all methods of the configurator can be called as necessary within
tests. If you use any of the <a class="reference internal" href="../api/config.html#pyramid.config.Configurator" title="pyramid.config.Configurator"><tt class="xref py py-class docutils literal"><span class="pre">Configurator</span></tt></a> APIs during
testing, be sure to use this pattern in your test case's <tt class="docutils literal"><span class="pre">setUp</span></tt> and
<tt class="docutils literal"><span class="pre">tearDown</span></tt>; these methods make sure you're using a &quot;fresh&quot;
<a class="reference internal" href="../glossary.html#term-application-registry"><em class="xref std std-term">application registry</em></a> per test run.</p>
<p>See the <a class="reference internal" href="../api/testing.html#testing-module"><em>pyramid.testing</em></a> chapter for the entire <span>Pyramid</span> -specific
testing API.  This chapter describes APIs for registering a security policy,
registering resources at paths, registering event listeners, registering
views and view permissions, and classes representing &quot;dummy&quot; implementations
of a request and a resource.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">See also the various methods of the <a class="reference internal" href="../glossary.html#term-configurator"><em class="xref std std-term">Configurator</em></a> documented in
<a class="reference internal" href="../api/config.html#configuration-module"><em>pyramid.config</em></a> that begin with the <tt class="docutils literal"><span class="pre">testing_</span></tt> prefix.</p>
</div>
</div>
<div class="section" id="creating-integration-tests">
<span id="integration-tests"></span><span id="index-3"></span><h2>Creating Integration Tests<a class="headerlink" href="#creating-integration-tests" title="Permalink to this headline">¶</a></h2>
<p>In <span>Pyramid</span>, a <em>unit test</em> typically relies on &quot;mock&quot; or &quot;dummy&quot;
implementations to give the code under test only enough context to run.</p>
<p>&quot;Integration testing&quot; implies another sort of testing.  In the context of a
<span>Pyramid</span> integration test, the test logic tests the functionality of
some code <em>and</em> its integration with the rest of the <span>Pyramid</span>
framework.</p>
<p>In <span>Pyramid</span> applications that are plugins to Pyramid, you can create an
integration test by including its <tt class="docutils literal"><span class="pre">includeme</span></tt> function via
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator.include" title="pyramid.config.Configurator.include"><tt class="xref py py-meth docutils literal"><span class="pre">pyramid.config.Configurator.include()</span></tt></a> in the test's setup code.  This
causes the entire <span>Pyramid</span> environment to be set up and torn down as if
your application was running &quot;for real&quot;.  This is a heavy-hammer way of
making sure that your tests have enough context to run properly, and it tests
your code's integration with the rest of <span>Pyramid</span>.</p>
<p>Let's demonstrate this by showing an integration test for a view.  The below
test assumes that your application's package name is <tt class="docutils literal"><span class="pre">myapp</span></tt>, and that
there is a <tt class="docutils literal"><span class="pre">views</span></tt> module in the app with a function with the name
<tt class="docutils literal"><span class="pre">my_view</span></tt> in it that returns the response 'Welcome to this application'
after accessing some values that require a fully set up environment.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">pyramid</span> <span class="kn">import</span> <span class="n">testing</span>

<span class="k">class</span> <span class="nc">ViewIntegrationTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This sets up the application registry with the</span>
<span class="sd">        registrations your application declares in its ``includeme``</span>
<span class="sd">        function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">myapp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">&#39;myapp&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear out the application registry &quot;&quot;&quot;</span>
        <span class="n">testing</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_my_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">myapp.views</span> <span class="kn">import</span> <span class="n">my_view</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">testing</span><span class="o">.</span><span class="n">DummyRequest</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s">&#39;200 OK&#39;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">app_iter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;Welcome to&#39;</span> <span class="ow">in</span> <span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">headerlist</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">headerlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/html; charset=UTF-8&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">headerlist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))))</span>
</pre></div>
</td></tr></table></div>
<p>Unless you cannot avoid it, you should prefer writing unit tests that use the
<a class="reference internal" href="../api/config.html#pyramid.config.Configurator" title="pyramid.config.Configurator"><tt class="xref py py-class docutils literal"><span class="pre">Configurator</span></tt></a> API to set up the right &quot;mock&quot;
registrations rather than creating an integration test.  Unit tests will run
faster (because they do less for each test) and the result of a unit test is
usually easier to make assertions about.</p>
</div>
<div class="section" id="creating-functional-tests">
<span id="functional-tests"></span><span id="index-4"></span><h2>Creating Functional Tests<a class="headerlink" href="#creating-functional-tests" title="Permalink to this headline">¶</a></h2>
<p>Functional tests test your literal application.</p>
<p>The below test assumes that your application's package name is <tt class="docutils literal"><span class="pre">myapp</span></tt>, and
that there is a view that returns an HTML body when the root URL is invoked.
It further assumes that you've added a <tt class="docutils literal"><span class="pre">tests_require</span></tt> dependency on the
<tt class="docutils literal"><span class="pre">WebTest</span></tt> package within your <tt class="docutils literal"><span class="pre">setup.py</span></tt> file.  <a class="reference internal" href="../glossary.html#term-webtest"><em class="xref std std-term">WebTest</em></a> is a
functional testing package written by Ian Bicking.</p>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">FunctionalTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">main</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">main</span><span class="p">({})</span>
        <span class="kn">from</span> <span class="nn">webtest</span> <span class="kn">import</span> <span class="n">TestApp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span> <span class="o">=</span> <span class="n">TestApp</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testapp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;Pyramid&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>When this test is run, each test creates a &quot;real&quot; WSGI application using the
<tt class="docutils literal"><span class="pre">main</span></tt> function in your <tt class="docutils literal"><span class="pre">myapp.__init__</span></tt> module and uses <a class="reference internal" href="../glossary.html#term-webtest"><em class="xref std std-term">WebTest</em></a>
to wrap that WSGI application.  It assigns the result to <tt class="docutils literal"><span class="pre">self.testapp</span></tt>.
In the test named <tt class="docutils literal"><span class="pre">test_root</span></tt>, we use the testapp's <tt class="docutils literal"><span class="pre">get</span></tt> method to
invoke the root URL.  We then assert that the returned HTML has the string
<tt class="docutils literal"><span class="pre">Pyramid</span></tt> in it.</p>
<p>See the <a class="reference internal" href="../glossary.html#term-webtest"><em class="xref std std-term">WebTest</em></a> documentation for further information about the
methods available to a <a class="reference external" href="http://webtest.pythonpaste.org/en/latest/api.html#webtest.app.TestApp" title="(in WebTest v2.0.17.dev0)"><tt class="xref py py-class docutils literal"><span class="pre">webtest.app.TestApp</span></tt></a> instance.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Unit, Integration, and Functional Testing</a><ul>
<li><a class="reference internal" href="#test-set-up-and-tear-down">Test Set Up and Tear Down</a><ul>
<li><a class="reference internal" href="#test-setup-using-a-context-manager">Test setup using a context manager</a></li>
<li><a class="reference internal" href="#what">What?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-the-configurator-and-pyramid-testing-apis-in-unit-tests">Using the <tt class="docutils literal"><span class="pre">Configurator</span></tt> and <tt class="docutils literal"><span class="pre">pyramid.testing</span></tt> APIs in Unit Tests</a></li>
<li><a class="reference internal" href="#creating-integration-tests">Creating Integration Tests</a></li>
<li><a class="reference internal" href="#creating-functional-tests">Creating Functional Tests</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="vhosting.html"
                        title="previous chapter">Virtual Hosting</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="resources.html"
                        title="next chapter">Resources</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="resources.html" title="Resources"
             >next</a> |</li>
        <li class="right" >
          <a href="vhosting.html" title="Virtual Hosting"
             >previous</a> |</li>
    	<li><a href="../index.html">The Pyramid Web Framework v1.5</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; <a href="../copyright.html">Copyright</a> 2008-2014, Agendaless Consulting.
      Last updated on Nov 09, 2014.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>