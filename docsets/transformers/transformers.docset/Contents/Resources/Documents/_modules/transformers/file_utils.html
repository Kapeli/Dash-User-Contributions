

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>transformers.file_utils &mdash; transformers 4.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/huggingface.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/code-snippets.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/hidesidebar.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/js/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> transformers
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quicktour.html">Quick tour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">Using 🤗 Transformers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../task_summary.html">Summary of the tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_summary.html">Summary of the models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Preprocessing data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training and fine-tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_sharing.html">Model sharing and uploading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tokenizer_summary.html">Summary of the tokenizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multilingual.html">Multi-lingual models</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pretrained_models.html">Pretrained models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_datasets.html">Fine-tuning with custom datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks.html">🤗 Transformers Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../converting_tensorflow_models.html">Converting Tensorflow Checkpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migration.html">Migrating from previous packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">How to contribute to transformers?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serialization.html">Exporting transformers models</a></li>
</ul>
<p class="caption"><span class="caption-text">Research</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../bertology.html">BERTology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../perplexity.html">Perplexity of fixed-length models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks.html">Benchmarks</a></li>
</ul>
<p class="caption"><span class="caption-text">Main Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/callback.html">Callbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/model.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/optimizer_schedules.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/output.html">Model outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/pipelines.html">Pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/processors.html">Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/tokenizer.html">Tokenizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../main_classes/trainer.html">Trainer</a></li>
</ul>
<p class="caption"><span class="caption-text">Models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/albert.html">ALBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/auto.html">Auto Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/bart.html">BART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/barthez.html">BARThez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/bert.html">BERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/bertweet.html">Bertweet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/bertgeneration.html">BertGeneration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/blenderbot.html">Blenderbot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/blenderbot_small.html">Blenderbot Small</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/camembert.html">CamemBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/ctrl.html">CTRL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/deberta.html">DeBERTa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/dialogpt.html">DialoGPT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/distilbert.html">DistilBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/dpr.html">DPR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/electra.html">ELECTRA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/encoderdecoder.html">Encoder Decoder Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/flaubert.html">FlauBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/fsmt.html">FSMT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/funnel.html">Funnel Transformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/herbert.html">herBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/layoutlm.html">LayoutLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/led.html">LED</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/longformer.html">Longformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/lxmert.html">LXMERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/marian.html">MarianMT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/mbart.html">MBart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/mobilebert.html">MobileBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/mpnet.html">MPNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/mt5.html">MT5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/gpt.html">OpenAI GPT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/gpt2.html">OpenAI GPT2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/pegasus.html">Pegasus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/phobert.html">PhoBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/prophetnet.html">ProphetNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/rag.html">RAG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/reformer.html">Reformer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/retribert.html">RetriBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/roberta.html">RoBERTa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/squeezebert.html">SqueezeBERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/t5.html">T5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/tapas.html">TAPAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/transformerxl.html">Transformer XL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/xlm.html">XLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/xlmprophetnet.html">XLM-ProphetNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/xlmroberta.html">XLM-RoBERTa</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_doc/xlnet.html">XLNet</a></li>
</ul>
<p class="caption"><span class="caption-text">Internal Helpers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internal/modeling_utils.html">Custom Layers and Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/pipelines_utils.html">Utilities for pipelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/tokenization_utils.html">Utilities for Tokenizers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/trainer_utils.html">Utilities for Trainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internal/generation_utils.html">Utilities for Generation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">transformers</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>transformers.file_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for transformers.file_utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2020 The HuggingFace Team, the AllenNLP library authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities for working with the local dataset cache. Parts of this file is adapted from the AllenNLP library at</span>
<span class="sd">https://github.com/allenai/allennlp.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">ModuleType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">is_zipfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">packaging</span> <span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">FileLock</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.hf_api</span> <span class="kn">import</span> <span class="n">HfFolder</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">logging</span>


<span class="c1"># The package importlib_metadata is in a different place, depending on the python version.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">importlib_metadata</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">importlib.metadata</span> <span class="k">as</span> <span class="nn">importlib_metadata</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="n">ENV_VARS_TRUE_VALUES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;ON&quot;</span><span class="p">,</span> <span class="s2">&quot;YES&quot;</span><span class="p">}</span>
<span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span> <span class="o">=</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s2">&quot;AUTO&quot;</span><span class="p">})</span>

<span class="n">USE_TF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USE_TF&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">USE_TORCH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USE_TORCH&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">USE_JAX</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USE_FLAX&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="k">if</span> <span class="n">USE_TORCH</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span> <span class="ow">and</span> <span class="n">USE_TF</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="p">:</span>
    <span class="n">_torch_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_torch_available</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_torch_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PyTorch version </span><span class="si">{</span><span class="n">_torch_version</span><span class="si">}</span><span class="s2"> available.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="n">_torch_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disabling PyTorch because USE_TF is set&quot;</span><span class="p">)</span>
    <span class="n">_torch_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">if</span> <span class="n">USE_TF</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span> <span class="ow">and</span> <span class="n">USE_TORCH</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_VALUES</span><span class="p">:</span>
    <span class="n">_tf_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_tf_available</span><span class="p">:</span>
        <span class="c1"># For the metadata, we have to look for both tensorflow and tensorflow-cpu</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tensorflow-cpu&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tensorflow-gpu&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tf-nightly&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tf-nightly-cpu&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">_tf_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;tf-nightly-gpu&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
                                <span class="n">_tf_version</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">_tf_available</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">_tf_available</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">_tf_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TensorFlow found but with version </span><span class="si">{</span><span class="n">_tf_version</span><span class="si">}</span><span class="s2">. Transformers requires version 2 minimum.&quot;</span><span class="p">)</span>
            <span class="n">_tf_available</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TensorFlow version </span><span class="si">{</span><span class="n">_tf_version</span><span class="si">}</span><span class="s2"> available.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Disabling Tensorflow because USE_TORCH is set&quot;</span><span class="p">)</span>
    <span class="n">_tf_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">if</span> <span class="n">USE_JAX</span> <span class="ow">in</span> <span class="n">ENV_VARS_TRUE_AND_AUTO_VALUES</span><span class="p">:</span>
    <span class="n">_flax_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;flax&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_flax_available</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_jax_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;jax&quot;</span><span class="p">)</span>
            <span class="n">_flax_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;flax&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JAX version </span><span class="si">{</span><span class="n">_jax_version</span><span class="si">}</span><span class="s2">, Flax version </span><span class="si">{</span><span class="n">_flax_version</span><span class="si">}</span><span class="s2"> available.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="n">_flax_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">_flax_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_datasets_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Check we&#39;re not importing a &quot;datasets&quot; directory somewhere but the actual library by trying to grab the version</span>
    <span class="c1"># AND checking it has an author field in the metadata that is HuggingFace.</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">)</span>
    <span class="n">_datasets_metadata</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">metadata</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_datasets_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;HuggingFace Inc.&quot;</span><span class="p">:</span>
        <span class="n">_datasets_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_datasets_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_faiss_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;faiss&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_faiss_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;faiss&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported faiss version </span><span class="si">{</span><span class="n">_faiss_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_faiss_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">_scatter_available</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_scatter&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">_scatter_version</span> <span class="o">=</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;torch_scatter&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully imported torch-scatter version </span><span class="si">{</span><span class="n">_scatter_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
    <span class="n">_scatter_available</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">torch_cache_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TORCH_HOME&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;XDG_CACHE_HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.cache&quot;</span><span class="p">),</span> <span class="s2">&quot;torch&quot;</span><span class="p">))</span>
<span class="n">old_default_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">torch_cache_home</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">)</span>
<span class="c1"># New default cache, shared with the Datasets library</span>
<span class="n">hf_cache_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HF_HOME&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;XDG_CACHE_HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;~/.cache&quot;</span><span class="p">),</span> <span class="s2">&quot;huggingface&quot;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">default_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hf_cache_home</span><span class="p">,</span> <span class="s2">&quot;transformers&quot;</span><span class="p">)</span>

<span class="c1"># Onetime move from the old location to the new one if no ENV variable has been set.</span>
<span class="k">if</span> <span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_default_cache_path</span><span class="p">)</span>
    <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">default_cache_path</span><span class="p">)</span>
    <span class="ow">and</span> <span class="s2">&quot;PYTORCH_PRETRAINED_BERT_CACHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="ow">and</span> <span class="s2">&quot;PYTORCH_TRANSFORMERS_CACHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="ow">and</span> <span class="s2">&quot;TRANSFORMERS_CACHE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
<span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;In Transformers v4.0.0, the default path to cache downloaded models changed from &quot;</span>
        <span class="s2">&quot;&#39;~/.cache/torch/transformers&#39; to &#39;~/.cache/huggingface/transformers&#39;. Since you don&#39;t seem to have overridden &quot;</span>
        <span class="s2">&quot;and &#39;~/.cache/torch/transformers&#39; is a directory that exists, we&#39;re moving it to &quot;</span>
        <span class="s2">&quot;&#39;~/.cache/huggingface/transformers&#39; to avoid redownloading models you have already in the cache. You should &quot;</span>
        <span class="s2">&quot;only see this message once.&quot;</span>
    <span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">old_default_cache_path</span><span class="p">,</span> <span class="n">default_cache_path</span><span class="p">)</span>

<span class="n">PYTORCH_PRETRAINED_BERT_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTORCH_PRETRAINED_BERT_CACHE&quot;</span><span class="p">,</span> <span class="n">default_cache_path</span><span class="p">)</span>
<span class="n">PYTORCH_TRANSFORMERS_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYTORCH_TRANSFORMERS_CACHE&quot;</span><span class="p">,</span> <span class="n">PYTORCH_PRETRAINED_BERT_CACHE</span><span class="p">)</span>
<span class="n">TRANSFORMERS_CACHE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TRANSFORMERS_CACHE&quot;</span><span class="p">,</span> <span class="n">PYTORCH_TRANSFORMERS_CACHE</span><span class="p">)</span>

<span class="n">WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;pytorch_model.bin&quot;</span>
<span class="n">TF2_WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;tf_model.h5&quot;</span>
<span class="n">TF_WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;model.ckpt&quot;</span>
<span class="n">FLAX_WEIGHTS_NAME</span> <span class="o">=</span> <span class="s2">&quot;flax_model.msgpack&quot;</span>
<span class="n">CONFIG_NAME</span> <span class="o">=</span> <span class="s2">&quot;config.json&quot;</span>
<span class="n">MODEL_CARD_NAME</span> <span class="o">=</span> <span class="s2">&quot;modelcard.json&quot;</span>

<span class="n">SENTENCEPIECE_UNDERLINE</span> <span class="o">=</span> <span class="s2">&quot;▁&quot;</span>
<span class="n">SPIECE_UNDERLINE</span> <span class="o">=</span> <span class="n">SENTENCEPIECE_UNDERLINE</span>  <span class="c1"># Kept for backward compatibility</span>

<span class="n">MULTIPLE_CHOICE_DUMMY_INPUTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># Needs to have 0s and 1s only since XLM uses it for langs too.</span>
<span class="n">DUMMY_INPUTS</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]]</span>
<span class="n">DUMMY_MASK</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="n">S3_BUCKET_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://s3.amazonaws.com/models.huggingface.co/bert&quot;</span>
<span class="n">CLOUDFRONT_DISTRIB_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://cdn.huggingface.co&quot;</span>
<span class="n">HUGGINGFACE_CO_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;https://huggingface.co/</span><span class="si">{model_id}</span><span class="s2">/resolve/</span><span class="si">{revision}</span><span class="s2">/</span><span class="si">{filename}</span><span class="s2">&quot;</span>

<span class="n">PRESET_MIRROR_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;tuna&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mirrors.tuna.tsinghua.edu.cn/hugging-face-models&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bfsu&quot;</span><span class="p">:</span> <span class="s2">&quot;https://mirrors.bfsu.edu.cn/hugging-face-models&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">is_torch_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_torch_available</span>


<span class="k">def</span> <span class="nf">is_tf_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_tf_available</span>


<span class="k">def</span> <span class="nf">is_flax_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_flax_available</span>


<span class="k">def</span> <span class="nf">is_torch_tpu_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_torch_available</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># This test is probably enough, but just in case, we unpack a bit.</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_xla&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_xla.core&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;torch_xla.core.xla_model&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_datasets_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_datasets_available</span>


<span class="k">def</span> <span class="nf">is_psutil_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;psutil&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_py3nvml_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;py3nvml&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_apex_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;apex&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_faiss_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_faiss_available</span>


<span class="k">def</span> <span class="nf">is_sklearn_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sklearn&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;scipy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sklearn.metrics&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;scipy.stats&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_sentencepiece_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;sentencepiece&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_protobuf_available</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;google&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;google.protobuf&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_tokenizers_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;tokenizers&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">is_in_notebook</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Test adapted from tqdm.autonotebook: https://github.com/tqdm/tqdm/blob/master/tqdm/autonotebook.py</span>
        <span class="n">get_ipython</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;IPython&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ipython</span>
        <span class="k">if</span> <span class="s2">&quot;IPKernelApp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;console&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;VSCODE_PID&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;vscode&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;IPython&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">is_scatter_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_scatter_available</span>


<span class="k">def</span> <span class="nf">is_pandas_available</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="s2">&quot;pandas&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">torch_only_method</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_torch_available</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;You need to install pytorch to use this method or class, &quot;</span>
                <span class="s2">&quot;or activate it with environment variables USE_TORCH=1 and USE_TF=0.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">DATASETS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the 🤗 Datasets library but it was not found in your environment. You can install it with:</span>
<span class="s2">```</span>
<span class="s2">pip install datasets</span>
<span class="s2">```</span>
<span class="s2">In a notebook or a colab, you can install it by executing a cell with</span>
<span class="s2">```</span>
<span class="s2">!pip install datasets</span>
<span class="s2">```</span>
<span class="s2">then restarting your kernel.</span>

<span class="s2">Note that if you have a local folder named `datasets` or a local python file named `datasets.py` in your current</span>
<span class="s2">working directory, python may try to import this instead of the 🤗 Datasets library. You should rename this folder or</span>
<span class="s2">that python file if that&#39;s the case.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">TOKENIZERS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the 🤗 Tokenizers library but it was not found in your environment. You can install it with:</span>
<span class="s2">```</span>
<span class="s2">pip install tokenizers</span>
<span class="s2">```</span>
<span class="s2">In a notebook or a colab, you can install it by executing a cell with</span>
<span class="s2">```</span>
<span class="s2">!pip install tokenizers</span>
<span class="s2">```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SENTENCEPIECE_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the SentencePiece library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page of its repo: https://github.com/google/sentencepiece#installation and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PROTOBUF_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the protobuf library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page of its repo: https://github.com/protocolbuffers/protobuf/tree/master/python#installation and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">FAISS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the faiss library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page of its repo: https://github.com/facebookresearch/faiss/blob/master/INSTALL.md and follow the ones</span>
<span class="s2">that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PYTORCH_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the PyTorch library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://pytorch.org/get-started/locally/ and follow the ones that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SKLEARN_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the scikit-learn library but it was not found in your environment. You can install it with:</span>
<span class="s2">```</span>
<span class="s2">pip install -U scikit-learn</span>
<span class="s2">```</span>
<span class="s2">In a notebook or a colab, you can install it by executing a cell with</span>
<span class="s2">```</span>
<span class="s2">!pip install -U scikit-learn</span>
<span class="s2">```</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">TENSORFLOW_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the TensorFlow library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://www.tensorflow.org/install and follow the ones that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">FLAX_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the FLAX library but it was not found in your environment. Checkout the instructions on the</span>
<span class="s2">installation page: https://github.com/google/flax and follow the ones that match your environment.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">SCATTER_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the torch-scatter library but it was not found in your environment. You can install it with pip as</span>
<span class="s2">explained here: https://github.com/rusty1s/pytorch_scatter.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># docstyle-ignore</span>
<span class="n">PANDAS_IMPORT_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{0}</span><span class="s2"> requires the pandas library but it was not found in your environment. You can install it with pip as</span>
<span class="s2">explained here: https://pandas.pydata.org/pandas-docs/stable/getting_started/install.html.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">requires_datasets</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_datasets_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">DATASETS_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_faiss</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_faiss_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">FAISS_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_pytorch</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">PYTORCH_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_sklearn</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sklearn_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">SKLEARN_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_tf</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_tf_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">TENSORFLOW_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_flax</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_flax_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">FLAX_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_tokenizers</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_tokenizers_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">TOKENIZERS_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_sentencepiece</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_sentencepiece_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">SENTENCEPIECE_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_protobuf</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_protobuf_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">PROTOBUF_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_pandas</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_pandas_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">PANDAS_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">requires_scatter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_scatter_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="n">SCATTER_IMPORT_ERROR</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">add_start_docstrings</span><span class="p">(</span><span class="o">*</span><span class="n">docstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span>


<span class="k">def</span> <span class="nf">add_start_docstrings_to_model_forward</span><span class="p">(</span><span class="o">*</span><span class="n">docstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="s2">&quot;:class:`~transformers.</span><span class="si">{}</span><span class="s2">`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">intro</span> <span class="o">=</span> <span class="s2">&quot;   The </span><span class="si">{}</span><span class="s2"> forward method, overrides the :func:`__call__` special method.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
        <span class="n">note</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    .. note::</span>
<span class="s2">        Although the recipe for forward pass needs to be defined within this function, one should call the</span>
<span class="s2">        :class:`Module` instance afterwards instead of this since the former takes care of running the pre and post</span>
<span class="s2">        processing steps while the latter silently ignores them.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">note</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span>


<span class="k">def</span> <span class="nf">add_end_docstrings</span><span class="p">(</span><span class="o">*</span><span class="n">docstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span>


<span class="n">PT_RETURN_INTRODUCTION</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Returns:</span>
<span class="s2">        :class:`~</span><span class="si">{full_output_type}</span><span class="s2">` or :obj:`tuple(torch.FloatTensor)`: A :class:`~</span><span class="si">{full_output_type}</span><span class="s2">` (if</span>
<span class="s2">        ``return_dict=True`` is passed or when ``config.return_dict=True``) or a tuple of :obj:`torch.FloatTensor`</span>
<span class="s2">        comprising various elements depending on the configuration (:class:`~transformers.</span><span class="si">{config_class}</span><span class="s2">`) and inputs.</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="n">TF_RETURN_INTRODUCTION</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Returns:</span>
<span class="s2">        :class:`~</span><span class="si">{full_output_type}</span><span class="s2">` or :obj:`tuple(tf.Tensor)`: A :class:`~</span><span class="si">{full_output_type}</span><span class="s2">` (if</span>
<span class="s2">        ``return_dict=True`` is passed or when ``config.return_dict=True``) or a tuple of :obj:`tf.Tensor` comprising</span>
<span class="s2">        various elements depending on the configuration (:class:`~transformers.</span><span class="si">{config_class}</span><span class="s2">`) and inputs.</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_get_indent</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the indentation in the first line of t&quot;&quot;&quot;</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\s*)\S&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">search</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">search</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_convert_output_args_doc</span><span class="p">(</span><span class="n">output_args_doc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert output_args_doc to display properly.&quot;&quot;&quot;</span>
    <span class="c1"># Split output_arg_doc in blocks argument/description</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="n">_get_indent</span><span class="p">(</span><span class="n">output_args_doc</span><span class="p">)</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_block</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output_args_doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="c1"># If the indent is the same as the beginning, the line is the name of new arg.</span>
        <span class="k">if</span> <span class="n">_get_indent</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="n">indent</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_block</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">current_block</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise it&#39;s part of the description of the current arg.</span>
            <span class="c1"># We need to remove 2 spaces to the indentation.</span>
            <span class="n">current_block</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_block</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Format each block for proper rendering</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)):</span>
        <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\s+)(\S+)(\s+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1- **\2**\3&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;:\s*\n\s*(\S)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot; -- \1&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_prepare_output_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the return part of the docstring using `output_type`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">docstrings</span> <span class="o">=</span> <span class="n">output_type</span><span class="o">.</span><span class="vm">__doc__</span>

    <span class="c1"># Remove the head of the docstring to keep the list of args only</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*(Args|Parameters):\s*$&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">docstrings</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">:])</span>
        <span class="n">docstrings</span> <span class="o">=</span> <span class="n">_convert_output_args_doc</span><span class="p">(</span><span class="n">docstrings</span><span class="p">)</span>

    <span class="c1"># Add the return introduction</span>
    <span class="n">full_output_type</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">output_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">intro</span> <span class="o">=</span> <span class="n">TF_RETURN_INTRODUCTION</span> <span class="k">if</span> <span class="n">output_type</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TF&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">PT_RETURN_INTRODUCTION</span>
    <span class="n">intro</span> <span class="o">=</span> <span class="n">intro</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_output_type</span><span class="o">=</span><span class="n">full_output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="o">=</span><span class="n">config_class</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intro</span> <span class="o">+</span> <span class="n">docstrings</span>


<span class="n">PT_TOKEN_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import torch</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">        &gt;&gt;&gt; labels = torch.tensor([1] * inputs[&quot;input_ids&quot;].size(1)).unsqueeze(0)  # Batch size 1</span>

<span class="s2">        &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_QUESTION_ANSWERING_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import torch</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; question, text = &quot;Who was Jim Henson?&quot;, &quot;Jim Henson was a nice puppet&quot;</span>
<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(question, text, return_tensors=&#39;pt&#39;)</span>
<span class="s2">        &gt;&gt;&gt; start_positions = torch.tensor([1])</span>
<span class="s2">        &gt;&gt;&gt; end_positions = torch.tensor([3])</span>

<span class="s2">        &gt;&gt;&gt; outputs = model(**inputs, start_positions=start_positions, end_positions=end_positions)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; start_scores = outputs.start_logits</span>
<span class="s2">        &gt;&gt;&gt; end_scores = outputs.end_logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_SEQUENCE_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import torch</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">        &gt;&gt;&gt; labels = torch.tensor([1]).unsqueeze(0)  # Batch size 1</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_MASKED_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import torch</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;The capital of France is </span><span class="si">{mask}</span><span class="s2">.&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">        &gt;&gt;&gt; labels = tokenizer(&quot;The capital of France is Paris.&quot;, return_tensors=&quot;pt&quot;)[&quot;input_ids&quot;]</span>

<span class="s2">        &gt;&gt;&gt; outputs = model(**inputs, labels=labels)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_BASE_MODEL_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import torch</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(**inputs)</span>

<span class="s2">        &gt;&gt;&gt; last_hidden_states = outputs.last_hidden_state</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_MULTIPLE_CHOICE_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import torch</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; prompt = &quot;In Italy, pizza served in formal settings, such as at a restaurant, is presented unsliced.&quot;</span>
<span class="s2">        &gt;&gt;&gt; choice0 = &quot;It is eaten with a fork and a knife.&quot;</span>
<span class="s2">        &gt;&gt;&gt; choice1 = &quot;It is eaten while held in the hand.&quot;</span>
<span class="s2">        &gt;&gt;&gt; labels = torch.tensor(0).unsqueeze(0)  # choice0 is correct (according to Wikipedia ;)), batch size 1</span>

<span class="s2">        &gt;&gt;&gt; encoding = tokenizer([[prompt, prompt], [choice0, choice1]], return_tensors=&#39;pt&#39;, padding=True)</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(**{{k: v.unsqueeze(0) for k,v in encoding.items()}}, labels=labels)  # batch size is 1</span>

<span class="s2">        &gt;&gt;&gt; # the linear classifier still needs to be trained</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">PT_CAUSAL_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; import torch</span>
<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;pt&quot;)</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(**inputs, labels=inputs[&quot;input_ids&quot;])</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_TOKEN_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">        &gt;&gt;&gt; input_ids = inputs[&quot;input_ids&quot;]</span>
<span class="s2">        &gt;&gt;&gt; inputs[&quot;labels&quot;] = tf.reshape(tf.constant([1] * tf.size(input_ids).numpy()), (-1, tf.size(input_ids))) # Batch size 1</span>

<span class="s2">        &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_QUESTION_ANSWERING_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; question, text = &quot;Who was Jim Henson?&quot;, &quot;Jim Henson was a nice puppet&quot;</span>
<span class="s2">        &gt;&gt;&gt; input_dict = tokenizer(question, text, return_tensors=&#39;tf&#39;)</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(input_dict)</span>
<span class="s2">        &gt;&gt;&gt; start_logits = outputs.start_logits</span>
<span class="s2">        &gt;&gt;&gt; end_logits = outputs.end_logits</span>

<span class="s2">        &gt;&gt;&gt; all_tokens = tokenizer.convert_ids_to_tokens(input_dict[&quot;input_ids&quot;].numpy()[0])</span>
<span class="s2">        &gt;&gt;&gt; answer = &#39; &#39;.join(all_tokens[tf.math.argmax(start_logits, 1)[0] : tf.math.argmax(end_logits, 1)[0]+1])</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_SEQUENCE_CLASSIFICATION_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">        &gt;&gt;&gt; inputs[&quot;labels&quot;] = tf.reshape(tf.constant(1), (-1, 1)) # Batch size 1</span>

<span class="s2">        &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_MASKED_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;The capital of France is </span><span class="si">{mask}</span><span class="s2">.&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">        &gt;&gt;&gt; inputs[&quot;labels&quot;] = tokenizer(&quot;The capital of France is Paris.&quot;, return_tensors=&quot;tf&quot;)[&quot;input_ids&quot;]</span>

<span class="s2">        &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">        &gt;&gt;&gt; loss = outputs.loss</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_BASE_MODEL_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(inputs)</span>

<span class="s2">        &gt;&gt;&gt; last_hidden_states = outputs.last_hidden_state</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_MULTIPLE_CHOICE_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; prompt = &quot;In Italy, pizza served in formal settings, such as at a restaurant, is presented unsliced.&quot;</span>
<span class="s2">        &gt;&gt;&gt; choice0 = &quot;It is eaten with a fork and a knife.&quot;</span>
<span class="s2">        &gt;&gt;&gt; choice1 = &quot;It is eaten while held in the hand.&quot;</span>

<span class="s2">        &gt;&gt;&gt; encoding = tokenizer([[prompt, prompt], [choice0, choice1]], return_tensors=&#39;tf&#39;, padding=True)</span>
<span class="s2">        &gt;&gt;&gt; inputs = {{k: tf.expand_dims(v, 0) for k, v in encoding.items()}}</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(inputs)  # batch size is 1</span>

<span class="s2">        &gt;&gt;&gt; # the linear classifier still needs to be trained</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">TF_CAUSAL_LM_SAMPLE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Example::</span>

<span class="s2">        &gt;&gt;&gt; from transformers import </span><span class="si">{tokenizer_class}</span><span class="s2">, </span><span class="si">{model_class}</span><span class="s2"></span>
<span class="s2">        &gt;&gt;&gt; import tensorflow as tf</span>

<span class="s2">        &gt;&gt;&gt; tokenizer = </span><span class="si">{tokenizer_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>
<span class="s2">        &gt;&gt;&gt; model = </span><span class="si">{model_class}</span><span class="s2">.from_pretrained(&#39;</span><span class="si">{checkpoint}</span><span class="s2">&#39;)</span>

<span class="s2">        &gt;&gt;&gt; inputs = tokenizer(&quot;Hello, my dog is cute&quot;, return_tensors=&quot;tf&quot;)</span>
<span class="s2">        &gt;&gt;&gt; outputs = model(inputs)</span>
<span class="s2">        &gt;&gt;&gt; logits = outputs.logits</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">add_code_sample_docstrings</span><span class="p">(</span>
    <span class="o">*</span><span class="n">docstr</span><span class="p">,</span> <span class="n">tokenizer_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">model_class</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">is_tf_class</span> <span class="o">=</span> <span class="n">model_class</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;TF&quot;</span>
        <span class="n">doc_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_class</span><span class="o">=</span><span class="n">model_class</span><span class="p">,</span> <span class="n">tokenizer_class</span><span class="o">=</span><span class="n">tokenizer_class</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;SequenceClassification&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_SEQUENCE_CLASSIFICATION_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_SEQUENCE_CLASSIFICATION_SAMPLE</span>
        <span class="k">elif</span> <span class="s2">&quot;QuestionAnswering&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_QUESTION_ANSWERING_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_QUESTION_ANSWERING_SAMPLE</span>
        <span class="k">elif</span> <span class="s2">&quot;TokenClassification&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_TOKEN_CLASSIFICATION_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_TOKEN_CLASSIFICATION_SAMPLE</span>
        <span class="k">elif</span> <span class="s2">&quot;MultipleChoice&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_MULTIPLE_CHOICE_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_MULTIPLE_CHOICE_SAMPLE</span>
        <span class="k">elif</span> <span class="s2">&quot;MaskedLM&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="n">model_class</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FlaubertWithLMHeadModel&quot;</span><span class="p">,</span> <span class="s2">&quot;XLMWithLMHeadModel&quot;</span><span class="p">]:</span>
            <span class="n">doc_kwargs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;[MASK]&quot;</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mask</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_MASKED_LM_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_MASKED_LM_SAMPLE</span>
        <span class="k">elif</span> <span class="s2">&quot;LMHead&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="s2">&quot;CausalLM&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_CAUSAL_LM_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_CAUSAL_LM_SAMPLE</span>
        <span class="k">elif</span> <span class="s2">&quot;Model&quot;</span> <span class="ow">in</span> <span class="n">model_class</span> <span class="ow">or</span> <span class="s2">&quot;Encoder&quot;</span> <span class="ow">in</span> <span class="n">model_class</span><span class="p">:</span>
            <span class="n">code_sample</span> <span class="o">=</span> <span class="n">TF_BASE_MODEL_SAMPLE</span> <span class="k">if</span> <span class="n">is_tf_class</span> <span class="k">else</span> <span class="n">PT_BASE_MODEL_SAMPLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Docstring can&#39;t be built for model </span><span class="si">{</span><span class="n">model_class</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">output_doc</span> <span class="o">=</span> <span class="n">_prepare_output_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="p">)</span> <span class="k">if</span> <span class="n">output_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">built_doc</span> <span class="o">=</span> <span class="n">code_sample</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">doc_kwargs</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docstr</span><span class="p">)</span> <span class="o">+</span> <span class="n">output_doc</span> <span class="o">+</span> <span class="n">built_doc</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span>


<span class="k">def</span> <span class="nf">replace_return_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">docstring_decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">docstrings</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">docstrings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*Returns?:\s*$&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_prepare_output_docstrings</span><span class="p">(</span><span class="n">output_type</span><span class="p">,</span> <span class="n">config_class</span><span class="p">)</span>
            <span class="n">docstrings</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The function </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> should have an empty &#39;Return:&#39; or &#39;Returns:&#39; in its docstring as placeholder, current docstring is:</span><span class="se">\n</span><span class="si">{</span><span class="n">docstrings</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">docstrings</span>
        <span class="k">return</span> <span class="n">fn</span>

    <span class="k">return</span> <span class="n">docstring_decorator</span>


<span class="k">def</span> <span class="nf">is_remote_url</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">):</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hf_bucket_url</span><span class="p">(</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mirror</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve a model identifier, a file name, and an optional revision id, to a huggingface.co-hosted url, redirecting</span>
<span class="sd">    to Cloudfront (a Content Delivery Network, or CDN) for large files.</span>

<span class="sd">    Cloudfront is replicated over the globe so downloads are way faster for the end user (and it also lowers our</span>
<span class="sd">    bandwidth costs).</span>

<span class="sd">    Cloudfront aggressively caches files by default (default TTL is 24 hours), however this is not an issue here</span>
<span class="sd">    because we migrated to a git-based versioning system on huggingface.co, so we now store the files on S3/Cloudfront</span>
<span class="sd">    in a content-addressable way (i.e., the file name is its hash). Using content-addressable filenames means cache</span>
<span class="sd">    can&#39;t ever be stale.</span>

<span class="sd">    In terms of client-side caching from this library, we base our caching on the objects&#39; ETag. An object&#39; ETag is:</span>
<span class="sd">    its sha1 if stored in git, or its sha256 if stored in git-lfs. Files cached locally from transformers before v3.5.0</span>
<span class="sd">    are not shared with those new files, because the cached file&#39;s name contains a hash of the url (which changed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">subfolder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subfolder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">mirror</span><span class="p">:</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">PRESET_MIRROR_DICT</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mirror</span><span class="p">,</span> <span class="n">mirror</span><span class="p">)</span>
        <span class="n">legacy_format</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_id</span>
        <span class="k">if</span> <span class="n">legacy_format</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">revision</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span>
    <span class="k">return</span> <span class="n">HUGGINGFACE_CO_PREFIX</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">url_to_filename</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">etag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert `url` into a hashed filename in a repeatable way. If `etag` is specified, append its hash to the url&#39;s,</span>
<span class="sd">    delimited by a period. If the url ends with .h5 (Keras HDF5 weights) adds &#39;.h5&#39; to the name so that TF 2.0 can</span>
<span class="sd">    identify it as a HDF5 file (see</span>
<span class="sd">    https://github.com/tensorflow/tensorflow/blob/00fad90125b18b80fe054de1055770cfb8fe4ba3/tensorflow/python/keras/engine/network.py#L1380)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url_bytes</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">url_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">etag</span><span class="p">:</span>
        <span class="n">etag_bytes</span> <span class="o">=</span> <span class="n">etag</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">sha256</span><span class="p">(</span><span class="n">etag_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.h5&quot;</span>

    <span class="k">return</span> <span class="n">filename</span>


<span class="k">def</span> <span class="nf">filename_to_url</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the url and etag (which may be ``None``) stored for `filename`. Raise ``EnvironmentError`` if `filename` or</span>
<span class="sd">    its stored metadata do not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cache_path</span><span class="p">))</span>

    <span class="n">meta_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meta_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_path</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">etag</span>


<span class="k">def</span> <span class="nf">get_cached_models</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of tuples representing model binaries that are cached locally. Each tuple has shape</span>
<span class="sd">    :obj:`(model_url, etag, size_MB)`. Filenames in :obj:`cache_dir` are use to get the metadata for each model, only</span>
<span class="sd">    urls ending with `.bin` are added.</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_dir (:obj:`Union[str, Path]`, `optional`):</span>
<span class="sd">            The cache directory to search for models within. Will default to the transformers cache if unset.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[Tuple]: List of tuples each with shape :obj:`(model_url, etag, size_MB)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="n">cached_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="n">meta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                <span class="n">etag</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.bin&quot;</span><span class="p">):</span>
                    <span class="n">size_MB</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">meta_path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mf">1e6</span>
                    <span class="n">cached_models</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">,</span> <span class="n">size_MB</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">cached_models</span>


<span class="k">def</span> <span class="nf">cached_path</span><span class="p">(</span>
    <span class="n">url_or_filename</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resume_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extract_compressed_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">force_extract</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given something that might be a URL (or might be a local path), determine which. If it&#39;s a URL, download the file</span>
<span class="sd">    and cache it, and return the path to the cached file. If it&#39;s already a local path, make sure the file exists and</span>
<span class="sd">    then return the path</span>

<span class="sd">    Args:</span>
<span class="sd">        cache_dir: specify a cache directory to save the file to (overwrite the default cache dir).</span>
<span class="sd">        force_download: if True, re-download the file even if it&#39;s already cached in the cache dir.</span>
<span class="sd">        resume_download: if True, resume the download if incompletely received file is found.</span>
<span class="sd">        user_agent: Optional string or dict that will be appended to the user-agent on remote requests.</span>
<span class="sd">        use_auth_token: Optional string or boolean to use as Bearer token for remote files. If True,</span>
<span class="sd">            will get token from ~/.huggingface.</span>
<span class="sd">        extract_compressed_file: if True and the path point to a zip or tar file, extract the compressed</span>
<span class="sd">            file in a folder along the archive.</span>
<span class="sd">        force_extract: if True when extract_compressed_file is True and the archive was already extracted,</span>
<span class="sd">            re-extract the archive and override the folder where it was extracted.</span>

<span class="sd">    Return:</span>
<span class="sd">        Local path (string) of file or if networking is off, last version of file cached on disk.</span>

<span class="sd">    Raises:</span>
<span class="sd">        In case of non-recoverable file (non-existent or inaccessible url + no cache on disk).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">url_or_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_remote_url</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">):</span>
        <span class="c1"># URL, so get it from the cache (downloading if necessary)</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">get_from_cache</span><span class="p">(</span>
            <span class="n">url_or_filename</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
            <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
            <span class="n">resume_download</span><span class="o">=</span><span class="n">resume_download</span><span class="p">,</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
            <span class="n">use_auth_token</span><span class="o">=</span><span class="n">use_auth_token</span><span class="p">,</span>
            <span class="n">local_files_only</span><span class="o">=</span><span class="n">local_files_only</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">):</span>
        <span class="c1"># File, and it exists.</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">url_or_filename</span>
    <span class="k">elif</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="c1"># File, but it doesn&#39;t exist.</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;file </span><span class="si">{}</span><span class="s2"> not found&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Something unknown</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;unable to parse </span><span class="si">{}</span><span class="s2"> as a URL or as a local path&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_or_filename</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">extract_compressed_file</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_zipfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">output_path</span>

        <span class="c1"># Path where we extract compressed archives</span>
        <span class="c1"># We avoid &#39;.&#39; in dir name and add &quot;-extracted&quot; at the end: &quot;./model.zip&quot; =&gt; &quot;./model-zip-extracted/&quot;</span>
        <span class="n">output_dir</span><span class="p">,</span> <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
        <span class="n">output_extract_dir_name</span> <span class="o">=</span> <span class="n">output_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-extracted&quot;</span>
        <span class="n">output_path_extracted</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">output_extract_dir_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_extract</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_path_extracted</span>

        <span class="c1"># Prevent parallel extractions</span>
        <span class="n">lock_path</span> <span class="o">=</span> <span class="n">output_path</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_zipfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_file</span><span class="p">:</span>
                    <span class="n">zip_file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span>
                    <span class="n">zip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">is_tarfile</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="n">tar_file</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="n">tar_file</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">output_path_extracted</span><span class="p">)</span>
                <span class="n">tar_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Archive format of </span><span class="si">{}</span><span class="s2"> could not be identified&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output_path_extracted</span>

    <span class="k">return</span> <span class="n">output_path</span>


<span class="k">def</span> <span class="nf">http_user_agent</span><span class="p">(</span><span class="n">user_agent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats a user-agent string with basic info about a request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ua</span> <span class="o">=</span> <span class="s2">&quot;transformers/</span><span class="si">{}</span><span class="s2">; python/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; torch/</span><span class="si">{</span><span class="n">_torch_version</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">is_tf_available</span><span class="p">():</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;; tensorflow/</span><span class="si">{</span><span class="n">_tf_version</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_agent</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_agent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ua</span> <span class="o">+=</span> <span class="s2">&quot;; &quot;</span> <span class="o">+</span> <span class="n">user_agent</span>
    <span class="k">return</span> <span class="n">ua</span>


<span class="k">def</span> <span class="nf">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">:</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resume_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Donwload remote file. Do not gobble up errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resume_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Range&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bytes=</span><span class="si">%d</span><span class="s2">-&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resume_size</span><span class="p">,)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">resume_size</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span> <span class="k">if</span> <span class="n">content_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="n">resume_size</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Downloading&quot;</span><span class="p">,</span>
        <span class="n">disable</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">get_verbosity</span><span class="p">()</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>  <span class="c1"># filter out keep-alive new chunks</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
            <span class="n">temp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_from_cache</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">proxies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">etag_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">resume_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">user_agent</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_auth_token</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">local_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a URL, look for the corresponding file in the local cache. If it&#39;s not there, download it. Then return the</span>
<span class="sd">    path to the cached file.</span>

<span class="sd">    Return:</span>
<span class="sd">        Local path (string) of file or if networking is off, last version of file cached on disk.</span>

<span class="sd">    Raises:</span>
<span class="sd">        In case of non-recoverable file (non-existent or inaccessible url + no cache on disk).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">TRANSFORMERS_CACHE</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="n">http_user_agent</span><span class="p">(</span><span class="n">user_agent</span><span class="p">)}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_auth_token</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">use_auth_token</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_auth_token</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">HfFolder</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;You specified use_auth_token=True, but a huggingface token was not found.&quot;</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

    <span class="n">url_to_download</span> <span class="o">=</span> <span class="n">url</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_files_only</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">etag_timeout</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">etag</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Linked-Etag&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ETag&quot;</span><span class="p">)</span>
            <span class="c1"># We favor a custom header indicating the etag of the linked resource, and</span>
            <span class="c1"># we fallback to the regular etag header.</span>
            <span class="c1"># If we don&#39;t have any of those, raise an error.</span>
            <span class="k">if</span> <span class="n">etag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
                    <span class="s2">&quot;Distant resource does not have an ETag, we won&#39;t be able to reliably ensure reproducibility.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># In case of a redirect,</span>
            <span class="c1"># save an extra redirect on the request.get call,</span>
            <span class="c1"># and ensure we download the exact atomic version even if it changed</span>
            <span class="c1"># between the HEAD and the GET (unlikely, but hey).</span>
            <span class="k">if</span> <span class="mi">300</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;=</span> <span class="mi">399</span><span class="p">:</span>
                <span class="n">url_to_download</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="c1"># etag is already None</span>
            <span class="k">pass</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">url_to_filename</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>

    <span class="c1"># get cache path to put the file</span>
    <span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># etag is None == we don&#39;t have a connection or we passed local_files_only.</span>
    <span class="c1"># try to get the last downloaded one</span>
    <span class="k">if</span> <span class="n">etag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cache_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">matching_files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">file</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">),</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.*&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.lock&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">matching_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If files cannot be found and local_files_only=True,</span>
                <span class="c1"># the models might&#39;ve been found if local_files_only=False</span>
                <span class="c1"># Notify the user about that</span>
                <span class="k">if</span> <span class="n">local_files_only</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot find the requested files in the cached path and outgoing traffic has been&quot;</span>
                        <span class="s2">&quot; disabled. To enable model look-ups and downloads online, set &#39;local_files_only&#39;&quot;</span>
                        <span class="s2">&quot; to False.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Connection error, and we cannot find the requested files in the cached path.&quot;</span>
                        <span class="s2">&quot; Please try again or make sure your Internet connection is on.&quot;</span>
                    <span class="p">)</span>

    <span class="c1"># From now on, etag is not None.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache_path</span>

    <span class="c1"># Prevent parallel downloads of the same file with a lock.</span>
    <span class="n">lock_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.lock&quot;</span>
    <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">):</span>

        <span class="c1"># If the download just completed while the lock was activated.</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
            <span class="c1"># Even if returning early like here, the lock will be released.</span>
            <span class="k">return</span> <span class="n">cache_path</span>

        <span class="k">if</span> <span class="n">resume_download</span><span class="p">:</span>
            <span class="n">incomplete_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.incomplete&quot;</span>

            <span class="nd">@contextmanager</span>
            <span class="k">def</span> <span class="nf">_resumable_file_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;io.BufferedWriter&quot;</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">incomplete_path</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">f</span>

            <span class="n">temp_file_manager</span> <span class="o">=</span> <span class="n">_resumable_file_manager</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">incomplete_path</span><span class="p">):</span>
                <span class="n">resume_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">incomplete_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resume_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_file_manager</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">resume_size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Download to temporary file, then copy to cache dir once finished.</span>
        <span class="c1"># Otherwise you get corrupt cache entries if the download gets interrupted.</span>
        <span class="k">with</span> <span class="n">temp_file_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in cache or force_download set to True, downloading to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="n">http_get</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">resume_size</span><span class="o">=</span><span class="n">resume_size</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;storing </span><span class="si">%s</span><span class="s2"> in cache at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating metadata file for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cache_path</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s2">&quot;etag&quot;</span><span class="p">:</span> <span class="n">etag</span><span class="p">}</span>
        <span class="n">meta_path</span> <span class="o">=</span> <span class="n">cache_path</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">meta_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">meta_file</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cache_path</span>


<span class="k">class</span> <span class="nc">cached_property</span><span class="p">(</span><span class="nb">property</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Descriptor that mimics @property but caches output in member variable.</span>

<span class="sd">    From tensorflow_datasets</span>

<span class="sd">    Built-in in functools from Python 3.8.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># See docs.python.org/3/howto/descriptor.html#properties</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;unreadable attribute&quot;</span><span class="p">)</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;__cached_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">cached</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cached</span>


<span class="k">def</span> <span class="nf">torch_required</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c1"># Chose a different decorator name than in tests so it&#39;s clear they are not the same.</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method `</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` requires PyTorch.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">tf_required</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="c1"># Chose a different decorator name than in tests so it&#39;s clear they are not the same.</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_tf_available</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method `</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` requires TF.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">is_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tests if ``x`` is a :obj:`torch.Tensor`, :obj:`tf.Tensor` or :obj:`np.ndarray`. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_torch_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">torch</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">is_tf_available</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>


<div class="viewcode-block" id="ModelOutput"><a class="viewcode-back" href="../../main_classes/output.html#transformers.file_utils.ModelOutput">[docs]</a><span class="k">class</span> <span class="nc">ModelOutput</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all model outputs as dataclass. Has a ``__getitem__`` that allows indexing by integer or slice (like</span>
<span class="sd">    a tuple) or strings (like a dictionary) that will ignore the ``None`` attributes. Otherwise behaves like a regular</span>
<span class="sd">    python dictionary.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        You can&#39;t unpack a :obj:`ModelOutput` directly. Use the :meth:`~transformers.file_utils.ModelOutput.to_tuple`</span>
<span class="sd">        method to convert it to a tuple before.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">class_fields</span> <span class="o">=</span> <span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Safety and consistency checks</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_fields</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no fields.&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">class_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> should not have more than one required field.&quot;</span>

        <span class="n">first_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">other_fields_are_none</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">class_fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">other_fields_are_none</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_tensor</span><span class="p">(</span><span class="n">first_field</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">first_field</span><span class="p">)</span>
                <span class="n">first_field_iterator</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">first_field_iterator</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># if we provided an iterator as first field and the iterator is a (key, value) iterator</span>
            <span class="c1"># set the associated fields</span>
            <span class="k">if</span> <span class="n">first_field_iterator</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">break</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">first_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">class_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">class_fields</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``__delitem__`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ModelOutput.setdefault"><a class="viewcode-back" href="../../main_classes/output.html#transformers.file_utils.ModelOutput.setdefault">[docs]</a>    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``setdefault`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelOutput.pop"><a class="viewcode-back" href="../../main_classes/output.html#transformers.file_utils.ModelOutput.pop">[docs]</a>    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``pop`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelOutput.update"><a class="viewcode-back" href="../../main_classes/output.html#transformers.file_utils.ModelOutput.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You cannot use ``update`` on a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> instance.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">inner_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">inner_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_tuple</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Don&#39;t call self.__setitem__ to avoid recursion errors</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># Will raise a KeyException if needed</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="c1"># Don&#39;t call self.__setattr__ to avoid recursion errors</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="ModelOutput.to_tuple"><a class="viewcode-back" href="../../main_classes/output.html#transformers.file_utils.ModelOutput.to_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert self to a tuple containing all the attributes/keys that are not ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div></div>


<span class="k">class</span> <span class="nc">_BaseLazyModule</span><span class="p">(</span><span class="n">ModuleType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Module class that surfaces all objects but only performs associated imports when the objects are requested.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Very heavily inspired by optuna.integration._IntegrationModule</span>
    <span class="c1"># https://github.com/optuna/optuna/blob/master/optuna/integration/__init__.py</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">import_structure</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">import_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">import_structure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
        <span class="c1"># Needed for autocompletion in an IDE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all__</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">import_structure</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">import_structure</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="p">[])</span>

    <span class="c1"># Needed for autocompletion in an IDE</span>
    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__all__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_class_to_module</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;module </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has no attribute </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_get_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModuleType</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, The Hugging Face Team, Licenced under the Apache License, Version 2.0.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83738774-2', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>