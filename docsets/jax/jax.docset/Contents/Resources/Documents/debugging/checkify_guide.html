
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>The checkify transformation — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="flags.html" rel="next" title="JAX debugging flags"/>
<link href="print_breakpoint.html" rel="prev" title="jax.debug.print and jax.debug.breakpoint"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   Runtime value debugging in JAX
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/debugging/checkify_guide.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#functionalizing-checks">
   Functionalizing checks
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#why-does-jax-need-checkify">
   Why does JAX need checkify?
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#checkify-under-jax-transformations">
<code class="docutils literal notranslate">
<span class="pre">
     checkify
    </span>
</code>
   under JAX transformations.
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#vmap-pmap">
<code class="docutils literal notranslate">
<span class="pre">
       vmap
      </span>
</code>
     /
     <code class="docutils literal notranslate">
<span class="pre">
       pmap
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#pjit">
<code class="docutils literal notranslate">
<span class="pre">
       pjit
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#grad">
<code class="docutils literal notranslate">
<span class="pre">
       grad
      </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#strengths-and-limitations-of-jax-experimental-checkify">
   Strengths and limitations of
   <code class="docutils literal notranslate">
<span class="pre">
     jax.experimental.checkify
    </span>
</code>
</a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#strengths">
     Strengths
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#limitations">
     Limitations
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>The checkify transformation</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#functionalizing-checks">
   Functionalizing checks
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#why-does-jax-need-checkify">
   Why does JAX need checkify?
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#checkify-under-jax-transformations">
<code class="docutils literal notranslate">
<span class="pre">
     checkify
    </span>
</code>
   under JAX transformations.
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#vmap-pmap">
<code class="docutils literal notranslate">
<span class="pre">
       vmap
      </span>
</code>
     /
     <code class="docutils literal notranslate">
<span class="pre">
       pmap
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#pjit">
<code class="docutils literal notranslate">
<span class="pre">
       pjit
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#grad">
<code class="docutils literal notranslate">
<span class="pre">
       grad
      </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#strengths-and-limitations-of-jax-experimental-checkify">
   Strengths and limitations of
   <code class="docutils literal notranslate">
<span class="pre">
     jax.experimental.checkify
    </span>
</code>
</a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#strengths">
     Strengths
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#limitations">
     Limitations
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/The checkify transformation"></a><section class="tex2jax_ignore mathjax_ignore" id="the-checkify-transformation">
<h1>The <code class="docutils literal notranslate"><span class="pre">checkify</span></code> transformation<a class="headerlink" href="#the-checkify-transformation" title="Permalink to this headline">#</a></h1>
<p><strong>TL;DR</strong> Checkify lets you add <code class="docutils literal notranslate"><span class="pre">jit</span></code>-able runtime error checking (e.g. out of bounds indexing) to your JAX code. Use the <code class="docutils literal notranslate"><span class="pre">checkify.checkify</span></code> transformation together with the assert-like <code class="docutils literal notranslate"><span class="pre">checkify.check</span></code> function to add runtime checks to JAX code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">checkify</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
  <span class="n">checkify</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"index needs to be non-negative!"</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">z</span>

<span class="n">jittable_f</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">jittable_f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
<span class="c1"># &gt;&gt; index needs to be non-negative! (check failed at &lt;...&gt;:6 (f))</span>
</pre></div>
</div>
<p>You can also use checkify to automatically add common checks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">user_checks</span> <span class="o">|</span> <span class="n">checkify</span><span class="o">.</span><span class="n">index_checks</span> <span class="o">|</span> <span class="n">checkify</span><span class="o">.</span><span class="n">float_checks</span>
<span class="n">checked_f</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,)),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: out-of-bounds indexing at &lt;..&gt;:7 (f)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: index needs to be non-negative! (check failed at &lt;…&gt;:6 (f))</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: nan generated by primitive sin at &lt;...&gt;:8 (f)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>  <span class="c1"># if no error occurred, throw does nothing!</span>
</pre></div>
</div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Functionalizing checks"></a><section id="functionalizing-checks">
<h2>Functionalizing checks<a class="headerlink" href="#functionalizing-checks" title="Permalink to this headline">#</a></h2>
<p>The assert-like check API by itself is not functionally pure: it can raise a Python Exception as a side-effect, just like assert. So it can’t be staged out with <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">pmap</span></code>, <code class="docutils literal notranslate"><span class="pre">pjit</span></code>, or <code class="docutils literal notranslate"><span class="pre">scan</span></code>:</p>
<!-- TODO this error message might need updating -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># checkify transformation not used</span>
<span class="c1"># ValueError: Cannot abstractly evaluate a checkify.check which was not functionalized.</span>
</pre></div>
</div>
<p>But the checkify transformation functionalizes (or discharges) these effects. A checkify-transformed function returns an error <em>value</em> as a new output and remains functionally pure. That functionalization means checkify-transformed functions can be composed with staging/transforms however we like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span><span class="n">checked_f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">]))</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="sd">"""</span>
<span class="sd">ValueError: </span>
<span class="sd">..  at mapped index 0: index needs to be non-negative! (check failed at :6 (f))</span>
<span class="sd">..  at mapped index 2: out-of-bounds indexing at &lt;..&gt;:7 (f)</span>
<span class="sd">"""</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Why does JAX need checkify?"></a><section id="why-does-jax-need-checkify">
<h2>Why does JAX need checkify?<a class="headerlink" href="#why-does-jax-need-checkify" title="Permalink to this headline">#</a></h2>
<p>Under some JAX transformations you can express runtime error checks with ordinary Python assertions, for example when only using <code class="docutils literal notranslate"><span class="pre">jax.grad</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">assert</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">"must be positive!"</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">0.</span><span class="p">)</span>
<span class="c1"># ValueError: "must be positive!"</span>
</pre></div>
</div>
<p>But ordinary assertions don’t work inside <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">pmap</span></code>, <code class="docutils literal notranslate"><span class="pre">pjit</span></code>, or <code class="docutils literal notranslate"><span class="pre">scan</span></code>. In those cases, numeric computations are staged out rather than evaluated eagerly during Python execution, and as a result numeric values aren’t available:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">0.</span><span class="p">)</span>
<span class="c1"># ConcretizationTypeError: "Abstract tracer value encountered ..."</span>
</pre></div>
</div>
<p>JAX transformation semantics rely on functional purity, especially when composing multiple transformations, so how can we provide an error mechanism without disrupting all that?
Beyond needing a new API, the situation is trickier still:
XLA HLO doesn’t support assertions or throwing errors, so even if we had a JAX API which was able to stage out assertions, how would we lower these assertions to XLA?</p>
<p>You could imagine manually adding run-time checks to your function and plumbing out values representing errors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f_checked</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">0.</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span>

<span class="n">err</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f_checked</span><span class="p">)(</span><span class="mf">0.</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span><span class="p">:</span>
  <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"must be positive!"</span><span class="p">)</span>
<span class="c1"># ValueError: "must be positive!"</span>
</pre></div>
</div>
<p>The error is a regular value computed by the function, and the error is raised outside of <code class="docutils literal notranslate"><span class="pre">f_checked</span></code>. <code class="docutils literal notranslate"><span class="pre">f_checked</span></code> is functionally pure, so we know by construction that it’ll already work with <code class="docutils literal notranslate"><span class="pre">jit</span></code>, pmap, pjit, scan, and all of JAX’s transformations. The only problem is that this plumbing can be a pain!</p>
<p><code class="docutils literal notranslate"><span class="pre">checkify</span></code> does this rewrite for you: that includes plumbing the error value through the function, rewriting checks to boolean operations and merging the result with the tracked error value, and returning the final error value as an output to the checkified function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">checkify</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="s2">"must be positive!"</span><span class="p">)</span>  <span class="c1"># convenient but effectful API</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">f_checked</span> <span class="o">=</span> <span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">f_checked</span><span class="p">)(</span><span class="mf">0.</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: must be positive! (check failed at &lt;...&gt;:2 (f))</span>
</pre></div>
</div>
<p>We call this functionalizing or discharging the effect introduced by calling check. (In the “manual” example above the error value is just a boolean. checkify’s error values are conceptually similar but also track error messages and expose throw and get methods; see <a class="reference internal" href="../jax.experimental.checkify.html#module-jax.experimental.checkify" title="jax.experimental.checkify"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code></a>).</p>
<p>You could now instrument your code with run-time checks, but <code class="docutils literal notranslate"><span class="pre">checkify</span></code> can also automatically add checks for common errors!
Consider these error cases:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span>                <span class="c1"># out of bounds</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>                <span class="c1"># NaN generated</span>
<span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,))</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># division by zero</span>
</pre></div>
</div>
<p>By default <code class="docutils literal notranslate"><span class="pre">checkify</span></code> only discharges <code class="docutils literal notranslate"><span class="pre">checkify.check</span></code>s, and won’t do anything to catch errors like the above. But if you ask it to, <code class="docutils literal notranslate"><span class="pre">checkify</span></code> will also instrument your code with checks automatically.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>        <span class="c1"># i could be out of bounds.</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># z could become NaN</span>
  <span class="k">return</span> <span class="n">z</span>

<span class="n">errors</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">user_checks</span> <span class="o">|</span> <span class="n">checkify</span><span class="o">.</span><span class="n">index_checks</span> <span class="o">|</span> <span class="n">checkify</span><span class="o">.</span><span class="n">float_checks</span>
<span class="n">checked_f</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,)),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: out-of-bounds indexing at &lt;..&gt;:7 (f)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: nan generated by primitive sin at &lt;...&gt;:8 (f)</span>
</pre></div>
</div>
<p>The API for selecting which automatic checks to enable is based on Sets. See <a class="reference internal" href="../jax.experimental.checkify.html#module-jax.experimental.checkify" title="jax.experimental.checkify"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code></a> for more details.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/checkify under JAX transformations."></a><section id="checkify-under-jax-transformations">
<h2><code class="docutils literal notranslate"><span class="pre">checkify</span></code> under JAX transformations.<a class="headerlink" href="#checkify-under-jax-transformations" title="Permalink to this headline">#</a></h2>
<p>As demonstrated in the examples above, a checkified function can be happily
jitted. Here’s a few more examples of <code class="docutils literal notranslate"><span class="pre">checkify</span></code> with other  JAX
transformations. Note that checkified functions are functionally pure, and
should trivially compose with all JAX transformations!</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/vmap/pmap"></a><section id="vmap-pmap">
<h3><code class="docutils literal notranslate"><span class="pre">vmap</span></code>/<code class="docutils literal notranslate"><span class="pre">pmap</span></code><a class="headerlink" href="#vmap-pmap" title="Permalink to this headline">#</a></h3>
<p>Mapping a checkified function will give you a mapped error, which can contain
different errors for every element of the mapped dimension.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
  <span class="n">checkify</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"index needs to be non-negative!"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">checked_f</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">checkify</span><span class="o">.</span><span class="n">all_errors</span><span class="p">)</span>
<span class="n">errs</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">checked_f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">]))</span>
<span class="n">errs</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="sd">"""</span>
<span class="sd">ValueError:</span>
<span class="sd">  at mapped index 0: index needs to be non-negative! (check failed at &lt;...&gt;:2 (f))</span>
<span class="sd">  at mapped index 2: out-of-bounds indexing at &lt;...&gt;:3 (f)</span>
<span class="sd">"""</span>
</pre></div>
</div>
<p>However, a checkify-of-vmap will produce a single (unmapped) error!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">vmap</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
  <span class="n">checkify</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"index needs to be non-negative!"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="n">checked_f</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">checkify</span><span class="o">.</span><span class="n">all_errors</span><span class="p">)</span>
<span class="n">err</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">checked_f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">]))</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: index needs to be non-negative! (check failed at &lt;...&gt;:2 (f))</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/pjit"></a><section id="pjit">
<h3><code class="docutils literal notranslate"><span class="pre">pjit</span></code><a class="headerlink" href="#pjit" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">pjit</span></code> of a checkified function <em>just works</em>, you only need to specify an
additional <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code> of <code class="docutils literal notranslate"><span class="pre">None</span></code> for the error value output.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">checkify</span><span class="o">.</span><span class="n">float_checks</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
  <span class="n">f</span><span class="p">,</span>
  <span class="n">in_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
  <span class="n">out_axis_resources</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
 
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">err</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
<span class="n">err</span><span class="o">.</span><span class="n">throw</span><span class="p">()</span>
<span class="c1"># ValueError: divided by zero at &lt;...&gt;:4 (f)</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/grad"></a><section id="grad">
<h3><code class="docutils literal notranslate"><span class="pre">grad</span></code><a class="headerlink" href="#grad" title="Permalink to this headline">#</a></h3>
<p>Your gradient computation will also be instrumented if you checkify-of-grad:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
 <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">grad_f</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">err</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">checkify</span><span class="o">.</span><span class="n">checkify</span><span class="p">(</span><span class="n">grad_f</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">checkify</span><span class="o">.</span><span class="n">nan_checks</span><span class="p">)(</span><span class="mf">0.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
<span class="o">&gt;&gt;</span> <span class="n">nan</span> <span class="n">generated</span> <span class="n">by</span> <span class="n">primitive</span> <span class="n">mul</span> <span class="n">at</span> <span class="o">&lt;...&gt;</span><span class="p">:</span><span class="mi">3</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that there’s no multiply in <code class="docutils literal notranslate"><span class="pre">f</span></code>, but there is a multiply in its gradient computation (and this is where the NaN is generated!). So use checkify-of-grad to add automatic checks to both forward and backward pass operations.</p>
<p><code class="docutils literal notranslate"><span class="pre">checkify.check</span></code>s will only be applied to the primal value of your function. If
you want to use a <code class="docutils literal notranslate"><span class="pre">check</span></code> on a gradient value, use a <code class="docutils literal notranslate"><span class="pre">custom_vjp</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">custom_vjp</span>
<span class="k">def</span> <span class="nf">assert_gradient_negative</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
 <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">fwd</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
 <span class="k">return</span> <span class="n">assert_gradient_negative</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">bwd</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">grad</span><span class="p">):</span>
 <span class="n">checkify</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">grad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"gradient needs to be negative!"</span><span class="p">)</span>
 <span class="k">return</span> <span class="p">(</span><span class="n">grad</span><span class="p">,)</span>

<span class="n">assert_gradient_negative</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">fwd</span><span class="p">,</span> <span class="n">bwd</span><span class="p">)</span>

<span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">assert_gradient_negative</span><span class="p">)(</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
<span class="c1"># ValueError: gradient needs to be negative!</span>
</pre></div>
</div>
<!-- TODO: scan? -->
<!-- TODO: check\_error -->
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Strengths and limitations of jax.experimental.checkify"></a><section id="strengths-and-limitations-of-jax-experimental-checkify">
<h2>Strengths and limitations of <code class="docutils literal notranslate"><span class="pre">jax.experimental.checkify</span></code><a class="headerlink" href="#strengths-and-limitations-of-jax-experimental-checkify" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Strengths"></a><section id="strengths">
<h3>Strengths<a class="headerlink" href="#strengths" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>You can use it everywhere (errors are “just values” and behave intuitively under transformations like other values)</p></li>
<li><p>Automatic instrumentation: you don’t need to make local modifications to your code. Instead, <code class="docutils literal notranslate"><span class="pre">checkify</span></code> can instrument all of it!</p></li>
</ul>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Limitations"></a><section id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Adding a lot of runtime checks can be expensive (eg. adding a NaN check to
every primitive will add a lot of operations to your computation)</p></li>
<li><p>Requires threading error values out of functions and manually throwing the
error. If the error is not explicitly thrown, you might miss out on errors!</p></li>
<li><p>Throwing an error value will materialize that error value on the host, meaning
it’s a blocking operation which defeats JAX’s async run-ahead.</p></li>
</ul>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="print_breakpoint.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">jax.debug.print</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.debug.breakpoint</span></code></p>
</div>
</a>
<a class="right-next" href="flags.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">JAX debugging flags</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>