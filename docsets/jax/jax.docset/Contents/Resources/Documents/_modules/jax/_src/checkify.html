
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jax._src.checkify &#8212; JAX  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/jax_logo_250px.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../installation.html">
   Installing JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/quickstart.html">
   JAX Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Common_Gotchas_in_JAX.html">
   ðŸ”ª JAX - The Sharp Bits ðŸ”ª
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../jax-101/index.html">
   Tutorial: JAX 101
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
   </li>
  </ul>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../debugging/index.html">
   Runtime value debugging in JAX
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../debugging/print_breakpoint.html">
     <code class="docutils literal notranslate">
      <span class="pre">
       jax.debug.print
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       jax.debug.breakpoint
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
      <span class="pre">
       checkify
      </span>
     </code>
     transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../debugging/flags.html">
     JAX debugging flags
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../async_dispatch.html">
   Asynchronous dispatch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../aot.html">
   Ahead-of-time lowering and compilation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../jaxpr.html">
   Understanding Jaxprs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../pytrees.html">
   Pytrees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../type_promotion.html">
   Type promotion semantics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../errors.html">
   JAX Errors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../transfer_guard.html">
   Transfer guard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../glossary.html">
   JAX Glossary of Terms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../changelog.html">
   Change log
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../api_compatibility.html">
   API compatibility
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../deprecation.html">
   Python and NumPy version support policy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../concurrency.html">
   Concurrency
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../profiling.html">
   Profiling JAX programs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../device_memory_profiling.html">
   Device Memory Profiling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rank_promotion_warning.html">
   Rank promotion warning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../contributing.html">
   Contributing to JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../developer.html">
   Building from source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../jax_internal_api.html">
   Internal APIs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../jax.html">
   Public API: jax package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.numpy.html">
     jax.numpy package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.scipy.html">
     jax.scipy package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.config.html">
     JAX configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.debug.html">
     jax.debug package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.dlpack.html">
     jax.dlpack module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.distributed.html">
     jax.distributed module
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../jax.example_libraries.html">
     jax.example_libraries package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../jax.experimental.html">
     jax.experimental package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.flatten_util.html">
     jax.flatten_util package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.image.html">
     jax.image package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.lax.html">
     jax.lax package
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../jax.nn.html">
     jax.nn package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.ops.html">
     jax.ops package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.profiler.html">
     jax.profiler module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.random.html">
     jax.random package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.stages.html">
     jax.stages package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.tree_util.html">
     jax.tree_util package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.lib.html">
     jax.lib package
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/google/jax"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for jax._src.checkify</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2021 The JAX Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">FrozenSet</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">linear_util</span> <span class="k">as</span> <span class="n">lu</span>
<span class="kn">from</span> <span class="nn">jax.api_util</span> <span class="kn">import</span> <span class="n">flatten_fun</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">pjit</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">maps</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">ad</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">batching</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">mlir</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">partial_eval</span> <span class="k">as</span> <span class="n">pe</span>
<span class="kn">from</span> <span class="nn">jax._src.sharding</span> <span class="kn">import</span> <span class="n">OpShardingSharding</span>
<span class="kn">from</span> <span class="nn">jax.tree_util</span> <span class="kn">import</span> <span class="n">tree_flatten</span><span class="p">,</span> <span class="n">tree_unflatten</span><span class="p">,</span> <span class="n">register_pytree_node</span>
<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">source_info_util</span><span class="p">,</span> <span class="n">traceback_util</span>
<span class="kn">from</span> <span class="nn">jax._src.lax</span> <span class="kn">import</span> <span class="n">control_flow</span> <span class="k">as</span> <span class="n">cf</span>
<span class="kn">from</span> <span class="nn">jax._src.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span> <span class="nn">jax._src.typing</span> <span class="kn">import</span> <span class="n">Array</span>
<span class="kn">from</span> <span class="nn">jax._src.util</span> <span class="kn">import</span> <span class="p">(</span><span class="n">as_hashable_function</span><span class="p">,</span> <span class="n">unzip2</span><span class="p">,</span> <span class="n">split_list</span><span class="p">,</span> <span class="n">safe_map</span><span class="p">,</span>
                           <span class="n">safe_zip</span><span class="p">)</span>

<span class="n">source_info_util</span><span class="o">.</span><span class="n">register_exclusion</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">traceback_util</span><span class="o">.</span><span class="n">register_exclusion</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="nb">map</span><span class="p">,</span> <span class="n">unsafe_map</span> <span class="o">=</span> <span class="n">safe_map</span><span class="p">,</span> <span class="nb">map</span>
<span class="nb">zip</span><span class="p">,</span> <span class="n">unsafe_zip</span> <span class="o">=</span> <span class="n">safe_zip</span><span class="p">,</span> <span class="nb">zip</span>


<span class="c1">## Utils</span>

<span class="k">def</span> <span class="nf">popattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
  <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
  <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">setnewattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
  <span class="n">sentinel</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
  <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="n">sentinel</span>
  <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>


<span class="c1">## Error value data type and functional assert.</span>

<span class="n">Bool</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Array</span><span class="p">]</span>
<span class="n">Int</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Array</span><span class="p">]</span>
<span class="n">Payload</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Array</span><span class="p">]</span>

<span class="c1"># For now, the payload needs to be a fixed-size array: 3 int32s, used for the</span>
<span class="c1"># OOB message.</span>
<span class="c1"># TODO(lenamartens): Relax this fixed-size constraint.</span>
<span class="n">init_payload</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">payloads</span><span class="p">):</span>
  <span class="n">payload_mapping</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">payloads</span><span class="p">):</span>
    <span class="n">payload_mapping</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;payload</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pl</span>
  <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">payload_mapping</span><span class="p">)</span>


<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../../_autosummary/jax.experimental.checkify.Error.html#jax.experimental.checkify.Error">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Error</span><span class="p">:</span>
  <span class="n">err</span><span class="p">:</span> <span class="n">Bool</span>
  <span class="n">code</span><span class="p">:</span> <span class="n">Int</span>
  <span class="n">msgs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
  <span class="c1"># There might be many msgs with a {payload}, but only one msg will</span>
  <span class="c1"># ever be active for an Error instance, so only one Payload is tracked.</span>
  <span class="n">payload</span><span class="p">:</span> <span class="n">Payload</span>

<div class="viewcode-block" id="Error.__init__"><a class="viewcode-back" href="../../../_autosummary/jax.experimental.checkify.Error.html#jax.experimental.checkify.Error.__init__">[docs]</a>  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">msgs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Payload</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># We can&#39;t directly assign to members of a frozen dataclass, even in __init__.</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;msgs&quot;</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span>
    <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;payload&quot;</span><span class="p">,</span>
                       <span class="n">init_payload</span><span class="p">()</span> <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">payload</span><span class="p">)</span></div>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Returns error message is error happened, None if no error happened.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_format_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msgs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
          <span class="sa">f</span><span class="s1">&#39;at mapped index </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span><span class="si">}</span><span class="s1">: &#39;</span>  <span class="c1"># type: ignore</span>
          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_format_msg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msgs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="n">idx</span><span class="p">])],</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span>  <span class="c1"># type: ignore</span>
          <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">throw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">check_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Error(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="si">}</span><span class="s1">)&#39;</span></div>


<span class="k">def</span> <span class="nf">raise_error</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>


<span class="n">register_pytree_node</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span>
                     <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">((</span><span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">),</span>
                                <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">()))),</span>
                     <span class="k">lambda</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Error</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># type: ignore</span>
                                              <span class="nb">dict</span><span class="p">(</span><span class="n">msgs</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>  <span class="c1"># type: ignore</span>

<span class="n">init_error</span> <span class="o">=</span> <span class="n">Error</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">next_code</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="fm">__next__</span>  <span class="c1"># globally unique ids, could be uuid4</span>


<span class="k">def</span> <span class="nf">assert_func</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="n">Error</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Payload</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Error</span><span class="p">:</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">next_code</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">init_payload</span><span class="p">()</span> <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">payload</span>
  <span class="n">out_err</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">err</span> <span class="o">|</span> <span class="n">err</span>
  <span class="n">out_code</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
  <span class="n">out_payload</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">Error</span><span class="p">(</span><span class="n">out_err</span><span class="p">,</span> <span class="n">out_code</span><span class="p">,</span> <span class="p">{</span><span class="n">code</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="p">},</span> <span class="n">out_payload</span><span class="p">)</span>


<span class="c1">## Checkify transformation for plumbing functional error values.</span>

<span class="k">class</span> <span class="nc">CheckifyTracer</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Tracer</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span> <span class="o">=</span> <span class="n">trace</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
  <span class="n">aval</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>
  <span class="n">full_lower</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span>

<span class="k">class</span> <span class="nc">CheckifyTrace</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
  <span class="n">pure</span> <span class="o">=</span> <span class="n">lift</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">MainTrace</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Sublevel</span><span class="p">,</span>
               <span class="n">enabled_errors</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="s1">&#39;ErrorCategory&#39;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">level</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sublevel</span> <span class="o">=</span> <span class="n">sublevel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">enabled_errors</span> <span class="o">=</span> <span class="n">enabled_errors</span>

  <span class="k">def</span> <span class="nf">sublift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracer</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracer</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">process_primitive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">in_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="n">error_checks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">primitive</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rule</span><span class="p">:</span>
      <span class="n">out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">rule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">enabled_errors</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                                  <span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">primitive</span><span class="o">.</span><span class="n">multiple_results</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">process_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">in_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">checkify_subtrace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
    <span class="k">if</span> <span class="s1">&#39;donated_invars&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
      <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">donated_invars</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
                                            <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;donated_invars&#39;</span><span class="p">]))</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out_vals</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span>
                                                   <span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="n">setnewattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">(),</span> <span class="n">payload</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_vals</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">process_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">in_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">checkify_subtrace</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

    <span class="nd">@as_hashable_function</span><span class="p">(</span><span class="n">closure</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;out_axes_thunk&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">new_out_axes_thunk</span><span class="p">():</span>
      <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;out_axes_thunk&#39;</span><span class="p">]())</span>

    <span class="n">params_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;in_axes&#39;</span><span class="p">]),</span>
                   <span class="n">out_axes_thunk</span><span class="o">=</span><span class="n">new_out_axes_thunk</span><span class="p">,</span>
                   <span class="n">donated_invars</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;donated_invars&#39;</span><span class="p">]))</span>
    <span class="n">errs</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">payloads</span><span class="p">,</span> <span class="o">*</span><span class="n">outs</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span>
                                                  <span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">params_</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">_reduce_any_error</span><span class="p">(</span><span class="n">errs</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">payloads</span><span class="p">)</span>
    <span class="n">setnewattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">(),</span> <span class="n">payload</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outs</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">post_process_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">msgs</span>
    <span class="k">def</span> <span class="nf">todo</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
      <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span>
      <span class="n">setnewattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">popattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;msgs&#39;</span><span class="p">),</span> <span class="n">payload</span><span class="p">))</span>
      <span class="n">trace</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">with_cur_sublevel</span><span class="p">()</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span><span class="p">),</span> <span class="n">todo</span>

  <span class="k">def</span> <span class="nf">post_process_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">msgs</span>
    <span class="k">def</span> <span class="nf">todo</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
      <span class="n">errs</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">payloads</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span>
      <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">_reduce_any_error</span><span class="p">(</span><span class="n">errs</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">payloads</span><span class="p">)</span>
      <span class="n">setnewattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">popattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;msgs&#39;</span><span class="p">),</span> <span class="n">payload</span><span class="p">))</span>
      <span class="n">trace</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">with_cur_sublevel</span><span class="p">()</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">out_axes_transform</span><span class="p">(</span><span class="n">out_axes</span><span class="p">):</span>
      <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">out_axes</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span><span class="p">),</span> <span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="n">out_axes_transform</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">process_custom_jvp_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jvp</span><span class="p">,</span> <span class="n">tracers</span><span class="p">):</span>
    <span class="n">in_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">fun</span><span class="p">,</span> <span class="n">msgs1</span> <span class="o">=</span> <span class="n">checkify_subtrace</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span>
    <span class="n">jvp</span><span class="p">,</span> <span class="n">msgs2</span> <span class="o">=</span> <span class="n">checkify_custom_jvp_subtrace</span><span class="p">(</span><span class="n">jvp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out_vals</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">jvp</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                              <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">in_vals</span><span class="p">)</span>
    <span class="n">fst</span><span class="p">,</span> <span class="n">out_msgs</span> <span class="o">=</span> <span class="n">lu</span><span class="o">.</span><span class="n">merge_linear_aux</span><span class="p">(</span><span class="n">msgs1</span><span class="p">,</span> <span class="n">msgs2</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">out_msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_vals</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">post_process_custom_jvp_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_tracers</span><span class="p">,</span> <span class="n">jvp_was_run</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">jvp_was_run</span><span class="p">:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;support for custom_jvp rules which close over checkify values is &quot;</span>
             <span class="s2">&quot;not implemented. If you see this, open an issue at &quot;</span>
             <span class="s2">&quot;https://github.com/google/jax/issues!&quot;</span><span class="p">)</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out_tracers</span><span class="p">]</span>
    <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">msgs</span>
    <span class="k">def</span> <span class="nf">todo</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
      <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span>
      <span class="n">setnewattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">popattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;msgs&#39;</span><span class="p">),</span> <span class="n">payload</span><span class="p">))</span>
      <span class="n">trace</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">with_cur_sublevel</span><span class="p">()</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span><span class="p">),</span> <span class="n">todo</span>

  <span class="k">def</span> <span class="nf">process_custom_vjp_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prim</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">fwd</span><span class="p">,</span> <span class="n">bwd</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">out_trees</span><span class="p">):</span>
    <span class="n">in_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tracers</span><span class="p">]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">popattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">fun</span><span class="p">,</span> <span class="n">msgs1</span> <span class="o">=</span> <span class="n">checkify_subtrace</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span>
    <span class="n">fwd</span><span class="p">,</span> <span class="n">msgs2</span> <span class="o">=</span> <span class="n">checkify_custom_vjp_subtrace</span><span class="p">(</span><span class="n">fwd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">fwd</span><span class="p">,</span> <span class="n">bwd</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="n">out_trees</span><span class="o">=</span><span class="n">out_trees</span><span class="p">)</span>
    <span class="n">fst</span><span class="p">,</span> <span class="n">out_msgs</span> <span class="o">=</span> <span class="n">lu</span><span class="o">.</span><span class="n">merge_linear_aux</span><span class="p">(</span><span class="n">msgs1</span><span class="p">,</span> <span class="n">msgs2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fst</span><span class="p">:</span>
      <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span>  <span class="c1"># forward input error values to output</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">out_msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_reduce_any_error</span><span class="p">(</span><span class="n">errs</span><span class="p">,</span> <span class="n">codes</span><span class="p">,</span> <span class="n">payloads</span><span class="p">):</span>
  <span class="n">reduced_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">errs</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">errs</span><span class="p">[</span><span class="n">reduced_idx</span><span class="p">],</span> <span class="n">codes</span><span class="p">[</span><span class="n">reduced_idx</span><span class="p">],</span> <span class="n">payloads</span><span class="p">[</span><span class="n">reduced_idx</span><span class="p">]</span>

<span class="n">ErrorCheckRule</span> <span class="o">=</span> <span class="n">Callable</span>  <span class="c1"># (Error, FrozenSet[ErrorCategory], *in_vals, **params) -&gt; (Any, Error)</span>
<span class="n">error_checks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">Primitive</span><span class="p">,</span> <span class="n">ErrorCheckRule</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">checkify_flat</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">lu</span><span class="o">.</span><span class="n">WrappedFun</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="s1">&#39;ErrorCategory&#39;</span><span class="p">],</span>
                  <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">fun</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">checkify_subtrace</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
  <span class="n">fun</span> <span class="o">=</span> <span class="n">checkify_traceable</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">init_error</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">enabled_errors</span><span class="p">)</span>
  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">outvals</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">call_wrapped</span><span class="p">(</span><span class="n">init_error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span>
                                                  <span class="n">init_error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                                                  <span class="n">init_error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">outvals</span><span class="p">),</span> <span class="n">msgs</span><span class="p">()</span>

<span class="nd">@lu</span><span class="o">.</span><span class="n">transformation</span>
<span class="k">def</span> <span class="nf">checkify_traceable</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="k">with</span> <span class="n">core</span><span class="o">.</span><span class="n">new_main</span><span class="p">(</span><span class="n">CheckifyTrace</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="o">=</span><span class="n">enabled_errors</span><span class="p">)</span> <span class="k">as</span> <span class="n">main</span><span class="p">:</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">),</span> <span class="p">{}</span>
    <span class="k">del</span> <span class="n">main</span>
  <span class="k">yield</span> <span class="n">outs</span>

<span class="nd">@lu</span><span class="o">.</span><span class="n">transformation_with_aux</span>
<span class="k">def</span> <span class="nf">checkify_subtrace</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">setnewattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msgs</span><span class="p">),</span> <span class="n">payload</span><span class="p">))</span>
  <span class="n">trace</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">with_cur_sublevel</span><span class="p">()</span>
  <span class="n">in_tracers</span> <span class="o">=</span> <span class="p">[</span><span class="n">CheckifyTracer</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
  <span class="n">out</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">in_tracers</span><span class="p">,</span> <span class="p">{}</span>
  <span class="n">out_tracers</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">full_raise</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
  <span class="n">out_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">out_tracers</span><span class="p">]</span>
  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span>
  <span class="k">del</span> <span class="n">main</span><span class="o">.</span><span class="n">error</span>
  <span class="k">yield</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out_vals</span><span class="p">),</span> <span class="n">msgs</span>

<span class="nd">@lu</span><span class="o">.</span><span class="n">transformation_with_aux</span>
<span class="k">def</span> <span class="nf">checkify_custom_jvp_subtrace</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="c1"># Like checkify_subtrace, but used specifically on the custom JVP rules</span>
  <span class="c1"># associated with a custom_jvp. This code is called in the context of a</span>
  <span class="c1"># jvp-of-checkify-of-custom_jvp. It takes both primal and tangent inputs,</span>
  <span class="c1"># flattened into a single args tuple, and similarly must produce flattened</span>
  <span class="c1"># primal and tangent outputs. Both primals and tangents include error values,</span>
  <span class="c1"># but the tangent error values are trivially zero.</span>
  <span class="c1"># The types to have in mind are:</span>
  <span class="c1">#   jvp : (a -&gt; b) -&gt; (a, T a) -&gt; (b, T b)</span>
  <span class="c1">#   checkify : (a -&gt; b) -&gt; a -&gt; Err b</span>
  <span class="c1">#   jvp-of-checkify : (a -&gt; b) -&gt; (a, T a) -&gt; (Err b, T (Err b))</span>
  <span class="c1"># where because Err is a pytree, we necessarily have T (Err b) = Err&#39; (T b)</span>
  <span class="c1"># where the other Err&#39; components are trivial (of float0 dtype).</span>
  <span class="c1"># Semantically, we don&#39;t add checks to the JVP rule. To check the result of a</span>
  <span class="c1"># JVP rule, one must instead use checkify-of-jvp. Thus this implementation</span>
  <span class="c1"># just forwards the input error and code (and trivial tangents) to the output.</span>
  <span class="k">del</span> <span class="n">main</span>
  <span class="n">n</span><span class="p">,</span> <span class="n">ragged</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">assert</span> <span class="ow">not</span> <span class="n">ragged</span>
  <span class="p">(</span><span class="n">err</span><span class="p">,),</span> <span class="p">(</span><span class="n">code</span><span class="p">,),</span> <span class="p">(</span><span class="n">payload</span><span class="p">,),</span> <span class="n">primals</span> <span class="o">=</span> <span class="n">split_list</span><span class="p">(</span><span class="n">args</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
  <span class="p">(</span><span class="n">err_dot</span><span class="p">,),</span> <span class="p">(</span><span class="n">code_dot</span><span class="p">,),</span> <span class="p">(</span><span class="n">pl_dot</span><span class="p">,),</span> <span class="n">tangents</span> <span class="o">=</span> <span class="n">split_list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">n</span><span class="p">:],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
  <span class="n">outs</span> <span class="o">=</span> <span class="k">yield</span> <span class="p">(</span><span class="o">*</span><span class="n">primals</span><span class="p">,</span> <span class="o">*</span><span class="n">tangents</span><span class="p">),</span> <span class="p">{}</span>
  <span class="n">m</span><span class="p">,</span> <span class="n">ragged</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">assert</span> <span class="ow">not</span> <span class="n">ragged</span>
  <span class="n">out_primals</span><span class="p">,</span> <span class="n">out_tangents</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[:</span><span class="n">m</span><span class="p">],</span> <span class="n">outs</span><span class="p">[</span><span class="n">m</span><span class="p">:]</span>
  <span class="k">yield</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out_primals</span><span class="p">,</span>
         <span class="n">err_dot</span><span class="p">,</span> <span class="n">code_dot</span><span class="p">,</span> <span class="n">pl_dot</span><span class="p">,</span> <span class="o">*</span><span class="n">out_tangents</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span>

<span class="nd">@lu</span><span class="o">.</span><span class="n">transformation_with_aux</span>
<span class="k">def</span> <span class="nf">checkify_custom_vjp_subtrace</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="c1"># We don&#39;t add any checks; just drop input error values.</span>
  <span class="k">del</span> <span class="n">main</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span>
  <span class="n">outs</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">args</span><span class="p">,</span> <span class="p">{}</span>
  <span class="k">yield</span> <span class="n">outs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span>

<span class="c1"># TODO take (error_aval, code_aval) instead of error here?</span>
<span class="k">def</span> <span class="nf">checkify_jaxpr</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">):</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">lu</span><span class="o">.</span><span class="n">wrap_init</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">jaxpr_as_fun</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">checkify_fun_to_jaxpr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">jaxpr</span><span class="o">.</span><span class="n">in_avals</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">checkify_fun_to_jaxpr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">in_avals</span><span class="p">):</span>
  <span class="n">f</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">checkify_subtrace</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">checkify_traceable</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">enabled_errors</span><span class="p">)</span>
  <span class="n">err_aval</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">raise_to_shaped</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">))</span>
  <span class="n">code_aval</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">raise_to_shaped</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
  <span class="n">payload_aval</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">raise_to_shaped</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">))</span>
  <span class="n">avals_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">err_aval</span><span class="p">,</span> <span class="n">code_aval</span><span class="p">,</span> <span class="n">payload_aval</span><span class="p">,</span> <span class="o">*</span><span class="n">in_avals</span><span class="p">]</span>
  <span class="n">jaxpr_out</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">literals_out</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">trace_to_jaxpr_dynamic</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">avals_in</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">ClosedJaxpr</span><span class="p">(</span><span class="n">jaxpr_out</span><span class="p">,</span> <span class="n">literals_out</span><span class="p">),</span> <span class="n">msgs</span><span class="p">()</span>


<span class="c1">## assert primitive</span>

<div class="viewcode-block" id="check"><a class="viewcode-back" href="../../../_autosummary/jax.experimental.checkify.check.html#jax.experimental.checkify.check">[docs]</a><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">pred</span><span class="p">:</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Check a predicate, add an error with msg if predicate is False.</span>

<span class="sd">  This is an effectful operation, and can&#39;t be staged (jitted/scanned/...).</span>
<span class="sd">  Before staging a function with checks, ``checkify`` it!</span>

<span class="sd">  Args:</span>
<span class="sd">    pred: if False, an error is added.</span>
<span class="sd">    msg: error message if error is added.</span>

<span class="sd">  For example:</span>

<span class="sd">    &gt;&gt;&gt; import jax</span>
<span class="sd">    &gt;&gt;&gt; import jax.numpy as jnp</span>
<span class="sd">    &gt;&gt;&gt; from jax.experimental import checkify</span>
<span class="sd">    &gt;&gt;&gt; def f(x):</span>
<span class="sd">    ...   checkify.check(x!=0, &quot;cannot be zero!&quot;)</span>
<span class="sd">    ...   return 1/x</span>
<span class="sd">    &gt;&gt;&gt; checked_f = checkify.checkify(f)</span>
<span class="sd">    &gt;&gt;&gt; err, out = jax.jit(checked_f)(0)</span>
<span class="sd">    &gt;&gt;&gt; err.throw()  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">      ...</span>
<span class="sd">    ValueError: cannot be zero! (check failed at ...)</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">is_scalar_pred</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;check takes a scalar pred as argument, got </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">next_code</span><span class="p">()</span>
  <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; (check failed at </span><span class="si">{</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s1">)&#39;</span>
  <span class="k">return</span> <span class="n">check_error</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span> <span class="n">code</span><span class="p">,</span> <span class="p">{</span><span class="n">code</span><span class="p">:</span> <span class="n">msg</span><span class="p">}))</span></div>

<span class="k">def</span> <span class="nf">is_scalar_pred</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">or</span>
          <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pred</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">()</span> <span class="ow">and</span>
          <span class="n">pred</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="check_error"><a class="viewcode-back" href="../../../_autosummary/jax.experimental.checkify.check_error.html#jax.experimental.checkify.check_error">[docs]</a><span class="k">def</span> <span class="nf">check_error</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="n">Error</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Raise an Exception if ``error`` represents a failure. Functionalized by ``checkify``.</span>

<span class="sd">  The semantics of this function are equivalent to:</span>

<span class="sd">  &gt;&gt;&gt; def check_error(err: Error) -&gt; None:</span>
<span class="sd">  ...   err.throw()  # can raise ValueError</span>

<span class="sd">  But unlike that implementation, ``check_error`` can be functionalized using</span>
<span class="sd">  the ``checkify`` transformation.</span>

<span class="sd">  This function is similar to ``check`` but with a different signature: whereas</span>
<span class="sd">  ``check`` takes as arguments a boolean predicate and a new error message</span>
<span class="sd">  string, this function takes an ``Error`` value as argument. Both ``check``</span>
<span class="sd">  and this function raise a Python Exception on failure (a side-effect), and</span>
<span class="sd">  thus cannot be staged out by ``jit``, ``pmap``, ``scan``, etc. Both also can</span>
<span class="sd">  be functionalized by using ``checkify``.</span>

<span class="sd">  But unlike ``check``, this function is like a direct inverse of ``checkify``:</span>
<span class="sd">  whereas ``checkify`` takes as input a function which can raise a Python</span>
<span class="sd">  Exception and produces a new function without that effect but which produces</span>
<span class="sd">  an ``Error`` value as output, this ``check_error`` function can accept an</span>
<span class="sd">  ``Error`` value as input and can produce the side-effect of raising an</span>
<span class="sd">  Exception. That is, while ``checkify`` goes from functionalizable Exception</span>
<span class="sd">  effect to error value, this ``check_error`` goes from error value to</span>
<span class="sd">  functionalizable Exception effect.</span>

<span class="sd">  ``check_error`` is useful when you want to turn checks represented by an</span>
<span class="sd">  ``Error`` value (produced by functionalizing ``checks`` via ``checkify``)</span>
<span class="sd">  back into Python Exceptions.</span>

<span class="sd">  Args:</span>
<span class="sd">    error: Error to check.</span>

<span class="sd">  For example, you might want to functionalize part of your program through</span>
<span class="sd">  checkify, stage out your functionalized code through ``jit``, then re-inject</span>
<span class="sd">  your error value outside of the ``jit``:</span>

<span class="sd">  &gt;&gt;&gt; import jax</span>
<span class="sd">  &gt;&gt;&gt; from jax.experimental import checkify</span>
<span class="sd">  &gt;&gt;&gt; def f(x):</span>
<span class="sd">  ...   checkify.check(x&gt;0, &quot;must be positive!&quot;)</span>
<span class="sd">  ...   return x</span>
<span class="sd">  &gt;&gt;&gt; def with_inner_jit(x):</span>
<span class="sd">  ...   checked_f = checkify.checkify(f)</span>
<span class="sd">  ...   # a checkified function can be jitted</span>
<span class="sd">  ...   error, out = jax.jit(checked_f)(x)</span>
<span class="sd">  ...   checkify.check_error(error)</span>
<span class="sd">  ...   return out</span>
<span class="sd">  &gt;&gt;&gt; _ = with_inner_jit(1)  # no failed check</span>
<span class="sd">  &gt;&gt;&gt; with_inner_jit(-1)  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">  Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">  ValueError: must be positive!</span>
<span class="sd">  &gt;&gt;&gt; # can re-checkify</span>
<span class="sd">  &gt;&gt;&gt; error, _ = checkify.checkify(with_inner_jit)(-1)</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">Error</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;check_error takes an Error as argument, &#39;</span>
                     <span class="sa">f</span><span class="s1">&#39;got type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s1"> instead.&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">):</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">_reduce_any_error</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span>

  <span class="n">err</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">raise_as_much_as_possible</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">assert_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">msgs</span><span class="o">=</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="p">)</span></div>

<span class="n">assert_p</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Primitive</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">)</span> <span class="c1"># TODO: rename to check?</span>
<span class="n">assert_p</span><span class="o">.</span><span class="n">multiple_results</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># zero results</span>

<span class="nd">@assert_p</span><span class="o">.</span><span class="n">def_impl</span>
<span class="k">def</span> <span class="nf">assert_impl</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgs</span><span class="p">):</span>
  <span class="n">raise_error</span><span class="p">(</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">[]</span>

<span class="n">CheckEffect</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="nd">@assert_p</span><span class="o">.</span><span class="n">def_effectful_abstract_eval</span>
<span class="k">def</span> <span class="nf">assert_abstract_eval</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgs</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">[],</span> <span class="p">{</span><span class="n">CheckEffect</span><span class="p">}</span>

<span class="c1"># TODO(lenamartens) add in-depth error explanation to link to in module docs.</span>
<span class="n">functionalization_error</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span>
    <span class="s1">&#39;Cannot abstractly evaluate a checkify.check which was not&#39;</span>
    <span class="s1">&#39; functionalized. This probably means you tried to stage&#39;</span>
    <span class="s1">&#39; (jit/scan/pmap/...) a `check` without functionalizing it&#39;</span>
    <span class="s1">&#39; through `checkify.checkify`.&#39;</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">python_err</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="n">check_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">assert_lowering_rule</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgs</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">jax_experimental_unsafe_xla_runtime_errors</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">functionalization_error</span>

  <span class="n">out_op</span><span class="p">,</span> <span class="n">token_out</span><span class="p">,</span> <span class="n">keep_alive</span> <span class="o">=</span> <span class="n">mlir</span><span class="o">.</span><span class="n">emit_python_callback</span><span class="p">(</span>
      <span class="n">ctx</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">:</span> <span class="n">python_err</span><span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">),</span>
      <span class="n">token</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">tokens_in</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">CheckEffect</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
      <span class="n">operands</span><span class="o">=</span><span class="p">[</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">],</span>
      <span class="n">operand_avals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">avals_in</span><span class="p">),</span>
      <span class="n">result_avals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">avals_out</span><span class="p">),</span>
      <span class="n">has_side_effect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">ctx</span><span class="o">.</span><span class="n">set_tokens_out</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">tokens_in</span><span class="o">.</span><span class="n">update_tokens</span><span class="p">(</span>
      <span class="n">mlir</span><span class="o">.</span><span class="n">TokenSet</span><span class="p">({</span><span class="n">CheckEffect</span><span class="p">:</span> <span class="n">token_out</span><span class="p">})))</span>
  <span class="n">ctx</span><span class="o">.</span><span class="n">module_context</span><span class="o">.</span><span class="n">add_keepalive</span><span class="p">(</span><span class="n">keep_alive</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out_op</span>

<span class="k">def</span> <span class="nf">assert_lowering_rule_unsupported</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
  <span class="k">raise</span> <span class="n">functionalization_error</span>

<span class="n">mlir</span><span class="o">.</span><span class="n">register_lowering</span><span class="p">(</span><span class="n">assert_p</span><span class="p">,</span> <span class="n">assert_lowering_rule_unsupported</span><span class="p">,</span>
                       <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;tpu&#39;</span><span class="p">)</span>
<span class="n">mlir</span><span class="o">.</span><span class="n">register_lowering</span><span class="p">(</span><span class="n">assert_p</span><span class="p">,</span> <span class="n">assert_lowering_rule</span><span class="p">,</span>
                       <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="n">mlir</span><span class="o">.</span><span class="n">register_lowering</span><span class="p">(</span><span class="n">assert_p</span><span class="p">,</span> <span class="n">assert_lowering_rule</span><span class="p">,</span>
                       <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;gpu&#39;</span><span class="p">)</span>
<span class="n">mlir</span><span class="o">.</span><span class="n">lowerable_effects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CheckEffect</span><span class="p">)</span>
<span class="n">cf</span><span class="o">.</span><span class="n">allowed_effects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CheckEffect</span><span class="p">)</span>
<span class="n">core</span><span class="o">.</span><span class="n">ordered_effects</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CheckEffect</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">assert_batching_rule</span><span class="p">(</span><span class="n">batched_args</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgs</span><span class="p">):</span>
  <span class="n">size</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batched_args</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">)</span>
              <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">batching</span><span class="o">.</span><span class="n">not_mapped</span><span class="p">)</span>
  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="n">batching</span><span class="o">.</span><span class="n">bdim_at_front</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batched_args</span><span class="p">,</span> <span class="n">batch_dims</span><span class="p">))</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="n">check_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="n">batching</span><span class="o">.</span><span class="n">primitive_batchers</span><span class="p">[</span><span class="n">assert_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">assert_batching_rule</span>

<span class="k">def</span> <span class="nf">assert_jvp_rule</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgs</span><span class="p">):</span>
  <span class="c1"># Check primals, discard tangents.</span>
  <span class="n">assert_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">primals</span><span class="p">,</span> <span class="n">msgs</span><span class="o">=</span><span class="n">msgs</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="n">ad</span><span class="o">.</span><span class="n">primitive_jvps</span><span class="p">[</span><span class="n">assert_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">assert_jvp_rule</span>

<span class="c1">## checkify rules</span>

<span class="k">def</span> <span class="nf">summary</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
  <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">source_info_util</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">source_info_util</span><span class="o">.</span><span class="n">current</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">nan_error_check</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">in_vals</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">ErrorCategory</span><span class="o">.</span><span class="n">NAN</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabled_errors</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span>
  <span class="n">any_nans</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nan generated by primitive </span><span class="si">{</span><span class="n">prim</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">assert_func</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">any_nans</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gather_error_check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">operand</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                       <span class="n">dimension_numbers</span><span class="p">,</span> <span class="n">slice_sizes</span><span class="p">,</span> <span class="n">unique_indices</span><span class="p">,</span>
                       <span class="n">indices_are_sorted</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="p">):</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">gather_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
      <span class="n">operand</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="o">=</span><span class="n">dimension_numbers</span><span class="p">,</span>
      <span class="n">slice_sizes</span><span class="o">=</span><span class="n">slice_sizes</span><span class="p">,</span> <span class="n">unique_indices</span><span class="o">=</span><span class="n">unique_indices</span><span class="p">,</span>
      <span class="n">indices_are_sorted</span><span class="o">=</span><span class="n">indices_are_sorted</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">ErrorCategory</span><span class="o">.</span><span class="n">OOB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabled_errors</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span>

  <span class="c1"># compare to OOB masking logic in lax._gather_translation_rule</span>
  <span class="n">dnums</span> <span class="o">=</span> <span class="n">dimension_numbers</span>
  <span class="n">operand_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">num_batch_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

  <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">operand_dims</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnums</span><span class="o">.</span><span class="n">start_index_map</span><span class="p">)]</span>
  <span class="n">upper_bound</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slice_sizes</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnums</span><span class="o">.</span><span class="n">start_index_map</span><span class="p">)]</span>
  <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_batch_dims</span><span class="p">)))</span>
  <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_indices</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">start_indices</span> <span class="o">&gt;</span> <span class="n">upper_bound</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">start_indices</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>

  <span class="c1"># Get first OOB index, axis and axis size so it can be added to the error msg.</span>
  <span class="n">flat_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">))</span>
  <span class="n">multi_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">flat_idx</span><span class="p">,</span> <span class="n">start_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="n">oob_axis</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dnums</span><span class="o">.</span><span class="n">start_index_map</span><span class="p">)[</span><span class="n">multi_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
  <span class="n">oob_axis_size</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="n">oob_axis</span><span class="p">]</span>
  <span class="n">oob_index</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">start_indices</span><span class="p">)[</span><span class="n">flat_idx</span><span class="p">]</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">oob_index</span><span class="p">,</span> <span class="n">oob_axis</span><span class="p">,</span> <span class="n">oob_axis_size</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

  <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;out-of-bounds indexing at </span><span class="si">{</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s1"> for array of &#39;</span>
         <span class="sa">f</span><span class="s1">&#39;shape </span><span class="si">{</span><span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">: &#39;</span>
         <span class="s1">&#39;index </span><span class="si">{payload0}</span><span class="s1"> is out of bounds for axis </span><span class="si">{payload1}</span><span class="s1"> &#39;</span>
         <span class="s1">&#39;with size </span><span class="si">{payload2}</span><span class="s1">.&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">assert_func</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">gather_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">gather_error_check</span>

<span class="k">def</span> <span class="nf">div_error_check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Checks for division by zero and NaN.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">ErrorCategory</span><span class="o">.</span><span class="n">DIV</span> <span class="ow">in</span> <span class="n">enabled_errors</span><span class="p">:</span>
    <span class="n">any_zero</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;division by zero at </span><span class="si">{</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">assert_func</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">any_zero</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">nan_error_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">div_p</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">div_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">div_error_check</span>

<span class="k">def</span> <span class="nf">scatter_oob</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">dnums</span><span class="p">):</span>
  <span class="c1"># Ref: see clamping code used in scatter_translation_rule</span>
  <span class="n">slice_sizes</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dnums</span><span class="o">.</span><span class="n">inserted_window_dims</span><span class="p">:</span>
      <span class="n">slice_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">slice_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">updates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">dnums</span><span class="o">.</span><span class="n">update_window_dims</span><span class="p">[</span><span class="n">pos</span><span class="p">]])</span>
      <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

  <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">operand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">slice_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dnums</span><span class="o">.</span><span class="n">scatter_dims_to_operand_dims</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
  <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
  <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim</span><span class="p">(</span><span class="n">upper_bound</span><span class="p">,</span> <span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                     <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,))</span>

  <span class="n">lower_oob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="n">upper_oob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">upper_bound</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">indices</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">lower_oob</span><span class="p">,</span> <span class="n">upper_oob</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scatter_error_check</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">operand</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span>
                        <span class="o">*</span><span class="p">,</span> <span class="n">update_jaxpr</span><span class="p">,</span> <span class="n">update_consts</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="p">,</span>
                        <span class="n">indices_are_sorted</span><span class="p">,</span> <span class="n">unique_indices</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Checks if indices are within bounds and update does not generate NaN.&quot;&quot;&quot;</span>
  <span class="n">out</span> <span class="o">=</span> <span class="n">prim</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
      <span class="n">operand</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">update_jaxpr</span><span class="o">=</span><span class="n">update_jaxpr</span><span class="p">,</span>
      <span class="n">update_consts</span><span class="o">=</span><span class="n">update_consts</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="o">=</span><span class="n">dimension_numbers</span><span class="p">,</span>
      <span class="n">indices_are_sorted</span><span class="o">=</span><span class="n">indices_are_sorted</span><span class="p">,</span> <span class="n">unique_indices</span><span class="o">=</span><span class="n">unique_indices</span><span class="p">,</span>
      <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">ErrorCategory</span><span class="o">.</span><span class="n">OOB</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabled_errors</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span>

  <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">scatter_oob</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">dimension_numbers</span><span class="p">)</span>
  <span class="n">oob_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;out-of-bounds indexing while updating at </span><span class="si">{</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
  <span class="n">oob_error</span> <span class="o">=</span> <span class="n">assert_func</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">out_of_bounds</span><span class="p">,</span> <span class="n">oob_msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

  <span class="n">any_nans</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
  <span class="n">nan_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nan generated by primitive </span><span class="si">{</span><span class="n">prim</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">summary</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">assert_func</span><span class="p">(</span><span class="n">oob_error</span><span class="p">,</span> <span class="n">any_nans</span><span class="p">,</span> <span class="n">nan_msg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">scatter_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">scatter_error_check</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">scatter_p</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">scatter_add_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">scatter_error_check</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">scatter_add_p</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">scatter_mul_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">scatter_error_check</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">scatter_mul_p</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">scatter_min_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">scatter_error_check</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">scatter_min_p</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">scatter_max_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">scatter_error_check</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">scatter_max_p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cond_error_check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="n">branches</span><span class="p">,</span> <span class="n">linear</span><span class="p">):</span>
  <span class="n">new_branches</span><span class="p">,</span> <span class="n">msgs_</span> <span class="o">=</span> <span class="n">unzip2</span><span class="p">(</span><span class="n">checkify_jaxpr</span><span class="p">(</span><span class="n">jxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">jxpr</span> <span class="ow">in</span> <span class="n">branches</span><span class="p">)</span>
  <span class="n">new_linear</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">linear</span><span class="p">)</span>
  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">outs</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">cond_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
      <span class="n">index</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
      <span class="n">branches</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_branches</span><span class="p">),</span> <span class="n">linear</span><span class="o">=</span><span class="n">new_linear</span><span class="p">)</span>
  <span class="n">new_msgs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="p">],</span> <span class="n">msgs_</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
  <span class="k">return</span> <span class="n">outs</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">new_msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">cond_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond_error_check</span>

<span class="k">def</span> <span class="nf">scan_error_check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="o">*</span><span class="n">in_flat</span><span class="p">,</span> <span class="n">reverse</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">jaxpr</span><span class="p">,</span>
                     <span class="n">num_consts</span><span class="p">,</span> <span class="n">num_carry</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">unroll</span><span class="p">):</span>
  <span class="n">consts</span><span class="p">,</span> <span class="n">carry</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">split_list</span><span class="p">(</span><span class="n">in_flat</span><span class="p">,</span> <span class="p">[</span><span class="n">num_consts</span><span class="p">,</span> <span class="n">num_carry</span><span class="p">])</span>
  <span class="n">checked_jaxpr_</span><span class="p">,</span> <span class="n">msgs_</span> <span class="o">=</span> <span class="n">checkify_jaxpr</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">)</span>
  <span class="n">tomove</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
  <span class="n">checked_jaxpr</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">move_binders_to_front</span><span class="p">(</span><span class="n">checked_jaxpr_</span><span class="p">,</span> <span class="n">tomove</span><span class="p">)</span>
  <span class="n">new_linear</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">linear</span><span class="p">)</span>
  <span class="n">new_in_flat</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">consts</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">carry</span><span class="p">,</span> <span class="o">*</span><span class="n">xs</span><span class="p">]</span>
  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">outs</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
      <span class="o">*</span><span class="n">new_in_flat</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">jaxpr</span><span class="o">=</span><span class="n">checked_jaxpr</span><span class="p">,</span>
      <span class="n">num_consts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">consts</span><span class="p">),</span> <span class="n">num_carry</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span>
      <span class="n">linear</span><span class="o">=</span><span class="n">new_linear</span><span class="p">,</span> <span class="n">unroll</span><span class="o">=</span><span class="n">unroll</span><span class="p">)</span>
  <span class="n">new_msgs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="p">,</span> <span class="o">**</span><span class="n">msgs_</span><span class="p">}</span>
  <span class="k">return</span> <span class="n">outs</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">new_msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">scan_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_error_check</span>

<span class="k">def</span> <span class="nf">checkify_while_body_jaxpr</span><span class="p">(</span><span class="n">cond_jaxpr</span><span class="p">,</span> <span class="n">body_jaxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">c_consts</span><span class="p">):</span>
  <span class="n">cond_f</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">jaxpr_as_fun</span><span class="p">(</span><span class="n">cond_jaxpr</span><span class="p">)</span>
  <span class="n">body_f</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">jaxpr_as_fun</span><span class="p">(</span><span class="n">body_jaxpr</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">new_body_f</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">body_f</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>
    <span class="c1"># This checks if the next cond application will error</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">cond_f</span><span class="p">(</span><span class="o">*</span><span class="n">c_consts</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
  <span class="k">return</span> <span class="n">checkify_fun_to_jaxpr</span><span class="p">(</span><span class="n">lu</span><span class="o">.</span><span class="n">wrap_init</span><span class="p">(</span><span class="n">new_body_f</span><span class="p">),</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span>
                               <span class="n">body_jaxpr</span><span class="o">.</span><span class="n">in_avals</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ignore_error_output_jaxpr</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Constructs a checked jaxpr which does not output its error value.&quot;&quot;&quot;</span>
  <span class="n">consts</span> <span class="o">=</span> <span class="n">jaxpr</span><span class="o">.</span><span class="n">consts</span>
  <span class="n">jaxpr</span> <span class="o">=</span> <span class="n">jaxpr</span><span class="o">.</span><span class="n">jaxpr</span>
  <span class="n">new_jaxpr</span> <span class="o">=</span> <span class="n">jaxpr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">outvars</span><span class="o">=</span><span class="n">jaxpr</span><span class="o">.</span><span class="n">outvars</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
  <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">ClosedJaxpr</span><span class="p">(</span><span class="n">new_jaxpr</span><span class="p">,</span> <span class="n">consts</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">batch_error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">):</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">)</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">)</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">batch_shape</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">unbatch_error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
  <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span>

<span class="k">def</span> <span class="nf">trivial_batched_jaxpr</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">,</span> <span class="n">batched_err</span><span class="p">):</span>
  <span class="n">fun</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">jaxpr_as_fun</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">):</span>
    <span class="n">err_args</span> <span class="o">=</span> <span class="n">unbatch_error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">err_args</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">batch_error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>

  <span class="n">error_avals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">raise_to_shaped</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_aval</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">batched_err</span><span class="p">)</span>
  <span class="n">new_jaxpr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">literals_out</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">trace_to_jaxpr_dynamic</span><span class="p">(</span>
      <span class="n">lu</span><span class="o">.</span><span class="n">wrap_init</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="p">[</span><span class="o">*</span><span class="n">error_avals</span><span class="p">,</span> <span class="o">*</span><span class="n">jaxpr</span><span class="o">.</span><span class="n">in_avals</span><span class="p">[</span><span class="mi">3</span><span class="p">:]])</span>
  <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">ClosedJaxpr</span><span class="p">(</span><span class="n">new_jaxpr</span><span class="p">,</span> <span class="n">literals_out</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">while_loop_error_check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="o">*</span><span class="n">in_flat</span><span class="p">,</span> <span class="n">cond_nconsts</span><span class="p">,</span>
                           <span class="n">cond_jaxpr</span><span class="p">,</span> <span class="n">body_nconsts</span><span class="p">,</span> <span class="n">body_jaxpr</span><span class="p">):</span>
  <span class="n">batch_shape</span> <span class="o">=</span> <span class="n">cond_jaxpr</span><span class="o">.</span><span class="n">out_avals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
  <span class="k">if</span> <span class="n">batch_shape</span><span class="p">:</span>
    <span class="n">err_args</span> <span class="o">=</span> <span class="n">batch_error</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">err_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">]</span>

  <span class="n">c_consts</span><span class="p">,</span> <span class="n">b_consts</span><span class="p">,</span> <span class="n">carry</span> <span class="o">=</span> <span class="n">split_list</span><span class="p">(</span><span class="n">in_flat</span><span class="p">,</span> <span class="p">[</span><span class="n">cond_nconsts</span><span class="p">,</span> <span class="n">body_nconsts</span><span class="p">])</span>

  <span class="c1"># Check if the first cond application will error.</span>
  <span class="n">checked_cond_jaxpr</span><span class="p">,</span> <span class="n">msgs_cond</span> <span class="o">=</span> <span class="n">checkify_jaxpr</span><span class="p">(</span><span class="n">cond_jaxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span>
                                                 <span class="n">enabled_errors</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">batch_shape</span><span class="p">:</span>
    <span class="n">checked_cond_jaxpr</span> <span class="o">=</span> <span class="n">trivial_batched_jaxpr</span><span class="p">(</span><span class="n">checked_cond_jaxpr</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">,</span> <span class="n">err_args</span><span class="p">)</span>
  <span class="n">cond_err</span><span class="p">,</span> <span class="n">cond_code</span><span class="p">,</span> <span class="n">cond_payload</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">jaxpr_as_fun</span><span class="p">(</span><span class="n">checked_cond_jaxpr</span><span class="p">)(</span>
      <span class="o">*</span><span class="n">err_args</span><span class="p">,</span> <span class="o">*</span><span class="n">c_consts</span><span class="p">,</span> <span class="o">*</span><span class="n">carry</span><span class="p">)</span>

  <span class="n">checked_body_jaxpr_</span><span class="p">,</span> <span class="n">msgs_body</span> <span class="o">=</span> <span class="n">checkify_while_body_jaxpr</span><span class="p">(</span>
    <span class="n">cond_jaxpr</span><span class="p">,</span> <span class="n">body_jaxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">c_consts</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">batch_shape</span><span class="p">:</span>
    <span class="n">checked_body_jaxpr_</span> <span class="o">=</span> <span class="n">trivial_batched_jaxpr</span><span class="p">(</span><span class="n">checked_body_jaxpr_</span><span class="p">,</span> <span class="n">batch_shape</span><span class="p">,</span> <span class="n">err_args</span><span class="p">)</span>
  <span class="n">to_move</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">body_nconsts</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span>
  <span class="n">checked_body_jaxpr</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">move_binders_to_front</span><span class="p">(</span><span class="n">checked_body_jaxpr_</span><span class="p">,</span> <span class="n">to_move</span><span class="p">)</span>

  <span class="n">compat_cond_jaxpr_</span> <span class="o">=</span> <span class="n">ignore_error_output_jaxpr</span><span class="p">(</span><span class="n">checked_cond_jaxpr</span><span class="p">)</span>
  <span class="n">to_move</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">cond_nconsts</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">carry</span><span class="p">)</span>
  <span class="n">compat_cond_jaxpr</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">move_binders_to_front</span><span class="p">(</span><span class="n">compat_cond_jaxpr_</span><span class="p">,</span> <span class="n">to_move</span><span class="p">)</span>
  <span class="n">new_in_flat</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">c_consts</span><span class="p">,</span> <span class="o">*</span><span class="n">b_consts</span><span class="p">,</span> <span class="n">cond_err</span><span class="p">,</span> <span class="n">cond_code</span><span class="p">,</span> <span class="n">cond_payload</span><span class="p">,</span> <span class="o">*</span><span class="n">carry</span><span class="p">]</span>

  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">while_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
      <span class="o">*</span><span class="n">new_in_flat</span><span class="p">,</span> <span class="n">cond_nconsts</span><span class="o">=</span><span class="n">cond_nconsts</span><span class="p">,</span> <span class="n">cond_jaxpr</span><span class="o">=</span><span class="n">compat_cond_jaxpr</span><span class="p">,</span>
      <span class="n">body_nconsts</span><span class="o">=</span><span class="n">body_nconsts</span><span class="p">,</span> <span class="n">body_jaxpr</span><span class="o">=</span><span class="n">checked_body_jaxpr</span><span class="p">)</span>
  <span class="n">new_msgs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="p">,</span> <span class="o">**</span><span class="n">msgs_body</span><span class="p">,</span> <span class="o">**</span><span class="n">msgs_cond</span><span class="p">}</span>
  <span class="k">if</span> <span class="n">batch_shape</span><span class="p">:</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">unbatch_error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">new_msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">lax</span><span class="o">.</span><span class="n">while_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">while_loop_error_check</span>


<span class="k">def</span> <span class="nf">pjit_error_check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="o">*</span><span class="n">vals_in</span><span class="p">,</span> <span class="n">jaxpr</span><span class="p">,</span>
                     <span class="n">in_shardings</span><span class="p">,</span> <span class="n">out_shardings</span><span class="p">,</span> <span class="n">resource_env</span><span class="p">,</span>
                     <span class="n">donated_invars</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                     <span class="n">in_positional_semantics</span><span class="p">,</span> <span class="n">out_positional_semantics</span><span class="p">):</span>
  <span class="n">checked_jaxpr</span><span class="p">,</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">checkify_jaxpr</span><span class="p">(</span><span class="n">jaxpr</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">)</span>
  <span class="n">new_vals_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals_in</span><span class="p">]</span>

  <span class="n">sharding</span> <span class="o">=</span> <span class="n">OpShardingSharding</span><span class="o">.</span><span class="n">get_replicated</span><span class="p">(</span>
      <span class="nb">list</span><span class="p">(</span><span class="n">resource_env</span><span class="o">.</span><span class="n">physical_mesh</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">flat</span><span class="p">))</span>
  <span class="n">new_in_shardings</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">sharding</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">in_shardings</span><span class="p">)</span>
  <span class="n">new_out_shardings</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">sharding</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">out_shardings</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">jax_array</span><span class="p">:</span>
    <span class="n">pos_sem</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">_PositionalSemantics</span><span class="o">.</span><span class="n">GLOBAL</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">pos_sem</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">_positional_semantics</span><span class="o">.</span><span class="n">val</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_positional_semantics</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
    <span class="n">in_positional_semantics</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_positional_semantics</span><span class="p">,)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_positional_semantics</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
    <span class="n">out_positional_semantics</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_positional_semantics</span><span class="p">,)</span>
  <span class="n">new_positional_sems_in</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pos_sem</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">in_positional_semantics</span><span class="p">)</span>
  <span class="n">new_positional_sems_out</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pos_sem</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">out_positional_semantics</span><span class="p">)</span>
  <span class="n">new_donated_invars</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">donated_invars</span><span class="p">)</span>

  <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">vals_out</span> <span class="o">=</span> <span class="n">pjit</span><span class="o">.</span><span class="n">pjit_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
      <span class="o">*</span><span class="n">new_vals_in</span><span class="p">,</span>
      <span class="n">jaxpr</span><span class="o">=</span><span class="n">checked_jaxpr</span><span class="p">,</span>
      <span class="n">in_shardings</span><span class="o">=</span><span class="n">new_in_shardings</span><span class="p">,</span>
      <span class="n">out_shardings</span><span class="o">=</span><span class="n">new_out_shardings</span><span class="p">,</span>
      <span class="n">resource_env</span><span class="o">=</span><span class="n">resource_env</span><span class="p">,</span>
      <span class="n">donated_invars</span><span class="o">=</span><span class="n">new_donated_invars</span><span class="p">,</span>
      <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
      <span class="n">in_positional_semantics</span><span class="o">=</span><span class="n">new_positional_sems_in</span><span class="p">,</span>
      <span class="n">out_positional_semantics</span><span class="o">=</span><span class="n">new_positional_sems_out</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">vals_out</span><span class="p">,</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">pjit</span><span class="o">.</span><span class="n">pjit_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pjit_error_check</span>


<span class="k">def</span> <span class="nf">add_nan_check</span><span class="p">(</span><span class="n">prim</span><span class="p">):</span>
  <span class="n">error_checks</span><span class="p">[</span><span class="n">prim</span><span class="p">]</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">nan_error_check</span><span class="p">,</span> <span class="n">prim</span><span class="p">)</span>

<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">floor_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">ceil_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">round_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sign_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">shift_left_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">shift_right_arithmetic_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">shift_right_logical_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">bitcast_convert_type_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">real_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">complex_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">conj_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">imag_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">add_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">broadcast_in_dim_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">concatenate_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">pad_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reshape_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">rev_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">transpose_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">slice_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reduce_sum_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reduce_window_sum_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">fft_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">cumsum_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">cumprod_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">cummax_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">cummin_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">erf_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">expm1_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log1p_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sqrt_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">rsqrt_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">asinh_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">acosh_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">atanh_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">erfc_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">rem_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">clamp_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">erf_inv_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">exp_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">pow_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">integer_pow_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">tanh_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">atan2_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sin_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">cos_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sinh_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">cosh_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">dot_general_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">conv_general_dilated_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reduce_max_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">reduce_min_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">select_n_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">max_p</span><span class="p">)</span>
<span class="n">add_nan_check</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">min_p</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">assert_discharge_rule</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">enabled_errors</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msgs</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">ErrorCategory</span><span class="o">.</span><span class="n">USER_CHECK</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enabled_errors</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">[],</span> <span class="n">error</span>

  <span class="n">out_err</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">err</span> <span class="o">|</span> <span class="n">err</span>
  <span class="n">out_code</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">err</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">[],</span> <span class="n">Error</span><span class="p">(</span><span class="n">out_err</span><span class="p">,</span> <span class="n">out_code</span><span class="p">,</span> <span class="p">{</span><span class="o">**</span><span class="n">error</span><span class="o">.</span><span class="n">msgs</span><span class="p">,</span> <span class="o">**</span><span class="n">msgs</span><span class="p">},</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">error_checks</span><span class="p">[</span><span class="n">assert_p</span><span class="p">]</span> <span class="o">=</span> <span class="n">assert_discharge_rule</span>


<span class="c1">## checkify api</span>

<span class="n">ErrorCategory</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;ErrorCategory&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;NAN&#39;</span><span class="p">,</span> <span class="s1">&#39;OOB&#39;</span><span class="p">,</span> <span class="s1">&#39;DIV&#39;</span><span class="p">,</span> <span class="s1">&#39;USER_CHECK&#39;</span><span class="p">])</span>

<span class="n">user_checks</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="n">ErrorCategory</span><span class="o">.</span><span class="n">USER_CHECK</span><span class="p">})</span>
<span class="n">nan_checks</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="n">ErrorCategory</span><span class="o">.</span><span class="n">NAN</span><span class="p">})</span>
<span class="n">index_checks</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="n">ErrorCategory</span><span class="o">.</span><span class="n">OOB</span><span class="p">})</span>
<span class="n">div_checks</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="n">ErrorCategory</span><span class="o">.</span><span class="n">DIV</span><span class="p">})</span>
<span class="n">float_checks</span> <span class="o">=</span> <span class="n">nan_checks</span> <span class="o">|</span> <span class="n">div_checks</span>
<span class="n">automatic_checks</span> <span class="o">=</span> <span class="n">float_checks</span> <span class="o">|</span> <span class="n">index_checks</span>
<span class="n">all_checks</span> <span class="o">=</span> <span class="n">automatic_checks</span> <span class="o">|</span> <span class="n">user_checks</span>

<span class="n">Out</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Out&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="checkify"><a class="viewcode-back" href="../../../_autosummary/jax.experimental.checkify.checkify.html#jax.experimental.checkify.checkify">[docs]</a><span class="k">def</span> <span class="nf">checkify</span><span class="p">(</span><span class="n">fun</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Out</span><span class="p">],</span>
             <span class="n">errors</span><span class="p">:</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">ErrorCategory</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_checks</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Error</span><span class="p">,</span> <span class="n">Out</span><span class="p">]]:</span>
  <span class="sd">&quot;&quot;&quot;Functionalize `check` calls in `fun`, and optionally add run-time error checks.</span>

<span class="sd">  Run-time errors are either user-added ``checkify.check`` assertions, or</span>
<span class="sd">  automatically added checks like NaN checks, depending on the ``errors``</span>
<span class="sd">  argument.</span>

<span class="sd">  The returned function will return an Error object `err` along with the output</span>
<span class="sd">  of the original function. ``err.get()`` will either return ``None`` (if no</span>
<span class="sd">  error occurred) or a string containing an error message. This error message</span>
<span class="sd">  will correspond to the first error which occurred. ``err.throw()`` will raise</span>
<span class="sd">  a ValueError with the error message if an error occurred.</span>

<span class="sd">  By default only user-added ``checkify.check`` assertions are enabled. You can</span>
<span class="sd">  enable automatic checks through the ``errors`` argument.</span>

<span class="sd">  The automatic check sets which can be enabled, and when an error is generated:</span>
<span class="sd">    - ``user_checks``: a ``checkify.check`` evaluated to False.</span>
<span class="sd">    - ``nan_checks``: a floating-point operation generated a NaN value</span>
<span class="sd">      as output.</span>
<span class="sd">    - ``div_checks``: a division by zero.</span>
<span class="sd">    - ``index_checks``: an index was out-of-bounds.</span>

<span class="sd">  Multiple categories can be enabled together by creating a `Set` (eg.</span>
<span class="sd">  ``errors={ErrorCategory.NAN, ErrorCategory.OOB}``). Multiple sets can be</span>
<span class="sd">  re-combined (eg. ``errors=float_checks|user_checks``)</span>

<span class="sd">  Args:</span>
<span class="sd">    fun: Callable which can contain user checks (see ``check``).</span>
<span class="sd">    errors: A set of ErrorCategory values which defines the set of enabled</span>
<span class="sd">      checks. By default only explicit ``checks`` are enabled</span>
<span class="sd">      (``user_checks``). You can also for example enable NAN and</span>
<span class="sd">      DIV errors by passing the ``float_checks`` set, or for</span>
<span class="sd">      example combine multiple sets through set operations</span>
<span class="sd">      (``float_checks | user_checks``)</span>
<span class="sd">  Returns:</span>
<span class="sd">    A function which accepts the same arguments as ``fun`` and returns as output</span>
<span class="sd">    a pair where the first element is an ``Error`` value, representing the first</span>
<span class="sd">    failed ``check``, and the second element is the original output of ``fun``.</span>

<span class="sd">  For example:</span>

<span class="sd">    &gt;&gt;&gt; import jax</span>
<span class="sd">    &gt;&gt;&gt; import jax.numpy as jnp</span>
<span class="sd">    &gt;&gt;&gt; from jax.experimental import checkify</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; @jax.jit</span>
<span class="sd">    ... def f(x):</span>
<span class="sd">    ...   y = jnp.sin(x)</span>
<span class="sd">    ...   return x+y</span>
<span class="sd">    &gt;&gt;&gt; err, out = checkify.checkify(f, errors=checkify.float_checks)(jnp.inf)</span>
<span class="sd">    &gt;&gt;&gt; err.throw()  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">      ...</span>
<span class="sd">    ValueError: nan generated by primitive sin</span>

<span class="sd">  &quot;&quot;&quot;</span>
  <span class="nd">@traceback_util</span><span class="o">.</span><span class="n">api_boundary</span>
  <span class="k">def</span> <span class="nf">checked_fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">args_flat</span><span class="p">,</span> <span class="n">in_tree</span> <span class="o">=</span> <span class="n">tree_flatten</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">out_tree</span> <span class="o">=</span> <span class="n">flatten_fun</span><span class="p">(</span><span class="n">lu</span><span class="o">.</span><span class="n">wrap_init</span><span class="p">(</span><span class="n">fun</span><span class="p">),</span> <span class="n">in_tree</span><span class="p">)</span>
    <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">out_flat</span><span class="p">),</span> <span class="n">msgs</span> <span class="o">=</span> <span class="n">checkify_flat</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="o">*</span><span class="n">args_flat</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">tree_unflatten</span><span class="p">(</span><span class="n">out_tree</span><span class="p">(),</span> <span class="n">out_flat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">payload</span><span class="p">),</span> <span class="n">out</span>
  <span class="k">return</span> <span class="n">checked_fun</span></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      &copy; Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>