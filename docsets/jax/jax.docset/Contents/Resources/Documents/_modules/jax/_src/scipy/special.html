
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jax._src.scipy.special &#8212; JAX  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../../../_static/style.css" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../../_static/jax_logo_250px.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../installation.html">
   Installing JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/quickstart.html">
   JAX Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/Common_Gotchas_in_JAX.html">
   ðŸ”ª JAX - The Sharp Bits ðŸ”ª
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../jax-101/index.html">
   Tutorial: JAX 101
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
   </li>
  </ul>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../debugging/index.html">
   Runtime value debugging in JAX
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../debugging/print_breakpoint.html">
     <code class="docutils literal notranslate">
      <span class="pre">
       jax.debug.print
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       jax.debug.breakpoint
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
      <span class="pre">
       checkify
      </span>
     </code>
     transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../debugging/flags.html">
     JAX debugging flags
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../async_dispatch.html">
   Asynchronous dispatch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../aot.html">
   Ahead-of-time lowering and compilation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../jaxpr.html">
   Understanding Jaxprs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../pytrees.html">
   Pytrees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../type_promotion.html">
   Type promotion semantics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../errors.html">
   JAX Errors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../transfer_guard.html">
   Transfer guard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../glossary.html">
   JAX Glossary of Terms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../changelog.html">
   Change log
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../api_compatibility.html">
   API compatibility
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../deprecation.html">
   Python and NumPy version support policy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../concurrency.html">
   Concurrency
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../profiling.html">
   Profiling JAX programs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../device_memory_profiling.html">
   Device Memory Profiling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../rank_promotion_warning.html">
   Rank promotion warning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../contributing.html">
   Contributing to JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../developer.html">
   Building from source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../jax_internal_api.html">
   Internal APIs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../../jax.html">
   Public API: jax package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.numpy.html">
     jax.numpy package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.scipy.html">
     jax.scipy package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.config.html">
     JAX configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.debug.html">
     jax.debug package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.dlpack.html">
     jax.dlpack module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.distributed.html">
     jax.distributed module
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../../jax.example_libraries.html">
     jax.example_libraries package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../../jax.experimental.html">
     jax.experimental package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.flatten_util.html">
     jax.flatten_util package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.image.html">
     jax.image package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.lax.html">
     jax.lax package
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../../jax.nn.html">
     jax.nn package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.ops.html">
     jax.ops package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.profiler.html">
     jax.profiler module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.random.html">
     jax.random package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.stages.html">
     jax.stages package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.tree_util.html">
     jax.tree_util package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../../jax.lib.html">
     jax.lib package
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/google/jax"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for jax._src.scipy.special</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The JAX Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">osp_special</span>

<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span><span class="p">,</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">ad</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax._src.lax.lax</span> <span class="kn">import</span> <span class="n">_const</span> <span class="k">as</span> <span class="n">_lax_const</span>
<span class="kn">from</span> <span class="nn">jax._src.numpy.lax_numpy</span> <span class="kn">import</span> <span class="n">_reduction_dims</span><span class="p">,</span> <span class="n">_promote_args_inexact</span>
<span class="kn">from</span> <span class="nn">jax._src.numpy.util</span> <span class="kn">import</span> <span class="n">_wraps</span>


<div class="viewcode-block" id="gammaln"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.gammaln.html#jax.nn.gammaln">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">gammaln</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gammaln</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;gammaln&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">betaln</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">betaln</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;betaln&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">lgamma</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>


<div class="viewcode-block" id="betainc"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.betainc.html#jax.nn.betainc">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">betainc</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">betainc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;betainc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">betainc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="digamma"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.digamma.html#jax.nn.digamma">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">digamma</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">lax_description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The JAX version only accepts real-valued inputs.&quot;&quot;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">digamma</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;digamma&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">digamma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>
<span class="n">ad</span><span class="o">.</span><span class="n">defjvp</span><span class="p">(</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">digamma_p</span><span class="p">,</span>
    <span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">polygamma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>  <span class="c1"># type: ignore[has-type]</span>


<div class="viewcode-block" id="gammainc"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.gammainc.html#jax.nn.gammainc">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">gammainc</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gammainc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;gammainc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">igamma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="gammaincc"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.gammaincc.html#jax.nn.gammaincc">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">gammaincc</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gammaincc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;gammaincc&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">igammac</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="erf"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.erf.html#jax.nn.erf">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">erf</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;erf&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="erfc"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.erfc.html#jax.nn.erfc">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">erfc</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erfc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;erfc&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="erfinv"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.erfinv.html#jax.nn.erfinv">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">erfinv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;erfinv&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf_inv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="logit"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.logit.html#jax.nn.logit">[docs]</a><span class="nd">@api</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">logit</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;logit&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_lax_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">)))</span></div>
<span class="n">logit</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_lax_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">))))</span>


<div class="viewcode-block" id="expit"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.expit.html#jax.nn.expit">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">expit</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">expit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;expit&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">logistic</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="logsumexp"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.logsumexp.html#jax.nn.logsumexp">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">logsumexp</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logsumexp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_sign</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;logsumexp&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">a</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;logsumexp&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">pos_dims</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">_reduction_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
  <span class="n">amax</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span>
  <span class="n">amax</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">amax</span><span class="p">),</span> <span class="n">amax</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">amax</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
  <span class="n">amax_with_dims</span> <span class="o">=</span> <span class="n">amax</span> <span class="k">if</span> <span class="n">keepdims</span> <span class="k">else</span> <span class="n">lax</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">amax</span><span class="p">,</span> <span class="n">pos_dims</span><span class="p">)</span>
  <span class="c1"># fast path if the result cannot be negative.</span>
  <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">amax_with_dims</span><span class="p">)),</span>
                                  <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)),</span>
                  <span class="n">amax</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">out</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">isneginf</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">expsub</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">amax_with_dims</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">expsub</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">expsub</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">sumexp</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">expsub</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="n">keepdims</span><span class="p">)</span>

    <span class="n">sign</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sumexp</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">sumexp</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">return_sign</span><span class="p">:</span>
        <span class="n">sumexp</span> <span class="o">=</span> <span class="n">sign</span><span class="o">*</span><span class="n">sumexp</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sumexp</span><span class="p">),</span> <span class="n">amax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumexp</span><span class="p">)),</span> <span class="n">amax</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">return_sign</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">sign</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">complexfloating</span><span class="p">):</span>
      <span class="k">with</span> <span class="n">jax</span><span class="o">.</span><span class="n">debug_nans</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sign</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">out</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="xlogy"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.xlogy.html#jax.nn.xlogy">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">xlogy</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">xlogy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;xlogy&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">x_ok</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.</span>
  <span class="n">safe_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="n">safe_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">safe_x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">safe_y</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="xlog1py"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.xlog1py.html#jax.nn.xlog1py">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">xlog1py</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">xlog1py</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;xlog1py&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">x_ok</span> <span class="o">=</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.</span>
  <span class="n">safe_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="n">safe_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_ok</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">safe_x</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">safe_y</span><span class="p">)),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="entr"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.entr.html#jax.nn.entr">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">entr</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">entr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;entr&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                    <span class="n">lax</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">xlogy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span></div>


<div class="viewcode-block" id="multigammaln"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.multigammaln.html#jax.nn.multigammaln">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">multigammaln</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">multigammaln</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
  <span class="n">d</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">concrete_or_error</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="s2">&quot;d argument of multigammaln&quot;</span><span class="p">)</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">d_</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;multigammaln&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

  <span class="n">constant</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">_lax_const</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">),</span> <span class="n">d_</span><span class="p">),</span>
                             <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">d_</span><span class="p">,</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span>
                     <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_lax_const</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">d_</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gammaln</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                        <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ndim</span><span class="p">)))),</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">res</span> <span class="o">+</span> <span class="n">constant</span></div>


<span class="c1"># coefs of (2k)! / B_{2k} where B are bernoulli numbers</span>
<span class="c1"># those numbers are obtained using https://www.wolframalpha.com</span>
<span class="n">_BERNOULLI_COEFS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">12</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">720</span><span class="p">,</span>
    <span class="mi">30240</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1209600</span><span class="p">,</span>
    <span class="mi">47900160</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1307674368000</span> <span class="o">/</span> <span class="mi">691</span><span class="p">,</span>
    <span class="mi">74724249600</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">10670622842880000</span> <span class="o">/</span> <span class="mi">3617</span><span class="p">,</span>
    <span class="mi">5109094217170944000</span> <span class="o">/</span> <span class="mi">43867</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">802857662698291200000</span> <span class="o">/</span> <span class="mi">174611</span><span class="p">,</span>
    <span class="mi">14101100039391805440000</span> <span class="o">/</span> <span class="mi">77683</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1693824136731743669452800000</span> <span class="o">/</span> <span class="mi">236364091</span><span class="p">,</span>
    <span class="mi">186134520519971831808000000</span> <span class="o">/</span> <span class="mi">657931</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">37893265687455865519472640000000</span> <span class="o">/</span> <span class="mi">3392780147</span><span class="p">,</span>
    <span class="mi">759790291646040068357842010112000000</span> <span class="o">/</span> <span class="mi">1723168255201</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">134196726836183700385281186201600000000</span> <span class="o">/</span> <span class="mi">7709321041217</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="zeta"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.zeta.html#jax.nn.zeta">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">zeta</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">zeta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="k">assert</span> <span class="n">q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Riemann zeta function is not implemented yet.&quot;</span>
  <span class="c1"># Reference: Johansson, Fredrik.</span>
  <span class="c1"># &quot;Rigorous high-precision computation of the Hurwitz zeta function and its derivatives.&quot;</span>
  <span class="c1"># Numerical Algorithms 69.2 (2015): 253-270.</span>
  <span class="c1"># https://arxiv.org/abs/1309.2877 - formula (5)</span>
  <span class="c1"># here we keep the same notation as in reference</span>
  <span class="n">s</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;zeta&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">s_</span><span class="p">,</span> <span class="n">a_</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="c1"># precision ~ N, M</span>
  <span class="n">N</span> <span class="o">=</span> <span class="n">M</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span> <span class="k">else</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">M</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_BERNOULLI_COEFS</span><span class="p">)</span>
  <span class="n">k</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ndim</span><span class="p">)))</span>
  <span class="n">S</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a_</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="n">s_</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">I</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="p">),</span> <span class="n">s</span> <span class="o">-</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
  <span class="n">T0</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="n">s</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">M</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">ndim</span><span class="p">)))</span>
  <span class="n">s_over_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">a_</span> <span class="o">+</span> <span class="n">N</span><span class="p">)</span>
  <span class="n">T1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">s_over_a</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">T1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">)</span>
  <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_BERNOULLI_COEFS</span><span class="p">[:</span><span class="n">T1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                         <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ndim</span><span class="p">)))</span>
  <span class="n">T1</span> <span class="o">=</span> <span class="n">T1</span> <span class="o">/</span> <span class="n">coefs</span>
  <span class="n">T</span> <span class="o">=</span> <span class="n">T0</span> <span class="o">*</span> <span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">S</span> <span class="o">+</span> <span class="n">I</span> <span class="o">+</span> <span class="n">T</span></div>


<div class="viewcode-block" id="polygamma"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.polygamma.html#jax.nn.polygamma">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">polygamma</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">,</span> <span class="n">update_doc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">polygamma</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">assert</span> <span class="n">jnp</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">integer</span><span class="p">)</span>
  <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;polygamma&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">broadcast_shapes</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_polygamma</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">shape</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span></div>


<span class="nd">@api</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="k">def</span> <span class="nf">_polygamma</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">n_plus</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">sign</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_plus</span> <span class="o">%</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">digamma</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">gammaln</span><span class="p">(</span><span class="n">n_plus</span><span class="p">))</span> <span class="o">*</span> <span class="n">zeta</span><span class="p">(</span><span class="n">n_plus</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="n">_polygamma</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">g</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">_polygamma</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>


<span class="c1"># Normal distributions</span>

<span class="c1"># Functions &quot;ndtr&quot; and &quot;ndtri&quot; are derived from calculations made in:</span>
<span class="c1"># https://root.cern.ch/doc/v608/SpecFuncCephesInv_8cxx_source.html</span>
<span class="c1"># In the following email exchange, the author gives his consent to redistribute</span>
<span class="c1"># derived works under an Apache 2.0 license.</span>
<span class="c1">#</span>
<span class="c1"># From: Stephen Moshier &lt;steve@moshier.net&gt;</span>
<span class="c1"># Date: Sat, Jun 9, 2018 at 2:36 PM</span>
<span class="c1"># Subject: Re: Licensing cephes under Apache (BSD-like) license.</span>
<span class="c1"># To: rif &lt;rif@google.com&gt;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Hello Rif,</span>
<span class="c1">#</span>
<span class="c1"># Yes, Google may distribute Cephes files under the Apache 2 license.</span>
<span class="c1">#</span>
<span class="c1"># If clarification is needed, I do not favor BSD over other free licenses.</span>
<span class="c1"># I would agree that Apache 2 seems to cover the concern you mentioned</span>
<span class="c1"># about sublicensees.</span>
<span class="c1">#</span>
<span class="c1"># Best wishes for good luck with your projects!</span>
<span class="c1"># Steve Moshier</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># On Thu, 31 May 2018, rif wrote:</span>
<span class="c1">#</span>
<span class="c1"># &gt; Hello Steve.</span>
<span class="c1"># &gt; My name is Rif. I work on machine learning software at Google.</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; Your cephes software continues to be incredibly useful and widely used. I</span>
<span class="c1"># &gt; was wondering whether it would be permissible for us to use the Cephes code</span>
<span class="c1"># &gt; under the Apache 2.0 license, which is extremely similar in permissions to</span>
<span class="c1"># &gt; the BSD license (Wikipedia comparisons). This would be quite helpful to us</span>
<span class="c1"># &gt; in terms of avoiding multiple licenses on software.</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; I&#39;m sorry to bother you with this (I can imagine you&#39;re sick of hearing</span>
<span class="c1"># &gt; about this by now), but I want to be absolutely clear we&#39;re on the level and</span>
<span class="c1"># &gt; not misusing your important software. In former conversation with Eugene</span>
<span class="c1"># &gt; Brevdo (ebrevdo@google.com), you wrote &quot;If your licensing is similar to BSD,</span>
<span class="c1"># &gt; the formal way that has been handled is simply to add a statement to the</span>
<span class="c1"># &gt; effect that you are incorporating the Cephes software by permission of the</span>
<span class="c1"># &gt; author.&quot; I wanted to confirm that (a) we could use the Apache license, (b)</span>
<span class="c1"># &gt; that we don&#39;t need to (and probably you don&#39;t want to) keep getting</span>
<span class="c1"># &gt; contacted about individual uses, because your intent is generally to allow</span>
<span class="c1"># &gt; this software to be reused under &quot;BSD-like&quot; license, and (c) you&#39;re OK</span>
<span class="c1"># &gt; letting incorporators decide whether a license is sufficiently BSD-like?</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; Best,</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt; rif</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt;</span>
<span class="c1"># &gt;</span>

<span class="c1"># log_ndtr uses different functions over the ranges</span>
<span class="c1"># (-infty, lower](lower, upper](upper, infty)</span>
<span class="c1"># Lower bound values were chosen by examining where the support of ndtr</span>
<span class="c1"># appears to be zero, relative to scipy&#39;s (which is always 64bit). They were</span>
<span class="c1"># then made more conservative just to be safe. (Conservative means use the</span>
<span class="c1"># expansion more than we probably need to.)</span>
<span class="n">_LOGNDTR_FLOAT64_LOWER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">_LOGNDTR_FLOAT32_LOWER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># Upper bound values were chosen by examining for which values of &#39;x&#39;</span>
<span class="c1"># Log[cdf(x)] is 0, after which point we need to use the approximation</span>
<span class="c1"># Log[cdf(x)] = Log[1 - cdf(-x)] approx -cdf(-x). We chose a value slightly</span>
<span class="c1"># conservative, meaning we use the approximation earlier than needed.</span>
<span class="n">_LOGNDTR_FLOAT64_UPPER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">_LOGNDTR_FLOAT32_UPPER</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<div class="viewcode-block" id="ndtr"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.ndtr.html#jax.nn.ndtr">[docs]</a><span class="k">def</span> <span class="nf">ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Normal distribution function.</span>

<span class="sd">  Returns the area under the Gaussian probability density function, integrated</span>
<span class="sd">  from minus infinity to x:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \begin{align}</span>
<span class="sd">    \mathrm{ndtr}(x) =&amp;</span>
<span class="sd">      \ \frac{1}{\sqrt{2 \pi}}\int_{-\infty}^{x} e^{-\frac{1}{2}t^2} dt \\</span>
<span class="sd">    =&amp;\ \frac{1}{2} (1 + \mathrm{erf}(\frac{x}{\sqrt{2}})) \\</span>
<span class="sd">    =&amp;\ \frac{1}{2} \mathrm{erfc}(\frac{x}{\sqrt{2}})</span>
<span class="sd">    \end{align}</span>

<span class="sd">  Args:</span>
<span class="sd">    x: An array of type `float32`, `float64`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    An array with `dtype=x.dtype`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError: if `x` is not floating-type.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;x.dtype=</span><span class="si">{}</span><span class="s2"> is not supported, see docstring for supported types.&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implements ndtr core logic.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">half_sqrt_2</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">half_sqrt_2</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">half_sqrt_2</span><span class="p">),</span>
                      <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">w</span><span class="p">),</span>
                      <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.</span><span class="p">)),</span>
                                      <span class="n">dtype</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                                      <span class="n">lax</span><span class="o">.</span><span class="n">erfc</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>


<div class="viewcode-block" id="ndtri"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.ndtri.html#jax.nn.ndtri">[docs]</a><span class="k">def</span> <span class="nf">ndtri</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;The inverse of the CDF of the Normal distribution function.</span>

<span class="sd">  Returns `x` such that the area under the PDF from :math:`-\infty` to `x` is equal</span>
<span class="sd">  to `p`.</span>

<span class="sd">  A piece-wise rational approximation is done for the function.</span>
<span class="sd">  This is a based on the implementation in netlib.</span>

<span class="sd">  Args:</span>
<span class="sd">    p: an array of type `float32`, `float64`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    an array with `dtype=p.dtype`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError: if `p` is not floating-type.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;x.dtype=</span><span class="si">{}</span><span class="s2"> is not supported, see docstring for supported types.&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">_ndtri</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_ndtri</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Implements ndtri core logic.&quot;&quot;&quot;</span>

  <span class="c1"># Constants used in piece-wise rational approximations. Taken from the cephes</span>
  <span class="c1"># library:</span>
  <span class="c1"># https://root.cern.ch/doc/v608/SpecFuncCephesInv_8cxx_source.html</span>
  <span class="n">p0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="o">-</span><span class="mf">5.99633501014107895267E1</span><span class="p">,</span>
                      <span class="mf">9.80010754185999661536E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">5.66762857469070293439E1</span><span class="p">,</span>
                      <span class="mf">1.39312609387279679503E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.23916583867381258016E0</span><span class="p">]))</span>
  <span class="n">q0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="mf">1.95448858338141759834E0</span><span class="p">,</span>
                      <span class="mf">4.67627912898881538453E0</span><span class="p">,</span>
                      <span class="mf">8.63602421390890590575E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">2.25462687854119370527E2</span><span class="p">,</span>
                      <span class="mf">2.00260212380060660359E2</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">8.20372256168333339912E1</span><span class="p">,</span>
                      <span class="mf">1.59056225126211695515E1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.18331621121330003142E0</span><span class="p">]))</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">4.05544892305962419923E0</span><span class="p">,</span>
                      <span class="mf">3.15251094599893866154E1</span><span class="p">,</span>
                      <span class="mf">5.71628192246421288162E1</span><span class="p">,</span>
                      <span class="mf">4.40805073893200834700E1</span><span class="p">,</span>
                      <span class="mf">1.46849561928858024014E1</span><span class="p">,</span>
                      <span class="mf">2.18663306850790267539E0</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.40256079171354495875E-1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">3.50424626827848203418E-2</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">8.57456785154685413611E-4</span><span class="p">]))</span>
  <span class="n">q1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="mf">1.57799883256466749731E1</span><span class="p">,</span>
                      <span class="mf">4.53907635128879210584E1</span><span class="p">,</span>
                      <span class="mf">4.13172038254672030440E1</span><span class="p">,</span>
                      <span class="mf">1.50425385692907503408E1</span><span class="p">,</span>
                      <span class="mf">2.50464946208309415979E0</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">1.42182922854787788574E-1</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">3.80806407691578277194E-2</span><span class="p">,</span>
                      <span class="o">-</span><span class="mf">9.33259480895457427372E-4</span><span class="p">]))</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">3.23774891776946035970E0</span><span class="p">,</span>
                      <span class="mf">6.91522889068984211695E0</span><span class="p">,</span>
                      <span class="mf">3.93881025292474443415E0</span><span class="p">,</span>
                      <span class="mf">1.33303460815807542389E0</span><span class="p">,</span>
                      <span class="mf">2.01485389549179081538E-1</span><span class="p">,</span>
                      <span class="mf">1.23716634817820021358E-2</span><span class="p">,</span>
                      <span class="mf">3.01581553508235416007E-4</span><span class="p">,</span>
                      <span class="mf">2.65806974686737550832E-6</span><span class="p">,</span>
                      <span class="mf">6.23974539184983293730E-9</span><span class="p">]))</span>
  <span class="n">q2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span>
                      <span class="mf">6.02427039364742014255E0</span><span class="p">,</span>
                      <span class="mf">3.67983563856160859403E0</span><span class="p">,</span>
                      <span class="mf">1.37702099489081330271E0</span><span class="p">,</span>
                      <span class="mf">2.16236993594496635890E-1</span><span class="p">,</span>
                      <span class="mf">1.34204006088543189037E-2</span><span class="p">,</span>
                      <span class="mf">3.28014464682127739104E-4</span><span class="p">,</span>
                      <span class="mf">2.89247864745380683936E-6</span><span class="p">,</span>
                      <span class="mf">6.79019408009981274425E-9</span><span class="p">]))</span>

  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_create_polynomial</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute n_th order polynomial via Horner&#39;s method.&quot;&quot;&quot;</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">coeffs</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">var</span>


  <span class="n">maybe_complement_p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">dtype</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">expm1</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)),</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="c1"># Write in an arbitrary value in place of 0 for p since 0 will cause NaNs</span>
  <span class="c1"># later on. The result from the computation when p == 0 is not used so any</span>
  <span class="c1"># number that doesn&#39;t result in NaNs is fine.</span>
  <span class="n">sanitized_mcp</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
      <span class="n">maybe_complement_p</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span>
      <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)),</span>
      <span class="n">maybe_complement_p</span><span class="p">)</span>

  <span class="c1"># Compute x for p &gt; exp(-2): x/sqrt(2pi) = w + w**3 P0(w**2)/Q0(w**2).</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">sanitized_mcp</span> <span class="o">-</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
  <span class="n">ww</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
  <span class="n">x_for_big_p</span> <span class="o">=</span> <span class="n">w</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">ww</span> <span class="o">*</span> <span class="p">(</span><span class="n">_create_polynomial</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">p0</span><span class="p">)</span>
                              <span class="o">/</span> <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">q0</span><span class="p">))</span>
  <span class="n">x_for_big_p</span> <span class="o">*=</span> <span class="o">-</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

  <span class="c1"># Compute x for p &lt;= exp(-2): x = z - log(z)/z - (1/z) P(1/z) / Q(1/z),</span>
  <span class="c1"># where z = sqrt(-2. * log(p)), and P/Q are chosen between two different</span>
  <span class="c1"># arrays based on whether p &lt; exp(-32).</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sanitized_mcp</span><span class="p">))</span>
  <span class="n">first_term</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span>
  <span class="n">second_term_small_p</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">)</span>
  <span class="n">second_term_otherwise</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span> <span class="o">/</span>
      <span class="n">_create_polynomial</span><span class="p">(</span><span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">,</span> <span class="n">q1</span><span class="p">)</span> <span class="o">/</span> <span class="n">z</span><span class="p">)</span>
  <span class="n">x_for_small_p</span> <span class="o">=</span> <span class="n">first_term</span> <span class="o">-</span> <span class="n">second_term_small_p</span>
  <span class="n">x_otherwise</span> <span class="o">=</span> <span class="n">first_term</span> <span class="o">-</span> <span class="n">second_term_otherwise</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sanitized_mcp</span> <span class="o">&gt;</span> <span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)),</span>
                <span class="n">x_for_big_p</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">8.0</span><span class="p">),</span> <span class="n">x_for_small_p</span><span class="p">,</span> <span class="n">x_otherwise</span><span class="p">))</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">)),</span> <span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
  <span class="n">infinity</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
  <span class="n">x_nan_replaced</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
      <span class="n">p</span> <span class="o">&lt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="o">-</span><span class="n">infinity</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">infinity</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">x_nan_replaced</span>


<div class="viewcode-block" id="log_ndtr"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.log_ndtr.html#jax.nn.log_ndtr">[docs]</a><span class="nd">@partial</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">custom_jvp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">log_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Log Normal distribution function.</span>

<span class="sd">  For details of the Normal distribution function see `ndtr`.</span>

<span class="sd">  This function calculates :math:`\log(\mathrm{ndtr}(x))` by either calling</span>
<span class="sd">  :math:`\log(\mathrm{ndtr}(x))` or using an asymptotic series. Specifically:</span>

<span class="sd">  - For `x &gt; upper_segment`, use the approximation `-ndtr(-x)` based on</span>
<span class="sd">    :math:`\log(1-x) \approx -x, x \ll 1`.</span>
<span class="sd">  - For `lower_segment &lt; x &lt;= upper_segment`, use the existing `ndtr` technique</span>
<span class="sd">    and take a log.</span>
<span class="sd">  - For `x &lt;= lower_segment`, we use the series approximation of `erf` to compute</span>
<span class="sd">    the log CDF directly.</span>

<span class="sd">  The `lower_segment` is set based on the precision of the input:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \begin{align}</span>
<span class="sd">    \mathit{lower\_segment} =&amp;</span>
<span class="sd">      \ \begin{cases}</span>
<span class="sd">        -20 &amp;  x.\mathrm{dtype}=\mathit{float64} \\</span>
<span class="sd">        -10 &amp;  x.\mathrm{dtype}=\mathit{float32} \\</span>
<span class="sd">        \end{cases} \\</span>
<span class="sd">    \mathit{upper\_segment} =&amp;</span>
<span class="sd">      \ \begin{cases}</span>
<span class="sd">        8&amp;  x.\mathrm{dtype}=\mathit{float64} \\</span>
<span class="sd">        5&amp;  x.\mathrm{dtype}=\mathit{float32} \\</span>
<span class="sd">        \end{cases}</span>
<span class="sd">    \end{align}</span>


<span class="sd">  When `x &lt; lower_segment`, the `ndtr` asymptotic series approximation is:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \begin{align}</span>
<span class="sd">     \mathrm{ndtr}(x) =&amp;\  \mathit{scale} * (1 + \mathit{sum}) + R_N \\</span>
<span class="sd">     \mathit{scale}   =&amp;\  \frac{e^{-0.5 x^2}}{-x \sqrt{2 \pi}} \\</span>
<span class="sd">     \mathit{sum}     =&amp;\  \sum_{n=1}^N {-1}^n (2n-1)!! / (x^2)^n \\</span>
<span class="sd">     R_N     =&amp;\  O(e^{-0.5 x^2} (2N+1)!! / |x|^{2N+3})</span>
<span class="sd">    \end{align}</span>

<span class="sd">  where :math:`(2n-1)!! = (2n-1) (2n-3) (2n-5) ...  (3) (1)` is a</span>
<span class="sd">  `double-factorial</span>
<span class="sd">  &lt;https://en.wikipedia.org/wiki/Double_factorial&gt;`_ operator.</span>


<span class="sd">  Args:</span>
<span class="sd">    x: an array of type `float32`, `float64`.</span>
<span class="sd">    series_order: Positive Python integer. Maximum depth to</span>
<span class="sd">      evaluate the asymptotic expansion. This is the `N` above.</span>

<span class="sd">  Returns:</span>
<span class="sd">    an array with `dtype=x.dtype`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError: if `x.dtype` is not handled.</span>
<span class="sd">    TypeError: if `series_order` is a not Python `integer.`</span>
<span class="sd">    ValueError:  if `series_order` is not in `[0, 30]`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series_order</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;series_order must be a Python integer.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">series_order</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;series_order must be non-negative.&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">series_order</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;series_order must be &lt;= 30.&quot;</span><span class="p">)</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
    <span class="n">lower_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT64_LOWER</span>
    <span class="n">upper_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT64_UPPER</span>
  <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
    <span class="n">lower_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT32_LOWER</span>
    <span class="n">upper_segment</span> <span class="o">=</span> <span class="n">_LOGNDTR_FLOAT32_UPPER</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x.dtype=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span><span class="p">)</span>

  <span class="c1"># The basic idea here was ported from:</span>
  <span class="c1">#   https://root.cern.ch/doc/v608/SpecFuncCephesInv_8cxx_source.html</span>
  <span class="c1"># We copy the main idea, with a few changes</span>
  <span class="c1"># * For x &gt;&gt; 1, and X ~ Normal(0, 1),</span>
  <span class="c1">#     Log[P[X &lt; x]] = Log[1 - P[X &lt; -x]] approx -P[X &lt; -x],</span>
  <span class="c1">#     which extends the range of validity of this function.</span>
  <span class="c1"># * We use one fixed series_order for all of &#39;x&#39;, rather than adaptive.</span>
  <span class="c1"># * Our docstring properly reflects that this is an asymptotic series, not a</span>
  <span class="c1">#   Taylor series. We also provided a correct bound on the remainder.</span>
  <span class="c1"># * We need to use the max/min in the _log_ndtr_lower arg to avoid nan when</span>
  <span class="c1">#   x=0. This happens even though the branch is unchosen because when x=0</span>
  <span class="c1">#   the gradient of a select involves the calculation 1*dy+0*(-inf)=nan</span>
  <span class="c1">#   regardless of whether dy is finite. Note that the minimum is a NOP if</span>
  <span class="c1">#   the branch is chosen.</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
      <span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">upper_segment</span><span class="p">),</span>
      <span class="o">-</span><span class="n">_ndtr</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">),</span>  <span class="c1"># log(1-x) ~= -x, x &lt;&lt; 1</span>
      <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_segment</span><span class="p">),</span>
                       <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_ndtr</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_segment</span><span class="p">))),</span>
                       <span class="n">_log_ndtr_lower</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">lower_segment</span><span class="p">),</span>
                                       <span class="n">series_order</span><span class="p">)))</span></div>
<span class="k">def</span> <span class="nf">_log_ndtr_jvp</span><span class="p">(</span><span class="n">series_order</span><span class="p">,</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">(</span><span class="n">t</span><span class="p">,)</span> <span class="o">=</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">log_ndtr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="o">=</span><span class="n">series_order</span><span class="p">)</span>
  <span class="n">t_out</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_norm_logpdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">ans</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="n">t_out</span>
<span class="n">log_ndtr</span><span class="o">.</span><span class="n">defjvp</span><span class="p">(</span><span class="n">_log_ndtr_jvp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_log_ndtr_lower</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Asymptotic expansion version of `Log[cdf(x)]`, appropriate for `x&lt;&lt;-1`.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="n">x_2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="c1"># Log of the term multiplying (1 + sum)</span>
  <span class="n">log_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_2</span> <span class="o">-</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">log_scale</span> <span class="o">+</span> <span class="n">lax</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_log_ndtr_asymptotic_series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_log_ndtr_asymptotic_series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">series_order</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Calculates the asymptotic series used in log_ndtr.&quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
  <span class="k">if</span> <span class="n">series_order</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
  <span class="n">x_2</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">even_sum</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">odd_sum</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">x_2n</span> <span class="o">=</span> <span class="n">x_2</span>  <span class="c1"># Start with x^{2*1} = x^{2*n} with n = 1.</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">series_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_double_factorial</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="p">)</span> <span class="o">/</span> <span class="n">x_2n</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">odd_sum</span> <span class="o">+=</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">even_sum</span> <span class="o">+=</span> <span class="n">y</span>
    <span class="n">x_2n</span> <span class="o">*=</span> <span class="n">x_2</span>
  <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="n">even_sum</span> <span class="o">-</span> <span class="n">odd_sum</span>


<span class="k">def</span> <span class="nf">_double_factorial</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The double factorial function for small Python integer `n`.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span>


<span class="n">_norm_logpdf_constant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_norm_logpdf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">neg_half</span> <span class="o">=</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
  <span class="n">log_normalizer</span> <span class="o">=</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_norm_logpdf_constant</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">neg_half</span><span class="p">,</span> <span class="n">lax</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">log_normalizer</span><span class="p">)</span>

<div class="viewcode-block" id="i0e"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.i0e.html#jax.nn.i0e">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">i0e</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i0e</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;i0e&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bessel_i0e</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="i0"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.i0.html#jax.nn.i0">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">i0</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i0</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;i0&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">lax</span><span class="o">.</span><span class="n">bessel_i0e</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>

<div class="viewcode-block" id="i1e"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.i1e.html#jax.nn.i1e">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">i1e</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i1e</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;i1e&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">bessel_i1e</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="i1"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.i1.html#jax.nn.i1">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">i1</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;i1&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">lax</span><span class="o">.</span><span class="n">bessel_i1e</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_gen_recurrence_mask</span><span class="p">(</span>
    <span class="n">l_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_normalized</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
  <span class="sd">&quot;&quot;&quot;Generates mask for recurrence relation on the remaining entries.</span>

<span class="sd">  The remaining entries are with respect to the diagonal and offdiagonal</span>
<span class="sd">  entries.</span>

<span class="sd">  Args:</span>
<span class="sd">    l_max: see `gen_normalized_legendre`.</span>
<span class="sd">    is_normalized: True if the recurrence mask is used by normalized associated</span>
<span class="sd">      Legendre functions.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Arrays representing the mask used by the recurrence relations.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># Computes all coefficients.</span>
  <span class="n">m_mat</span><span class="p">,</span> <span class="n">l_mat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">is_normalized</span><span class="p">:</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">l_mat</span> <span class="o">*</span> <span class="n">l_mat</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">m_mat</span> <span class="o">*</span> <span class="n">m_mat</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">l_mat</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_mat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_mat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">d0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">c0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c0</span> <span class="o">-</span> <span class="n">c1</span><span class="p">))</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">c2</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c3</span> <span class="o">-</span> <span class="n">c1</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">c2</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">c0</span> <span class="o">-</span> <span class="n">c1</span><span class="p">)))</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">d0</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">l_mat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">l_mat</span> <span class="o">-</span> <span class="n">m_mat</span><span class="p">)</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_mat</span> <span class="o">+</span> <span class="n">m_mat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">l_mat</span> <span class="o">-</span> <span class="n">m_mat</span><span class="p">)</span>

  <span class="n">d0_mask_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">d1_mask_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">d_zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">d0_mask</span> <span class="o">=</span> <span class="n">d_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">d0_mask_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">d0_mask_indices</span><span class="p">])</span>
  <span class="n">d1_mask</span> <span class="o">=</span> <span class="n">d_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">d1_mask_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">d1_mask_indices</span><span class="p">])</span>

  <span class="c1"># Creates a 3D mask that contains 1s on the diagonal plane and 0s elsewhere.</span>
  <span class="c1"># i = jnp.arange(l_max + 1)[:, None, None]</span>
  <span class="c1"># j = jnp.arange(l_max + 1)[None, :, None]</span>
  <span class="c1"># k = jnp.arange(l_max + 1)[None, None, :]</span>
  <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">-</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

  <span class="n">d0_mask_3d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jk,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">d0_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
  <span class="n">d1_mask_3d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jk,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">d1_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">d0_mask_3d</span><span class="p">,</span> <span class="n">d1_mask_3d</span><span class="p">)</span>


<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_gen_derivatives</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                     <span class="n">is_normalized</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Generates derivatives of associated Legendre functions of the first kind.</span>

<span class="sd">  Args:</span>
<span class="sd">    p: The 3D array containing the values of associated Legendre functions; the</span>
<span class="sd">      dimensions are in the sequence of order (m), degree (l), and evalution</span>
<span class="sd">      points.</span>
<span class="sd">    x: A vector of type `float32` or `float64` containing the sampled points.</span>
<span class="sd">    is_normalized: True if the associated Legendre functions are normalized.</span>
<span class="sd">  Returns:</span>
<span class="sd">    The 3D array representing the derivatives of associated Legendre functions</span>
<span class="sd">    of the first kind.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">num_m</span><span class="p">,</span> <span class="n">num_l</span><span class="p">,</span> <span class="n">num_x</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span>

  <span class="c1"># p_{l-1}^m.</span>
  <span class="n">p_m_lm1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))[:,</span> <span class="p">:</span><span class="n">num_l</span><span class="p">,</span> <span class="p">:]</span>

  <span class="c1"># p_{l-1}^{m+2}.</span>
  <span class="n">p_mp2_lm1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p_m_lm1</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))[</span><span class="mi">2</span><span class="p">:</span><span class="n">num_m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

  <span class="c1"># p_{l-1}^{m-2}.</span>
  <span class="n">p_mm2_lm1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">p_m_lm1</span><span class="p">,</span> <span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))[:</span><span class="n">num_m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

  <span class="c1"># Derivative computation requires negative orders.</span>
  <span class="k">if</span> <span class="n">is_normalized</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s1">&#39;Negative orders for normalization is not implemented yet.&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">num_l</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">l_vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
      <span class="n">p_p1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">num_l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">coeff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">l_vec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_vec</span><span class="p">)</span>
      <span class="n">update_p_p1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">p_p1</span><span class="p">)</span>
      <span class="n">p_mm2_lm1</span> <span class="o">=</span> <span class="n">p_mm2_lm1</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">num_l</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">update_p_p1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_l</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">l_vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
      <span class="n">p_p2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">num_l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
      <span class="n">coeff</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">l_vec</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_vec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_vec</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_vec</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
      <span class="n">update_p_p2</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">p_p2</span><span class="p">)</span>
      <span class="n">p_mm2_lm1</span> <span class="o">=</span> <span class="n">p_mm2_lm1</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="n">num_l</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">update_p_p2</span><span class="p">)</span>

  <span class="n">m_mat</span><span class="p">,</span> <span class="n">l_mat</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_m</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_l</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
    <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

  <span class="n">coeff_zeros</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_m</span><span class="p">,</span> <span class="n">num_l</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">upper_0_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">num_m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_l</span><span class="p">)</span>
  <span class="n">zero_vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_l</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="n">a0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_mat</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">a0_masked</span> <span class="o">=</span> <span class="n">coeff_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">a0</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">])</span>
  <span class="n">a0_masked</span> <span class="o">=</span> <span class="n">a0_masked</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">zero_vec</span><span class="p">)</span>

  <span class="n">b0</span> <span class="o">=</span> <span class="n">l_mat</span> <span class="o">+</span> <span class="n">m_mat</span>
  <span class="n">c0</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">*</span> <span class="p">(</span><span class="n">b0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">b0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">c0_masked</span> <span class="o">=</span> <span class="n">coeff_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">c0</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">])</span>
  <span class="n">c0_masked</span> <span class="o">=</span> <span class="n">c0_masked</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">zero_vec</span><span class="p">)</span>

  <span class="c1"># p_l^{m-1}.</span>
  <span class="n">p_mm1_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">a0_masked</span><span class="p">,</span> <span class="n">p_m_lm1</span><span class="p">)</span> <span class="o">+</span>
             <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">c0_masked</span><span class="p">,</span> <span class="n">p_mm2_lm1</span><span class="p">))</span>

  <span class="n">d0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_mat</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">d0_masked</span> <span class="o">=</span> <span class="n">coeff_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">])</span>
  <span class="n">e0</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">*</span> <span class="n">b0</span> <span class="o">*</span> <span class="p">(</span><span class="n">b0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">e0_masked</span> <span class="o">=</span> <span class="n">coeff_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">e0</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">])</span>

  <span class="c1"># p_l^{m+1}.</span>
  <span class="n">p_mp1_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">d0_masked</span><span class="p">,</span> <span class="n">p_mp2_lm1</span><span class="p">)</span> <span class="o">+</span>
             <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">e0_masked</span><span class="p">,</span> <span class="n">p_m_lm1</span><span class="p">))</span>

  <span class="n">f0</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">*</span> <span class="p">(</span><span class="n">l_mat</span> <span class="o">-</span> <span class="n">m_mat</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
  <span class="n">f0_masked</span> <span class="o">=</span> <span class="n">coeff_zeros</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">f0</span><span class="p">[</span><span class="n">upper_0_indices</span><span class="p">])</span>
  <span class="n">p_derivative</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">f0_masked</span><span class="p">,</span> <span class="n">p_mm1_l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">p_mp1_l</span>

  <span class="c1"># Special treatment of the singularity at m = 1.</span>
  <span class="k">if</span> <span class="n">num_m</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">l_vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_l</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij-&gt;ij&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">l_vec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">l_vec</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
    <span class="k">if</span> <span class="n">num_l</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">g0</span> <span class="o">=</span> <span class="n">g0</span> <span class="o">-</span>  <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">p_derivative_m0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;j,ij-&gt;ij&#39;</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">g0</span><span class="p">)</span>
    <span class="n">p_derivative</span> <span class="o">=</span> <span class="n">p_derivative</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">p_derivative_m0</span><span class="p">)</span>
    <span class="n">p_derivative</span> <span class="o">=</span> <span class="n">p_derivative</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">p_derivative</span>


<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">_gen_associated_legendre</span><span class="p">(</span><span class="n">l_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                             <span class="n">is_normalized</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes associated Legendre functions (ALFs) of the first kind.</span>

<span class="sd">  The ALFs of the first kind are used in spherical harmonics. The spherical</span>
<span class="sd">  harmonic of degree `l` and order `m` can be written as</span>
<span class="sd">  `Y_l^m(Î¸, Ï†) = N_l^m * P_l^m(cos(Î¸)) * exp(i m Ï†)`, where `N_l^m` is the</span>
<span class="sd">  normalization factor and Î¸ and Ï† are the colatitude and longitude,</span>
<span class="sd">  repectively. `N_l^m` is chosen in the way that the spherical harmonics form</span>
<span class="sd">  a set of orthonormal basis function of L^2(S^2). For the computational</span>
<span class="sd">  efficiency of spherical harmonics transform, the normalization factor is</span>
<span class="sd">  used in the computation of the ALFs. In addition, normalizing `P_l^m`</span>
<span class="sd">  avoids overflow/underflow and achieves better numerical stability. Three</span>
<span class="sd">  recurrence relations are used in the computation.</span>

<span class="sd">  Args:</span>
<span class="sd">    l_max: The maximum degree of the associated Legendre function. Both the</span>
<span class="sd">      degrees and orders are `[0, 1, 2, ..., l_max]`.</span>
<span class="sd">    x: A vector of type `float32`, `float64` containing the sampled points in</span>
<span class="sd">      spherical coordinates, at which the ALFs are computed; `x` is essentially</span>
<span class="sd">      `cos(Î¸)`. For the numerical integration used by the spherical harmonics</span>
<span class="sd">      transforms, `x` contains the quadrature points in the interval of</span>
<span class="sd">      `[-1, 1]`. There are several approaches to provide the quadrature points:</span>
<span class="sd">      Gauss-Legendre method (`scipy.special.roots_legendre`), Gauss-Chebyshev</span>
<span class="sd">      method (`scipy.special.roots_chebyu`), and Driscoll &amp; Healy</span>
<span class="sd">      method (Driscoll, James R., and Dennis M. Healy. &quot;Computing Fourier</span>
<span class="sd">      transforms and convolutions on the 2-sphere.&quot; Advances in applied</span>
<span class="sd">      mathematics 15, no. 2 (1994): 202-250.). The Gauss-Legendre quadrature</span>
<span class="sd">      points are nearly equal-spaced along Î¸ and provide exact discrete</span>
<span class="sd">      orthogonality, (P^m)^T W P_m = I, where `T` represents the transpose</span>
<span class="sd">      operation, `W` is a diagonal matrix containing the quadrature weights,</span>
<span class="sd">      and `I` is the identity matrix. The Gauss-Chebyshev points are equally</span>
<span class="sd">      spaced, which only provide approximate discrete orthogonality. The</span>
<span class="sd">      Driscoll &amp; Healy qudarture points are equally spaced and provide the</span>
<span class="sd">      exact discrete orthogonality. The number of sampling points is required to</span>
<span class="sd">      be twice as the number of frequency points (modes) in the Driscoll &amp; Healy</span>
<span class="sd">      approach, which enables FFT and achieves a fast spherical harmonics</span>
<span class="sd">      transform.</span>
<span class="sd">    is_normalized: True if the associated Legendre functions are normalized.</span>
<span class="sd">      With normalization, `N_l^m` is applied such that the spherical harmonics</span>
<span class="sd">      form a set of orthonormal basis functions of L^2(S^2).</span>

<span class="sd">  Returns:</span>
<span class="sd">    The 3D array of shape `(l_max + 1, l_max + 1, len(x))` containing the values</span>
<span class="sd">    of the ALFs at `x`; the dimensions in the sequence of order, degree, and</span>
<span class="sd">    evalution points.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="n">a_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="n">b_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">is_normalized</span><span class="p">:</span>
    <span class="n">initial_value</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>  <span class="c1"># The initial value p(0,0).</span>
    <span class="n">f_a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">a_idx</span><span class="p">))</span>
    <span class="n">f_b</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">b_idx</span> <span class="o">+</span> <span class="mf">3.0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">initial_value</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># The initial value p(0,0).</span>
    <span class="n">f_a</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">a_idx</span><span class="p">)</span>
    <span class="n">f_b</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">b_idx</span> <span class="o">+</span> <span class="mf">1.0</span>

  <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">initial_value</span><span class="p">)</span>

  <span class="c1"># Compute the diagonal entries p(l,l) with recurrence.</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span>
      <span class="n">jnp</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
      <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">p_diag</span> <span class="o">=</span> <span class="n">initial_value</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">f_a</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">diag_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">l_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">diag_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">diag_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">p_diag</span><span class="p">)</span>

  <span class="c1"># Compute the off-diagonal entries with recurrence.</span>
  <span class="n">p_offdiag</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;ij&#39;</span><span class="p">,</span>
                         <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span> <span class="n">f_b</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
                         <span class="n">p</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="n">l_max</span><span class="p">)])</span>
  <span class="n">offdiag_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">diag_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">l_max</span><span class="p">],</span> <span class="n">diag_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="n">l_max</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">offdiag_indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">p_offdiag</span><span class="p">)</span>

  <span class="c1"># Compute the remaining entries with recurrence.</span>
  <span class="n">d0_mask_3d</span><span class="p">,</span> <span class="n">d1_mask_3d</span> <span class="o">=</span> <span class="n">_gen_recurrence_mask</span><span class="p">(</span>
      <span class="n">l_max</span><span class="p">,</span> <span class="n">is_normalized</span><span class="o">=</span><span class="n">is_normalized</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">body_fun</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p_val</span><span class="p">):</span>
    <span class="n">coeff_0</span> <span class="o">=</span> <span class="n">d0_mask_3d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">coeff_1</span> <span class="o">=</span> <span class="n">d1_mask_3d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span>
                    <span class="n">coeff_0</span><span class="p">,</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
                        <span class="s1">&#39;ijk,k-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">))</span> <span class="o">-</span>
         <span class="n">jnp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">coeff_1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">p_val</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">p_val</span> <span class="o">=</span> <span class="n">p_val</span> <span class="o">+</span> <span class="n">h</span>
    <span class="k">return</span> <span class="n">p_val</span>

  <span class="c1"># TODO(jakevdp): use some sort of fixed-point procedure here instead?</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">result_type</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d0_mask_3d</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">l_max</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">l_max</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">body_fun</span><span class="o">=</span><span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">p</span>


<div class="viewcode-block" id="lpmn"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.lpmn.html#jax.nn.lpmn">[docs]</a><span class="k">def</span> <span class="nf">lpmn</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
  <span class="sd">&quot;&quot;&quot;The associated Legendre functions (ALFs) of the first kind.</span>

<span class="sd">  Args:</span>
<span class="sd">    m: The maximum order of the associated Legendre functions.</span>
<span class="sd">    n: The maximum degree of the associated Legendre function, often called</span>
<span class="sd">      `l` in describing ALFs. Both the degrees and orders are</span>
<span class="sd">      `[0, 1, 2, ..., l_max]`, where `l_max` denotes the maximum degree.</span>
<span class="sd">    z: A vector of type `float32` or `float64` containing the sampling</span>
<span class="sd">      points at which the ALFs are computed.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A 2-tuple of 3D arrays of shape `(l_max + 1, l_max + 1, len(z))` containing</span>
<span class="sd">    the values and derivatives of the associated Legendre functions of the</span>
<span class="sd">    first kind. The return type matches the type of `z`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError if elements of array `z` are not in (float32, float64).</span>
<span class="sd">    ValueError if array `z` is not 1D.</span>
<span class="sd">    NotImplementedError if `m!=n`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s1">&#39;z.dtype=</span><span class="si">{}</span><span class="s1"> is not supported, see docstring for supported types.&#39;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;z must be a 1D array.&#39;</span><span class="p">)</span>

  <span class="n">m</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">concrete_or_error</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="s1">&#39;Argument m of lpmn.&#39;</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">concrete_or_error</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;Argument n of lpmn.&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Computations for m!=n are not yet supported.&#39;</span><span class="p">)</span>

  <span class="n">l_max</span> <span class="o">=</span> <span class="n">n</span>
  <span class="n">is_normalized</span> <span class="o">=</span> <span class="kc">False</span>
  <span class="n">p_vals</span> <span class="o">=</span> <span class="n">_gen_associated_legendre</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">is_normalized</span><span class="p">)</span>
  <span class="n">p_derivatives</span> <span class="o">=</span> <span class="n">_gen_derivatives</span><span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">is_normalized</span><span class="p">)</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">p_derivatives</span><span class="p">)</span></div>


<div class="viewcode-block" id="lpmn_values"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.lpmn_values.html#jax.nn.lpmn_values">[docs]</a><span class="k">def</span> <span class="nf">lpmn_values</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">is_normalized</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;The associated Legendre functions (ALFs) of the first kind.</span>

<span class="sd">  Unlike `lpmn`, this function only computes the values of ALFs.</span>
<span class="sd">  The ALFs of the first kind can be used in spherical harmonics. The</span>
<span class="sd">  spherical harmonic of degree `l` and order `m` can be written as</span>
<span class="sd">  :math:`Y_l^m(\theta, \phi) = N_l^m * P_l^m(\cos \theta) * \exp(i m \phi)`,</span>
<span class="sd">  where :math:`N_l^m` is the normalization factor and Î¸ and Ï† are the</span>
<span class="sd">  colatitude and longitude, repectively. :math:`N_l^m` is chosen in the</span>
<span class="sd">  way that the spherical harmonics form a set of orthonormal basis function</span>
<span class="sd">  of :math:`L^2(S^2)`. Normalizing :math:`P_l^m` avoids overflow/underflow</span>
<span class="sd">  and achieves better numerical stability.</span>

<span class="sd">  Args:</span>
<span class="sd">    m: The maximum order of the associated Legendre functions.</span>
<span class="sd">    n: The maximum degree of the associated Legendre function, often called</span>
<span class="sd">      `l` in describing ALFs. Both the degrees and orders are</span>
<span class="sd">      `[0, 1, 2, ..., l_max]`, where `l_max` denotes the maximum degree.</span>
<span class="sd">    z: A vector of type `float32` or `float64` containing the sampling</span>
<span class="sd">      points at which the ALFs are computed.</span>
<span class="sd">    is_normalized: True if the associated Legendre functions are normalized.</span>
<span class="sd">      With normalization, :math:`N_l^m` is applied such that the spherical</span>
<span class="sd">      harmonics form a set of orthonormal basis functions of :math:`L^2(S^2)`.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A 3D array of shape `(l_max + 1, l_max + 1, len(z))` containing</span>
<span class="sd">    the values of the associated Legendre functions of the first kind. The</span>
<span class="sd">    return type matches the type of `z`.</span>

<span class="sd">  Raises:</span>
<span class="sd">    TypeError if elements of array `z` are not in (float32, float64).</span>
<span class="sd">    ValueError if array `z` is not 1D.</span>
<span class="sd">    NotImplementedError if `m!=n`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dtype</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s1">&#39;z.dtype=</span><span class="si">{}</span><span class="s1"> is not supported, see docstring for supported types.&#39;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;z must be a 1D array.&#39;</span><span class="p">)</span>

  <span class="n">m</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">concrete_or_error</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="s1">&#39;Argument m of lpmn.&#39;</span><span class="p">)</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">concrete_or_error</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;Argument n of lpmn.&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Computations for m!=n are not yet supported.&#39;</span><span class="p">)</span>

  <span class="n">l_max</span> <span class="o">=</span> <span class="n">n</span>

  <span class="k">return</span> <span class="n">_gen_associated_legendre</span><span class="p">(</span><span class="n">l_max</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">is_normalized</span><span class="p">)</span></div>



<span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">_sph_harm</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
              <span class="n">n</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
              <span class="n">theta</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
              <span class="n">phi</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
              <span class="n">n_max</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Computes the spherical harmonics.&quot;&quot;&quot;</span>

  <span class="n">cos_colatitude</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>

  <span class="n">legendre</span> <span class="o">=</span> <span class="n">_gen_associated_legendre</span><span class="p">(</span><span class="n">n_max</span><span class="p">,</span> <span class="n">cos_colatitude</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">legendre_val</span> <span class="o">=</span> <span class="n">legendre</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">))]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;clip&quot;</span><span class="p">)</span>

  <span class="n">angle</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta</span>
  <span class="n">vandermonde</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span>
  <span class="n">harmonics</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">legendre_val</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">vandermonde</span><span class="p">),</span>
                          <span class="n">legendre_val</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">vandermonde</span><span class="p">))</span>

  <span class="c1"># Negative order.</span>
  <span class="n">harmonics</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">harmonics</span><span class="p">),</span>
                        <span class="n">harmonics</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">harmonics</span>


<div class="viewcode-block" id="sph_harm"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.sph_harm.html#jax.nn.sph_harm">[docs]</a><span class="k">def</span> <span class="nf">sph_harm</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">n</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">theta</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">phi</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
             <span class="n">n_max</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Computes the spherical harmonics.</span>

<span class="sd">  The JAX version has one extra argument `n_max`, the maximum value in `n`.</span>

<span class="sd">  The spherical harmonic of degree `n` and order `m` can be written as</span>
<span class="sd">  :math:`Y_n^m(\theta, \phi) = N_n^m * P_n^m(\cos \phi) * \exp(i m \theta)`,</span>
<span class="sd">  where :math:`N_n^m = \sqrt{\frac{\left(2n+1\right) \left(n-m\right)!}</span>
<span class="sd">  {4 \pi \left(n+m\right)!}}` is the normalization factor and :math:`\phi` and</span>
<span class="sd">  :math:\theta` are the colatitude and longitude, repectively. :math:`N_n^m` is</span>
<span class="sd">  chosen in the way that the spherical harmonics form a set of orthonormal basis</span>
<span class="sd">  functions of :math:`L^2(S^2)`.</span>

<span class="sd">  Args:</span>
<span class="sd">    m: The order of the harmonic; must have `|m| &lt;= n`. Return values for</span>
<span class="sd">      `|m| &gt; n` ara undefined.</span>
<span class="sd">    n: The degree of the harmonic; must have `n &gt;= 0`. The standard notation for</span>
<span class="sd">      degree in descriptions of spherical harmonics is `l (lower case L)`. We</span>
<span class="sd">      use `n` here to be consistent with `scipy.special.sph_harm`. Return</span>
<span class="sd">      values for `n &lt; 0` are undefined.</span>
<span class="sd">    theta: The azimuthal (longitudinal) coordinate; must be in [0, 2*pi].</span>
<span class="sd">    phi: The polar (colatitudinal) coordinate; must be in [0, pi].</span>
<span class="sd">    n_max: The maximum degree `max(n)`. If the supplied `n_max` is not the true</span>
<span class="sd">      maximum value of `n`, the results are clipped to `n_max`. For example,</span>
<span class="sd">      `sph_harm(m=jnp.array([2]), n=jnp.array([10]), theta, phi, n_max=6)`</span>
<span class="sd">      acutually returns</span>
<span class="sd">      `sph_harm(m=jnp.array([2]), n=jnp.array([6]), theta, phi, n_max=6)`</span>
<span class="sd">  Returns:</span>
<span class="sd">    A 1D array containing the spherical harmonics at (m, n, theta, phi).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="n">jnp</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">n_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">n_max</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
  <span class="n">n_max</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">concrete_or_error</span><span class="p">(</span>
      <span class="nb">int</span><span class="p">,</span> <span class="n">n_max</span><span class="p">,</span> <span class="s1">&#39;The `n_max` argument of `jnp.scipy.special.sph_harm` must &#39;</span>
      <span class="s1">&#39;be statically specified to use `sph_harm` within JAX transformations.&#39;</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">_sph_harm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">n_max</span><span class="p">)</span></div>


<span class="c1"># exponential integrals</span>
<span class="c1"># these algorithms are ported over from the files ei.c and expn.c in the Cephes mathematical library.</span>
<span class="c1"># https://fossies.org/dox/cephes-math-28/ei_8c_source.html</span>
<span class="c1"># https://fossies.org/dox/cephes-math-28/expn_8c_source.html</span>


<span class="k">def</span> <span class="nf">_expint1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># 0 &lt; x &lt;= 2</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">-</span><span class="mf">5.350447357812542947283e0</span><span class="p">,</span>
    <span class="mf">2.185049168816613393830e2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">4.176572384826693777058e3</span><span class="p">,</span>
    <span class="mf">5.541176756393557601232e4</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">3.313381331178144034309e5</span><span class="p">,</span>
    <span class="mf">1.592627163384945414220e6</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">5.250547959112862969197e1</span><span class="p">,</span>
    <span class="mf">1.259616186786790571525e3</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.756549581973534652631e4</span><span class="p">,</span>
    <span class="mf">1.493062117002725991967e5</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">7.294949239640527645655e5</span><span class="p">,</span>
    <span class="mf">1.592627163384945429726e6</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">U</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">])</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">f</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">euler_gamma</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="c1"># helper function for all subsequent intervals</span>
  <span class="n">A</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">U</span> <span class="ow">in</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">])</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">w</span> <span class="o">=</span> <span class="n">one</span> <span class="o">/</span> <span class="n">x</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span> <span class="o">+</span> <span class="n">one</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">_expint2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># 2 &lt;= x &lt; 4</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.981808503259689673238e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.271645625984917501326e0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.088160335681228318920e0</span><span class="p">,</span>
    <span class="mf">2.755544509187936721172e0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">4.409507048701600257171e-1</span><span class="p">,</span>
    <span class="mf">4.665623805935891391017e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.545042679673485262580e-3</span><span class="p">,</span>
    <span class="mf">7.059980605299617478514e-5</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="mf">1.476498670914921440652e0</span><span class="p">,</span>
    <span class="mf">5.629177174822436244827e-1</span><span class="p">,</span>
    <span class="mf">1.699017897879307263248e-1</span><span class="p">,</span>
    <span class="mf">2.291647179034212017463e-2</span><span class="p">,</span>
    <span class="mf">4.450150439728752875043e-3</span><span class="p">,</span>
    <span class="mf">1.727439612206521482874e-4</span><span class="p">,</span>
    <span class="mf">3.953167195549672482304e-5</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expint3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># 4 &lt;= x &lt;= 8</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">-</span><span class="mf">1.373215375871208729803e0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">7.084559133740838761406e-1</span><span class="p">,</span>
    <span class="mf">1.580806855547941010501e0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.601500427425622944234e-1</span><span class="p">,</span>
    <span class="mf">2.994674694113713763365e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.038086040188744005513e-3</span><span class="p">,</span>
    <span class="mf">4.371064420753005429514e-5</span><span class="p">,</span>
    <span class="mf">2.141783679522602903795e-6</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="mf">8.585231423622028380768e-1</span><span class="p">,</span>
    <span class="mf">4.483285822873995129957e-1</span><span class="p">,</span>
    <span class="mf">7.687932158124475434091e-2</span><span class="p">,</span>
    <span class="mf">2.449868241021887685904e-2</span><span class="p">,</span>
    <span class="mf">8.832165941927796567926e-4</span><span class="p">,</span>
    <span class="mf">4.590952299511353531215e-4</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">4.729848351866523044863e-6</span><span class="p">,</span>
    <span class="mf">2.665195537390710170105e-6</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expint4</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># 8 &lt;= x &lt;= 16</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">-</span><span class="mf">2.106934601691916512584e0</span><span class="p">,</span>
    <span class="mf">1.732733869664688041885e0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.423619178935841904839e-1</span><span class="p">,</span>
    <span class="mf">2.322724180937565842585e-2</span><span class="p">,</span>
    <span class="mf">2.372880440493179832059e-4</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">8.343219561192552752335e-5</span><span class="p">,</span>
    <span class="mf">1.363408795605250394881e-5</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">3.655412321999253963714e-7</span><span class="p">,</span>
    <span class="mf">1.464941733975961318456e-8</span><span class="p">,</span>
    <span class="mf">6.176407863710360207074e-10</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.298062239901678075778e-1</span><span class="p">,</span>
    <span class="mf">1.105077041474037862347e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.566542966630792353556e-2</span><span class="p">,</span>
    <span class="mf">2.761106850817352773874e-3</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.089148012284048449115e-4</span><span class="p">,</span>
    <span class="mf">1.708528938807675304186e-5</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">4.459311796356686423199e-7</span><span class="p">,</span>
    <span class="mf">1.394634930353847498145e-8</span><span class="p">,</span>
    <span class="mf">6.150865933977338354138e-10</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expint5</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># 16 &lt;= x &lt;= 32</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">-</span><span class="mf">2.458119367674020323359e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.483382253322077687183e-1</span><span class="p">,</span>
    <span class="mf">7.248291795735551591813e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.348315687380940523823e-2</span><span class="p">,</span>
    <span class="mf">1.342775069788636972294e-3</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">7.942465637159712264564e-5</span><span class="p">,</span>
    <span class="mf">2.644179518984235952241e-6</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">4.239473659313765177195e-8</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.044225908443871106315e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.676453128101402655055e-1</span><span class="p">,</span>
    <span class="mf">9.695000254621984627876e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.601745692712991078208e-2</span><span class="p">,</span>
    <span class="mf">1.496414899205908021882e-3</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">8.462452563778485013756e-5</span><span class="p">,</span>
    <span class="mf">2.728938403476726394024e-6</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">4.239462431819542051337e-8</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expint6</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># 32 &lt;= x &lt;= 64</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.212561118105456670844e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">5.823133179043894485122e-1</span><span class="p">,</span>
    <span class="mf">2.348887314557016779211e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">3.040034318113248237280e-2</span><span class="p">,</span>
    <span class="mf">1.510082146865190661777e-3</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.523137095499571377122e-5</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.002252150365854016662e0</span><span class="p">,</span>
    <span class="mf">2.928709694872224144953e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">3.337004338674007801307e-2</span><span class="p">,</span>
    <span class="mf">1.560544881127388842819e-3</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.523137093603234562648e-5</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expint7</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># x &gt; 64</span>
  <span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">-</span><span class="mf">7.657847078286127362028e-1</span><span class="p">,</span>
    <span class="mf">6.886192415566705051750e-1</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.132598113545206124553e-1</span><span class="p">,</span>
    <span class="mf">3.346107552384193813594e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">3.076541477344756050249e-3</span><span class="p">,</span>
    <span class="mf">1.747119316454907477380e-4</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">6.103711682274170530369e-6</span><span class="p">,</span>
    <span class="mf">1.218032765428652199087e-7</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.086076102793290233007e-9</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="n">B</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mf">1.0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.888802868662308731041e0</span><span class="p">,</span>
    <span class="mf">1.066691687211408896850e0</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">2.751915982306380647738e-1</span><span class="p">,</span>
    <span class="mf">3.930852688233823569726e-2</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">3.414684558602365085394e-3</span><span class="p">,</span>
    <span class="mf">1.866844370703555398195e-4</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">6.345146083130515357861e-6</span><span class="p">,</span>
    <span class="mf">1.239754287483206878024e-7</span><span class="p">,</span>
    <span class="o">-</span><span class="mf">1.086076102793126632978e-9</span><span class="p">,</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">_eval_expint_k</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expi_pos</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="c1"># x &gt; 0</span>
  <span class="n">_c</span> <span class="o">=</span> <span class="n">_lax_const</span>
  <span class="n">conds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span> <span class="o">+</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
  <span class="p">]</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">conds</span><span class="p">,</span>
    <span class="p">[</span><span class="n">_expint1</span><span class="p">,</span> <span class="n">_expint2</span><span class="p">,</span> <span class="n">_expint3</span><span class="p">,</span> <span class="n">_expint4</span><span class="p">,</span> <span class="n">_expint5</span><span class="p">,</span> <span class="n">_expint6</span><span class="p">,</span> <span class="n">_expint7</span><span class="p">],</span>
  <span class="p">)</span>


<div class="viewcode-block" id="expi"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.expi.html#jax.nn.expi">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">expi</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="nd">@api</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">expi</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="p">(</span><span class="n">x</span><span class="p">,)</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;expi&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">exp1</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">),</span> <span class="n">_expi_pos</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">ret</span></div>


<span class="nd">@expi</span><span class="o">.</span><span class="n">defjvp</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">expi_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="p">(</span><span class="n">x</span><span class="p">,)</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="p">(</span><span class="n">x_dot</span><span class="p">,)</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">expi</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x_dot</span>


<span class="k">def</span> <span class="nf">_expn1</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="c1"># exponential integral En</span>
  <span class="n">_c</span> <span class="o">=</span> <span class="n">_lax_const</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">MACHEP</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

  <span class="n">zero</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">psi</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">euler_gamma</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">psi</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">psi</span><span class="p">:</span> <span class="n">psi</span> <span class="o">+</span> <span class="n">one</span> <span class="o">/</span> <span class="n">i</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
  <span class="n">n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">one</span> <span class="o">+</span> <span class="n">one</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
  <span class="n">init</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
    <span class="n">z</span><span class="o">=-</span><span class="n">x</span><span class="p">,</span>
    <span class="n">xk</span><span class="o">=</span><span class="n">zero</span><span class="p">,</span>
    <span class="n">yk</span><span class="o">=</span><span class="n">one</span><span class="p">,</span>
    <span class="n">pk</span><span class="o">=</span><span class="n">one</span> <span class="o">-</span> <span class="n">n</span><span class="p">,</span>
    <span class="n">ans</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span> <span class="o">/</span> <span class="p">(</span><span class="n">one</span> <span class="o">-</span> <span class="n">n1</span><span class="p">)),</span>
    <span class="n">t</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;xk&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">one</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;yk&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;xk&quot;</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">one</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">zero</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;yk&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span> <span class="n">zero</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">zero</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;yk&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]),</span> <span class="n">one</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

  <span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_c</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MACHEP</span><span class="p">)</span>

  <span class="n">d</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">n</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="n">r</span> <span class="o">*</span> <span class="n">psi</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">gammaln</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_expn2</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="c1"># x &gt; 1.</span>
  <span class="n">_c</span> <span class="o">=</span> <span class="n">_lax_const</span>
  <span class="n">BIG</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.44115188075855872e17</span><span class="p">)</span>
  <span class="n">MACHEP</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">BIG</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>  <span class="c1"># ?</span>
  <span class="n">zero</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

  <span class="n">init</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">k</span><span class="o">=</span><span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">pkm2</span><span class="o">=</span><span class="n">one</span><span class="p">,</span>
    <span class="n">qkm2</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
    <span class="n">pkm1</span><span class="o">=</span><span class="n">one</span><span class="p">,</span>
    <span class="n">qkm1</span><span class="o">=</span><span class="n">x</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span>
    <span class="n">ans</span><span class="o">=</span><span class="n">one</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">n</span><span class="p">),</span>
    <span class="n">t</span><span class="o">=</span><span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
    <span class="n">r</span><span class="o">=</span><span class="n">zero</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_c</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span>
    <span class="n">odd</span> <span class="o">=</span> <span class="n">k</span> <span class="o">%</span> <span class="n">_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">yk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">odd</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">xk</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">odd</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="n">_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">k</span> <span class="o">/</span> <span class="n">_c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">pk</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pkm1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">yk</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pkm2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xk</span>
    <span class="n">qk</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;qkm1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">yk</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;qkm2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xk</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">qk</span> <span class="o">!=</span> <span class="n">zero</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="n">pk</span> <span class="o">/</span> <span class="n">qk</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">])</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="nb">abs</span><span class="p">((</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">),</span> <span class="n">one</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">])</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pkm2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pkm1&quot;</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;pkm1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pk</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;qkm2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;qkm1&quot;</span><span class="p">]</span>
    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;qkm1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qk</span>
    <span class="n">is_big</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">BIG</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="s2">&quot;pq&quot;</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s2">&quot;12&quot;</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;km&quot;</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_big</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">BIG</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">d</span>

  <span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_c</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MACHEP</span><span class="p">)</span>

  <span class="n">d</span> <span class="o">=</span> <span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ans&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_expn3</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="c1"># n &gt;= 5000</span>
  <span class="n">_c</span> <span class="o">=</span> <span class="n">_lax_const</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="n">xk</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">n</span>
  <span class="n">yk</span> <span class="o">=</span> <span class="n">one</span> <span class="o">/</span> <span class="p">(</span><span class="n">xk</span> <span class="o">*</span> <span class="n">xk</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">n</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">yk</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">yk</span> <span class="o">*</span> <span class="p">(</span><span class="n">ans</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">yk</span> <span class="o">*</span> <span class="p">(</span><span class="n">ans</span> <span class="o">+</span> <span class="n">t</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">ans</span> <span class="o">+</span> <span class="n">one</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">xk</span>


<div class="viewcode-block" id="expn"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.expn.html#jax.nn.expn">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">expn</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">)</span>
<span class="nd">@partial</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">custom_jvp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="nd">@jnp</span><span class="o">.</span><span class="n">vectorize</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">expn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">n</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;expn&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">_c</span> <span class="o">=</span> <span class="n">_lax_const</span>
  <span class="n">zero</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">one</span> <span class="o">=</span> <span class="n">_c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">conds</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">zero</span><span class="p">),</span>
    <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">zero</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">zero</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
    <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">zero</span><span class="p">),</span>
    <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)),</span>
    <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">one</span><span class="p">),</span>
  <span class="p">]</span>
  <span class="n">n1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">_c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
  <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
    <span class="n">one</span> <span class="o">/</span> <span class="n">n1</span><span class="p">,</span>  <span class="c1"># prevent div by zero</span>
    <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span>
    <span class="n">partial</span><span class="p">(</span><span class="n">_expn3</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
    <span class="n">partial</span><span class="p">(</span><span class="n">_expn2</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
    <span class="n">partial</span><span class="p">(</span><span class="n">_expn1</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
  <span class="p">]</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">piecewise</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">conds</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ret</span></div>


<span class="nd">@expn</span><span class="o">.</span><span class="n">defjvp</span>
<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">expn_jvp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="p">(</span><span class="n">x</span><span class="p">,),</span> <span class="p">(</span><span class="n">x_dot</span><span class="p">,)</span> <span class="o">=</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">expn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">lax</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span>
    <span class="n">lax</span><span class="o">.</span><span class="n">neg</span><span class="p">(</span><span class="n">x_dot</span><span class="p">),</span> <span class="n">expn</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">_lax_const</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">)</span>


<div class="viewcode-block" id="exp1"><a class="viewcode-back" href="../../../../_autosummary/jax.scipy.special.exp1.html#jax.nn.exp1">[docs]</a><span class="nd">@_wraps</span><span class="p">(</span><span class="n">osp_special</span><span class="o">.</span><span class="n">exp1</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;scipy.special&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">exp1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;scipy.special&#39;</span><span class="p">):</span>
  <span class="p">(</span><span class="n">x</span><span class="p">,)</span> <span class="o">=</span> <span class="n">_promote_args_inexact</span><span class="p">(</span><span class="s2">&quot;exp1&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">expn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      &copy; Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>