
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>jax._src.config &#8212; JAX  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" href="../../../_static/style.css" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/jax_logo_250px.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../installation.html">
   Installing JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/quickstart.html">
   JAX Quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Common_Gotchas_in_JAX.html">
   ðŸ”ª JAX - The Sharp Bits ðŸ”ª
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../jax-101/index.html">
   Tutorial: JAX 101
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
   </li>
  </ul>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../debugging/index.html">
   Runtime value debugging in JAX
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../debugging/print_breakpoint.html">
     <code class="docutils literal notranslate">
      <span class="pre">
       jax.debug.print
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       jax.debug.breakpoint
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
      <span class="pre">
       checkify
      </span>
     </code>
     transformation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../debugging/flags.html">
     JAX debugging flags
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../async_dispatch.html">
   Asynchronous dispatch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../aot.html">
   Ahead-of-time lowering and compilation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../jaxpr.html">
   Understanding Jaxprs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../pytrees.html">
   Pytrees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../type_promotion.html">
   Type promotion semantics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../errors.html">
   JAX Errors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../transfer_guard.html">
   Transfer guard
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../glossary.html">
   JAX Glossary of Terms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../changelog.html">
   Change log
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../api_compatibility.html">
   API compatibility
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../deprecation.html">
   Python and NumPy version support policy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../concurrency.html">
   Concurrency
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../profiling.html">
   Profiling JAX programs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../device_memory_profiling.html">
   Device Memory Profiling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rank_promotion_warning.html">
   Rank promotion warning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../contributing.html">
   Contributing to JAX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../developer.html">
   Building from source
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../jax_internal_api.html">
   Internal APIs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../jax.html">
   Public API: jax package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.numpy.html">
     jax.numpy package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.scipy.html">
     jax.scipy package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.config.html">
     JAX configuration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.debug.html">
     jax.debug package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.dlpack.html">
     jax.dlpack module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.distributed.html">
     jax.distributed module
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../jax.example_libraries.html">
     jax.example_libraries package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../jax.experimental.html">
     jax.experimental package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.flatten_util.html">
     jax.flatten_util package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.image.html">
     jax.image package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.lax.html">
     jax.lax package
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../../../jax.nn.html">
     jax.nn package
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../../../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.ops.html">
     jax.ops package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.profiler.html">
     jax.profiler module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.random.html">
     jax.random package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.stages.html">
     jax.stages package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.tree_util.html">
     jax.tree_util package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../jax.lib.html">
     jax.lib package
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/google/jax"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for jax._src.config</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The JAX Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="c1"># TODO(phawkins): this file triggers a pytype bug.</span>
<span class="c1"># pytype: skip-file</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Hashable</span><span class="p">,</span> <span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">logging</span>

<span class="kn">from</span> <span class="nn">jax._src</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">jax._src.lib</span> <span class="kn">import</span> <span class="n">jax_jit</span>
<span class="kn">from</span> <span class="nn">jax._src.lib</span> <span class="kn">import</span> <span class="n">transfer_guard_lib</span>
<span class="kn">from</span> <span class="nn">jax._src.lib</span> <span class="kn">import</span> <span class="n">xla_client</span>

<span class="k">def</span> <span class="nf">bool_env</span><span class="p">(</span><span class="n">varname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Read an environment variable and interpret it as a boolean.</span>

<span class="sd">  True values are (case insensitive): &#39;y&#39;, &#39;yes&#39;, &#39;t&#39;, &#39;true&#39;, &#39;on&#39;, and &#39;1&#39;;</span>
<span class="sd">  false values are &#39;n&#39;, &#39;no&#39;, &#39;f&#39;, &#39;false&#39;, &#39;off&#39;, and &#39;0&#39;.</span>

<span class="sd">  Args:</span>
<span class="sd">    varname: the name of the variable</span>
<span class="sd">    default: the default boolean value</span>
<span class="sd">  Raises: ValueError if the environment variable is anything else.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">))</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">True</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid truth value </span><span class="si">{</span><span class="n">val</span><span class="si">!r}</span><span class="s2"> for environment </span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">int_env</span><span class="p">(</span><span class="n">varname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Read an environment variable and interpret it as an integer.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">default</span><span class="p">)))</span>


<span class="n">UPGRADE_BOOL_HELP</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot; This will be enabled by default in future versions of JAX, at which &quot;</span>
    <span class="s2">&quot;point all uses of the flag will be considered deprecated (following &quot;</span>
    <span class="s2">&quot;the `API compatibility policy &quot;</span>
    <span class="s2">&quot;&lt;https://jax.readthedocs.io/en/latest/api_compatibility.html&gt;`_).&quot;</span><span class="p">)</span>

<span class="n">UPGRADE_BOOL_EXTRA_DESC</span> <span class="o">=</span> <span class="s2">&quot; (transient)&quot;</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
  <span class="n">_HAS_DYNAMIC_ATTRIBUTES</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">FLAGS</span> <span class="o">=</span> <span class="n">NameSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_absl</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_hooks</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_absl</span><span class="p">:</span>
      <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absl_flags</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">check_exists</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized config option: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_hooks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hook</span><span class="p">:</span>
      <span class="n">hook</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
          <span class="s2">&quot;For flags with a corresponding contextmanager, read their value &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;via e.g. `config.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` rather than `config.FLAGS.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">`.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_absl</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absl_flags</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">check_exists</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">add_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">opt_type</span><span class="p">,</span> <span class="n">meta_args</span><span class="p">,</span> <span class="n">meta_kwargs</span><span class="p">,</span>
                 <span class="n">update_hook</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config option </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> already defined&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">opt_type</span><span class="p">,</span> <span class="n">meta_args</span><span class="p">,</span> <span class="n">meta_kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">update_hook</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_update_hooks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_hook</span>
      <span class="n">update_hook</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">check_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized config option: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">DEFINE_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">update_hook</span><span class="o">=</span><span class="n">update_hook</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">DEFINE_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">update_hook</span><span class="o">=</span><span class="n">update_hook</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">DEFINE_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">update_hook</span><span class="o">=</span><span class="n">update_hook</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">DEFINE_enum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">update_hook</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;update_hook&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="s1">&#39;enum&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span>
                    <span class="n">update_hook</span><span class="o">=</span><span class="n">update_hook</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">config_with_absl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Run this before calling `app.run(main)` etc</span>
    <span class="kn">import</span> <span class="nn">absl.flags</span> <span class="k">as</span> <span class="nn">absl_FLAGS</span>  <span class="c1"># noqa: F401</span>
    <span class="kn">from</span> <span class="nn">absl</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">flags</span> <span class="k">as</span> <span class="n">absl_flags</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">use_absl</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">absl_flags</span> <span class="o">=</span> <span class="n">absl_flags</span>
    <span class="n">absl_defs</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">bool</span><span class="p">:</span> <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">,</span>
                  <span class="nb">int</span><span class="p">:</span>  <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">,</span>
                  <span class="nb">str</span><span class="p">:</span>  <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">,</span>
                  <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="n">absl_flags</span><span class="o">.</span><span class="n">DEFINE_enum</span> <span class="p">}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">flag_type</span><span class="p">,</span> <span class="n">meta_args</span><span class="p">,</span> <span class="n">meta_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="n">absl_defs</span><span class="p">[</span><span class="n">flag_type</span><span class="p">](</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">meta_args</span><span class="p">,</span> <span class="o">**</span><span class="n">meta_kwargs</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">call_after_init</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_absl_config</span><span class="p">(</span><span class="n">absl_flags</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">complete_absl_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absl_flags</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">absl_flags</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">parse_flags_with_absl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">already_configured_with_absl</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_configured_with_absl</span><span class="p">:</span>
      <span class="c1"># Extract just the --jax... flags (before the first --) from argv. In some</span>
      <span class="c1"># environments (e.g. ipython/colab) argv might be a mess of things</span>
      <span class="c1"># parseable by absl and other junk.</span>
      <span class="n">jax_argv</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
      <span class="n">jax_argv</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">jax_argv</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--jax&#39;</span><span class="p">))]</span>

      <span class="kn">import</span> <span class="nn">absl.flags</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config_with_absl</span><span class="p">()</span>
      <span class="n">absl</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span><span class="p">(</span><span class="n">jax_argv</span><span class="p">,</span> <span class="n">known_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">complete_absl_config</span><span class="p">(</span><span class="n">absl</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
      <span class="n">already_configured_with_absl</span> <span class="o">=</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="nf">define_bool_state</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bool</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">extra_description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">    This function is a convenience wrapper. It defines a flag, environment</span>
<span class="sd">    variable, and corresponding thread-local state, which can be managed via the</span>
<span class="sd">    contextmanager it returns.</span>

<span class="sd">    The thread-local state value can be read via the ``config.&lt;option_name&gt;``</span>
<span class="sd">    attribute, where ``config`` is the singleton ``Config`` instance.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string, converted to lowercase to define the name of the config</span>
<span class="sd">        option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">        corresponding shell environment variable.</span>
<span class="sd">      default: boolean, a default value for the option.</span>
<span class="sd">      help: string, used to populate the flag help information as well as the</span>
<span class="sd">        docstring of the returned context manager.</span>
<span class="sd">      update_global_hook: a optional callback that is called with the updated</span>
<span class="sd">        value of the global state when it is altered or set initially.</span>
<span class="sd">      update_thread_local_hook: a optional callback that is called with the</span>
<span class="sd">        updated value of the thread-local state when it is altered or set</span>
<span class="sd">        initially.</span>
<span class="sd">      upgrade: optional indicator that this flag controls a canonical feature</span>
<span class="sd">        upgrade, so that it is `True` for the incoming functionality, `False`</span>
<span class="sd">        for the outgoing functionality to be deprecated.</span>
<span class="sd">      extra_description: string, optional: extra information to add to the</span>
<span class="sd">        summary description.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A contextmanager to control the thread-local state value.</span>

<span class="sd">    Example:</span>

<span class="sd">      enable_foo = config.define_bool_state(</span>
<span class="sd">          name=&#39;jax_enable_foo&#39;,</span>
<span class="sd">          default=False,</span>
<span class="sd">          help=&#39;Enable foo.&#39;)</span>

<span class="sd">      # Now the JAX_ENABLE_FOO shell environment variable and --jax_enable_foo</span>
<span class="sd">      # command-line flag can be used to control the process-level value of</span>
<span class="sd">      # the configuration option, in addition to using e.g.</span>
<span class="sd">      # ``config.update(&quot;jax_enable_foo&quot;, True)`` directly. We can also use a</span>
<span class="sd">      # context manager:</span>

<span class="sd">      with enable_foo(True):</span>
<span class="sd">        ...</span>

<span class="sd">    The value of the thread-local state or flag can be accessed via</span>
<span class="sd">    ``config.jax_enable_foo``. Reading it via ``config.FLAGS.jax_enable_foo`` is</span>
<span class="sd">    an error.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">upgrade</span><span class="p">:</span>
      <span class="n">help</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">UPGRADE_BOOL_HELP</span>
      <span class="n">extra_description</span> <span class="o">+=</span> <span class="n">UPGRADE_BOOL_EXTRA_DESC</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bool_env</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">),</span> <span class="n">help</span><span class="p">,</span>
                     <span class="n">update_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">unset</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">val</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">unset</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_state</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_StateContextManager</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">,</span>
                                <span class="n">extra_description</span><span class="o">=</span><span class="n">extra_description</span><span class="p">,</span>
                                <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">define_enum_state</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">enum_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
      <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> \
        <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>
<span class="sd">    Args:</span>
<span class="sd">      name: string, converted to lowercase to define the name of the config</span>
<span class="sd">        option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">        corresponding shell environment variable.</span>
<span class="sd">      enum_values: list of strings representing the possible values for the</span>
<span class="sd">        option.</span>
<span class="sd">      default: optional string, default value.</span>
<span class="sd">      help: string, used to populate the flag help information as well as the</span>
<span class="sd">        docstring of the returned context manager.</span>
<span class="sd">    Returns:</span>
<span class="sd">      A contextmanager to control the thread-local state value.</span>
<span class="sd">    See docstring for ``define_bool_state``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_values</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid value </span><span class="se">\&quot;</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for JAX flag </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">DEFINE_enum</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span>
                     <span class="n">enum_values</span><span class="o">=</span><span class="n">enum_values</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
                     <span class="n">update_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">unset</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">val</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">unset</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_state</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
          <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">new_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enum_values</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new enum value must be None or in </span><span class="si">{</span><span class="n">enum_values</span><span class="si">}</span><span class="s2">, &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_StateContextManager</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">define_string_state</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
      <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">    See docstring for ``define_bool_state``.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string, converted to lowercase to define the name of the config</span>
<span class="sd">        option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">        corresponding shell environment variable.</span>
<span class="sd">      default: string, a default value for the option.</span>
<span class="sd">      help: string, used to populate the flag help information as well as the</span>
<span class="sd">        docstring of the returned context manager.</span>
<span class="sd">      update_global_hook: an optional callback that is called with the updated</span>
<span class="sd">        value of the global state when it is altered or set initially.</span>
<span class="sd">      update_thread_local_hook: an optional callback that is called with the</span>
<span class="sd">        updated value of the thread-local state when it is altered or set</span>
<span class="sd">        initially.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A contextmanager to control the thread-local state value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">new_val</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;new string config value must be None or of type str,&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39; got </span><span class="si">{</span><span class="n">new_val</span><span class="si">}</span><span class="s1"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_string_or_object_state</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span>
                                              <span class="n">update_global_hook</span><span class="p">,</span>
                                              <span class="n">update_thread_local_hook</span><span class="p">,</span>
                                              <span class="n">validate</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">define_string_or_object_state</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
      <span class="n">default</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
      <span class="n">help</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
      <span class="n">update_global_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">update_thread_local_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
      <span class="n">validate_new_val_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set up thread-local state and return a contextmanager for managing it.</span>

<span class="sd">    Similar to ``define_string_state``, except the context manager will accept</span>
<span class="sd">    any object, not just a string. Any value passed via commandline flag or</span>
<span class="sd">    environment variable will be treated as a string.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string, converted to lowercase to define the name of the config</span>
<span class="sd">        option (and absl flag). It is converted to uppercase to define the</span>
<span class="sd">        corresponding shell environment variable.</span>
<span class="sd">      default: string, a default value for the option.</span>
<span class="sd">      help: string, used to populate the flag help information as well as the</span>
<span class="sd">        docstring of the returned context manager.</span>
<span class="sd">      update_global_hook: an optional callback that is called with the updated</span>
<span class="sd">        value of the global state when it is altered or set initially.</span>
<span class="sd">      update_thread_local_hook: an optional callback that is called with the</span>
<span class="sd">        updated value of the thread-local state when it is altered or set</span>
<span class="sd">        initially.</span>
<span class="sd">      validate_new_val_hook: an optional callback that is called with the new</span>
<span class="sd">        value on any update, and should raise an error if the new value is</span>
<span class="sd">        invalid.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A contextmanager to control the thread-local state value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">DEFINE_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help</span><span class="p">,</span>
                       <span class="n">update_hook</span><span class="o">=</span><span class="n">update_global_hook</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">unset</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">val</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">unset</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_state</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">_StateContextManager</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">,</span>
                                <span class="n">validate_new_val_hook</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_trace_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a tuple of configuration values that affect tracing.</span>

<span class="sd">    These values are included in the cache key for linear_util.cache.</span>

<span class="sd">    Values included in this set should also most likely be included in</span>
<span class="sd">    the C++ JIT state, which is handled separately.&quot;&quot;&quot;</span>
    <span class="n">tls</span> <span class="o">=</span> <span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
    <span class="n">axis_env_state</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">extra_jit_context</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">axis_env_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">axis_env_state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">axis_env_state</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">axis_env_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x64_enabled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jax_numpy_rank_promotion</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jax_default_matmul_precision</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jax_dynamic_shapes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jax_numpy_dtype_promotion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jax_default_device</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jax_array</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NoDefault</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">no_default</span> <span class="o">=</span> <span class="n">NoDefault</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_StateContextManager</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">help</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">,</span>
               <span class="n">validate_new_val_hook</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">extra_description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">default_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">no_default</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;jax_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context manager for `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` config option&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">extra_description</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="si">{</span><span class="n">help</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span> <span class="o">=</span> <span class="n">update_thread_local_hook</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_new_val_hook</span> <span class="o">=</span> <span class="n">validate_new_val_hook</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span> <span class="o">=</span> <span class="n">default_value</span>

  <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
  <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_val</span><span class="o">=</span><span class="n">no_default</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">new_val</span> <span class="ow">is</span> <span class="n">no_default</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">no_default</span><span class="p">:</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span>  <span class="c1"># default_value provided to constructor</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no default_value provided to constructor and no value provided as an</span>
        <span class="c1"># argument, so we raise an error</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context manager for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> config option &quot;</span>
                        <span class="s2">&quot;requires an argument representing the new value for &quot;</span>
                        <span class="s2">&quot;the config option.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_new_val_hook</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_validate_new_val_hook</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
    <span class="n">prev_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">unset</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">prev_val</span> <span class="ow">is</span> <span class="n">unset</span><span class="p">:</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">_thread_local_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span><span class="p">(</span><span class="n">prev_val</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_add_hooks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_global_hook</span><span class="p">,</span> <span class="n">update_thread_local_hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Private method that adds hooks to an existing context-manager.</span>

<span class="sd">    Used to avoid cyclic import dependencies.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_update_thread_local_hook</span> <span class="o">=</span> <span class="n">update_thread_local_hook</span>
    <span class="n">config</span><span class="o">.</span><span class="n">_update_hooks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_global_hook</span>
    <span class="n">update_global_hook</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>


<span class="n">_thread_local_state</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_Unset</span><span class="p">:</span> <span class="k">pass</span>
<span class="n">unset</span> <span class="o">=</span> <span class="n">_Unset</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">NameSpace</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span><span class="p">):</span>
    <span class="c1"># must use super because we override this class&#39;s __setattr__, see</span>
    <span class="c1"># https://docs.python.org/3/reference/datamodel.html#object.__setattr__</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_getter&#39;</span><span class="p">,</span> <span class="n">getter</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_setter&#39;</span><span class="p">,</span> <span class="n">setter</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_setter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>


<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
<span class="n">flags</span> <span class="o">=</span> <span class="n">config</span>
<span class="n">FLAGS</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">FLAGS</span>

<span class="n">already_configured_with_absl</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># The C++ JIT maintains its own copy of several configuration items as</span>
<span class="c1"># a global/thread-local state. These methods allow updates to part of the</span>
<span class="c1"># state when a configuration value changes.</span>
<span class="k">class</span> <span class="nc">_GlobalExtraJitContext</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
  <span class="n">numpy_rank_promotion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">numpy_dtype_promotion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">default_matmul_precision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">dynamic_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_update_global_jit_state</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
  <span class="n">gs</span> <span class="o">=</span> <span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span>
  <span class="n">context</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="ow">or</span> <span class="n">_GlobalExtraJitContext</span><span class="p">()</span>
  <span class="n">gs</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_ThreadLocalExtraJitContext</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;&quot;A namedtuple containing states to add to the cache key.</span>

<span class="sd">  Just in time compilation (for jit, pmap, etc) behavior is configurable through</span>
<span class="sd">  global and thread-local options, used in the cache key.</span>

<span class="sd">  The initialization, which uses both config.py and core.py is done using</span>
<span class="sd">  `_update_thread_local_jit_state` in core.py to prevent circular imports.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dynamic_trace_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">axis_env_state</span><span class="p">:</span> <span class="n">Hashable</span> <span class="o">=</span> <span class="p">()</span>
  <span class="n">numpy_rank_promotion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">numpy_dtype_promotion</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">default_matmul_precision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">dynamic_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">_ThreadLocalStateCache</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;&quot;A thread local cache for _ThreadLocalExtraJitContext</span>

<span class="sd">  The extra_jit_context in jax_jit.thread_local_state() may get updated and thus</span>
<span class="sd">  incurring dispatch overhead for comparing this python object during jit calls.</span>
<span class="sd">  We want to duduplicate the objects that have the same hash/equality to also</span>
<span class="sd">  have the same object ID, since the equality check is much faster if the object</span>
<span class="sd">  IDs match.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">canonicalize</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">128</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>


<span class="n">_thread_local_state_cache</span> <span class="o">=</span> <span class="n">_ThreadLocalStateCache</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">update_thread_local_jit_state</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
  <span class="n">tls</span> <span class="o">=</span> <span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="c1"># After xla_client._version &gt;= 70, the thread_local object will necessarily</span>
  <span class="c1"># be initialized when accessed. The following line can be removed when the</span>
  <span class="c1"># minimum  jaxlib version is past version 70</span>
  <span class="n">context</span> <span class="o">=</span> <span class="n">tls</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="ow">or</span> <span class="n">_ThreadLocalExtraJitContext</span><span class="p">()</span>
  <span class="n">tmp</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
  <span class="n">tls</span><span class="o">.</span><span class="n">extra_jit_context</span> <span class="o">=</span> <span class="n">_thread_local_state_cache</span><span class="o">.</span><span class="n">canonicalize</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>


<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">(</span>
    <span class="s1">&#39;jax_tracer_error_num_traceback_frames&#39;</span><span class="p">,</span>
    <span class="n">int_env</span><span class="p">(</span><span class="s1">&#39;JAX_TRACER_ERROR_NUM_TRACEBACK_FRAMES&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set the number of stack frames in JAX tracer error messages.&#39;</span>
<span class="p">)</span>

<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">(</span>
    <span class="s1">&#39;jax_pprint_use_color&#39;</span><span class="p">,</span>
    <span class="n">bool_env</span><span class="p">(</span><span class="s1">&#39;JAX_PPRINT_USE_COLOR&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable jaxpr pretty-printing with colorful syntax highlighting.&#39;</span>
<span class="p">)</span>

<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">(</span>
    <span class="s1">&#39;jax_host_callback_inline&#39;</span><span class="p">,</span>
    <span class="n">bool_env</span><span class="p">(</span><span class="s1">&#39;JAX_HOST_CALLBACK_INLINE&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Inline the host_callback, if not in a staged context.&#39;</span>
<span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_integer</span><span class="p">(</span>
    <span class="s1">&#39;jax_host_callback_max_queue_byte_size&#39;</span><span class="p">,</span>
    <span class="n">int_env</span><span class="p">(</span><span class="s1">&#39;JAX_HOST_CALLBACK_MAX_QUEUE_BYTE_SIZE&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;The size in bytes of the buffer used to hold outfeeds from each &#39;</span>
          <span class="s1">&#39;device. When this capacity is reached consuming outfeeds from the &#39;</span>
          <span class="s1">&#39;device is paused, thus potentially pausing the device computation, &#39;</span>
          <span class="s1">&#39;until the Python callback consume more outfeeds.&#39;</span><span class="p">),</span>
    <span class="n">lower_bound</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">(</span>
    <span class="s1">&#39;jax_host_callback_outfeed&#39;</span><span class="p">,</span>
    <span class="n">bool_env</span><span class="p">(</span><span class="s1">&#39;JAX_HOST_CALLBACK_OUTFEED&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Use outfeed implementation for host_callback, even on CPU and GPU. &#39;</span>
        <span class="s1">&#39;If false, use the CustomCall implementation. &#39;</span>
        <span class="s1">&#39;Has no effect on TPU, since only the outfeed mechanism is implemented.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">flags</span><span class="o">.</span><span class="n">DEFINE_bool</span><span class="p">(</span>
    <span class="s1">&#39;jax_host_callback_ad_transforms&#39;</span><span class="p">,</span>
    <span class="n">bool_env</span><span class="p">(</span><span class="s1">&#39;JAX_HOST_CALLBACK_AD_TRANSFORMS&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Enable support for jvp/vjp for the host_callback primitives. Default is &#39;</span>
        <span class="s1">&#39;False, which means that host_callback operates only on primals. &#39;</span>
        <span class="s1">&#39;The flag exists only temporarily, for backward compatibility.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># TODO(b/214340779): remove flag when XLA:CPU is improved.</span>
<span class="n">jax2tf_associative_scan_reductions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax2tf_associative_scan_reductions&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;JAX has two separate lowering rules for the cumulative reduction &#39;</span>
        <span class="s1">&#39;primitives (cumsum, cumprod, cummax, cummin). On CPUs and GPUs it uses &#39;</span>
        <span class="s1">&#39;a lax.associative_scan, while for TPUs it uses the HLO ReduceWindow. &#39;</span>
        <span class="s1">&#39;The latter has a slow implementation on CPUs and GPUs. &#39;</span>
        <span class="s1">&#39;By default, jax2tf uses the TPU lowering. Set this flag to True to &#39;</span>
        <span class="s1">&#39;use the associative scan lowering usage, and only if it makes a difference &#39;</span>
        <span class="s1">&#39;for your application. &#39;</span>
        <span class="s1">&#39;See the jax2tf README.md for more details.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">jax2tf_default_experimental_native_lowering</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax2tf_default_experimental_native_lowering&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="n">bool_env</span><span class="p">(</span><span class="s1">&#39;JAX2TF_DEFAULT_EXPERIMENTAL_NATIVE_LOWERING&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;DO NOT USE, highly experimental. Sets the default value of the &#39;</span>
        <span class="s1">&#39;experimental_native_lowering parameter to jax2tf.convert.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">jax_platforms</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_platforms&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Comma-separated list of platform names specifying which platforms jax &#39;</span>
        <span class="s1">&#39;should initialize. If any of the platforms in this list are not successfully &#39;</span>
        <span class="s1">&#39;initialized, an exception will be raised and the program will be aborted. &#39;</span>
        <span class="s1">&#39;The first platform in the list will be the default platform. &#39;</span>
        <span class="s1">&#39;For example, config.jax_platforms=cpu,tpu means that CPU and TPU backends &#39;</span>
        <span class="s1">&#39;will be initialized, and the CPU backend will be used unless otherwise &#39;</span>
        <span class="s1">&#39;specified. If TPU initialization fails, it will raise an exception. &#39;</span>
        <span class="s1">&#39;By default, jax will try to initialize all available &#39;</span>
        <span class="s1">&#39;platforms and will default to GPU or TPU if available, and fallback to CPU &#39;</span>
        <span class="s1">&#39;otherwise.&#39;</span>
        <span class="p">))</span>

<span class="n">enable_checks</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_checks&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn on invariant checking for JAX internals. Makes things slower.&#39;</span><span class="p">)</span>

<span class="n">check_tracer_leaks</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_check_tracer_leaks&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Turn on checking for leaked tracers as soon as a trace completes. &#39;</span>
          <span class="s1">&#39;Enabling leak checking may have performance impacts: some caching &#39;</span>
          <span class="s1">&#39;is disabled, and other overheads may be added. Additionally, be aware &#39;</span>
          <span class="s1">&#39;that some Python debuggers can cause false positives, so it is recommended &#39;</span>
          <span class="s1">&#39;to disable any debuggers while leak checking is enabled.&#39;</span><span class="p">))</span>
<span class="n">checking_leaks</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">check_tracer_leaks</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">debug_nans</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_debug_nans&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Add nan checks to every operation. When a nan is detected on the &#39;</span>
          <span class="s1">&#39;output of a jit-compiled computation, call into the un-compiled &#39;</span>
          <span class="s1">&#39;version in an attempt to more precisely identify the operation &#39;</span>
          <span class="s1">&#39;which produced the nan.&#39;</span><span class="p">))</span>

<span class="n">debug_infs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_debug_infs&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Add inf checks to every operation. When an inf is detected on the &#39;</span>
          <span class="s1">&#39;output of a jit-compiled computation, call into the un-compiled &#39;</span>
          <span class="s1">&#39;version in an attempt to more precisely identify the operation &#39;</span>
          <span class="s1">&#39;which produced the inf.&#39;</span><span class="p">))</span>

<span class="n">log_compiles</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_log_compiles&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Log a message each time every time `jit` or `pmap` compiles an XLA &#39;</span>
          <span class="s1">&#39;computation. Logging is performed with `absl.logging`. When this &#39;</span>
          <span class="s1">&#39;option is set, the log level is WARNING; otherwise the level is &#39;</span>
          <span class="s1">&#39;DEBUG.&#39;</span><span class="p">))</span>

<span class="n">parallel_functions_output_gda</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_parallel_functions_output_gda&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If True, pjit will output GDAs.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_update_jax_array_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">xla_extension_version</span> <span class="o">&gt;=</span> <span class="mi">92</span><span class="p">:</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">jax_array</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_update_jax_array_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">lib</span><span class="o">.</span><span class="n">xla_extension_version</span> <span class="o">&gt;=</span> <span class="mi">92</span><span class="p">:</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">jax_array</span> <span class="o">=</span> <span class="n">val</span>

<span class="n">jax_array</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_array&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">update_global_hook</span> <span class="o">=</span> <span class="n">_update_jax_array_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span> <span class="o">=</span> <span class="n">_update_jax_array_thread_local</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;If True, new pjit behavior will be enabled and `jax.Array` will be &#39;</span>
          <span class="s1">&#39;used.&#39;</span><span class="p">))</span>


<span class="n">distributed_debug</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_distributed_debug&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enable logging useful for debugging multi-process distributed &#39;</span>
          <span class="s1">&#39;computations. Logging is performed with `absl.logging` at WARNING &#39;</span>
          <span class="s1">&#39;level.&#39;</span><span class="p">))</span>


<span class="n">enable_custom_prng</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_custom_prng&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables an internal upgrade that allows one to define custom &#39;</span>
          <span class="s1">&#39;pseudo-random number generator implementations.&#39;</span><span class="p">))</span>

<span class="n">default_prng_impl</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_prng_impl&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;threefry2x32&#39;</span><span class="p">,</span> <span class="s1">&#39;rbg&#39;</span><span class="p">,</span> <span class="s1">&#39;unsafe_rbg&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;threefry2x32&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the default PRNG implementation, used when one is not &#39;</span>
          <span class="s1">&#39;explicitly provided at seeding time.&#39;</span><span class="p">))</span>

<span class="n">enable_custom_vjp_by_custom_transpose</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_custom_vjp_by_custom_transpose&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables an internal upgrade that implements `jax.custom_vjp` by &#39;</span>
          <span class="s1">&#39;reduction to `jax.custom_jvp` and `jax.custom_transpose`.&#39;</span><span class="p">))</span>

<span class="n">raise_persistent_cache_errors</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_raise_persistent_cache_errors&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;If true, exceptions raised when reading or writing to the &#39;</span>
          <span class="s1">&#39;persistent compilation cache will be allowed through, halting &#39;</span>
          <span class="s1">&#39;program execution if not manually caught. If false, exceptions are &#39;</span>
          <span class="s1">&#39;caught and raised as warnings, allowing program execution to &#39;</span>
          <span class="s1">&#39;continue. Defaults to false so cache bugs or intermittent issues &#39;</span>
          <span class="s1">&#39;are non-fatal.&#39;</span><span class="p">))</span>

<span class="n">hlo_source_file_canonicalization_regex</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_string_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_hlo_source_file_canonicalization_regex&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Used to canonicalize the source_path metadata of HLO instructions &#39;</span>
          <span class="s1">&#39;by removing the given regex. If set, re.sub() is called on each &#39;</span>
          <span class="s1">&#39;source_file with the given regex, and all matches are removed. &#39;</span>
          <span class="s1">&#39;This can be used to avoid spurious cache misses when using the &#39;</span>
          <span class="s1">&#39;persistent compilation cache, which includes HLO metadata in the &#39;</span>
          <span class="s1">&#39;cache key.&#39;</span><span class="p">))</span>

<span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_dtype_bits&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;32&#39;</span><span class="p">,</span> <span class="s1">&#39;64&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;64&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Specify bit width of default dtypes, either 32-bit or 64-bit. &#39;</span>
          <span class="s1">&#39;This is a temporary flag that will be used during the process &#39;</span>
          <span class="s1">&#39;of deprecating the ``jax_enable_x64`` flag.&#39;</span><span class="p">))</span>

<span class="n">numpy_dtype_promotion</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_numpy_dtype_promotion&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;strict&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Specify the rules used for implicit type promotion in operations &#39;</span>
          <span class="s1">&#39;between arrays. Options are &quot;standard&quot; or &quot;strict&quot;; in strict-mode, &#39;</span>
          <span class="s1">&#39;binary operations between arrays of differing strongly-specified &#39;</span>
          <span class="s1">&#39;dtypes will result in an error.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">numpy_dtype_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">numpy_dtype_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_update_x64_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">enable_x64</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_update_x64_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">enable_x64</span> <span class="o">=</span> <span class="n">val</span>

<span class="n">enable_x64</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_enable_x64&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable 64-bit types to be used&#39;</span><span class="p">,</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_x64_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_x64_thread_local</span><span class="p">)</span>

<span class="c1"># TODO(phawkins): remove after fixing users of FLAGS.x64_enabled.</span>
<span class="n">config</span><span class="o">.</span><span class="n">_contextmanager_flags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;jax_enable_x64&#39;</span><span class="p">)</span>

<span class="n">Config</span><span class="o">.</span><span class="n">x64_enabled</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">jax_enable_x64</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span> <span class="nf">_update_default_device_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">default_device</span> <span class="o">=</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_update_default_device_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">default_device</span> <span class="o">=</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">_validate_default_device</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">xla_client</span><span class="o">.</span><span class="n">Device</span><span class="p">):</span>
    <span class="c1"># TODO(skyewm): this is a workaround for non-PJRT Device types. Remove when</span>
    <span class="c1"># all JAX backends use a single C++ device interface.</span>
    <span class="k">if</span> <span class="s1">&#39;Device&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)):</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s1">&#39;Allowing non-`xla_client.Device` default device: </span><span class="si">%s</span><span class="s1">, type: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;jax.default_device must be passed a Device object (e.g. &#39;</span>
                     <span class="sa">f</span><span class="s2">&quot;`jax.devices(&#39;cpu&#39;)[0]`), got: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># TODO(skye): default_device only accepts devices for now. Make it work with</span>
<span class="c1"># platform names as well (e.g. &quot;cpu&quot; to mean the same as jax.devices(&quot;cpu&quot;)[0]).</span>
<span class="n">default_device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_string_or_object_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_device&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
        <span class="s1">&#39;Configure the default device for JAX operations. Set to a Device &#39;</span>
        <span class="s1">&#39;object (e.g. ``jax.devices(&quot;cpu&quot;)[0]``) to use that Device as the &#39;</span>
        <span class="s1">&#39;default device for JAX operations and jit</span><span class="se">\&#39;</span><span class="s1">d function calls (there is &#39;</span>
        <span class="s1">&#39;no effect on multi-device computations, e.g. pmapped function calls). &#39;</span>
        <span class="s1">&#39;Set to None to use the system default device. See &#39;</span>
        <span class="s1">&#39;:ref:`faq-data-placement` for more information on device placement.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_default_device_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_default_device_thread_local</span><span class="p">,</span>
    <span class="n">validate_new_val_hook</span><span class="o">=</span><span class="n">_validate_default_device</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_update_disable_jit_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">global_state</span><span class="p">()</span><span class="o">.</span><span class="n">disable_jit</span> <span class="o">=</span> <span class="n">val</span>

<span class="k">def</span> <span class="nf">_update_disable_jit_thread_local</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="n">lib</span><span class="o">.</span><span class="n">jax_jit</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span><span class="o">.</span><span class="n">disable_jit</span> <span class="o">=</span> <span class="n">val</span>

<span class="n">disable_jit</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_disable_jit&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Disable JIT compilation and just call original Python.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_disable_jit_global</span><span class="p">,</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="n">_update_disable_jit_thread_local</span><span class="p">)</span>


<span class="n">numpy_rank_promotion</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_numpy_rank_promotion&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;raise&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;allow&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Control NumPy-style automatic rank promotion broadcasting &#39;</span>
          <span class="s1">&#39;(&quot;allow&quot;, &quot;warn&quot;, or &quot;raise&quot;).&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">numpy_rank_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">numpy_rank_promotion</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="n">default_matmul_precision</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_default_matmul_precision&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bfloat16&#39;</span><span class="p">,</span> <span class="s1">&#39;tensorfloat32&#39;</span><span class="p">,</span> <span class="s1">&#39;float32&#39;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Control the default matmul and conv precision for 32bit inputs.</span><span class="se">\n\n</span><span class="s1">&#39;</span>

          <span class="s1">&#39;Some platforms, like TPU, offer configurable precision levels for &#39;</span>
          <span class="s1">&#39;matrix multiplication and convolution computations, trading off &#39;</span>
          <span class="s1">&#39;accuracy for speed. The precision can be controlled for each &#39;</span>
          <span class="s1">&#39;operation; for example, see the :func:`jax.lax.conv_general_dilated` &#39;</span>
          <span class="s1">&#39;and :func:`jax.lax.dot` docstrings. But it can be useful to control &#39;</span>
          <span class="s1">&#39;the default behavior obtained when an operation is not given a &#39;</span>
          <span class="s1">&#39;specific precision.</span><span class="se">\n\n</span><span class="s1">&#39;</span>

          <span class="s1">&#39;This option can be used to control the default precision &#39;</span>
          <span class="s1">&#39;level for computations involved in matrix multiplication and &#39;</span>
          <span class="s1">&#39;convolution on 32bit inputs. The levels roughly describe the &#39;</span>
          <span class="s2">&quot;precision at which scalar products are computed. The &#39;bfloat16&#39; &quot;</span>
          <span class="s2">&quot;option is the fastest and least precise; &#39;float32&#39; is similar to &quot;</span>
          <span class="s2">&quot;full float32 precision; &#39;tensorfloat32&#39; is intermediate.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">default_matmul_precision</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">default_matmul_precision</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="n">traceback_filtering</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;jax_traceback_filtering&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;tracebackhide&quot;</span><span class="p">,</span> <span class="s2">&quot;remove_frames&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">],</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Controls how JAX filters internal frames out of tracebacks.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot;Valid values are:</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">off</span><span class="se">\&quot;</span><span class="s2">: disables traceback filtering.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">auto</span><span class="se">\&quot;</span><span class="s2">: use </span><span class="se">\&quot;</span><span class="s2">tracebackhide</span><span class="se">\&quot;</span><span class="s2"> if running under a sufficiently &quot;</span>
         <span class="s2">&quot;new IPython, or </span><span class="se">\&quot;</span><span class="s2">remove_frames</span><span class="se">\&quot;</span><span class="s2"> otherwise.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">tracebackhide</span><span class="se">\&quot;</span><span class="s2">: adds </span><span class="se">\&quot;</span><span class="s2">__tracebackhide__</span><span class="se">\&quot;</span><span class="s2"> annotations to &quot;</span>
         <span class="s2">&quot; hidden stack frames, which some traceback printers support.</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="s2">&quot; * </span><span class="se">\&quot;</span><span class="s2">remove_frames</span><span class="se">\&quot;</span><span class="s2">: removes hidden frames from tracebacks, and adds &quot;</span>
         <span class="s2">&quot; the unfiltered traceback as a __cause__ of the exception.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># This flag is for internal use.</span>
<span class="c1"># TODO(tianjianlu): Removes once we always enable cusparse lowering.</span>
<span class="n">bcoo_cusparse_lowering</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_bcoo_cusparse_lowering&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables lowering BCOO ops to cuSparse.&#39;</span><span class="p">))</span>

<span class="c1"># TODO(mattjj): remove this flag when we ensure we only succeed at trace-staging</span>
<span class="c1"># if the intended backend can handle lowering the result</span>
<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_dynamic_shapes&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;JAX_DYNAMIC_SHAPES&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables experimental features for staging out computations with &#39;</span>
          <span class="s1">&#39;dynamic shapes.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">_update_global_jit_state</span><span class="p">(</span><span class="n">dynamic_shapes</span><span class="o">=</span><span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> \
      <span class="n">update_thread_local_jit_state</span><span class="p">(</span><span class="n">dynamic_shapes</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>

<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_experimental_name_stack&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable using the context manager-based name stack.&#39;</span><span class="p">)</span>

<span class="c1"># This flag is temporary during rollout of the remat barrier.</span>
<span class="c1"># TODO(parkers): Remove if there are no complaints.</span>
<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_remat_opt_barrier&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enables using optimization-barrier op for lowering remat.&#39;</span><span class="p">))</span>

<span class="c1"># TODO(b/205307544): Remove flag once coordination service has rolled out.</span>
<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_coordination_service&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">xla_extension_version</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span>
         <span class="s1">&#39;Use coordination service (experimental) instead of the default PjRT &#39;</span>
         <span class="s1">&#39;distributed runtime.&#39;</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_experimental_subjaxpr_lowering_cache&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable using a cache for lowering subjaxprs.&#39;</span><span class="p">)</span>

<span class="c1"># TODO(sharadmv,mattjj): set default to True, then remove</span>
<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_eager_pmap&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">upgrade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable eager-mode pmap when jax_disable_jit is activated.&#39;</span><span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">define_bool_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_experimental_unsafe_xla_runtime_errors&#39;</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Enable XLA runtime errors for jax.experimental.checkify.checks &#39;</span>
          <span class="s1">&#39;on CPU and GPU. These errors are async, might get lost and are not &#39;</span>
          <span class="s1">&#39;very readable. But, they crash the computation and enable you &#39;</span>
          <span class="s1">&#39;to write jittable checks without needing to checkify. Does not &#39;</span>
          <span class="s1">&#39;work under pmap/pjit.&#39;</span><span class="p">)</span>
<span class="p">)</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">explicit_device_put_scope</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
  <span class="sd">&quot;&quot;&quot;Indicates that the current context is an explicit device_put*() call.&quot;&quot;&quot;</span>
  <span class="n">state</span> <span class="o">=</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_put</span>
  <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_put</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">yield</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_put</span> <span class="o">=</span> <span class="n">prev</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">explicit_device_get_scope</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
  <span class="sd">&quot;&quot;&quot;Indicates that the current context is an explicit device_get() call.&quot;&quot;&quot;</span>
  <span class="n">state</span> <span class="o">=</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">()</span>
  <span class="n">prev</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_get</span>
  <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_get</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">yield</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">state</span><span class="o">.</span><span class="n">explicit_device_get</span> <span class="o">=</span> <span class="n">prev</span>

<span class="k">def</span> <span class="nf">_update_transfer_guard</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Applies the transfer guard level within transfer_guard_lib.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;allow&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">ALLOW</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">LOG</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;disallow&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">DISALLOW</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">LOG_EXPLICIT</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;disallow_explicit&#39;</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">TransferGuardLevel</span><span class="o">.</span><span class="n">DISALLOW_EXPLICIT</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Invalid transfer guard level </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">transfer_guard_host_to_device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard_host_to_device&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for host-to-device transfers. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">global_state</span><span class="p">(),</span> <span class="s1">&#39;host_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">(),</span> <span class="s1">&#39;host_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="n">transfer_guard_device_to_device</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard_device_to_device&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for device-to-device transfers. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">global_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_device&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="n">transfer_guard_device_to_host</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard_device_to_host&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for device-to-host transfers. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">global_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_host&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
    <span class="n">update_thread_local_hook</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">_update_transfer_guard</span><span class="p">(</span>
        <span class="n">transfer_guard_lib</span><span class="o">.</span><span class="n">thread_local_state</span><span class="p">(),</span> <span class="s1">&#39;device_to_host&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_update_all_transfer_guard_global</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jax_transfer_guard_host_to_device&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jax_transfer_guard_device_to_device&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jax_transfer_guard_device_to_host&#39;</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

<span class="n">_transfer_guard</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">define_enum_state</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jax_transfer_guard&#39;</span><span class="p">,</span>
    <span class="n">enum_values</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;allow&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow&#39;</span><span class="p">,</span> <span class="s1">&#39;log_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;disallow_explicit&#39;</span>
    <span class="p">],</span>
    <span class="c1"># The default is applied by transfer_guard_lib. Use None here to avoid</span>
    <span class="c1"># accidentally overriding --jax_transfer_guard_*.</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Select the transfer guard level for all transfers. This option is &#39;</span>
          <span class="s1">&#39;set-only; the transfer guard level for a specific direction should &#39;</span>
          <span class="s1">&#39;be read using the per-transfer direction option. &#39;</span>
          <span class="s1">&#39;Default is &quot;allow&quot;.&#39;</span><span class="p">),</span>
    <span class="n">update_global_hook</span><span class="o">=</span><span class="n">_update_all_transfer_guard_global</span><span class="p">)</span>

<div class="viewcode-block" id="transfer_guard"><a class="viewcode-back" href="../../../_autosummary/jax.transfer_guard.html#jax.transfer_guard">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">transfer_guard</span><span class="p">(</span><span class="n">new_val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
  <span class="sd">&quot;&quot;&quot;A contextmanager to control the transfer guard level for all transfers.</span>

<span class="sd">  For more information, see</span>
<span class="sd">  https://jax.readthedocs.io/en/latest/transfer_guard.html</span>

<span class="sd">  Args:</span>
<span class="sd">    new_val: The new thread-local transfer guard level for all transfers.</span>

<span class="sd">  Yields:</span>
<span class="sd">    None.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">transfer_guard_host_to_device</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">transfer_guard_device_to_device</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">transfer_guard_device_to_host</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">_transfer_guard</span><span class="p">(</span><span class="n">new_val</span><span class="p">))</span>
    <span class="k">yield</span></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      &copy; Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>