
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Custom derivative rules for JAX-transformable Python functions — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="How_JAX_primitives_work.html" rel="next" title="How JAX primitives work"/>
<link href="neural_network_with_tfds_data.html" rel="prev" title="Training a Simple Neural Network, with tensorflow/datasets Data Loading"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1 current active">
<a class="current reference internal" href="#">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/notebooks/Custom_derivative_rules_for_Python_code.ipynb.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#tl-dr">
   TL;DR
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#custom-jvps-with-jax-custom-jvp">
     Custom JVPs with
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_jvp
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#custom-vjps-with-jax-custom-vjp">
     Custom VJPs with
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_vjp
      </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#example-problems">
   Example problems
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#numerical-stability">
     Numerical stability
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#enforcing-a-differentiation-convention">
     Enforcing a differentiation convention
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#gradient-clipping">
     Gradient clipping
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python-debugging">
     Python debugging
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#implicit-function-differentiation-of-iterative-implementations">
     Implicit function differentiation of iterative implementations
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#basic-usage-of-jax-custom-jvp-and-jax-custom-vjp-apis">
   Basic usage of
   <code class="docutils literal notranslate">
<span class="pre">
     jax.custom_jvp
    </span>
</code>
   and
   <code class="docutils literal notranslate">
<span class="pre">
     jax.custom_vjp
    </span>
</code>
   APIs
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#use-jax-custom-jvp-to-define-forward-mode-and-indirectly-reverse-mode-rules">
     Use
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_jvp
      </span>
</code>
     to define forward-mode (and, indirectly, reverse-mode) rules
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#use-jax-custom-vjp-to-define-custom-reverse-mode-only-rules">
     Use
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_vjp
      </span>
</code>
     to define custom reverse-mode-only rules
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#more-features-and-details">
   More features and details
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#working-with-list-tuple-dict-containers-and-other-pytrees">
     Working with
     <code class="docutils literal notranslate">
<span class="pre">
       list
      </span>
</code>
     /
     <code class="docutils literal notranslate">
<span class="pre">
       tuple
      </span>
</code>
     /
     <code class="docutils literal notranslate">
<span class="pre">
       dict
      </span>
</code>
     containers (and other pytrees)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#handling-non-differentiable-arguments">
     Handling  non-differentiable arguments
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-custom-jvp-with-nondiff-argnums">
<code class="docutils literal notranslate">
<span class="pre">
         jax.custom_jvp
        </span>
</code>
       with
       <code class="docutils literal notranslate">
<span class="pre">
         nondiff_argnums
        </span>
</code>
</a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-custom-vjp-with-nondiff-argnums">
<code class="docutils literal notranslate">
<span class="pre">
         jax.custom_vjp
        </span>
</code>
       with
       <code class="docutils literal notranslate">
<span class="pre">
         nondiff_argnums
        </span>
</code>
</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Custom derivative rules for JAX-transformable Python functions</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#tl-dr">
   TL;DR
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#custom-jvps-with-jax-custom-jvp">
     Custom JVPs with
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_jvp
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#custom-vjps-with-jax-custom-vjp">
     Custom VJPs with
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_vjp
      </span>
</code>
</a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#example-problems">
   Example problems
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#numerical-stability">
     Numerical stability
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#enforcing-a-differentiation-convention">
     Enforcing a differentiation convention
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#gradient-clipping">
     Gradient clipping
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python-debugging">
     Python debugging
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#implicit-function-differentiation-of-iterative-implementations">
     Implicit function differentiation of iterative implementations
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#basic-usage-of-jax-custom-jvp-and-jax-custom-vjp-apis">
   Basic usage of
   <code class="docutils literal notranslate">
<span class="pre">
     jax.custom_jvp
    </span>
</code>
   and
   <code class="docutils literal notranslate">
<span class="pre">
     jax.custom_vjp
    </span>
</code>
   APIs
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#use-jax-custom-jvp-to-define-forward-mode-and-indirectly-reverse-mode-rules">
     Use
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_jvp
      </span>
</code>
     to define forward-mode (and, indirectly, reverse-mode) rules
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#use-jax-custom-vjp-to-define-custom-reverse-mode-only-rules">
     Use
     <code class="docutils literal notranslate">
<span class="pre">
       jax.custom_vjp
      </span>
</code>
     to define custom reverse-mode-only rules
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#more-features-and-details">
   More features and details
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#working-with-list-tuple-dict-containers-and-other-pytrees">
     Working with
     <code class="docutils literal notranslate">
<span class="pre">
       list
      </span>
</code>
     /
     <code class="docutils literal notranslate">
<span class="pre">
       tuple
      </span>
</code>
     /
     <code class="docutils literal notranslate">
<span class="pre">
       dict
      </span>
</code>
     containers (and other pytrees)
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#handling-non-differentiable-arguments">
     Handling  non-differentiable arguments
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-custom-jvp-with-nondiff-argnums">
<code class="docutils literal notranslate">
<span class="pre">
         jax.custom_jvp
        </span>
</code>
       with
       <code class="docutils literal notranslate">
<span class="pre">
         nondiff_argnums
        </span>
</code>
</a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-custom-vjp-with-nondiff-argnums">
<code class="docutils literal notranslate">
<span class="pre">
         jax.custom_vjp
        </span>
</code>
       with
       <code class="docutils literal notranslate">
<span class="pre">
         nondiff_argnums
        </span>
</code>
</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom derivative rules for JAX-transformable Python functions"></a><section class="tex2jax_ignore mathjax_ignore" id="custom-derivative-rules-for-jax-transformable-python-functions">
<h1>Custom derivative rules for JAX-transformable Python functions<a class="headerlink" href="#custom-derivative-rules-for-jax-transformable-python-functions" title="Permalink to this headline">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/google/jax/blob/main/docs/notebooks/Custom_derivative_rules_for_Python_code.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p><em>mattjj@ Mar 19 2020, last updated Oct 14 2020</em></p>
<p>There are two ways to define differentiation rules in JAX:</p>
<ol class="arabic simple">
<li><p>using <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> to define custom differentiation rules for Python functions that are already JAX-transformable; and</p></li>
<li><p>defining new <code class="docutils literal notranslate"><span class="pre">core.Primitive</span></code> instances along with all their transformation rules, for example to call into functions from other systems like solvers, simulators, or general numerical computing systems.</p></li>
</ol>
<p>This notebook is about #1. To read instead about #2, see the <a class="reference external" href="https://jax.readthedocs.io/en/latest/notebooks/How_JAX_primitives_work.html">notebook on adding primitives</a>.</p>
<p>For an introduction to JAX’s automatic differentiation API, see <a class="reference external" href="https://jax.readthedocs.io/en/latest/notebooks/autodiff_cookbook.html">The Autodiff Cookbook</a>. This notebook assumes some familiarity with <a class="reference external" href="https://jax.readthedocs.io/en/latest/jax.html#jax.jvp">jax.jvp</a> and <a class="reference external" href="https://jax.readthedocs.io/en/latest/jax.html#jax.grad">jax.grad</a>, and the mathematical meaning of JVPs and VJPs.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/TL;DR"></a><section id="tl-dr">
<h2>TL;DR<a class="headerlink" href="#tl-dr" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom JVPs with jax.custom_jvp"></a><section id="custom-jvps-with-jax-custom-jvp">
<h3>Custom JVPs with <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code><a class="headerlink" href="#custom-jvps-with-jax-custom-jvp" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_jvp</span>

<span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="n">y_dot</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="n">primal_out</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">tangent_out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_dot</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_dot</span>
  <span class="k">return</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">tangent_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jvp</span><span class="p">,</span> <span class="n">grad</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
<span class="n">y</span><span class="p">,</span> <span class="n">y_dot</span> <span class="o">=</span> <span class="n">jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_dot</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.7278922
2.7278922
-1.2484405
-1.2484405
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Equivalent alternative using the defjvps convenience wrapper</span>

<span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x_dot</span><span class="p">,</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_dot</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
          <span class="k">lambda</span> <span class="n">y_dot</span><span class="p">,</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_dot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
<span class="n">y</span><span class="p">,</span> <span class="n">y_dot</span> <span class="o">=</span> <span class="n">jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_dot</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.7278922
2.7278922
-1.2484405
-1.2484405
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom VJPs with jax.custom_vjp"></a><section id="custom-vjps-with-jax-custom-vjp">
<h3>Custom VJPs with <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code><a class="headerlink" href="#custom-vjps-with-jax-custom-vjp" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_vjp</span>

<span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">f_fwd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="c1"># Returns primal output and residuals to be used in backward pass by f_bwd.</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="n">cos_x</span><span class="p">,</span> <span class="n">sin_x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">res</span> <span class="c1"># Gets residuals computed in f_fwd</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">cos_x</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">sin_x</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">f_fwd</span><span class="p">,</span> <span class="n">f_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.2484405
</pre></div>
</div>
</div>
</div>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Example problems"></a><section id="example-problems">
<h2>Example problems<a class="headerlink" href="#example-problems" title="Permalink to this headline">#</a></h2>
<p>To get an idea of what problems <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> are meant to solve, let’s go over a few examples. A more thorough introduction to the <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> APIs is in the next section.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Numerical stability"></a><section id="numerical-stability">
<h3>Numerical stability<a class="headerlink" href="#numerical-stability" title="Permalink to this headline">#</a></h3>
<p>One application of <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> is to improve the numerical stability of differentiation.</p>
<p>Say we want to write a function called <code class="docutils literal notranslate"><span class="pre">log1pexp</span></code>, which computes <span class="math notranslate nohighlight">\(x \mapsto \log ( 1 + e^x )\)</span>. We can write that using <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="k">def</span> <span class="nf">log1pexp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">log1pexp</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(3.0485873, dtype=float32, weak_type=True)
</pre></div>
</div>
</div>
</div>
<p>Since it’s written in terms of <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code>, it’s JAX-transformable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">vmap</span>

<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">))(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)))(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">3.</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.0485873
0.95257413
[0.5       0.7310586 0.8807971]
</pre></div>
</div>
</div>
</div>
<p>But there’s a numerical stability problem lurking here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)(</span><span class="mf">100.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nan
</pre></div>
</div>
</div>
</div>
<p>That doesn’t seem right! After all, the derivative of <span class="math notranslate nohighlight">\(x \mapsto \log (1 + e^x)\)</span> is <span class="math notranslate nohighlight">\(x \mapsto \frac{e^x}{1 + e^x}\)</span>, and so for large values of <span class="math notranslate nohighlight">\(x\)</span> we’d expect the value to be about 1.</p>
<p>We can get a bit more insight into what’s going on by looking at the jaxpr for the gradient computation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">make_jaxpr</span>

<span class="n">make_jaxpr</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">))(</span><span class="mf">100.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ lambda ; a:f32[]. let
    b:f32[] = exp a
    c:f32[] = add 1.0 b
    _:f32[] = log c
    d:f32[] = div 1.0 c
    e:f32[] = mul d b
  in (e,) }
</pre></div>
</div>
</div>
</div>
<p>Stepping through how the jaxpr would be evaluated, we can see that the last line would involve multiplying values that floating point math will round to 0 and <span class="math notranslate nohighlight">\(\infty\)</span>, respectively, which is never a good idea. That is, we’re effectively evaluating <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">(1</span> <span class="pre">/</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">jnp.exp(x)))</span> <span class="pre">*</span> <span class="pre">jnp.exp(x)</span></code> for large <code class="docutils literal notranslate"><span class="pre">x</span></code>, which effectively turns into <code class="docutils literal notranslate"><span class="pre">0.</span> <span class="pre">*</span> <span class="pre">jnp.inf</span></code>.</p>
<p>Instead of generating such large and small values, hoping for a cancellation that floats can’t always provide, we’d rather just express the derivative function as a more numerically stable program. In particular, we can write a program that more closely evaluates the equal mathematical expression <span class="math notranslate nohighlight">\(1 - \frac{1}{1 + e^x}\)</span>, with no cancellation in sight.</p>
<p>This problem is interesting because even though our definition of <code class="docutils literal notranslate"><span class="pre">log1pexp</span></code> could already be JAX-differentiated (and transformed with <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, …), we’re not happy with the result of applying standard autodiff rules to the primitives comprising <code class="docutils literal notranslate"><span class="pre">log1pexp</span></code> and composing the result. Instead, we’d like to specify how the whole function <code class="docutils literal notranslate"><span class="pre">log1pexp</span></code> should be differentiated, as a unit, and thus arrange those exponentials better.</p>
<p>This is one application of custom derivative rules for Python functions that are already JAX transformable: specifying how a composite function should be differentiated, while still using its original Python definition for other transformations (like <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, …).</p>
<p>Here’s a solution using <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_jvp</span>

<span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">log1pexp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="nd">@log1pexp</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">log1pexp_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">log1pexp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">ans_dot</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">*</span> <span class="n">x_dot</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="n">ans_dot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)(</span><span class="mf">100.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">))(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)))(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">3.</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.0485873
0.95257413
[0.5       0.7310586 0.8807971]
</pre></div>
</div>
</div>
</div>
<p>Here’s a <code class="docutils literal notranslate"><span class="pre">defjvps</span></code> convenience wrapper to express the same thing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">log1pexp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">log1pexp</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)(</span><span class="mf">100.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">))(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">log1pexp</span><span class="p">)))(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">3.</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
3.0485873
0.95257413
[0.5       0.7310586 0.8807971]
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Enforcing a differentiation convention"></a><section id="enforcing-a-differentiation-convention">
<h3>Enforcing a differentiation convention<a class="headerlink" href="#enforcing-a-differentiation-convention" title="Permalink to this headline">#</a></h3>
<p>A related application is to enforce a differentiation convention, perhaps at a boundary.</p>
<p>Consider the function <span class="math notranslate nohighlight">\(f : \mathbb{R}_+ \mapsto \mathbb{R}_+\)</span> with <span class="math notranslate nohighlight">\(f(x) = \frac{x}{1 + \sqrt{x}}\)</span>, where we take <span class="math notranslate nohighlight">\(\mathbb{R}_+ = [0, \infty)\)</span>. We might implement <span class="math notranslate nohighlight">\(f\)</span> as a program like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>As a mathematical function on <span class="math notranslate nohighlight">\(\mathbb{R}\)</span> (the full real line), <span class="math notranslate nohighlight">\(f\)</span> is not differentiable at zero (because the limit defining the derivative doesn’t exist from the left). Correspondingly, autodiff produces a <code class="docutils literal notranslate"><span class="pre">nan</span></code> value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">0.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nan
</pre></div>
</div>
</div>
</div>
<p>But mathematically if we think of <span class="math notranslate nohighlight">\(f\)</span> as a function on <span class="math notranslate nohighlight">\(\mathbb{R}_+\)</span> then it is differentiable at 0 [Rudin’s Principles of Mathematical Analysis Definition 5.1, or Tao’s Analysis I 3rd ed. Definition 10.1.1 and Example 10.1.6]. Alternatively, we might say as a convention we want to consider the directional derivative from the right. So there is a sensible value for the Python function <code class="docutils literal notranslate"><span class="pre">grad(f)</span></code> to return at <code class="docutils literal notranslate"><span class="pre">0.0</span></code>, namely <code class="docutils literal notranslate"><span class="pre">1.0</span></code>. By default, JAX’s machinery for differentiation assumes all functions are defined over <span class="math notranslate nohighlight">\(\mathbb{R}\)</span> and thus doesn’t produce <code class="docutils literal notranslate"><span class="pre">1.0</span></code> here.</p>
<p>We can use a custom JVP rule! In particular, we can define the JVP rule in terms of the derivative function <span class="math notranslate nohighlight">\(x \mapsto \frac{\sqrt{x} + 2}{2(\sqrt{x} + 1)^2}\)</span> on <span class="math notranslate nohighlight">\(\mathbb{R}_+\)</span>,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">ans_dot</span> <span class="o">=</span> <span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">x_dot</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="n">ans_dot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">0.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
<p>Here’s the convenience wrapper version:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">0.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Gradient clipping"></a><section id="gradient-clipping">
<h3>Gradient clipping<a class="headerlink" href="#gradient-clipping" title="Permalink to this headline">#</a></h3>
<p>While in some cases we want to express a mathematical differentiation computation, in other cases we may even want to take a step away from mathematics to adjust the computation autodiff performs. One canonical example is reverse-mode gradient clipping.</p>
<p>For gradient clipping, we can use <code class="docutils literal notranslate"><span class="pre">jnp.clip</span></code> together with a <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> reverse-mode-only rule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_vjp</span>

<span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">clip_gradient</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span>  <span class="c1"># identity function</span>

<span class="k">def</span> <span class="nf">clip_gradient_fwd</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>  <span class="c1"># save bounds as residuals</span>

<span class="k">def</span> <span class="nf">clip_gradient_bwd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">res</span>
  <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">))</span>  <span class="c1"># use None to indicate zero cotangents for lo and hi</span>

<span class="n">clip_gradient</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">clip_gradient_fwd</span><span class="p">,</span> <span class="n">clip_gradient_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vmap</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">))(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x15e9bd480&gt;]
</pre></div>
</div>
<img alt="../_images/96d5d90836db10201d9cfaa7d20b41229182d0163e4902696220287cf36bb527.png" src="../_images/96d5d90836db10201d9cfaa7d20b41229182d0163e4902696220287cf36bb527.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clip_sin</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">clip_gradient</span><span class="p">(</span><span class="o">-</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clip_sin</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">clip_sin</span><span class="p">))(</span><span class="n">t</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x15ec36ec0&gt;]
</pre></div>
</div>
<img alt="../_images/73d846f04566ac149bfa06076d801f2d62de99d87d8cdcc15f2f4251ed170a6f.png" src="../_images/73d846f04566ac149bfa06076d801f2d62de99d87d8cdcc15f2f4251ed170a6f.png"/>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Python debugging"></a><section id="python-debugging">
<h3>Python debugging<a class="headerlink" href="#python-debugging" title="Permalink to this headline">#</a></h3>
<p>Another application that is motivated by development workflow rather than numerics is to set a <code class="docutils literal notranslate"><span class="pre">pdb</span></code> debugger trace in the backward pass of reverse-mode autodiff.</p>
<p>When trying to track down the source of a <code class="docutils literal notranslate"><span class="pre">nan</span></code> runtime error, or just examine carefully the cotangent (gradient) values being propagated, it can be useful to insert a debugger at a point in the backward pass that corresponds to a specific point in the primal computation. You can do that with <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code>.</p>
<p>We’ll defer an example until the next section.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Implicit function differentiation of iterative implementations"></a><section id="implicit-function-differentiation-of-iterative-implementations">
<h3>Implicit function differentiation of iterative implementations<a class="headerlink" href="#implicit-function-differentiation-of-iterative-implementations" title="Permalink to this headline">#</a></h3>
<p>This example gets pretty deep in the mathematical weeds!</p>
<p>Another application for <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> is reverse-mode differentiation of functions that are JAX-transformable (by <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, …) but not efficiently JAX-differentiable for some reason, perhaps because they involve <code class="docutils literal notranslate"><span class="pre">lax.while_loop</span></code>. (It’s not possible to produce an XLA HLO program that efficiently computes the reverse-mode derivative of an XLA HLO While loop because that would require a program with unbounded memory use, which isn’t possible to express in XLA HLO, at least without side-effecting interactions through infeed/outfeed.)</p>
<p>For example, consider this <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code> routine which computes a fixed point by iteratively applying a function in a <code class="docutils literal notranslate"><span class="pre">while_loop</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.lax</span> <span class="kn">import</span> <span class="n">while_loop</span>

<span class="k">def</span> <span class="nf">fixed_point</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x_guess</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">cond_fun</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
    <span class="n">x_prev</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">carry</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_prev</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span>

  <span class="k">def</span> <span class="nf">body_fun</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">carry</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

  <span class="n">_</span><span class="p">,</span> <span class="n">x_star</span> <span class="o">=</span> <span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="p">(</span><span class="n">x_guess</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x_guess</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">x_star</span>
</pre></div>
</div>
</div>
</div>
<p>This is an iterative procedure for numerically solving the equation <span class="math notranslate nohighlight">\(x = f(a, x)\)</span> for <span class="math notranslate nohighlight">\(x\)</span>, by iterating <span class="math notranslate nohighlight">\(x_{t+1} = f(a, x_t)\)</span> until <span class="math notranslate nohighlight">\(x_{t+1}\)</span> is sufficiently close to <span class="math notranslate nohighlight">\(x_t\)</span>. The result <span class="math notranslate nohighlight">\(x^*\)</span> depends on the parameters <span class="math notranslate nohighlight">\(a\)</span>, and so we can think of there being a function <span class="math notranslate nohighlight">\(a \mapsto x^*(a)\)</span> that is implicitly defined by equation <span class="math notranslate nohighlight">\(x = f(a, x)\)</span>.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code> to run iterative procedures to convergence, for example running Newton’s method to calculate square roots while only executing adds, multiplies, and divides:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">newton_sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">update</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">a</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">fixed_point</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">newton_sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4142135
</pre></div>
</div>
</div>
</div>
<p>We can <code class="docutils literal notranslate"><span class="pre">vmap</span></code> or <code class="docutils literal notranslate"><span class="pre">jit</span></code> the function as well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">newton_sqrt</span><span class="p">))(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.        1.4142135 1.7320509 2.       ]
</pre></div>
</div>
</div>
</div>
<p>We can’t apply reverse-mode automatic differentiation because of the <code class="docutils literal notranslate"><span class="pre">while_loop</span></code>, but it turns out we wouldn’t want to anyway: instead of differentiating through the implementation of <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code> and all its iterations, we can exploit the mathematical structure to do something that is much more memory-efficient (and FLOP-efficient in this case, too!). We can instead use the implicit function theorem [Prop A.25 of Bertsekas’s Nonlinear Programming, 2nd ed.], which guarantees (under some conditions) the existence of the mathematical objects we’re about to use. In essence, we linearize at the solution and solve those linear equations iteratively to compute the derivatives we want.</p>
<p>Consider again the equation <span class="math notranslate nohighlight">\(x = f(a, x)\)</span> and the function <span class="math notranslate nohighlight">\(x^*\)</span>. We want to evaluate vector-Jacobian products like <span class="math notranslate nohighlight">\(v^\mathsf{T} \mapsto v^\mathsf{T} \partial x^*(a_0)\)</span>.</p>
<p>At least in an open neighborhood around the point <span class="math notranslate nohighlight">\(a_0\)</span> at which we want to differentiate, let’s assume that the equation <span class="math notranslate nohighlight">\(x^*(a) = f(a, x^*(a))\)</span> holds for all <span class="math notranslate nohighlight">\(a\)</span>. Since the two sides are equal as functions of <span class="math notranslate nohighlight">\(a\)</span>, their derivatives must be equal as well, so let’s differentiate both sides:</p>
<p><span class="math notranslate nohighlight">\(\qquad \partial x^*(a) = \partial_0 f(a, x^*(a)) + \partial_1 f(a, x^*(a))  \partial x^*(a)\)</span>.</p>
<p>Setting <span class="math notranslate nohighlight">\(A = \partial_1 f(a_0, x^*(a_0))\)</span> and <span class="math notranslate nohighlight">\(B = \partial_0 f(a_0, x^*(a_0))\)</span>, we can write the quantity we’re after more simply as</p>
<p><span class="math notranslate nohighlight">\(\qquad \partial x^*(a_0) = B + A \partial x^*(a_0)\)</span>,</p>
<p>or, by rearranging,</p>
<p><span class="math notranslate nohighlight">\(\qquad \partial x^*(a_0) = (I - A)^{-1} B\)</span>.</p>
<p>That means we can evaluate vector-Jacobian products like</p>
<p><span class="math notranslate nohighlight">\(\qquad v^\mathsf{T} \partial x^*(a_0) = v^\mathsf{T} (I - A)^{-1} B = w^\mathsf{T} B\)</span>,</p>
<p>where <span class="math notranslate nohighlight">\(w^\mathsf{T} = v^\mathsf{T} (I - A)^{-1}\)</span>, or equivalently <span class="math notranslate nohighlight">\(w^\mathsf{T} = v^\mathsf{T} + w^\mathsf{T} A\)</span>, or equivalently <span class="math notranslate nohighlight">\(w^\mathsf{T}\)</span> is the fixed point of the map <span class="math notranslate nohighlight">\(u^\mathsf{T} \mapsto v^\mathsf{T} + u^\mathsf{T} A\)</span>. That last characterization gives us a way to write the VJP for <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code> in terms of a call to <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code>! Moreover, after expanding <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span> back out, we can see we need only to evaluate VJPs of <span class="math notranslate nohighlight">\(f\)</span> at <span class="math notranslate nohighlight">\((a_0, x^*(a_0))\)</span>.</p>
<p>Here’s the upshot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vjp</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">custom_vjp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">fixed_point</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x_guess</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">cond_fun</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
    <span class="n">x_prev</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">carry</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_prev</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-6</span>

  <span class="k">def</span> <span class="nf">body_fun</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">carry</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

  <span class="n">_</span><span class="p">,</span> <span class="n">x_star</span> <span class="o">=</span> <span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="p">(</span><span class="n">x_guess</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x_guess</span><span class="p">)))</span>
  <span class="k">return</span> <span class="n">x_star</span>

<span class="k">def</span> <span class="nf">fixed_point_fwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x_init</span><span class="p">):</span>
  <span class="n">x_star</span> <span class="o">=</span> <span class="n">fixed_point</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x_init</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x_star</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x_star</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fixed_point_rev</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">x_star_bar</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">x_star</span> <span class="o">=</span> <span class="n">res</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">vjp_a</span> <span class="o">=</span> <span class="n">vjp</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x_star</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">a_bar</span><span class="p">,</span> <span class="o">=</span> <span class="n">vjp_a</span><span class="p">(</span><span class="n">fixed_point</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">rev_iter</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x_star</span><span class="p">,</span> <span class="n">x_star_bar</span><span class="p">),</span>
                             <span class="n">x_star_bar</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">a_bar</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_star</span><span class="p">)</span>
  
<span class="k">def</span> <span class="nf">rev_iter</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">packed</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
  <span class="n">a</span><span class="p">,</span> <span class="n">x_star</span><span class="p">,</span> <span class="n">x_star_bar</span> <span class="o">=</span> <span class="n">packed</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">vjp_x</span> <span class="o">=</span> <span class="n">vjp</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">x_star</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x_star_bar</span> <span class="o">+</span> <span class="n">vjp_x</span><span class="p">(</span><span class="n">u</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">fixed_point</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">fixed_point_fwd</span><span class="p">,</span> <span class="n">fixed_point_rev</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">newton_sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.4142135
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">newton_sqrt</span><span class="p">)(</span><span class="mf">2.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">newton_sqrt</span><span class="p">))(</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.35355338
-0.088388346
</pre></div>
</div>
</div>
</div>
<p>We can check our answers by differentiating <code class="docutils literal notranslate"><span class="pre">jnp.sqrt</span></code>, which uses a totally different implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)(</span><span class="mf">2.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">))(</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.35355338
-0.08838835
</pre></div>
</div>
</div>
</div>
<p>A limitation to this approach is that the argument <code class="docutils literal notranslate"><span class="pre">f</span></code> can’t close over any values involved in differentiation. That is, you might notice that we kept the parameter <code class="docutils literal notranslate"><span class="pre">a</span></code> explicit in the argument list of <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code>. For this use case, consider using the low-level primitive <code class="docutils literal notranslate"><span class="pre">lax.custom_root</span></code>, which allows for deriviatives in closed-over variables with custom root-finding functions.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Basic usage of jax.custom_jvp and jax.custom_vjp APIs"></a><section id="basic-usage-of-jax-custom-jvp-and-jax-custom-vjp-apis">
<h2>Basic usage of <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> APIs<a class="headerlink" href="#basic-usage-of-jax-custom-jvp-and-jax-custom-vjp-apis" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Use jax.custom_jvp to define forward-mode (and, indirectly, reverse-mode) rules"></a><section id="use-jax-custom-jvp-to-define-forward-mode-and-indirectly-reverse-mode-rules">
<h3>Use <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> to define forward-mode (and, indirectly, reverse-mode) rules<a class="headerlink" href="#use-jax-custom-jvp-to-define-forward-mode-and-indirectly-reverse-mode-rules" title="Permalink to this headline">#</a></h3>
<p>Here’s a canonical basic example of using <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>, where the comments use
<a class="reference external" href="https://wiki.haskell.org/Type_signature">Haskell-like type signatures</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_jvp</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="c1"># f :: a -&gt; b</span>
<span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># f_jvp :: (a, T a) -&gt; (b, T b)</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">t</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvp</span><span class="p">(</span><span class="n">f_jvp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.f_jvp(primals, tangents)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jvp</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span>

<span class="n">y</span><span class="p">,</span> <span class="n">y_dot</span> <span class="o">=</span> <span class="n">jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.</span><span class="p">,),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_dot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.14112
0.14112
-0.9899925
</pre></div>
</div>
</div>
</div>
<p>In words, we start with a primal function <code class="docutils literal notranslate"><span class="pre">f</span></code> that takes inputs of type <code class="docutils literal notranslate"><span class="pre">a</span></code> and produces outputs of type <code class="docutils literal notranslate"><span class="pre">b</span></code>. We associate with it a JVP rule function <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code> that takes a pair of inputs representing the primal inputs of type <code class="docutils literal notranslate"><span class="pre">a</span></code> and the corresponding tangent inputs of type <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">a</span></code>, and produces a pair of outputs representing the primal outputs of type <code class="docutils literal notranslate"><span class="pre">b</span></code> and tangent outputs of type <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">b</span></code>. The tangent outputs should be a linear function of the tangent inputs.</p>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">f.defjvp</span></code> as a decorator, as in</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="o">...</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>Even though we defined only a JVP rule and no VJP rule, we can use both forward- and reverse-mode differentiation on <code class="docutils literal notranslate"><span class="pre">f</span></code>. JAX will automatically transpose the linear computation on tangent values from our custom JVP rule, computing the VJP as efficiently as if we had written the rule by hand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">grad</span>

<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.9899925
-0.14112
</pre></div>
</div>
</div>
</div>
<p>For automatic transposition to work, the JVP rule’s output tangents must be linear as a function of the input tangents. Otherwise a transposition error is raised.</p>
<p>Multiple arguments work like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="n">y_dot</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="n">primal_out</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
  <span class="n">tangent_out</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x_dot</span> <span class="o">+</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_dot</span>
  <span class="k">return</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">tangent_out</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">defjvps</span></code> convenience wrapper lets us define a JVP for each argument separately, and the results are computed separately then summed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">ans</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-0.9899925
</pre></div>
</div>
</div>
</div>
<p>Here’s a <code class="docutils literal notranslate"><span class="pre">defjvps</span></code> example with multiple arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x_dot</span><span class="p">,</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x_dot</span><span class="p">,</span>
          <span class="k">lambda</span> <span class="n">y_dot</span><span class="p">,</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_dot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>  <span class="c1"># same as above</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
12.0
4.0
</pre></div>
</div>
</div>
</div>
<p>As a shorthand, with <code class="docutils literal notranslate"><span class="pre">defjvps</span></code> you can pass a <code class="docutils literal notranslate"><span class="pre">None</span></code> value to indicate that the JVP for a particular argument is zero:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvps</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x_dot</span><span class="p">,</span> <span class="n">primal_out</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x_dot</span><span class="p">,</span>
          <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>  <span class="c1"># same as above</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
12.0
0.0
</pre></div>
</div>
</div>
</div>
<p>Calling a <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> function with keyword arguments, or writing a <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> function definition with default arguments, are both allowed so long as they can be unambiguously mapped to positional arguments based on the function signature retrieved by the standard library <code class="docutils literal notranslate"><span class="pre">inspect.signature</span></code> mechanism.</p>
<p>When you’re not performing differentiation, the function <code class="docutils literal notranslate"><span class="pre">f</span></code> is called just as if it weren’t decorated by <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">'called f!'</span><span class="p">)</span>  <span class="c1"># a harmless side-effect</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">'called f_jvp!'</span><span class="p">)</span>  <span class="c1"># a harmless side-effect</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">t</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vmap</span><span class="p">,</span> <span class="n">jit</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f!
0.14112
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">3.</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f!
[0.        0.841471  0.9092974]
called f!
0.14112
</pre></div>
</div>
</div>
</div>
<p>The custom JVP rule is invoked during differentiation, whether forward or reverse:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="p">,</span> <span class="n">y_dot</span> <span class="o">=</span> <span class="n">jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.</span><span class="p">,),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y_dot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_jvp!
called f!
-0.9899925
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_jvp!
called f!
-0.9899925
</pre></div>
</div>
</div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code> calls <code class="docutils literal notranslate"><span class="pre">f</span></code> to compute the primal outputs. In the context of higher-order differentiation, each application of a differentiation transform will use the custom JVP rule if and only if the rule calls the original <code class="docutils literal notranslate"><span class="pre">f</span></code> to compute the primal outputs. (This represents a kind of fundamental tradeoff, where we can’t make use of intermediate values from the evaluation of <code class="docutils literal notranslate"><span class="pre">f</span></code> in our rule <em>and also</em> have the rule apply in all orders of higher-order differentiation.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grad</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span><span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_jvp!
called f_jvp!
called f!
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(-0.14112, dtype=float32, weak_type=True)
</pre></div>
</div>
</div>
</div>
<p>You can use Python control flow with <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_dot</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x_dot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">1.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
3.0
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Use jax.custom_vjp to define custom reverse-mode-only rules"></a><section id="use-jax-custom-vjp-to-define-custom-reverse-mode-only-rules">
<h3>Use <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> to define custom reverse-mode-only rules<a class="headerlink" href="#use-jax-custom-vjp-to-define-custom-reverse-mode-only-rules" title="Permalink to this headline">#</a></h3>
<p>While <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> suffices for controlling both forward- and, via JAX’s automatic transposition, reverse-mode differentiation behavior, in some cases we may want to directly control a VJP rule, for example in the latter two example problems presented above. We can do that with <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_vjp</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="c1"># f :: a -&gt; b</span>
<span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># f_fwd :: a -&gt; (b, c)</span>
<span class="k">def</span> <span class="nf">f_fwd</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># f_bwd :: (c, CT b) -&gt; CT a</span>
<span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">cos_x</span><span class="p">,</span> <span class="n">y_bar</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">cos_x</span> <span class="o">*</span> <span class="n">y_bar</span><span class="p">,)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">f_fwd</span><span class="p">,</span> <span class="n">f_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">grad</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.14112
-0.9899925
</pre></div>
</div>
</div>
</div>
<p>In words, we again start with a primal function <code class="docutils literal notranslate"><span class="pre">f</span></code> that takes inputs of type <code class="docutils literal notranslate"><span class="pre">a</span></code> and produces outputs of type <code class="docutils literal notranslate"><span class="pre">b</span></code>. We associate with it two functions, <code class="docutils literal notranslate"><span class="pre">f_fwd</span></code> and <code class="docutils literal notranslate"><span class="pre">f_bwd</span></code>, which describe how to perform the forward- and backward-passes of reverse-mode autodiff, respectively.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">f_fwd</span></code> describes the forward pass, not only the primal computation but also what values to save for use on the backward pass. Its input signature is just like that of the primal function <code class="docutils literal notranslate"><span class="pre">f</span></code>, in that it takes a primal input of type <code class="docutils literal notranslate"><span class="pre">a</span></code>. But as output it produces a pair, where the first element is the primal output <code class="docutils literal notranslate"><span class="pre">b</span></code> and the second element is any “residual” data of type <code class="docutils literal notranslate"><span class="pre">c</span></code> to be stored for use by the backward pass. (This second output is analogous to <a class="reference external" href="https://pytorch.org/tutorials/beginner/examples_autograd/two_layer_net_custom_function.html">PyTorch’s save_for_backward mechanism</a>.)</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">f_bwd</span></code> describes the backward pass. It takes two inputs, where the first is the residual data of type <code class="docutils literal notranslate"><span class="pre">c</span></code> produced by <code class="docutils literal notranslate"><span class="pre">f_fwd</span></code> and the second is the output cotangents of type <code class="docutils literal notranslate"><span class="pre">CT</span> <span class="pre">b</span></code> corresponding to the output of the primal function. It produces an output of type <code class="docutils literal notranslate"><span class="pre">CT</span> <span class="pre">a</span></code> representing the cotangents corresponding to the input of the primal function. In particular, the output of <code class="docutils literal notranslate"><span class="pre">f_bwd</span></code> must be a sequence (e.g. a tuple) of length equal to the number of arguments to the primal function.</p>
<p>So multiple arguments work like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">custom_vjp</span>

<span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>

<span class="k">def</span> <span class="nf">f_fwd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="n">cos_x</span><span class="p">,</span> <span class="n">sin_x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">res</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">cos_x</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">sin_x</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">f_fwd</span><span class="p">,</span> <span class="n">f_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-1.2484405
</pre></div>
</div>
</div>
</div>
<p>Calling a <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> function with keyword arguments, or writing a <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> function definition with default arguments, are both allowed so long as they can be unambiguously mapped to positional arguments based on the function signature retrieved by the standard library <code class="docutils literal notranslate"><span class="pre">inspect.signature</span></code> mechanism.</p>
<p>As with <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>, the custom VJP rule comprised by <code class="docutils literal notranslate"><span class="pre">f_fwd</span></code> and <code class="docutils literal notranslate"><span class="pre">f_bwd</span></code> is not invoked if differentiation is not applied. If function is evaluated, or transformed with <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, or other non-differentiation transformations, then only <code class="docutils literal notranslate"><span class="pre">f</span></code> is called.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"called f!"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f_fwd</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"called f_fwd!"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">cos_x</span><span class="p">,</span> <span class="n">y_bar</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"called f_bwd!"</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">cos_x</span> <span class="o">*</span> <span class="n">y_bar</span><span class="p">,)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">f_fwd</span><span class="p">,</span> <span class="n">f_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f!
0.14112
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_fwd!
called f!
called f_bwd!
-0.9899925
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">vjp</span>

<span class="n">y</span><span class="p">,</span> <span class="n">f_vjp</span> <span class="o">=</span> <span class="n">vjp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_fwd!
called f!
0.14112
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">f_vjp</span><span class="p">(</span><span class="mf">1.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_bwd!
(DeviceArray(-0.9899925, dtype=float32, weak_type=True),)
</pre></div>
</div>
</div>
</div>
<p><strong>Forward-mode autodiff cannot be used on the</strong> <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> <strong>function</strong> and will raise an error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jvp</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.</span><span class="p">,),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,))</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">'ERROR! </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>called f_fwd!
called f!
ERROR! can't apply forward-mode autodiff (jvp) to a custom_vjp function.
</pre></div>
</div>
</div>
</div>
<p>If you want to use both forward- and reverse-mode, use <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> instead.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> together with <code class="docutils literal notranslate"><span class="pre">pdb</span></code> to insert a debugger trace in the backward pass:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pdb</span>

<span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span>  <span class="c1"># acts like identity</span>

<span class="k">def</span> <span class="nf">debug_fwd</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">debug_bwd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">g</span>

<span class="n">debug</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">debug_fwd</span><span class="p">,</span> <span class="n">debug_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">debug</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># insert pdb in corresponding backward pass step</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">foo</span><span class="p">)(</span><span class="mf">3.</span><span class="p">)</span>

<span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">113</span><span class="o">-</span><span class="n">b19a2dc1abf7</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="n">debug_bwd</span><span class="p">()</span>
<span class="o">-&gt;</span> <span class="k">return</span> <span class="n">g</span>
<span class="p">(</span><span class="n">Pdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">x</span>
<span class="n">DeviceArray</span><span class="p">(</span><span class="mf">9.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="p">(</span><span class="n">Pdb</span><span class="p">)</span> <span class="n">p</span> <span class="n">g</span>
<span class="n">DeviceArray</span><span class="p">(</span><span class="o">-</span><span class="mf">0.91113025</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float32</span><span class="p">)</span>
<span class="p">(</span><span class="n">Pdb</span><span class="p">)</span> <span class="n">q</span>
</pre></div>
</div>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/More features and details"></a><section id="more-features-and-details">
<h2>More features and details<a class="headerlink" href="#more-features-and-details" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Working with list / tuple / dict containers (and other pytrees)"></a><section id="working-with-list-tuple-dict-containers-and-other-pytrees">
<h3>Working with <code class="docutils literal notranslate"><span class="pre">list</span></code> / <code class="docutils literal notranslate"><span class="pre">tuple</span></code> / <code class="docutils literal notranslate"><span class="pre">dict</span></code> containers (and other pytrees)<a class="headerlink" href="#working-with-list-tuple-dict-containers-and-other-pytrees" title="Permalink to this headline">#</a></h3>
<p>You should expect standard Python containers like lists, tuples, namedtuples, and dicts to just work, along with nested versions of those. In general, any <a class="reference external" href="https://jax.readthedocs.io/en/latest/pytrees.html">pytrees</a> are permissible, so long as their structures are consistent according to the type constraints.</p>
<p>Here’s a contrived example with <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="n">Point</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Point"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"x"</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">])</span>

<span class="nd">@custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pt</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
          <span class="s1">'b'</span><span class="p">:</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">))}</span>

<span class="nd">@f</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">pt</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">pt_dot</span><span class="p">,</span> <span class="o">=</span>  <span class="n">tangents</span>
  <span class="n">ans</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
  <span class="n">ans_dot</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">pt_dot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
             <span class="s1">'b'</span><span class="p">:</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">pt_dot</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">pt_dot</span><span class="o">.</span><span class="n">y</span><span class="p">)}</span>
  <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="n">ans_dot</span>

<span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">pt</span><span class="p">):</span>
  <span class="n">dct</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dct</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span> <span class="o">+</span> <span class="n">dct</span><span class="p">[</span><span class="s1">'b'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{'a': 1.0, 'b': (DeviceArray(0.841471, dtype=float32, weak_type=True), DeviceArray(-0.41614684, dtype=float32, weak_type=True))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">fun</span><span class="p">)(</span><span class="n">pt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Point(x=DeviceArray(2.5403023, dtype=float32, weak_type=True), y=DeviceArray(0., dtype=float32, weak_type=True))
</pre></div>
</div>
</div>
</div>
<p>And an analogous contrived example with <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@custom_vjp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pt</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
          <span class="s1">'b'</span><span class="p">:</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="p">))}</span>

<span class="k">def</span> <span class="nf">f_fwd</span><span class="p">(</span><span class="n">pt</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">pt</span><span class="p">),</span> <span class="n">pt</span>

<span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="n">a_bar</span><span class="p">,</span> <span class="p">(</span><span class="n">b0_bar</span><span class="p">,</span> <span class="n">b1_bar</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s1">'b'</span><span class="p">]</span>
  <span class="n">x_bar</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pt</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">a_bar</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">b0_bar</span>
  <span class="n">y_bar</span> <span class="o">=</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">b1_bar</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">x_bar</span><span class="p">,</span> <span class="n">y_bar</span><span class="p">),)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">f_fwd</span><span class="p">,</span> <span class="n">f_bwd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">pt</span><span class="p">):</span>
  <span class="n">dct</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">dct</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span> <span class="o">+</span> <span class="n">dct</span><span class="p">[</span><span class="s1">'b'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{'a': 1.0, 'b': (DeviceArray(0.841471, dtype=float32, weak_type=True), DeviceArray(-0.41614684, dtype=float32, weak_type=True))}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">fun</span><span class="p">)(</span><span class="n">pt</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Point(x=DeviceArray(2.5403023, dtype=float32, weak_type=True), y=DeviceArray(-0., dtype=float32, weak_type=True))
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Handling  non-differentiable arguments"></a><section id="handling-non-differentiable-arguments">
<h3>Handling  non-differentiable arguments<a class="headerlink" href="#handling-non-differentiable-arguments" title="Permalink to this headline">#</a></h3>
<p>Some use cases, like the final example problem, call for non-differentiable arguments like function-valued arguments to be passed to functions with custom differentiation rules, and for those arguments to also be passed to the rules themselves. In the case of <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code>, the function argument <code class="docutils literal notranslate"><span class="pre">f</span></code> was such a non-differentiable argument. A similar situation arises with <code class="docutils literal notranslate"><span class="pre">jax.experimental.odeint</span></code>.</p>
<section id="jax-custom-jvp-with-nondiff-argnums">
<h4><code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> with <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code><a class="headerlink" href="#jax-custom-jvp-with-nondiff-argnums" title="Permalink to this headline">#</a></h4>
<p>Use the optional <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> to indicate arguments like these. Here’s an example with <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">custom_jvp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">app_jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">x_dot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">app</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>27.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.0
</pre></div>
</div>
</div>
</div>
<p>Notice the gotcha here: no matter where in the argument list these parameters appear, they’re placed at the <em>start</em> of the signature of the corresponding JVP rule. Here’s another example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">custom_jvp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">app2</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">g</span><span class="p">((</span><span class="n">x</span><span class="p">)))</span>

<span class="nd">@app2</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">app2_jvp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">x_dot</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x_dot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">app2</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3375.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">app2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="jax-custom-vjp-with-nondiff-argnums">
<h4><code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> with <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code><a class="headerlink" href="#jax-custom-vjp-with-nondiff-argnums" title="Permalink to this headline">#</a></h4>
<p>A similar option exists for <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code>, and, similarly, the convention is that the non-differentiable arguments are passed as the first arguments to the <code class="docutils literal notranslate"><span class="pre">_bwd</span></code> rule, no matter where they appear in the signature of the original function. The signature of the <code class="docutils literal notranslate"><span class="pre">_fwd</span></code> rule remains unchanged - it is the same as the signature of the primal function. Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">custom_vjp</span><span class="p">,</span> <span class="n">nondiff_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">app_fwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">app_bwd</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">g</span><span class="p">,)</span>

<span class="n">app</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">app_fwd</span><span class="p">,</span> <span class="n">app_bwd</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">app</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">4.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>16.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="mi">1</span><span class="p">)(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">4.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.0
</pre></div>
</div>
</div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code> above for another usage example.</p>
<p><strong>You don’t need to use</strong> <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> <strong>with array-valued arguments</strong>, for example ones with integer dtype. Instead, <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> should only be used for argument values that don’t correspond to JAX types (essentially don’t correspond to array types), like Python callables or strings. If JAX detects that an argument indicated by <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> contains a JAX Tracer, then an error is raised. The <code class="docutils literal notranslate"><span class="pre">clip_gradient</span></code> function above is a good example of not using <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> for integer-dtype array arguments.</p>
</section>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="neural_network_with_tfds_data.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Training a Simple Neural Network, with tensorflow/datasets Data Loading</p>
</div>
</a>
<a class="right-next" href="How_JAX_primitives_work.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">How JAX primitives work</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>