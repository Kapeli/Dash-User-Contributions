
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>🔪 JAX - The Sharp Bits 🔪 — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="../jax-101/index.html" rel="next" title="Tutorial: JAX 101"/>
<link href="thinking_in_jax.html" rel="prev" title="How to Think in JAX"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1 current active">
<a class="current reference internal" href="#">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/notebooks/Common_Gotchas_in_JAX.ipynb.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#pure-functions">
   🔪 Pure functions
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#in-place-updates">
   🔪 In-Place Updates
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#array-updates-x-at-idx-set-y">
     Array updates:
     <code class="docutils literal notranslate">
<span class="pre">
       x.at[idx].set(y)
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#array-updates-with-other-operations">
     Array updates with other operations
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#out-of-bounds-indexing">
   🔪 Out-of-Bounds Indexing
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#non-array-inputs-numpy-vs-jax">
   🔪 Non-array inputs: NumPy vs. JAX
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#random-numbers">
   🔪 Random Numbers
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#rngs-and-state">
     RNGs and State
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-prng">
     JAX PRNG
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#control-flow">
   🔪 Control Flow
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python-control-flow-autodiff">
     ✔ python control_flow + autodiff ✔
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python-control-flow-jit">
     python control flow + JIT
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#structured-control-flow-primitives">
     Structured control flow primitives
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#cond">
       cond
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#while-loop">
       while_loop
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#fori-loop">
       fori_loop
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#summary">
       Summary
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#nans">
   🔪 NaNs
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#debugging-nans">
     Debugging NaNs
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#double-64bit-precision">
   🔪 Double (64bit) precision
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#caveats">
     Caveats
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#miscellaneous-divergences-from-numpy">
   🔪 Miscellaneous Divergences from NumPy
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#fin">
   Fin.
  </a>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>🔪 JAX - The Sharp Bits 🔪</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#pure-functions">
   🔪 Pure functions
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#in-place-updates">
   🔪 In-Place Updates
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#array-updates-x-at-idx-set-y">
     Array updates:
     <code class="docutils literal notranslate">
<span class="pre">
       x.at[idx].set(y)
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#array-updates-with-other-operations">
     Array updates with other operations
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#out-of-bounds-indexing">
   🔪 Out-of-Bounds Indexing
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#non-array-inputs-numpy-vs-jax">
   🔪 Non-array inputs: NumPy vs. JAX
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#random-numbers">
   🔪 Random Numbers
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#rngs-and-state">
     RNGs and State
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-prng">
     JAX PRNG
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#control-flow">
   🔪 Control Flow
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python-control-flow-autodiff">
     ✔ python control_flow + autodiff ✔
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#python-control-flow-jit">
     python control flow + JIT
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#structured-control-flow-primitives">
     Structured control flow primitives
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#cond">
       cond
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#while-loop">
       while_loop
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#fori-loop">
       fori_loop
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#summary">
       Summary
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#nans">
   🔪 NaNs
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#debugging-nans">
     Debugging NaNs
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#double-64bit-precision">
   🔪 Double (64bit) precision
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#caveats">
     Caveats
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#miscellaneous-divergences-from-numpy">
   🔪 Miscellaneous Divergences from NumPy
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#fin">
   Fin.
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 JAX - The Sharp Bits 🔪"></a><section class="tex2jax_ignore mathjax_ignore" id="jax-the-sharp-bits">
<h1>🔪 JAX - The Sharp Bits 🔪<a class="headerlink" href="#jax-the-sharp-bits" title="Permalink to this headline">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/google/jax/blob/main/docs/notebooks/Common_Gotchas_in_JAX.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p><em>levskaya@ mattjj@</em></p>
<p>When walking about the countryside of Italy, the people will not hesitate to tell you that <strong>JAX</strong> has <a class="reference external" href="https://www.sscardapane.it/iaml-backup/jax-intro/"><em>“una anima di pura programmazione funzionale”</em></a>.</p>
<p><strong>JAX</strong> is a language for <strong>expressing</strong> and <strong>composing</strong> <strong>transformations</strong> of numerical programs. <strong>JAX</strong> is also able to <strong>compile</strong> numerical programs for CPU or accelerators (GPU/TPU).
JAX works great for many numerical and scientific programs, but <strong>only if they are written with certain constraints</strong> that we describe below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">grad</span><span class="p">,</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.interpolation'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'nearest'</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.cmap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'viridis'</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">'axes.grid'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Pure functions"></a><section id="pure-functions">
<h2>🔪 Pure functions<a class="headerlink" href="#pure-functions" title="Permalink to this headline">#</a></h2>
<p>JAX transformation and compilation are designed to work only on Python functions that are functionally pure: all the input data is passed through the function parameters, all the results are output through the function results. A pure function will always return the same result if invoked with the same inputs.</p>
<p>Here are some examples of functions that are not functionally pure for which JAX behaves differently than the Python interpreter. Note that these behaviors are not guaranteed by the JAX system; the proper way to use JAX is to use it only on functionally pure Python functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">impure_print_side_effect</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"Executing function"</span><span class="p">)</span>  <span class="c1"># This is a side-effect </span>
  <span class="k">return</span> <span class="n">x</span>

<span class="c1"># The side-effects appear during the first run  </span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"First call: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_print_side_effect</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>

<span class="c1"># Subsequent runs with parameters of same type and shape may not show the side-effect</span>
<span class="c1"># This is because JAX now invokes a cached compilation of the function</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"Second call: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_print_side_effect</span><span class="p">)(</span><span class="mf">5.</span><span class="p">))</span>

<span class="c1"># JAX re-runs the Python function when the type or shape of the argument changes</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"Third call, different type: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_print_side_effect</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Executing function
First call:  4.0
Second call:  5.0
Executing function
Third call, different type:  [5.]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="k">def</span> <span class="nf">impure_uses_globals</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">g</span>

<span class="c1"># JAX captures the value of the global during the first run</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"First call: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_uses_globals</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">10.</span>  <span class="c1"># Update the global</span>

<span class="c1"># Subsequent runs may silently use the cached value of the globals</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"Second call: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_uses_globals</span><span class="p">)(</span><span class="mf">5.</span><span class="p">))</span>

<span class="c1"># JAX re-runs the Python function when the type or shape of the argument changes</span>
<span class="c1"># This will end up reading the latest value of the global</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"Third call, different type: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_uses_globals</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First call:  4.0
Second call:  5.0
Third call, different type:  [14.]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="k">def</span> <span class="nf">impure_saves_global</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">g</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="c1"># JAX runs once the transformed function with special Traced values for arguments</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"First call: "</span><span class="p">,</span> <span class="n">jit</span><span class="p">(</span><span class="n">impure_saves_global</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">"Saved global: "</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>  <span class="c1"># Saved global has an internal JAX value</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>First call:  4.0
Saved global:  Traced&lt;ShapedArray(float32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;
</pre></div>
</div>
</div>
</div>
<p>A Python function can be functionally pure even if it actually uses stateful objects internally, as long as it does not read or write external state:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pure_uses_internal_state</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">even</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">odd</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">state</span><span class="p">[</span><span class="s1">'even'</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">'odd'</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">state</span><span class="p">[</span><span class="s1">'even'</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="s1">'odd'</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">pure_uses_internal_state</span><span class="p">)(</span><span class="mf">5.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50.0
</pre></div>
</div>
</div>
</div>
<p>It is not recommended to use iterators in any JAX function you want to <code class="docutils literal notranslate"><span class="pre">jit</span></code> or in any control-flow primitive. The reason is that an iterator is a python object which introduces state to retrieve the next element. Therefore, it is incompatible with JAX functional programming model. In the code below, there are some examples of incorrect attempts to use iterators with JAX. Most of them return an error, but some give unexpected results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">jax.lax</span> <span class="k">as</span> <span class="nn">lax</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">make_jaxpr</span>

<span class="c1"># lax.fori_loop</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># expected result 45</span>
<span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># unexpected result 0</span>

<span class="c1"># lax.scan</span>
<span class="k">def</span> <span class="nf">func11</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">aelems</span><span class="p">):</span>
        <span class="n">ae1</span><span class="p">,</span> <span class="n">ae2</span> <span class="o">=</span> <span class="n">aelems</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">carry</span> <span class="o">+</span> <span class="n">ae1</span> <span class="o">*</span> <span class="n">ae2</span> <span class="o">+</span> <span class="n">extra</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">ones</span><span class="p">))</span>    
<span class="n">make_jaxpr</span><span class="p">(</span><span class="n">func11</span><span class="p">)(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="mf">5.</span><span class="p">)</span>
<span class="c1"># make_jaxpr(func11)(iter(range(16)), 5.) # throws error</span>

<span class="c1"># lax.cond</span>
<span class="n">array_operand</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
<span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">array_operand</span><span class="p">)</span>
<span class="n">iter_operand</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="c1"># lax.cond(True, lambda x: next(x)+1, lambda x: next(x)-1, iter_operand) # throws error</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>45
0
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 In-Place Updates"></a><section id="in-place-updates">
<h2>🔪 In-Place Updates<a class="headerlink" href="#in-place-updates" title="Permalink to this headline">#</a></h2>
<p>In Numpy you’re used to doing this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numpy_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"original array:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>

<span class="c1"># In place, mutating update</span>
<span class="n">numpy_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"updated array:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">numpy_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original array:
[[0. 0. 0.]
 [0. 0. 0.]
 [0. 0. 0.]]
updated array:
[[0. 0. 0.]
 [1. 1. 1.]
 [0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
<p>If we try to update a JAX device array in-place, however, we get an <strong>error</strong>!  (☉_☉)</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jax_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># In place update of JAX's array will yield an error!</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">jax_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"Exception </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception '&lt;class 'jaxlib.xla_extension.DeviceArray'&gt;' object does not support item assignment. JAX arrays are immutable. Instead of ``x[idx] = y``, use ``x = x.at[idx].set(y)`` or another .at[] method: https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html
</pre></div>
</div>
</div>
</div>
<p>Allowing mutation of variables in-place makes program analysis and transformation difficult. JAX requires that programs are pure functions.</p>
<p>Instead, JAX offers a <em>functional</em> array update using the <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html#jax.numpy.ndarray.at"><code class="docutils literal notranslate"><span class="pre">.at</span></code> property on JAX arrays</a>.</p>
<p>️⚠️ inside <code class="docutils literal notranslate"><span class="pre">jit</span></code>’d code and <code class="docutils literal notranslate"><span class="pre">lax.while_loop</span></code> or <code class="docutils literal notranslate"><span class="pre">lax.fori_loop</span></code> the <strong>size</strong> of slices can’t be functions of argument <em>values</em> but only functions of argument <em>shapes</em> – the slice start indices have no such restriction.  See the below <strong>Control Flow</strong> Section for more information on this limitation.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Array updates: x.at[idx].set(y)"></a><section id="array-updates-x-at-idx-set-y">
<h3>Array updates: <code class="docutils literal notranslate"><span class="pre">x.at[idx].set(y)</span></code><a class="headerlink" href="#array-updates-x-at-idx-set-y" title="Permalink to this headline">#</a></h3>
<p>For example, the update above can be written as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">updated_array</span> <span class="o">=</span> <span class="n">jax_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"updated array:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">updated_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>updated array:
 [[0. 0. 0.]
 [1. 1. 1.]
 [0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
<p>JAX’s array update functions, unlike their NumPy versions, operate out-of-place. That is, the updated array is returned as a new array and the original array is not modified by the update.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"original array unchanged:</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">jax_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original array unchanged:
 [[0. 0. 0.]
 [0. 0. 0.]
 [0. 0. 0.]]
</pre></div>
</div>
</div>
</div>
<p>However, inside <strong>jit</strong>-compiled code, if the <strong>input value</strong> <code class="docutils literal notranslate"><span class="pre">x</span></code> of <code class="docutils literal notranslate"><span class="pre">x.at[idx].set(y)</span></code> is not reused, the compiler will optimize the array update to occur <em>in-place</em>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Array updates with other operations"></a><section id="array-updates-with-other-operations">
<h3>Array updates with other operations<a class="headerlink" href="#array-updates-with-other-operations" title="Permalink to this headline">#</a></h3>
<p>Indexed array updates are not limited simply to overwriting values. For example, we can perform indexed addition as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"original array:"</span><span class="p">)</span>
<span class="n">jax_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">jax_array</span><span class="p">)</span>

<span class="n">new_jax_array</span> <span class="o">=</span> <span class="n">jax_array</span><span class="o">.</span><span class="n">at</span><span class="p">[::</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">7.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"new array post-addition:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">new_jax_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>original array:
[[1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 1. 1. 1.]]
new array post-addition:
[[1. 1. 1. 8. 8. 8.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 8. 8. 8.]
 [1. 1. 1. 1. 1. 1.]
 [1. 1. 1. 8. 8. 8.]]
</pre></div>
</div>
</div>
</div>
<p>For more details on indexed array updates, see the <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.numpy.ndarray.at.html#jax.numpy.ndarray.at">documentation for the <code class="docutils literal notranslate"><span class="pre">.at</span></code> property</a>.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Out-of-Bounds Indexing"></a><section id="out-of-bounds-indexing">
<h2>🔪 Out-of-Bounds Indexing<a class="headerlink" href="#out-of-bounds-indexing" title="Permalink to this headline">#</a></h2>
<p>In Numpy, you are used to errors being thrown when you index an array outside of its bounds, like this:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
  <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="mi">11</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"Exception </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception index 11 is out of bounds for axis 0 with size 10
</pre></div>
</div>
</div>
</div>
<p>However, raising an error from code running on an accelerator can be difficult or impossible. Therefore, JAX must choose some non-error behavior for out of bounds indexing (akin to how invalid floating point arithmetic results in <code class="docutils literal notranslate"><span class="pre">NaN</span></code>). When the indexing operation is an array index update (e.g. <code class="docutils literal notranslate"><span class="pre">index_add</span></code> or <code class="docutils literal notranslate"><span class="pre">scatter</span></code>-like primitives), updates at out-of-bounds indices will be skipped; when the operation is an array index retrieval (e.g. NumPy indexing or <code class="docutils literal notranslate"><span class="pre">gather</span></code>-like primitives) the index is clamped to the bounds of the array since <strong>something</strong> must be returned. For example, the last value of the array will be returned from this indexing operation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">)[</span><span class="mi">11</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(9, dtype=int32)
</pre></div>
</div>
</div>
</div>
<p>Note that due to this behavior for index retrieval, functions like <code class="docutils literal notranslate"><span class="pre">jnp.nanargmin</span></code> and <code class="docutils literal notranslate"><span class="pre">jnp.nanargmax</span></code> return -1 for slices consisting of NaNs whereas Numpy would throw an error.</p>
<p>Note also that, as the two behaviors described above are not inverses of each other, reverse-mode automatic differentiation (which turns index updates into index retrievals and vice versa) <a class="reference external" href="https://github.com/google/jax/issues/5760">will not preserve the semantics of out of bounds indexing</a>. Thus it may be a good idea to think of out-of-bounds indexing in JAX as a case of <a class="reference external" href="https://en.wikipedia.org/wiki/Undefined_behavior">undefined behavior</a>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Non-array inputs: NumPy vs. JAX"></a><section id="non-array-inputs-numpy-vs-jax">
<h2>🔪 Non-array inputs: NumPy vs. JAX<a class="headerlink" href="#non-array-inputs-numpy-vs-jax" title="Permalink to this headline">#</a></h2>
<p>NumPy is generally happy accepting Python lists or tuples as inputs to its API functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6
</pre></div>
</div>
</div>
</div>
<p>JAX departs from this, generally returning a helpful error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
  <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"TypeError: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TypeError: sum requires ndarray or scalar arguments, got &lt;class 'list'&gt; at position 0.
</pre></div>
</div>
</div>
</div>
<p>This is a deliberate design choice, because passing lists or tuples to traced functions can lead to silent performance degradation that might otherwise be difficult to detect.</p>
<p>For example, consider the following permissive version of <code class="docutils literal notranslate"><span class="pre">jnp.sum</span></code> that allows list inputs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">permissive_sum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">permissive_sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(45, dtype=int32)
</pre></div>
</div>
</div>
</div>
<p>The output is what we would expect, but this hides potential performance issues under the hood. In JAX’s tracing and JIT compilation model, each element in a Python list or tuple is treated as a separate JAX variable, and individually processed and pushed to device. This can be seen in the jaxpr for the <code class="docutils literal notranslate"><span class="pre">permissive_sum</span></code> function above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">make_jaxpr</span><span class="p">(</span><span class="n">permissive_sum</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{ lambda ; a:i32[] b:i32[] c:i32[] d:i32[] e:i32[] f:i32[] g:i32[] h:i32[] i:i32[]
    j:i32[]. let
    k:i32[] = convert_element_type[new_dtype=int32 weak_type=False] a
    l:i32[] = convert_element_type[new_dtype=int32 weak_type=False] b
    m:i32[] = convert_element_type[new_dtype=int32 weak_type=False] c
    n:i32[] = convert_element_type[new_dtype=int32 weak_type=False] d
    o:i32[] = convert_element_type[new_dtype=int32 weak_type=False] e
    p:i32[] = convert_element_type[new_dtype=int32 weak_type=False] f
    q:i32[] = convert_element_type[new_dtype=int32 weak_type=False] g
    r:i32[] = convert_element_type[new_dtype=int32 weak_type=False] h
    s:i32[] = convert_element_type[new_dtype=int32 weak_type=False] i
    t:i32[] = convert_element_type[new_dtype=int32 weak_type=False] j
    u:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] k
    v:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] l
    w:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] m
    x:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] n
    y:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] o
    z:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] p
    ba:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] q
    bb:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] r
    bc:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] s
    bd:i32[1] = broadcast_in_dim[broadcast_dimensions=() shape=(1,)] t
    be:i32[10] = concatenate[dimension=0] u v w x y z ba bb bc bd
    bf:i32[] = reduce_sum[axes=(0,)] be
  in (bf,) }
</pre></div>
</div>
</div>
</div>
<p>Each entry of the list is handled as a separate input, resulting in a tracing &amp; compilation overhead that grows linearly with the size of the list. To prevent surprises like this, JAX avoids implicit conversions of lists and tuples to arrays.</p>
<p>If you would like to pass a tuple or list to a JAX function, you can do so by first explicitly converting it to an array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(45, dtype=int32)
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Random Numbers"></a><section id="random-numbers">
<h2>🔪 Random Numbers<a class="headerlink" href="#random-numbers" title="Permalink to this headline">#</a></h2>
<blockquote>
<div><p><em>If all scientific papers whose results are in doubt because of bad
<code class="docutils literal notranslate"><span class="pre">rand()</span></code>s were to disappear from library shelves, there would be a
gap on each shelf about as big as your fist.</em> - Numerical Recipes</p>
</div></blockquote>
<a class="dashAnchor" name="//apple_ref/cpp/Section/RNGs and State"></a><section id="rngs-and-state">
<h3>RNGs and State<a class="headerlink" href="#rngs-and-state" title="Permalink to this headline">#</a></h3>
<p>You’re used to <em>stateful</em> pseudorandom number generators (PRNGs) from numpy and other libraries, which helpfully hide a lot of details under the hood to give you a ready fountain of pseudorandomness:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9711822779427176
0.19155111450091566
0.6102677712965705
</pre></div>
</div>
</div>
</div>
<p>Underneath the hood, numpy uses the <a class="reference external" href="https://en.wikipedia.org/wiki/Mersenne_Twister">Mersenne Twister</a> PRNG to power its pseudorandom functions.  The PRNG has a period of <span class="math notranslate nohighlight">\(2^{19937}-1\)</span> and at any point can be described by <strong>624 32bit unsigned ints</strong> and a <strong>position</strong> indicating how much of this  “entropy” has been used up.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1">#print(rng_state)</span>
<span class="c1"># --&gt; ('MT19937', array([0, 1, 1812433255, 1900727105, 1208447044,</span>
<span class="c1">#       2481403966, 4042607538,  337614300, ... 614 more numbers..., </span>
<span class="c1">#       3048484911, 1796872496], dtype=uint32), 624, 0, 0.0)</span>
</pre></div>
</div>
</div>
</div>
<p>This pseudorandom state vector is automagically updated behind the scenes every time a random number is needed, “consuming” 2 of the uint32s in the Mersenne twister state vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1">#print(rng_state) </span>
<span class="c1"># --&gt; ('MT19937', array([2443250962, 1093594115, 1878467924,</span>
<span class="c1">#       ..., 2648828502, 1678096082], dtype=uint32), 2, 0, 0.0)</span>

<span class="c1"># Let's exhaust the entropy in this PRNG statevector</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">311</span><span class="p">):</span>
  <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1">#print(rng_state) </span>
<span class="c1"># --&gt; ('MT19937', array([2443250962, 1093594115, 1878467924,</span>
<span class="c1">#       ..., 2648828502, 1678096082], dtype=uint32), 624, 0, 0.0)</span>

<span class="c1"># Next call iterates the RNG state for a new batch of fake "entropy".</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
<span class="n">rng_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
<span class="c1"># print(rng_state) </span>
<span class="c1"># --&gt; ('MT19937', array([1499117434, 2949980591, 2242547484, </span>
<span class="c1">#      4162027047, 3277342478], dtype=uint32), 2, 0, 0.0)</span>
</pre></div>
</div>
</div>
</div>
<p>The problem with magic PRNG state is that it’s hard to reason about how it’s being used and updated across different threads, processes, and devices, and it’s <em>very easy</em> to screw up when the details of entropy production and consumption are hidden from the end user.</p>
<p>The Mersenne Twister PRNG is also known to have a <a class="reference external" href="https://cs.stackexchange.com/a/53475">number</a> of problems, it has a large 2.5Kb state size, which leads to problematic <a class="reference external" href="https://dl.acm.org/citation.cfm?id=1276928">initialization issues</a>.  It <a class="reference external" href="http://www.pcg-random.org/pdf/toms-oneill-pcg-family-v1.02.pdf">fails</a> modern BigCrush tests, and is generally slow.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/JAX PRNG"></a><section id="jax-prng">
<h3>JAX PRNG<a class="headerlink" href="#jax-prng" title="Permalink to this headline">#</a></h3>
<p>JAX instead implements an <em>explicit</em> PRNG where entropy production and consumption are handled by explicitly passing and iterating PRNG state.  JAX uses a modern <a class="reference external" href="https://github.com/google/jax/blob/main/docs/jep/263-prng.md">Threefry counter-based PRNG</a> that’s <strong>splittable</strong>.  That is, its design allows us to <strong>fork</strong> the PRNG state into new PRNGs for use with parallel stochastic generation.</p>
<p>The random state is described by two unsigned-int32s that we call a <strong>key</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">key</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray([0, 0], dtype=uint32)
</pre></div>
</div>
</div>
</div>
<p>JAX’s random functions produce pseudorandom numbers from the PRNG state, but <strong>do not</strong> change the state!</p>
<p>Reusing the same state will cause <strong>sadness</strong> and <strong>monotony</strong>, depriving the end user of <strong>lifegiving chaos</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="c1"># No no no!</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.20584226]
[0 0]
[-0.20584226]
[0 0]
</pre></div>
</div>
</div>
</div>
<p>Instead, we <strong>split</strong> the PRNG to get usable <strong>subkeys</strong> every time we need a new pseudorandom number:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"old key"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">normal_pseudorandom</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"    \---SPLIT --&gt; new key   "</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"             \--&gt; new subkey"</span><span class="p">,</span> <span class="n">subkey</span><span class="p">,</span> <span class="s2">"--&gt; normal"</span><span class="p">,</span> <span class="n">normal_pseudorandom</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>old key [0 0]
    \---SPLIT --&gt; new key    [4146024105  967050713]
             \--&gt; new subkey [2718843009 1272950319] --&gt; normal [-1.2515389]
</pre></div>
</div>
</div>
</div>
<p>We propagate the <strong>key</strong> and make new <strong>subkeys</strong> whenever we need a new random number:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"old key"</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">normal_pseudorandom</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"    \---SPLIT --&gt; new key   "</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"             \--&gt; new subkey"</span><span class="p">,</span> <span class="n">subkey</span><span class="p">,</span> <span class="s2">"--&gt; normal"</span><span class="p">,</span> <span class="n">normal_pseudorandom</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>old key [4146024105  967050713]
    \---SPLIT --&gt; new key    [2384771982 3928867769]
             \--&gt; new subkey [1278412471 2182328957] --&gt; normal [-0.58665055]
</pre></div>
</div>
</div>
</div>
<p>We can generate more than one <strong>subkey</strong> at a time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">subkeys</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="n">subkeys</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.37533438]
[0.98645043]
[0.14553197]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Control Flow"></a><section id="control-flow">
<h2>🔪 Control Flow<a class="headerlink" href="#control-flow" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/✔ python control_flow + autodiff ✔"></a><section id="python-control-flow-autodiff">
<h3>✔ python control_flow + autodiff ✔<a class="headerlink" href="#python-control-flow-autodiff" title="Permalink to this headline">#</a></h3>
<p>If you just want to apply <code class="docutils literal notranslate"><span class="pre">grad</span></code> to your python functions, you can use regular python control-flow constructs with no problems, as if you were using <a class="reference external" href="https://github.com/hips/autograd">Autograd</a> (or Pytorch or TF Eager).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">2.</span><span class="p">))</span>  <span class="c1"># ok!</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">4.</span><span class="p">))</span>  <span class="c1"># ok!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
-4.0
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/python control flow + JIT"></a><section id="python-control-flow-jit">
<h3>python control flow + JIT<a class="headerlink" href="#python-control-flow-jit" title="Permalink to this headline">#</a></h3>
<p>Using control flow with <code class="docutils literal notranslate"><span class="pre">jit</span></code> is more complicated, and by default it has more constraints.</p>
<p>This works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>
  <span class="k">return</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<p>So does this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">y</span>

<span class="nb">print</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.0
</pre></div>
</div>
</div>
</div>
<p>But this doesn’t, at least by default:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span>

<span class="c1"># This will fail!</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"Exception </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exception Abstract tracer value encountered where concrete value is expected: Traced&lt;ShapedArray(bool[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;
The problem arose with the `bool` function. 
The error occurred while tracing the function f at /var/folders/hb/9_9_kvm96fb7w3zrqwzp3kkh0000gn/T/ipykernel_60922/2259617891.py:1 for jit. This concrete value was not available in Python because it depends on the value of the argument 'x'.

See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.ConcretizationTypeError
</pre></div>
</div>
</div>
</div>
<p><strong>What gives!?</strong></p>
<p>When we <code class="docutils literal notranslate"><span class="pre">jit</span></code>-compile a function, we usually want to compile a version of the function that works for many different argument values, so that we can cache and reuse the compiled code. That way we don’t have to re-compile on each function evaluation.</p>
<p>For example, if we evaluate an <code class="docutils literal notranslate"><span class="pre">@jit</span></code> function on the array <code class="docutils literal notranslate"><span class="pre">jnp.array([1.,</span> <span class="pre">2.,</span> <span class="pre">3.],</span> <span class="pre">jnp.float32)</span></code>, we might want to compile code that we can reuse to evaluate the function on <code class="docutils literal notranslate"><span class="pre">jnp.array([4.,</span> <span class="pre">5.,</span> <span class="pre">6.],</span> <span class="pre">jnp.float32)</span></code> to save on compile time.</p>
<p>To get a view of your Python code that is valid for many different argument values, JAX traces it on <em>abstract values</em> that represent sets of possible inputs. There are <a class="reference external" href="https://github.com/google/jax/blob/main/jax/_src/abstract_arrays.py">multiple different levels of abstraction</a>, and different transformations use different abstraction levels.</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">jit</span></code> traces your code on the <code class="docutils literal notranslate"><span class="pre">ShapedArray</span></code> abstraction level, where each abstract value represents the set of all array values with a fixed shape and dtype. For example, if we trace using the abstract value <code class="docutils literal notranslate"><span class="pre">ShapedArray((3,),</span> <span class="pre">jnp.float32)</span></code>, we get a view of the function that can be reused for any concrete value in the corresponding set of arrays. That means we can save on compile time.</p>
<p>But there’s a tradeoff here: if we trace a Python function on a <code class="docutils literal notranslate"><span class="pre">ShapedArray((),</span> <span class="pre">jnp.float32)</span></code> that isn’t committed to a specific concrete value, when we hit a line like <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">3</span></code>, the expression <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">3</span></code> evaluates to an abstract <code class="docutils literal notranslate"><span class="pre">ShapedArray((),</span> <span class="pre">jnp.bool_)</span></code> that represents the set <code class="docutils literal notranslate"><span class="pre">{True,</span> <span class="pre">False}</span></code>. When Python attempts to coerce that to a concrete <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>, we get an error: we don’t know which branch to take, and can’t continue tracing! The tradeoff is that with higher levels of abstraction we gain a more general view of the Python code (and thus save on re-compilations), but we require more constraints on the Python code to complete the trace.</p>
<p>The good news is that you can control this tradeoff yourself. By having <code class="docutils literal notranslate"><span class="pre">jit</span></code> trace on more refined abstract values, you can relax the traceability constraints. For example, using the <code class="docutils literal notranslate"><span class="pre">static_argnums</span></code> argument to <code class="docutils literal notranslate"><span class="pre">jit</span></code>, we can specify to trace on concrete values of some arguments. Here’s that example function again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0
</pre></div>
</div>
</div>
</div>
<p>Here’s another example, this time involving a loop:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">y</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

<span class="n">f</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(5., dtype=float32)
</pre></div>
</div>
</div>
</div>
<p>In effect, the loop gets statically unrolled.  JAX can also trace at <em>higher</em> levels of abstraction, like <code class="docutils literal notranslate"><span class="pre">Unshaped</span></code>, but that’s not currently the default for any transformation</p>
<p>️⚠️ <strong>functions with argument-<strong>value</strong> dependent shapes</strong></p>
<p>These control-flow issues also come up in a more subtle way: numerical functions we want to <strong>jit</strong> can’t specialize the shapes of internal arrays on argument <em>values</em> (specializing on argument <strong>shapes</strong> is ok).  As a trivial example, let’s make a function whose output happens to depend on the input variable <code class="docutils literal notranslate"><span class="pre">length</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">example_fun</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">length</span><span class="p">,))</span> <span class="o">*</span> <span class="n">val</span>
<span class="c1"># un-jit'd works fine</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example_fun</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">bad_example_jit</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">example_fun</span><span class="p">)</span>
<span class="c1"># this will fail:</span>
<span class="k">try</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">bad_example_jit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"Exception </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="c1"># static_argnums tells JAX to recompile on changes at these argument positions:</span>
<span class="n">good_example_jit</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">example_fun</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
<span class="c1"># first compile</span>
<span class="nb">print</span><span class="p">(</span><span class="n">good_example_jit</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1"># recompiles</span>
<span class="nb">print</span><span class="p">(</span><span class="n">good_example_jit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4. 4. 4. 4. 4.]
Exception The numpy.ndarray conversion method __array__() was called on the JAX Tracer object Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;
The error occurred while tracing the function example_fun at /var/folders/hb/9_9_kvm96fb7w3zrqwzp3kkh0000gn/T/ipykernel_60922/1262266785.py:1 for jit. This concrete value was not available in Python because it depends on the value of the argument 'length'.
See https://jax.readthedocs.io/en/latest/errors.html#jax.errors.TracerArrayConversionError
[4. 4. 4. 4. 4. 4. 4. 4. 4. 4.]
[4. 4. 4. 4. 4.]
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">static_argnums</span></code> can be handy if <code class="docutils literal notranslate"><span class="pre">length</span></code> in our example rarely changes, but it would be disastrous if it changed a lot!</p>
<p>Lastly, if your function has global side-effects, JAX’s tracer can cause weird things to happen. A common gotcha is trying to print arrays inside <strong>jit</strong>’d functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span>
<span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;
Traced&lt;ShapedArray(int32[], weak_type=True)&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(4, dtype=int32, weak_type=True)
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Structured control flow primitives"></a><section id="structured-control-flow-primitives">
<h3>Structured control flow primitives<a class="headerlink" href="#structured-control-flow-primitives" title="Permalink to this headline">#</a></h3>
<p>There are more options for control flow in JAX. Say you want to avoid re-compilations but still want to use control flow that’s traceable, and that avoids un-rolling large loops. Then you can use these 4 structured control flow primitives:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">lax.cond</span></code> <em>differentiable</em></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lax.while_loop</span></code> <strong>fwd-mode-differentiable</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lax.fori_loop</span></code> <strong>fwd-mode-differentiable</strong> in general; <strong>fwd and rev-mode differentiable</strong> if endpoints are static.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lax.scan</span></code> <em>differentiable</em></p></li>
</ul>
<section id="cond">
<h4>cond<a class="headerlink" href="#cond" title="Permalink to this headline">#</a></h4>
<p>python equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true_fun</span><span class="p">,</span> <span class="n">false_fun</span><span class="p">,</span> <span class="n">operand</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">pred</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">true_fun</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">false_fun</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>

<span class="n">operand</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
<span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
<span class="c1"># --&gt; array([1.], dtype=float32)</span>
<span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">operand</span><span class="p">)</span>
<span class="c1"># --&gt; array([-1.], dtype=float32)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray([-1.], dtype=float32)
</pre></div>
</div>
</div>
</div>
</section>
<section id="while-loop">
<h4>while_loop<a class="headerlink" href="#while-loop" title="Permalink to this headline">#</a></h4>
<p>python equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">):</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">init_val</span>
  <span class="k">while</span> <span class="n">cond_fun</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">body_fun</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">val</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_val</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">cond_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">&lt;</span><span class="mi">10</span>
<span class="n">body_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
<span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">cond_fun</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">)</span>
<span class="c1"># --&gt; array(10, dtype=int32)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(10, dtype=int32, weak_type=True)
</pre></div>
</div>
</div>
</div>
</section>
<section id="fori-loop">
<h4>fori_loop<a class="headerlink" href="#fori-loop" title="Permalink to this headline">#</a></h4>
<p>python equivalent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fori_loop</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">):</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">init_val</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">body_fun</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">val</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">init_val</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stop</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">body_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">i</span>
<span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">body_fun</span><span class="p">,</span> <span class="n">init_val</span><span class="p">)</span>
<span class="c1"># --&gt; array(45, dtype=int32)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DeviceArray(45, dtype=int32, weak_type=True)
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary">
<h4>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h4>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array} {r|rr} 
\hline \
\textrm{construct} 
&amp; \textrm{jit} 
&amp; \textrm{grad} \\
\hline \
\textrm{if} &amp; ❌ &amp; ✔ \\
\textrm{for} &amp; ✔* &amp; ✔\\
\textrm{while} &amp; ✔* &amp; ✔\\
\textrm{lax.cond} &amp; ✔ &amp; ✔\\
\textrm{lax.while_loop} &amp; ✔ &amp; \textrm{fwd}\\
\textrm{lax.fori_loop} &amp; ✔ &amp; \textrm{fwd}\\
\textrm{lax.scan} &amp; ✔ &amp; ✔\\
\hline
\end{array}
\end{split}\]</div>
<center>
<p><span class="math notranslate nohighlight">\(\ast\)</span> = argument-<b>value</b>-independent loop condition - unrolls the loop</p>
</center></section>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 NaNs"></a><section id="nans">
<h2>🔪 NaNs<a class="headerlink" href="#nans" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Debugging NaNs"></a><section id="debugging-nans">
<h3>Debugging NaNs<a class="headerlink" href="#debugging-nans" title="Permalink to this headline">#</a></h3>
<p>If you want to trace where NaNs are occurring in your functions or gradients, you can turn on the NaN-checker by:</p>
<ul class="simple">
<li><p>setting the <code class="docutils literal notranslate"><span class="pre">JAX_DEBUG_NANS=True</span></code> environment variable;</p></li>
<li><p>adding <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">jax.config</span> <span class="pre">import</span> <span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">config.update("jax_debug_nans",</span> <span class="pre">True)</span></code> near the top of your main file;</p></li>
<li><p>adding <code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">jax.config</span> <span class="pre">import</span> <span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">config.parse_flags_with_absl()</span></code> to your main file, then set the option using a command-line flag like <code class="docutils literal notranslate"><span class="pre">--jax_debug_nans=True</span></code>;</p></li>
</ul>
<p>This will cause computations to error-out immediately on production of a NaN. Switching this option on adds a nan check to every floating point type value produced by XLA. That means values are pulled back to the host and checked as ndarrays for every primitive operation not under an <code class="docutils literal notranslate"><span class="pre">@jit</span></code>. For code under an <code class="docutils literal notranslate"><span class="pre">@jit</span></code>, the output of every <code class="docutils literal notranslate"><span class="pre">@jit</span></code> function is checked and if a nan is present it will re-run the function in de-optimized op-by-op mode, effectively removing one level of <code class="docutils literal notranslate"><span class="pre">@jit</span></code> at a time.</p>
<p>There could be tricky situations that arise, like nans that only occur under a <code class="docutils literal notranslate"><span class="pre">@jit</span></code> but don’t get produced in de-optimized mode. In that case you’ll see a warning message print out but your code will continue to execute.</p>
<p>If the nans are being produced in the backward pass of a gradient evaluation, when an exception is raised several frames up in the stack trace you will be in the backward_pass function, which is essentially a simple jaxpr interpreter that walks the sequence of primitive operations in reverse. In the example below, we started an ipython repl with the command line <code class="docutils literal notranslate"><span class="pre">env</span> <span class="pre">JAX_DEBUG_NANS=True</span> <span class="pre">ipython</span></code>, then ran this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="ne">FloatingPointError</span>                        <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">f2e2c413b437</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">jnp</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">343</span>     <span class="k">return</span> <span class="n">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">344</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">345</span>     <span class="k">return</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">346</span>
    <span class="mi">347</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">332</span>   <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">333</span>   <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">),</span>
<span class="o">--&gt;</span> <span class="mi">334</span>                  <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">))</span>
    <span class="mi">335</span>
    <span class="mi">336</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">lax</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">244</span> <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="mi">245</span>   <span class="sa">r</span><span class="s2">"""Elementwise division: :math:`x \over y`."""</span>
<span class="o">--&gt;</span> <span class="mi">246</span>   <span class="k">return</span> <span class="n">div_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">247</span>
    <span class="mi">248</span> <span class="k">def</span> <span class="nf">rem</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

<span class="o">...</span> <span class="n">stack</span> <span class="n">trace</span> <span class="o">...</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">interpreters</span><span class="o">/</span><span class="n">xla</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">handle_result</span><span class="p">(</span><span class="n">device_buffer</span><span class="p">)</span>
    <span class="mi">103</span>         <span class="n">py_val</span> <span class="o">=</span> <span class="n">device_buffer</span><span class="o">.</span><span class="n">to_py</span><span class="p">()</span>
    <span class="mi">104</span>         <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">py_val</span><span class="p">)):</span>
<span class="o">--&gt;</span> <span class="mi">105</span>           <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="s2">"invalid value"</span><span class="p">)</span>
    <span class="mi">106</span>         <span class="k">else</span><span class="p">:</span>
    <span class="mi">107</span>           <span class="k">return</span> <span class="n">DeviceArray</span><span class="p">(</span><span class="n">device_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">result_shape</span><span class="p">)</span>

<span class="ne">FloatingPointError</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">value</span>
</pre></div>
</div>
<p>The nan generated was caught. By running <code class="docutils literal notranslate"><span class="pre">%debug</span></code>, we can get a post-mortem debugger. This also works with functions under <code class="docutils literal notranslate"><span class="pre">@jit</span></code>, as the example below shows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="nd">@jit</span>
   <span class="o">...</span><span class="p">:</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
   <span class="o">...</span><span class="p">:</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span>
   <span class="o">...</span><span class="p">:</span>     <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span>
   <span class="o">...</span><span class="p">:</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">Invalid</span> <span class="n">value</span> <span class="n">encountered</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">output</span> <span class="n">of</span> <span class="n">a</span> <span class="n">jit</span> <span class="n">function</span><span class="o">.</span> <span class="n">Calling</span> <span class="n">the</span> <span class="n">de</span><span class="o">-</span><span class="n">optimized</span> <span class="n">version</span><span class="o">.</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="ne">FloatingPointError</span>                        <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">811</span><span class="n">b7ddb3300</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

 <span class="o">...</span> <span class="n">stack</span> <span class="n">trace</span> <span class="o">...</span>

<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">619</span><span class="n">b39acbaac</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
      <span class="mi">2</span> <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
      <span class="mi">3</span>     <span class="n">a</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<span class="o">----&gt;</span> <span class="mi">4</span>     <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
      <span class="mi">5</span>     <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="mi">6</span>     <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">343</span>     <span class="k">return</span> <span class="n">floor_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">344</span>   <span class="k">else</span><span class="p">:</span>
<span class="o">--&gt;</span> <span class="mi">345</span>     <span class="k">return</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">346</span>
    <span class="mi">347</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">numpy</span><span class="o">/</span><span class="n">lax_numpy</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">true_divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">332</span>   <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">_promote_shapes</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="mi">333</span>   <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">),</span>
<span class="o">--&gt;</span> <span class="mi">334</span>                  <span class="n">lax</span><span class="o">.</span><span class="n">convert_element_type</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">result_dtype</span><span class="p">))</span>
    <span class="mi">335</span>
    <span class="mi">336</span>

<span class="o">.../</span><span class="n">jax</span><span class="o">/</span><span class="n">jax</span><span class="o">/</span><span class="n">lax</span><span class="o">.</span><span class="n">pyc</span> <span class="ow">in</span> <span class="n">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">244</span> <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="mi">245</span>   <span class="sa">r</span><span class="s2">"""Elementwise division: :math:`x \over y`."""</span>
<span class="o">--&gt;</span> <span class="mi">246</span>   <span class="k">return</span> <span class="n">div_p</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="mi">247</span>
    <span class="mi">248</span> <span class="k">def</span> <span class="nf">rem</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>

 <span class="o">...</span> <span class="n">stack</span> <span class="n">trace</span> <span class="o">...</span>
</pre></div>
</div>
<p>When this code sees a nan in the output of an <code class="docutils literal notranslate"><span class="pre">@jit</span></code> function, it calls into the de-optimized code, so we still get a clear stack trace. And we can run a post-mortem debugger with <code class="docutils literal notranslate"><span class="pre">%debug</span></code> to inspect all the values to figure out the error.</p>
<p>⚠️ You shouldn’t have the NaN-checker on if you’re not debugging, as it can introduce lots of device-host round-trips and performance regressions!</p>
<p>⚠️ The NaN-checker doesn’t work with <code class="docutils literal notranslate"><span class="pre">pmap</span></code>. To debug nans in <code class="docutils literal notranslate"><span class="pre">pmap</span></code> code, one thing to try is replacing <code class="docutils literal notranslate"><span class="pre">pmap</span></code> with <code class="docutils literal notranslate"><span class="pre">vmap</span></code>.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Double (64bit) precision"></a><section id="double-64bit-precision">
<h2>🔪 Double (64bit) precision<a class="headerlink" href="#double-64bit-precision" title="Permalink to this headline">#</a></h2>
<p>At the moment, JAX by default enforces single-precision numbers to mitigate the Numpy API’s tendency to aggressively promote operands to <code class="docutils literal notranslate"><span class="pre">double</span></code>.  This is the desired behavior for many machine-learning applications, but it may catch you by surprise!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('float32')
</pre></div>
</div>
</div>
</div>
<p>To use double-precision numbers, you need to set the <code class="docutils literal notranslate"><span class="pre">jax_enable_x64</span></code> configuration variable <strong>at startup</strong>.</p>
<p>There are a few ways to do this:</p>
<ol class="arabic">
<li><p>You can enable 64bit mode by setting the environment variable <code class="docutils literal notranslate"><span class="pre">JAX_ENABLE_X64=True</span></code>.</p></li>
<li><p>You can manually set the <code class="docutils literal notranslate"><span class="pre">jax_enable_x64</span></code> configuration flag at startup:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># again, this only works on startup!</span>
<span class="kn">from</span> <span class="nn">jax.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">"jax_enable_x64"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>You can parse command-line flags with <code class="docutils literal notranslate"><span class="pre">absl.app.run(main)</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="n">config</span><span class="o">.</span><span class="n">config_with_absl</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>If you want JAX to run absl parsing for you, i.e. you don’t want to do <code class="docutils literal notranslate"><span class="pre">absl.app.run(main)</span></code>, you can instead use</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
  <span class="c1"># calls config.config_with_absl() *and* runs absl parsing</span>
  <span class="n">config</span><span class="o">.</span><span class="n">parse_flags_with_absl</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
<p>Note that #2-#4 work for <em>any</em> of JAX’s configuration options.</p>
<p>We can then confirm that <code class="docutils literal notranslate"><span class="pre">x64</span></code> mode is enabled:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="c1"># --&gt; dtype('float64')</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('float32')
</pre></div>
</div>
</div>
</div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Caveats"></a><section id="caveats">
<h3>Caveats<a class="headerlink" href="#caveats" title="Permalink to this headline">#</a></h3>
<p>⚠️ XLA doesn’t support 64-bit convolutions on all backends!</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/🔪 Miscellaneous Divergences from NumPy"></a><section id="miscellaneous-divergences-from-numpy">
<h2>🔪 Miscellaneous Divergences from NumPy<a class="headerlink" href="#miscellaneous-divergences-from-numpy" title="Permalink to this headline">#</a></h2>
<p>While <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> makes every attempt to replicate the behavior of numpy’s API, there do exist corner cases where the behaviors differ.
Many such cases are discussed in detail in the sections above; here we list several other known places where the APIs diverge.</p>
<ul>
<li><p>For binary operations, JAX’s type promotion rules differ somewhat from those used by NumPy. See <a class="reference external" href="https://jax.readthedocs.io/en/latest/type_promotion.html">Type Promotion Semantics</a> for more details.</p></li>
<li><p>When performing unsafe type casts (i.e. casts in which the target dtype cannot represent the input value), JAX’s behavior may be backend dependent, and in general may diverge from NumPy’s behavior. Numpy allows control over the result in these scenarios via the <code class="docutils literal notranslate"><span class="pre">casting</span></code> argument (see <a class="reference external" href="https://numpy.org/devdocs/reference/generated/numpy.ndarray.astype.html"><code class="docutils literal notranslate"><span class="pre">np.ndarray.astype</span></code></a>); JAX does not provide any such configuration, instead directly inheriting the behavior of <a class="reference external" href="https://www.tensorflow.org/xla/operation_semantics#convertelementtype">XLA:ConvertElementType</a>.</p>
<p>Here is an example of an unsafe cast with differing results between NumPy and JAX:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">254.0</span><span class="p">,</span> <span class="mf">258.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'uint8'</span><span class="p">)</span>                                                
<span class="go">array([254, 255,   0,   1], dtype=uint8)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">254.0</span><span class="p">,</span> <span class="mf">258.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'uint8'</span><span class="p">)</span>                                               
<span class="go">DeviceArray([254, 255, 255, 255], dtype=uint8)</span>
</pre></div>
</div>
<p>This sort of mismatch would typically arise when casting extreme values from floating to integer types or vice versa.</p>
</li>
</ul>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Fin."></a><section id="fin">
<h2>Fin.<a class="headerlink" href="#fin" title="Permalink to this headline">#</a></h2>
<p>If something’s not covered here that has caused you weeping and gnashing of teeth, please let us know and we’ll extend these introductory <em>advisos</em>!</p>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="thinking_in_jax.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">How to Think in JAX</p>
</div>
</a>
<a class="right-next" href="../jax-101/index.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Tutorial: JAX 101</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>