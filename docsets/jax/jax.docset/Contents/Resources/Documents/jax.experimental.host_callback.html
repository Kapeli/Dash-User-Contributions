
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>jax.experimental.host_callback module — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="_static/pygments.css" rel="stylesheet" type="text/css">
<link href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
<script src="_static/jquery.js"></script>
<script src="_static/underscore.js"></script>
<script src="_static/doctools.js"></script>
<script src="_static/clipboard.min.js"></script>
<script src="_static/copybutton.js"></script>
<script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="_static/favicon.png" rel="shortcut icon">
<link href="genindex.html" rel="index" title="Index"/>
<link href="search.html" rel="search" title="Search"/>
<link href="_autosummary/jax.experimental.host_callback.id_tap.html" rel="next" title="jax.experimental.host_callback.id_tap"/>
<link href="jax.experimental.global_device_array.html" rel="prev" title="jax.experimental.global_device_array module"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="_static/jax_logo_250px.png"/>
</a>
</div><form action="search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="jep/263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="jax.html">
   Public API: jax package
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 current active has-children">
<a class="reference internal" href="jax.experimental.html">
     jax.experimental package
    </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l3">
<a class="reference internal" href="jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3 current active">
<a class="current reference internal" href="#">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="_sources/jax.experimental.host_callback.rst.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.rst</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-call-to-call-a-host-function-and-return-results-to-device">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     call()
    </span>
</code>
   to call a host function and return results to device
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-id-tap-to-call-a-python-function-on-the-host-with-no-returned-values">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     id_tap()
    </span>
</code>
   to call a Python function on the host, with no returned values
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-barrier-wait-to-wait-until-all-callbacks-have-executed">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     barrier_wait()
    </span>
</code>
   to wait until all callbacks have executed
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#behavior-under-parallelization-transformations">
   Behavior under parallelization transformations
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#behavior-under-jax-autodiff-transformations">
   Behavior under JAX autodiff transformations
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#behavior-under-jax-vmap">
   Behavior under jax.vmap
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-call-to-call-a-tensorflow-function-with-reverse-mode-autodiff-support">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     call()
    </span>
</code>
   to call a TensorFlow function, with reverse-mode autodiff support
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-call-to-call-a-jax-function-on-another-device-with-reverse-mode-autodiff-support">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     call()
    </span>
</code>
   to call a JAX function on another device, with reverse-mode autodiff support
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#low-level-details-and-debugging">
   Low-level details and debugging
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#api">
   API
  </a>
<ul class="simple visible nav section-nav flex-column">
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<a class="dashAnchor" name="//apple_ref/cpp/Module/jax.experimental.host_callback"></a><h1>jax.experimental.host_callback module</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-call-to-call-a-host-function-and-return-results-to-device">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     call()
    </span>
</code>
   to call a host function and return results to device
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-id-tap-to-call-a-python-function-on-the-host-with-no-returned-values">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     id_tap()
    </span>
</code>
   to call a Python function on the host, with no returned values
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-barrier-wait-to-wait-until-all-callbacks-have-executed">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     barrier_wait()
    </span>
</code>
   to wait until all callbacks have executed
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#behavior-under-parallelization-transformations">
   Behavior under parallelization transformations
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#behavior-under-jax-autodiff-transformations">
   Behavior under JAX autodiff transformations
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#behavior-under-jax-vmap">
   Behavior under jax.vmap
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-call-to-call-a-tensorflow-function-with-reverse-mode-autodiff-support">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     call()
    </span>
</code>
   to call a TensorFlow function, with reverse-mode autodiff support
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-call-to-call-a-jax-function-on-another-device-with-reverse-mode-autodiff-support">
   Using
   <code class="xref py py-func docutils literal notranslate">
<span class="pre">
     call()
    </span>
</code>
   to call a JAX function on another device, with reverse-mode autodiff support
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#low-level-details-and-debugging">
   Low-level details and debugging
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#api">
   API
  </a>
<ul class="simple visible nav section-nav flex-column">
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<section id="module-jax.experimental.host_callback">
<span id="jax-experimental-host-callback-module"></span><h1>jax.experimental.host_callback module<a class="headerlink" href="#module-jax.experimental.host_callback" title="Permalink to this headline">#</a></h1>
<p>Primitives for calling Python functions on the host from JAX accelerator code.</p>
<p><strong>Experimental: please give feedback, and expect changes.</strong></p>
<p>This module introduces the host callback functions <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>,
<a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a>, and <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a>, that send their arguments from the device
to the host and invoke user-defined Python functions on the host, optionally
returning results back to the device computation.</p>
<p>We show below how these functions can be used. We start with <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>,
and we discuss examples of calling from JAX to arbitrary Python functions
on the CPU, e.g., to use NumPy CPU custom kernels. Then we
show uses of <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> and <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a>, which have the restriction
that they cannot return values from the host to the device.
These primitives are generally faster
because they are executed asynchronously with the device code.
In particular, they can be used to tap into and to debug JAX code.</p>
<section id="using-call-to-call-a-host-function-and-return-results-to-device">
<h2>Using <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> to call a host function and return results to device<a class="headerlink" href="#using-call-to-call-a-host-function-and-return-results-to-device" title="Permalink to this headline">#</a></h2>
<p>Use <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> to invoke a computation on the host and return
NumPy arrays to the device computation.
Host computation is useful, e.g., when a device computation needs some data
that requires I/O on the host, or it needs a library that is available on the
host and you do not want to code it in JAX.
For example, eigen decomposition for general matrices in JAX does not work on TPU.
We can call the Numpy implementation from any JAX accelerator computation,
using a host computation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This function runs on the host</span>
<span class="k">def</span> <span class="nf">host_eig</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1"># This function is used in JAX</span>
<span class="k">def</span> <span class="nf">device_fun</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
  <span class="c1"># We send "m" to the host, asking it to call "host_eig" and return the result.</span>
  <span class="c1"># We have to specify the result shape and dtype, either in the form of an</span>
  <span class="c1"># example return value or any object that has `shape` and `dtype` attributes,</span>
  <span class="c1"># e.g., a NumPy array or a `jax.ShapeDtypeStruct`.</span>
  <span class="k">return</span> <span class="n">hcb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">host_eig</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
                  <span class="c1"># Given an input of shape (..., d, d), eig output has shape (..., d)</span>
                  <span class="n">result_shape</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> function and the Python host function both take a single argument
and return a single result, but those can be pytrees. Note that we must tell
the <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> what shape and dtype to expect from the host invocation, using
the <code class="docutils literal notranslate"><span class="pre">result_shape</span></code> keyword argument.
This is important because the device code is compiled with that expectation.
There will be an error raised at runtime if the actual invocation produces a
different result shape. In general, <strong>such errors and also exceptions raised
by the host computation may be difficult to debug</strong>. See the Debugging section
below.
This is a problem for <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> but not for <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> because for the
latter the decice code does not expect a returned value.</p>
<p>The <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> API can be used inside a jit or pmap computation or inside
cond/scan/while control flow. When used inside <a class="reference internal" href="_autosummary/jax.pmap.html#jax.pmap" title="jax.pmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.pmap()</span></code></a>, there will be
separate calls to the host from each of the participating devices:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">host_sin</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
  <span class="c1"># The ``device`` argument is passed due to ``call_with_device=True`` below.</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Invoking host_sin with </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># Use pmap to run the computation on two devices</span>
<span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hcb</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">host_sin</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span>
                            <span class="n">result_shape</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                            <span class="c1"># Ask that the `host_sin` function be passed `device=dev`</span>
                            <span class="n">call_with_device</span><span class="o">=</span><span class="kc">True</span><span class="p">))(</span>
         <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

<span class="c1"># prints (in arbitrary order)</span>
<span class="c1"># Invoking host_sin with (4,) on cpu:0</span>
<span class="c1"># Invoking host_sin with (4,) on cpu:1</span>
</pre></div>
</div>
<p>Note that <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> does not support any JAX transformations, but as we
show below one can make use of the
existing support for <a class="reference external" href="https://jax.readthedocs.io/en/latest/notebooks/Custom_derivative_rules_for_Python_code.html">Custom differentiation in JAX</a>.</p>
</section>
<section id="using-id-tap-to-call-a-python-function-on-the-host-with-no-returned-values">
<h2>Using <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> to call a Python function on the host, with no returned values<a class="headerlink" href="#using-id-tap-to-call-a-python-function-on-the-host-with-no-returned-values" title="Permalink to this headline">#</a></h2>
<p>The <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> and <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a> are special cases of <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>, when
you just want the side effects of your Python callback. These functions have
the advantage that once the arguments have been sent to the host, the device
computation can proceed without waiting for the Python callback to return.
For <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> you can specify your Python callback to be called, while
<a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a> uses a built-in callback that prints the arguments to
<cite>stdout</cite> on the host.
The Python function passed
to <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> takes two positional arguments (the value tapped
from the device computation along with a <code class="docutils literal notranslate"><span class="pre">transforms</span></code> tuple,
described below). Optionally, the function may be passed a keyword argument
<code class="docutils literal notranslate"><span class="pre">device</span></code> with the Device from which the value was tapped.</p>
<p>A few examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">host_func</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">transforms</span><span class="p">):</span>
   <span class="o">...</span><span class="n">do</span> <span class="n">something</span> <span class="k">with</span> <span class="n">arg</span><span class="o">...</span>

<span class="c1"># calls host_func(2x, []) on host</span>
<span class="n">id_tap</span><span class="p">(</span><span class="n">host_func</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># calls host_func((2x, 3x), [])</span>
<span class="n">id_tap</span><span class="p">(</span><span class="n">host_func</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>  <span class="c1"># The argument can be a pytree</span>

<span class="c1"># calls host_func(2x, [], device=jax.devices()[0])</span>
<span class="n">id_tap</span><span class="p">(</span><span class="n">host_func</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">tap_with_device</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Pass the device to the tap</span>

<span class="c1"># calls host_func(2x, [], what='activation')</span>
<span class="n">id_tap</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">host_func</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s1">'activation'</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># calls host_func(dict(x=x, y=y), what='data')</span>
<span class="n">id_tap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tap</span><span class="p">,</span> <span class="n">transforms</span><span class="p">:</span> <span class="n">host_func</span><span class="p">(</span><span class="n">tap</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s1">'data'</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
<p>The above examples can all be adapted to use <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a> instead, with
the difference that <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a> prints on the host the positional argument,
along with any additional kwargs and the automatic kwarg <code class="docutils literal notranslate"><span class="pre">transforms</span></code>.</p>
</section>
<section id="using-barrier-wait-to-wait-until-all-callbacks-have-executed">
<h2>Using <a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a> to wait until all callbacks have executed<a class="headerlink" href="#using-barrier-wait-to-wait-until-all-callbacks-have-executed" title="Permalink to this headline">#</a></h2>
<p>If your Python callbacks have side-effects you may need to wait until the
computation has finished to ensure that the side-effects have been observed.
You can use the <a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a> function for that purpose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">accumulator</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">def</span> <span class="nf">host_log</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">transforms</span><span class="p">):</span>
  <span class="c1"># We just record the arguments in a list</span>
  <span class="n">accumulator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">device_fun</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
  <span class="n">id_tap</span><span class="p">(</span><span class="n">host_log</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="n">id_tap</span><span class="p">(</span><span class="n">host_log</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

<span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device_fun</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device_fun</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span>

<span class="c1"># At this point, we have started two computations, each with two</span>
<span class="c1"># taps, but they may not have yet executed.</span>
<span class="n">barrier_wait</span><span class="p">()</span>
<span class="c1"># Now we know that all the computations started before `barrier_wait`</span>
<span class="c1"># on all devices, have finished, and all the callbacks have finished</span>
<span class="c1"># executing.</span>
</pre></div>
</div>
<p>Note that <a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a> will start one
tiny computation with one tap on each of the <cite>jax.local_devices()</cite> and
will wait for all these taps to be received.</p>
<p>An alternative to using <a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a> is to just wait for the end
of the computation, if all the callbacks are <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">accumulator</span> <span class="o">=</span> <span class="n">p</span><span class="p">[]</span>
<span class="k">def</span> <span class="nf">host_log</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="c1"># We just record the arguments in a list</span>
  <span class="n">accumulator</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
  <span class="k">return</span> <span class="mf">0.</span>  <span class="c1">#  return something</span>


<span class="k">def</span> <span class="nf">device_fun</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="n">host_log</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">result_shape</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="n">host_log</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">result_shape</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">ShapeDtypeStruct</span><span class="p">((),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>  <span class="c1"># return something that uses both results</span>

<span class="n">res1</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device_fun</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">res2</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">device_fun</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">res1</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
<span class="n">res2</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="behavior-under-parallelization-transformations">
<h2>Behavior under parallelization transformations<a class="headerlink" href="#behavior-under-parallelization-transformations" title="Permalink to this headline">#</a></h2>
<p>In presence of <a class="reference internal" href="_autosummary/jax.pmap.html#jax.pmap" title="jax.pmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.pmap()</span></code></a> the code will run on multiple devices and
each device will tap its values independently.
It may be helpful to use the <code class="docutils literal notranslate"><span class="pre">tap_with_device</span></code> option for <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a>
or <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a>, so that you see which device is sending which data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">pmap</span><span class="p">(</span><span class="n">power3</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">local_devices</span><span class="p">()[:</span><span class="mi">2</span><span class="p">])(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">])</span>
<span class="c1"># device=cpu:0 what=x,x^2: (3., 9.)  # from the first device</span>
<span class="c1"># device=cpu:1 what=x,x^2: (4., 16.)  # from the second device</span>
</pre></div>
</div>
<p>When using <a class="reference internal" href="_autosummary/jax.pmap.html#jax.pmap" title="jax.pmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.pmap()</span></code></a> with multiple devices on multiple hosts, every
host will receive callbacks from all of its local devices, with an operand
that corresponds to each device slice. For a
<a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>, the callback must return to each device only the slice of the
result that pertains to the corresponding device.</p>
<p>When using the experimental <code class="xref py py-func docutils literal notranslate"><span class="pre">pjit.pjit()</span></code> the code will run on multiple
devices on different shards of the input. The current implementation of
host callbacks will ensure that a single device will collect and outfeed
the entire operand, in a single callback. The callback function is supposed
to return the entire array, which will then be sent in a single infeed to the
same device that issued the outfeed. This device is then responsible for
sending the required shards to the other devices:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">local_devices</span><span class="p">()[:</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="s2">"d"</span><span class="p">]):</span>
  <span class="n">pjit</span><span class="o">.</span><span class="n">pjit</span><span class="p">(</span><span class="n">power3</span><span class="p">,</span> <span class="n">in_axis_resources</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s2">"d"</span><span class="p">),),</span>
            <span class="n">out_axis_resources</span><span class="o">=</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="s2">"d"</span><span class="p">),))(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]))</span>

<span class="c1"># device=TPU:0 what=x,x^2: ( [3., 4.],</span>
<span class="c1">#                            [9., 16.] )</span>
</pre></div>
</div>
<p>Note that the collection of the operand on one device may result in OOM if
the operand was sharded across devices.</p>
<p>When using <code class="xref py py-func docutils literal notranslate"><span class="pre">pjit.pjit()</span></code> with multiple devices on multiple hosts, only
the host for the device 0 (w.r.t. the mesh) will receive the callback, with
the operand collected
from all participating devices on all hosts. For a <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>, the callback
must return the entire array for all devices on all hosts.</p>
</section>
<section id="behavior-under-jax-autodiff-transformations">
<h2>Behavior under JAX autodiff transformations<a class="headerlink" href="#behavior-under-jax-autodiff-transformations" title="Permalink to this headline">#</a></h2>
<p>When used under a JAX autodiff transformation, the host callback functions
operate on the primal values only. Consider the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">power3</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
  <span class="c1"># Print both 'x' and 'x^2'. Must pack as a tuple.</span>
  <span class="n">hcb</span><span class="o">.</span><span class="n">id_print</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">what</span><span class="o">=</span><span class="s2">"x,x^2"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">power3</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
</pre></div>
</div>
<p>(You can see these examples tested in <cite>host_callback_test.HostCallbackTapTest.test_tap_transforms</cite>.)</p>
<p>When used under <a class="reference internal" href="_autosummary/jax.jvp.html#jax.jvp" title="jax.jvp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jvp()</span></code></a> there will be one callback with the primal
values only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">power3</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,))</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
</pre></div>
</div>
<p>Similarly for <a class="reference internal" href="_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a>, we get a callback from the forward computation
only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">power3</span><span class="p">)(</span><span class="mf">3.</span><span class="p">)</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
</pre></div>
</div>
<p>If you want to invoke the callback on the tangents during a <a class="reference internal" href="_autosummary/jax.jvp.html#jax.jvp" title="jax.jvp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.jvp()</span></code></a>,
you can use a custom_jvp. For example, you can define a function that does
nothing interesting except that its custom_jvp will print the tangents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="k">def</span> <span class="nf">print_tangents</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="k">return</span> <span class="kc">None</span>

<span class="nd">@print_tangents</span><span class="o">.</span><span class="n">defjvp</span>
<span class="k">def</span> <span class="nf">print_tangents_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">arg_dot</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="n">hcb</span><span class="o">.</span><span class="n">id_print</span><span class="p">(</span><span class="n">arg_dot</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">"tangents"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span>
</pre></div>
</div>
<p>Then you use this function in the places where you want to tap the tangents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">power3_with_tangents</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
  <span class="c1"># Print both 'x' and 'x^2'. Must pack as a tuple.</span>
  <span class="n">hcb</span><span class="o">.</span><span class="n">id_print</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">what</span><span class="o">=</span><span class="s2">"x,x^2"</span><span class="p">)</span>
  <span class="n">print_tangents</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">jax</span><span class="o">.</span><span class="n">jvp</span><span class="p">(</span><span class="n">power3_with_tangents</span><span class="p">,</span> <span class="p">(</span><span class="mf">3.</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,))</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
<span class="c1"># what: tangents : (0.1, 0.6)</span>
</pre></div>
</div>
<p>You can do a similar thing for the cotangents during <a class="reference internal" href="_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.grad()</span></code></a>. This
time you must be careful to use in the rest of the computation the values whose
cotangents you want to tap. Hence we make the <code class="docutils literal notranslate"><span class="pre">print_cotangents</span></code> return
its argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">custom_vjp</span>
<span class="k">def</span> <span class="nf">print_cotangents</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="c1"># Must return the argument for which we want the cotangent.</span>
  <span class="k">return</span> <span class="n">arg</span>

<span class="c1"># f_fwd: a -&gt; (b, residual)</span>
<span class="k">def</span> <span class="nf">print_cotangents_fwd</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">print_cotangents</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="kc">None</span>
<span class="c1"># f_bwd: (residual, CT b) -&gt; [CT a]</span>
<span class="k">def</span> <span class="nf">print_cotangents_bwd</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="n">ct_b</span><span class="p">):</span>
  <span class="n">hcb</span><span class="o">.</span><span class="n">id_print</span><span class="p">(</span><span class="n">ct_b</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">"cotangents"</span><span class="p">,</span> <span class="n">output_stream</span><span class="o">=</span><span class="n">testing_stream</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">ct_b</span><span class="p">,</span>

<span class="n">print_cotangents</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">print_cotangents_fwd</span><span class="p">,</span> <span class="n">print_cotangents_bwd</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">power3_with_cotangents</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
  <span class="c1"># Print both 'x' and 'x^2'. Must pack as a tuple.</span>
  <span class="n">hcb</span><span class="o">.</span><span class="n">id_print</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">what</span><span class="o">=</span><span class="s2">"x,x^2"</span><span class="p">,</span> <span class="n">output_stream</span><span class="o">=</span><span class="n">testing_stream</span><span class="p">)</span>
  <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="n">print_cotangents</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
  <span class="c1"># Must use the output of print_cotangents</span>
  <span class="k">return</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">x1</span>

<span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">power3_with_cotangents</span><span class="p">)(</span><span class="mf">3.</span><span class="p">)</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
<span class="c1"># what: cotangents : (9., 3.)</span>
</pre></div>
</div>
<p>If you use <code class="xref py py-func docutils literal notranslate"><span class="pre">ad_checkpoint.checkpoint()</span></code> to rematerialize the residuals
for the backward pass, then the callbacks from the primal computation will
be called twice:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">power3</span><span class="p">(</span><span class="n">ad_checkpoint</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="n">power3</span><span class="p">)(</span><span class="n">x</span><span class="p">)))(</span><span class="mf">3.</span><span class="p">)</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
<span class="c1"># what: x,x^2 : (27., 729.)</span>
<span class="c1"># what: x,x^2 : (3., 9.)</span>
</pre></div>
</div>
<p>The callbacks are, in order from: the primal computation of the inner <code class="docutils literal notranslate"><span class="pre">power3</span></code>,
the primal computation of the outer <code class="docutils literal notranslate"><span class="pre">power3</span></code>, and the rematerialization
of the residuals for the inner <code class="docutils literal notranslate"><span class="pre">power3</span></code>.</p>
</section>
<section id="behavior-under-jax-vmap">
<h2>Behavior under jax.vmap<a class="headerlink" href="#behavior-under-jax-vmap" title="Permalink to this headline">#</a></h2>
<p>The host callback functions <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a> and <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> support the
vectorization transformation <a class="reference internal" href="_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a>.</p>
<p>For <a class="reference internal" href="_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.vmap()</span></code></a> the arguments to the callback are batched,
and the callback function is
passed an additional special <code class="docutils literal notranslate"><span class="pre">transforms</span></code> containing a list of transformation descriptors
in the form <code class="docutils literal notranslate"><span class="pre">("batch",</span> <span class="pre">{"batch_dims":</span> <span class="pre">...})</span></code>, where <code class="docutils literal notranslate"><span class="pre">...`</span></code> denotes the
batched dimensions for the tapped values (one entry per argument, `
<cite>None`</cite> denotes an argument that was broadcast).</p>
<blockquote>
<div><p>jax.vmap(power3)(np.array([2., 3.]))
# transforms: [(‘batch’, {‘batch_dims’: (0, 0)})] what: x,x^2 : ([2., 3.], [4., 9.])</p>
</div></blockquote>
<p>See documentation for <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a>, <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_print()</span></code></a>, and <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>.</p>
<p>For more usage example, see tests/host_callback_test.py.</p>
</section>
<section id="using-call-to-call-a-tensorflow-function-with-reverse-mode-autodiff-support">
<h2>Using <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> to call a TensorFlow function, with reverse-mode autodiff support<a class="headerlink" href="#using-call-to-call-a-tensorflow-function-with-reverse-mode-autodiff-support" title="Permalink to this headline">#</a></h2>
<p>Another possible use for host computation is to invoke a library written for
another framework, such as TensorFlow.
In this case it becomes interesting to support JAX autodiff for host callbacks
by deferring to the autodiff mechanism in TensorFlow,
using the <a class="reference internal" href="_autosummary/jax.custom_vjp.html#jax.custom_vjp" title="jax.custom_vjp"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.custom_vjp()</span></code></a> mechanism.</p>
<p>This is relatively easy to do, once one understands both the JAX custom VJP
and the TensorFlow autodiff mechanisms.
The code for how this can be done is shown in the <code class="docutils literal notranslate"><span class="pre">call_tf_full_ad</span></code>
function in <a class="reference external" href="https://github.com/google/jax/blob/main/tests/host_callback_to_tf_test.py">host_callback_to_tf_test.py</a>.
This example supports arbitrary higher-order differentiation as well.</p>
<p>Note that if you just want to call TensorFlow functions from JAX, you can also
use the <a class="reference external" href="https://github.com/google/jax/blob/main/jax/experimental/jax2tf/call_tf.py">jax2tf.call_tf function</a>.</p>
</section>
<section id="using-call-to-call-a-jax-function-on-another-device-with-reverse-mode-autodiff-support">
<h2>Using <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a> to call a JAX function on another device, with reverse-mode autodiff support<a class="headerlink" href="#using-call-to-call-a-jax-function-on-another-device-with-reverse-mode-autodiff-support" title="Permalink to this headline">#</a></h2>
<p>It should not be surprising that we can use host computation to invoke a JAX
computation on another device. The arguments are sent from the accelerator to
the host, and then to the outside device on which the JAX host
computation will run, and then the results are sent back to the original accelerator.</p>
<p>The code for how this can be done is shown in the <code class="docutils literal notranslate"><span class="pre">call_jax_other_device</span> <span class="pre">function</span></code>
in <a class="reference external" href="https://github.com/google/jax/blob/main/tests/host_callback_test.py">host_callback_test.py</a>.</p>
</section>
<section id="low-level-details-and-debugging">
<h2>Low-level details and debugging<a class="headerlink" href="#low-level-details-and-debugging" title="Permalink to this headline">#</a></h2>
<p>The host callback functions will be executed for each device in the order in
which the send operations were performed on the device.</p>
<p>The host callback functions for multiple devices may be interleaved.
The data from the devices is received by separate threads managed by the JAX
runtime (one thread per device). The runtime maintains a buffer of
configurable size (see the flag <code class="docutils literal notranslate"><span class="pre">--jax_host_callback_max_queue_byte_size</span></code>).
When the buffer is full, all the receiving threads are paused
which eventually pauses the computation on devices. The runtime has one
additional thread for each device to invoke the Python user functions with the
received data. If the processing of the callbacks is slow, it may actually
lead to the runtime buffer filling up, and eventually pausing the computation
on the devices when they need to send something.
For more details on the outfeed receiver runtime mechanism see
<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/compiler/xla/python/outfeed_receiver.cc">runtime code</a>.</p>
<p>In order to pause the execution until all data from computations already
started on devices has arrived and has been processed, use <a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a>.</p>
<p>Exceptions from the user-defined callback functions are logged along with their
stack traces, but the receiving threads are not stopped. Instead the last
exception is recorded and the subsequent <a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a> will
raise <a class="reference internal" href="_autosummary/jax.experimental.host_callback.CallbackException.html#jax.experimental.host_callback.CallbackException" title="jax.experimental.host_callback.CallbackException"><code class="xref py py-exc docutils literal notranslate"><span class="pre">CallbackException</span></code></a> if any exception had occurred
in one of the tap functions. This exception will include the text and the
stack trace of the last exception encountered.</p>
<p>One further complication arises for callback functions that must return
results to the call origin device, such as <a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">call()</span></code></a>. This is handled
differently on CPU/GPU devices compared to TPU devices.</p>
<p>On CPU/GPU devices, in order to avoid the device computation
being stuck waiting for a result that will never arrive, in case of any
error during the processing of the callback (whether raised by the user-code
itself or due to a mismatch of the returned value and the expected return_shape)
we send the device a “fake” result of shape <code class="docutils literal notranslate"><span class="pre">int8[12345]</span></code>.
This will make the device
computation abort because the received data is different than the one that
it expects. On CPU the runtime will crash with a distinctive error message:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">Check</span> <span class="pre">failed:</span> <span class="pre">buffer-&gt;length()</span> <span class="pre">==</span> <span class="pre">buffer_length</span> <span class="pre">(12345</span> <span class="pre">vs.</span> <span class="pre">...)</span>
<span class="pre">`</span></code></p>
<p>On GPU, the failure is more user-friendly and will be surfaced to the Python
program as:</p>
<p><code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">RET_CHECK</span> <span class="pre">failure</span> <span class="pre">...</span> <span class="pre">Mismatch</span> <span class="pre">between</span> <span class="pre">infeed</span> <span class="pre">source</span> <span class="pre">buffer</span> <span class="pre">shape</span> <span class="pre">s8[12345]</span> <span class="pre">...</span>
<span class="pre">`</span></code></p>
<p>To debug the underlying cause for these messages, see the Debugging section.</p>
<p>On TPU devices, there is currently no shape check for infeed, so we take the
safer route of not sending this fake result in case of errors. This means
that the computation will hang, and no exception will be raised (but any
exceptions in the callback functions will still appear in the logs).</p>
<p>The current implementation uses the outfeed mechanism provided by XLA. The
mechanism itself is quite primitive in the sense that a receiver must know
exactly the shape of each incoming packet, and how many packets are expected.
This makes it hard to use for multiple kinds of data in the same computation,
and it is practically impossible to use it under conditionals or in loops
of non-constant iteration count. Furthermore, code that uses the outfeed
mechanism directly cannot be transformed by JAX. All these limitations are
addressed by the host callback functions. The tapping API introduced here
makes it easy to share the outfeed mechanism for multiple purposes, while
supporting all transformations.</p>
<p><strong>Note that after you have used the host callback functions, you cannot
use lax.outfeed directly</strong>. You may want to <code class="xref py py-func docutils literal notranslate"><span class="pre">stop_outfeed_receiver()</span></code>
if you later need to use lax.outfeed.</p>
<p>Since the actual calls to your callback functions are made from the C++
receiver, it may be hard to debug the calls. In particular, the stack trace
will not include the calling code. You can use the flag
<code class="docutils literal notranslate"><span class="pre">jax_host_callback_inline</span></code> (or the environment variable
<code class="docutils literal notranslate"><span class="pre">JAX_HOST_CALLBACK_INLINE</span></code>) to ensure that the calls to the callbacks are
inlined. This works only if the calls are outside a staging context (<code class="docutils literal notranslate"><span class="pre">jit</span></code>
or a control-flow primitive).</p>
<p>The C++ <a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/compiler/xla/python/outfeed_receiver.cc">receiver</a>
is started automatically on the first call to <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a>. In order to stop
it properly, upon start an <code class="docutils literal notranslate"><span class="pre">atexit</span></code> handler is registered to call
<a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">barrier_wait()</span></code></a> with the logging name “at_exit”.</p>
<p>There are a few environment variables that you can use to turn on logging
for the C++ outfeed <a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/compiler/xla/python/outfeed_receiver.cc">receiver backend</a>.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=0</span></code>: will turn on INFO logging, needed for all below.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_VLOG_LEVEL=3</span></code>: will make all VLOG logging up to level 3 behave
like INFO logs. This may be too much, but you will see which modules are
logging relevant info, and then you can select which modules to log from.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TF_CPP_VMODULE=&lt;module_name&gt;=3</span></code> (the module name can be either C++ or
Python, without the extension).</p></li>
</ul>
</div></blockquote>
<p>You should also use the <code class="docutils literal notranslate"><span class="pre">--verbosity=2</span></code> flag so that you see the logs
from Python.</p>
<p>For example, you can try to enable logging in the <code class="docutils literal notranslate"><span class="pre">host_callback</span></code> module:
<code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=0</span> <span class="pre">TF_CPP_VMODULE=host_callback=3</span> <span class="pre">python</span> <span class="pre">tests/host_callback_test.py</span> <span class="pre">--verbosity=2</span> <span class="pre">HostCallbackIdTapTest.test_tap_jit_simple</span></code></p>
<p>If you want to enable logging in lower-level implementation modules try:
<code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=0</span> <span class="pre">TF_CPP_VMODULE=outfeed_receiver=3,host_callback=3,outfeed_receiver_py=3,outfeed_thunk=3,infeed_thunk=3,cpu_transfer_manager=3,cpu_runtime=3,xfeed_manager=3,pjrt_client=3</span> <span class="pre">python</span> <span class="pre">tests/host_callback_test.py</span> <span class="pre">--verbosity=2</span> <span class="pre">HostCallbackIdTapTest.test_tap_jit_simple</span></code></p>
<p>(For bazel tests use –test_arg=–vmodule=…</p>
<dl class="simple">
<dt>Still to do:</dt><dd><ul class="simple">
<li><p>More performance tests.</p></li>
<li><p>Explore implementation with outside compilation for TPU.</p></li>
<li><p>Explore implementation with XLA CustomCall for CPU and GPU.</p></li>
</ul>
</dd>
</dl>
</section>
<section id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">#</a></h2>
<table class="autosummary longtable table autosummary">
<colgroup>
<col style="width: 10%"/>
<col style="width: 90%"/>
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">id_tap</span></code></a>(tap_func, arg, *[, result, ...])</p></td>
<td><p>Host-callback tap primitive, like identity function with a call to <code class="docutils literal notranslate"><span class="pre">tap_func</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_print.html#jax.experimental.host_callback.id_print" title="jax.experimental.host_callback.id_print"><code class="xref py py-obj docutils literal notranslate"><span class="pre">id_print</span></code></a>(arg, *[, result, tap_with_device, ...])</p></td>
<td><p>Like <a class="reference internal" href="_autosummary/jax.experimental.host_callback.id_tap.html#jax.experimental.host_callback.id_tap" title="jax.experimental.host_callback.id_tap"><code class="xref py py-func docutils literal notranslate"><span class="pre">id_tap()</span></code></a> with a printing tap function.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="_autosummary/jax.experimental.host_callback.call.html#jax.experimental.host_callback.call" title="jax.experimental.host_callback.call"><code class="xref py py-obj docutils literal notranslate"><span class="pre">call</span></code></a>(callback_func, arg, *[, result_shape, ...])</p></td>
<td><p>Make a call to the host, and expect a result.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="_autosummary/jax.experimental.host_callback.barrier_wait.html#jax.experimental.host_callback.barrier_wait" title="jax.experimental.host_callback.barrier_wait"><code class="xref py py-obj docutils literal notranslate"><span class="pre">barrier_wait</span></code></a>([logging_name])</p></td>
<td><p>Blocks the calling thread until all current outfeed is processed.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="_autosummary/jax.experimental.host_callback.CallbackException.html#jax.experimental.host_callback.CallbackException" title="jax.experimental.host_callback.CallbackException"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CallbackException</span></code></a></p></td>
<td><p>Signals that some callback function had exceptions.</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="jax.experimental.global_device_array.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">jax.experimental.global_device_array module</p>
</div>
</a>
<a class="right-next" href="_autosummary/jax.experimental.host_callback.id_tap.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">jax.experimental.host_callback.id_tap</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>