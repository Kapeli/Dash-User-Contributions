
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Type Annotation Roadmap for JAX â€” JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="../jax.html" rel="next" title="Public API: jax package"/>
<link href="11830-new-remat-checkpoint.html" rel="prev" title="jax.remat / jax.checkpoint changes: what you need to know"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   ðŸ”ª JAX - The Sharp Bits ðŸ”ª
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jep/12049-type-annotations.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#background">
   Background
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#why-type-annotations">
   Why type annotations?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#level-1-annotations-as-documentation">
     Level 1: Annotations as documentation
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#level-2-annotations-for-intelligent-autocomplete">
     Level 2: Annotations for intelligent autocomplete
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#level-3-annotations-for-static-type-checking">
     Level 3: Annotations for static type-checking
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#type-annotation-challenges-for-jax">
   Type annotation challenges for JAX
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-1-pytype-mypy-and-developer-friction">
     Challenge 1: pytype, mypy and developer friction
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-2-array-duck-typing">
     Challenge 2: array duck-typing
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-3-transformations-and-decorators">
     Challenge 3: transformations and decorators
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-4-array-annotation-lack-of-granularity">
     Challenge 4: array annotation lack of granularity
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-5-imprecise-apis-inherited-from-numpy">
     Challenge 5: imprecise APIs inherited from NumPy
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-type-annotation-roadmap">
   JAX type annotation roadmap
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#guiding-principles">
     Guiding Principles
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#purpose-of-type-annotations">
       Purpose of type annotations
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#annotate-for-intent">
       Annotate for intent
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#inputs-should-be-permissively-typed">
       Inputs should be permissively-typed
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#outputs-should-be-strictly-typed">
       Outputs should be strictly-typed
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#err-toward-simplicity">
       Err toward simplicity
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#avoid-unstable-typing-mechanisms">
       Avoid unstable typing mechanisms
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#array-type-design-considerations">
<code class="docutils literal notranslate">
<span class="pre">
       Array
      </span>
</code>
     Type Design Considerations
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#static-type-annotations">
       Static type annotations
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#runtime-instance-checks">
       Runtime instance checks
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#following-numpy-s-lead">
       Following NumPyâ€™s lead
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#unifying-instance-checks-and-annotation">
       Unifying instance checks and annotation
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-1-partial-unification">
         Option 1: Partial unification
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-2-full-unification-via-overrides">
         Option 2: Full unification via overrides
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-3-full-unification-via-class-hierarchy">
         Option 3: Full unification via class hierarchy
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-4-parial-unification-via-class-hierarchy">
         Option 4: Parial unification via class hierarchy
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#evaluation">
         Evaluation
        </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#implementation-plan">
     Implementation Plan
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Type Annotation Roadmap for JAX</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#background">
   Background
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#why-type-annotations">
   Why type annotations?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#level-1-annotations-as-documentation">
     Level 1: Annotations as documentation
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#level-2-annotations-for-intelligent-autocomplete">
     Level 2: Annotations for intelligent autocomplete
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#level-3-annotations-for-static-type-checking">
     Level 3: Annotations for static type-checking
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#type-annotation-challenges-for-jax">
   Type annotation challenges for JAX
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-1-pytype-mypy-and-developer-friction">
     Challenge 1: pytype, mypy and developer friction
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-2-array-duck-typing">
     Challenge 2: array duck-typing
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-3-transformations-and-decorators">
     Challenge 3: transformations and decorators
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-4-array-annotation-lack-of-granularity">
     Challenge 4: array annotation lack of granularity
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#challenge-5-imprecise-apis-inherited-from-numpy">
     Challenge 5: imprecise APIs inherited from NumPy
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-type-annotation-roadmap">
   JAX type annotation roadmap
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#guiding-principles">
     Guiding Principles
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#purpose-of-type-annotations">
       Purpose of type annotations
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#annotate-for-intent">
       Annotate for intent
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#inputs-should-be-permissively-typed">
       Inputs should be permissively-typed
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#outputs-should-be-strictly-typed">
       Outputs should be strictly-typed
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#err-toward-simplicity">
       Err toward simplicity
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#avoid-unstable-typing-mechanisms">
       Avoid unstable typing mechanisms
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#array-type-design-considerations">
<code class="docutils literal notranslate">
<span class="pre">
       Array
      </span>
</code>
     Type Design Considerations
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#static-type-annotations">
       Static type annotations
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#runtime-instance-checks">
       Runtime instance checks
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#following-numpy-s-lead">
       Following NumPyâ€™s lead
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#unifying-instance-checks-and-annotation">
       Unifying instance checks and annotation
      </a>
<ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-1-partial-unification">
         Option 1: Partial unification
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-2-full-unification-via-overrides">
         Option 2: Full unification via overrides
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-3-full-unification-via-class-hierarchy">
         Option 3: Full unification via class hierarchy
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-4-parial-unification-via-class-hierarchy">
         Option 4: Parial unification via class hierarchy
        </a>
</li>
<li class="toc-h5 nav-item toc-entry">
<a class="reference internal nav-link" href="#evaluation">
         Evaluation
        </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#implementation-plan">
     Implementation Plan
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Type Annotation Roadmap for JAX"></a><section class="tex2jax_ignore mathjax_ignore" id="type-annotation-roadmap-for-jax">
<h1>Type Annotation Roadmap for JAX<a class="headerlink" href="#type-annotation-roadmap-for-jax" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p><em>Author: jakevdp</em></p></li>
<li><p><em>Date: August 2022</em></p></li>
</ul>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Background"></a><section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">#</a></h2>
<p>Python 3.0 introduced optional function annotations (<a class="reference external" href="https://peps.python.org/pep-3107/">PEP 3107</a>), which were later codified for use in static type checking around the release of Python 3.5 (<a class="reference external" href="https://peps.python.org/pep-0484/">PEP 484</a>).
To some degree, type annotations and static type checking have become an integral part of many Python development workflows, and to this end we have added annotations in a number of places throughout the JAX API.
The current state of type annotations in JAX is a bit patchwork, and efforts to add more have been hampered by more fundamental design questions.
This doc attempts to summarize those issues and generate a roadmap for the goals and non-goals of type annotations in JAX.</p>
<p>Why do we need such a roadmap? Better/more comprehensive type annotations are a frequent request from users, both internally and externally.
In addition, we frequently receive pull requests from external users (for example, <a class="reference external" href="https://github.com/google/jax/pull/9917">PR #9917</a>, <a class="reference external" href="https://github.com/google/jax/pull/10322">PR #10322</a>) seeking to improve JAXâ€™s type annotations: itâ€™s not always clear to the JAX team member reviewing the code whether such contributions are beneficial, particularly when they introduce complex Protocols to address the challenges inherent to full-fledged annotation of JAXâ€™s use of Python.
This document details JAXâ€™s goals and recommendations for type annotations within the package.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Why type annotations?"></a><section id="why-type-annotations">
<h2>Why type annotations?<a class="headerlink" href="#why-type-annotations" title="Permalink to this headline">#</a></h2>
<p>There are a number of reasons that a Python project might wish to annotate their code-base; weâ€™ll summarize them in this document as Level 1, Level 2, and Level 3.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Level 1: Annotations as documentation"></a><section id="level-1-annotations-as-documentation">
<h3>Level 1: Annotations as documentation<a class="headerlink" href="#level-1-annotations-as-documentation" title="Permalink to this headline">#</a></h3>
<p>When originally introduced in <a class="reference external" href="https://peps.python.org/pep-3107/">PEP 3107</a>, type annotations were motivated partly by the ability to use them as concise, inline documentation of function parameter types and return types. JAX has long utilized annotations in this manner; an example is the common pattern of creating type names aliased to <code class="docutils literal notranslate"><span class="pre">Any</span></code>. An example can be found in <code class="docutils literal notranslate"><span class="pre">lax/slicing.py</span></code> [<a class="reference external" href="https://github.com/google/jax/blob/2bc3e39cd9104071ee39dacac22abd51b94eb27e/jax/_src/lax/slicing.py#L47-L58">source</a>]:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Array</span> <span class="o">=</span> <span class="n">Any</span>
<span class="n">Shape</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Shape</span>

<span class="k">def</span> <span class="nf">slice</span><span class="p">(</span><span class="n">operand</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
          <span class="n">limit_indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
          <span class="n">strides</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>For the purposes of static type checking, this use of <code class="docutils literal notranslate"><span class="pre">Array</span> <span class="pre">=</span> <span class="pre">Any</span></code> for array type annotations puts no constraint on the argument values (<code class="docutils literal notranslate"><span class="pre">Any</span></code> is equivalent to no annotation at all), but it does serve as a form of useful in-code documentation for the developer.</p>
<p>For the sake of generated documentation, the name of the alias gets lost (the <a class="reference external" href="https://jax.readthedocs.io/en/latest/_autosummary/jax.lax.slice.html">HTML docs</a> for <code class="docutils literal notranslate"><span class="pre">jax.lax.slice</span></code> report operand as type <code class="docutils literal notranslate"><span class="pre">Any</span></code>), so the documentation benefit does not go beyond the source code (though we could enable some <code class="docutils literal notranslate"><span class="pre">sphinx-autodoc</span></code> options to improve this: See <a class="reference external" href="https://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html#confval-autodoc_type_aliases">autodoc_type_aliases</a>).</p>
<p>A benefit of this level of type annotation is that it is never wrong to annotate a value with <code class="docutils literal notranslate"><span class="pre">Any</span></code>, so it will provide a concrete benefit to developers and users in the form of documentation, without added complexity of satisfying the stricter needs of any particular static type checker.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Level 2: Annotations for intelligent autocomplete"></a><section id="level-2-annotations-for-intelligent-autocomplete">
<h3>Level 2: Annotations for intelligent autocomplete<a class="headerlink" href="#level-2-annotations-for-intelligent-autocomplete" title="Permalink to this headline">#</a></h3>
<p>Many modern IDEs take advantage of type annotations as inputs to <a class="reference external" href="https://en.wikipedia.org/wiki/Intelligent_code_completion">intelligent code completion</a> systems. One example of this is the <a class="reference external" href="https://marketplace.visualstudio.com/items?itemName=ms-python.vscode-pylance">Pylance</a> extension for VSCode, which uses Microsoftâ€™s <a class="reference external" href="https://github.com/microsoft/pyright">pyright</a> static type checker as a source of information for VSCodeâ€™s <a class="reference external" href="https://code.visualstudio.com/docs/editor/intellisense">IntelliSense</a> completions.</p>
<p>This use of type checking requires going further than the simple aliases used above; for example, knowing that the <code class="docutils literal notranslate"><span class="pre">slice</span></code> function returns an alias of <code class="docutils literal notranslate"><span class="pre">Any</span></code> named <code class="docutils literal notranslate"><span class="pre">Array</span></code> does not add any useful information to the code completion engine. However, were we to annotate the function with a <code class="docutils literal notranslate"><span class="pre">DeviceArray</span></code> return type, the autocomplete would know how to populate the namespace of the result, and thus be able to suggest more relevant autocompletions during the course of development.</p>
<p>JAX has begun to add this level of type annotation in a few places; one example is the <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> return type within the <code class="docutils literal notranslate"><span class="pre">jax.random</span></code> package [<a class="reference external" href="https://github.com/google/jax/blob/2bc3e39cd9104071ee39dacac22abd51b94eb27e/jax/_src/random.py#L359">source</a>]:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">KeyArray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Array</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>In this case <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> is an abstract base class that forward-declares the attributes and methods of JAX arrays (<a class="reference external" href="https://github.com/google/jax/blob/2bc3e39cd9104071ee39dacac22abd51b94eb27e/jax/_src/numpy/ndarray.py#L41">see source</a>), and so Pylance in VSCode can offer the full set of autocompletions on results from this function. Here is a screenshot showing the result:</p>
<p><img alt="VSCode Intellisense Screenshot" src="../_images/vscode-completion.png"/></p>
<p>Listed in the autocomplete field are all methods and attributes declared by the abstract <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> class.
Weâ€™ll discuss further below why it was necessary to create this abstract class rather than annotating with <code class="docutils literal notranslate"><span class="pre">DeviceArray</span></code> directly.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Level 3: Annotations for static type-checking"></a><section id="level-3-annotations-for-static-type-checking">
<h3>Level 3: Annotations for static type-checking<a class="headerlink" href="#level-3-annotations-for-static-type-checking" title="Permalink to this headline">#</a></h3>
<p>These days, static type-checking often is the first thing people think of when considering the purpose of type annotations in Python code.
While Python does not do any runtime checking of types, several mature static type checking tools exist that can do this as part of a CI test suite.
The most important ones for JAX are the following:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/python/mypy">python/mypy</a> is more or less the standard in the open Python world. JAX currently runs mypy on a subset of source files within the Github Actions CI checks.</p></li>
<li><p><a class="reference external" href="https://github.com/google/pytype">google/pytype</a> is Googleâ€™s static type checker, and projects which depend on JAX within Google frequently use this.</p></li>
<li><p><a class="reference external" href="https://github.com/microsoft/pyright">microsoft/pyright</a> is important as the static type checker used within VSCode for the Pylance completions mentioned previously.</p></li>
</ul>
<p>Full static type checking is the strictest of all the type annotation applications, because it will surface an error any time your type annotations are not precisely correct.
On the one hand, this is nice because your static type analysis may catch faulty type annotations (for example, a case where a <code class="docutils literal notranslate"><span class="pre">DeviceArray</span></code> method is missing from the <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> abstract class).</p>
<p>On the other hand, this strictness can make the type checking process very brittle in packages that often rely on duck-typing rather than strict type-safe APIs.
Youâ€™ll currently find code comments like <code class="docutils literal notranslate"><span class="pre">#type:</span> <span class="pre">ignore</span></code> (for mypy) or <code class="docutils literal notranslate"><span class="pre">#pytype:</span> <span class="pre">disable</span></code> (for pytype) peppered throughout the JAX codebase in several hundred places.
These typically represent cases where typing problems have arisen; they may be inaccuracies in JAX type annotations, or inaccuracies in the static type checkerâ€™s ability to correctly follow the control flow in the code.
On occasion, they are due to real &amp; subtle bugs in the behavior of pytype or mypy.
In rare cases, they may be due to the fact that JAX uses Python patterns that are difficult or even impossible to express in terms of Pythonâ€™s static type annotation syntax.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Type annotation challenges for JAX"></a><section id="type-annotation-challenges-for-jax">
<h2>Type annotation challenges for JAX<a class="headerlink" href="#type-annotation-challenges-for-jax" title="Permalink to this headline">#</a></h2>
<p>JAX currently has type annotations that are a mixture of different styles, and aimed at all three levels of type annotation discussed above.
Partly, this comes from the fact that JAXâ€™s source code poses a number of unique challenges for Pythonâ€™s type annotation system. Weâ€™ll outline them here.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Challenge 1: pytype, mypy and developer friction"></a><section id="challenge-1-pytype-mypy-and-developer-friction">
<h3>Challenge 1: pytype, mypy and developer friction<a class="headerlink" href="#challenge-1-pytype-mypy-and-developer-friction" title="Permalink to this headline">#</a></h3>
<p>One challenge JAX currently faces is that package development must satisfy the constraints of two different static type checking systems, <code class="docutils literal notranslate"><span class="pre">pytype</span></code> (used by internal CI and internal Google projects) and <code class="docutils literal notranslate"><span class="pre">mypy</span></code> (used by external CI and external dependencies).
Although the two type checkers have broad overlap in their behavior, each presents its own unique corner cases, as evidenced by the numerous <code class="docutils literal notranslate"><span class="pre">#type:</span> <span class="pre">ignore</span></code> and <code class="docutils literal notranslate"><span class="pre">#pytype:</span> <span class="pre">disable</span></code> statements throughout the JAX codebase.</p>
<p>This creates friction in development: internal contributors may iterate until tests pass, only to find that on export their pytype-approved code falls afoul of mypy.
For external contributors, itâ€™s often the opposite: a recent example is <a class="reference external" href="https://github.com/google/jax/issues/9596">#9596</a> which had to be rolled-back after it failed internal Google pytype checks.
Each time we move a type annotation from Level 1 (<code class="docutils literal notranslate"><span class="pre">Any</span></code> everywhere) to Level 2 or 3 (stricter annotations), it introduces more potential for such frustrating developer experiences.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Challenge 2: array duck-typing"></a><section id="challenge-2-array-duck-typing">
<h3>Challenge 2: array duck-typing<a class="headerlink" href="#challenge-2-array-duck-typing" title="Permalink to this headline">#</a></h3>
<p>One particular challenge for annotating JAX code is its heavy use of duck-typing. An input to a function marked <code class="docutils literal notranslate"><span class="pre">Array</span></code> in general could be one of many different types: a JAX <code class="docutils literal notranslate"><span class="pre">DeviceArray</span></code>, a NumPy <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code>, a NumPy scalar, a Python scalar, a Python sequence, an object with an <code class="docutils literal notranslate"><span class="pre">__array__</span></code> attribute, an object with a <code class="docutils literal notranslate"><span class="pre">__jax_array__</span></code> attribute, or any flavor of <code class="docutils literal notranslate"><span class="pre">jax.Tracer</span></code>.
For this reason, simple annotations like <code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">func(x:</span> <span class="pre">DeviceArray)</span></code> will not be sufficient, and will lead to false positives for many valid uses.
This means that type annotations for JAX functions will not be short or trivial, but we would have to effectively develop a set of JAX-specific typing extensions similar to those in the <a class="reference external" href="https://github.com/numpy/numpy/blob/main/numpy/_typing/_array_like.py"><code class="docutils literal notranslate"><span class="pre">numpy.typing</span></code> package</a>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Challenge 3: transformations and decorators"></a><section id="challenge-3-transformations-and-decorators">
<h3>Challenge 3: transformations and decorators<a class="headerlink" href="#challenge-3-transformations-and-decorators" title="Permalink to this headline">#</a></h3>
<p>JAXâ€™s Python API relies heavily on function transformations (<a class="reference internal" href="../_autosummary/jax.jit.html#jax.jit" title="jax.jit"><code class="xref py py-func docutils literal notranslate"><span class="pre">jit()</span></code></a>, <a class="reference internal" href="../_autosummary/jax.vmap.html#jax.vmap" title="jax.vmap"><code class="xref py py-func docutils literal notranslate"><span class="pre">vmap()</span></code></a>, <a class="reference internal" href="../_autosummary/jax.grad.html#jax.grad" title="jax.grad"><code class="xref py py-func docutils literal notranslate"><span class="pre">grad()</span></code></a>, etc.), and this type of API poses a particular challenge for static type analysis.
Flexible annotation for decorators has been a <a class="reference external" href="https://github.com/python/mypy/issues/1927">long-standing issue</a> in the mypy package, which was only recently resolved by the introduction of <code class="docutils literal notranslate"><span class="pre">ParamSpec</span></code>, discussed in <a class="reference external" href="https://peps.python.org/pep-0612/">PEP 612</a> and added in Python 3.10.
Because JAX follows <a class="reference external" href="https://numpy.org/neps/nep-0029-deprecation_policy.html">NEP 29</a>, it cannot rely on Python 3.10 features until sometime after mid-2024.
In the meantime, Protocols can be used as a partial solution to this (JAX added this for jit and other methods in <a class="reference external" href="https://github.com/google/jax/issues/9950">#9950</a>) and ParamSpec is possible to use via the <code class="docutils literal notranslate"><span class="pre">typing_extensions</span></code> package (a prototype is in <a class="reference external" href="https://github.com/google/jax/issues/9999">#9999</a>) though this currently reveals fundamental bugs in mypy (see <a class="reference external" href="https://github.com/python/mypy/issues/12593">python/mypy#12593</a>).
All that to say: itâ€™s not yet clear that the API of JAXâ€™s function transforms can be suitably annotated within the current constraints of Python type annotation tools.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Challenge 4: array annotation lack of granularity"></a><section id="challenge-4-array-annotation-lack-of-granularity">
<h3>Challenge 4: array annotation lack of granularity<a class="headerlink" href="#challenge-4-array-annotation-lack-of-granularity" title="Permalink to this headline">#</a></h3>
<p>Another challenge here is common to all array-oriented APIs in Python, and has been part of the JAX discussion for several years (see <a class="reference external" href="https://github.com/google/jax/issues/943">#943</a>).
Type annotations have to do with the Python class or type of an object, whereas in array-based languages often the attributes of the class are more important.
In the case of NumPy, JAX, and similar packages, often we would wish to annotate particular array shapes and data types.</p>
<p>For example, the arguments to the <code class="docutils literal notranslate"><span class="pre">jnp.linspace</span></code> function must be scalar values, but in JAX scalars are represented by zero-dimensional arrays.
So in order for annotations to not raise false positives, we must allow these arguments to be <em>arbitrary</em> arrays.
Another example is the second argument to <code class="docutils literal notranslate"><span class="pre">jax.random.choice</span></code>, which must have <code class="docutils literal notranslate"><span class="pre">dtype=int</span></code> when <code class="docutils literal notranslate"><span class="pre">shape=()</span></code>.
Python has a plan to enable type annotations with this level of granularity via Variadic Type Generics (see <a class="reference external" href="https://peps.python.org/pep-0646/">PEP 646</a>, slated for Python 3.11) but like <code class="docutils literal notranslate"><span class="pre">ParamSpec</span></code>, support for this feature will take a while to stabilize.</p>
<p>There are some third-party projects that may help in the meantime, in particular <a class="reference external" href="https://github.com/google/jaxtyping">google/jaxtyping</a>, but this uses non-standard annotations and may not be suitable for annotating the core JAX library itself.
All told, the array-type-granularity challenge is less of an issue than the other challenges, because the main effect is that array-like annotations will be less specific than they otherwise could be.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Challenge 5: imprecise APIs inherited from NumPy"></a><section id="challenge-5-imprecise-apis-inherited-from-numpy">
<h3>Challenge 5: imprecise APIs inherited from NumPy<a class="headerlink" href="#challenge-5-imprecise-apis-inherited-from-numpy" title="Permalink to this headline">#</a></h3>
<p>A large part of JAXâ€™s user-facing API is inherited from NumPy within the <a class="reference internal" href="../jax.numpy.html#module-jax.numpy" title="jax.numpy"><code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.numpy</span></code></a> submodule.
NumPyâ€™s API was developed years before static type checking became part of the Python language, and follows Pythonâ€™s historic recommendations to use a <a class="reference external" href="https://docs.python.org/3/glossary.html#term-duck-typing">duck-typing</a>/<a class="reference external" href="https://docs.python.org/3/glossary.html#term-eafp">EAFP</a> coding style, in which strict type-checking at runtime is discouraged. As a concrete example of this, consider the <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.tile.html#numpy.tile" title="(in NumPy v1.23)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.tile()</span></code></a> function, which is defined like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tile</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">reps</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">reps</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">reps</span><span class="p">,)</span>
  <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span>
  <span class="o">...</span>
</pre></div>
</div>
<p>Here the <em>intent</em> is that <code class="docutils literal notranslate"><span class="pre">reps</span></code> would contain either an <code class="docutils literal notranslate"><span class="pre">int</span></code> or a sequence of <code class="docutils literal notranslate"><span class="pre">int</span></code> values, but the <em>implementation</em> allows <code class="docutils literal notranslate"><span class="pre">tup</span></code> to be any iterable.
When adding annotations to this kind of duck-typed code, we could take one of two routes:</p>
<ol class="arabic simple">
<li><p>We may choose to annotate the <em>intent</em> of the functionâ€™s API, which here might be something like <code class="docutils literal notranslate"><span class="pre">reps:</span> <span class="pre">Union[int,</span> <span class="pre">Sequence[int]]</span></code>.</p></li>
<li><p>Conversely, we may choose to annotate the <em>implementation</em> of the function, which here might look something like <code class="docutils literal notranslate"><span class="pre">reps:</span> <span class="pre">Union[ConvertibleToInt,</span> <span class="pre">Iterable[ConvertibleToInt]]</span></code> where <code class="docutils literal notranslate"><span class="pre">ConvertibleToInt</span></code> is a special protocol that covers the exact mechanism by which our function converts the inputs to integers (i.e. via <code class="docutils literal notranslate"><span class="pre">__int__</span></code>, via <code class="docutils literal notranslate"><span class="pre">__index__</span></code>, via <code class="docutils literal notranslate"><span class="pre">__array__</span></code>, etc.). Note also here that in a strict sense, <code class="docutils literal notranslate"><span class="pre">Iterable</span></code> is not sufficient here because there are objects in Python that duck-type as iterables but do not satisfy a static type check against <code class="docutils literal notranslate"><span class="pre">Iterable</span></code> (namely, an object that is iterable via <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> rather than <code class="docutils literal notranslate"><span class="pre">__iter__</span></code>.)</p></li>
</ol>
<p>The advantage of #1, annotating intent, is that the annotations are more useful to the user in communicating the API contract; while for the developer the flexibility leaves room for refactoring when necessary. The down-side (particularly for gradually-typed APIs like JAXâ€™s) is that itâ€™s quite likely that user code exists which runs correctly, but would be flagged as incorrect by a type checker.
Gradual typing of an existing duck-typed API means that the current annotation is implicitly <code class="docutils literal notranslate"><span class="pre">Any</span></code>, so changing this to a stricter type may present to users as a breaking change.</p>
<p>Broadly speaking, annotating intent better serves Level 1 type checking, while annotating implementation better serves Level 3, while Level 2 is more of a mixed bag (both intent and implementation are important when it comes to annotations in IDEs).</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/JAX type annotation roadmap"></a><section id="jax-type-annotation-roadmap">
<h2>JAX type annotation roadmap<a class="headerlink" href="#jax-type-annotation-roadmap" title="Permalink to this headline">#</a></h2>
<p>With this framing (Level 1/2/3) and JAX-specific challenges in mind, we can begin to develop our roadmap for implementing consistent type annotations across the JAX project.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Guiding Principles"></a><section id="guiding-principles">
<h3>Guiding Principles<a class="headerlink" href="#guiding-principles" title="Permalink to this headline">#</a></h3>
<p>For JAX type annotation, we will be guided by the following principles:</p>
<section id="purpose-of-type-annotations">
<h4>Purpose of type annotations<a class="headerlink" href="#purpose-of-type-annotations" title="Permalink to this headline">#</a></h4>
<p>We would like to support full, <em>Level 1, 2, and 3</em> type annotation as far as possible. In particular, this means that we should have restrictive type annotations on both inputs and outputs to public API functions.</p>
</section>
<section id="annotate-for-intent">
<h4>Annotate for intent<a class="headerlink" href="#annotate-for-intent" title="Permalink to this headline">#</a></h4>
<p>JAX type annotations should in general indicate the <strong>intent</strong> of APIs, rather than the implementation, so that the annotations become useful to communicate the contract of the API. This means that at times inputs that are valid at runtime may not be recognized as valid by the static type checker (one example might be an arbitrary iterator passed in place of a shape that is annotated as <code class="docutils literal notranslate"><span class="pre">Shape</span> <span class="pre">=</span> <span class="pre">Sequence[int]</span></code>).</p>
</section>
<section id="inputs-should-be-permissively-typed">
<h4>Inputs should be permissively-typed<a class="headerlink" href="#inputs-should-be-permissively-typed" title="Permalink to this headline">#</a></h4>
<p>Inputs to JAX functions and methods should be typed as permissively as is reasonable: for example, while shapes are typically tuples, functions that accept a shape should accept arbitrary sequences. Similarly, functions that accept a dtype need not require an instance of class <code class="docutils literal notranslate"><span class="pre">np.dtype</span></code>, but rather any dtype-convertible object. This might include strings, built-in scalar types, or scalar object constructors such as <code class="docutils literal notranslate"><span class="pre">np.float64</span></code> and <code class="docutils literal notranslate"><span class="pre">jnp.float64</span></code>. In order to make this as uniform as possible across the package, we will add a <code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.typing</span></code> module with common type specifications, starting with broad categories such as:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ArrayLike</span></code> would be a union of anything that can be implicitly converted into an array: for example, jax arrays, numpy arrays, JAX tracers, and python or numpy scalars</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DTypeLike</span></code> would be a union of anything that can be implicitly converted into a dtype: for example, numpy dtypes, numpy dtype objects, jax dtype objects, strings, and built-in types.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ShapeLike</span></code> would be a union of anything that could be converted into a shape: for example, sequences of integer or integer-like objecs.</p></li>
<li><p>etc.</p></li>
</ul>
<p>Note that these will in general be simpler than the equivalent protocols used in <a class="reference external" href="https://numpy.org/doc/stable/reference/typing.html#module-numpy.typing" title="(in NumPy v1.23)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy.typing</span></code></a>. For example, in the case of <code class="docutils literal notranslate"><span class="pre">DTypeLike</span></code>, JAX does not support structured dtypes, so JAX can use a simpler implementation. Similarly, in <code class="docutils literal notranslate"><span class="pre">ArrayLike</span></code>, JAX generally does not support list or tuple inputs in place of arrays, so the type definition will be simpler than the NumPy analog.</p>
</section>
<section id="outputs-should-be-strictly-typed">
<h4>Outputs should be strictly-typed<a class="headerlink" href="#outputs-should-be-strictly-typed" title="Permalink to this headline">#</a></h4>
<p>Conversely, outputs of functions and methods should be typed as strictly as possible: for example, for a JAX function that returns an array, the output should be annotated with something similar to <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> rather than <code class="docutils literal notranslate"><span class="pre">ArrayLike</span></code>. Functions returning a dtype should always be annotated <code class="docutils literal notranslate"><span class="pre">np.dtype</span></code>, and functions returning a shape should always be <code class="docutils literal notranslate"><span class="pre">Tuple[int]</span></code> or a strictly-typed NamedShape equivalent. For this purpose, we will implement in <code class="xref py py-mod docutils literal notranslate"><span class="pre">jax.typing</span></code> several strictly-typed analogs of the permissive types mentioned above, namely:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Array</span></code> or <code class="docutils literal notranslate"><span class="pre">NDArray</span></code> (see below) for type annotation purposes is effectively equivalent to <code class="docutils literal notranslate"><span class="pre">Union[Tracer,</span> <span class="pre">jnp.ndarray]</span></code> and should be used to annotate array outputs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DType</span></code> is an alias of <code class="docutils literal notranslate"><span class="pre">np.dtype</span></code>, perhaps with the ability to also represent key types and other generalizations used within JAX.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Shape</span></code> is essentially <code class="docutils literal notranslate"><span class="pre">Tuple[int,</span> <span class="pre">...]</span></code>, perhaps with some additional flexibilty to account for dynamic shapes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NamedShape</span></code> is an extension of <code class="docutils literal notranslate"><span class="pre">Shape</span></code> that allows for named shapes as used internall in JAX.</p></li>
<li><p>etc.</p></li>
</ul>
<p>We will also explore whether the current implementation of <code class="docutils literal notranslate"><span class="pre">jax.numpy.ndarray</span></code> can be dropped in favor of making <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> an alias of <code class="docutils literal notranslate"><span class="pre">Array</span></code> or similar.</p>
</section>
<section id="err-toward-simplicity">
<h4>Err toward simplicity<a class="headerlink" href="#err-toward-simplicity" title="Permalink to this headline">#</a></h4>
<p>Aside from common typing protocols gathered in <code class="docutils literal notranslate"><span class="pre">jax.typing</span></code>, we should err on the side of simplicity. We should avoid constructing overly-complex protocols for arguments passed to API functions, and instead use simple unions such as <code class="docutils literal notranslate"><span class="pre">Union[simple_type,</span> <span class="pre">Any]</span></code> in the case that the full type specification of the API cannot be succinctly specified. This is a compromise that achieves the goals of Level 1 and 2 annotations, while punting on Level 3 in favor of avoiding unnecessary complexity.</p>
</section>
<section id="avoid-unstable-typing-mechanisms">
<h4>Avoid unstable typing mechanisms<a class="headerlink" href="#avoid-unstable-typing-mechanisms" title="Permalink to this headline">#</a></h4>
<p>In order to not add undue development friction (due to the internal/external CI differences), we would like to be conservative in the type annotation constructs we use: in particular, when it comes to recently-introduced mechanisms such as <code class="docutils literal notranslate"><span class="pre">ParamSpec</span></code> (<a class="reference external" href="https://peps.python.org/pep-0612/">PEP 612</a>) and Variadic Type Generics (<a class="reference external" href="https://peps.python.org/pep-0646/">PEP 646</a>), we would like to wait until support in mypy and other tools matures and stabilizes before relying on them.</p>
<p>One impact of this is that for the time being, when functions are decorated by JAX transformations like <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, <code class="docutils literal notranslate"><span class="pre">grad</span></code>, etc. JAX will effectively <strong>strip all annotations</strong> from the decorated function.
While this is unfortunate, at the time of this writing mypy has a laundry-list of incompatibilities with the potential solution offered by <code class="docutils literal notranslate"><span class="pre">ParamSpec</span></code> (see <a class="reference external" href="https://github.com/python/mypy/issues?q=is%3Aissue+is%3Aopen++label%3Atopic-paramspec+"><code class="docutils literal notranslate"><span class="pre">ParamSpec</span></code> mypy bug tracker</a>), and we therefore judge it as not ready for full adoption in JAX at this time.
We will revisit this question in the future once support for such features stabilizes.</p>
<p>Similarly, for the time being we will avoid adding the more complex &amp; granular array type annotations offered by the <a class="reference external" href="http://github.com/google/jaxtyping">jaxtyping</a> project. This is a decision we could revisit at a future date.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Array Type Design Considerations"></a><section id="array-type-design-considerations">
<h3><code class="docutils literal notranslate"><span class="pre">Array</span></code> Type Design Considerations<a class="headerlink" href="#array-type-design-considerations" title="Permalink to this headline">#</a></h3>
<p>As mentioned above, type annotation of arrays in JAX poses a unique challenge because of JAXâ€™s extensive use of duck-typing, i.e. passing and returning <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> objects in place actual arrays within jax transformations.
This becomes increasingly confusing because objects used for type annotation often overlap with objects used for runtime instance checking, and may or may not correspond to the actual type hierarchy of the objects in question.
For JAX, we need to provide duck-typed objects for use in two contexts: <strong>static type annotations</strong> and <strong>runtime instance checks</strong>.</p>
<p>The following discussion will assume that <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is the runtime type on-device arrays, which is not yet the case but will be once the work in <a class="reference external" href="https://github.com/google/jax/issues/12016">#12016</a> is complete.</p>
<section id="static-type-annotations">
<h4>Static type annotations<a class="headerlink" href="#static-type-annotations" title="Permalink to this headline">#</a></h4>
<p>We need to provide an object that can be used for duck-typed type annotations.
Assuming for the moment that we call this object <code class="docutils literal notranslate"><span class="pre">ArrayAnnotation</span></code>, we need a solution which satisfies <code class="docutils literal notranslate"><span class="pre">mypy</span></code> and <code class="docutils literal notranslate"><span class="pre">pytype</span></code> for a case like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ArrayAnnotation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ArrayAnnotation</span><span class="p">:</span>
  <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Tracer</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>This could be accomplished via a number of approaches, for example:</p>
<ul class="simple">
<li><p>Use a type union: <code class="docutils literal notranslate"><span class="pre">ArrayAnnotation</span> <span class="pre">=</span> <span class="pre">Union[Array,</span> <span class="pre">Tracer]</span></code></p></li>
<li><p>Create an interface file that declares <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> and <code class="docutils literal notranslate"><span class="pre">Array</span></code> should be treated as subclasses of <code class="docutils literal notranslate"><span class="pre">ArrayAnnotation</span></code>.</p></li>
<li><p>Restructure <code class="docutils literal notranslate"><span class="pre">Array</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> so that <code class="docutils literal notranslate"><span class="pre">ArrayAnnotation</span></code> is a true base class of both.</p></li>
</ul>
</section>
<section id="runtime-instance-checks">
<h4>Runtime instance checks<a class="headerlink" href="#runtime-instance-checks" title="Permalink to this headline">#</a></h4>
<p>We also must provide an object that can be used for duck-typed runtime <code class="docutils literal notranslate"><span class="pre">isinstance</span></code> checks.
Assuming for the moment that we call this object <code class="docutils literal notranslate"><span class="pre">ArrayInstance</span></code>, we need a solution that passes the following runtime check:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ArrayInstance</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>       <span class="c1"># x will be an array</span>
<span class="k">assert</span> <span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># x will be a tracer</span>
</pre></div>
</div>
<p>Again, there are a couple mechanisms that could be used for this:</p>
<ul class="simple">
<li><p>override <code class="docutils literal notranslate"><span class="pre">type(ArrayInstance).__instancecheck__</span></code> to return <code class="docutils literal notranslate"><span class="pre">True</span></code> for both <code class="docutils literal notranslate"><span class="pre">Array</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> objects; this is how <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> is currently implemented (<a class="reference external" href="https://github.com/google/jax/blob/jax-v0.3.17/jax/_src/numpy/ndarray.py#L24-L49">source</a>).</p></li>
<li><p>define <code class="docutils literal notranslate"><span class="pre">ArrayInstance</span></code> as an abstract base class and dynamically register it to <code class="docutils literal notranslate"><span class="pre">Array</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code></p></li>
<li><p>restructure <code class="docutils literal notranslate"><span class="pre">Array</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> so that <code class="docutils literal notranslate"><span class="pre">ArrayInstance</span></code> is a true base class of both <code class="docutils literal notranslate"><span class="pre">Array</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code></p></li>
</ul>
<p>A decision we need to make is whether <code class="docutils literal notranslate"><span class="pre">ArrayAnnotation</span></code> and <code class="docutils literal notranslate"><span class="pre">ArrayInstance</span></code> should be the same or different objects. There is some precedent here; for example in the core Python language spec, <code class="docutils literal notranslate"><span class="pre">typing.Dict</span></code> and <code class="docutils literal notranslate"><span class="pre">typing.List</span></code> exist for the sake of annotation, while the built-in <code class="docutils literal notranslate"><span class="pre">dict</span></code> and <code class="docutils literal notranslate"><span class="pre">list</span></code> serve the purposes of instance checks.
However, <code class="docutils literal notranslate"><span class="pre">Dict</span></code> and <code class="docutils literal notranslate"><span class="pre">List</span></code> are <a class="reference external" href="https://peps.python.org/pep-0585/#implementation">deprecated</a> in newer Python versions in favor of using <code class="docutils literal notranslate"><span class="pre">dict</span></code> and <code class="docutils literal notranslate"><span class="pre">list</span></code> for both annotation and instance checks.</p>
</section>
<section id="following-numpy-s-lead">
<h4>Following NumPyâ€™s lead<a class="headerlink" href="#following-numpy-s-lead" title="Permalink to this headline">#</a></h4>
<p>In NumPyâ€™s case, <code class="docutils literal notranslate"><span class="pre">np.typing.NDArray</span></code> serves the purpose of type annotations, while <code class="docutils literal notranslate"><span class="pre">np.ndarray</span></code> serves the purpose of instance checks (as well as array type identity).
Given this, it may be reasonable to conform to NumPyâ€™s precedent and implement the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is the actual type of on-device arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.typing.NDArray</span></code> is the object used for duck-typed array annotations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.numpy.ndarray</span></code> is the object used for duck-typed array instance checks.</p></li>
</ul>
<p>This might feel somewhat natural to NumPy power-users, however this trifurcation would likely be a source of confusion: the choice of which to use for instance checks and annotations is not immediately clear.</p>
</section>
<section id="unifying-instance-checks-and-annotation">
<h4>Unifying instance checks and annotation<a class="headerlink" href="#unifying-instance-checks-and-annotation" title="Permalink to this headline">#</a></h4>
<p>Another approach would be to unify type checking and annotation via override mechanisms mentioned above.</p>
<section id="option-1-partial-unification">
<h5>Option 1: Partial unification<a class="headerlink" href="#option-1-partial-unification" title="Permalink to this headline">#</a></h5>
<p>A partial unification might look like this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is the actual type of on-device arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.typing.Array</span></code> is the object used for duck-typed array annotations (via <code class="docutils literal notranslate"><span class="pre">.pyi</span></code> interfaces on <code class="docutils literal notranslate"><span class="pre">Array</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.typing.Array</span></code> is also the object used duck-typed instance checks (via an <code class="docutils literal notranslate"><span class="pre">__isinstance__</span></code> override in its metaclass)</p></li>
</ul>
<p>In this approach, <code class="docutils literal notranslate"><span class="pre">jax.numpy.ndarray</span></code> would become a simple alias <code class="docutils literal notranslate"><span class="pre">jax.typing.Array</span></code> for backward compatibility.</p>
</section>
<section id="option-2-full-unification-via-overrides">
<h5>Option 2: Full unification via overrides<a class="headerlink" href="#option-2-full-unification-via-overrides" title="Permalink to this headline">#</a></h5>
<p>Alternatively, we could opt for full unification via overrides:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is the actual type of on-device arrays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is also the object used for duck-typed array annotations (via a <code class="docutils literal notranslate"><span class="pre">.pyi</span></code> interface on <code class="docutils literal notranslate"><span class="pre">Tracer</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is also the object used for duck-typed instance checks (via an <code class="docutils literal notranslate"><span class="pre">__isinstance__</span></code> override in its metaclass)</p></li>
</ul>
<p>Here, <code class="docutils literal notranslate"><span class="pre">jax.numpy.ndarray</span></code> would become a simple alias <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> for backward compatibility.</p>
</section>
<section id="option-3-full-unification-via-class-hierarchy">
<h5>Option 3: Full unification via class hierarchy<a class="headerlink" href="#option-3-full-unification-via-class-hierarchy" title="Permalink to this headline">#</a></h5>
<p>Finally, we could opt for full unification via restructuring of the class hierarchy and replacing duck-typing with OOP object hierarchies:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is the actual type of on-device arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is also the object used for array type annotations, by ensuring that <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> inherits from <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is also the object used for instance checks, via the same mechanism</p></li>
</ul>
<p>Here <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> could be an alias for <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code>.
This final approach is in some senses the most pure, but it is somewhat forced from an OOP design standpoint (<code class="docutils literal notranslate"><span class="pre">Tracer</span></code> <em>is an</em> <code class="docutils literal notranslate"><span class="pre">Array</span></code>?).</p>
</section>
<section id="option-4-parial-unification-via-class-hierarchy">
<h5>Option 4: Parial unification via class hierarchy<a class="headerlink" href="#option-4-parial-unification-via-class-hierarchy" title="Permalink to this headline">#</a></h5>
<p>We could make the class hierarchy more sensible by making <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> and the class for
on-device arrays inherit from a common base class. So, for example:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is a base class for <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> as well as the actual type of on-device arrays,
which might be <code class="docutils literal notranslate"><span class="pre">jax._src.ArrayImpl</span></code> or similar.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is the object used for array type annotations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is also the object used for instance checks</p></li>
</ul>
<p>Here <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> would be an alias for <code class="docutils literal notranslate"><span class="pre">Array</span></code>.
This may be purer from an OOP perspective, but compared to Options 2 and 3 it drops the notion
that <code class="docutils literal notranslate"><span class="pre">type(x)</span> <span class="pre">is</span> <span class="pre">jax.Array</span></code> will evaluate to True.</p>
</section>
<section id="evaluation">
<h5>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">#</a></h5>
<p>Considering the overall strengths and weaknesses of each potential approach:</p>
<ul class="simple">
<li><p>From a user perspective, the unified approaches (options 2 and 3) are arguably best, because they remove the cognitive overhead involved in remembering which objects to use for instance checks or annotations: <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> is all you need to know.</p></li>
<li><p>However, both options 2 and 3 introduce some strange and/or confusing behavior. Option 2 depends on potentially confusing overrides of instance checks, which are <a class="reference external" href="https://github.com/pybind/pybind11/issues/2696">not well supported</a> for classes defined in pybind11. Option 3 requires <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> to be a subclass array. This breaks the inheritance model, because it would require <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> objects to carry all the baggage of <code class="docutils literal notranslate"><span class="pre">Array</span></code> objects (data buffers, sharding, devices, etc.)</p></li>
<li><p>Option 4 is purer in an OOP sense, and avoids the need for any overrides of typical instance check or type annotation behavior. The tradeoff is that the actual type of on-device arrays becomes something separate (here <code class="docutils literal notranslate"><span class="pre">jax._src.ArrayImpl</span></code>). But the vast majority of users would never have to touch this private implementation directly.</p></li>
</ul>
<p>There are different tradeoffs here, but after discussion weâ€™ve landed on Option 4 as our way forward.</p>
</section>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Implementation Plan"></a><section id="implementation-plan">
<h3>Implementation Plan<a class="headerlink" href="#implementation-plan" title="Permalink to this headline">#</a></h3>
<p>To move forward with type annotations, we will do the following:</p>
<ol class="arabic">
<li><p>Iterate on this JEP doc until developers and stakeholders are bought-in.</p></li>
<li><p>Create a private <code class="docutils literal notranslate"><span class="pre">jax._src.typing</span></code> (not providing any public APIs for now) and put in it the first level of simple types mentioned above:</p>
<ul class="simple">
<li><p>Alias <code class="docutils literal notranslate"><span class="pre">Array</span> <span class="pre">=</span> <span class="pre">Any</span></code> for the time being, as this will take a bit more thought.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ArrayLike</span></code>: a Union of types valid as inputs to normal <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> functions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DType</span></code> / <code class="docutils literal notranslate"><span class="pre">DTypeLike</span></code> (Note: numpy uses camel-cased <code class="docutils literal notranslate"><span class="pre">DType</span></code>; we should follow this convention for ease of use)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Shape</span></code> / <code class="docutils literal notranslate"><span class="pre">NamedShape</span></code> / <code class="docutils literal notranslate"><span class="pre">ShapeLike</span></code></p></li>
</ul>
<p>The beginnings of this are done in <a class="reference external" href="https://github.com/google/jax/issues/12300">#12300</a>.</p>
</li>
<li><p>Begin work on a <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> base class that follows Option 4 from the previous section. Initially this will be defined in Python, and use the dynamic registration mechanism currently found in the <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> implementation to ensure correct behavior of <code class="docutils literal notranslate"><span class="pre">isinstance</span></code> checks. A <code class="docutils literal notranslate"><span class="pre">pyi</span></code> override for each tracer and array-like class would ensure correct behavior for type annotations. <code class="docutils literal notranslate"><span class="pre">jnp.ndarray</span></code> could then be make into an alias of <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code></p></li>
<li><p>As a test, use these new typing definitions to comprehensively annotate functions within <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> according to the guidelines above.</p></li>
<li><p>Continue adding additional annotations one module at a time, focusing on public API functions.</p></li>
<li><p>In parallel, begin re-implementing a <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> base class in pybind11, so that <code class="docutils literal notranslate"><span class="pre">ArrayImpl</span></code> and <code class="docutils literal notranslate"><span class="pre">Tracer</span></code> can inherit from it. Use a <code class="docutils literal notranslate"><span class="pre">pyi</span></code> definition to ensure static type checkers recognize the appropriate attributes of the class.</p></li>
<li><p>Once <code class="docutils literal notranslate"><span class="pre">jax.Array</span></code> and <code class="docutils literal notranslate"><span class="pre">jax._src.ArrayImpl</span></code> have fully landed, remove these temporary Python implementations.</p></li>
<li><p>When all is finalized, create a public <code class="docutils literal notranslate"><span class="pre">jax.typing</span></code> module that makes the above types available to users, along with documentation of annotation best practices for code using JAX.</p></li>
</ol>
<p>We will track this work in <a class="reference external" href="https://github.com/google/jax/issues/12049">#12049</a>, from which this JEP gets its number.</p>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="11830-new-remat-checkpoint.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">jax.remat</span></code> / <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> changes: what you need to know</p>
</div>
</a>
<a class="right-next" href="../jax.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Public API: jax package</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      Â© Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>