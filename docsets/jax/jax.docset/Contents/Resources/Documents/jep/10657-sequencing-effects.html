
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Sequencing side-effects in JAX — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="11830-new-remat-checkpoint.html" rel="next" title="jax.remat / jax.checkpoint changes: what you need to know"/>
<link href="9419-jax-versioning.html" rel="prev" title="Jax and Jaxlib versioning"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jep/10657-sequencing-effects.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#overview">
   Overview
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#background">
   Background
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#motivation">
   Motivation
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#enforcing-ordered-effects">
   Enforcing ordered effects
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#runtime-tokens-vs-compiler-tokens">
   Runtime tokens vs. compiler tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#managing-runtime-tokens">
   Managing runtime tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#adding-compiler-tokens">
   Adding compiler tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#blocking-on-output-tokens">
   Blocking on output tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#some-more-details">
   Some more details
  </a>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Sequencing side-effects in JAX</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#overview">
   Overview
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#background">
   Background
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#motivation">
   Motivation
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#enforcing-ordered-effects">
   Enforcing ordered effects
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#runtime-tokens-vs-compiler-tokens">
   Runtime tokens vs. compiler tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#managing-runtime-tokens">
   Managing runtime tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#adding-compiler-tokens">
   Adding compiler tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#blocking-on-output-tokens">
   Blocking on output tokens
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#some-more-details">
   Some more details
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Sequencing side-effects in JAX"></a><section class="tex2jax_ignore mathjax_ignore" id="sequencing-side-effects-in-jax">
<h1>Sequencing side-effects in JAX<a class="headerlink" href="#sequencing-side-effects-in-jax" title="Permalink to this headline">#</a></h1>
<p><em>sharadmv@</em>
<em>May 9 2022</em></p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Overview"></a><section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h2>
<p>When we write JAX code, we can usually pretend we’re writing single-threaded, eagerly-executed Python
even though underneath the hood, JAX and its runtime may execute it asynchronously in the background.
As long as we write pure (side-effect-free) code, these performance optimizations are usually invisible to us and don’t interfere with our single-threaded mental model.
Asynchronous execution is great – we get performant, parallel code without
having to think about it at all!</p>
<p>However, in the presence of side-effects, the illusion begins to break down and
the cracks in our mental model start to show. Specifically, these differences
show up when we think about the <em>order</em> in which side-effects happen.</p>
<p>In this design note, we explore the interaction between JAX’s execution model,
and the ordering of side-effects. We also provide a way of enforcing a
“single-threaded” ordering of effects.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Background"></a><section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">#</a></h2>
<p>When we write the following Python code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">2</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">3</span>
<span class="n">f</span><span class="p">()</span>
<span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>we expect <code class="docutils literal notranslate"><span class="pre">"hello"</span></code> to be printed before <code class="docutils literal notranslate"><span class="pre">"world"</span></code>. This might seem obvious
but consider the following JAX code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="k">return</span> <span class="mi">2</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
  <span class="k">return</span> <span class="mi">3</span>
<span class="n">f</span><span class="p">()</span>
<span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>In many cases, JAX will execute <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">g</span></code> <em>in parallel</em>, dispatching
the computations onto different threads – <code class="docutils literal notranslate"><span class="pre">g</span></code> might actually be executed
before <code class="docutils literal notranslate"><span class="pre">f</span></code>. Parallel execution is a nice performance optimization, especially if copying
to and from a device is expensive (see the <a class="reference external" href="https://jax.readthedocs.io/en/latest/async_dispatch.html">asynchronous dispatch note</a> for more details).
In practice, however, we often don’t need to
think about asynchronous dispatch because we’re writing pure functions and only
care about the inputs and outputs of functions – we’ll naturally block on future
values.</p>
<p>However, now imagine that we have a <code class="docutils literal notranslate"><span class="pre">jax.print</span></code> function that works inside of
JIT-ted JAX functions (<code class="docutils literal notranslate"><span class="pre">host_callback.id_print</span></code> is an example of this). Let’s
return to the previous example except with prints in the mix.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">2</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">3</span>
<span class="n">f</span><span class="p">()</span>
<span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>Thanks to asynchronous dispatch, we could actually see <code class="docutils literal notranslate"><span class="pre">"world"</span></code> being printed
before <code class="docutils literal notranslate"><span class="pre">"hello"</span></code>. The reordering of the print side-effects breaks the illusion
of a single-threaded execution model.</p>
<p>Another example of where side-effects can “reveal” out-of-order execution is
when we we compile JAX programs. Consider the following JAX code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
<p>Even though in Python, we’ve written the <code class="docutils literal notranslate"><span class="pre">"hello"</span></code> print before the <code class="docutils literal notranslate"><span class="pre">"world"</span></code> print,
a compiler like XLA is free to reorder them because there’s no explicit data-dependence between the prints.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Motivation"></a><section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">#</a></h2>
<p>We’d like to support “ordered” effects. When we say ordered, we mean that the effects
occur in the same order as we would if we were executing a single-threaded Python program.
This is our main desideratum. In the presence of explicit parallelism like <code class="docutils literal notranslate"><span class="pre">pmap</span></code> or
user threads, we don’t need to maintain this behavior but at least if the user is not
explicitly requesting parallelism, we’d like to preserve a single-threaded ordering.</p>
<p>Before we dive in more, let’s first step back and ask ourselves if it is okay
if we reorder effects in the name of performance, and conversely, do we need to
enforce an ordering on effects at all? In some cases, we don’t need ordering.
Maybe some side-effects shouldn’t adversely affect the
performance of a JAX program. However, for other side-effects, we may
want to enforce a single-threaded program order so users don’t get counterintuitive
behavior. Consider a logging effect.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
  <span class="n">log_value</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">log_value</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">log</span></code> is mutating a global list, we might expect that we add <code class="docutils literal notranslate"><span class="pre">x</span></code> before adding <code class="docutils literal notranslate"><span class="pre">y</span></code>.
For a more strict effect, we may want the option to order the effects.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Enforcing ordered effects"></a><section id="enforcing-ordered-effects">
<h2>Enforcing ordered effects<a class="headerlink" href="#enforcing-ordered-effects" title="Permalink to this headline">#</a></h2>
<p>The main tool we have to enforce the ordering of computations is <em>data-dependence</em>.
Simply put, if a function <code class="docutils literal notranslate"><span class="pre">g</span></code> has an input that is the output of a function <code class="docutils literal notranslate"><span class="pre">f</span></code>,
<code class="docutils literal notranslate"><span class="pre">f</span></code> must be executed before <code class="docutils literal notranslate"><span class="pre">g</span></code>.</p>
<p>However, we may have side effects like prints that have no inputs at all
so naively we couldn’t sequence them. We thus use <em>tokens</em> as a means of injecting
artificial data-dependence into a computation.</p>
<p>What is a token? A token is just a dummy value that can be threaded in and out of a computation.
By threading the same token in and out and several computations, we enforce that they have to happen
in a certain order. Let’s take the previous print example and see what it would look like with tokens
in the mix:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">token</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">"hello"</span><span class="p">)</span>
  <span class="n">token</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">"world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">x</span>
</pre></div>
</div>
<p>If we rewrite <code class="docutils literal notranslate"><span class="pre">jax.print</span></code> to take in and return a token, we have now sequenced
the two prints since the input to the second print depends is the output of the first print.
The actual value of <code class="docutils literal notranslate"><span class="pre">token</span></code> can be anything really, but we’ll see in practice
that the tokens are invisible to users.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Runtime tokens vs. compiler tokens"></a><section id="runtime-tokens-vs-compiler-tokens">
<h2>Runtime tokens vs. compiler tokens<a class="headerlink" href="#runtime-tokens-vs-compiler-tokens" title="Permalink to this headline">#</a></h2>
<p>Here we will actually start talking about implementation details. In practice, we’ll need
two separate types of tokens to sequence effects: one for each of the aforementioned sources
of reordering. We’ll need <em>runtime tokens</em> to sequence asynchronously dispatched
side-effecting computations and we’ll need <em>compiler tokens</em> to sequence effects within computations.</p>
<p>In practice, our computation will be rewritten to look like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">runtime_token</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="n">compiler_token</span> <span class="o">=</span> <span class="n">new_compiler_token</span><span class="p">()</span>
  <span class="n">compiler_token</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">compiler_token</span><span class="p">,</span> <span class="s2">"hello"</span><span class="p">)</span>
  <span class="n">compiler_token</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">compiler_token</span><span class="p">,</span> <span class="s2">"world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">runtime_token</span><span class="p">,</span> <span class="n">x</span>
</pre></div>
</div>
<p>Notice how the runtime tokens are only used at the JIT boundary and the compiler tokens
are only within the compiled code. Compiler tokens are created during
“lowering” (we convert Python code to a lower level representation like HLO or MHLO)
but runtime tokens need to be managed in Python since they’re being threaded in and out
of JIT-ted functions.</p>
<p>Furthermore, notice that the runtime tokens are “disconnected”
from the compiler tokens meaning there’s no data dependency between them. This could
potentially be dangerous as if we will lose the data dependence between the bodies
of two dispatched function calls. However, if we assume “strict execution” – i.e.
a dispatched function will only start execution when all of its inputs are ready
and all of it outputs will become ready at the same time – we are safe to create a
fresh compiler token and return a non-output-dependent runtime token.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Managing runtime tokens"></a><section id="managing-runtime-tokens">
<h2>Managing runtime tokens<a class="headerlink" href="#managing-runtime-tokens" title="Permalink to this headline">#</a></h2>
<p>To manage runtime tokens on behalf of the user, we’ll need to hook into JAX’s dispatch machinery.
Whenever we call a JIT-ted function, we eventually bottom out in a function that looks like
this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="n">compiled_computation</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">outputs</span> <span class="o">=</span> <span class="n">compiled_computation</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
<p>At this point we need to “inject” the runtime tokens into the computation
and “extract” them from the computation’s outputs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="n">compiled_computation</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">runtime_token</span> <span class="o">=</span> <span class="n">get_runtime_token</span><span class="p">()</span> <span class="c1"># Grab global token</span>
  <span class="n">runtime_token</span><span class="p">,</span> <span class="o">*</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">compiled_computation</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">runtime_token</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="n">update_runtime_token</span><span class="p">(</span><span class="n">runtime_token</span><span class="p">)</span> <span class="c1"># Update global token</span>
  <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
<p>What is <code class="docutils literal notranslate"><span class="pre">runtime_token</span></code> exactly? Well we need to be able to pass it into a <code class="docutils literal notranslate"><span class="pre">compiled_computation</span></code>,
which means it needs to be some sort of array (for now, since there’s no shared token representation
inside and outside compiled JAX code). In practice we can use a <code class="docutils literal notranslate"><span class="pre">(0,)</span></code>-shaped array to minimize overheads.</p>
<p>We also need to think about the multiple device use case, e.g. the first example where
we first call a JIT-ted function on device 0 and then one on device 1.
In that case, we need to also <em>copy</em> the runtime token returned from the first computation (which lives on device 0)
to device 1 so we can pass it into the second computation. If two subsequent computations share the same device,
this copy is not necessary.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Adding compiler tokens"></a><section id="adding-compiler-tokens">
<h2>Adding compiler tokens<a class="headerlink" href="#adding-compiler-tokens" title="Permalink to this headline">#</a></h2>
<p>When we lower Python code to HLO or MHLO we need to create a token at the start of the computation and
ensure they are available when we have side-effecting computations that need to be ordered. The side-effecting
computations will take the token as input and return it as an output.</p>
<p>The implementation of this token threading involves upgrading the JAX lowering machinery to do
this bookkeeping automatically.
The main challenges involve dealing with higher-order primitives like call primitives
and control-flow primitives. We won’t go into details in how to handle those in this design note.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Blocking on output tokens"></a><section id="blocking-on-output-tokens">
<h2>Blocking on output tokens<a class="headerlink" href="#blocking-on-output-tokens" title="Permalink to this headline">#</a></h2>
<p>Adding support for runtime and compiler tokens for side-effecting computations is important for sequencing
but there’s also another subtle use-case for tokens, which is blocking on side-effecting computations.
Even if we don’t want a side-effecting computation to be <em>ordered</em> we may still want to wait on its
completion. Currently we have <code class="docutils literal notranslate"><span class="pre">jax.block_until_ready</span></code>, which waits until a future value has its
result ready. However, with side-effecting computations, we may have functions that don’t have a return
value but are still executing a side-effect. Take the simple example here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello world"</span><span class="p">)</span>
  <span class="k">return</span>
<span class="n">f</span><span class="p">()</span> <span class="c1"># Executed asynchronously</span>
</pre></div>
</div>
<p>This compiled computation takes no explicit inputs and has no explicit outputs. If it was an ordered print effect,
we could block on the returned runtime token, However,
when this is an unordered computation we don’t do any token threading. How do we wait for <code class="docutils literal notranslate"><span class="pre">f()</span></code> to
finish executing when we have no output value to call <code class="docutils literal notranslate"><span class="pre">block_until_ready</span></code> on? Well, we could apply our same
token strategy except we only return runtime tokens and don’t take them as inputs. This will give us
a value to block on that will only be ready once <code class="docutils literal notranslate"><span class="pre">f()</span></code> is done being executed. We’ll call these tokens
<em>output tokens</em>. We end up with a function that looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">new_runtime_token</span><span class="p">()</span>
<span class="n">f</span><span class="p">()</span> <span class="c1"># Executed asynchronously</span>
</pre></div>
</div>
<p>Underneath the hood, we’ll manage the output tokens in the same way we manage the runtime tokens but
provide a method for users to block on the current set of output tokens. Unlike runtime tokens,
output tokens need to be <em>device-specific</em>.
Consider a single device use-case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>

<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>

<span class="n">f</span><span class="p">()</span>
<span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">f()</span></code> and <code class="docutils literal notranslate"><span class="pre">g()</span></code> are executed on the same device, blocking on <code class="docutils literal notranslate"><span class="pre">g()</span></code>’s output token
effectively blocks on <code class="docutils literal notranslate"><span class="pre">f()</span></code> since (as of now!), the JAX runtime does not interleave computations
executed on the same device. We’ll have to revise this entire design if that changes, of course.</p>
<p>However, consider the two device use-case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>

<span class="n">f</span><span class="p">()</span>
<span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we don’t want to explicitly sequence <code class="docutils literal notranslate"><span class="pre">f()</span></code> and <code class="docutils literal notranslate"><span class="pre">g()</span></code> but want to wait for both of them to finish.
We’ll need one output token for <code class="docutils literal notranslate"><span class="pre">f()</span></code> and one for <code class="docutils literal notranslate"><span class="pre">g()</span></code> and we’ll block on both of those tokens:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">new_runtime_token</span><span class="p">()</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">device</span><span class="o">=&lt;</span><span class="n">device</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
  <span class="n">jax</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">new_runtime_token</span><span class="p">()</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<span class="n">block_until_ready</span><span class="p">((</span><span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">))</span>
</pre></div>
</div>
<p>We’ll thus need a per-device output token so we can avoid sequencing computations on different
devices while offering the ability to block on side-effecting computations. We end up with the following
(approximate) change to the JAX dispatch machinery:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_execute</span><span class="p">(</span><span class="n">compiled_computation</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
  <span class="n">output_token</span><span class="p">,</span> <span class="o">*</span><span class="n">outputs</span> <span class="o">=</span> <span class="n">compiled_computation</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">runtime_token</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="n">update_output_token</span><span class="p">(</span><span class="n">output_token</span><span class="p">,</span> <span class="n">compiled_computation</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
<p>We’ll also need to expose a function to that blocks on the output token:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">effects_barrier</span><span class="p">():</span>
  <span class="n">output_token</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that blocking on output tokens may not be fairly common since most JAX computations will return
a value to block on. However, output tokens are helpful for testing and profiling, and are good to
support so that we have a consistent and cohesive effect system.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Some more details"></a><section id="some-more-details">
<h2>Some more details<a class="headerlink" href="#some-more-details" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>All of the aforementioned token management infrastructure will be <em>thread-local</em>. This means
that each user thread will have their own independent stream of runtime tokens. Sequencing
is only promised at a user thread level.</p></li>
<li><p>In practice, we have one runtime token per effect. Different instances of that effect will be
sequenced. This is to avoid sequencing effectul computations that may not have any relation to each
other. Technically this goes against our original goal though of enforcing a single-threaded Python
program ordering, but this is a tradeoff that could be modulated by having both “effect”-specific tokens
and “global” tokens.</p></li>
</ul>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="9419-jax-versioning.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Jax and Jaxlib versioning</p>
</div>
</a>
<a class="right-next" href="11830-new-remat-checkpoint.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">jax.remat</span></code> / <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> changes: what you need to know</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>