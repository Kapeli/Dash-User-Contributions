
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Omnistaging — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="9407-type-promotion.html" rel="next" title="Design of Type Promotion Semantics for JAX"/>
<link href="4008-custom-vjp-update.html" rel="prev" title="custom_vjp and nondiff_argnums update guide"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jep/4410-omnistaging.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#contents">
   Contents
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#tl-dr">
   tl;dr
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-s-going-on">
     What’s going on?
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-do-i-know-if-omnistaging-broke-my-code">
     How do I know if omnistaging broke my code?
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-can-i-disable-omnistaging-for-now">
     How can I disable omnistaging for now?
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-do-i-fix-bugs-exposed-by-omnistaging">
     How do I fix bugs exposed by omnistaging?
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-is-omnistaging-and-why-is-it-useful">
   What is “omnistaging” and why is it useful?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#toy-example">
     Toy example
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#slightly-less-toy-example">
     Slightly less toy example
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-issues-can-arise-when-omnistaging-is-switched-on">
   What issues can arise when omnistaging is switched on?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-jax-numpy-for-shape-computations">
     Using
     <code class="docutils literal notranslate">
<span class="pre">
       jax.numpy
      </span>
</code>
     for shape computations
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#example">
       Example
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#error-message">
       Error message
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#explanation">
       Explanation
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#solution">
       Solution
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#side-effects">
     Side-effects
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Example
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
       Error message
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
       Explanation
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
       Solution
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#small-numerical-differences-based-on-xla-optimizations">
     Small numerical differences based on XLA optimizations
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#dependence-on-jax-internal-apis-that-changed">
     Dependence on JAX internal APIs that changed
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#triggering-xla-compile-time-bugs">
     Triggering XLA compile time bugs
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Omnistaging</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#contents">
   Contents
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#tl-dr">
   tl;dr
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-s-going-on">
     What’s going on?
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-do-i-know-if-omnistaging-broke-my-code">
     How do I know if omnistaging broke my code?
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-can-i-disable-omnistaging-for-now">
     How can I disable omnistaging for now?
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-do-i-fix-bugs-exposed-by-omnistaging">
     How do I fix bugs exposed by omnistaging?
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-is-omnistaging-and-why-is-it-useful">
   What is “omnistaging” and why is it useful?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#toy-example">
     Toy example
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#slightly-less-toy-example">
     Slightly less toy example
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-issues-can-arise-when-omnistaging-is-switched-on">
   What issues can arise when omnistaging is switched on?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#using-jax-numpy-for-shape-computations">
     Using
     <code class="docutils literal notranslate">
<span class="pre">
       jax.numpy
      </span>
</code>
     for shape computations
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#example">
       Example
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#error-message">
       Error message
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#explanation">
       Explanation
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#solution">
       Solution
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#side-effects">
     Side-effects
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Example
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
       Error message
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
       Explanation
      </a>
</li>
<li class="toc-h4 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
       Solution
      </a>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#small-numerical-differences-based-on-xla-optimizations">
     Small numerical differences based on XLA optimizations
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#dependence-on-jax-internal-apis-that-changed">
     Dependence on JAX internal APIs that changed
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#triggering-xla-compile-time-bugs">
     Triggering XLA compile time bugs
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Omnistaging"></a><section class="tex2jax_ignore mathjax_ignore" id="omnistaging">
<h1>Omnistaging<a class="headerlink" href="#omnistaging" title="Permalink to this headline">#</a></h1>
<p><em>mattjj@</em>
<em>Sept 25 2020</em></p>
<p>This is more of an upgrade guide than a design doc.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Contents"></a><section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#tl-dr"><span class="std std-doc">tl;dr</span></a></p></li>
<li><p><a class="reference internal" href="#what-is-omnistaging-and-why-is-it-useful"><span class="std std-doc">What is “omnistaging” and why is it useful?</span></a></p></li>
<li><p><a class="reference internal" href="#what-issues-can-arise-when-omnistaging-is-switched-on"><span class="std std-doc">What issues can arise when omnistaging is switched on?</span></a></p>
<ul>
<li><p><a class="reference internal" href="#using-jax-numpy-for-shape-computations"><span class="std std-doc">Using <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> for shape computations</span></a></p></li>
<li><p><a class="reference internal" href="#side-effects"><span class="std std-doc">Side-effects</span></a></p></li>
<li><p><a class="reference internal" href="#small-numerical-differences-based-on-xla-optimizations"><span class="std std-doc">Small numerical differences based on XLA optimizations</span></a></p></li>
<li><p><a class="reference internal" href="#dependence-on-jax-internal-apis-that-changed"><span class="std std-doc">Dependence on JAX internal APIs that changed</span></a></p></li>
<li><p><a class="reference internal" href="#triggering-xla-compile-time-bugs"><span class="std std-doc">Triggering XLA compile time bugs</span></a></p></li>
</ul>
</li>
</ul>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/tl;dr"></a><section id="tl-dr">
<h2>tl;dr<a class="headerlink" href="#tl-dr" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/What's going on?"></a><section id="what-s-going-on">
<h3>What’s going on?<a class="headerlink" href="#what-s-going-on" title="Permalink to this headline">#</a></h3>
<p>A change to JAX’s tracing infrastructure called “omnistaging”
(<a class="reference external" href="https://github.com/google/jax/pull/3370">google/jax#3370</a>) was switched on in
jax==0.2.0. This change improves memory performance, trace execution time, and
simplifies jax internals, but may cause some existing code to break. Breakage is
usually a result of buggy code, so long-term it’s best to fix the bugs, but
omnistaging can also be disabled as a temporary workaround. And we’re happy to
help you with fixes!</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/How do I know if omnistaging broke my code?"></a><section id="how-do-i-know-if-omnistaging-broke-my-code">
<h3>How do I know if omnistaging broke my code?<a class="headerlink" href="#how-do-i-know-if-omnistaging-broke-my-code" title="Permalink to this headline">#</a></h3>
<p>The easiest way to tell if omnistaging is responsible is to disable omnistaging
and see if the issues go away. See the <a class="reference internal" href="#what-issues-can-arise-when-omnistaging-is-switched-on"><span class="std std-doc">What issues can arise when omnistaging
is switched on?</span></a> section
below.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/How can I disable omnistaging for now?"></a><section id="how-can-i-disable-omnistaging-for-now">
<h3>How can I disable omnistaging for now?<a class="headerlink" href="#how-can-i-disable-omnistaging-for-now" title="Permalink to this headline">#</a></h3>
<p><em>Note: this applies to JAX versions 0.2.0 through 0.2.11; omnistaging cannot be
disabled in JAX versions 0.2.12 and higher</em></p>
<p>It is temporarily possible to disable omnistaging by</p>
<ol class="arabic simple">
<li><p>setting the shell environment variable <code class="docutils literal notranslate"><span class="pre">JAX_OMNISTAGING</span></code> to something falsey;</p></li>
<li><p>setting the boolean flag <code class="docutils literal notranslate"><span class="pre">jax_omnistaging</span></code> to something falsey if your code
parses flags with absl;</p></li>
<li><p>using this statement near the top of your main file:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">disable_omnistaging</span><span class="p">()</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/How do I fix bugs exposed by omnistaging?"></a><section id="how-do-i-fix-bugs-exposed-by-omnistaging">
<h3>How do I fix bugs exposed by omnistaging?<a class="headerlink" href="#how-do-i-fix-bugs-exposed-by-omnistaging" title="Permalink to this headline">#</a></h3>
<p>By far the most common issue with omnistaging is using <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> to compute
shape values or other trace-time constants. See the code block below for a quick
example, and for full details along with other issues see the section <a class="reference internal" href="#what-issues-can-arise-when-omnistaging-is-switched-on"><span class="std std-doc">What
issues can arise when omnistaging is switched
on?</span></a>.</p>
<p>Instead of this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">input_size</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">input_size</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">input_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">input_size</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Instead of thinking of <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> as a drop-in replacement for <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, it’s
now better to think of using <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> operations only when you want to perform a
computation on an accelerator (like your GPU).</p>
</section>
</section>
<a class="dashAnchor" name='//apple_ref/cpp/Section/What is "omnistaging" and why is it useful?'></a><section id="what-is-omnistaging-and-why-is-it-useful">
<h2>What is “omnistaging” and why is it useful?<a class="headerlink" href="#what-is-omnistaging-and-why-is-it-useful" title="Permalink to this headline">#</a></h2>
<p>Omnistaging is the name for a JAX core upgrade aimed at staging out more
computation from op-by-op Python to XLA, and avoiding any “trace-time constant
folding” in <code class="docutils literal notranslate"><span class="pre">jit</span></code>, <code class="docutils literal notranslate"><span class="pre">pmap</span></code>, and control flow primitives. As a result, omnistaging
improves JAX’s memory performance (sometimes dramatically) both by reducing
fragmentation during tracing and by producing fewer large compile-time constants
for XLA. It can also improve tracing performance by eliminating op-by-op
execution at tracing time. Further, omnistaging simplifies JAX core internals,
fixing many outstanding bugs and setting the stage for important upcoming
features.</p>
<p>The name “omnistaging” means staging out everything possible.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Toy example"></a><section id="toy-example">
<h3>Toy example<a class="headerlink" href="#toy-example" title="Permalink to this headline">#</a></h3>
<p>JAX transformations like <code class="docutils literal notranslate"><span class="pre">jit</span></code> and <code class="docutils literal notranslate"><span class="pre">pmap</span></code> stage out computations to XLA. That
is, we apply them to functions comprising multiple primitive operations so that
rather being executed one at a time from Python the operations are all part of
one end-to-end optimized XLA computation.</p>
<p>But exactly which operations get staged out? Until omnistaging, JAX staged out
computation based on data dependence only. Here’s an example function, followed
by the XLA HLO program it stages out <em>before</em> the omnistaging change:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

<span class="n">f</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ENTRY</span> <span class="n">jit_f</span><span class="mf">.6</span> <span class="p">{</span>
  <span class="n">constant</span><span class="mf">.2</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
  <span class="n">parameter</span><span class="mf">.1</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">constant</span><span class="mf">.3</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">multiply</span><span class="mf">.4</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">multiply</span><span class="p">(</span><span class="n">parameter</span><span class="mf">.1</span><span class="p">,</span> <span class="n">constant</span><span class="mf">.3</span><span class="p">)</span>
  <span class="n">ROOT</span> <span class="nb">tuple</span><span class="mf">.5</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">[])</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">multiply</span><span class="mf">.4</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">add</span></code> operation is not staged out. Instead, we only see a
multiply.</p>
<p>Here’s the HLO generated from this function <em>after</em> the omnistaging change:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ENTRY</span> <span class="n">jit_f</span><span class="mf">.8</span> <span class="p">{</span>
  <span class="n">constant</span><span class="mf">.2</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
  <span class="n">parameter</span><span class="mf">.1</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">constant</span><span class="mf">.3</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">constant</span><span class="mf">.4</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">add</span><span class="mf">.5</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">add</span><span class="p">(</span><span class="n">constant</span><span class="mf">.3</span><span class="p">,</span> <span class="n">constant</span><span class="mf">.4</span><span class="p">)</span>
  <span class="n">multiply</span><span class="mf">.6</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">multiply</span><span class="p">(</span><span class="n">parameter</span><span class="mf">.1</span><span class="p">,</span> <span class="n">add</span><span class="mf">.5</span><span class="p">)</span>
  <span class="n">ROOT</span> <span class="nb">tuple</span><span class="mf">.7</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">[])</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">multiply</span><span class="mf">.6</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Slightly less toy example"></a><section id="slightly-less-toy-example">
<h3>Slightly less toy example<a class="headerlink" href="#slightly-less-toy-example" title="Permalink to this headline">#</a></h3>
<p>Here’s a less toy example which can arise in practice when we want to create
boolean masks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">lax</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">select_tril</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">mask</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>  <span class="c1"># lax.select is like jnp.where</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">select_tril</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Before</em> omnistaging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ENTRY</span> <span class="n">jit_select_tril</span><span class="mf">.8</span> <span class="p">{</span>
  <span class="n">constant</span><span class="mf">.3</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
  <span class="n">constant</span><span class="mf">.1</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">constant</span><span class="p">({</span><span class="o">...</span><span class="p">})</span>
  <span class="n">parameter</span><span class="mf">.2</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">constant</span><span class="mf">.4</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">broadcast</span><span class="mf">.5</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">constant</span><span class="mf">.4</span><span class="p">),</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">{}</span>
  <span class="n">select</span><span class="mf">.6</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">select</span><span class="p">(</span><span class="n">constant</span><span class="mf">.1</span><span class="p">,</span> <span class="n">parameter</span><span class="mf">.2</span><span class="p">,</span> <span class="n">broadcast</span><span class="mf">.5</span><span class="p">)</span>
  <span class="n">ROOT</span> <span class="nb">tuple</span><span class="mf">.7</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">})</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">select</span><span class="mf">.6</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">select</span></code> operation is staged out, but the operations for constructing the
constant <code class="docutils literal notranslate"><span class="pre">mask</span></code> are not. Rather than being staged out, the operations that
construct <code class="docutils literal notranslate"><span class="pre">mask</span></code> are executed op-by-op at Python tracing time, and XLA only sees
a compile time constant <code class="docutils literal notranslate"><span class="pre">constant.1</span></code> representing the value of <code class="docutils literal notranslate"><span class="pre">mask</span></code>. That’s
unfortunate, because if we had staged out the operations for constructing
<code class="docutils literal notranslate"><span class="pre">mask</span></code>, XLA could have fused them into the <code class="docutils literal notranslate"><span class="pre">select</span></code> and avoided materializing
the result at all. As a result we end up wasting memory with a potentially-large
constant, wasting time dispatching multiple un-fused op-by-op XLA computations,
and potentially even fragmenting memory.</p>
<p>(The <code class="docutils literal notranslate"><span class="pre">broadcast</span></code> that corresponds to the construction of the zeros array for
<code class="docutils literal notranslate"><span class="pre">jnp.zeros_like(x)</span></code> is staged out because JAX is lazy about very simple
expressions from <a class="reference external" href="https://github.com/google/jax/pull/1668">google/jax#1668</a>. After
omnistaging, we can remove that lazy sublanguage and simplify JAX internals.)</p>
<p>The reason the creation of <code class="docutils literal notranslate"><span class="pre">mask</span></code> is not staged out is that, before omnistaging,
<code class="docutils literal notranslate"><span class="pre">jit</span></code> operates based on data dependence. That is, <code class="docutils literal notranslate"><span class="pre">jit</span></code> stages out only those
operations in a function that have a data dependence on an argument. Control
flow primitives and <code class="docutils literal notranslate"><span class="pre">pmap</span></code> behave similarly. In the case of <code class="docutils literal notranslate"><span class="pre">select_tril</span></code>, the
operations to construct the constant <code class="docutils literal notranslate"><span class="pre">mask</span></code> do not have a data dependence on the
argument x, so they are not staged out; only the <code class="docutils literal notranslate"><span class="pre">lax.select</span></code> call has a data
dependence.</p>
<p>With omnistaging all <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> calls in the dynamic context of a
<code class="docutils literal notranslate"><span class="pre">jit</span></code>-transformed function are staged out to XLA. That is, after omnistaging the
computation XLA sees for <code class="docutils literal notranslate"><span class="pre">select_tril</span></code> is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ENTRY</span> <span class="n">jit_select_tril</span><span class="mf">.16</span> <span class="p">{</span>
  <span class="n">constant</span><span class="mf">.4</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="n">false</span><span class="p">)</span>
  <span class="n">iota</span><span class="mf">.1</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">]{</span><span class="mi">0</span><span class="p">}</span> <span class="n">iota</span><span class="p">(),</span> <span class="n">iota_dimension</span><span class="o">=</span><span class="mi">0</span>
  <span class="n">broadcast</span><span class="mf">.5</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">iota</span><span class="mf">.1</span><span class="p">),</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
  <span class="n">reshape</span><span class="mf">.7</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">]{</span><span class="mi">0</span><span class="p">}</span> <span class="n">reshape</span><span class="p">(</span><span class="n">broadcast</span><span class="mf">.5</span><span class="p">)</span>
  <span class="n">broadcast</span><span class="mf">.8</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">reshape</span><span class="mf">.7</span><span class="p">),</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
  <span class="n">iota</span><span class="mf">.2</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">4</span><span class="p">]{</span><span class="mi">0</span><span class="p">}</span> <span class="n">iota</span><span class="p">(),</span> <span class="n">iota_dimension</span><span class="o">=</span><span class="mi">0</span>
  <span class="n">broadcast</span><span class="mf">.6</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">iota</span><span class="mf">.2</span><span class="p">),</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
  <span class="n">reshape</span><span class="mf">.9</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">4</span><span class="p">]{</span><span class="mi">0</span><span class="p">}</span> <span class="n">reshape</span><span class="p">(</span><span class="n">broadcast</span><span class="mf">.6</span><span class="p">)</span>
  <span class="n">broadcast</span><span class="mf">.10</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">reshape</span><span class="mf">.9</span><span class="p">),</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
  <span class="n">compare</span><span class="mf">.11</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">compare</span><span class="p">(</span><span class="n">broadcast</span><span class="mf">.8</span><span class="p">,</span> <span class="n">broadcast</span><span class="mf">.10</span><span class="p">),</span> <span class="n">direction</span><span class="o">=</span><span class="n">GT</span>
  <span class="n">parameter</span><span class="mf">.3</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">constant</span><span class="mf">.12</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[]</span> <span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">broadcast</span><span class="mf">.13</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">broadcast</span><span class="p">(</span><span class="n">constant</span><span class="mf">.12</span><span class="p">),</span> <span class="n">dimensions</span><span class="o">=</span><span class="p">{}</span>
  <span class="n">select</span><span class="mf">.14</span> <span class="o">=</span> <span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">select</span><span class="p">(</span><span class="n">compare</span><span class="mf">.11</span><span class="p">,</span> <span class="n">parameter</span><span class="mf">.3</span><span class="p">,</span> <span class="n">broadcast</span><span class="mf">.13</span><span class="p">)</span>
  <span class="n">ROOT</span> <span class="nb">tuple</span><span class="mf">.15</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">})</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">select</span><span class="mf">.14</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/What issues can arise when omnistaging is switched on?"></a><section id="what-issues-can-arise-when-omnistaging-is-switched-on">
<h2>What issues can arise when omnistaging is switched on?<a class="headerlink" href="#what-issues-can-arise-when-omnistaging-is-switched-on" title="Permalink to this headline">#</a></h2>
<p>As a consequence of staging out all <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> operations from Python to XLA
when in the dynamic context of a <code class="docutils literal notranslate"><span class="pre">jit</span></code> or <code class="docutils literal notranslate"><span class="pre">pmap</span></code>, some code that worked
previously can start raising loud errors. As explained below, these behaviors
were already buggy before omnistaging, but omnistaging makes them into hard
errors.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Using jax.numpy for shape computations"></a><section id="using-jax-numpy-for-shape-computations">
<h3>Using <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> for shape computations<a class="headerlink" href="#using-jax-numpy-for-shape-computations" title="Permalink to this headline">#</a></h3>
<section id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">#</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>

<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">ex1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">size</span><span class="p">,))</span>

<span class="n">ex1</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
</pre></div>
</div>
</section>
<section id="error-message">
<h4>Error message<a class="headerlink" href="#error-message" title="Permalink to this headline">#</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[... full traceback ...]
  File "/home/mattjj/packages/jax/jax/core.py", line 862, in raise_concretization_error
    raise ConcretizationTypeError(msg)
jax.core.ConcretizationTypeError: Abstract tracer value encountered where concrete value is expected.

The error arose in jax.numpy.reshape.

While tracing the function ex1 at ex1.py:4, this value became a tracer due to JAX operations on these lines:

  operation c:int32[] = reduce_prod[ axes=(0,) ] b:int32[2]
    from line ex1.py:6 (ex1)

You can use transformation parameters such as `static_argnums` for `jit` to avoid tracing particular arguments of transformed functions.

See https://jax.readthedocs.io/en/latest/faq.html#abstract-tracer-value-encountered-where-concrete-value-is-expected-error for more information.

Encountered tracer value: Traced&lt;ShapedArray(int32[])&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;
</pre></div>
</div>
</section>
<section id="explanation">
<h4>Explanation<a class="headerlink" href="#explanation" title="Permalink to this headline">#</a></h4>
<p>With omnistaging, we can’t use <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> for shape computations as in the use
of <code class="docutils literal notranslate"><span class="pre">jnp.prod</span></code> above because in the dynamic context of a jit function those
operations will be staged out of Python as values to be computed at execution
time, yet we need them to be compile-time (and hence trace-time) constants.</p>
<p>Before omnistaging, this code wouldn’t have raised an error, but it was a common
performance bug: the <code class="docutils literal notranslate"><span class="pre">jnp.prod</span></code> computation would have been executed on the
device at tracing time, meaning extra compilation, transfers, synchronization,
allocations, and potentially memory fragmentation.</p>
</section>
<section id="solution">
<h4>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">#</a></h4>
<p>The solution is simply to use the original <code class="docutils literal notranslate"><span class="pre">numpy</span></code> for shape calculations like
these. Not only do we avoid the error, but also we keep the computations on the
host (and with lower overheads).</p>
<p>This issue was common enough in code that we tried to make the error
message especially good. In addition to the stack trace showing where an
abstract tracer value caused a problem (the <code class="docutils literal notranslate"><span class="pre">jnp.reshape</span></code> line in the full stack
trace, on omni.py:10), we also explain why this value became a tracer in the
first place by pointing to the upstream primitive operation that caused it to
become an abstract tracer (the <code class="docutils literal notranslate"><span class="pre">reduce_prod</span></code> from <code class="docutils literal notranslate"><span class="pre">jnp.prod</span></code> on omni.py:9) and to
which <code class="docutils literal notranslate"><span class="pre">jit</span></code>-decorated function the tracer belongs (<code class="docutils literal notranslate"><span class="pre">ex1</span></code> on omni.py:6).</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Side-effects"></a><section id="side-effects">
<h3>Side-effects<a class="headerlink" href="#side-effects" title="Permalink to this headline">#</a></h3>
<section id="id1">
<h4>Example<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">key</span>
  <span class="n">key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="n">init</span><span class="p">())</span>  <span class="c1"># -1.2515389</span>
<span class="nb">print</span><span class="p">(</span><span class="n">init</span><span class="p">())</span>  <span class="c1"># -0.58665067</span>

<span class="n">init</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">init</span><span class="p">())</span>  <span class="c1"># 0.48648298</span>
<span class="nb">print</span><span class="p">(</span><span class="n">init</span><span class="p">())</span>  <span class="c1"># 0.48648298  !!</span>
</pre></div>
</div>
<p>That last call has repeated randomness but no hard error, because we aren’t
re-executing the Python. But if we look at <code class="docutils literal notranslate"><span class="pre">key</span></code>, we see an escaped tracer <em>when
omnistaging is on</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="c1"># Traced&lt;ShapedArray(uint32[2])&gt;with&lt;DynamicJaxprTrace(level=0/1)&gt;</span>
</pre></div>
</div>
<p>Before omnistaging, the <code class="docutils literal notranslate"><span class="pre">random.split</span></code> call would not be staged out and so we
wouldn’t get an escaped tracer. The code would still be buggy in that the jitted
function wouldn’t be reproducing the semantics of the original function (because
of the repeated use of the same PRNG key), ultimately due to the side effect.</p>
<p>With omnistaging on, if we touch <code class="docutils literal notranslate"><span class="pre">key</span></code> again, we’ll get an escaped tracer error:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">())</span>
</pre></div>
</div>
</section>
<section id="id2">
<h4>Error message<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[... full stack trace …]
  File "/home/mattjj/packages/jax/jax/interpreters/partial_eval.py", line 836, in _assert_live
    raise core.escaped_tracer_error(msg)
jax.core.UnexpectedTracerError: Encountered an unexpected tracer. Perhaps this tracer escaped through global state from a previously traced function.
The functions being transformed should not save traced values to global state. Detail: tracer created on line example.py:8 (init).
</pre></div>
</div>
</section>
<section id="id3">
<h4>Explanation<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h4>
<p>The second largest category of omnistaging issues we found had to do with
side-effecting code. This code already voided the JAX warranty by transforming
effectful functions, but due to pre-omnistaging “trace-time constant folding”
behavior, some side effecting functions could nevertheless behave correctly.
Omnistaging catches more of these errors.</p>
</section>
<section id="id4">
<h4>Solution<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h4>
<p>The solution is to identify JAX-transformed functions that rely on side effects,
and to rewrite them not to be effectful.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Small numerical differences based on XLA optimizations"></a><section id="small-numerical-differences-based-on-xla-optimizations">
<h3>Small numerical differences based on XLA optimizations<a class="headerlink" href="#small-numerical-differences-based-on-xla-optimizations" title="Permalink to this headline">#</a></h3>
<p>Because with omnistaging more computations are being staged out to XLA, rather
than some being executed at trace time, that can have the effect of reordering
floating point operations. As a result, we’ve seen numerical behaviors change in
a way that causes tests with overly tight tolerances to fail when omnistaging is
switched on.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Dependence on JAX internal APIs that changed"></a><section id="dependence-on-jax-internal-apis-that-changed">
<h3>Dependence on JAX internal APIs that changed<a class="headerlink" href="#dependence-on-jax-internal-apis-that-changed" title="Permalink to this headline">#</a></h3>
<p>Omnistaging involved some big revisions to JAX’s core code, including removing
or changing internal functions. Any code that relies on such internal
JAX APIs can break when omnistaging is switched on, either with build errors
(from pytype) or runtime errors.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Triggering XLA compile time bugs"></a><section id="triggering-xla-compile-time-bugs">
<h3>Triggering XLA compile time bugs<a class="headerlink" href="#triggering-xla-compile-time-bugs" title="Permalink to this headline">#</a></h3>
<p>Because omnistaging involves staging out more code to XLA, we’ve seen it trigger
pre-existing XLA compile-time bugs on some backends. The best thing to do with
these is to report them so we can work with the XLA teams on fixes.</p>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="4008-custom-vjp-update.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">custom_vjp</span></code> and <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> update guide</p>
</div>
</a>
<a class="right-next" href="9407-type-promotion.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Design of Type Promotion Semantics for JAX</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>