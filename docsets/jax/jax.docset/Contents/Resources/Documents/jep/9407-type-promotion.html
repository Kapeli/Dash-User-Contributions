
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Design of Type Promotion Semantics for JAX — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="9419-jax-versioning.html" rel="next" title="Jax and Jaxlib versioning"/>
<link href="4410-omnistaging.html" rel="prev" title="Omnistaging"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jep/9407-type-promotion.ipynb.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.ipynb</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#goals-of-jax-type-promotion">
   Goals of JAX Type Promotion
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#stepping-back-tables-and-lattices">
   Stepping Back: Tables and Lattices
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#properties-of-a-type-promotion-lattice">
     Properties of a Type Promotion Lattice
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#type-promotion-within-categories">
   Type Promotion within Categories
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#enter-python-scalars">
   Enter Python Scalars
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#combining-lattices">
   Combining Lattices
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mixed-promotion-float-and-complex">
   Mixed Promotion: Float and Complex
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mixed-promotion-signed-unsigned-integers">
   Mixed Promotion: Signed &amp; Unsigned Integers
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-to-handle-uint64">
     How to handle
     <code class="docutils literal notranslate">
<span class="pre">
       uint64
      </span>
</code>
     ?
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mixed-promotion-integer-and-floating">
   Mixed Promotion: Integer and Floating
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-0-leave-integer-floating-mixed-precision-undefined">
     Option 0: Leave integer/floating mixed precision undefined
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-1-avoiding-all-precision-loss">
     Option 1: Avoiding All Precision Loss
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-2-avoid-most-wider-than-necessary-promotions">
     Option 2: Avoid most wider-than-necessary promotions
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-3-avoid-all-wider-than-necessary-promotions">
     Option 3: Avoid all wider-than-necessary promotions
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#type-promotion-in-jax">
   Type Promotion in JAX
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#appendix-example-type-promotion-tables">
   Appendix: Example Type Promotion Tables
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#numpy-type-promotion">
     NumPy Type Promotion
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tensorflow-type-promotion">
     Tensorflow Type Promotion
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#pytorch-type-promotion">
     PyTorch Type Promotion
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-type-promotion-jax-numpy">
     JAX Type Promotion:
     <code class="docutils literal notranslate">
<span class="pre">
       jax.numpy
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-type-promotion-jax-lax">
     JAX Type Promotion:
     <code class="docutils literal notranslate">
<span class="pre">
       jax.lax
      </span>
</code>
</a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Design of Type Promotion Semantics for JAX</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#goals-of-jax-type-promotion">
   Goals of JAX Type Promotion
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#stepping-back-tables-and-lattices">
   Stepping Back: Tables and Lattices
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#properties-of-a-type-promotion-lattice">
     Properties of a Type Promotion Lattice
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#type-promotion-within-categories">
   Type Promotion within Categories
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#enter-python-scalars">
   Enter Python Scalars
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#combining-lattices">
   Combining Lattices
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mixed-promotion-float-and-complex">
   Mixed Promotion: Float and Complex
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mixed-promotion-signed-unsigned-integers">
   Mixed Promotion: Signed &amp; Unsigned Integers
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-to-handle-uint64">
     How to handle
     <code class="docutils literal notranslate">
<span class="pre">
       uint64
      </span>
</code>
     ?
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#mixed-promotion-integer-and-floating">
   Mixed Promotion: Integer and Floating
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-0-leave-integer-floating-mixed-precision-undefined">
     Option 0: Leave integer/floating mixed precision undefined
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-1-avoiding-all-precision-loss">
     Option 1: Avoiding All Precision Loss
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-2-avoid-most-wider-than-necessary-promotions">
     Option 2: Avoid most wider-than-necessary promotions
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#option-3-avoid-all-wider-than-necessary-promotions">
     Option 3: Avoid all wider-than-necessary promotions
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#type-promotion-in-jax">
   Type Promotion in JAX
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#appendix-example-type-promotion-tables">
   Appendix: Example Type Promotion Tables
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#numpy-type-promotion">
     NumPy Type Promotion
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#tensorflow-type-promotion">
     Tensorflow Type Promotion
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#pytorch-type-promotion">
     PyTorch Type Promotion
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-type-promotion-jax-numpy">
     JAX Type Promotion:
     <code class="docutils literal notranslate">
<span class="pre">
       jax.numpy
      </span>
</code>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#jax-type-promotion-jax-lax">
     JAX Type Promotion:
     <code class="docutils literal notranslate">
<span class="pre">
       jax.lax
      </span>
</code>
</a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Design of Type Promotion Semantics for JAX"></a><section class="tex2jax_ignore mathjax_ignore" id="design-of-type-promotion-semantics-for-jax">
<h1>Design of Type Promotion Semantics for JAX<a class="headerlink" href="#design-of-type-promotion-semantics-for-jax" title="Permalink to this headline">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/google/jax/blob/main/docs/jep/9407-type-promotion.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a></p>
<p><em>Jake VanderPlas, December 2021</em></p>
<p>One of the challenges faced in the design of any numerical computing library is the choice of how to handle operations between values of different types. This document outlines the thought process behind the promotion semantics used by JAX, summarized in <a class="reference external" href="https://jax.readthedocs.io/en/latest/type_promotion.html">JAX Type Promotion Semantics</a>.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Goals of JAX Type Promotion"></a><section id="goals-of-jax-type-promotion">
<h2>Goals of JAX Type Promotion<a class="headerlink" href="#goals-of-jax-type-promotion" title="Permalink to this headline">#</a></h2>
<p>JAX’s numerical computing API is modeled after that of NumPy, with a few enhancements including the ability to target accelerators like GPU and TPU.
This makes adoption of NumPy’s type promotion system disadvantageous for JAX users: NumPy’s type promotion rules heavily favor 64-bit outputs, which is problematic for computation on accelerators. Devices such as GPUs and TPUs often pay a significant performance penalty to use 64-bit floating point types, and in some cases do not support native 64-bit floating point types at all.</p>
<p>A simple example of this problematic type promotion semantics can be seen in binary operations between 32-bit integers and floats:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('float64')
</pre></div>
</div>
</div>
</div>
<p>NumPy’s tendency to produce 64-bit values is a <a class="reference external" href="https://github.com/numpy/numpy/issues/6860">long-standing issue</a> with using NumPy’s API for accelerator computations, for which there isn’t yet a good solution.
For this reason, JAX has sought to re-think NumPy-style type promotion with accelerators in mind.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Stepping Back: Tables and Lattices"></a><section id="stepping-back-tables-and-lattices">
<h2>Stepping Back: Tables and Lattices<a class="headerlink" href="#stepping-back-tables-and-lattices" title="Permalink to this headline">#</a></h2>
<p>Before we dive into the details, let’s take a moment to step back and think about <em>how</em> to think about the problem of type promotion. Consider arithmetic operations between built-in numerical types in Python, namely those of type <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, and <code class="docutils literal notranslate"><span class="pre">complex</span></code>. With a few lines of code we can generate the type promotion table used by Python for addition between values of these types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="vm">__name__</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">name</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">t2</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">for</span> <span class="n">t1</span> <span class="ow">in</span> <span class="n">types</span><span class="p">]</span> <span class="k">for</span> <span class="n">t2</span> <span class="ow">in</span> <span class="n">types</span><span class="p">],</span>
             <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div id="df-d8b485e9-55e5-412f-a01e-3be03fedc9d8">
<div class="colab-df-container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>int</th>
<th>float</th>
<th>complex</th>
</tr>
</thead>
<tbody>
<tr>
<th>int</th>
<td>int</td>
<td>float</td>
<td>complex</td>
</tr>
<tr>
<th>float</th>
<td>float</td>
<td>float</td>
<td>complex</td>
</tr>
<tr>
<th>complex</th>
<td>complex</td>
<td>complex</td>
<td>complex</td>
</tr>
</tbody>
</table>
</div>
<button class="colab-df-convert" onclick="convertToInteractive('df-d8b485e9-55e5-412f-a01e-3be03fedc9d8')" style="display:none;" title="Convert this dataframe to an interactive table.">
<svg height="24px" viewbox="0 0 24 24" width="24px" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0V0z" fill="none"></path>
<path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
</svg>
</button>
<style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>
<script>
        const buttonEl =
          document.querySelector('#df-d8b485e9-55e5-412f-a01e-3be03fedc9d8 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-d8b485e9-55e5-412f-a01e-3be03fedc9d8');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
</div>
</div>
</div></div>
</div>
<p>This table enumerates Python’s numerical type promotion behavior, but it turns out there is a complementary representation that is much more compact: a <a class="reference external" href="https://en.wikipedia.org/wiki/Lattice_(order)">Lattice</a> representation, where the <a class="reference external" href="https://en.wikipedia.org/wiki/Infimum_and_supremum">supremum</a> between any two nodes is the type that they promote to. The lattice representation of Python’s promotion table is much simpler:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'int'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'float'</span><span class="p">],</span> <span class="s1">'float'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'complex'</span><span class="p">]}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'int'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'float'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'complex'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/818a3cf499d15c3be1d4c116db142da0418c174873f21e1ffcde679c6058f918.png" src="../_images/818a3cf499d15c3be1d4c116db142da0418c174873f21e1ffcde679c6058f918.png"/>
</div>
</div>
<p>This lattice is a compact encoding of the information in the promotion table above. You can find the result of a type promotion for two inputs by tracing the graph to the first common child of the two nodes (including the nodes themselves); mathematically, this common child is known as the <em>supremum</em>, or <em>least upper bound</em>, or <em>join</em> of the pair on the lattice; here we will refer to this operation as the <strong>join</strong>.</p>
<p>Conceptually, an arrow means that <em>implicit type promotion is allowed</em> between the source and the destination: for example, implicit promotion from integer to float is allowed, but implicit promotion from float to integer is not.</p>
<p>Keep in mind that in general not every directed acyclic graph (DAG) will satisfy the properties of a lattice. A lattice requires the existence of a unique least upper bound for every pair of nodes; so, for example the following two DAGs are not lattices:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'A'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">]}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'A'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'B'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'C'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]}</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'A'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'C'</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">],</span> <span class="s1">'B'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'C'</span><span class="p">,</span> <span class="s1">'D'</span><span class="p">]}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'A'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'B'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="s1">'C'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'D'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]}</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/a0acbd07f9486d95c10a36c11301d528fb7e65d671d622226151c431b3e36c62.png" src="../_images/a0acbd07f9486d95c10a36c11301d528fb7e65d671d622226151c431b3e36c62.png"/>
</div>
</div>
<p>The left DAG is not a lattice because there exists no upper bound for nodes <code class="docutils literal notranslate"><span class="pre">B</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code>; the right DAG fails on two counts: first, there exists no upper bound for nodes <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code>, and for nodes <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> the least upper bound cannot be <em>uniquely</em> determined: both <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code> are candidates, but they are unorderable.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Properties of a Type Promotion Lattice"></a><section id="properties-of-a-type-promotion-lattice">
<h3>Properties of a Type Promotion Lattice<a class="headerlink" href="#properties-of-a-type-promotion-lattice" title="Permalink to this headline">#</a></h3>
<p>Specifying type promotions in terms of a lattice ensures a number of useful properties. Denoting the join on the lattice with the <span class="math notranslate nohighlight">\(\vee\)</span> operator, we have:</p>
<p><strong>Existence:</strong> A lattice by definition requires that a unique lattice join exists for every pair of elements: <span class="math notranslate nohighlight">\(\forall (a, b): \exists !(a \vee b)\)</span></p>
<p><strong>Commutativity:</strong> The lattice join is commutative: <span class="math notranslate nohighlight">\(\forall (a, b): a\vee b = b \vee a\)</span>.</p>
<p><strong>Associativity:</strong> The lattice join is associative: <span class="math notranslate nohighlight">\(\forall (a, b, c): a \vee (b \vee c) = (a \vee b) \vee c\)</span>.</p>
<p>On the other hand, these properties imply restrictions on the type promotion systems they can represent; in particular <strong>not every type promotion table can be represented by a lattice</strong>. A ready example of this is NumPy’s full type promotion table; this can be shown quickly by counterexample: here are three scalar types whose promotion behavior in NumPy is non-associative:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>float32
float16
</pre></div>
</div>
</div>
</div>
<p>Such a result may come as a surprise to users: we generally expect mathematical expressions to map to mathematical concepts, so, for example, <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">c</span></code> should be equivalent to <code class="docutils literal notranslate"><span class="pre">c</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">+</span> <span class="pre">a</span></code>; <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">(y</span> <span class="pre">+</span> <span class="pre">z)</span></code> should be equivalent to <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">*</span> <span class="pre">y</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">*</span> <span class="pre">z</span></code>. If type promotion is non-associative or non-commutative, these properties no longer apply.</p>
<p>Further, a lattice-based type promotion system is simpler to conceptualize and understand when compared to a table-based system. For example, JAX recognizes 18 distinct types: a promotion lattice consisting of 18 nodes and sparse, well-motivated connections between them is far easier to hold in one’s mind than a table of 324 entries.</p>
<p>For this reason, we opt to use a lattice-based type promotion system for JAX.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Type Promotion within Categories"></a><section id="type-promotion-within-categories">
<h2>Type Promotion within Categories<a class="headerlink" href="#type-promotion-within-categories" title="Permalink to this headline">#</a></h2>
<p>Numerical computing libraries generally provide more than just <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, and <code class="docutils literal notranslate"><span class="pre">complex</span></code>; within each of these categories there are a variety of possible precisions, denoted by the number of bits used in the numerical representation. The categories we will consider here are:</p>
<ul class="simple">
<li><p><em>unsigned integers</em> which include <code class="docutils literal notranslate"><span class="pre">uint8</span></code>, <code class="docutils literal notranslate"><span class="pre">uint16</span></code>, <code class="docutils literal notranslate"><span class="pre">uint32</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">uint64</span></code> (we’ll use <code class="docutils literal notranslate"><span class="pre">u8</span></code>, <code class="docutils literal notranslate"><span class="pre">u16</span></code>, <code class="docutils literal notranslate"><span class="pre">u32</span></code>, <code class="docutils literal notranslate"><span class="pre">u64</span></code> for short)</p></li>
<li><p><em>signed integers</em> which include <code class="docutils literal notranslate"><span class="pre">int8</span></code>, <code class="docutils literal notranslate"><span class="pre">int16</span></code>, <code class="docutils literal notranslate"><span class="pre">int32</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">int64</span></code> (we’ll use <code class="docutils literal notranslate"><span class="pre">i8</span></code>, <code class="docutils literal notranslate"><span class="pre">i16</span></code>, <code class="docutils literal notranslate"><span class="pre">i32</span></code>, <code class="docutils literal notranslate"><span class="pre">i64</span></code> for short)</p></li>
<li><p><em>floating point</em>, which include <code class="docutils literal notranslate"><span class="pre">float16</span></code>, <code class="docutils literal notranslate"><span class="pre">float32</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">float64</span></code> (we’ll use <code class="docutils literal notranslate"><span class="pre">f16</span></code>, <code class="docutils literal notranslate"><span class="pre">f32</span></code>, <code class="docutils literal notranslate"><span class="pre">f64</span></code> for short)</p></li>
<li><p><em>complex floating point</em>, which include <code class="docutils literal notranslate"><span class="pre">complex64</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">complex128</span></code> (we’ll use <code class="docutils literal notranslate"><span class="pre">c64</span></code>, <code class="docutils literal notranslate"><span class="pre">c128</span></code> for short)</p></li>
</ul>
<p>Numpy’s type promotion semantics <strong>within</strong> each of these four categories is relatively straightforward: the ordered hierarchy of types translates directly to four separate lattices representing in-category type promotion rules:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/2d8495bcb006c34b42eeb4f3e0c6530fdef0bd7364c56184993925f0cf157abc.png" src="../_images/2d8495bcb006c34b42eeb4f3e0c6530fdef0bd7364c56184993925f0cf157abc.png"/>
</div>
</div>
<p>In terms of promotion of values to 64-bit that JAX seeks to avoid, these same-kind promotion semantics within each type category are unproblematic: the only way to produce a 64-bit output is to have a 64-bit input.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Enter Python Scalars"></a><section id="enter-python-scalars">
<h2>Enter Python Scalars<a class="headerlink" href="#enter-python-scalars" title="Permalink to this headline">#</a></h2>
<p>Let’s now think about where Python scalars fit into the mix.</p>
<p>In NumPy, promotion behavior differs depending on whether the inputs are arrays or scalars. For example, when operating on two scalars, normal promotion rules apply:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># int8 scalar</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Python int = int64 scalar</span>
<span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('int64')
</pre></div>
</div>
</div>
</div>
<p>Here the Python value <code class="docutils literal notranslate"><span class="pre">1</span></code> is treated as an <code class="docutils literal notranslate"><span class="pre">int64</span></code>, and straightforward within-category rules lead to an <code class="docutils literal notranslate"><span class="pre">int64</span></code> result.</p>
<p>In operations between Python scalars and NumPy arrays, however, scalars defer to the dtype of the array. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'int8'</span><span class="p">)</span>  <span class="c1"># int8 array</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Python int = int64 scalar</span>
<span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('int8')
</pre></div>
</div>
</div>
</div>
<p>Here the bit width of the <code class="docutils literal notranslate"><span class="pre">int64</span></code> scalar is ignored, deferring to the bit width of the array.</p>
<p>There is another detail here: when NumPy type promotion involves a scalar, the output dtype is value-dependent: if the Python scalar is too large for the given dtype, it is promoted to a compatible type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'int8'</span><span class="p">)</span>  <span class="c1"># int8 array</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># int64 scalar</span>
<span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('int16')
</pre></div>
</div>
</div>
</div>
<p>For the purposes of JAX, <strong>value-dependent promotion is a non-starter</strong> because of the nature of JIT compilation and other transformations, which act on abstract representations of data without reference to their value.</p>
<p>Ignoring value-dependent effects, the signed integer branch of NumPy’s type promotion can be represented in the following lattice, where we’ll use <code class="docutils literal notranslate"><span class="pre">*</span></code> to mark scalar dtypes:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i8*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16*'</span><span class="p">],</span> <span class="s1">'i16*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32*'</span><span class="p">],</span> <span class="s1">'i32*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64*'</span><span class="p">],</span> <span class="s1">'i64*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i8'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i8*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="s2">"Scalar Types"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="s2">"Array Types"</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/7e8c3295e403209560d8e142c5c830d79456a4e6d207dd1a7e4d15b55c56006b.png" src="../_images/7e8c3295e403209560d8e142c5c830d79456a4e6d207dd1a7e4d15b55c56006b.png"/>
</div>
</div>
<p>A similar pattern holds within the <code class="docutils literal notranslate"><span class="pre">uint</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, and <code class="docutils literal notranslate"><span class="pre">complex</span></code> lattices.</p>
<p>For the sake of simplicity, let’s collapse each category of scalar types into a single node, denoted by <code class="docutils literal notranslate"><span class="pre">u*</span></code>, <code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, and <code class="docutils literal notranslate"><span class="pre">c*</span></code> respectively. Our set of in-category lattices can now be represented like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'u*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u8'</span><span class="p">],</span> <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">],</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'u*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/0fbe0c20cd350821e64f3742aa7864ec729565572b136950042095881672fdb9.png" src="../_images/0fbe0c20cd350821e64f3742aa7864ec729565572b136950042095881672fdb9.png"/>
</div>
</div>
<p>In some senses, putting scalars at the left is a strange choice: the scalar types may contain values of any width, but when interacting with an array of a given type, the promotion result defers to the array type.
The benefit of this is that when you perform an operation like <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">2</span></code> for an array <code class="docutils literal notranslate"><span class="pre">x</span></code>, the type of <code class="docutils literal notranslate"><span class="pre">x</span></code> will carry to the result no matter its width:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
  <span class="k">assert</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">dtype</span>
</pre></div>
</div>
</div>
</div>
<p>This behavior gives motivation to our <code class="docutils literal notranslate"><span class="pre">*</span></code> notation for scalar values: the <code class="docutils literal notranslate"><span class="pre">*</span></code> is reminiscent of a wildcard that can take on any desired value.</p>
<p>The benefit of these semantics are that you can readily express sequences of operations with clean Python code, without having to explicitly cast scalars to the appropriate type. Imagine if rather than writing this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
<p>you had to write this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Although it is explicit, numerical code would become tedious to read or write. With the scalar promotion semantics described above, given an array <code class="docutils literal notranslate"><span class="pre">x</span></code> of type <code class="docutils literal notranslate"><span class="pre">int32</span></code>, the types in the second statement are implicit within the first.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Combining Lattices"></a><section id="combining-lattices">
<h2>Combining Lattices<a class="headerlink" href="#combining-lattices" title="Permalink to this headline">#</a></h2>
<p>Recall that we began our discussion by introducing the lattice representing type promotion within Python: <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">float</span> <span class="pre">-&gt;</span> <span class="pre">complex</span></code>. Let’s rewrite this as <code class="docutils literal notranslate"><span class="pre">i*</span> <span class="pre">-&gt;</span> <span class="pre">f*</span> <span class="pre">-&gt;</span> <span class="pre">c*</span></code>, and let’s further allow <code class="docutils literal notranslate"><span class="pre">i*</span></code> to subsume <code class="docutils literal notranslate"><span class="pre">u*</span></code> (after all, there is no unsigned integer scalar type in Python).</p>
<p>Putting these all together, we get the following partial lattice representing type promotion between Python scalars and numpy arrays:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">,</span> <span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/796586be87180b0de3171d39763f2d33a80a641b72d82c00f0c0e352f754f201.png" src="../_images/796586be87180b0de3171d39763f2d33a80a641b72d82c00f0c0e352f754f201.png"/>
</div>
</div>
<p>Notice that this is not (yet) a true lattice: there are many pairs of nodes for which a join does not exist. However, we can think of this as a <em>partial</em> lattice, in which some pairs of nodes do not have a defined promotion behavior, and the defined portion of this partial lattice does correctly describe NumPy’s array promotion behavior (leaving aside value-dependent semantics mentioned above).</p>
<p>This sets up a nice framework by which we can think about filling-out these undefined promotion rules, by adding connections on this graph. But which connections to add?
Broadly speaking, we want any additional connections to satisfy a few properties:</p>
<ol class="arabic simple">
<li><p>Promotion should satisfy the commutative and associative properties: in other words, the graph should remain a (partial) lattice.</p></li>
<li><p>Promotion should never allow for dropping entire components of data: for example, we should never promote <code class="docutils literal notranslate"><span class="pre">complex</span></code> to <code class="docutils literal notranslate"><span class="pre">float</span></code>, as it would discard any imaginary parts.</p></li>
<li><p>Promotion should never lead to an unhandled overflow. For example, the maximum possible <code class="docutils literal notranslate"><span class="pre">uint32</span></code> is twice as large as the maximum possible <code class="docutils literal notranslate"><span class="pre">int32</span></code>, so we should not implicitly promote <code class="docutils literal notranslate"><span class="pre">uint32</span></code> to <code class="docutils literal notranslate"><span class="pre">int32</span></code>.</p></li>
<li><p>Wherever possible, promotion should avoid loss of precision. For example, an <code class="docutils literal notranslate"><span class="pre">int64</span></code> value may have 64 bits of mantissa, so promoting <code class="docutils literal notranslate"><span class="pre">int64</span></code> to <code class="docutils literal notranslate"><span class="pre">float64</span></code> represents a possible loss of precision. However, the maximum representable float64 is larger than the maximum representable int64, so in this case criterion #3 is still satisfied.</p></li>
<li><p>Wherever possible, binary promotion should avoid resulting in types that are wider than the inputs. This is to ensure that JAX’s implicit promotions remain friendly to accelerator-based workflows, in which users often want to restrict types to 32-bit (or in some cases 16-bit) values.</p></li>
</ol>
<p>Each new connection on the lattice introduces some level of convenience to the user (a new set of types that can interact without explicit casting), but the convenience may becomes too costly if any of the above criteria are violated. Developing a full promotion lattice involves striking a balance between this convenience and this cost.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Mixed Promotion: Float and Complex"></a><section id="mixed-promotion-float-and-complex">
<h2>Mixed Promotion: Float and Complex<a class="headerlink" href="#mixed-promotion-float-and-complex" title="Permalink to this headline">#</a></h2>
<p>Let’s begin with what is perhaps the easiest case, that of promotion between float and complex values.</p>
<p>Complex numbers are made up of pairs of floating point numbers, and so we have a natural path of promotion between them: cast float to complex while maintaining the width of the real part. In terms of our partial lattice representation, it would look like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">,</span> <span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/bf87909b2344aed80590d1c6d91585a02b25898ac217526cb49948d91205318f.png" src="../_images/bf87909b2344aed80590d1c6d91585a02b25898ac217526cb49948d91205318f.png"/>
</div>
</div>
<p>This turns out to represent exactly the semantics used by Numpy in mixed float/complex type promotion.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Mixed Promotion: Signed &amp; Unsigned Integers"></a><section id="mixed-promotion-signed-unsigned-integers">
<h2>Mixed Promotion: Signed &amp; Unsigned Integers<a class="headerlink" href="#mixed-promotion-signed-unsigned-integers" title="Permalink to this headline">#</a></h2>
<p>For the next case, let’s consider something a bit more difficult: promotion between signed and unsigned integers. For example, when promoting <code class="docutils literal notranslate"><span class="pre">uint8</span></code> to a signed integer, how many bits do we need?</p>
<p>At first glance, you might think it natural to promote <code class="docutils literal notranslate"><span class="pre">uint8</span></code> to <code class="docutils literal notranslate"><span class="pre">int8</span></code>; but the largest <code class="docutils literal notranslate"><span class="pre">uint8</span></code> numbers are not representable in <code class="docutils literal notranslate"><span class="pre">int8</span></code>. For this reason, it makes more sense to promote unsigned integers to integers with twice the number of bits; this promotion behavior can be represented by adding the following connections to the promotion lattice:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">,</span> <span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/3be7e17889458ac823bb5dacf31525c0d96578c6854962f45dcc60ec987a30bd.png" src="../_images/3be7e17889458ac823bb5dacf31525c0d96578c6854962f45dcc60ec987a30bd.png"/>
</div>
</div>
<p>Again, the connections added here are precisely the promotion semantics implemented by Numpy for mixed-integer promotion.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/How to handle uint64?"></a><section id="how-to-handle-uint64">
<h3>How to handle <code class="docutils literal notranslate"><span class="pre">uint64</span></code>?<a class="headerlink" href="#how-to-handle-uint64" title="Permalink to this headline">#</a></h3>
<p>The approached to mixed signed/unsigned integer promotion leaves out one type: <code class="docutils literal notranslate"><span class="pre">uint64</span></code>. Following the pattern above, the output of a mixed-integer opertion involving <code class="docutils literal notranslate"><span class="pre">uint64</span></code> should result in <code class="docutils literal notranslate"><span class="pre">int128</span></code>, but this is not a standard available dtype.</p>
<p>Numpy’s choice here is to promote to <code class="docutils literal notranslate"><span class="pre">float64</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dtype('float64')
</pre></div>
</div>
</div>
</div>
<p>However, this may be a surprising convention: it’s the only case in which promotion of integer types does not result in an integer.
For now, we will leave <code class="docutils literal notranslate"><span class="pre">uint64</span></code> promotion undefined, and return to it later.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Mixed Promotion: Integer and Floating"></a><section id="mixed-promotion-integer-and-floating">
<h2>Mixed Promotion: Integer and Floating<a class="headerlink" href="#mixed-promotion-integer-and-floating" title="Permalink to this headline">#</a></h2>
<p>When promoting integers to floating point, we might start with the same thought process as mixed promotion between signed and unsigned integers. A 16-bit signed or unsigned integer cannot be represented at full precision by a 16-bit float, which has only 10 bits of mantissa. Therefore, it might make sense to promote integers to floats represented by twice the number of bits:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">,</span> <span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8b3247e8189fbfad46a7e5583b636866fc45576e07c9bfd904457926306299d1.png" src="../_images/8b3247e8189fbfad46a7e5583b636866fc45576e07c9bfd904457926306299d1.png"/>
</div>
</div>
<p>This is effectively what Numpy type promotion does, but in doing so it breaks the lattice property of the graph: for example, the pair <em>{i8, u8}</em> no longer has a unique least upper bound: the possibilities are <em>i16</em> and <em>f16</em>, which are unorderable on the graph. This turns out to be the source of NumPy’s non-associative type promotion highlighted above.</p>
<p>Can we come up with a modification of NumPy’s promotion rules, such that it will satisfy the lattice property, while also giving sensible results for mixed type promotion? There are a few approaches we could take here.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Option 0: Leave integer/floating mixed precision undefined"></a><section id="option-0-leave-integer-floating-mixed-precision-undefined">
<h3>Option 0: Leave integer/floating mixed precision undefined<a class="headerlink" href="#option-0-leave-integer-floating-mixed-precision-undefined" title="Permalink to this headline">#</a></h3>
<p>To make behavior utterly predictable (at some cost to user convenience), a defensible choice would be to leave as undefined any mixed integer/float promotion beyond Python scalars, stopping with the partial lattice from the previous section. The downside would be the requirement for users to explicitly type-cast when operating between integer and floating-point quantities.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Option 1: Avoiding All Precision Loss"></a><section id="option-1-avoiding-all-precision-loss">
<h3>Option 1: Avoiding All Precision Loss<a class="headerlink" href="#option-1-avoiding-all-precision-loss" title="Permalink to this headline">#</a></h3>
<p>If our focus is on avoiding precision loss at all costs, we can restore the lattice property by promoting unsigned integers to float via their existing signed integer paths:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">,</span> <span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1eda89d008a8c6dadf926229bf9f2245722006c5bc1c42961c555a2595c95117.png" src="../_images/1eda89d008a8c6dadf926229bf9f2245722006c5bc1c42961c555a2595c95117.png"/>
</div>
</div>
<p>A disadvantage of this approach is that it still leaves <code class="docutils literal notranslate"><span class="pre">int64</span></code> and <code class="docutils literal notranslate"><span class="pre">uint64</span></code> promotion undefined, because there is no standard floating point type with enough bits of mantissa to represent their full range of values. We could relax the precision constraint and complete the lattice by drawing connections from <code class="docutils literal notranslate"><span class="pre">i64-&gt;f64</span></code> and <code class="docutils literal notranslate"><span class="pre">u64-&gt;f64</span></code>, but those links would run counter to the motivation for this promotion scheme.</p>
<p>A second disadvantage is that this lattice makes it difficult to find a sensible place to insert <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> (see below) while maintaining the lattice property.</p>
<p>A third disadvantage of this approach, more important for JAX’s accelerator backends, is that some operations result in types that are much wider than necessary; for example mixed operations between <code class="docutils literal notranslate"><span class="pre">uint16</span></code> and <code class="docutils literal notranslate"><span class="pre">float16</span></code> would promote all the way to <code class="docutils literal notranslate"><span class="pre">float64</span></code>, which is not ideal.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Option 2: Avoid most wider-than-necessary promotions"></a><section id="option-2-avoid-most-wider-than-necessary-promotions">
<h3>Option 2: Avoid most wider-than-necessary promotions<a class="headerlink" href="#option-2-avoid-most-wider-than-necessary-promotions" title="Permalink to this headline">#</a></h3>
<p>To address the unnecessary promotions to wider types, we could accept the possibility of some precision loss in integer/float promotion, promoting signed integers to floats of the same width:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">,</span> <span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f16'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f41cee38a476bf636be901e7f64a5dc3687002f9d12532ab706b9077d602b175.png" src="../_images/f41cee38a476bf636be901e7f64a5dc3687002f9d12532ab706b9077d602b175.png"/>
</div>
</div>
<p>While this does allow for precision-losing promotions between integers and floats, these promotions will not mis-represent the <em>magnitude</em> of the result: though the floating point mantissa is not wide enough to represent all values, the exponent is wide enough to approximate them.</p>
<p>This approach also allows a natural promotion path from <code class="docutils literal notranslate"><span class="pre">int64</span></code> to <code class="docutils literal notranslate"><span class="pre">float64</span></code>, though <code class="docutils literal notranslate"><span class="pre">uint64</span></code> remains unpromotable in this scheme. That said, a connection from <code class="docutils literal notranslate"><span class="pre">u64</span></code> to <code class="docutils literal notranslate"><span class="pre">f64</span></code> could be justified more readily here than before.</p>
<p>This promotion scheme still results in some wider than necessary promotion paths; for example operations between <code class="docutils literal notranslate"><span class="pre">float32</span></code> and <code class="docutils literal notranslate"><span class="pre">uint32</span></code> result in <code class="docutils literal notranslate"><span class="pre">float64</span></code>. Additionally, this lattice makes it difficult to find a sensible place to insert <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> (see below) while maintaining the lattice property.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Option 3: Avoid all wider-than-necessary promotions"></a><section id="option-3-avoid-all-wider-than-necessary-promotions">
<h3>Option 3: Avoid all wider-than-necessary promotions<a class="headerlink" href="#option-3-avoid-all-wider-than-necessary-promotions" title="Permalink to this headline">#</a></h3>
<p>We can avoid <em>all</em> non-ideal 64-bit promotions if we’re willing to fundamentally change our thinking around integer and float promotions.
Just as scalars always defer to the widths of array types, we can make integers always defer to the width of float types:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d3f5e5be4354238a60698cb4f228d4e1f75a665577343c36b2c1ade1207783a0.png" src="../_images/d3f5e5be4354238a60698cb4f228d4e1f75a665577343c36b2c1ade1207783a0.png"/>
</div>
</div>
<p>This involves a small sleight of hand: previously we had used <code class="docutils literal notranslate"><span class="pre">f*</span></code> to refer to a scalar type. In this lattice, <code class="docutils literal notranslate"><span class="pre">f*</span></code> might be applied to the array output of a mixed computation. Instead of thinking of <code class="docutils literal notranslate"><span class="pre">f*</span></code> as a scalar, we could think of it as a special kind of <code class="docutils literal notranslate"><span class="pre">float</span></code> value with distinct promotion rules: in JAX we refer to this as a <em>weak float</em>; see below.</p>
<p>The advantage of this approach is that, outside unsigned ints, it avoids <em>all</em> wider-than-necessary promotions: you can never get an f64 output without a 64-bit input, and you can never get an f32 output without a 32-bit input: this results in convenient semantics for working on accelerators while avoiding inadvertent 64-bit values.</p>
<p>This feature of giving primacy to floating point types resembles the type promotion behavior of PyTorch.
This lattice also happens to generate a promotion table that very closely resembles JAX’s original <em>ad hoc</em> type promotion scheme, which was not based on a lattice but had the property of giving primacy to floating point types.</p>
<p>This lattice additionally offers a natural location to insert <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code>, without the need to impose an ordering between <code class="docutils literal notranslate"><span class="pre">bf16</span></code> and <code class="docutils literal notranslate"><span class="pre">f16</span></code>:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">,</span> <span class="s1">'bf16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'bf16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">],</span> <span class="s1">'bf16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/aa73688b580b02776fce218d6efe58792ae3b0976160a4b0c130b797780578af.png" src="../_images/aa73688b580b02776fce218d6efe58792ae3b0976160a4b0c130b797780578af.png"/>
</div>
</div>
<p>This is important because <code class="docutils literal notranslate"><span class="pre">f16</span></code> and <code class="docutils literal notranslate"><span class="pre">bf16</span></code> are not comparable because they utilize their bits differently: <code class="docutils literal notranslate"><span class="pre">bf16</span></code> represents a larger range at lower precision, while <code class="docutils literal notranslate"><span class="pre">f16</span></code> represents a smaller range at higher precision.</p>
<p>However, these advantages comes with a few tradeoffs:</p>
<ul class="simple">
<li><p>mixed float/integer promotion is very prone to precision loss: for example, <code class="docutils literal notranslate"><span class="pre">int64</span></code> (with a maximum value of <span class="math notranslate nohighlight">\(9.2 \times 10^{18}\)</span>) can be promoted to <code class="docutils literal notranslate"><span class="pre">float16</span></code> (with a maximum value of <span class="math notranslate nohighlight">\(6.5 \times 10^4\)</span>), meaning most representable values will become <code class="docutils literal notranslate"><span class="pre">inf</span></code>.</p></li>
<li><p>as mentioned above, <code class="docutils literal notranslate"><span class="pre">f*</span></code> can no longer be thought of as a “scalar type”, but whether as a different flavor of float64. In JAX’s parlance, this is referred to as a <a class="reference external" href="https://jax.readthedocs.io/en/latest/type_promotion.html#weakly-typed-values-in-jax"><em>weak type</em></a>, in that it is represented as 64-bit, but only weakly holds to this bit width in promotion with other values.</p></li>
</ul>
<p>Note that also, this approach still leaves the <code class="docutils literal notranslate"><span class="pre">uint64</span></code> promotion question unanswered, although it is perhaps reasonable to close the lattice by connecting <code class="docutils literal notranslate"><span class="pre">u64</span></code> to <code class="docutils literal notranslate"><span class="pre">f*</span></code>.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Type Promotion in JAX"></a><section id="type-promotion-in-jax">
<h2>Type Promotion in JAX<a class="headerlink" href="#type-promotion-in-jax" title="Permalink to this headline">#</a></h2>
<p>In designing the type promotion semantics of JAX, we kept in mind many of these ideas, and leaned heavily on a few things:</p>
<ol class="arabic simple">
<li><p>We chose to constrain JAX’s type promotion semantics to graphs that satisfy the lattice property: this is to ensure associativity and commutativity, but also to allow the semantics to be compactly described in a DAG, rather than requiring a large table.</p></li>
<li><p>We leaned toward semantics that avoid inadvertent promotion to wider types, particularly when it comes to float values, in order to benefit computation on accelerators.</p></li>
<li><p>We were fine accepting potential loss of precision (but not loss of magnitude) in mixed type promotion if it were required to maintain (1) and (2)</p></li>
</ol>
<p>With this in mind, JAX has adopted Option 3. Or rather, a slightly modified version of Option 3 that draws the connection between <code class="docutils literal notranslate"><span class="pre">u64</span></code> and <code class="docutils literal notranslate"><span class="pre">f*</span></code>, in order to create a true lattice.
Rearranging the nodes for clarity, JAX’s type promotion lattice then looks like this:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">lattice</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u8'</span><span class="p">,</span> <span class="s1">'i8'</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c*'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">,</span> <span class="s1">'bf16'</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c64'</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u16'</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u32'</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'u64'</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i16'</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i32'</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'i64'</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f*'</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'bf16'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f32'</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'f64'</span><span class="p">,</span> <span class="s1">'c64'</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'c128'</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">from_dict_of_lists</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="n">create_using</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="s1">'f16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.75</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span> <span class="s1">'bf16'</span><span class="p">:</span> <span class="p">[</span><span class="mf">5.75</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="s1">'lightgray'</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># ax.patches[12].set_linestyle((0, (2, 4)))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/d261add493a579484d9772634ce146f1240af3966d0845839c354417a3de2e53.png" src="../_images/d261add493a579484d9772634ce146f1240af3966d0845839c354417a3de2e53.png"/>
</div>
</div>
<p>The behavior resulting from this choice is summarized in <a class="reference external" href="https://jax.readthedocs.io/en/latest/type_promotion.html">JAX Type Promotion Semantics</a>. Notably, aside from the inclusion of larger unsigned types (<code class="docutils literal notranslate"><span class="pre">u16</span></code>, <code class="docutils literal notranslate"><span class="pre">u32</span></code>, <code class="docutils literal notranslate"><span class="pre">u64</span></code>) and some details about the behavior of scalar/weak types (<code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, <code class="docutils literal notranslate"><span class="pre">c*</span></code>), this type promotion scheme turns out to be very close to that chosen by PyTorch.</p>
<p>For those interested, the appendix below prints the full promotion tables used by NumPy, Tensorflow, PyTorch, and JAX.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Appendix: Example Type Promotion Tables"></a><section id="appendix-example-type-promotion-tables">
<h2>Appendix: Example Type Promotion Tables<a class="headerlink" href="#appendix-example-type-promotion-tables" title="Permalink to this headline">#</a></h2>
<p>The following are some examples of implicit type promotion tables implemented by various Python array computing libraries.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/NumPy Type Promotion"></a><section id="numpy-type-promotion">
<h3>NumPy Type Promotion<a class="headerlink" href="#numpy-type-promotion" title="Permalink to this headline">#</a></h3>
<p>Note that NumPy does not include the <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> dtype, and that the table below ignores value-dependent effects.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">np_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'b'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
  <span class="s1">'bf16'</span><span class="p">:</span> <span class="s1">'invalid'</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>

<span class="n">np_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">np_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">make_np_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">np_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_np_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_np_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">'-'</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">np_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>


<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">np_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">np_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">np_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">np_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
<thead>
<tr style="text-align: right;">
<th></th>
<th>b</th>
<th>u8</th>
<th>u16</th>
<th>u32</th>
<th>u64</th>
<th>i8</th>
<th>i16</th>
<th>i32</th>
<th>i64</th>
<th>bf16</th>
<th>f16</th>
<th>f32</th>
<th>f64</th>
<th>c64</th>
<th>c128</th>
<th>i*</th>
<th>f*</th>
<th>c*</th>
</tr>
</thead>
<tbody>
<tr>
<th>b</th>
<td>b</td>
<td>u8</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>u8</th>
<td>u8</td>
<td>u8</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u8</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>u16</th>
<td>u16</td>
<td>u16</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u16</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>u32</th>
<td>u32</td>
<td>u32</td>
<td>u32</td>
<td>u32</td>
<td>u64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>u32</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>u64</th>
<td>u64</td>
<td>u64</td>
<td>u64</td>
<td>u64</td>
<td>u64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>u64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>i8</th>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>f64</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i8</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>i16</th>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>f64</td>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i16</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>i32</th>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>f64</td>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>i32</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>i64</th>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>f64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>i64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>bf16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>f16</th>
<td>f16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>f64</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>f64</td>
<td>-</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f16</td>
<td>f16</td>
<td>c64</td>
</tr>
<tr>
<th>f32</th>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>f64</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>f64</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f32</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>f64</th>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>c64</th>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c128</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c128</td>
<td>-</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
</tr>
<tr>
<th>c128</th>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>-</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
</tr>
<tr>
<th>i*</th>
<td>i64</td>
<td>u8</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>-</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>f*</th>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>-</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>c*</th>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>-</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
</tr>
</tbody>
</table></div></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Tensorflow Type Promotion"></a><section id="tensorflow-type-promotion">
<h3>Tensorflow Type Promotion<a class="headerlink" href="#tensorflow-type-promotion" title="Permalink to this headline">#</a></h3>
<p>Tensorflow avoids defining implicit type promotion, except for Python scalars in limited cases. The table is asymmetric because in <code class="docutils literal notranslate"><span class="pre">tf.add(x,</span> <span class="pre">y)</span></code>, the type of <code class="docutils literal notranslate"><span class="pre">y</span></code> must be coercable to the type of <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">tf_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'b'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint16</span><span class="p">,</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint64</span><span class="p">,</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
  <span class="s1">'bf16'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>

<span class="n">tf_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">tf_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">make_tf_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_tf_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_tf_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">'-'</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">tf_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">tf_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>


<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">tf_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">tf_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">tf_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">tf_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
<thead>
<tr style="text-align: right;">
<th></th>
<th>b</th>
<th>u8</th>
<th>u16</th>
<th>u32</th>
<th>u64</th>
<th>i8</th>
<th>i16</th>
<th>i32</th>
<th>i64</th>
<th>bf16</th>
<th>f16</th>
<th>f32</th>
<th>f64</th>
<th>c64</th>
<th>c128</th>
<th>i*</th>
<th>f*</th>
<th>c*</th>
</tr>
</thead>
<tbody>
<tr>
<th>b</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u8</th>
<td>-</td>
<td>u8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u8</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u16</th>
<td>-</td>
<td>-</td>
<td>u16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u16</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u32</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u64</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i8</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i8</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i16</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i32</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i64</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>bf16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>bf16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>bf16</td>
<td>bf16</td>
<td>-</td>
</tr>
<tr>
<th>f16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f16</td>
<td>f16</td>
<td>-</td>
</tr>
<tr>
<th>f32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>-</td>
</tr>
<tr>
<th>f64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f64</td>
<td>-</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>-</td>
</tr>
<tr>
<th>c64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c64</td>
<td>-</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
</tr>
<tr>
<th>c128</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
</tr>
<tr>
<th>i*</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i32</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>f*</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>-</td>
</tr>
<tr>
<th>c*</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
</tr>
</tbody>
</table></div></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/PyTorch Type Promotion"></a><section id="pytorch-type-promotion">
<h3>PyTorch Type Promotion<a class="headerlink" href="#pytorch-type-promotion" title="Permalink to this headline">#</a></h3>
<p>Notice that torch does not include unsigned integer types larger than <code class="docutils literal notranslate"><span class="pre">uint8</span></code>.
Aside from this and some details about promotion with scalar/weak types, the table is close to that used by <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">torch_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'b'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="s1">'invalid'</span><span class="p">,</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="s1">'invalid'</span><span class="p">,</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="s1">'invalid'</span><span class="p">,</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int8</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
  <span class="s1">'bf16'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>

<span class="n">torch_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">torch_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">make_torch_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">torch_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_torch_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_torch_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">'-'</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">torch_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">torch_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>


<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">torch_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">torch_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">torch_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">torch_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">torch_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
<thead>
<tr style="text-align: right;">
<th></th>
<th>b</th>
<th>u8</th>
<th>u16</th>
<th>u32</th>
<th>u64</th>
<th>i8</th>
<th>i16</th>
<th>i32</th>
<th>i64</th>
<th>bf16</th>
<th>f16</th>
<th>f32</th>
<th>f64</th>
<th>c64</th>
<th>c128</th>
<th>i*</th>
<th>f*</th>
<th>c*</th>
</tr>
</thead>
<tbody>
<tr>
<th>b</th>
<td>b</td>
<td>u8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i64</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>u8</th>
<td>u8</td>
<td>u8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u8</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>u16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i8</th>
<td>i8</td>
<td>i16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i8</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>i16</th>
<td>i16</td>
<td>i16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i16</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>i32</th>
<td>i32</td>
<td>i32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i32</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>i64</th>
<td>i64</td>
<td>i64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i64</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>bf16</th>
<td>bf16</td>
<td>bf16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>bf16</td>
<td>bf16</td>
<td>c64</td>
</tr>
<tr>
<th>f16</th>
<td>f16</td>
<td>f16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f32</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f16</td>
<td>f16</td>
<td>c64</td>
</tr>
<tr>
<th>f32</th>
<td>f32</td>
<td>f32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f32</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>f64</th>
<td>f64</td>
<td>f64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>c64</th>
<td>c64</td>
<td>c64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
</tr>
<tr>
<th>c128</th>
<td>c128</td>
<td>c128</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
</tr>
<tr>
<th>i*</th>
<td>i64</td>
<td>u8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i64</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>f*</th>
<td>f32</td>
<td>f32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
</tr>
<tr>
<th>c*</th>
<td>c64</td>
<td>c64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
</tr>
</tbody>
</table></div></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/JAX Type Promotion: jax.numpy"></a><section id="jax-type-promotion-jax-numpy">
<h3>JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code><a class="headerlink" href="#jax-type-promotion-jax-numpy" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> follows type promotion rules laid out at https://jax.readthedocs.io/en/latest/type_promotion.html. Here we use <code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, <code class="docutils literal notranslate"><span class="pre">c*</span></code> to indicate both Python scalars and weakly-typed arrays.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">dtypes</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">'jax_enable_x64'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">jnp_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'b'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bool_</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'bf16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex128</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>


<span class="n">jnp_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">make_jnp_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">'-'</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">'aval'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">aval</span><span class="o">.</span><span class="n">weak_type</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">+</span> <span class="s1">'*'</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
<thead>
<tr style="text-align: right;">
<th></th>
<th>b</th>
<th>u8</th>
<th>u16</th>
<th>u32</th>
<th>u64</th>
<th>i8</th>
<th>i16</th>
<th>i32</th>
<th>i64</th>
<th>bf16</th>
<th>f16</th>
<th>f32</th>
<th>f64</th>
<th>c64</th>
<th>c128</th>
<th>i*</th>
<th>f*</th>
<th>c*</th>
</tr>
</thead>
<tbody>
<tr>
<th>b</th>
<td>b</td>
<td>u8</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i*</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>u8</th>
<td>u8</td>
<td>u8</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u8</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>u16</th>
<td>u16</td>
<td>u16</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u16</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>u32</th>
<td>u32</td>
<td>u32</td>
<td>u32</td>
<td>u32</td>
<td>u64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u32</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>u64</th>
<td>u64</td>
<td>u64</td>
<td>u64</td>
<td>u64</td>
<td>u64</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>u64</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>i8</th>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>f*</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i8</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>i16</th>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>f*</td>
<td>i16</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i16</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>i32</th>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>f*</td>
<td>i32</td>
<td>i32</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i32</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>i64</th>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>f*</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i64</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>bf16</th>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>bf16</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>bf16</td>
<td>bf16</td>
<td>c64</td>
</tr>
<tr>
<th>f16</th>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f16</td>
<td>f32</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f16</td>
<td>f16</td>
<td>c64</td>
</tr>
<tr>
<th>f32</th>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f32</td>
<td>f32</td>
<td>c64</td>
</tr>
<tr>
<th>f64</th>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
<td>c128</td>
<td>f64</td>
<td>f64</td>
<td>c128</td>
</tr>
<tr>
<th>c64</th>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
</tr>
<tr>
<th>c128</th>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
<td>c128</td>
</tr>
<tr>
<th>i*</th>
<td>i*</td>
<td>u8</td>
<td>u16</td>
<td>u32</td>
<td>u64</td>
<td>i8</td>
<td>i16</td>
<td>i32</td>
<td>i64</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>i*</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>f*</th>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>f*</td>
<td>bf16</td>
<td>f16</td>
<td>f32</td>
<td>f64</td>
<td>c64</td>
<td>c128</td>
<td>f*</td>
<td>f*</td>
<td>c*</td>
</tr>
<tr>
<th>c*</th>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
<td>c64</td>
<td>c64</td>
<td>c64</td>
<td>c128</td>
<td>c64</td>
<td>c128</td>
<td>c*</td>
<td>c*</td>
<td>c*</td>
</tr>
</tbody>
</table></div></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/JAX Type Promotion: jax.lax"></a><section id="jax-type-promotion-jax-lax">
<h3>JAX Type Promotion: <code class="docutils literal notranslate"><span class="pre">jax.lax</span></code><a class="headerlink" href="#jax-type-promotion-jax-lax" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">jax.lax</span></code> is lower-level, and does not do any implicit promotion. Here we use <code class="docutils literal notranslate"><span class="pre">i*</span></code>, <code class="docutils literal notranslate"><span class="pre">f*</span></code>, <code class="docutils literal notranslate"><span class="pre">c*</span></code> to indicate both Python scalars and weakly-typed arrays.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">dtypes</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">'jax_enable_x64'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">jnp_dtypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'b'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bool_</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'u8'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'u16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'u32'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'u64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">uint64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'i8'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int8</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'i16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'i32'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'i64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'bf16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'f16'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'f32'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'f64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'c64'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex64</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">'c128'</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">complex128</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
  <span class="s1">'i*'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'f*'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">'c*'</span><span class="p">:</span> <span class="nb">complex</span><span class="p">}</span>


<span class="n">jnp_dtype_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">make_jnp_zero</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
    <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype1</span><span class="p">),</span> <span class="n">make_jnp_zero</span><span class="p">(</span><span class="n">dtype2</span><span class="p">))</span>
  <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">'-'</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">'aval'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">aval</span><span class="o">.</span><span class="n">weak_type</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">+</span> <span class="s1">'*'</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">}:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">jnp_dtype_to_code</span><span class="p">[</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="n">jnp_result_code</span><span class="p">(</span><span class="n">dtype1</span><span class="p">,</span> <span class="n">dtype2</span><span class="p">)</span>
         <span class="k">for</span> <span class="n">dtype2</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">dtype1</span> <span class="ow">in</span> <span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">jnp_dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">display</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe" style="font-size: 80%;">
<thead>
<tr style="text-align: right;">
<th></th>
<th>b</th>
<th>u8</th>
<th>u16</th>
<th>u32</th>
<th>u64</th>
<th>i8</th>
<th>i16</th>
<th>i32</th>
<th>i64</th>
<th>bf16</th>
<th>f16</th>
<th>f32</th>
<th>f64</th>
<th>c64</th>
<th>c128</th>
<th>i*</th>
<th>f*</th>
<th>c*</th>
</tr>
</thead>
<tbody>
<tr>
<th>b</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u8</th>
<td>-</td>
<td>u8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u16</th>
<td>-</td>
<td>-</td>
<td>u16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>u64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>u64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i8</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i8</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>i64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i64</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>bf16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>bf16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>f16</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f16</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>f32</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f32</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>f64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f64</td>
<td>-</td>
</tr>
<tr>
<th>c64</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>c128</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c128</td>
<td>-</td>
<td>-</td>
<td>c128</td>
</tr>
<tr>
<th>i*</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>i*</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<th>f*</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f64</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>f*</td>
<td>-</td>
</tr>
<tr>
<th>c*</th>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>c128</td>
<td>-</td>
<td>-</td>
<td>c*</td>
</tr>
</tbody>
</table></div></div>
</div>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="4410-omnistaging.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Omnistaging</p>
</div>
</a>
<a class="right-next" href="9419-jax-versioning.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Jax and Jaxlib versioning</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>