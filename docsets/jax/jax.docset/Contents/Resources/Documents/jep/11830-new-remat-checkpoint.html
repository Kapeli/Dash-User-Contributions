
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>jax.remat / jax.checkpoint changes: what you need to know â€” JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="12049-type-annotations.html" rel="next" title="Type Annotation Roadmap for JAX"/>
<link href="10657-sequencing-effects.html" rel="prev" title="Sequencing side-effects in JAX"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   ðŸ”ª JAX - The Sharp Bits ðŸ”ª
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jep/11830-new-remat-checkpoint.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#contents">
   Contents
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#whats-going-on">
   Whatâ€™s going on?
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-can-i-disable-the-change-and-go-back-to-the-old-behavior-for-now">
   How can I disable the change, and go back to the old behavior for now?
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#why-are-we-doing-this">
   Why are we doing this?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#user-customizable-rematerialization-policies">
     User-customizable rematerialization policies
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#ability-to-rematerialize-constants-not-just-operations-with-data-dependence-on-arguments">
     Ability to rematerialize constants, not just operations with data dependence on arguments
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#significantly-less-python-overhead-in-some-cases">
     Significantly less Python overhead in some cases
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#enabling-new-jax-features-by-simplifying-internals">
     Enabling new JAX features by simplifying internals
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-are-the-possible-issues-after-the-upgrade">
   What are the possible issues after the upgrade?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#innocuous-numerical-changes">
     Innocuous numerical changes
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-concrete-true-option-is-removed">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       concrete=True
      </span>
</code>
     option is removed.
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>jax.remat / jax.checkpoint changes: what you need to know</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#contents">
   Contents
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#whats-going-on">
   Whatâ€™s going on?
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-can-i-disable-the-change-and-go-back-to-the-old-behavior-for-now">
   How can I disable the change, and go back to the old behavior for now?
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#why-are-we-doing-this">
   Why are we doing this?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#user-customizable-rematerialization-policies">
     User-customizable rematerialization policies
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#ability-to-rematerialize-constants-not-just-operations-with-data-dependence-on-arguments">
     Ability to rematerialize constants, not just operations with data dependence on arguments
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#significantly-less-python-overhead-in-some-cases">
     Significantly less Python overhead in some cases
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#enabling-new-jax-features-by-simplifying-internals">
     Enabling new JAX features by simplifying internals
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#what-are-the-possible-issues-after-the-upgrade">
   What are the possible issues after the upgrade?
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#innocuous-numerical-changes">
     Innocuous numerical changes
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-concrete-true-option-is-removed">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       concrete=True
      </span>
</code>
     option is removed.
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/jax.remat / jax.checkpoint changes: what you need to know"></a><section class="tex2jax_ignore mathjax_ignore" id="jax-remat-jax-checkpoint-changes-what-you-need-to-know">
<h1><code class="docutils literal notranslate"><span class="pre">jax.remat</span></code> / <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> changes: what you need to know<a class="headerlink" href="#jax-remat-jax-checkpoint-changes-what-you-need-to-know" title="Permalink to this headline">#</a></h1>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Contents"></a><section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#whats-going-on"><span class="std std-doc">Whatâ€™s going on?</span></a></p></li>
<li><p><a class="reference internal" href="#how-can-i-disable-the-change-and-go-back-to-the-old-behavior-for-now"><span class="std std-doc">How can I disable the change, and go back to the old behavior for
now?</span></a></p></li>
<li><p><a class="reference internal" href="#why-are-we-doing-this"><span class="std std-doc">Why are we doing this?</span></a></p></li>
<li><p><a class="reference internal" href="#what-are-the-possible-issues-after-the-upgrade"><span class="std std-doc">What are the possible issues after the upgrade?</span></a></p></li>
</ul>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Whatâ€™s going on?"></a><section id="whats-going-on">
<h2>Whatâ€™s going on?<a class="headerlink" href="#whats-going-on" title="Permalink to this headline">#</a></h2>
<p>As of <a class="reference external" href="https://github.com/google/jax/pull/11830">#11830</a> weâ€™re switching on a new implementation of <a class="reference internal" href="../_autosummary/jax.checkpoint.html#jax.checkpoint" title="jax.checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">jax.checkpoint()</span></code></a>, aka <code class="xref py py-func docutils literal notranslate"><span class="pre">jax.remat()</span></code> (the two names are aliases of one another). <strong>For most code, there will be no changes.</strong> But there may be some observable differences in edge cases; see <a class="reference internal" href="#what-are-the-possible-issues-after-the-upgrade"><span class="std std-doc">What are the possible issues after the upgrade?</span></a></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/How can I disable the change, and go back to the old behavior for now?"></a><section id="how-can-i-disable-the-change-and-go-back-to-the-old-behavior-for-now">
<h2>How can I disable the change, and go back to the old behavior for now?<a class="headerlink" href="#how-can-i-disable-the-change-and-go-back-to-the-old-behavior-for-now" title="Permalink to this headline">#</a></h2>
<p>In case you have a problem with this change, <strong>through version <code class="docutils literal notranslate"><span class="pre">jax==0.3.16</span></code></strong> it is possible to switch off the new implementation by setting the <code class="docutils literal notranslate"><span class="pre">jax_new_checkpoint</span></code> config option to be False, in any one of these ways:</p>
<ol class="arabic simple">
<li><p>set the shell environment variable <code class="docutils literal notranslate"><span class="pre">JAX_NEW_CHECKPOINT=0</span></code>;</p></li>
<li><p>execute <code class="docutils literal notranslate"><span class="pre">jax.config.update('jax_new_checkpoint',</span> <span class="pre">False)</span></code>;</p></li>
<li><p>if you parse flags with <code class="docutils literal notranslate"><span class="pre">absl</span></code>, pass the <code class="docutils literal notranslate"><span class="pre">--jax_new_checkpoint=False</span></code> option.</p></li>
</ol>
<p>If you need to revert to the old implementation, <strong>please reach out</strong> on a GitHub issue so that we can make the new implementation work for you.</p>
<p>As of <code class="docutils literal notranslate"><span class="pre">jax==0.3.17</span></code> the <code class="docutils literal notranslate"><span class="pre">jax_new_checkpoint</span></code> config option is no longer
available. If you have an issue, please reach out on <a class="reference external" href="https://github.com/google/jax/issues">the issue
tracker</a> so we can help fix it!</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Why are we doing this?"></a><section id="why-are-we-doing-this">
<h2>Why are we doing this?<a class="headerlink" href="#why-are-we-doing-this" title="Permalink to this headline">#</a></h2>
<p>At the time of writing, JAX has two parallel implementations of <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code>. The new one has been used for months (e.g. by Pax and Flaxformer/T5X) on an opt-in basis. But it hasnâ€™t been on-by-default.</p>
<p>We want to switch the new implementation to be on-by-default, and then delete the old implementation. Using the new implementation, and removing the old implementation, gives users several benefits.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/User-customizable rematerialization policies"></a><section id="user-customizable-rematerialization-policies">
<h3>User-customizable rematerialization policies<a class="headerlink" href="#user-customizable-rematerialization-policies" title="Permalink to this headline">#</a></h3>
<p>The main upside of the new implementation is a new feature corresponding to the <code class="docutils literal notranslate"><span class="pre">policy</span></code> argument. The idea is to give precise user control over what intermediates get saved (versus rematerialized) during the forward pass of automatic differentiation. By exercising this control over the memory-usage vs recomputation tradeoff, users can get significant performance wins, especially in large models and in our LLM MLPerf submission!</p>
<p>The full documentation for this feature is still forthcoming, but hereâ€™s a quick example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">jax</span>

<span class="k">def</span> <span class="nf">apply_layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

<span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint_policies</span><span class="o">.</span><span class="n">checkpoint_dots</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">W</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">apply_layer</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>By applying <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> with <code class="docutils literal notranslate"><span class="pre">policy=jax.checkpoint_policies.checkpoint_dots</span></code> here, we ensure that only the results of matrix multiplies are allowed to be saved during the forward pass. The Jacobian coefficient values from <code class="docutils literal notranslate"><span class="pre">cos</span></code> applications, and the values of <code class="docutils literal notranslate"><span class="pre">sin</span></code> applications needed to compute them, are not saved from the forward pass and are instead recomputed during the backward pass. (Policies like this one can be effective on TPUs, where elementwise computations are effectively free but results from the matrix unit are worth saving.)</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Ability to rematerialize constants, not just operations with data dependence on arguments"></a><section id="ability-to-rematerialize-constants-not-just-operations-with-data-dependence-on-arguments">
<h3>Ability to rematerialize constants, not just operations with data dependence on arguments<a class="headerlink" href="#ability-to-rematerialize-constants-not-just-operations-with-data-dependence-on-arguments" title="Permalink to this headline">#</a></h3>
<p>The old <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> implementation couldnâ€™t actually rematerialize computations without a data dependence on arguments to the decorated function. Consider this toy example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@jax</span><span class="o">.</span><span class="n">checkpoint</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">some_function</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">))</span>  <span class="c1"># `a` does not depend on `x`</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span>
</pre></div>
</div>
<p>The old <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> implementation was forced to save the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>, which could require a lot of memory. The new <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> implementation can rematerialize rather than save the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Significantly less Python overhead in some cases"></a><section id="significantly-less-python-overhead-in-some-cases">
<h3>Significantly less Python overhead in some cases<a class="headerlink" href="#significantly-less-python-overhead-in-some-cases" title="Permalink to this headline">#</a></h3>
<p>The new <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> incurs significantly less Python overhead in some cases. <a class="reference external" href="https://github.com/google/jax/blob/88636d2b649bfa31fa58a30ea15c925f35637397/benchmarks/api_benchmark.py#L511-L539">Simple overhead benchmarks</a> got 10x faster. These overheads only arise in eager op-by-op execution, so in the common case of using a <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> under a <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code> or similar the speedups arenâ€™t relevant. But still, nice!</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Enabling new JAX features by simplifying internals"></a><section id="enabling-new-jax-features-by-simplifying-internals">
<h3>Enabling new JAX features by simplifying internals<a class="headerlink" href="#enabling-new-jax-features-by-simplifying-internals" title="Permalink to this headline">#</a></h3>
<p>This change unlocks big future user benefits too, like custom batching rules (the <code class="docutils literal notranslate"><span class="pre">vmap</span></code> analogue of <code class="docutils literal notranslate"><span class="pre">custom_vjp</span></code>) and a forward-differentiable upgrade to <code class="docutils literal notranslate"><span class="pre">custom_vjp</span></code>. It also significantly reduces complexity in parts of the JAX codebase, which will be good for maintainability and bug-fixing in general.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/What are the possible issues after the upgrade?"></a><section id="what-are-the-possible-issues-after-the-upgrade">
<h2>What are the possible issues after the upgrade?<a class="headerlink" href="#what-are-the-possible-issues-after-the-upgrade" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Innocuous numerical changes"></a><section id="innocuous-numerical-changes">
<h3>Innocuous numerical changes<a class="headerlink" href="#innocuous-numerical-changes" title="Permalink to this headline">#</a></h3>
<p>Because the new implementation can rematerialize more computations, including those of potentially large constants, some code may see small numerical changes. The magnitude of any numerical changes should be within the range we expect from changing compiler optimizations, like reordering of floating point operations. But some overly tight test tolerances may need to be slightly relaxed.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/The concrete=True option is removed."></a><section id="the-concrete-true-option-is-removed">
<h3>The <code class="docutils literal notranslate"><span class="pre">concrete=True</span></code> option is removed.<a class="headerlink" href="#the-concrete-true-option-is-removed" title="Permalink to this headline">#</a></h3>
<p>The old <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> implementation had a boolean <code class="docutils literal notranslate"><span class="pre">concrete</span></code> option, which allowed tracing on concrete Python values (rather than delaying all computations and only tracing on abstracted values). That option was seldom used, and in the cases where it was used there were much simpler alternatives. So we removed the option in the new <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code>.</p>
<p>For example, the overwhelmingly common use of <code class="docutils literal notranslate"><span class="pre">concrete=True</span></code> in Google code was to support passing an argument like <code class="docutils literal notranslate"><span class="pre">is_training</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">concrete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># OLD jax.checkpoint API</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is_training</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">is_training</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>With the new <code class="docutils literal notranslate"><span class="pre">jax.checkpoint</span></code> implementation, we can accomplish the same using the <code class="docutils literal notranslate"><span class="pre">static\_argnums</span></code> option:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>  <span class="c1"># NEW jax.checkpoint API</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">is_training</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">is_training</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">jax.numpy</span></code> operations need to be performed on static arguments, with their numerical results computed during Python tracing rather than delayed, we can use <code class="docutils literal notranslate"><span class="pre">static_argnums</span></code> with <code class="docutils literal notranslate"><span class="pre">jax.ensure_compile_time_eval()</span></code>. But it seems unlikely that youâ€™d need this!</p>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="10657-sequencing-effects.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Sequencing side-effects in JAX</p>
</div>
</a>
<a class="right-next" href="12049-type-annotations.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Type Annotation Roadmap for JAX</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      Â© Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>