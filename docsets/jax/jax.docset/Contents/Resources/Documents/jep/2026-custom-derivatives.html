
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Custom JVP/VJP rules for JAX-transformable functions — JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="4008-custom-vjp-update.html" rel="next" title="custom_vjp and nondiff_argnums update guide"/>
<link href="263-prng.html" rel="prev" title="JAX PRNG Design"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   🔪 JAX - The Sharp Bits 🔪
  </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax-101/index.html">
   Tutorial: JAX 101
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax-101/08-pjit.html">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jep/2026-custom-derivatives.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#contents">
   Contents
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#goals">
   Goals
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#non-goals">
   Non-goals
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#main-problem-descriptions">
   Main problem descriptions
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-vmap-removes-custom-jvp-semantics-problem">
     The vmap-removes-custom-jvp semantics problem
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-python-flexibility-problem">
     The Python flexibility problem
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#solution-idea">
   Solution idea
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#api">
   API
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#implementation-notes">
   Implementation notes
  </a>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Custom JVP/VJP rules for JAX-transformable functions</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#contents">
   Contents
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#goals">
   Goals
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#non-goals">
   Non-goals
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#main-problem-descriptions">
   Main problem descriptions
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-vmap-removes-custom-jvp-semantics-problem">
     The vmap-removes-custom-jvp semantics problem
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-python-flexibility-problem">
     The Python flexibility problem
    </a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#solution-idea">
   Solution idea
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#api">
   API
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#implementation-notes">
   Implementation notes
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Custom JVP/VJP rules for JAX-transformable functions"></a><section class="tex2jax_ignore mathjax_ignore" id="custom-jvp-vjp-rules-for-jax-transformable-functions">
<h1>Custom JVP/VJP rules for JAX-transformable functions<a class="headerlink" href="#custom-jvp-vjp-rules-for-jax-transformable-functions" title="Permalink to this headline">#</a></h1>
<p>This is a design document, explaining some of the thinking behind the design and
implementation of <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code>. For user-oriented
documentation, see <a class="reference external" href="https://jax.readthedocs.io/en/latest/notebooks/Custom_derivative_rules_for_Python_code.html">the tutorial notebook</a>.</p>
<p>There are two ways to define differentiation rules in JAX:</p>
<ol class="arabic simple">
<li><p>using <code class="docutils literal notranslate"><span class="pre">jax.custom_jvp</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.custom_vjp</span></code> to define custom differentiation
rules for Python functions that are already JAX-transformable; and</p></li>
<li><p>defining new <code class="docutils literal notranslate"><span class="pre">core.Primitive</span></code> instances along with all their transformation
rules, for example to call into functions from other systems like solvers,
simulators, or general numerical computing systems.</p></li>
</ol>
<p>This document is about #1 only.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Contents"></a><section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#goals"><span class="std std-doc">Goals</span></a></p></li>
<li><p><a class="reference internal" href="#non-goals"><span class="std std-doc">Non-goals</span></a></p></li>
<li><p><a class="reference internal" href="#main-problem-descriptions"><span class="std std-doc">Main problem descriptions</span></a></p>
<ul>
<li><p><a class="reference internal" href="#the-vmap-removes-custom-jvp-semantics-problem"><span class="std std-doc">The vmap-removes-custom-jvp semantics problem</span></a></p></li>
<li><p><a class="reference internal" href="#the-python-flexibility-problem"><span class="std std-doc">The Python flexibility problem</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#solution-idea"><span class="std std-doc">Solution idea</span></a></p></li>
<li><p><a class="reference internal" href="#implementation-notes"><span class="std std-doc">Implementation notes</span></a></p></li>
</ul>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Goals"></a><section id="goals">
<h2>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">#</a></h2>
<p>We want <strong>users</strong> to customize the forward- and/or reverse-mode differentiation
behavior of their code. This customization</p>
<ol class="arabic simple">
<li><p>should have a <em>clear and consistent semantics</em> in how it works and how it
composes with other JAX transformations; and</p></li>
<li><p>should be <em>flexible</em> in supporting use cases and workflows like in
<a class="reference external" href="https://github.com/hips/autograd">Autograd</a> and
<a class="reference external" href="https://pytorch.org">PyTorch</a>, including cases involving differentiation of
Python control flow and workflows for NaN debugging.</p></li>
</ol>
<p>As <strong>JAX developers</strong> we want to write library functions, like
<a class="reference external" href="https://github.com/google/jax/blob/01039299304b148b405ef9b9fa5e82bbb527471d/jax/scipy/special.py#L83"><code class="docutils literal notranslate"><span class="pre">logit</span></code></a>
and
<a class="reference external" href="https://github.com/google/jax/blob/01039299304b148b405ef9b9fa5e82bbb527471d/jax/scipy/special.py#L91"><code class="docutils literal notranslate"><span class="pre">expit</span></code></a>,
that are defined in terms of other primitives, but for the purposes of
differentiation have primitive-like behavior in the sense that we want to define
custom differentiation rules for them, which may be more numerically stable or
performant. In particular, we don’t want to have to specify <code class="docutils literal notranslate"><span class="pre">vmap</span></code> or <code class="docutils literal notranslate"><span class="pre">jit</span></code>
rules for functions like <code class="docutils literal notranslate"><span class="pre">logit</span></code> and <code class="docutils literal notranslate"><span class="pre">expit</span></code>.</p>
<p>As a stretch goal, we’d like to make JAX a great environment for power users
looking to add custom differentiation rules for higher-order functions like
<code class="docutils literal notranslate"><span class="pre">fixed_point</span></code>, <code class="docutils literal notranslate"><span class="pre">odeint</span></code>, etc.; this design doc won’t solve that problem, but we
want to be confident we’re not going to preclude good solutions to that problem.</p>
<p>That is, our primary goals are</p>
<ol class="arabic simple">
<li><p>solve the vmap-removes-custom-jvp semantics problem (<a class="reference external" href="https://github.com/google/jax/issues/1249">#1249</a>), and</p></li>
<li><p>allow Python in custom VJPs, e.g. to debug NaNs
(<a class="reference external" href="https://github.com/google/jax/issues/1275">#1275</a>).</p></li>
</ol>
<p>Secondary goals are
3. clean up and simplify user experience (symbolic zeros, kwargs, etc)
4. make progress towards a world where users can easily add <code class="docutils literal notranslate"><span class="pre">fixed_point</span></code>,
<code class="docutils literal notranslate"><span class="pre">odeint</span></code>, <code class="docutils literal notranslate"><span class="pre">root</span></code>, etc.</p>
<p>Overall, we want to close
<a class="reference external" href="https://github.com/google/jax/issues/116">#116</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1097">#1097</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1249">#1249</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1275">#1275</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1366">#1366</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1723">#1723</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1670">#1670</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1875">#1875</a>,
<a class="reference external" href="https://github.com/google/jax/issues/1938">#1938</a>,
and replace the custom_transforms machinery (from
<a class="reference external" href="https://github.com/google/jax/issues/636">#636</a>,
<a class="reference external" href="https://github.com/google/jax/issues/818">#818</a>,
and others).</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Non-goals"></a><section id="non-goals">
<h2>Non-goals<a class="headerlink" href="#non-goals" title="Permalink to this headline">#</a></h2>
<p>Here are objectives we’re <strong>not</strong> aiming to achieve:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">custom_transforms</span></code> machinery aimed to provide a transformation-generic
mechanism for customizing behavior, in principle (though never really used in
practice) allowing users to customize rules for any transformation while
somehow inheriting the “transparent” behavior for others. <strong>We are instead
only going to solve the customization problem for differentiation (JVP and
VJP, separately).</strong> Differentiation is the only case actually requested, and
by specializing to differentiation we can reduce complexity and improve
flexibility. To control all rules one can just write a primitive.</p></li>
<li><p><strong>We’re not going to prioritize mathematical aesthetics</strong> over flexibility
and clarity on the user side, and simplicity on the implementation side. In
particular, while the custom VJP signature <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(b,</span> <span class="pre">CT</span> <span class="pre">b</span> <span class="pre">--o</span> <span class="pre">CT</span> <span class="pre">a)</span></code> is
mathematically pleasing, if it’s hard to implement in a Python mechanism
because of the closure in the return type, we’re fine doing something that
handles residuals more explicitly.</p></li>
<li><p><strong>Serialization support</strong>, of the form where the staged-out serialized
program representation can be loaded and further JAX-transformed as opposed
to just evaluated, is currently out of scope for these custom JVP/VJP
transformation rules. Serialization may be useful not only for researchers
who want to save some representation of their computation (and transform it
after loading it), but also for future considerations like having jaxpr
transformations implemented outside Python, or having jaxprs as an MLIR
dialect. By defining this as a non-goal for the purpose of this design, we
have fewer constraints on where we can stash Python callables.</p></li>
</ol>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Main problem descriptions"></a><section id="main-problem-descriptions">
<h2>Main problem descriptions<a class="headerlink" href="#main-problem-descriptions" title="Permalink to this headline">#</a></h2>
<a class="dashAnchor" name="//apple_ref/cpp/Section/The vmap-removes-custom-jvp semantics problem"></a><section id="the-vmap-removes-custom-jvp-semantics-problem">
<h3>The vmap-removes-custom-jvp semantics problem<a class="headerlink" href="#the-vmap-removes-custom-jvp-semantics-problem" title="Permalink to this headline">#</a></h3>
<p>The vmap-removes-custom-jvp semantics problem is that vmap does not compose
properly with differentiation of functions with <code class="docutils literal notranslate"><span class="pre">custom_transforms</span></code> rules:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># old custom_transforms api to be replaced</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">custom_transforms</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">x</span>

<span class="c1"># f_vjp :: a -&gt; (b, CT b --o CT a)</span>
<span class="k">def</span> <span class="nf">f_vjp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span>  <span class="c1"># 3 instead of 2</span>

<span class="n">jax</span><span class="o">.</span><span class="n">defvjp_all</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_vjp</span><span class="p">)</span>

<span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span>  <span class="c1"># 3.</span>
<span class="n">vmap</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>  <span class="c1"># [3., 3., 3., 3.]</span>
<span class="n">grad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>  <span class="c1"># [2., 2., 2., 2.]</span>
</pre></div>
</div>
<p>The last grad-of-vmap line has an unexpected result! In general, applying
<code class="docutils literal notranslate"><span class="pre">vmap</span></code>, or really any non-differentiation transformation, has the effect of
removing the custom differentiation rule. (Applying <code class="docutils literal notranslate"><span class="pre">jvp</span></code> causes a failure when
a custom VJP rule is defined.)</p>
<p>The problem exists because transformations are like rewrites, and the <code class="docutils literal notranslate"><span class="pre">vmap</span></code>
transformation effectively rewrites the function to no longer call the
newly-introduced primitive for which there is a custom rule (and hence <code class="docutils literal notranslate"><span class="pre">grad</span></code>
then doesn’t produce the custom rule’s result). In more detail, the
<code class="docutils literal notranslate"><span class="pre">custom_transforms</span></code> machinery sets things up so that evaluating <code class="docutils literal notranslate"><span class="pre">f(x)</span></code> applies
the function</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="k">lambda</span>  <span class="p">;</span> <span class="p">;</span> <span class="n">a</span><span class="o">.</span>
  <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">f_primitive</span> <span class="n">a</span>
  <span class="ow">in</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">f_primitive</span></code> is a new primitive (introduced for every <code class="docutils literal notranslate"><span class="pre">custom_transforms</span></code>
function and in fact for every call of the function) to which the custom VJP
rule is associated. When we evaluate <code class="docutils literal notranslate"><span class="pre">grad(f)(x)</span></code>, the differentiation machinery
encounters <code class="docutils literal notranslate"><span class="pre">f_primitive</span></code> and processes it with the custom rule.</p>
<p>However, because <code class="docutils literal notranslate"><span class="pre">f_primitive</span></code> is <em>transparent</em> to <code class="docutils literal notranslate"><span class="pre">vmap</span></code>, in the sense that
<code class="docutils literal notranslate"><span class="pre">vmap</span></code> operates on (effectively by inlining) the definition of <code class="docutils literal notranslate"><span class="pre">f_primitive</span></code>,
the function <code class="docutils literal notranslate"><span class="pre">vmap(f)</span></code> is effectively</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="k">lambda</span>  <span class="p">;</span> <span class="p">;</span> <span class="n">a</span><span class="o">.</span>
  <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mul</span> <span class="mf">2.</span> <span class="n">a</span>
  <span class="ow">in</span> <span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<p>In words, <code class="docutils literal notranslate"><span class="pre">vmap</span></code> rewrites the function in terms of its underlying primitives and
their transformation rules, removing <code class="docutils literal notranslate"><span class="pre">f_primitive</span></code> entirely.</p>
<p>More generally, <strong>because <code class="docutils literal notranslate"><span class="pre">vmap(f)</span></code> has semantics defined in terms of calls to
f, it is semantically inconsistent to remove the custom derivative rule</strong>. That
is, since we define</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">])</span>
</pre></div>
</div>
<p>we must have</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jvp</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">))(</span><span class="n">xs</span><span class="p">)</span> <span class="o">==</span> <span class="n">jvp</span><span class="p">(</span><span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]))</span>
</pre></div>
</div>
<p>yet this property is not observed when <code class="docutils literal notranslate"><span class="pre">f</span></code> has a custom derivative rule defined,
as the custom derivative rule is used in the right-hand version but not the
left-hand one.</p>
<p>This issue isn’t specific to <code class="docutils literal notranslate"><span class="pre">vmap</span></code>; it applies to all transformations for which
the semantics of transforming a function <code class="docutils literal notranslate"><span class="pre">f</span></code> are defined in terms of calls to
the function <code class="docutils literal notranslate"><span class="pre">f</span></code>, rather than rewriting it into another function. The <code class="docutils literal notranslate"><span class="pre">mask</span></code>
transformation also falls into this class. Differentiation transforms and the
hypothetical all-unary-functions-become-cosine transform are not in this class.</p>
<p>(The interaction between additional custom rules, like custom <code class="docutils literal notranslate"><span class="pre">vmap</span></code> rules, is
likely to get even more complex, suggesting the problem framing of
<code class="docutils literal notranslate"><span class="pre">custom_transforms</span></code> is too broad.)</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/The Python flexibility problem"></a><section id="the-python-flexibility-problem">
<h3>The Python flexibility problem<a class="headerlink" href="#the-python-flexibility-problem" title="Permalink to this headline">#</a></h3>
<p>In JAX, as in <a class="reference external" href="https://github.com/hips/autograd">Autograd</a> and
<a class="reference external" href="https://pytorch.org">PyTorch</a> but not TF1, differentiation of a Python function
is performed while the function is being executed and traced. This behavior
delights users for a few reasons.</p>
<p><strong>First and most importantly, it enables pdb-based workflows, e.g. for
inspecting numerics or catching NaNs.</strong> That is, users can employ the standard
Python debugger and other Python-native tools to debug their code, even being
able to inspect runtime values to understand numerical behavior on examples and
to catch fundamentally runtime errors like NaNs. In fact, just while working on
the PR corresponding to this design, especially on the <code class="docutils literal notranslate"><span class="pre">odeint</span></code> primitive, I
used runtime value inspection to debug issues many times, increasing my
confidence that this is a key user workflow in Python. One especially handy
trick, which I’ve used in both JAX and Autograd many times, is the ability to
insert a debugger breakpoint in a custom VJP rule to enter a debugger at a
specific point in the backward pass.</p>
<p><strong>Second, it allows differentiation of Python native control flow.</strong> We’re not
sure how often this is used in practice in finalized software artifacts, but
when users first poke around JAX or Autograd they’re often impressed by this
freedom. There’s a reason we include it at the top of our JAX and Autograd
READMEs, slide decks, and demos. Ceding this capability would be a step backward
from Autograd. We want JAX to have the best automatic differentiation.</p>
<p>However, the <code class="docutils literal notranslate"><span class="pre">custom_transforms</span></code> machinery does not provide this Python-support
flexibility. That is, because it’s implemented in terms of up-front jaxpr
formation from the Python code for both the user function and custom
differentiation rules, code like this leads to an abstract value tracing error:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># old custom_transforms api to be replaced</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">custom_transforms</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">0.</span>

<span class="k">def</span> <span class="nf">f_vjp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="o">...</span>

<span class="n">jax</span><span class="o">.</span><span class="n">defvjp_all</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_vjp</span><span class="p">)</span>

<span class="n">grad</span><span class="p">(</span><span class="n">f</span><span class="p">)(</span><span class="mf">1.</span><span class="p">)</span>  <span class="c1"># Error!</span>
</pre></div>
</div>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Solution idea"></a><section id="solution-idea">
<h2>Solution idea<a class="headerlink" href="#solution-idea" title="Permalink to this headline">#</a></h2>
<p>The main idea is that <strong><a class="reference external" href="https://github.com/dougalm">dougalm@</a> already solved
these problems with <code class="docutils literal notranslate"><span class="pre">core.call</span></code></strong>. That is, we can frame the task of specifying
a custom JVP rule for a user function in terms of a new Python-level call
primitive (not to be added to the jaxpr language; see below). This new call
primitive has a user Python function associated with it just like <code class="docutils literal notranslate"><span class="pre">core.call</span></code>,
but additionally has a second Python callable representing the JVP rule. Let’s
refer to this new call primitive as <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code>.</p>
<p>Transformations like <code class="docutils literal notranslate"><span class="pre">vmap</span></code> interact with <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code> as with <code class="docutils literal notranslate"><span class="pre">core.call</span></code>:
they effectively pass right through it and are applied to the underlying Python
callables. Schematically, writing in terms of curried versions of the primitives
for convenience, analogously to how <code class="docutils literal notranslate"><span class="pre">vmap</span></code> interacts with <code class="docutils literal notranslate"><span class="pre">core.call</span></code> by
applying to the function to be called:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">call</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
<p>for the new primitive <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code> we simply apply <code class="docutils literal notranslate"><span class="pre">vmap</span></code> to the two
functions it entails:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">vmap</span><span class="p">(</span><span class="n">custom_jvp_call</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_jvp</span><span class="p">))</span> <span class="o">==</span> <span class="n">custom_jvp_call</span><span class="p">(</span><span class="n">vmap</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">vmap</span><span class="p">(</span><span class="n">f_jvp</span><span class="p">))</span>
</pre></div>
</div>
<p>This behavior means we’ve solved the <a class="reference internal" href="#the-vmap-removes-custom-jvp-semantics-problem"><span class="std std-doc">vmap-removes-custom-jvp semantics
problem</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">jvp</span></code> transformation interacts as one might expect: it just calls <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code>,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jvp</span><span class="p">(</span><span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">call</span><span class="p">(</span><span class="n">jvp</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="n">jvp</span><span class="p">(</span><span class="n">custom_jvp_call</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_jvp</span><span class="p">))</span> <span class="o">==</span> <span class="n">f_jvp</span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code> acts like <code class="docutils literal notranslate"><span class="pre">core.call</span></code> (and not like <code class="docutils literal notranslate"><span class="pre">xla.xla_call</span></code>) in
that it doesn’t raise the abstraction level of its inputs (because it’s not
delaying anything or staging anything out), it means we’ve solved <a class="reference internal" href="#the-python-flexibility-problem"><span class="std std-doc">the Python
flexibility problem</span></a>: there are no constraints
on the user Python function (above the usual functional programming constraints
required by <code class="docutils literal notranslate"><span class="pre">jvp</span></code> or <code class="docutils literal notranslate"><span class="pre">vjp</span></code>).</p>
<p>What about evaluation and compilation? These are two ways to “exit” the JAX
system, in the sense that no additional transformations can be applied after
these steps. As a result, their rules are trivial:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">eval</span><span class="p">(</span><span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="nb">eval</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">jit</span><span class="p">(</span><span class="n">call</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">==</span> <span class="n">hlo_call</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="nb">eval</span><span class="p">(</span><span class="n">custom_jvp_call</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_jvp</span><span class="p">))</span> <span class="o">==</span> <span class="nb">eval</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">jit</span><span class="p">(</span><span class="n">custom_jvp_call</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f_jvp</span><span class="p">))</span> <span class="o">==</span> <span class="n">hlo_call</span><span class="p">(</span><span class="n">jit</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
<p>In words, if a JVP rule hasn’t already rewritten <code class="docutils literal notranslate"><span class="pre">custom_jvp_call(f,</span> <span class="pre">f_jvp)</span></code>
into <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code>, when we get to the point of evaluation with <code class="docutils literal notranslate"><span class="pre">eval</span></code> or staging out
to XLA with <code class="docutils literal notranslate"><span class="pre">jit</span></code>, differentiation is never going to be applied, so we just
ignore <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code> and behave just like <code class="docutils literal notranslate"><span class="pre">core.call</span></code>. However, due to the wrinkle
discussed next, the partial eval rule for <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code> must be a bit more
complex, since partial evaluation isn’t just used to stage out to XLA with
<code class="docutils literal notranslate"><span class="pre">jit</span></code>.</p>
<p>The only remaining wrinkle has to do with “initial-style” jaxpr-forming
primitives, like <code class="docutils literal notranslate"><span class="pre">lax.scan</span></code>, and their transformation rules. These represent a
different kind of “staging out to a jaxpr” than that for compilation because we
can perform additional transformations on the staged-out jaxpr. That is, when
<code class="docutils literal notranslate"><span class="pre">lax.scan</span></code> forms a jaxpr, it does not exit the transformation system, since when
we apply a jvp or vmap to a <code class="docutils literal notranslate"><span class="pre">lax.scan</span></code> we need to apply it to the function
represented by the jaxpr.</p>
<p>Another way to state the wrinkle is that initial-style primitives like <code class="docutils literal notranslate"><span class="pre">lax.scan</span></code>
rely on the ability to round-trip to a jaxpr and back to a Python callable while
preserving semantics. That must mean preserving custom differentiation rule
semantics too.</p>
<p>The solution is to use a bit of dynamic scoping: when we’re staging out to a
jaxpr for an initial-style primitive, like those in lax_control_flow.py, we set
a bit on the global trace state. When that bit is set, instead of using the
final-style <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code> primitive, we use an initial-style
<code class="docutils literal notranslate"><span class="pre">custom_jvp_call_jaxpr</span></code> primitive, and trace the functions <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code> to
jaxprs up-front to make initial-style processing easier. The
<code class="docutils literal notranslate"><span class="pre">custom_jvp_call_jaxpr</span></code> primitive is otherwise similar to the final-style
version.</p>
<p>(Footnote: while morally we form jaxprs for both <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code> before binding
<code class="docutils literal notranslate"><span class="pre">custom_jvp_call_jaxpr</span></code>, we need to delay the formation of the jaxpr of <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code>
because it may call the custom-JVP function and thus eager processing would lead
to an infinite recursion. We delay that jaxpr formation in a thunk.)</p>
<p>If we gave up on <a class="reference internal" href="#the-python-flexibility-problem"><span class="std std-doc">the Python flexibility
problem</span></a>, we could get away with only having
<code class="docutils literal notranslate"><span class="pre">custom_jvp_call_jaxpr</span></code> and not having the separate Python-level primitive
<code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/API"></a><section id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">#</a></h2>
<p>The custom JVP for an <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">b</span></code> function is specified with an <code class="docutils literal notranslate"><span class="pre">(a,</span> <span class="pre">Ta)</span> <span class="pre">-&gt;</span> <span class="pre">(b,</span> <span class="pre">T</span> <span class="pre">b)</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># f :: a -&gt; b</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">custom_jvp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># f_jvp :: (a, T a) -&gt; (b, T b)</span>
<span class="k">def</span> <span class="nf">f_jvp</span><span class="p">(</span><span class="n">primals</span><span class="p">,</span> <span class="n">tangents</span><span class="p">):</span>
  <span class="n">x</span><span class="p">,</span> <span class="o">=</span> <span class="n">primals</span>
  <span class="n">t</span><span class="p">,</span> <span class="o">=</span> <span class="n">tangents</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span>

<span class="n">f</span><span class="o">.</span><span class="n">defjvp</span><span class="p">(</span><span class="n">f_jvp</span><span class="p">)</span>
</pre></div>
</div>
<p>(Interesting autodiff aside: for the rule to apply to higher-order
differentiation, one must call <code class="docutils literal notranslate"><span class="pre">f</span></code> in the body of <code class="docutils literal notranslate"><span class="pre">f_jvp</span></code>; that precludes some
kinds of work sharing between the internals of <code class="docutils literal notranslate"><span class="pre">f</span></code> and the tangent calculation.)</p>
<p>The custom VJP for an <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">b</span></code> function is specified with an <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(b,</span> <span class="pre">c)</span></code> forward
pass function paired with a <code class="docutils literal notranslate"><span class="pre">(c,</span> <span class="pre">CT</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">CT</span></code> a backward pass function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># f :: a -&gt; b</span>
<span class="nd">@jax</span><span class="o">.</span><span class="n">custom_vjp</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># f_fwd :: a -&gt; (b, c)</span>
<span class="k">def</span> <span class="nf">f_fwd</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># f_bwd :: (c, CT b) -&gt; CT a</span>
<span class="k">def</span> <span class="nf">f_bwd</span><span class="p">(</span><span class="n">cos_x</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">cos_x</span> <span class="o">*</span> <span class="n">g</span><span class="p">,)</span>

<span class="n">f</span><span class="o">.</span><span class="n">defvjp</span><span class="p">(</span><span class="n">f_fwd</span><span class="p">,</span> <span class="n">f_bwd</span><span class="p">)</span>
</pre></div>
</div>
<p>The signature <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(b,</span> <span class="pre">CT</span> <span class="pre">b</span> <span class="pre">--o</span> <span class="pre">CT</span> <span class="pre">a)</span></code> is more aesthetically pleasing, but
supporting it would make the implementation more complex and might require
compromising expressibility desiderata. The basic reason that Python callables
are opaque (unless we trace them to a jaxpr eagerly, which places expressiveness
constraints), and in this case we may be returning a callable with <code class="docutils literal notranslate"><span class="pre">vmap</span></code> tracers
inside its closure that we need to know about during the forward pass.</p>
<p>We could add convenience wrappers, for example to define the JVP rule for a
single argument at a time (like we do internally for primitives). But because
this proposal is complicated enough as it is, I decided against convenience
layers; let’s keep things minimal for now.</p>
<p>There are some other bells and whistles to the API:</p>
<ul class="simple">
<li><p>Inputs and output types <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> can be arbitrary pytrees of
jaxtypes.</p></li>
<li><p>Passing arguments by name (keyword arguments) is supported when they can be
resolved to positions using the <code class="docutils literal notranslate"><span class="pre">inspect</span></code> module. This is a bit of an experiment
with Python 3’s improved ability to programmatically inspect argument
signatures. I believe it is sound but not complete, which is a fine place to be.
(See also <a class="reference external" href="https://github.com/google/jax/issues/2069">#2069</a>.)</p></li>
<li><p>Arguments can be marked non-differentiable using <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code>, and as with
<code class="docutils literal notranslate"><span class="pre">jit</span></code>’s <code class="docutils literal notranslate"><span class="pre">static_argnums</span></code> these arguments don’t have to be JAX types. We need to
set a convention for how these arguments are passed to the rules. For a primal
function with type signature <code class="docutils literal notranslate"><span class="pre">(d,</span> <span class="pre">a)</span> <span class="pre">-&gt;</span> <span class="pre">b</span></code> where <code class="docutils literal notranslate"><span class="pre">d</span></code> represents the
non-differentiable type, the JVP rule’s signature is <code class="docutils literal notranslate"><span class="pre">(a,</span> <span class="pre">T</span> <span class="pre">a,</span> <span class="pre">d)</span> <span class="pre">-&gt;</span> <span class="pre">T</span> <span class="pre">b</span></code> and
the VJP rule’s reverse component signature is <code class="docutils literal notranslate"><span class="pre">(d,</span> <span class="pre">c,</span> <span class="pre">CT</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">CT</span> <span class="pre">a</span></code>. That is,
the non-differentiable arguments are passed in order after <code class="docutils literal notranslate"><span class="pre">primals</span></code> and
<code class="docutils literal notranslate"><span class="pre">tangents</span></code> for a custom JVP rule, and passed in order preceding the residuals in
a custom VJP rule’s reverse function.</p></li>
</ul>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Implementation notes"></a><section id="implementation-notes">
<h2>Implementation notes<a class="headerlink" href="#implementation-notes" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Updated <code class="docutils literal notranslate"><span class="pre">jax.experimental.odeint</span></code></p>
<ul>
<li><p>Since <code class="docutils literal notranslate"><span class="pre">odeint</span></code> is a pretty complex user of a custom VJP rule, in addition to
just updating it to work at all, I wanted to revise it to be a canonical
user of the new custom VJP API as a way to test that the API was a good one.</p></li>
<li><p>Along the way I made other improvements to the <code class="docutils literal notranslate"><span class="pre">odeint</span></code> implementation:</p>
<ul>
<li><p>remove raveling/unraveling boilerplate</p></li>
<li><p>make use of <code class="docutils literal notranslate"><span class="pre">lax.scan</span></code> to remove the index-update logic</p></li>
<li><p>speed up by 20+% on the simple pendulum benchmark</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Added a custom bind method on each transform for the custom derivative call
primitives, <code class="docutils literal notranslate"><span class="pre">custom_jvp_call</span></code> and <code class="docutils literal notranslate"><span class="pre">custom_vjp_call</span></code>. It’s like
<code class="docutils literal notranslate"><span class="pre">core.call_bind</span></code>, except we don’t process env traces: those are just errors.</p></li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">custom_lin</span></code> primitive, which gets staged out into linear jaxprs to be
transposed when using a custom VJP rule.</p>
<ul>
<li><p>Because our reverse-mode autodiff is decomposed into linearization, partial
evaluation, and transposition, our custom VJP rules are processed in two
separate steps: one during linearization and one during transposition.</p></li>
<li><p>The linearization step, i.e. the JVP rule for <code class="docutils literal notranslate"><span class="pre">custom_vjp_call</span></code>, applies
<code class="docutils literal notranslate"><span class="pre">custom_lin</span></code> to the tangent values; <code class="docutils literal notranslate"><span class="pre">custom_lin</span></code> carries with it the user’s
custom backward-pass function, and as a primitive it only has a transpose
rule.</p></li>
<li><p>This mechanism is described more in <a class="reference external" href="https://github.com/google/jax/issues/636">#636</a>.</p></li>
</ul>
</li>
<li><p>To prevent</p></li>
</ul>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="263-prng.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">JAX PRNG Design</p>
</div>
</a>
<a class="right-next" href="4008-custom-vjp-update.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title"><code class="docutils literal notranslate"><span class="pre">custom_vjp</span></code> and <code class="docutils literal notranslate"><span class="pre">nondiff_argnums</span></code> update guide</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      © Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>