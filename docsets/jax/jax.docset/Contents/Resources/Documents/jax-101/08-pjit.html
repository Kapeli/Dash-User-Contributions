
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Introduction to pjit ‚Äî JAX  documentation</title>
<!-- Loaded before other Sphinx assets -->
<link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css">
<link href="../_static/plot_directive.css" rel="stylesheet" type="text/css">
<link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../_static/style.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/clipboard.min.js"></script>
<script src="../_static/copybutton.js"></script>
<script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
<link href="../_static/favicon.png" rel="shortcut icon">
<link href="../genindex.html" rel="index" title="Index"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="../debugging/index.html" rel="next" title="Runtime value debugging in JAX"/>
<link href="07-state.html" rel="prev" title="Stateful Computations in JAX"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="None" name="docsearch:language"/>
<!-- Google Analytics -->
</link></link></link></link></link></link></head>
<body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
<div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
<div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>
<div class="container-fluid" id="banner"></div>
<div class="container-xl">
<div class="row">
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
<div class="bd-sidebar__content">
<div class="bd-sidebar__top"><div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
<!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
<img alt="logo" class="logo" src="../_static/jax_logo_250px.png"/>
</a>
</div><form action="../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Getting Started
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../installation.html">
   Installing JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/quickstart.html">
   JAX Quickstart
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/thinking_in_jax.html">
   How to Think in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Common_Gotchas_in_JAX.html">
   üî™ JAX - The Sharp Bits üî™
  </a>
</li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children">
<a class="reference internal" href="index.html">
   Tutorial: JAX 101
  </a>
<input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
<label for="toctree-checkbox-1">
<i class="fas fa-chevron-down">
</i>
</label>
<ul class="current">
<li class="toctree-l2">
<a class="reference internal" href="01-jax-basics.html">
     JAX As Accelerated NumPy
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="02-jitting.html">
     Just In Time Compilation with JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="03-vectorization.html">
     Automatic Vectorization in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="04-advanced-autodiff.html">
     Advanced Automatic Differentiation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="05-random-numbers.html">
     Pseudo Random Numbers in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="05.1-pytrees.html">
     Working with Pytrees
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="06-parallelism.html">
     Parallel Evaluation in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="07-state.html">
     Stateful Computations in JAX
    </a>
</li>
<li class="toctree-l2 current active">
<a class="current reference internal" href="#">
     Introduction to pjit
    </a>
</li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../debugging/index.html">
   Runtime value debugging in JAX
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox">
<label for="toctree-checkbox-2">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/print_breakpoint.html">
<code class="docutils literal notranslate">
<span class="pre">
       jax.debug.print
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       jax.debug.breakpoint
      </span>
</code>
</a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/checkify_guide.html">
     The
     <code class="docutils literal notranslate">
<span class="pre">
       checkify
      </span>
</code>
     transformation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../debugging/flags.html">
     JAX debugging flags
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Reference Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../faq.html">
   JAX Frequently Asked Questions (FAQ)
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../async_dispatch.html">
   Asynchronous dispatch
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../aot.html">
   Ahead-of-time lowering and compilation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jaxpr.html">
   Understanding Jaxprs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/convolutions.html">
   Convolutions in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../pytrees.html">
   Pytrees
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../type_promotion.html">
   Type promotion semantics
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../errors.html">
   JAX Errors
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../transfer_guard.html">
   Transfer guard
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../glossary.html">
   JAX Glossary of Terms
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../changelog.html">
   Change log
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Advanced JAX Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/autodiff_cookbook.html">
   The Autodiff Cookbook
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/vmapped_log_probs.html">
   Autobatching log-densities example
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/neural_network_with_tfds_data.html">
   Training a Simple Neural Network, with tensorflow/datasets Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Custom_derivative_rules_for_Python_code.html">
   Custom derivative rules for JAX-transformable Python functions
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/How_JAX_primitives_work.html">
   How JAX primitives work
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Writing_custom_interpreters_in_Jax.html">
   Writing custom Jaxpr interpreters in JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/Neural_Network_and_Data_Loading.html">
   Training a Simple Neural Network, with PyTorch Data Loading
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../notebooks/xmap_tutorial.html">
   Named axes and easy-to-revise parallelism
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../multi_process.html">
   Using JAX in multi-host and multi-process environments
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Notes
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../api_compatibility.html">
   API compatibility
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../deprecation.html">
   Python and NumPy version support policy
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../concurrency.html">
   Concurrency
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../gpu_memory_allocation.html">
   GPU memory allocation
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../profiling.html">
   Profiling JAX programs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../device_memory_profiling.html">
   Device Memory Profiling
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../rank_promotion_warning.html">
   Rank promotion warning
  </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  Developer documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1">
<a class="reference internal" href="../contributing.html">
   Contributing to JAX
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../developer.html">
   Building from source
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../jax_internal_api.html">
   Internal APIs
  </a>
</li>
<li class="toctree-l1">
<a class="reference internal" href="../autodidax.html">
   Autodidax: JAX core from scratch
  </a>
</li>
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jep/index.html">
   JAX Enhancement Proposals (JEPs)
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox">
<label for="toctree-checkbox-3">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jep/263-prng.html">
     263: JAX PRNG Design
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/2026-custom-derivatives.html">
     2026: Custom JVP/VJP rules for JAX-transformable functions
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4008-custom-vjp-update.html">
     4008: Custom VJP and `nondiff_argnums` update
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/4410-omnistaging.html">
     4410: Omnistaging
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9407-type-promotion.html">
     9407: Design of Type Promotion Semantics for JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/9419-jax-versioning.html">
     9419: Jax and Jaxlib versioning
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/10657-sequencing-effects.html">
     10657: Sequencing side-effects in JAX
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/11830-new-remat-checkpoint.html">
     11830: `jax.remat` / `jax.checkpoint` new implementation
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jep/12049-type-annotations.html">
     12049: Type Annotation Roadmap for JAX
    </a>
</li>
</ul>
</input></li>
</ul>
<p aria-level="2" class="caption" role="heading">
<span class="caption-text">
  API documentation
 </span>
</p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children">
<a class="reference internal" href="../jax.html">
   Public API: jax package
  </a>
<input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
<label for="toctree-checkbox-4">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l2">
<a class="reference internal" href="../jax.numpy.html">
     jax.numpy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.scipy.html">
     jax.scipy package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.config.html">
     JAX configuration
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.debug.html">
     jax.debug package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.dlpack.html">
     jax.dlpack module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.distributed.html">
     jax.distributed module
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.example_libraries.html">
     jax.example_libraries package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
<label for="toctree-checkbox-5">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.optimizers.html">
       jax.example_libraries.optimizers module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.example_libraries.stax.html">
       jax.example_libraries.stax module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.experimental.html">
     jax.experimental package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
<label for="toctree-checkbox-6">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.checkify.html">
       jax.experimental.checkify module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.global_device_array.html">
       jax.experimental.global_device_array module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.host_callback.html">
       jax.experimental.host_callback module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.maps.html">
       jax.experimental.maps module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.pjit.html">
       jax.experimental.pjit module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.sparse.html">
       jax.experimental.sparse module
      </a>
</li>
<li class="toctree-l3">
<a class="reference internal" href="../jax.experimental.jet.html">
       jax.experimental.jet module
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.flatten_util.html">
     jax.flatten_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.image.html">
     jax.image package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lax.html">
     jax.lax package
    </a>
</li>
<li class="toctree-l2 has-children">
<a class="reference internal" href="../jax.nn.html">
     jax.nn package
    </a>
<input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
<label for="toctree-checkbox-7">
<i class="fas fa-chevron-down">
</i>
</label>
<ul>
<li class="toctree-l3">
<a class="reference internal" href="../jax.nn.initializers.html">
       jax.nn.initializers package
      </a>
</li>
</ul>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.ops.html">
     jax.ops package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.profiler.html">
     jax.profiler module
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.random.html">
     jax.random package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.stages.html">
     jax.stages package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.tree_util.html">
     jax.tree_util package
    </a>
</li>
<li class="toctree-l2">
<a class="reference internal" href="../jax.lib.html">
     jax.lib package
    </a>
</li>
</ul>
</li>
</ul>
</div>
</nav></div>
<div class="bd-sidebar__bottom">
<!-- To handle the deprecated key -->
<div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
<div class="header-article row sticky-top noprint">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
<span class="headerbtn__icon-container">
<i class="fas fa-bars"></i>
</span>
</label>
</div>
<div class="header-article__right">
<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="headerbtn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<a class="headerbtn" data-placement="bottom" data-toggle="tooltip" href="https://github.com/google/jax" title="Source repository">
<span class="headerbtn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<div class="menu-dropdown menu-dropdown-download-buttons">
<button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
<i class="fas fa-download"></i>
</button>
<div class="menu-dropdown__content">
<ul>
<li>
<a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../_sources/jax-101/08-pjit.md.txt" title="Download source file">
<span class="headerbtn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="headerbtn__text-container">.md</span>
</a>
</li>
<li>
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="headerbtn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="headerbtn__text-container">.pdf</span>
</button>
</li>
</ul>
</div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
<span class="headerbtn__icon-container">
<i class="fas fa-list"></i>
</span>
</label>
</div>
</div>
<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
<div class="tocsection onthispage pt-5 pb-3">
<i class="fas fa-list"></i> Contents
    </div>
<nav aria-label="Page" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#background">
   Background
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-it-works">
   How it works:
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#single-host-example">
   Single Host Example
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
     Setup
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mesh">
     Mesh
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#input-data">
     Input Data
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#in-axis-resources-out-axis-resources">
     in_axis_resources &amp; out_axis_resources
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#putting-everything-together">
     Putting everything together
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#more-information-on-partitionspec">
     More information on PartitionSpec:
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-x-none">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec('x',
       </span>
<span class="pre">
        None)
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-y-none">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec('y',
       </span>
<span class="pre">
        None)
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-x-y-none">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec((‚Äúx‚Äù,
       </span>
<span class="pre">
        ‚Äúy‚Äù),
       </span>
<span class="pre">
        None)
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-none-y">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec(None,
       </span>
<span class="pre">
        'y')
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-none-x">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec(None,
       </span>
<span class="pre">
        'x')
       </span>
</code>
</strong>
</a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#multiple-host-example">
   Multiple Host Example
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
     Setup
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
     Mesh
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
     Input data
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
     in_axis_resources &amp; out_axis_resources
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id5">
     Putting everything together
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class="article row">
<div class="col pl-md-3 pl-lg-5 content-container">
<!-- Table of contents that is only displayed when printing the page -->
<div class="onlyprint" id="jb-print-docs-body">
<h1>Introduction to pjit</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#background">
   Background
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#how-it-works">
   How it works:
  </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#single-host-example">
   Single Host Example
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#setup">
     Setup
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#mesh">
     Mesh
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#input-data">
     Input Data
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#in-axis-resources-out-axis-resources">
     in_axis_resources &amp; out_axis_resources
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#putting-everything-together">
     Putting everything together
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#more-information-on-partitionspec">
     More information on PartitionSpec:
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-x-none">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec('x',
       </span>
<span class="pre">
        None)
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-y-none">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec('y',
       </span>
<span class="pre">
        None)
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-x-y-none">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec((‚Äúx‚Äù,
       </span>
<span class="pre">
        ‚Äúy‚Äù),
       </span>
<span class="pre">
        None)
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-none-y">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec(None,
       </span>
<span class="pre">
        'y')
       </span>
</code>
</strong>
</a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#partitionspec-none-x">
<strong>
      -
      <code class="docutils literal notranslate">
<span class="pre">
        PartitionSpec(None,
       </span>
<span class="pre">
        'x')
       </span>
</code>
</strong>
</a>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#multiple-host-example">
   Multiple Host Example
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
     Setup
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id2">
     Mesh
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id3">
     Input data
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id4">
     in_axis_resources &amp; out_axis_resources
    </a>
</li>
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id5">
     Putting everything together
    </a>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<main id="main-content" role="main">
<div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Introduction to pjit"></a><section class="tex2jax_ignore mathjax_ignore" id="introduction-to-pjit">
<h1>Introduction to pjit<a class="headerlink" href="#introduction-to-pjit" title="Permalink to this headline">#</a></h1>
<p>This guide explains how to use pjit to compile and automatically partition functions in both single and multi-host environments. <code class="docutils literal notranslate"><span class="pre">pjit</span></code> is <code class="docutils literal notranslate"><span class="pre">jit</span></code> with <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code> and <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code> to specify how a function should be partitioned. <code class="docutils literal notranslate"><span class="pre">pjit</span></code> can be useful when the jitted version of <code class="docutils literal notranslate"><span class="pre">fun</span></code> would not fit in a single device‚Äôs memory, or to speed up <code class="docutils literal notranslate"><span class="pre">fun</span></code> by running each operation in parallel across multiple devices. <code class="docutils literal notranslate"><span class="pre">pjit</span></code> enables users to shard computations without rewriting using the SPMD partitioner. The returned function has semantics equivalent to those of <code class="docutils literal notranslate"><span class="pre">fun</span></code>, but is compiled to an XLA computation that runs across multiple devices (e.g. multiple GPUs or multiple TPU cores).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">jax</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">pjit</span><span class="o">.</span><span class="n">pjit</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">in_axis_resources</span><span class="p">,</span> <span class="n">out_axis_resources</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(),</span> <span class="n">donate_argnums</span><span class="o">=</span><span class="p">())</span>
</pre></div>
</div>
<p>Two examples are shown in this guide to demonstrate how <code class="docutils literal notranslate"><span class="pre">pjit</span></code> works in both single and multi-host environments. The identity function (<code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">x</span></code>) is chosen to better show how other input parameters are used.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Background"></a><section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">#</a></h2>
<p>The core infrastructure that supports parallel model training is the XLA SPMD partitioner. It takes in an XLA program that represents the complete neural net, as if there is only one giant virtual device. In addition to the program, it also takes in partitioning specifications for both function inputs and outputs. The output of the XLA SPMD partitioner is an identical program for N devices that performs communications between devices through collective operations. The program only compiles once per host. <strong><code class="docutils literal notranslate"><span class="pre">pjit</span></code> is the API exposed for the XLA SPMD partitioner in JAX.</strong></p>
<p><img alt="spmd" src="../_images/xla_spmd.jpg"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/How it works:"></a><section id="how-it-works">
<h2>How it works:<a class="headerlink" href="#how-it-works" title="Permalink to this headline">#</a></h2>
<p>The partitioning over devices happens automatically based on the propagation of the input partitioning specified in <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code> and the output partitioning specified in <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code>. The resources specified in those two arguments must refer to <code class="docutils literal notranslate"><span class="pre">mesh</span> <span class="pre">axes</span></code>, as defined by the <code class="docutils literal notranslate"><span class="pre">jax.experimental.maps.Mesh()</span></code> context manager. Note that the <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> definition at <code class="docutils literal notranslate"><span class="pre">pjit</span></code> application time is ignored, and the returned function will use the <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> definition available at each call site.</p>
<p>Inputs to a <code class="docutils literal notranslate"><span class="pre">pjit</span></code>ted function will be automatically partitioned across devices if they‚Äôre not already correctly partitioned based on <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>. In some scenarios, ensuring that the inputs are already correctly pre-partitioned can increase performance. For example, if passing the output of one pjit‚Äôd function to another <code class="docutils literal notranslate"><span class="pre">pjit</span></code>ted function (or the same pjit‚Äôd function in a loop), make sure the relevant <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code> match the corresponding <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Single Host Example"></a><section id="single-host-example">
<h2>Single Host Example<a class="headerlink" href="#single-host-example" title="Permalink to this headline">#</a></h2>
<p>In this example, we have</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mesh</span></code>: a mesh of shape (4, 2) and axes named ‚Äòx‚Äô and ‚Äòy‚Äô respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">input</span> <span class="pre">data</span></code>: an 8 by 2 numpy array.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>: None. So the (8, 2) input data is replicated across all devices.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code>: <code class="docutils literal notranslate"><span class="pre">PartitionSpec('x',</span> <span class="pre">'y')</span></code>. It specifies that the two dimensions of output data are sharded over ‚Äòx‚Äô and ‚Äòy‚Äô respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">function</span></code>: <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">x</span></code>. It is the identity function.</p></li>
</ul>
<p>As a result, the <code class="docutils literal notranslate"><span class="pre">pjit</span></code>ted function applied with the given mesh replicates the input across all devices based on <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>, and then keeps only what each device should have based on <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code>. It effectively shards the data on CPU across all accelerators according to the <code class="docutils literal notranslate"><span class="pre">PartitionSpec</span></code>.</p>
<p>Each parameter is explained in detail below:</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Setup"></a><section id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">#</a></h3>
<p>This tutorial should be run on TPU with 8 devices. Please <a class="reference external" href="https://cloud.google.com/tpu/docs/jax-pods">build your own runtime</a> on Google Cloud Platform and <a class="reference external" href="https://research.google.com/colaboratory/local-runtimes.html">connects to it using Jupyter</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">maps</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">PartitionSpec</span>
<span class="kn">from</span> <span class="nn">jax.experimental.pjit</span> <span class="kn">import</span> <span class="n">pjit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Mesh"></a><section id="mesh">
<h3>Mesh<a class="headerlink" href="#mesh" title="Permalink to this headline">#</a></h3>
<p>The mesh is defined in <a class="reference external" href="https://github.com/google/jax/blob/main/jax/interpreters/pxla.py#L1389">jax/interpreters/pxla</a>: It is a NumPy array of JAX devices in a multi-dimensional grid, alongside names for the axes of this mesh. It is also called the logical mesh.</p>
<p>In the example we are working with, the first (vertical) axis is named ‚Äòx‚Äô and has length 4, and the second (horizontal) axis is named ‚Äòy‚Äô and has length 2. If a dimension of data is sharded across an axis, each device has a slice of the size of <code class="docutils literal notranslate"><span class="pre">data.shape[dim]</span></code> divided by <code class="docutils literal notranslate"><span class="pre">mesh_shape[axis]</span></code>. If data is replicated across an axis, devices on that axis should have the same data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mesh_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">devices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">mesh_shape</span><span class="p">)</span>
<span class="c1"># 'x', 'y' axis names are used here for simplicity</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">))</span>
<span class="n">mesh</span>
</pre></div>
</div>
</div>
</div>
<p>The actual TPU physical device mesh are connected by Inter-chip Interconnect (ICI) fabric. The logical mesh with given axis names is created to abstract the physical device mesh because it is easier to reshape the logical mesh based on distributed computation needs. The layout of the logical mesh is different from that of the physical mesh.</p>
<p>For example, we can have a physical mesh of size (4, 4, 4). If the computation requires a 16-way data parallelism and 4-way model parallelism, the physical mesh should be abstracted to a logical mesh with a shape of (16, 4).</p>
<p><img alt="spmd" src="../_images/mesh.jpg"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Input Data"></a><section id="input-data">
<h3>Input Data<a class="headerlink" href="#input-data" title="Permalink to this headline">#</a></h3>
<p>A NumPy array of size (8,2)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">input_data</span>
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/in_axis_resources &amp; out_axis_resources"></a><section id="in-axis-resources-out-axis-resources">
<h3>in_axis_resources &amp; out_axis_resources<a class="headerlink" href="#in-axis-resources-out-axis-resources" title="Permalink to this headline">#</a></h3>
<p>Pytree of structure matching that of arguments to fun, with all actual arguments replaced by resource assignment specifications. It is also valid to specify a pytree prefix (e.g. one value in place of a whole subtree), in which case the leaves get broadcast to all values in that subtree.</p>
<p>The valid resource assignment specifications are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code>, in which case the value will be replicated on all devices</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PartitionSpec</span></code>, a tuple of length at most equal to the rank of the partitioned value. Each element can be a None, a mesh axis or a tuple of mesh axes, and specifies the set of resources assigned to partition the value‚Äôs dimension matching its position in the spec. More details are discussed in the section below (More information on PartitionSpec).</p></li>
</ul>
<p>The size of every dimension has to be a multiple of the total number of resources assigned to it.</p>
<p><code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code> is like <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>, but specifies resource assignment for function outputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">in_axis_resources</span><span class="o">=</span><span class="kc">None</span>
<span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Putting everything together"></a><section id="putting-everything-together">
<h3>Putting everything together<a class="headerlink" href="#putting-everything-together" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
  <span class="n">in_axis_resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">))</span>
 
<span class="c1"># Sends data to accelerators based on partition_spec</span>
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">device_buffers</span>
</pre></div>
</div>
</div>
</div>
<p>The result after applying the <code class="docutils literal notranslate"><span class="pre">pjit</span></code>ted function is a <code class="docutils literal notranslate"><span class="pre">ShardedDeviceArray</span></code>, and <code class="docutils literal notranslate"><span class="pre">device_buffers</span></code> shows what data each device has.</p>
<p><strong>Result visualization:</strong>
Each color represents a different device. Since an (8,2) array is partitioned across a (4,2) mesh in both ‚Äòx‚Äô and ‚Äòy‚Äô axes, each accelerator ends up with a (2,1) slice of the data.</p>
<p><img alt="spmd" src="../_images/partition_spec_x_y.png"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/More information on PartitionSpec:"></a><section id="more-information-on-partitionspec">
<h3>More information on PartitionSpec:<a class="headerlink" href="#more-information-on-partitionspec" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">PartitionSpec</span></code> is a named tuple, whose element can be a <code class="docutils literal notranslate"><span class="pre">None</span></code>, a mesh axis or a tuple of mesh axes. Each element describes which mesh dimension the input‚Äôs dimension is partitioned across. For example, <code class="docutils literal notranslate"><span class="pre">PartitionSpec('x',</span> <span class="pre">'y')</span></code> is a PartitionSpec where the first dimension of data is sharded across ‚Äòx‚Äô axis of the mesh, and the second dimension is sharded across ‚Äòy‚Äô axis of the mesh.</p>
<p><strong>Examples of other possible PartitionSpecs:</strong></p>
<p>Reminder: mesh is of shape (4, 2), input data is of shape (8, 2).</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/- PartitionSpec('x', None)"></a><section id="partitionspec-x-none">
<h3><strong>- <code class="docutils literal notranslate"><span class="pre">PartitionSpec('x',</span> <span class="pre">None)</span></code></strong><a class="headerlink" href="#partitionspec-x-none" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
  <span class="n">in_axis_resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
 
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">device_buffers</span>
</pre></div>
</div>
</div>
</div>
<p>The first dimension of the input is sharded across ‚Äòx‚Äô axis and the other dimensions are replicated across other axes. <code class="docutils literal notranslate"><span class="pre">None</span></code> can also be omitted in the PartitionSpec. If <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span> <span class="pre">=</span> <span class="pre">PartitionSpec('x',</span> <span class="pre">None)</span></code> in the example above, the result visualization will be the following:</p>
<p><img alt="spmd" src="../_images/partition_spec_x_none.png"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/- PartitionSpec('y', None)"></a><section id="partitionspec-y-none">
<h3><strong>- <code class="docutils literal notranslate"><span class="pre">PartitionSpec('y',</span> <span class="pre">None)</span></code></strong><a class="headerlink" href="#partitionspec-y-none" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
  <span class="n">in_axis_resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'y'</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
 
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">device_buffers</span>
</pre></div>
</div>
</div>
</div>
<p>the first dimension of the input is sharded across <code class="docutils literal notranslate"><span class="pre">y</span></code> axis and the other dimensions are replicated across other axes. If <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span> <span class="pre">=</span> <span class="pre">PartitionSpec(‚Äúy‚Äù,</span> <span class="pre">None)</span></code> in the example above, the result visualization will be the following:</p>
<p><img alt="spmd" src="../_images/partition_spec_y_none.png"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/- PartitionSpec((‚Äúx‚Äù, ‚Äúy‚Äù), None)"></a><section id="partitionspec-x-y-none">
<h3><strong>- <code class="docutils literal notranslate"><span class="pre">PartitionSpec((‚Äúx‚Äù,</span> <span class="pre">‚Äúy‚Äù),</span> <span class="pre">None)</span></code></strong><a class="headerlink" href="#partitionspec-x-y-none" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
  <span class="n">in_axis_resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
 
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">device_buffers</span>
</pre></div>
</div>
</div>
</div>
<p>the first dimension of the input is sharded across both ‚Äòx‚Äô and ‚Äòy‚Äô axes and the other dimensions are replicated across other axes. We can think of this as stretching the 2D mesh into an 1D mesh and then do the partition. If <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span> <span class="pre">=</span> <span class="pre">PartitionSpec(('x',</span> <span class="pre">'y'),</span> <span class="pre">None)</span></code> in the example above, the result visualization will be the following:</p>
<p><img alt="spmd" src="../_images/partition_spec_xy.png"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/- PartitionSpec(None, 'y')"></a><section id="partitionspec-none-y">
<h3><strong>- <code class="docutils literal notranslate"><span class="pre">PartitionSpec(None,</span> <span class="pre">'y')</span></code></strong><a class="headerlink" href="#partitionspec-none-y" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
  <span class="n">in_axis_resources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">))</span>
 
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">device_buffers</span>
</pre></div>
</div>
</div>
</div>
<p>the second dimension of the input is sharded over y axis and the first dimensions is replicated across other axes. We can think of this as stretching the 2D mesh into an 1D mesh and then do the partition. If <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span> <span class="pre">=</span> <span class="pre">PartitionSpec(None,</span> <span class="pre">'y')</span></code> in the example above, the result visualization will be the following:</p>
<p><img alt="spmd" src="../_images/partition_spec_none_y.png"/></p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/- PartitionSpec(None, 'x')"></a><section id="partitionspec-none-x">
<h3><strong>- <code class="docutils literal notranslate"><span class="pre">PartitionSpec(None,</span> <span class="pre">'x')</span></code></strong><a class="headerlink" href="#partitionspec-none-x" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">pjit</span></code> will complain when <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code> is set to be <code class="docutils literal notranslate"><span class="pre">PartitionSpec(None,</span> <span class="pre">'x')</span></code>. This is because the second dimension of input data is of size 2, but mesh‚Äôs ‚Äòx‚Äô dimension has size 4. size 2 can not be sharded over size 4. It is important to note that the size of input data has to be divisible by the size of mesh on corresponding dimensions.</p>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Multiple Host Example"></a><section id="multiple-host-example">
<h2>Multiple Host Example<a class="headerlink" href="#multiple-host-example" title="Permalink to this headline">#</a></h2>
<p>The following example is run in parallel on each host in a Cloud TPU v3-32 pod slice (4 hosts 32 devices). (<a class="reference external" href="https://cloud.google.com/tpu/docs/jax-pods">Set up instruction here</a>)</p>
<p>In this example, we have</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mesh</span></code>: a mesh of shape (16, 2) and axes named ‚Äòx‚Äô and ‚Äòy‚Äô respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">input</span> <span class="pre">data</span></code>: Each host contains a quarter (8, 2) of the input data of size (32, 2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>: <code class="docutils literal notranslate"><span class="pre">PartitionSpec(('x',</span> <span class="pre">'y'),)</span></code>. This lets <code class="docutils literal notranslate"><span class="pre">pjit</span></code> know that the (32, 2) input data is already split evenly across hosts (done by user).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code>: <code class="docutils literal notranslate"><span class="pre">PartitionSpec('x',</span> <span class="pre">'y')</span></code>. It specifies that the two dimensions of output data are sharded over <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> respectively.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">function</span></code>: <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x:</span> <span class="pre">x</span></code>. It is the identity function.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">pjit</span></code>ted function applied with a given mesh distributes an even slice to each device. It effectively shards the data on hosts across all accelerators based on the <code class="docutils literal notranslate"><span class="pre">PartitionSpec</span></code>.</p>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Setup"></a><section id="id1">
<h3>Setup<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">maps</span>
<span class="kn">from</span> <span class="nn">jax.experimental</span> <span class="kn">import</span> <span class="n">PartitionSpec</span>
<span class="kn">from</span> <span class="nn">jax.experimental.pjit</span> <span class="kn">import</span> <span class="n">pjit</span>
<span class="kn">from</span> <span class="nn">jax.interpreters</span> <span class="kn">import</span> <span class="n">pxla</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Mesh"></a><section id="id2">
<h3>Mesh<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<p>In this example, there are 4 hosts with 32 devices. These physical devices are abstracted to a logical mesh of size (16, 2). The first (vertical) axis is named ‚Äòx‚Äô and has length 16, and the second (horizontal) axis is named ‚Äòy‚Äô and has length 2. Within the global mesh, the first (4, 2) devices are connected to host 0, the second (4, 2) devices are connected to host 1. The first 8 devices (in the order of left to right, top to bottom) always belong to host 0, and the second 8 devices always belong to host 1 and so on.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mesh_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">devices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">mesh_shape</span><span class="p">)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">))</span>
</pre></div>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Input data"></a><section id="id3">
<h3>Input data<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h3>
<p>In a multi-host environment, all the devices connected to one host have to contain a subslice of a single continuous large slice of the data. In JAX SPMD, there are no direct communications between hosts, so hosts only talk to each other via collective communication between devices. As a result, users need to handle distributed data loading on hosts.</p>
<p>In this example, the input array of size (32,2) is manually split into quarters of size (8,2) along the ‚Äòx‚Äô axis by user and assigned to each host.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">jax</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
 <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">jax</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
 <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">jax</span><span class="o">.</span><span class="n">process_index</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
 <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">48</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
 <span class="n">input_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pjit</span></code> always assumes that the input is the local data chunk of a global array. If the local chunk it to be sharded over multiple local devices and is not partitioned as expected, pjit will put the right slices on the right <strong>local devices</strong> for you. Once all of the local chunks are on the devices on all the
hosts, then XLA will run the computation.</p>
<p>XLA operates on the global data so if <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code> is different than <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code> then XLA will do data redistribution cross-host. So global communication doesn‚Äôt happen in preparation for the launch of the XLA executable that pjit represents, but only in the XLA executable itself.</p>
<p>One way to do data redistribution cross-host is to use an identity <code class="docutils literal notranslate"><span class="pre">pjit</span></code> with <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code> different from <code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code>. XLA will do the global data reordering for you via <code class="docutils literal notranslate"><span class="pre">pjit</span></code>.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/in_axis_resources &amp; out_axis_resources"></a><section id="id4">
<h3>in_axis_resources &amp; out_axis_resources<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>: <code class="docutils literal notranslate"><span class="pre">PartitionSpec(('x',</span> <span class="pre">'y'),)</span></code>. This partitions the first dimension of input data over both ‚Äòx‚Äô and ‚Äòy‚Äô axes. Since input argument dimensions partitioned over multi-process mesh axes should be of size equal to the corresponding local mesh axis size, pjit sends the (8, 2) on each host to its devices based on <code class="docutils literal notranslate"><span class="pre">in_axis_resources</span></code>. Since each host has a logical mesh of size (4, 2) within the entire logical mesh, each device has a (1, 2) slice.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">out_axis_resources</span></code>: <code class="docutils literal notranslate"><span class="pre">PartitionSpec('x',</span> <span class="pre">'y')</span></code>. It specifies that the two dimensions of output data are sharded over ‚Äòx‚Äô and ‚Äòy‚Äô respectively, so each device gets a (2,1) slice.</p></li>
</ul>
<p><strong>Note</strong>: in_axis_resources and out_axis_resources are different. Here, in_axis_resources shards input data‚Äôs first dimension over both ‚Äòx‚Äô and ‚Äòy‚Äô, whereas out_axis_resources shards input data‚Äôs first dimension only over ‚Äòx‚Äô.</p>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Putting everything together"></a><section id="id5">
<h3>Putting everything together<a class="headerlink" href="#id5" title="Permalink to this headline">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
   <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
   <span class="n">in_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">((</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">),),</span>
   <span class="n">out_axis_resources</span><span class="o">=</span><span class="n">PartitionSpec</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">))</span>

<span class="c1"># Sends data to accelerators based on partition_spec</span>
<span class="k">with</span> <span class="n">maps</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">axis_names</span><span class="p">):</span>
 <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Result on host 0</strong></p>
<p><img alt="spmd" src="../_images/multi_host.jpg"/></p>
</section>
</section>
</section>
</div>
</main>
<footer class="footer-article noprint">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="07-state.html" id="prev-link" title="previous page">
<i class="fas fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Stateful Computations in JAX</p>
</div>
</a>
<a class="right-next" href="../debugging/index.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Runtime value debugging in JAX</p>
</div>
<i class="fas fa-angle-right"></i>
</a>
</div>
</footer>
</div>
</div>
<div class="footer-content row">
<footer class="col footer"><p>
  
    By The JAX authors<br/>
  
      ¬© Copyright 2020, The JAX Authors. NumPy and SciPy documentation are copyright the respective authors..<br/>
</p>
</footer>
</div>
</div>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
</body>
</html>