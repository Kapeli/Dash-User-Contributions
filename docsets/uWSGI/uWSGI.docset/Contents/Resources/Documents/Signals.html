
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The uWSGI Signal Framework &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The uWSGI Spooler" href="Spooler.html" />
    <link rel="prev" title="SharedArea – share memory pages between uWSGI components" href="SharedArea.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Spooler.html" title="The uWSGI Spooler"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="SharedArea.html" title="SharedArea – share memory pages between uWSGI components"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-uwsgi-signal-framework">
<h1>The uWSGI Signal Framework<a class="headerlink" href="#the-uwsgi-signal-framework" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Raw usage of uwsgi signals is for advanced users only. You should see <a class="reference internal" href="PythonDecorators.html"><span class="doc">uWSGI API - Python decorators</span></a> for a more elegant abstraction.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>uWSGI Signals have _nothing_ in common with UNIX/Posix signals (if you are looking for those, <a class="reference internal" href="Management.html"><span class="doc">Managing the uWSGI server</span></a> is your page).</p>
</div>
<p>Over time, your uWSGI stack is growing, you add spoolers, more processes, more plugins, whatever. The more features you add the more you need all of these components to speak to each other.</p>
<p>Another important task for today’s rich/advanced web apps is to respond to different events. An event could be a file modification, a new cluster node popping up, another one (sadly) dying, a timer having elapsed… whatever you can imagine.</p>
<p>Communication and event management are all managed by the same subsystem – the uWSGI signal framework.</p>
<p>uWSGI signals are managed with sockets, so they are <em>fully reliable</em>. When you send an uWSGI signal, you can be sure that it will be delivered.</p>
<div class="section" id="the-signals-table">
<h2>The Signals table<a class="headerlink" href="#the-signals-table" title="Permalink to this headline">¶</a></h2>
<p>Signals are simple <em>1 byte</em> messages that are routed by the master process to workers and spoolers.</p>
<p>When a worker receives a signal it searches the signals table for the corresponding handler to execute.</p>
<p>The signal table is shared by all workers (and protected against race conditions by a shared lock).</p>
<p>Every uWSGI process (mainly the master though) can write into it to set signal handlers and recipient processes.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Always pay attention to who will run the signal handler. It must have access to the handler itself.
This means that if you define a new function in <code class="docutils literal notranslate"><span class="pre">worker1</span></code> and register it as a signal handler, only <code class="docutils literal notranslate"><span class="pre">worker1</span></code> can run it.
The best way to register signals is defining them in the master, so (thanks to <code class="docutils literal notranslate"><span class="pre">fork()</span></code>) all workers see them.</p>
</div>
</div>
<div class="section" id="defining-signal-handlers">
<h2>Defining signal handlers<a class="headerlink" href="#defining-signal-handlers" title="Permalink to this headline">¶</a></h2>
<p>To manage the signals table the uWSGI API exposes one simple function, <a class="reference internal" href="PythonModule.html#uwsgi.register_signal" title="uwsgi.register_signal"><code class="xref py py-meth docutils literal notranslate"><span class="pre">uwsgi.register_signal()</span></code></a>.</p>
<p>These are two simple examples of defining signal table items, in Python and Lua.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">hello_signal</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;i am the signal </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num</span>

<span class="k">def</span> <span class="nf">hello_signal2</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;Hi, i am the signal </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">num</span>

<span class="c1"># define 2 signal table items (30 and 22)</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">register_signal</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="n">hello_signal</span><span class="p">)</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">register_signal</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="s2">&quot;workers&quot;</span><span class="p">,</span> <span class="n">hello_signal2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">hello_signal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;i am Lua, received signal &quot;</span> <span class="o">..</span> <span class="n">sig</span> <span class="o">..</span><span class="p">)</span>
<span class="kr">end</span>

<span class="o">#</span> <span class="n">define</span> <span class="n">a</span> <span class="n">single</span> <span class="n">signal</span> <span class="n">table</span> <span class="n">item</span> <span class="p">(</span><span class="n">signal</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">register_signal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="n">hello_signal</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="signals-targets">
<h2>Signals targets<a class="headerlink" href="#signals-targets" title="Permalink to this headline">¶</a></h2>
<p>The third argument of uwsgi.register_signal is the ‘signal target’.</p>
<p>It instructs the system about ‘who’ must run the handler. By default the target is ‘worker’ that means ‘the first available worker’. The following targets are available:</p>
<ul class="simple">
<li><p>workerN (run the signal handler only on worker N)</p></li>
<li><p>worker/worker0 (the default one, run the signal handler on the first available worker)</p></li>
<li><p>workers (run the signal handler on all the workers)</p></li>
<li><p>active-workers (run the signal handlers on all the active [non-cheaped] workers)</p></li>
<li><p>spooler (run the signal on the first available spooler)</p></li>
<li><p>mules (run the signal handler on all of the mules)</p></li>
<li><p>muleN (run the signal handler on mule N)</p></li>
<li><p>mule/mule0 (run the signal handler on the first available mule)</p></li>
<li><p>farmN/farm_XXX (run the signal handler in the mule farm N or named XXX)</p></li>
</ul>
</div>
<div class="section" id="raising-signals">
<h2>Raising signals<a class="headerlink" href="#raising-signals" title="Permalink to this headline">¶</a></h2>
<p>Signals may be raised using <a class="reference internal" href="PythonModule.html#uwsgi.signal" title="uwsgi.signal"><code class="xref py py-meth docutils literal notranslate"><span class="pre">uwsgi.signal()</span></code></a>. When you send a signal, it is copied into the master’s queue. The master will then check the signal table and dispatch the messages.</p>
</div>
<div class="section" id="external-events">
<h2>External events<a class="headerlink" href="#external-events" title="Permalink to this headline">¶</a></h2>
<p>The most useful feature of uWSGI signals is that they can be used to announce external events.</p>
<p>At the time of writing the available external events are</p>
<ul class="simple">
<li><p>filesystem modifications</p></li>
<li><p>timers/rb_timers</p></li>
<li><p>cron</p></li>
</ul>
<p>Other events are exposed via plugins, like <a class="reference external" href="https://github.com/unbit/uwsgi-pgnotify">https://github.com/unbit/uwsgi-pgnotify</a> raising signal whenever a postgres notification channel is ready.</p>
<div class="section" id="filesystem-modifications">
<h3>Filesystem modifications<a class="headerlink" href="#filesystem-modifications" title="Permalink to this headline">¶</a></h3>
<p>To map a specific file/directory modification event to a signal you can use <a class="reference internal" href="PythonModule.html#uwsgi.add_file_monitor" title="uwsgi.add_file_monitor"><code class="xref py py-meth docutils literal notranslate"><span class="pre">uwsgi.add_file_monitor()</span></code></a>.</p>
<p>An example:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">hello_file</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;/tmp has been modified !!!&quot;</span>

<span class="n">uwsgi</span><span class="o">.</span><span class="n">register_signal</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="n">hello_file</span><span class="p">)</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">add_file_monitor</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;/tmp&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>From now on, every time <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> is modified, signal 17 will be raised and <code class="docutils literal notranslate"><span class="pre">hello_file</span></code> will be run by the first available worker.</p>
</div>
<div class="section" id="timers">
<h3>Timers<a class="headerlink" href="#timers" title="Permalink to this headline">¶</a></h3>
<p>Timers are another useful feature in web programming – for instance to clear sessions and shopping carts and what-have-you.</p>
<p>Timers are implemented using kernel facilities (most notably kqueue on BSD systems and timerfd() on modern Linux kernels). uWSGI also contains support for rb_timers, timers implemented in user space using red-black trees.</p>
<p>To register a timer, use <a class="reference internal" href="PythonModule.html#uwsgi.add_timer" title="uwsgi.add_timer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">uwsgi.add_timer()</span></code></a>. To register an rb_timer, use <a class="reference internal" href="PythonModule.html#uwsgi.add_rb_timer" title="uwsgi.add_rb_timer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">uwsgi.add_rb_timer()</span></code></a>.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">hello_timer</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;2 seconds elapsed, signal </span><span class="si">%d</span><span class="s2"> raised&quot;</span> <span class="o">%</span> <span class="n">num</span>

<span class="k">def</span> <span class="nf">oneshot_timer</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;40 seconds elapsed, signal </span><span class="si">%d</span><span class="s2"> raised. You will never see me again.&quot;</span> <span class="o">%</span> <span class="n">num</span>


<span class="n">uwsgi</span><span class="o">.</span><span class="n">register_signal</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="s2">&quot;worker&quot;</span><span class="p">,</span> <span class="n">hello_timer</span><span class="p">)</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">register_signal</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">oneshot_timer</span><span class="p">)</span>

<span class="n">uwsgi</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># never-ending timer every 2 seconds</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">add_rb_timer</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># one shot rb timer after 40 seconds</span>
</pre></div>
</div>
<p>Signal 26 will be raised every 2 seconds and handled by the first available worker.
Signal 30 will be raised after 40 seconds and executed only once.</p>
</div>
</div>
<div class="section" id="signal-wait-and-signal-received">
<h2>signal_wait and signal_received<a class="headerlink" href="#signal-wait-and-signal-received" title="Permalink to this headline">¶</a></h2>
<p>Unregistered signals (those without an handler associated) will be routed to the first available worker to use the <a class="reference internal" href="PythonModule.html#uwsgi.signal_wait" title="uwsgi.signal_wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">uwsgi.signal_wait()</span></code></a> function.</p>
<div class="highlight-xxx notranslate"><div class="highlight"><pre><span></span>uwsgi.signal_wait()
signum = uwsgi.signal_received()
</pre></div>
</div>
<p>You can combine external events (file monitors, timers…) with this technique to implement event-based apps. A good example is a chat server where every core waits for text sent by users.</p>
<p>You can also wait for specific (even registered) signals by passing a signal number to <code class="docutils literal notranslate"><span class="pre">signal_wait</span></code>.</p>
</div>
<div class="section" id="todo-known-issues">
<h2>Todo/Known Issues<a class="headerlink" href="#todo-known-issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Signal table entry cannot be removed (this will be fixed soon)</p></li>
<li><p>Iterations work only with rb_timers</p></li>
<li><p>uwsgi.signal_wait() does not work in async mode (will be fixed)</p></li>
<li><p>Add iterations to file monitoring (to allow one-shot event as timers)</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The uWSGI Signal Framework</a><ul>
<li><a class="reference internal" href="#the-signals-table">The Signals table</a></li>
<li><a class="reference internal" href="#defining-signal-handlers">Defining signal handlers</a></li>
<li><a class="reference internal" href="#signals-targets">Signals targets</a></li>
<li><a class="reference internal" href="#raising-signals">Raising signals</a></li>
<li><a class="reference internal" href="#external-events">External events</a><ul>
<li><a class="reference internal" href="#filesystem-modifications">Filesystem modifications</a></li>
<li><a class="reference internal" href="#timers">Timers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#signal-wait-and-signal-received">signal_wait and signal_received</a></li>
<li><a class="reference internal" href="#todo-known-issues">Todo/Known Issues</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="SharedArea.html"
                        title="previous chapter">SharedArea – share memory pages between uWSGI components</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Spooler.html"
                        title="next chapter">The uWSGI Spooler</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Signals.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Spooler.html" title="The uWSGI Spooler"
             >next</a> |</li>
        <li class="right" >
          <a href="SharedArea.html" title="SharedArea – share memory pages between uWSGI components"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>