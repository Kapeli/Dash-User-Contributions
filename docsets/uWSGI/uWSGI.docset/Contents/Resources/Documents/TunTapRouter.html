
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The TunTap Router &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Monitoring uWSGI with Nagios" href="Nagios.html" />
    <link rel="prev" title="The Forkpty Router" href="ForkptyRouter.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Nagios.html" title="Monitoring uWSGI with Nagios"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ForkptyRouter.html" title="The Forkpty Router"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-tuntap-router">
<h1>The TunTap Router<a class="headerlink" href="#the-tuntap-router" title="Permalink to this headline">¶</a></h1>
<p>The TunTap router is an ad-hoc solution for giving network connectivity to Linux processes running in a dedicated network namespace. Well obviously it has other uses, but very probably this is the most interesting one, and the one for which it was developed. Currently it builds only on Linux platforms.</p>
<p>The TunTap router is not compiled in by default.</p>
<p>For having it in one shot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UWSGI_EMBED_PLUGINS</span><span class="o">=</span>tuntap make
</pre></div>
</div>
<p>(yes the plugin is named only ‘tuntap’ as effectively it exposes various tuntap devices features)</p>
<p>The best way to use it is binding it to a unix socket, allowing processes in new namespaces to reach it (generally unix sockets are the best communication channel for linux namespaces).</p>
<div class="section" id="the-first-config">
<h2>The first config<a class="headerlink" href="#the-first-config" title="Permalink to this headline">¶</a></h2>
<p>We want our vassals to live in the 192.168.0.0/24 network, with 192.168.0.1 as default gateway.</p>
<p>The default gateway (read: the tuntap router) is managed by the Emperor itself</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; create the tun device &#39;emperor0&#39; and bind it to a unix socket</span>
<span class="na">tuntap-router</span> <span class="o">=</span> <span class="s">emperor0 /tmp/tuntap.socket</span>
<span class="c1">; give it an ip address</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig emperor0 192.168.0.1 netmask 255.255.255.0 up</span>
<span class="c1">; setup nat</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">iptables -t nat -F</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
<span class="c1">; enable linux ip forwarding</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">echo 1 &gt;/proc/sys/net/ipv4/ip_forward</span>
<span class="c1">; force vassals to be created in a new network namespace</span>
<span class="na">emperor-use-clone</span> <span class="o">=</span> <span class="s">net</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/vassals</span>
</pre></div>
</div>
<p>The vassals spawned by this Emperor will born without network connectivity.</p>
<p>To give them access to the public network we create a new tun device (it will exist only in the vassal network namespace)
instructing it to route traffic to the Emperor tuntap unix socket:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; we need it as the vassal have no way to know it is jailed</span>
<span class="c1">; without it post_jail plugin hook would be never executed</span>
<span class="na">jailed</span> <span class="o">=</span> <span class="s">true</span>
<span class="c1">; create uwsgi0 tun interface and force it to connect to the Emperor exposed unix socket</span>
<span class="na">tuntap-device</span> <span class="o">=</span> <span class="s">uwsgi0 /tmp/tuntap.socket</span>
<span class="c1">; bring up loopback</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig lo up</span>
<span class="c1">; bring up interface uwsgi0</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig uwsgi0 192.168.0.2 netmask 255.255.255.0 up</span>
<span class="c1">; and set the default gateway</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">route add default gw 192.168.0.1</span>
<span class="c1">; classic options</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">customer001</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">customer001</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/var/www/foobar.socket</span>
<span class="na">psgi-file</span> <span class="o">=</span> <span class="s">foobar.pl</span>
<span class="na">...</span>
</pre></div>
</div>
</div>
<div class="section" id="the-embedded-firewall">
<h2>The embedded firewall<a class="headerlink" href="#the-embedded-firewall" title="Permalink to this headline">¶</a></h2>
<p>The TunTap router includes a very simple firewall for governing vassal’s traffic</p>
<p>Firewalling is based on 2 chains (in and out), and each rule is formed by 3 parameters: &lt;action&gt; &lt;src&gt; &lt;dst&gt;</p>
<p>The firewall is applied to traffic from the clients to the tuntap device (out) and the opposite (in)</p>
<p>The first matching rule stops the chain, if no rule applies, the policy is “allow”</p>
<p>the following rules allows access from vassals to the internet, but block vassals intercommunication</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">tuntap-router</span> <span class="o">=</span> <span class="s">emperor0 /tmp/tuntap.socket</span>

<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">allow 192.168.0.0/24 192.168.0.1</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">deny 192.168.0.0/24 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">allow 192.168.0.0/24 0.0.0.0</span>
<span class="na">tuntap-router-firewall-out</span> <span class="o">=</span> <span class="s">deny</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">allow 192.168.0.1 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">deny 192.168.0.0/24 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">allow 0.0.0.0 192.168.0.0/24</span>
<span class="na">tuntap-router-firewall-in</span> <span class="o">=</span> <span class="s">deny</span>

<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig emperor0 192.168.0.1 netmask 255.255.255.0 up</span>
<span class="c1">; setup nat</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">iptables -t nat -F</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
<span class="c1">; enable linux ip forwarding</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">echo 1 &gt;/proc/sys/net/ipv4/ip_forward</span>
<span class="c1">; force vassals to be created in a new network namespace</span>
<span class="na">emperor-use-clone</span> <span class="o">=</span> <span class="s">net</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/vassals</span>
</pre></div>
</div>
</div>
<div class="section" id="security">
<h2>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h2>
<p>The “switching” part of the TunTap router (read: mapping ip addresses to vassals) is pretty simple: the first packet received from a vassal by the TunTap router
register the vassal for that ip address. A good approach (from a security point of view) is sending a ping packet soon after network setup in the vassal:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; create uwsgi0 tun interface and force it to connect to the Emperor exposed unix socket</span>
<span class="na">tuntap-device</span> <span class="o">=</span> <span class="s">uwsgi0 /tmp/tuntap.socket</span>
<span class="c1">; bring up loopback</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig lo up</span>
<span class="c1">; bring up interface uwsgi0</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ifconfig uwsgi0 192.168.0.2 netmask 255.255.255.0 up</span>
<span class="c1">; and set the default gateway</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">route add default gw 192.168.0.1</span>

<span class="c1">; ping something to register</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">ping -c 1 192.168.0.1</span>

<span class="c1">; classic options</span>
<span class="na">...</span>
</pre></div>
</div>
<p>after a vassal/ip pair is registered, only that combo will be valid (so other vassals will not be able to use that address until the one holding it dies)</p>
</div>
<div class="section" id="the-future">
<h2>The Future<a class="headerlink" href="#the-future" title="Permalink to this headline">¶</a></h2>
<p>This is becoming a very important part of the unbit.it networking stack. We are currently working on:</p>
<ul class="simple">
<li><p>dynamic firewall rules (luajit resulted a great tool for writing fast networking rules)</p></li>
<li><p>federation/proxy of tuntap router (the tuntaprouter can multiplex vassals networking over a tcp connection to an external tuntap router [that is why you can bind a tuntap router to a tcp address])</p></li>
<li><p>authentication of vassals (maybe the old UNIX ancillary credentials could be enough)</p></li>
<li><p>a stats server for network statistics (rx/tx/errors)</p></li>
<li><p>a bandwidth shaper based on the blastbeat project</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The TunTap Router</a><ul>
<li><a class="reference internal" href="#the-first-config">The first config</a></li>
<li><a class="reference internal" href="#the-embedded-firewall">The embedded firewall</a></li>
<li><a class="reference internal" href="#security">Security</a></li>
<li><a class="reference internal" href="#the-future">The Future</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ForkptyRouter.html"
                        title="previous chapter">The Forkpty Router</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Nagios.html"
                        title="next chapter">Monitoring uWSGI with Nagios</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/TunTapRouter.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Nagios.html" title="Monitoring uWSGI with Nagios"
             >next</a> |</li>
        <li class="right" >
          <a href="ForkptyRouter.html" title="The Forkpty Router"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>