
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Running uWSGI in a Linux CGroup &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Linux KSM in uWSGI" href="KSM.html" />
    <link rel="prev" title="Setting POSIX Capabilities" href="Capabilities.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="KSM.html" title="Using Linux KSM in uWSGI"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Capabilities.html" title="Setting POSIX Capabilities"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="running-uwsgi-in-a-linux-cgroup">
<h1>Running uWSGI in a Linux CGroup<a class="headerlink" href="#running-uwsgi-in-a-linux-cgroup" title="Permalink to this headline">¶</a></h1>
<p>Linux cgroups are an amazing feature available in recent Linux kernels. They
allow you to “jail” your processes in constrained environments with limited
CPU, memory, scheduling priority, IO, etc..</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>uWSGI has to be run as root to use cgroups. <code class="docutils literal notranslate"><span class="pre">uid</span></code> and <code class="docutils literal notranslate"><span class="pre">gid</span></code> are very, very necessary.</p>
</div>
<div class="section" id="enabling-cgroups">
<h2>Enabling cgroups<a class="headerlink" href="#enabling-cgroups" title="Permalink to this headline">¶</a></h2>
<p>First you need to enable cgroup support in your system.  Create the /cgroup
directory and add this to your /etc/fstab:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>none /cgroup cgroup cpu,cpuacct,memory
</pre></div>
</div>
<p>Then mount /cgroup and you’ll have jails with controlled CPU and memory usage.
There are other Cgroup subsystems, but CPU and memory usage are the most useful
to constrain.</p>
<p>Let’s run uWSGI in a cgroup:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi -M -p <span class="m">8</span> --cgroup /cgroup/jail001 -w simple_app -m --http :9090
</pre></div>
</div>
<p>Cgroups are simple directories. With this command your uWSGI server and its
workers are “jailed” in the ‘cgroup/jail001’ cgroup.  If you make a bunch of
requests to the server,  you will see usage counters – cpuacct.* and
memoryfiles.* in the cgroup directory growing.  You can also use pre-existing
cgroups by specifying a directory that already exists.</p>
</div>
<div class="section" id="a-real-world-example-scheduling-qos-for-your-customers">
<h2>A real world example: Scheduling QoS for your customers<a class="headerlink" href="#a-real-world-example-scheduling-qos-for-your-customers" title="Permalink to this headline">¶</a></h2>
<p>Suppose you’re hosting apps for 4 customers.  Two of them are paying you $100 a
month, one is paying $200, and the last is paying $400.  To have a good Quality
of Service implementation, the $100 apps should get 1/8, or 12.5% of your CPU
power, the $200 app should get 1/4 (25%) and the last should get 50%.  To
implement this, we have to create 4 cgroups, one for each app, and limit their
scheduling weights.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --uid <span class="m">1001</span> --gid <span class="m">1001</span> -s /tmp/app1 -w app1 --cgroup /cgroup/app1 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">125</span>
./uwsgi --uid <span class="m">1002</span> --gid <span class="m">1002</span> -s /tmp/app2 -w app1 --cgroup /cgroup/app2 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">125</span>
./uwsgi --uid <span class="m">1003</span> --gid <span class="m">1003</span> -s /tmp/app3 -w app1 --cgroup /cgroup/app3 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">250</span>
./uwsgi --uid <span class="m">1004</span> --gid <span class="m">1004</span> -s /tmp/app4 -w app1 --cgroup /cgroup/app4 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">500</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cpu.shares</span></code> values are simply computed relative to each other, so you
can use whatever scheme you like, such as (125, 125, 250, 500) or even (1, 1,
2, 4).  With CPU handled, we turn to limiting memory.  Let’s use the same
scheme as before, with a maximum of 2 GB for all apps altogether.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --uid <span class="m">1001</span> --gid <span class="m">1001</span> -s /tmp/app1 -w app1 --cgroup /cgroup/app1 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">125</span> --cgroup-opt memory.limit_in_bytes<span class="o">=</span><span class="m">268435456</span>
./uwsgi --uid <span class="m">1002</span> --gid <span class="m">1002</span> -s /tmp/app2 -w app1 --cgroup /cgroup/app2 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">125</span> --cgroup-opt memory.limit_in_bytes<span class="o">=</span><span class="m">268435456</span>
./uwsgi --uid <span class="m">1003</span> --gid <span class="m">1003</span> -s /tmp/app3 -w app1 --cgroup /cgroup/app3 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">250</span> --cgroup-opt memory.limit_in_bytes<span class="o">=</span><span class="m">536870912</span>
./uwsgi --uid <span class="m">1004</span> --gid <span class="m">1004</span> -s /tmp/app4 -w app1 --cgroup /cgroup/app4 --cgroup-opt cpu.shares<span class="o">=</span><span class="m">500</span> --cgroup-opt memory.limit_in_bytes<span class="o">=</span><span class="m">1067459584</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Running uWSGI in a Linux CGroup</a><ul>
<li><a class="reference internal" href="#enabling-cgroups">Enabling cgroups</a></li>
<li><a class="reference internal" href="#a-real-world-example-scheduling-qos-for-your-customers">A real world example: Scheduling QoS for your customers</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Capabilities.html"
                        title="previous chapter">Setting POSIX Capabilities</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="KSM.html"
                        title="next chapter">Using Linux KSM in uWSGI</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Cgroups.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="KSM.html" title="Using Linux KSM in uWSGI"
             >next</a> |</li>
        <li class="right" >
          <a href="Capabilities.html" title="Setting POSIX Capabilities"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>