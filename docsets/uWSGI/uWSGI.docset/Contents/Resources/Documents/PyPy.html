
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The PyPy plugin &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Running PHP scripts in uWSGI" href="PHP.html" />
    <link rel="prev" title="Aliasing Python modules" href="PythonModuleAlias.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="PHP.html" title="Running PHP scripts in uWSGI"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="PythonModuleAlias.html" title="Aliasing Python modules"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-pypy-plugin">
<h1>The PyPy plugin<a class="headerlink" href="#the-pypy-plugin" title="Permalink to this headline">¶</a></h1>
<p>Requires uWSGI &gt;= 2.0.9</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Idea/Design: Maciej Fijalkowski</p>
<p>Contributors: Alex Gaynor, Armin Rigo</p>
<p>A new PyPy plugin based on cffi is available since uWSGI 1.9.11. The old slow cpyext-based one has been removed from the tree.</p>
<p>The plugin is currently supported only on Linux systems. Following releases will support other platforms as well.</p>
<p>The plugin loads <code class="docutils literal notranslate"><span class="pre">libpypy-c.so</span></code> on startup, sets the home of the PyPy installation and executes a special Python module
implementing the plugin logic. So yes, most of the plugin is implemented in Python, and theoretically this approach will allow
writing uWSGI plugins directly in Python in addition to C, C++ and Objective-C.</p>
<p>As of December 2014 all of the required patches to PyPy have been merged, so you can get an official nightly build (or a stable version released after december 2014)
and use it with uWSGI.</p>
</div>
<div class="section" id="install-uwsgi-with-pypy-support">
<h2>Install uWSGI with PyPy support<a class="headerlink" href="#install-uwsgi-with-pypy-support" title="Permalink to this headline">¶</a></h2>
<p>As always with uWSGI, you have different ways to install uWSGI based on your needs.</p>
<p>If you have installed pip in your PyPy home, you can run</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pip install uwsgi
</pre></div>
</div>
<p>The uwsgi setup.py file will recognize the PyPy environment and will build a PyPy-only uWSGI binary.</p>
<p>In the same way, you can execute the setup.py supplied in uWSGI sources:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pypy setup.py install
</pre></div>
</div>
<p>(this two approaches will hardcode the pypy home in the uWSGI binary, so you will not need to set pypy-home in your options)</p>
<p>Or you can compile manually:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UWSGI_PROFILE</span><span class="o">=</span>pypy make
</pre></div>
</div>
<p>Or you can use the network installer:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl https://uwsgi.it/install <span class="p">|</span> bash -s pypy /tmp/uwsgi
</pre></div>
</div>
<p>This will build a uWSGI + PyPy binary in <code class="docutils literal notranslate"><span class="pre">/tmp/uwsgi</span></code>.</p>
<p>Or you can build PyPy support as a plugin.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --build-plugin plugins/pypy
</pre></div>
</div>
<p>or (old-style)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --plugin plugins/pypy
</pre></div>
</div>
</div>
<div class="section" id="the-pypy-home">
<h2>The PyPy home<a class="headerlink" href="#the-pypy-home" title="Permalink to this headline">¶</a></h2>
<p>The uWSGI Python plugin (more exactly the CPython plugin) works by linking in <code class="docutils literal notranslate"><span class="pre">libpython</span></code>. That means you need to rebuild the plugin for every different version of Python. The PyPy plugin is different, as libpypy-c is loaded on startup and its symbols are resolved at runtime. This allows you to migrate to a different PyPy version on the fly.</p>
<p>The “downside” of this approach is that you need to inform uWSGI where your PyPy installation is at runtime (unless you installed uwsgi via pip or with the setup.py script, in such a case the home will be found automatically)</p>
<p>Supposing your PyPy is in <code class="docutils literal notranslate"><span class="pre">/opt/pypy</span></code> you can start uWSGI with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --pypy-home /opt/pypy
</pre></div>
</div>
<p>With this command line uWSGI will search for <code class="docutils literal notranslate"><span class="pre">/opt/pypy/bin/libpypy-c.so</span></code> and if found, it will set that path as the PyPy home.</p>
<p>If your <code class="docutils literal notranslate"><span class="pre">libpypy-c.so</span></code> is outside of the PyPy home (and in a directory not reachable by the dynamic linker), you can use the <a href="#id1"><span class="problematic" id="id2">``</span></a>–pypy-lib``option.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --pypy-home /opt/pypy --pypy-lib /opt/libs/libpypy-c.so
</pre></div>
</div>
<p>With this approach you are able to use the library from a specific PyPy build and the home from another one.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember to prefix –pypy-lib with ./ if you want to point to a .so file in your current directory!</p>
</div>
</div>
<div class="section" id="the-pypy-setup-file">
<h2>The PyPy setup file<a class="headerlink" href="#the-pypy-setup-file" title="Permalink to this headline">¶</a></h2>
<p>As said before, most of the uWSGI PyPy plugin is written in Python. This code is loaded at runtime, and you can also customize it.</p>
<p>Yes, this does mean you can change the way the plugin works without rebuilding uWSGI.</p>
<p>A default version of the <code class="docutils literal notranslate"><span class="pre">pypy_setup.py</span></code> file is embedded in the uWSGI binary, and it is automatically loaded on startup.</p>
<p>If you want to change it, just pass another filename via the <code class="docutils literal notranslate"><span class="pre">--pypy-setup</span></code> option.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --pypy-home /opt/pypy --pypy-lib /opt/libs/libpypy-c.so --pypy-setup /home/foobar/foo.py
</pre></div>
</div>
<p>This Python module implements uWSGI hooks and the virtual <code class="docutils literal notranslate"><span class="pre">uwsgi</span></code> python module for accessing the uWSGI API from your apps.</p>
<p>If you want to retrieve the contents of the embedded pypy_setup.py file you can read it from the binary symbols with the <code class="docutils literal notranslate"><span class="pre">print-sym</span></code> convenience option.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --print-sym uwsgi_pypy_setup
</pre></div>
</div>
</div>
<div class="section" id="wsgi-support">
<h2>WSGI support<a class="headerlink" href="#wsgi-support" title="Permalink to this headline">¶</a></h2>
<p>The plugin implements PEP 333 and PEP 3333. You can load both WSGI modules and <code class="docutils literal notranslate"><span class="pre">mod_wsgi</span></code> style <code class="docutils literal notranslate"><span class="pre">.wsgi</span></code> files.</p>
<p>To load a WSGI module (it must be in your Python path):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --pypy-home /opt/pypy --pypy-wsgi myapp
</pre></div>
</div>
<p>To load a WSGI file:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --pypy-home /opt/pypy --pypy-wsgi-file /var/www/myapp/myapp.wsgi
</pre></div>
</div>
</div>
<div class="section" id="rpc-support">
<h2>RPC support<a class="headerlink" href="#rpc-support" title="Permalink to this headline">¶</a></h2>
<p>You can register RPC functions using the <a class="reference internal" href="PythonModule.html#uwsgi.register_rpc" title="uwsgi.register_rpc"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.register_rpc()</span></code></a> API function, like you would with the vanilla Python plugin.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World&quot;</span>

<span class="n">uwsgi</span><span class="o">.</span><span class="n">register_rpc</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">)</span>
</pre></div>
</div>
<p>To call RPC functions, both <a class="reference internal" href="PythonModule.html#uwsgi.rpc" title="uwsgi.rpc"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.rpc()</span></code></a> and <a class="reference internal" href="PythonModule.html#uwsgi.call" title="uwsgi.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.call()</span></code></a> are available.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uwsgi</span>

<span class="n">uwsgi</span><span class="o">.</span><span class="n">rpc</span><span class="p">(</span><span class="s1">&#39;192.168.173.100:3031&#39;</span><span class="p">,</span> <span class="s1">&#39;myfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;myarg&#39;</span><span class="p">)</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;myfunc&#39;</span><span class="p">,</span> <span class="s1">&#39;myarg&#39;</span><span class="p">)</span>
<span class="n">uwsgi</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;myfunc@192.168.173.100:3031&#39;</span><span class="p">,</span> <span class="s1">&#39;myarg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Integration (with local RPC) has been tested between PyPy and PyPy, PyPy and JVM, and PyPy and Lua. All of these worked flawlessly… so that means you can call Java functions from PyPy.</p>
</div>
<div class="section" id="ipython-trick">
<h2>IPython trick<a class="headerlink" href="#ipython-trick" title="Permalink to this headline">¶</a></h2>
<p>Having a runtime shell for making tests is very nice to have. You can use IPython for this.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --socket :3031 --pypy-home /opt/pypy --pypy-eval <span class="s2">&quot;import IPython; IPython.embed()&quot;</span> --honour-stdin
</pre></div>
</div>
</div>
<div class="section" id="uwsgi-api-status">
<h2>uWSGI API status<a class="headerlink" href="#uwsgi-api-status" title="Permalink to this headline">¶</a></h2>
<p>The following API functions, hooks and attributes are supported as of 20130526.</p>
<ul class="simple">
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.opt" title="uwsgi.opt"><code class="xref py py-data docutils literal notranslate"><span class="pre">uwsgi.opt</span></code></a></p></li>
<li><p><code class="xref py py-data docutils literal notranslate"><span class="pre">uwsgi.post_fork_hook</span></code></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.add_cron" title="uwsgi.add_cron"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.add_cron()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.setprocname" title="uwsgi.setprocname"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.setprocname()</span></code></a></p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.alarm()</span></code></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.signal_registered" title="uwsgi.signal_registered"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.signal_registered()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.mule_id" title="uwsgi.mule_id"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.mule_id()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.worker_id" title="uwsgi.worker_id"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.worker_id()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.masterpid" title="uwsgi.masterpid"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.masterpid()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.lock" title="uwsgi.lock"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.lock()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.unlock" title="uwsgi.unlock"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.unlock()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.add_file_monitor" title="uwsgi.add_file_monitor"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.add_file_monitor()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.add_timer" title="uwsgi.add_timer"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.add_timer()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.add_rb_timer" title="uwsgi.add_rb_timer"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.add_rb_timer()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.cache_get" title="uwsgi.cache_get"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.cache_get()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.cache_set" title="uwsgi.cache_set"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.cache_set()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.cache_update" title="uwsgi.cache_update"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.cache_update()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.cache_del" title="uwsgi.cache_del"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.cache_del()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.signal" title="uwsgi.signal"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.signal()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.call" title="uwsgi.call"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.call()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.rpc" title="uwsgi.rpc"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.rpc()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.register_rpc" title="uwsgi.register_rpc"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.register_rpc()</span></code></a></p></li>
<li><p><a class="reference internal" href="PythonModule.html#uwsgi.register_signal" title="uwsgi.register_signal"><code class="xref py py-func docutils literal notranslate"><span class="pre">uwsgi.register_signal()</span></code></a></p></li>
</ul>
</div>
<div class="section" id="options">
<h2>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-lib</span></code> - load the specified libpypy-s.so</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-setup</span></code> - load the specified pypy_setup script file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-home</span></code> - set the pypy home</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-wsgi</span></code> - load a WSGI module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-wsgi-file</span></code> - load a mod_wsgi compatible .wsgi file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-eval</span></code> - execute the specified string before <code class="docutils literal notranslate"><span class="pre">fork()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-eval-post-fork</span></code> - execute the specified string after each <code class="docutils literal notranslate"><span class="pre">fork()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-exec</span></code> - execute the specified python script before <code class="docutils literal notranslate"><span class="pre">fork()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-exec-post-fork</span></code> - execute the specified python script after each <code class="docutils literal notranslate"><span class="pre">fork()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-pp/pypy-python-path/pypy-pythonpath</span></code> - add the specified item to the pythonpath</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-paste</span></code> - load a paste.deploy .ini configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pypy-ini-paste</span></code> - load a paste.deploy .ini configuration and use its [uwsgi] section</p></li>
</ul>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Mixing libpython with libpypy-c is explicitly forbidden. A check in the pypy plugin prevents you from doing such a hellish thing.</p></li>
<li><p>The PyPy plugin is generally somewhat more “orthodox” from a Python programmer point of view, while the CPython one may be a little blasphemous in many areas. We have been able to make that choice as we do not need backward compatibility with older uWSGI releases.</p></li>
<li><p>The uWSGI API is still incomplete.</p></li>
<li><p>The WSGI loader does not update the uWSGI internal application list, so things like <code class="docutils literal notranslate"><span class="pre">--need-app</span></code> will not work. The server will report “dynamic mode” on startup even if the app has been successfully loaded. This will be fixed soon.</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The PyPy plugin</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#install-uwsgi-with-pypy-support">Install uWSGI with PyPy support</a></li>
<li><a class="reference internal" href="#the-pypy-home">The PyPy home</a></li>
<li><a class="reference internal" href="#the-pypy-setup-file">The PyPy setup file</a></li>
<li><a class="reference internal" href="#wsgi-support">WSGI support</a></li>
<li><a class="reference internal" href="#rpc-support">RPC support</a></li>
<li><a class="reference internal" href="#ipython-trick">IPython trick</a></li>
<li><a class="reference internal" href="#uwsgi-api-status">uWSGI API status</a></li>
<li><a class="reference internal" href="#options">Options</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="PythonModuleAlias.html"
                        title="previous chapter">Aliasing Python modules</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="PHP.html"
                        title="next chapter">Running PHP scripts in uWSGI</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/PyPy.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="PHP.html" title="Running PHP scripts in uWSGI"
             >next</a> |</li>
        <li class="right" >
          <a href="PythonModuleAlias.html" title="Aliasing Python modules"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>