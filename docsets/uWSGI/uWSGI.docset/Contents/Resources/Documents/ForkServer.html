
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The Fork Server (sponsored by Intellisurvey) &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-fork-server-sponsored-by-intellisurvey">
<h1>The Fork Server (sponsored by Intellisurvey)<a class="headerlink" href="#the-fork-server-sponsored-by-intellisurvey" title="Permalink to this headline">¶</a></h1>
<p>This is a really advanced (and complex) feature developed with sponsorship from Intellisurvey.com.</p>
<p>If you have dozens or even hundreds of applications built upon the same codebase you can setup your Emperor to fork vassals
from an already running one (with the application core loaded).</p>
<p>Currently the feature is supported only in the PSGI plugin, and requires Linux kernel &gt;= 3.4.</p>
<div class="section" id="how-it-works">
<h2>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>When in <cite>fork-server</cite> mode, the Emperor differentiates between two kind of vassals: base vassals and adopted vassals.</p>
<p>“base” vassals are pretty much classic vassals; generated by <cite>fork()</cite> + <cite>execve()</cite> by the Emperor.
The only difference is that they are supposed to load as much of your application code as possible as soon as possible, then suspend themselves waiting for connections on a UNIX socket.</p>
<p>A “base” vassal will be something like this</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; load myapp.pl as soon as possible</span>
<span class="na">early-psgi</span> <span class="o">=</span> <span class="s">myapp.pl</span>
<span class="c1">; suspend and execution and bind on UNIX socket /tmp/fork_server.socket</span>
<span class="na">fork-server</span> <span class="o">=</span> <span class="s">/tmp/fork_server.socket</span>
</pre></div>
</div>
<p>“Adopted” vassals are the true “new thing”.</p>
<p>Once an adopted vassal is requested, the Emperor connects to the specified fork server (instead of calling <cite>fork()</cite> + <cite>execve()</cite> itself).</p>
<p>The Emperor passes an uwsgi-serialized array of command line options of the new vassal and up to 3 file descriptors (since UNIX sockets allow passing file descriptors from one process to another).</p>
<p>Those 3 file descriptors are:</p>
<ul class="simple">
<li><p>1 -&gt; the communication pipe with the Emperor (required)</p></li>
<li><p>2 -&gt; the config pipe (optional)</p></li>
<li><p>3 -&gt; on_demand socket (optional)</p></li>
</ul>
<p>At this point, the fork server <cite>fork()</cite>s itself twice and continues the uWSGI startup using the supplied arguments array.</p>
<p>How can the Emperor <cite>wait()</cite> on an external process, then?</p>
<p>This is why a &gt;= 3.4 kernel is required, as thanks to the <cite>prctl(PR_SET_CHILD_SUBREAPER, 1)</cite> call we can tell
vassals to be re-parented to the Emperor when their parent dies (in fact the fork-server forks two times, so the vassal has no live parent, poor thing).</p>
<p>Now the Emperor has a new child and a communication pipe. And that’s all.</p>
</div>
<div class="section" id="configuring-the-emperor-for-fork-server-mode">
<h2>Configuring the Emperor for fork-server mode<a class="headerlink" href="#configuring-the-emperor-for-fork-server-mode" title="Permalink to this headline">¶</a></h2>
<p>You need only two new options: <code class="docutils literal notranslate"><span class="pre">--emperor-use-fork-serve</span> <span class="pre">&lt;addr&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">--vassal-fork-base</span> <span class="pre">&lt;name&gt;</span></code></p>
<p>Let’s start with a slow-loading (10 seconds) Perl app:</p>
<div class="highlight-pl notranslate"><div class="highlight"><pre><span></span><span class="c1"># myapp.pl</span>
<span class="k">print</span> <span class="s">&quot;I am the App\n&quot;</span><span class="p">;</span>
<span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$app</span> <span class="o">=</span> <span class="k">sub</span> <span class="p">{</span>
     <span class="k">return</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="o">=&gt;</span><span class="s">&#39;text/html&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Hello World&quot;</span><span class="p">]];</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Save it as myapp.pl and load it in perlbase.ini vassal file (this is a base vassal):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">early-psgi</span> <span class="o">=</span> <span class="s">myapp.pl</span>
<span class="na">fork-server</span> <span class="o">=</span> <span class="s">/var/run/fork_server.socket</span>
</pre></div>
</div>
<p>Now create two vassals (one.ini and two.ini) that will <cite>fork()</cite> from the base one:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; one.ini</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:8181</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">4</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">1001</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">1001</span>
</pre></div>
</div>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; two.ini</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:8282</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">8</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">1002</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">1002</span>
</pre></div>
</div>
<p>As you can see they are pretty different, even in privileges.</p>
<p>Now let’s spawn the Emperor in fork-server mode allowing perlbase.ini as a “base” vassal:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">emperor-use-fork-server</span> <span class="o">=</span> <span class="s">/var/run/fork_server.socket</span>
<span class="na">vassal-fork-base</span> <span class="o">=</span> <span class="s">perlbase.ini</span>
<span class="na">emperor-stats</span> <span class="o">=</span> <span class="s">127.0.0.1:5000</span>
</pre></div>
</div>
<p>The Emperor will start running perlbase.ini as a standard vassal, while for the non-base ones it will <cite>fork()</cite> from the base, where the app is already loaded.</p>
<p>You will note that instead waiting for 10 seconds, your new vassals will start immediately. Pretty cool, huh?</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Fork Server (sponsored by Intellisurvey)</a><ul>
<li><a class="reference internal" href="#how-it-works">How it works</a></li>
<li><a class="reference internal" href="#configuring-the-emperor-for-fork-server-mode">Configuring the Emperor for fork-server mode</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/ForkServer.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>