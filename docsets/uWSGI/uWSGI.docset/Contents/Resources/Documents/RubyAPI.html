
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Ruby API support &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Lua/WSAPI with uWSGI" href="Lua.html" />
    <link rel="prev" title="Ruby support" href="Ruby.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Lua.html" title="Using Lua/WSAPI with uWSGI"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Ruby.html" title="Ruby support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Ruby.html" accesskey="U">Ruby support</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ruby-api-support">
<h1>Ruby API support<a class="headerlink" href="#ruby-api-support" title="Permalink to this headline">¶</a></h1>
<div class="section" id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>The uWSGI API for Ruby is still incomplete (QueueFramework, SharedArea, custom routing and SNMP being the most missing players). The DSL will be extended as soon as the various API calls are ready.</p>
<p>Currently available API functions and constants (available in the UWSGI ruby module) are</p>
<ul class="simple">
<li><p>UWSGI.suspend</p></li>
<li><p>UWSGI.masterpid</p></li>
<li><p>UWSGI.async_sleep</p></li>
<li><p>UWSGI.wait_fd_read</p></li>
<li><p>UWSGI.wait_fd_write</p></li>
<li><p>UWSGI.async_connect</p></li>
<li><p>UWSGI.signal</p></li>
<li><p>UWSGI.register_signal</p></li>
<li><p>UWSGI.register_rpc</p></li>
<li><p>UWSGI.signal_registered</p></li>
<li><p>UWSGI.signal_wait</p></li>
<li><p>UWSGI.signal_received</p></li>
<li><p>UWSGI.add_cron</p></li>
<li><p>UWSGI.add_timer</p></li>
<li><p>UWSGI.add_rb_timer</p></li>
<li><p>UWSGI.add_file_monitor</p></li>
<li><p>UWSGI.cache_get</p></li>
<li><p>UWSGI.cache_get!</p></li>
<li><p>UWSGI.cache_exists</p></li>
<li><p>UWSGI.cache_exists?</p></li>
<li><p>UWSGI.cache_del</p></li>
<li><p>UWSGI.cache_set</p></li>
<li><p>UWSGI.cache_set</p></li>
<li><p>UWSGI.cache_set!</p></li>
<li><p>UWSGI.cache_update</p></li>
<li><p>UWSGI.cache_update!</p></li>
<li><p>UWSGI.setprocname</p></li>
<li><p>UWSGI.set_warning_message</p></li>
<li><p>UWSGI.lock</p></li>
<li><p>UWSGI.unlock</p></li>
<li><p>UWSGI.mem</p></li>
<li><p>UWSGI.mule_get_msg</p></li>
<li><p>UWSGI.request_id</p></li>
<li><p>UWSGI.mule_id</p></li>
<li><p>UWSGI.mule_msg</p></li>
<li><p>UWSGI.worker_id</p></li>
<li><p>UWSGI.log</p></li>
<li><p>UWSGI.logsize</p></li>
<li><p>UWSGI.i_am_the_spooler</p></li>
<li><p>UWSGI.send_to_spooler</p></li>
<li><p>UWSGI.spool</p></li>
<li><p>UWSGI::OPT</p></li>
<li><p>UWSGI::VERSION</p></li>
<li><p>UWSGI::HOSTNAME</p></li>
<li><p>UWSGI::NUMPROC</p></li>
<li><p>UWSGI::PIDFILE</p></li>
<li><p>UWSGI::SPOOL_OK</p></li>
<li><p>UWSGI::SPOOL_RETRY</p></li>
<li><p>UWSGI::SPOLL_IGNORE</p></li>
</ul>
</div>
<div class="section" id="uwsgi-dsl">
<h2>uWSGI DSL<a class="headerlink" href="#uwsgi-dsl" title="Permalink to this headline">¶</a></h2>
<p>In parallel to the uWSGI API Python decorators, a DSL for Ruby is available, allowing elegant access to the uWSGI API.</p>
<p>The module is available as <code class="file docutils literal notranslate"><span class="pre">uwsgidsl.rb</span></code> in the source distribution. You can put this code in your <code class="file docutils literal notranslate"><span class="pre">config.ru</span></code> file, or use the <code class="docutils literal notranslate"><span class="pre">rbrequire</span></code> option to auto-include it.</p>
</div>
<div class="section" id="timer-n-block">
<h2>timer(n, block)<a class="headerlink" href="#timer-n-block" title="Permalink to this headline">¶</a></h2>
<p>Execute code at regular intervals.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">timer</span> <span class="mi">30</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;30 seconds elapsed&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="rbtimer-n-block">
<h2>rbtimer(n, block)<a class="headerlink" href="#rbtimer-n-block" title="Permalink to this headline">¶</a></h2>
<p>As timer, but using a red-black tree timer.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">rbtimer</span> <span class="mi">30</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;30 seconds elapsed&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="filemon-path-block">
<h2>filemon(path, block)<a class="headerlink" href="#filemon-path-block" title="Permalink to this headline">¶</a></h2>
<p>Execute code at file modifications.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">filemon</span> <span class="s1">&#39;/tmp&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;/tmp has been modified&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="cron-hours-mins-dom-mon-dow-block">
<h2>cron(hours, mins, dom, mon, dow, block)<a class="headerlink" href="#cron-hours-mins-dom-mon-dow-block" title="Permalink to this headline">¶</a></h2>
<p>Execute a task periodically using the <span class="xref std std-doc">CronInterface</span>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">cron</span> <span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;It&#39;s time for tea.&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="signal-signum-block">
<h2>signal(signum, block)<a class="headerlink" href="#signal-signum-block" title="Permalink to this headline">¶</a></h2>
<p>Register code as a signal handler for the <span class="xref std std-doc">SignalFramework</span>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">signal</span> <span class="mi">17</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;Signal </span><span class="si">#{</span><span class="n">signum</span><span class="si">}</span><span class="s2"> was invoked.&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="postfork-block">
<h2>postfork(block)<a class="headerlink" href="#postfork-block" title="Permalink to this headline">¶</a></h2>
<p>Execute code after each <code class="docutils literal notranslate"><span class="pre">fork()</span></code>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">postfork</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s2">&quot;uWSGI server called fork()&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="rpc-name-block">
<h2>rpc(name, block)<a class="headerlink" href="#rpc-name-block" title="Permalink to this headline">¶</a></h2>
<p>Register code as a <a class="reference internal" href="RPC.html"><span class="doc">uWSGI RPC Stack</span></a> function.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">rpc</span> <span class="s1">&#39;helloworld&#39;</span> <span class="k">do</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World&quot;</span>
<span class="k">end</span>

<span class="n">rpc</span> <span class="s1">&#39;advancedhelloworld&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">|</span>
    <span class="k">return</span> <span class="s2">&quot;x = </span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">, y = </span><span class="si">#{</span><span class="n">y</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="mule-id-block">
<h2>mule(id?, block)<a class="headerlink" href="#mule-id-block" title="Permalink to this headline">¶</a></h2>
<p>Execute code as a <a class="reference internal" href="Mules.html"><span class="doc">Mule</span></a> brain.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">mule</span> <span class="mi">1</span> <span class="k">do</span> <span class="c1"># Run in mule 1</span>
  <span class="nb">puts</span> <span class="s2">&quot;I am the mule </span><span class="si">#{</span><span class="no">UWSGI</span><span class="o">.</span><span class="n">mule_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="n">mule</span> <span class="k">do</span> <span class="c1"># Run in first available mule</span>
  <span class="nb">puts</span> <span class="s2">&quot;I am the mule </span><span class="si">#{</span><span class="no">UWSGI</span><span class="o">.</span><span class="n">mule_id</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>After the function returns, the mule will be brainless. To avoid this, put the code in a loop, or use <code class="docutils literal notranslate"><span class="pre">muleloop</span></code>.</p>
</div>
<div class="section" id="muleloop-id-block">
<h2>muleloop(id?, block)<a class="headerlink" href="#muleloop-id-block" title="Permalink to this headline">¶</a></h2>
<p>Execute code in a mule in looped context.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">muleloop</span> <span class="mi">3</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="s2">&quot;I am the mule </span><span class="si">#{</span><span class="no">UWSGI</span><span class="o">.</span><span class="n">mule_id</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="spoolproc">
<h2>SpoolProc<a class="headerlink" href="#spoolproc" title="Permalink to this headline">¶</a></h2>
<p>A subclass of <code class="docutils literal notranslate"><span class="pre">Proc</span></code>, allowing you to define a task to be executed in the <a class="reference internal" href="Spooler.html"><span class="doc">Spooler</span></a>.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the function</span>
<span class="n">my_long_running_task</span> <span class="o">=</span> <span class="no">SpoolProc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">args</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;I am a task&quot;</span>
  <span class="no">UWSGI</span><span class="o">::</span><span class="no">SPOOL_OK</span>
<span class="p">}</span>

<span class="c1"># spool it</span>
<span class="n">my_long_running_task</span><span class="o">.</span><span class="n">call</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;two&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="mulefunc">
<h2>MuleFunc<a class="headerlink" href="#mulefunc" title="Permalink to this headline">¶</a></h2>
<p>Call a function from any process (such as a worker), but execute in a mule</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">i_am_a_long_running_function</span> <span class="o">=</span> <span class="no">MuleFunc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">pippo</span><span class="p">,</span> <span class="n">pluto</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;i am mule </span><span class="si">#{</span><span class="no">UWSGI</span><span class="o">.</span><span class="n">mule_id</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">pippo</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">pluto</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="n">i_am_a_long_running_function</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;serena&quot;</span><span class="p">,</span> <span class="s2">&quot;alessandro&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The worker calls <code class="docutils literal notranslate"><span class="pre">i_am_a_long_running_function()</span></code> but the function will be execute asynchronously in the first available mule.</p>
<p>If you want to run the function on a specific mule, add an ID parameter. The following would only use mule #5.</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="n">i_am_a_long_running_function</span> <span class="o">=</span> <span class="no">MuleFunc</span><span class="o">.</span><span class="n">new</span> <span class="mi">5</span> <span class="k">do</span> <span class="o">|</span><span class="n">pippo</span><span class="p">,</span><span class="n">pluto</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;i am mule </span><span class="si">#{</span><span class="no">UWSGI</span><span class="o">.</span><span class="n">mule_id</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">pippo</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">pluto</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="n">i_am_a_long_running_function</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;serena&quot;</span><span class="p">,</span> <span class="s2">&quot;alessandro&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="real-world-usage">
<h2>Real world usage<a class="headerlink" href="#real-world-usage" title="Permalink to this headline">¶</a></h2>
<p>A simple Sinatra app printing messages every 30 seconds:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is config.ru</span>

<span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;uwsgidsl&#39;</span>

<span class="n">timer</span> <span class="mi">30</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;30 seconds elapsed&quot;</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">&#39;/hi&#39;</span> <span class="k">do</span>
  <span class="s2">&quot;Hello World!&quot;</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
</pre></div>
</div>
<p>Or you can put your code in a dedicated file (<code class="file docutils literal notranslate"><span class="pre">mytasks.rb</span></code> here)</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">&#39;uwsgidsl&#39;</span>

<span class="n">timer</span> <span class="mi">30</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;30 seconds elapsed&quot;</span>
<span class="k">end</span>

<span class="n">timer</span> <span class="mi">60</span> <span class="k">do</span> <span class="o">|</span><span class="n">signum</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;60 seconds elapsed&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>and then load it with</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --socket :3031 --rack config.ru --rbrequire mytasks.rb --master --processes <span class="m">4</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Ruby API support</a><ul>
<li><a class="reference internal" href="#status">Status</a></li>
<li><a class="reference internal" href="#uwsgi-dsl">uWSGI DSL</a></li>
<li><a class="reference internal" href="#timer-n-block">timer(n, block)</a></li>
<li><a class="reference internal" href="#rbtimer-n-block">rbtimer(n, block)</a></li>
<li><a class="reference internal" href="#filemon-path-block">filemon(path, block)</a></li>
<li><a class="reference internal" href="#cron-hours-mins-dom-mon-dow-block">cron(hours, mins, dom, mon, dow, block)</a></li>
<li><a class="reference internal" href="#signal-signum-block">signal(signum, block)</a></li>
<li><a class="reference internal" href="#postfork-block">postfork(block)</a></li>
<li><a class="reference internal" href="#rpc-name-block">rpc(name, block)</a></li>
<li><a class="reference internal" href="#mule-id-block">mule(id?, block)</a></li>
<li><a class="reference internal" href="#muleloop-id-block">muleloop(id?, block)</a></li>
<li><a class="reference internal" href="#spoolproc">SpoolProc</a></li>
<li><a class="reference internal" href="#mulefunc">MuleFunc</a></li>
<li><a class="reference internal" href="#real-world-usage">Real world usage</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Ruby.html"
                        title="previous chapter">Ruby support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Lua.html"
                        title="next chapter">Using Lua/WSAPI with uWSGI</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/RubyAPI.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Lua.html" title="Using Lua/WSAPI with uWSGI"
             >next</a> |</li>
        <li class="right" >
          <a href="Ruby.html" title="Ruby support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Ruby.html" >Ruby support</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>