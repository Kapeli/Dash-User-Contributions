
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Using Lua/WSAPI with uWSGI &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="JVM in the uWSGI server (updated to 1.9)" href="JVM.html" />
    <link rel="prev" title="Ruby API support" href="RubyAPI.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="JVM.html" title="JVM in the uWSGI server (updated to 1.9)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="RubyAPI.html" title="Ruby API support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-lua-wsapi-with-uwsgi">
<h1>Using Lua/WSAPI with uWSGI<a class="headerlink" href="#using-lua-wsapi-with-uwsgi" title="Permalink to this headline">¶</a></h1>
<p>Updated for uWSGI 2.0</p>
<div class="section" id="building-the-plugin">
<h2>Building the plugin<a class="headerlink" href="#building-the-plugin" title="Permalink to this headline">¶</a></h2>
<p>The lua plugin is part of the official uWSGI distribution (official modifier 6) and it is availale in the plugins/lua directory.</p>
<p>The plugin support lua 5.1, lua 5.2 and luajit.</p>
<p>By default lua 5.1 is assumed</p>
<p>As always there are various ways to build and install Lua support:</p>
<p>from sources directory:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>make lua
</pre></div>
</div>
<p>with the installer (the resulting binary will be in /tmp/uwsgi)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl http://uwsgi.it/install <span class="p">|</span> bash -s lua /tmp/uwsgi
</pre></div>
</div>
<p>or you can build it as a plugin</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --plugin plugins/lua
</pre></div>
</div>
<p>or (if you already have a uwsgi binary)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --build-plugin plugins/lua
</pre></div>
</div>
<p>The build system (check uwsgiplugin.py in plugins/lua directory for more details) uses pkg-config to find headers and libraries.</p>
<p>You can specify the pkg-config module to use with the UWSGICONFIG_LUAPC environment variable.</p>
<p>As an example</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UWSGICONFIG_LUAPC</span><span class="o">=</span>lua5.2 make lua
</pre></div>
</div>
<p>will build a uwsgi binary for lua 5.2</p>
<p>as well as</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UWSGICONFIG_LUAPC</span><span class="o">=</span>luajit make lua
</pre></div>
</div>
<p>will build a binary with luajit</p>
<p>If you do not want to rely on the pkg-config tool you can manually specify the includes and library directories as well as the lib name with the following environment vars:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UWSGICONFIG_LUAINC</span><span class="o">=</span>&lt;directory&gt;
<span class="nv">UWSGICONFIG_LUALIBPATH</span><span class="o">=</span>&lt;directory&gt;
<span class="nv">UWSGICONFIG_LUALIB</span><span class="o">=</span>&lt;name&gt;
</pre></div>
</div>
</div>
<div class="section" id="why-lua">
<h2>Why Lua ?<a class="headerlink" href="#why-lua" title="Permalink to this headline">¶</a></h2>
<p>If you came from other object oriented languages, you may find lua for web development a strange choice.</p>
<p>Well, you have to consider one thing when exploring Lua: it is fast, really fast and consume very few resources.</p>
<p>The uWSGI plugin allows you to write web applications in lua, but another purpose (if not the main one) is using Lua to
extend the uWSGI server (and your application) using the signals framework, the rpc subsystem or the simple hooks engine.</p>
<p>If you have slow-area in your code (independently by the language used) consider rewriting them in Lua (before dealing with C)
and use uWSGI to safely call them.</p>
</div>
<div class="section" id="your-first-wsapi-application">
<h2>Your first WSAPI application<a class="headerlink" href="#your-first-wsapi-application" title="Permalink to this headline">¶</a></h2>
<p>We will use the official WSAPI example, let’s call it <code class="file docutils literal notranslate"><span class="pre">pippo.lua</span></code>:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">hello</span><span class="p">(</span><span class="n">wsapi_env</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="s2">&quot;Content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text/html&quot;</span> <span class="p">}</span>
  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">hello_text</span><span class="p">()</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Hello Wsapi!&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;PATH_INFO: &quot;</span> <span class="o">..</span> <span class="n">wsapi_env</span><span class="p">.</span><span class="n">PATH_INFO</span> <span class="o">..</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;SCRIPT_NAME: &quot;</span> <span class="o">..</span> <span class="n">wsapi_env</span><span class="p">.</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
  <span class="kr">end</span>
  <span class="kr">return</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="nb">coroutine.wrap</span><span class="p">(</span><span class="n">hello_text</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">return</span> <span class="n">hello</span>
</pre></div>
</div>
<p>Now run uWSGI with the <code class="docutils literal notranslate"><span class="pre">lua</span></code> option (remember to add <code class="docutils literal notranslate"><span class="pre">--plugins</span> <span class="pre">lua</span></code> as the
first command line option if you are using it as a plugin)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --http :8080 --http-modifier1 <span class="m">6</span> --lua pippo.lua
</pre></div>
</div>
<p>This command line starts an http router that forward requests to a single worker in which pippo.lua is loaded.</p>
<p>As you can see the modifier 6 is enforced.</p>
<p>Obviously you can directly attach uWSGI to your frontline webserver (like nginx) and bind it to a uwsgi socket:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --socket <span class="m">127</span>.0.0.1:3031 --lua pippo.lua
</pre></div>
</div>
<p>(remember to set modifier1 to 6 in your webserver of choice)</p>
</div>
<div class="section" id="concurrency">
<h2>Concurrency<a class="headerlink" href="#concurrency" title="Permalink to this headline">¶</a></h2>
<p>Basically Lua is available in all of the supported uWSGI concurrency models</p>
<p>you can go multiprocess:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --socket <span class="m">127</span>.0.0.1:3031 --lua pippo.lua --processes <span class="m">8</span> --master
</pre></div>
</div>
<p>or multithread:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --socket <span class="m">127</span>.0.0.1:3031 --lua pippo.lua --threads <span class="m">8</span> --master
</pre></div>
</div>
<p>or both</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --socket <span class="m">127</span>.0.0.1:3031 --lua pippo.lua --processes <span class="m">4</span> --threads <span class="m">8</span> --master
</pre></div>
</div>
<p>you can run it in coroutine mode (see below) using <a class="reference internal" href="uGreen.html"><span class="doc">uGreen – uWSGI Green Threads</span></a> as the suspend engine</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --socket <span class="m">127</span>.0.0.1:3031 --lua pippo.lua --async <span class="m">1000</span> --ugreen
</pre></div>
</div>
<p>Both threading and async modes will initialize a lua state each (you can see it as a whole independent lua VM)</p>
</div>
<div class="section" id="abusing-coroutines">
<h2>Abusing coroutines<a class="headerlink" href="#abusing-coroutines" title="Permalink to this headline">¶</a></h2>
<p>One of the most exciting feature of Lua are coroutines (cooperative
multithreading) support. uWSGI can benefit from this using its async engine. The
Lua plugin will initialize a <code class="docutils literal notranslate"><span class="pre">lua_State</span></code> for every async core. We will use a
CPU-bound version of our pippo.lua to test it:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="kr">function</span> <span class="nf">hello</span><span class="p">(</span><span class="n">wsapi_env</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="s2">&quot;Content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;text/html&quot;</span> <span class="p">}</span>

  <span class="kd">local</span> <span class="kr">function</span> <span class="nf">hello_text</span><span class="p">()</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;Hello Wsapi!&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;PATH_INFO: &quot;</span> <span class="o">..</span> <span class="n">wsapi_env</span><span class="p">.</span><span class="n">PATH_INFO</span> <span class="o">..</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;p&gt;SCRIPT_NAME: &quot;</span> <span class="o">..</span> <span class="n">wsapi_env</span><span class="p">.</span><span class="n">SCRIPT_NAME</span> <span class="o">..</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">)</span>
    <span class="kr">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span> <span class="kr">do</span>
        <span class="nb">coroutine.yield</span><span class="p">(</span><span class="n">i</span> <span class="o">..</span> <span class="s2">&quot;&lt;br/&gt;&quot;</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="nb">coroutine.yield</span><span class="p">(</span><span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="p">)</span>
  <span class="kr">end</span>

  <span class="kr">return</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="nb">coroutine.wrap</span><span class="p">(</span><span class="n">hello_text</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">return</span> <span class="n">hello</span>
</pre></div>
</div>
<p>and run uWSGI with 8 async cores…</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --socket :3031 --lua pippo.lua --async <span class="m">8</span>
</pre></div>
</div>
<p>And just like that, you can manage 8 concurrent requests within a single worker!</p>
<p>Lua coroutines do not work over C stacks (meaning you cannot manage them with your C code), but thanks to <a class="reference internal" href="uGreen.html"><span class="doc">uGreen – uWSGI Green Threads</span></a> (the uWSGI official coroutine/greenthread engine)
you can bypass this limit.</p>
<p>Thanks to uGreen you can use the uWSGI async API in your Lua apps and gain a very high level of concurrency.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">uwsgi</span><span class="p">.</span><span class="n">async_connect</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">wait_fd_read</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">wait_fd_write</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">is_connected</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">send</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">recv</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">close</span>
<span class="n">uwsgi</span><span class="p">.</span><span class="n">ready_fd</span>
</pre></div>
</div>
</div>
<div class="section" id="threading-example">
<h2>Threading example<a class="headerlink" href="#threading-example" title="Permalink to this headline">¶</a></h2>
<p>The Lua plugin is “thread-safe” as uWSGI maps a lua_State to each internal
pthread.  For example you can run the <a class="reference external" href="http://sputnik.freewisdom.org/">Sputnik</a> wiki engine very easily.  Use
<a class="reference external" href="http://www.luarocks.org/">LuaRocks</a> to install Sputnik and <code class="docutils literal notranslate"><span class="pre">versium-sqlite3</span></code>. A database-backed storage
is required as the default filesystem storage does not support being accessed
by multiple interpreters concurrently.  Create a wsapi compliant file:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="nb">require</span><span class="p">(</span><span class="s1">&#39;sputnik&#39;</span><span class="p">)</span>
<span class="kr">return</span> <span class="n">sputnik</span><span class="p">.</span><span class="n">wsapi_app</span><span class="p">.</span><span class="n">new</span><span class="p">{</span>
  <span class="n">VERSIUM_STORAGE_MODULE</span> <span class="o">=</span> <span class="s2">&quot;versium.sqlite3&quot;</span><span class="p">,</span>
  <span class="n">VERSIUM_PARAMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;/tmp/sputnik.db&#39;</span><span class="p">},</span>
  <span class="n">SHOW_STACK_TRACE</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
  <span class="n">TOKEN_SALT</span> <span class="o">=</span> <span class="s1">&#39;xxx&#39;</span><span class="p">,</span>
  <span class="n">BASE_URL</span>       <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And run your threaded uWSGI server</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./uwsgi --plugins lua --lua sputnik.ws --threads <span class="m">20</span> --socket :3031
</pre></div>
</div>
</div>
<div class="section" id="a-note-on-memory">
<h2>A note on memory<a class="headerlink" href="#a-note-on-memory" title="Permalink to this headline">¶</a></h2>
<p>As we all know, uWSGI is parsimonious with memory. Memory is a precious
resource. Do not trust software that does not care for your memory!  The Lua
garbage collector is automatically called (by default) after each request.</p>
<p>You can tune the frequency of the GC call with the <code class="docutils literal notranslate"><span class="pre">--lua-gc-freq</span> <span class="pre">&lt;n&gt;</span></code> option, where n
is the number of requests after the GC will be called:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">lua</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">127.0.0.1:3031</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">4</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">lua</span> <span class="o">=</span> <span class="s">foobar.lua</span>
<span class="c1">; run the gc every 10 requests</span>
<span class="na">lua-gc-freq</span> <span class="o">=</span> <span class="s">10</span>
</pre></div>
</div>
</div>
<div class="section" id="rpc-and-signals">
<h2>RPC and signals<a class="headerlink" href="#rpc-and-signals" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="the-lua-shell">
<h2>The Lua shell<a class="headerlink" href="#the-lua-shell" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="using-lua-as-configurator">
<h2>Using Lua as ‘configurator’<a class="headerlink" href="#using-lua-as-configurator" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="uwsgi-api-status">
<h2>uWSGI api status<a class="headerlink" href="#uwsgi-api-status" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using Lua/WSAPI with uWSGI</a><ul>
<li><a class="reference internal" href="#building-the-plugin">Building the plugin</a></li>
<li><a class="reference internal" href="#why-lua">Why Lua ?</a></li>
<li><a class="reference internal" href="#your-first-wsapi-application">Your first WSAPI application</a></li>
<li><a class="reference internal" href="#concurrency">Concurrency</a></li>
<li><a class="reference internal" href="#abusing-coroutines">Abusing coroutines</a></li>
<li><a class="reference internal" href="#threading-example">Threading example</a></li>
<li><a class="reference internal" href="#a-note-on-memory">A note on memory</a></li>
<li><a class="reference internal" href="#rpc-and-signals">RPC and signals</a></li>
<li><a class="reference internal" href="#the-lua-shell">The Lua shell</a></li>
<li><a class="reference internal" href="#using-lua-as-configurator">Using Lua as ‘configurator’</a></li>
<li><a class="reference internal" href="#uwsgi-api-status">uWSGI api status</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="RubyAPI.html"
                        title="previous chapter">Ruby API support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="JVM.html"
                        title="next chapter">JVM in the uWSGI server (updated to 1.9)</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Lua.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="JVM.html" title="JVM in the uWSGI server (updated to 1.9)"
             >next</a> |</li>
        <li class="right" >
          <a href="RubyAPI.html" title="Ruby API support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>