
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>uWSGI 1.9.12 &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="uWSGI 1.9.11" href="Changelog-1.9.11.html" />
    <link rel="prev" title="uWSGI 1.9.13" href="Changelog-1.9.13.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Changelog-1.9.11.html" title="uWSGI 1.9.11"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Changelog-1.9.13.html" title="uWSGI 1.9.13"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="uwsgi-1-9-12">
<h1>uWSGI 1.9.12<a class="headerlink" href="#uwsgi-1-9-12" title="Permalink to this headline">¶</a></h1>
<p>Changelog [20130605]</p>
<div class="section" id="bugfixes">
<h2>Bugfixes<a class="headerlink" href="#bugfixes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>offloading cache writes will return the correct status code and not 202</p></li>
<li><p>you can now control the path of temporary files setting the TMPDIR environment variable (this fixes an old issue for users without control over /tmp)</p></li>
<li><p>fixed a compilation error on amqp imperial monitor</p></li>
<li><p>cron commands are correctly escaped when reported in the stats server</p></li>
<li><p>fixed fastcgi parser corner-case bug with big uploads</p></li>
<li><p>fixed support for newest cygwin</p></li>
</ul>
</div>
<div class="section" id="new-features">
<h2>New Features<a class="headerlink" href="#new-features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="offloading-responses">
<h3>Offloading responses<a class="headerlink" href="#offloading-responses" title="Permalink to this headline">¶</a></h3>
<p>Take the following WSGI app:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;u&#39;</span> <span class="o">*</span> <span class="mi">100000000</span><span class="p">]</span>
</pre></div>
</div>
<p>it will generate about 100megs of data. 98% of the time the worker spent on the request was on the data transfer. As the whole response
is followed by the end of the request we can offload the data write to a thread and free the worker suddenly (so it will be able to handle a new request).</p>
<p>100megs are a huge value, but even 1MB can cause a dozen of poll()/write() syscalls that blocks your worker for a bunch of milliseconds</p>
<p>Thanks to the ‘memory offload’ facility added in 1.9.11 implementing it has been very easy.</p>
<p>The offloading happens via the <a class="reference internal" href="Transformations.html"><span class="doc">uWSGI Transformations</span></a></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">:3031</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">myapp.py</span>
<span class="c1">; offload all of the application writes</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">offload:</span>
</pre></div>
</div>
<p>By default the response is buffered to memory until it reaches 1MB size. After that it will be buffered to disk and the offload engine
will use sendfile().</p>
<p>You can set the limit (in bytes) after disk buffering passing an argument to the offload:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">:3031</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">myapp.py</span>
<span class="c1">; offload all of the application writes (buffer to disk after 1k)</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">offload:1024</span>
</pre></div>
</div>
<p>“offload” MUST BE the last transformation in the chain</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">:3031</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">myapp.py</span>
<span class="c1">; gzip the response</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">gzip:</span>
<span class="c1">; offload all of the application writes (buffer to disk after 1k)</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">offload:1024</span>
</pre></div>
</div>
</div>
<div class="section" id="jwsgi-and-jvm-improvements">
<h3>JWSGI and JVM improvements<a class="headerlink" href="#jwsgi-and-jvm-improvements" title="Permalink to this headline">¶</a></h3>
<p>The JVM plugin has been extended to support more objects helper (like ArrayList), while JWSGI can now be used as
a low-level layer to add support for more JVM-based languages.</p>
<p>JRuby integration is the first attempt of such a usage. We have just releases a JWSGI to Rack adapter allowing you tun run
Ruby/Rack apps on top of JRUBY:</p>
<p><a class="reference external" href="https://github.com/unbit/jwsgi-rack">https://github.com/unbit/jwsgi-rack</a></p>
<p>A similar approach for Jython is on work</p>
</div>
<div class="section" id="touch-signal">
<h3>–touch-signal<a class="headerlink" href="#touch-signal" title="Permalink to this headline">¶</a></h3>
<p>A new touch option has been added allowing the rise of a uwsgi signal when a file is touched:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="c1">; raise signal 17 on /tmp/foobar modifications</span>
<span class="na">touch-signal</span> <span class="o">=</span> <span class="s">/tmp/foobar 17</span>
<span class="na">...</span>
</pre></div>
</div>
</div>
<div class="section" id="the-pipe-offload-engine">
<h3>The “pipe” offload engine<a class="headerlink" href="#the-pipe-offload-engine" title="Permalink to this headline">¶</a></h3>
<p>A new offload engine allowing transfer from a socket to the client has been added.</p>
<p>it will be automatically used in the new router_memacached and router_redis plugins</p>
</div>
<div class="section" id="memcached-router-improvements">
<h3>memcached router improvements<a class="headerlink" href="#memcached-router-improvements" title="Permalink to this headline">¶</a></h3>
<p>You can now store responses in memcached (as you can already do with uWSGI caching)</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme memcachedstore:addr=127.0.0.1:11211,key=${REQUEST_URI}</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme2 memcachedstore:addr=192.168.0.1:11211,key=${REQUEST_URI}foobar</span>
<span class="na">...</span>
</pre></div>
</div>
<p>obviously you can get them too</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">memcached:addr=127.0.0.1:11211,key=${REQUEST_URI}</span>
<span class="na">...</span>
</pre></div>
</div>
<p>The memcached router is now builtin in the default profiles</p>
</div>
<div class="section" id="the-new-redis-router">
<h3>The new redis router<a class="headerlink" href="#the-new-redis-router" title="Permalink to this headline">¶</a></h3>
<p>Based on the memcached router, a redis router has been added. It works in the same way:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme redisstore:addr=127.0.0.1:6379,key=${REQUEST_URI}</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme2 redisstore:addr=192.168.0.1:6379,key=${REQUEST_URI}foobar</span>
<span class="na">...</span>
</pre></div>
</div>
<p>… and get the values</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">redis:addr=127.0.0.1:6379,key=${REQUEST_URI}</span>
<span class="na">...</span>
</pre></div>
</div>
<p>The redis router is builtin by default</p>
</div>
<div class="section" id="the-hash-router">
<h3>The “hash” router<a class="headerlink" href="#the-hash-router" title="Permalink to this headline">¶</a></h3>
<p>this special routing action allows you to hash a string and return a value from a list (indexed with the hashed key).</p>
<p>Take the following list:</p>
<p>127.0.0.1:11211</p>
<p>192.168.0.1:11222</p>
<p>192.168.0.2:22122</p>
<p>192.168.0.4:11321</p>
<p>and a string:</p>
<p>/foobar</p>
<p>we hash the string /foobar using djb33x algorithm and we apply the modulo 4 (the size of the items list) to the result.</p>
<p>We get “1”, so we will get the second items in the list (we are obviously zero-indexed).</p>
<p>Do you recognize the pattern ?</p>
<p>Yes, it is the standard way to distribute items on multiple servers (memcached clients for example uses it from ages).</p>
<p>The hash router exposes this system allowing you to distribute items in you redis/memcached servers or to make other funny things.</p>
<p>This an example usage for redis:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="c1">; hash the list of servers and return the value in the MYNODE var</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme_as/(.*) hash:items=127.0.0.1:11211;192.168.0.1:11222;192.168.0.2:22122;192.168.0.4:11321,key=$1,var=MYNODE</span>
<span class="c1">; log the result</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme_as/(.*) log:${MYNODE} is the choosen memcached server !!!</span>
<span class="c1">; use MYNODE as the server address</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme_as/(.*) memcached:addr=${MYNODE},key=$1</span>
<span class="na">...</span>
</pre></div>
</div>
<p>you can even choose the hashing algo from those supported in uWSGI</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="c1">; hash the list of servers with murmur2 and return the value in the MYNODE var</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme_as/(.*) hash:algo=murmur2,items=127.0.0.1:11211;192.168.0.1:11222;192.168.0.2:22122;192.168.0.4:11321,key=$1,var=MYNODE</span>
<span class="c1">; log the result</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme_as/(.*) log:${MYNODE} is the choosen memcached server !!!</span>
<span class="c1">; use MYNODE as the server address</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/cacheme_as/(.*) memcached:addr=${MYNODE},key=$1</span>
<span class="na">...</span>
</pre></div>
</div>
<p>the router_hash plugin is compiled-in by default</p>
</div>
</div>
<div class="section" id="availability">
<h2>Availability<a class="headerlink" href="#availability" title="Permalink to this headline">¶</a></h2>
<p>uWSGI 1.9.12 will be available starting from 20130605 at the following url</p>
<p><a class="reference external" href="https://projects.unbit.it/downloads/uwsgi-1.9.12.tar.gz">https://projects.unbit.it/downloads/uwsgi-1.9.12.tar.gz</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">uWSGI 1.9.12</a><ul>
<li><a class="reference internal" href="#bugfixes">Bugfixes</a></li>
<li><a class="reference internal" href="#new-features">New Features</a><ul>
<li><a class="reference internal" href="#offloading-responses">Offloading responses</a></li>
<li><a class="reference internal" href="#jwsgi-and-jvm-improvements">JWSGI and JVM improvements</a></li>
<li><a class="reference internal" href="#touch-signal">–touch-signal</a></li>
<li><a class="reference internal" href="#the-pipe-offload-engine">The “pipe” offload engine</a></li>
<li><a class="reference internal" href="#memcached-router-improvements">memcached router improvements</a></li>
<li><a class="reference internal" href="#the-new-redis-router">The new redis router</a></li>
<li><a class="reference internal" href="#the-hash-router">The “hash” router</a></li>
</ul>
</li>
<li><a class="reference internal" href="#availability">Availability</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Changelog-1.9.13.html"
                        title="previous chapter">uWSGI 1.9.13</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Changelog-1.9.11.html"
                        title="next chapter">uWSGI 1.9.11</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Changelog-1.9.12.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Changelog-1.9.11.html" title="uWSGI 1.9.11"
             >next</a> |</li>
        <li class="right" >
          <a href="Changelog-1.9.13.html" title="uWSGI 1.9.13"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>