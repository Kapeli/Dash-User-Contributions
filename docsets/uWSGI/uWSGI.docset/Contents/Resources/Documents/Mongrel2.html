
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Attaching uWSGI to Mongrel2 &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Nginx support" href="Nginx.html" />
    <link rel="prev" title="Lighttpd support" href="Lighttpd.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Nginx.html" title="Nginx support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Lighttpd.html" title="Lighttpd support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="attaching-uwsgi-to-mongrel2">
<h1>Attaching uWSGI to Mongrel2<a class="headerlink" href="#attaching-uwsgi-to-mongrel2" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://mongrel2.org/">Mongrel2</a> is a next-next-generation webserver that focuses on modern webapps.</p>
<p>Just like uWSGI, it is fully language agnostic, cluster-friendly and delightfully controversial :)</p>
<p>It uses the amazing <a class="reference external" href="http://www.zeromq.org/">ZeroMQ</a> library for communication, allowing reliable, easy message queueing and configuration-free scalability.</p>
<p>Starting from version 0.9.8-dev, uWSGI can be used as a Mongrel2 handler.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>To enable ZeroMQ/Mongrel2 support in uWSGI you need the zeromq library (2.1+) and the uuid library.</p>
<p>Mongrel2 can use JSON or tnetstring to pass data (such as headers and various other information) to handlers. uWSGI supports tnetstring out of the box but requires the <a class="reference external" href="http://www.digip.org/jansson/">Jansson</a> library to parse JSON data.
If you don’t install jansson or do not want to use JSON, make sure you specify <code class="docutils literal notranslate"><span class="pre">protocol='tnetstring'</span></code> in the Handler in the Mongrel2 configuration, as the default is to use JSON. This would result in a rather obscure “JSON support not enabled. Skip request” message in the uWSGI log.</p>
</div>
<div class="section" id="configuring-mongrel2">
<h2>Configuring Mongrel2<a class="headerlink" href="#configuring-mongrel2" title="Permalink to this headline">¶</a></h2>
<p>You can find <code class="docutils literal notranslate"><span class="pre">mongrel2-uwsgi.conf</span></code> shipped with the uWSGI source. You can use this file as a base to configure Mongrel2.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">main</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span>
    <span class="n">uuid</span><span class="o">=</span><span class="s2">&quot;f400bf85-4538-4f7a-8908-67e313d515c2&quot;</span><span class="p">,</span>
    <span class="n">access_log</span><span class="o">=</span><span class="s2">&quot;/logs/access.log&quot;</span><span class="p">,</span>
    <span class="n">error_log</span><span class="o">=</span><span class="s2">&quot;/logs/error.log&quot;</span><span class="p">,</span>
    <span class="n">chroot</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span>
    <span class="n">default_host</span><span class="o">=</span><span class="s2">&quot;192.168.173.11&quot;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="n">pid_file</span><span class="o">=</span><span class="s2">&quot;/run/mongrel2.pid&quot;</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">6767</span><span class="p">,</span>
    <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Host</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;192.168.173.11&quot;</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">Handler</span><span class="p">(</span><span class="n">send_spec</span><span class="o">=</span><span class="s1">&#39;tcp://192.168.173.11:9999&#39;</span><span class="p">,</span>
                    <span class="n">send_ident</span><span class="o">=</span><span class="s1">&#39;54c6755b-9628-40a4-9a2d-cc82a816345e&#39;</span><span class="p">,</span>
                    <span class="n">recv_spec</span><span class="o">=</span><span class="s1">&#39;tcp://192.168.173.11:9998&#39;</span><span class="p">,</span> <span class="n">recv_ident</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">protocol</span><span class="o">=</span><span class="s1">&#39;tnetstring&#39;</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;upload.temp_store&#39;</span><span class="p">:</span><span class="s1">&#39;tmp/mongrel2.upload.XXXXXX&#39;</span><span class="p">}</span>
<span class="n">servers</span> <span class="o">=</span> <span class="p">[</span><span class="n">main</span><span class="p">]</span>
</pre></div>
</div>
<p>It is a pretty standard Mongrel2 configuration with upload streaming enabled.</p>
</div>
<div class="section" id="configuring-uwsgi-for-mongrel2">
<h2>Configuring uWSGI for Mongrel2<a class="headerlink" href="#configuring-uwsgi-for-mongrel2" title="Permalink to this headline">¶</a></h2>
<p>To attach uWSGI to Mongrel2, simply use the <span class="xref std std-ref">OptionZeromq</span> option:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --zeromq tcp://192.168.173.11:9999,tcp://192.168.173.11:9998
</pre></div>
</div>
<p>You can spawn multiple processes (each one will subscribe to Mongrel2 with a different uuid)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --zeromq tcp://192.168.173.11:9999,tcp://192.168.173.11:9998 -p <span class="m">4</span>
</pre></div>
</div>
<p>You can use threads too. Each thread will subscribe to the Mongrel2 queue but the responder socket will be shared by all the threads and protected by a mutex.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --zeromq tcp://192.168.173.11:9999,tcp://192.168.173.11:9998 -p <span class="m">4</span> --threads <span class="m">8</span>
<span class="c1"># This will spawn 4 processes with 8 threads each, totaling 32 threads.</span>
</pre></div>
</div>
</div>
<div class="section" id="test-them-all">
<h2>Test them all<a class="headerlink" href="#test-them-all" title="Permalink to this headline">¶</a></h2>
<p>Add an application to uWSGI (we will use the werkzeug.testapp as always)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --zeromq tcp://192.168.173.11:9999,tcp://192.168.173.11:9998 -p <span class="m">4</span> --threads <span class="m">8</span> --module werkzeug.testapp:test_app
</pre></div>
</div>
<p>Now launch the command on all the servers you want, Mongrel2 will distribute requests to them automagically.</p>
</div>
<div class="section" id="async-mode">
<h2>Async mode<a class="headerlink" href="#async-mode" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Async support for ZeroMQ is still under development, as ZeroMQ uses edge triggered events that complicate things in the uWSGI async architecture.</p>
</div>
</div>
<div class="section" id="chroot">
<h2>Chroot<a class="headerlink" href="#chroot" title="Permalink to this headline">¶</a></h2>
<p>By default Mongrel2 will <code class="docutils literal notranslate"><span class="pre">chroot()</span></code>. This is a good thing for security, but can cause headaches regarding file upload streaming. Remember that Mongrel2 will save the uploaded file
in its own chroot jail, so if your uWSGI instance does not live in the same chroot jail, you’ll have to choose the paths carefully. In the example Mongrel2 configuration file we have used a relative path to easily allow uWSGI to reach the file.</p>
</div>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>Mongrel2 is extremely fast and reliable even under huge loads. tnetstring and JSON are text-based (so they are a little less effective than the binary <a class="reference internal" href="Protocol.html"><span class="doc">uwsgi protocol</span></a>. However, as Mongrel2 does not require the expensive one-connection-for-request method, you should get pretty much the same (if not higher) results compared to a (for example) <a class="reference internal" href="Nginx.html"><span class="doc">Nginx</span></a> + uWSGI approach.</p>
</div>
<div class="section" id="uwsgi-clustering-zeromq">
<h2>uWSGI clustering + ZeroMQ<a class="headerlink" href="#uwsgi-clustering-zeromq" title="Permalink to this headline">¶</a></h2>
<p>You can easily mix uWSGI <span class="xref std std-doc">clustering</span> with ZeroMQ.</p>
<p>Choose the main node and run</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --zeromq tcp://192.168.173.11:9999,tcp://192.168.173.11:9998 -p <span class="m">4</span> --threads <span class="m">8</span> --module werkzeug.testapp:test_app --cluster <span class="m">225</span>.1.1.1:1717
</pre></div>
</div>
<p>And on all the other nodes simply run</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --cluster <span class="m">225</span>.1.1.1:1717
</pre></div>
</div>
</div>
<div class="section" id="mixing-standard-sockets-with-zeromq">
<h2>Mixing standard sockets with ZeroMQ<a class="headerlink" href="#mixing-standard-sockets-with-zeromq" title="Permalink to this headline">¶</a></h2>
<p>You can add uwsgi/<a class="reference internal" href="HTTP.html"><span class="doc">HTTP</span></a>/FastCGI/… sockets to your uWSGI server in addition to ZeroMQ, but if you do, remember to disable threads! This limitation will probably be fixed in the future.</p>
</div>
<div class="section" id="logging-via-zeromq">
<h2>Logging via ZeroMQ<a class="headerlink" href="#logging-via-zeromq" title="Permalink to this headline">¶</a></h2>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><span class="xref std std-doc">ZeroMQLogging</span></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Attaching uWSGI to Mongrel2</a><ul>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#configuring-mongrel2">Configuring Mongrel2</a></li>
<li><a class="reference internal" href="#configuring-uwsgi-for-mongrel2">Configuring uWSGI for Mongrel2</a></li>
<li><a class="reference internal" href="#test-them-all">Test them all</a></li>
<li><a class="reference internal" href="#async-mode">Async mode</a></li>
<li><a class="reference internal" href="#chroot">Chroot</a></li>
<li><a class="reference internal" href="#performance">Performance</a></li>
<li><a class="reference internal" href="#uwsgi-clustering-zeromq">uWSGI clustering + ZeroMQ</a></li>
<li><a class="reference internal" href="#mixing-standard-sockets-with-zeromq">Mixing standard sockets with ZeroMQ</a></li>
<li><a class="reference internal" href="#logging-via-zeromq">Logging via ZeroMQ</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Lighttpd.html"
                        title="previous chapter">Lighttpd support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Nginx.html"
                        title="next chapter">Nginx support</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Mongrel2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Nginx.html" title="Nginx support"
             >next</a> |</li>
        <li class="right" >
          <a href="Lighttpd.html" title="Lighttpd support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>