
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The Metrics subsystem &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The Chunked input API" href="Chunked.html" />
    <link rel="prev" title="WebSocket support" href="WebSockets.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Chunked.html" title="The Chunked input API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="WebSockets.html" title="WebSocket support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-metrics-subsystem">
<h1>The Metrics subsystem<a class="headerlink" href="#the-metrics-subsystem" title="Permalink to this headline">¶</a></h1>
<p>Available from 1.9.19.</p>
<p>The uWSGI metrics subsystem allows you to manage “numbers” from your app.</p>
<p>While the caching subsystem got some math capabilities during the 1.9 development cycle, the metrics subsystem
is optimized by design for storing numbers and applying functions over them. So, compared to the caching subsystem it’s way faster
and requires a fraction of the memory.</p>
<p>When enabled, the metric subsystem configures a vast amount of metrics (like requests per-core, memory usage, etc) but, in addition to this, you can configure your own metrics,
such as the number of active users or, say, hits of a particular URL, as well as the memory consumption of your app or the whole server.</p>
<p>To enable the metrics subsystem just add <code class="docutils literal notranslate"><span class="pre">--enable-metrics</span></code> to your options, or configure a stats pusher (see below).</p>
<p>The metrics subsystem is completely thread-safe.</p>
<p>By default uWSGI creates a lot of metrics (and more are planned), so before adding your own be sure uWSGI does not already expose the one(s) you need.</p>
<div class="section" id="metric-names-and-oids">
<h2>Metric names and oids<a class="headerlink" href="#metric-names-and-oids" title="Permalink to this headline">¶</a></h2>
<p>Each metric must have a name (containing only numbers, letters, underscores, dashes and dots) and an optional <code class="docutils literal notranslate"><span class="pre">oid</span></code> (required for mapping a metric to <a class="reference internal" href="SNMP.html"><span class="doc">The embedded SNMP server</span></a>).</p>
</div>
<div class="section" id="metric-types">
<h2>Metric types<a class="headerlink" href="#metric-types" title="Permalink to this headline">¶</a></h2>
<p>Before dealing with metrics you need to understand the various types represented by each metric:</p>
<div class="section" id="counter-type-0">
<h3>COUNTER (type 0)<a class="headerlink" href="#counter-type-0" title="Permalink to this headline">¶</a></h3>
<p>This is a generally-growing up number (like the number of requests).</p>
</div>
<div class="section" id="gauge-type-1">
<h3>GAUGE (type 1)<a class="headerlink" href="#gauge-type-1" title="Permalink to this headline">¶</a></h3>
<p>This is a number that can increase or decrease dynamically (like the memory used by a worker, or CPU load).</p>
</div>
<div class="section" id="absolute-type-2">
<h3>ABSOLUTE (type 2)<a class="headerlink" href="#absolute-type-2" title="Permalink to this headline">¶</a></h3>
<p>This is an absolute number, like the memory of the whole server, or the size of the hard disk.</p>
</div>
<div class="section" id="alias-type-3">
<h3>ALIAS (type 3)<a class="headerlink" href="#alias-type-3" title="Permalink to this headline">¶</a></h3>
<p>This is a virtual metric pointing to another one . You can use it to give different names to already existing metrics.</p>
</div>
</div>
<div class="section" id="metric-collectors">
<h2>Metric collectors<a class="headerlink" href="#metric-collectors" title="Permalink to this headline">¶</a></h2>
<p>Once you define a metric type, you need to tell uWSGI how to ‘collect’ the specific metric.</p>
<p>There are various collectors available (and more can be added via plugins).</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ptr</span></code> – The value is collected from a memory pointer</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">file</span></code> – the value is collected from a file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sum</span></code> – the value is the sum of other metrics</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avg</span></code> – compute the algebraic average of the children (added in 1.9.20)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accumulator</span></code> – always add the sum of children to the final value. See below for an example.</p>
<blockquote>
<div><p>Round 1: child1 = 22, child2 = 17 -&gt; metric_value = 39
Round 2: child1 = 26, child2 = 30 -&gt; metric_value += 56</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">multiplier</span></code> - Multiply the sum of children by the specified argument (arg1n).</p>
<blockquote>
<div><p>child1 = 22, child2 = 17, arg1n = 3 -&gt; metric_value = (22+17)*3</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code> - the value is computed calling a specific function every time</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">manual</span></code> - the NULL collector. The value must be updated manually from applications using the metrics API.</p></li>
</ul>
</div>
<div class="section" id="custom-metrics">
<h2>Custom metrics<a class="headerlink" href="#custom-metrics" title="Permalink to this headline">¶</a></h2>
<p>You can define additional metrics to manage from your app.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--metric</span></code> option allows you to add more metrics.</p>
<p>It has two syntaxes: “simplified” and “keyval”.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --metric foobar
</pre></div>
</div>
<p>will create a metric ‘foobar’ with type ‘counter’, manual collector and no oid.</p>
<p>For creating advanced metrics you need the keyval way:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --http-socket :9090 --metric <span class="nv">name</span><span class="o">=</span>foobar,type<span class="o">=</span>gauge,oid<span class="o">=</span><span class="m">100</span>.100.100
</pre></div>
</div>
<p>The following keys are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> – set the metric name</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">oid</span></code> – set the metric oid</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code> – set the metric type, can be <code class="docutils literal notranslate"><span class="pre">counter</span></code>, <code class="docutils literal notranslate"><span class="pre">gauge</span></code>, <code class="docutils literal notranslate"><span class="pre">absolute</span></code>, <code class="docutils literal notranslate"><span class="pre">alias</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">initial_value</span></code> – set the metric to a specific value on startup</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">freq</span></code> – set the collection frequency in seconds (default to 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reset_after_push</span></code> – reset the metric to zero (or the configured <code class="docutils literal notranslate"><span class="pre">initial_value</span></code>) after it’s been pushed to the backend (so every <code class="docutils literal notranslate"><span class="pre">freq</span></code> seconds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">children</span></code> – maps children to the metric (see below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alias</span></code> – the metric will be a simple alias for the specified one (–metric name=foobar,alias=worker.0.requests,type=alias)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arg1</span></code> to <code class="docutils literal notranslate"><span class="pre">arg3</span></code> – string based arguments (see below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">arg1n</span></code> to <code class="docutils literal notranslate"><span class="pre">arg3n</span></code> – number based arguments (see below)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">collector</span></code> set the collector, can be <code class="docutils literal notranslate"><span class="pre">ptr</span></code>, <code class="docutils literal notranslate"><span class="pre">file</span></code>, <code class="docutils literal notranslate"><span class="pre">sum</span></code>, <code class="docutils literal notranslate"><span class="pre">func</span></code> or anything exposed by plugins. Not specifying a collector means the metric is manual (your app needs to update it).</p></li>
</ul>
<p>The ptr is currently unimplemented, while the other collector requires a bit of additional configuration:</p>
<p><code class="docutils literal notranslate"><span class="pre">collector=file</span></code> requires <code class="docutils literal notranslate"><span class="pre">arg1</span></code> for the filename and an optional <code class="docutils literal notranslate"><span class="pre">arg1n</span></code> for the so-called split value.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --metric <span class="nv">name</span><span class="o">=</span>loadavg,type<span class="o">=</span>gauge,collector<span class="o">=</span>file,arg1<span class="o">=</span>/proc/loadavg,arg1n<span class="o">=</span><span class="m">1</span>,freq<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
<p>This will add a ‘loadavg` metric, of type gauge, updated every 3 seconds with the content of <code class="docutils literal notranslate"><span class="pre">/proc/loadavg</span></code>. The content is split (using \n, \t, spaces, \r and zero as separator) and the item 1 (the returned array is zero-based) used as the return value.</p>
<p>The splitter is very powerful, making it possible to gather information from more complex files, such as <code class="docutils literal notranslate"><span class="pre">/proc/meminfo</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --metric <span class="nv">name</span><span class="o">=</span>memory,type<span class="o">=</span>gauge,collector<span class="o">=</span>file,arg1<span class="o">=</span>/proc/meminfo,arg1n<span class="o">=</span><span class="m">4</span>,freq<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
<p>Once split, <code class="docutils literal notranslate"><span class="pre">/proc/meminfo</span></code> has the MemFree value in the 4th slot.</p>
<p><code class="docutils literal notranslate"><span class="pre">collector=sum</span></code> requires the list of metrics that must be summed up. Each metric has the concept of ‘children’. The sum collector
will sum the values of all of its children:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --metric <span class="nv">name</span><span class="o">=</span>reqs,collector<span class="o">=</span>sum,children<span class="o">=</span>worker.1.requests<span class="p">;</span>worker.2.requests
</pre></div>
</div>
<p>This will sum the value of worker.1.requests and worker.2.requests every second.</p>
<p><code class="docutils literal notranslate"><span class="pre">collector=func</span></code> is a convenience collector avoiding you to write a whole plugin for adding a new collector.</p>
<p>Let’s define a C function (call the file mycollector.c or whatever you want):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int64_t</span> <span class="nf">my_collector</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">metric</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">173</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and build it as a shared library…</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gcc -shared -o mycollector.so mycollector.c
</pre></div>
</div>
<p>now run uWSGI loading the library…</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --dlopen ./mycollector.so --metric <span class="nv">name</span><span class="o">=</span>mine,collector<span class="o">=</span>func,arg1<span class="o">=</span>my_collector,freq<span class="o">=</span><span class="m">10</span>
</pre></div>
</div>
<p>this will call the C function my_collector every 10 seconds and will set the value of the metric ‘mine’ to its return value.</p>
<p>The function must returns an <code class="docutils literal notranslate"><span class="pre">int64_t</span></code> value. The argument it takes is a <code class="docutils literal notranslate"><span class="pre">uwsgi_metric</span></code> pointer. You generally do not need to parse the metric, so just casting to void will avoid headaches.</p>
</div>
<div class="section" id="the-metrics-directory">
<h2>The metrics directory<a class="headerlink" href="#the-metrics-directory" title="Permalink to this headline">¶</a></h2>
<p>UNIX sysadmins love text files. They are generally the things they have to work on most of the time. If you want to make a UNIX sysadmin happy, just give him or her some text file to play with. (Or some coffee, or whiskey maybe, depending on their tastes. But generally, text files should do just fine.)</p>
<p>The metrics subsystem can expose all of its metrics in the form of text files in a directory:</p>
<div class="highlight-uwsgi notranslate"><div class="highlight"><pre><span></span>uwsgi --metrics-dir mymetrics ...
</pre></div>
</div>
<p>The directory must exist in advance.</p>
<p>This will create a text file for each metric in the ‘mymetrics’ directory. The content of each file is the value of the metric (updated in real time).</p>
<p>Each file is mapped into the process address space, so do not worry if your virtual memory increases slightly.</p>
</div>
<div class="section" id="restoring-metrics-persistent-metrics">
<h2>Restoring metrics (persistent metrics)<a class="headerlink" href="#restoring-metrics-persistent-metrics" title="Permalink to this headline">¶</a></h2>
<p>When you restart a uWSGI instance, all of its metrics are reset.</p>
<p>This is generally the best thing to do, but if you want, you can restore the previous situation using the values stored in the metrics
directory defined before.</p>
<p>Just add the <code class="docutils literal notranslate"><span class="pre">--metrics-dir-restore</span></code> option to force the metric subsystem to read-back the values from the metric directory before
starting to collect values.</p>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>Your language plugins should expose at least the following api functions. Currently they are implemented in Perl, CPython, PyPy and Ruby</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_get(name)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_set(name,</span> <span class="pre">value)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_set_max(name,</span> <span class="pre">value)</span></code> – only set the metric <em>name</em> if the give <em>value</em> is greater than the one currently stored</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_set_min(name,</span> <span class="pre">value)</span></code> – only set the metric <em>name</em> if the give <em>value</em> is lower than the one currently stored</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">metric_set_max</span></code> and <code class="docutils literal notranslate"><span class="pre">metric_set_min</span></code> can be used to avoid having to call <code class="docutils literal notranslate"><span class="pre">metric_get</span></code> when you need a metric to be set at a maximal or minimal value. Another simple use case is to use the <code class="docutils literal notranslate"><span class="pre">avg</span></code> collector to calculate an average between some <em>max</em> and <em>min</em> set metrics.</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_inc(name[,</span> <span class="pre">delta])</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_dec(name[,</span> <span class="pre">delta])</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_mul(name[,</span> <span class="pre">delta])</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metric_div(name[,</span> <span class="pre">delta])</span></code></p></li>
<li><p>metrics (tuple/array of metric keys, should be immutable and not-callable, currently unimplemented)</p></li>
</ul>
</div>
<div class="section" id="stats-pushers">
<h2>Stats pushers<a class="headerlink" href="#stats-pushers" title="Permalink to this headline">¶</a></h2>
<p>Collected metrics can be sent to external systems for analysis or chart generation.</p>
<p>Stats pushers are plugins aimed at sending metrics to those systems.</p>
<p>There are two kinds of stats pushers at the moment: JSON and raw.</p>
<p>The JSON stats pusher send the whole JSON stats blob (the same you get from the stats server), while ‘raw’ ones send the metrics list.</p>
<p>Currently available stats pushers:</p>
<div class="section" id="rrdtool">
<h3>rrdtool<a class="headerlink" href="#rrdtool" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: raw</p></li>
<li><p>Plugin: rrdtool (builtin by default)</p></li>
<li><p>Requires (during runtime): librrd.so</p></li>
<li><p>Syntax: <code class="docutils literal notranslate"><span class="pre">--stats-push</span> <span class="pre">rrdtool:my_rrds</span> <span class="pre">...</span></code></p></li>
</ul>
<p>This will store an rrd file for each metric in the specified directory. Each rrd file has a single data source named ‘metric’.</p>
<p>Usage:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --rrdtool my_rrds ...
<span class="c1"># or</span>
uwsgi --stats-push rrdtool:my_rrds ...
</pre></div>
</div>
<p>By default the RRD files are updated every 300 seconds. You can tune this value with <code class="docutils literal notranslate"><span class="pre">--rrdtool-freq</span></code></p>
<p>The librrd.so library is detected at runtime. If you need you can specify its absolute path with <code class="docutils literal notranslate"><span class="pre">--rrdtool-lib</span></code>.</p>
</div>
<div class="section" id="statsd">
<h3>statsd<a class="headerlink" href="#statsd" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: raw</p></li>
<li><p>Plugin: stats_pusher_statsd</p></li>
<li><p>Syntax: <code class="docutils literal notranslate"><span class="pre">--stats-push</span> <span class="pre">statsd:address[,prefix]</span></code></p></li>
</ul>
<p>Push metrics to a statsd server.</p>
<p>Usage:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --stats-push statsd:127.0.0.1:8125,myinstance ...
</pre></div>
</div>
</div>
<div class="section" id="carbon">
<h3>carbon<a class="headerlink" href="#carbon" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: raw</p></li>
<li><p>Plugin: carbon (built-in by default)</p></li>
<li><p>See: <a class="reference internal" href="Carbon.html"><span class="doc">Integration with Graphite/Carbon</span></a></p></li>
</ul>
</div>
<div class="section" id="zabbix">
<h3>zabbix<a class="headerlink" href="#zabbix" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: raw</p></li>
<li><p>Plugin: zabbix</p></li>
<li><p>Syntax: <code class="docutils literal notranslate"><span class="pre">--stats-push</span> <span class="pre">zabbix:address[,prefix]</span></code></p></li>
</ul>
<p>Push metrics to a zabbix server.</p>
<p>The plugin exposes a <code class="docutils literal notranslate"><span class="pre">--zabbix-template</span></code> option that will generate a zabbix template (on stdout or in the specified file) containing all of the exposed metrics as trapper items.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On some Zabbix versions you will need to authorize the IP addresses allowed to push items.</p>
</div>
<p>Usage:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --stats-push zabbix:127.0.0.1:10051,myinstance ...
</pre></div>
</div>
</div>
<div class="section" id="mongodb">
<h3>mongodb<a class="headerlink" href="#mongodb" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: json</p></li>
<li><p>Plugin: stats_pusher_mongodb</p></li>
<li><p>Required (build time): libmongoclient.so</p></li>
<li><p>Syntax (keyval): <code class="docutils literal notranslate"><span class="pre">--stats-push</span> <span class="pre">mongodb:addr=&lt;addr&gt;,collection=&lt;db&gt;,freq=&lt;freq&gt;</span></code></p></li>
</ul>
<p>Push statistics (as JSON) the the specified MongoDB database.</p>
</div>
<div class="section" id="file">
<h3>file<a class="headerlink" href="#file" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: json</p></li>
<li><p>Plugin: stats_pusher_file</p></li>
</ul>
<p>Example plugin storing stats JSON in a file.</p>
</div>
<div class="section" id="socket">
<h3>socket<a class="headerlink" href="#socket" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Type: raw</p></li>
<li><p>Plugin: stats_pusher_socket (builtin by default)</p></li>
<li><p>Syntax: <code class="docutils literal notranslate"><span class="pre">--stats-push</span> <span class="pre">socket:address[,prefix]</span></code></p></li>
</ul>
<p>Push metrics to a UDP server with the following format: <code class="docutils literal notranslate"><span class="pre">&lt;metric&gt;</span> <span class="pre">&lt;type&gt;</span> <span class="pre">&lt;value&gt;</span></code> (&lt;type&gt; is in the numeric form previously reported).</p>
<p>Example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --stats-push socket:127.0.0.1:8125,myinstance ...
</pre></div>
</div>
</div>
</div>
<div class="section" id="alarms-thresholds">
<h2>Alarms/Thresholds<a class="headerlink" href="#alarms-thresholds" title="Permalink to this headline">¶</a></h2>
<p>You can configure one or more “thresholds” for each metric.</p>
<p>Once this limit is reached the specified alarm (see <a class="reference internal" href="AlarmSubsystem.html"><span class="doc">The uWSGI alarm subsystem (from 1.3)</span></a>) is triggered.</p>
<p>Once the alarm is delivered you may choose to reset the counter to a specific value (generally 0), or continue triggering alarms
with a specified rate.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="na">metric-alarm</span> <span class="o">=</span> <span class="s">key=worker.0.avg_response_time,value=2000,alarm=overload,rate=30</span>
<span class="na">metric-alarm</span> <span class="o">=</span> <span class="s">key=loadavg,value=3,alarm=overload,rate=120</span>
<span class="na">metric-threshold</span> <span class="o">=</span> <span class="s">key=mycounter,value=1000,reset=0</span>
<span class="na">...</span>
</pre></div>
</div>
<p>Specifying an alarm is not required. Using the threshold value to automatically reset a metric is perfectly valid.</p>
<p>Note: <code class="docutils literal notranslate"><span class="pre">--metric-threshold</span></code> and <code class="docutils literal notranslate"><span class="pre">--metric-alarm</span></code> are aliases for the same option.</p>
</div>
<div class="section" id="snmp-integration">
<h2>SNMP integration<a class="headerlink" href="#snmp-integration" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="SNMP.html"><span class="doc">The embedded SNMP server</span></a> server exposes metrics starting from the 1.3.6.1.4.1.35156.17.3 OID.</p>
<p>For example to get the value of <code class="docutils literal notranslate"><span class="pre">worker.0.requests</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>snmpget -v2c -c &lt;snmp_community&gt; &lt;snmp_addr&gt;:&lt;snmp_port&gt; <span class="m">1</span>.3.6.1.4.1.35156.17.3.0.1
</pre></div>
</div>
<p>Remember: only metrics with an associated OID can be used via SNMP.</p>
</div>
<div class="section" id="internal-routing-integration">
<h2>Internal Routing integration<a class="headerlink" href="#internal-routing-integration" title="Permalink to this headline">¶</a></h2>
<p>The ‘’router_metrics’’ plugin (builtin by default) adds a series of actions to the internal routing subsystem.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">metricinc:&lt;metric&gt;[,value]</span></code> increase the &lt;metric&gt;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metricdec:&lt;metric&gt;[,value]</span></code> decrease the &lt;metric&gt;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metricmul:&lt;metric&gt;[,value]</span></code> multiply the &lt;metric&gt;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metricdiv:&lt;metric&gt;[,value]</span></code> divide the &lt;metric&gt;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">metricset:&lt;metric&gt;,&lt;value&gt;</span></code> set &lt;metric&gt; to &lt;value&gt;</p></li>
</ul>
<p>In addition to action, a route var named “metric” is added.</p>
<p>Example:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">metric</span> <span class="o">=</span> <span class="s">mymetric</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/foo metricinc:mymetric</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">log:the value of the metric &#39;mymetric&#39; is ${metric[mymetric]}</span>
<span class="na">log-format</span> <span class="o">=</span> <span class="s">%(time) - %(metric.mymetric)</span>
</pre></div>
</div>
</div>
<div class="section" id="request-logging">
<h2>Request logging<a class="headerlink" href="#request-logging" title="Permalink to this headline">¶</a></h2>
<p>You can access metrics values from your request logging format using the %(metric.xxx) placeholder:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">log-format</span> <span class="o">=</span> <span class="s">[hello] %(time) %(metric.worker.0.requests)</span>
</pre></div>
</div>
</div>
<div class="section" id="officially-registered-metrics">
<h2>Officially Registered Metrics<a class="headerlink" href="#officially-registered-metrics" title="Permalink to this headline">¶</a></h2>
<p>This is a work in progress.</p>
<p>The best way to know which default metrics are exposed is enabling the stats server and querying it (or adding the <code class="docutils literal notranslate"><span class="pre">--metrics-dir</span></code> option).</p>
<ul class="simple">
<li><p>worker/3 (exports information about workers, example worker.1.requests [or 3.1.1] reports the number of requests served by worker 1)</p></li>
<li><p>plugin/4 (namespace for metrics automatically added by plugins, example plugins.foo.bar)</p></li>
<li><p>core/5 (namespace for general instance informations)</p></li>
<li><p>router/6 (namespace for corerouters, example router.http.active_sessions)</p></li>
<li><p>socket/7 (namespace for sockets, example socket.0.listen_queue)</p></li>
<li><p>mule/8 (namespace for mules, example mule.1.signals)</p></li>
<li><p>spooler/9 (namespace for spoolers, example spooler.1.signals)</p></li>
<li><p>system/10 (namespace for system metrics, like loadavg or free memory)</p></li>
</ul>
</div>
<div class="section" id="oid-assigment-for-plugins">
<h2>OID assigment for plugins<a class="headerlink" href="#oid-assigment-for-plugins" title="Permalink to this headline">¶</a></h2>
<p>If you want to write a plugin that will expose metrics, please add the OID namespace that you are going to use to the list below and make a pull request first.</p>
<p>This will ensure that all plugins are using unique OID namespaces.</p>
<p>Prefix all plugin metric names with plugin name to ensure no conflicts if same keys are used in multiple plugins (example plugin.myplugin.foo.bar, worker.1.plugin.myplugin.foo.bar)</p>
<blockquote>
<div><ul class="simple">
<li><p>(3|4).100.1 - cheaper_busyness</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="external-tools">
<h2>External tools<a class="headerlink" href="#external-tools" title="Permalink to this headline">¶</a></h2>
<p>Check: <a class="reference external" href="https://github.com/unbit/unbit-bars">https://github.com/unbit/unbit-bars</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The Metrics subsystem</a><ul>
<li><a class="reference internal" href="#metric-names-and-oids">Metric names and oids</a></li>
<li><a class="reference internal" href="#metric-types">Metric types</a><ul>
<li><a class="reference internal" href="#counter-type-0">COUNTER (type 0)</a></li>
<li><a class="reference internal" href="#gauge-type-1">GAUGE (type 1)</a></li>
<li><a class="reference internal" href="#absolute-type-2">ABSOLUTE (type 2)</a></li>
<li><a class="reference internal" href="#alias-type-3">ALIAS (type 3)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metric-collectors">Metric collectors</a></li>
<li><a class="reference internal" href="#custom-metrics">Custom metrics</a></li>
<li><a class="reference internal" href="#the-metrics-directory">The metrics directory</a></li>
<li><a class="reference internal" href="#restoring-metrics-persistent-metrics">Restoring metrics (persistent metrics)</a></li>
<li><a class="reference internal" href="#api">API</a></li>
<li><a class="reference internal" href="#stats-pushers">Stats pushers</a><ul>
<li><a class="reference internal" href="#rrdtool">rrdtool</a></li>
<li><a class="reference internal" href="#statsd">statsd</a></li>
<li><a class="reference internal" href="#carbon">carbon</a></li>
<li><a class="reference internal" href="#zabbix">zabbix</a></li>
<li><a class="reference internal" href="#mongodb">mongodb</a></li>
<li><a class="reference internal" href="#file">file</a></li>
<li><a class="reference internal" href="#socket">socket</a></li>
</ul>
</li>
<li><a class="reference internal" href="#alarms-thresholds">Alarms/Thresholds</a></li>
<li><a class="reference internal" href="#snmp-integration">SNMP integration</a></li>
<li><a class="reference internal" href="#internal-routing-integration">Internal Routing integration</a></li>
<li><a class="reference internal" href="#request-logging">Request logging</a></li>
<li><a class="reference internal" href="#officially-registered-metrics">Officially Registered Metrics</a></li>
<li><a class="reference internal" href="#oid-assigment-for-plugins">OID assigment for plugins</a></li>
<li><a class="reference internal" href="#external-tools">External tools</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="WebSockets.html"
                        title="previous chapter">WebSocket support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Chunked.html"
                        title="next chapter">The Chunked input API</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Metrics.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Chunked.html" title="The Chunked input API"
             >next</a> |</li>
        <li class="right" >
          <a href="WebSockets.html" title="WebSocket support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>