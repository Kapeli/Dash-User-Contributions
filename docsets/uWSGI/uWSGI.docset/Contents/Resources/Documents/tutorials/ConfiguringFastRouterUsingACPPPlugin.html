
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Configuring FastRouter using a C++ plugin &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="configuring-fastrouter-using-a-c-plugin">
<h1>Configuring FastRouter using a C++ plugin<a class="headerlink" href="#configuring-fastrouter-using-a-c-plugin" title="Permalink to this headline">¶</a></h1>
<div class="section" id="intro">
<h2>Intro<a class="headerlink" href="#intro" title="Permalink to this headline">¶</a></h2>
<p>This tutorial assumes that you are familiar with the usage and purpose of the uwsgi fastrouter and you are facing an edge-case (like “Darth Vader wearing a t-shirt with your face”) so you have to use some kind of code-driven “configuration”. The fastrouter documentation page recommends <a class="reference external" href="https://uwsgi-docs.readthedocs.io/en/latest/Fastrouter.html#way-5-fastrouter-use-code-string">the –fastrouter-use-code-string commandline argument of uwsgi</a> to solve such terribly complicated routing problems by executing your own code/logic for each request to decide which gateway to send it to. The official documentation (at the previous link) shows an example where a python script provides the routing logic and the doc states that you can use any uwsgi-supported language to configure the fastrouter (although my uwsgi-2.0.3 seems to have the code_string feature only in its python and ruby plugins if I’m right…). This tutorial shows you how to write and compile a C++ plugin that contains the routing logic for the fastrouter. This document can also serve a partial/basic C++ plugin tutorial.</p>
<p>To make things a bit more complicated I will do the development of this plugin on windows using a cygwin environment. In case of such a simple plugin this involves only 1-2 extra steps compared to building on linux, I will comment the differences. For production I’m using “original” Debian and Ubuntu distros so my examples work there for sure.</p>
</div>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A ready-made uwsgi-2.0.3 executable or uwsgi-2.0.3 sources to build from. In case of older uwsgi releases the uwsgi binary-only solution may not be an option as uwsgi doesn’t have the –build-plugin commandline argument in older releases.</p></li>
<li><p>gcc and g++ (I use version 4.8.2, and also used 4.6 in a recent project release)</p></li>
<li><p>If you are on windows you need cygwin of course</p></li>
</ul>
</div>
</div>
<div class="section" id="plugin-sources-and-build-configs">
<h1>Plugin sources and build configs<a class="headerlink" href="#plugin-sources-and-build-configs" title="Permalink to this headline">¶</a></h1>
<p>Create a directory for your plugin somewhere in your filesystem. Note that this directory doesn’t have to be inside the extracted uwsgi source directory, put it anywhere. I will refer to this directory as <code class="docutils literal notranslate"><span class="pre">$PLUGIN_DIR</span></code> in this tutorial. The plugin directory will contain the following things:</p>
<ol class="arabic simple">
<li><p>The source code of the plugin.</p></li>
<li><p>An uwsgiplugin.py file that must be located exactly in the <code class="docutils literal notranslate"><span class="pre">$PLUGIN_DIR</span></code> and its name must be exactly uwsgiplugin.py because the uwsgiconfig.py script looks after this file in this directory with this name (its hardcoded). The code in uwsgiplugin.py is executed by uwsgiconfig.py when you build your plugin, you can do fancy configuration things here (like code generation) but often this script just gives some compile flags and source file lists to uwsgiconfig.py.</p></li>
<li><p>Build ini file(s) to feed to uwsgiconfig.py when building our minimal uwsgi executable that is good almost only to run as a fastrouter. Of course you don’t need these ini files if you are working with a pre-built uwsgi binary. Note that you can put these ini files anywhere but we need the relative/absolute path of these files when building uwsgi. I put them into the <code class="docutils literal notranslate"><span class="pre">$PLUGIN_DIR</span></code> just because… After building uwsgi we will use it to build and load our plugin that provides the routing logic of our fastrouter. On cygwin we have 2 ini files because we need an extra ini file to build libuwsgi.a (that isn’t needed in case of linux builds).</p></li>
</ol>
<p>Here is the structure and contents of my <code class="docutils literal notranslate"><span class="pre">$PLUGIN_DIR</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$PLUGIN_DIR
    my_router_config.cc
    uwsgiplugin.py
    my_uwsgi.ini
    my_uwsgi_lib.ini (needed only on cygwin)
</pre></div>
</div>
<p><em>my_router_config.cc:</em> The extension is .cc because uwsgiconfig.py doesn’t recognise the .cpp extension. In case of .cpp ext (and other unhandled extensions) uwsgiconfig.py appends an additional (default) .c extension and tries to compile the source as C (but it fails as it doesn’t find the my_router_config.cc.c source file).</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;uwsgi.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">SOptions</span>
<span class="p">{</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">config_file</span><span class="p">;</span>
<span class="p">}</span> <span class="n">options</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">uwsgi_option</span> <span class="n">options_cfg</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="s">&quot;my-router-cfg-file&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="s">&quot;config file for my fastrouter logic&quot;</span><span class="p">,</span> <span class="n">uwsgi_opt_set_str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">Deinit</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;+++++ %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
    <span class="c1">// TODO: Put your cleanup code here.</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Init</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;+++++ %s config_file=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;The --my-router-cfg-file commandline argument is mandatory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">FILE</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;Error opening config file: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">config_file</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// TODO: parse options</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="c1">// TODO: init you plugin</span>
    <span class="n">atexit</span><span class="p">(</span><span class="n">Deinit</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">UWSGI_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span><span class="o">*</span> <span class="nf">CodeString</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;+++++ %s id=%s code=%s function=%s key=%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="c1">// TODO: Return a pointer to the gateway address string.</span>
    <span class="c1">// The pointer must be valid until the next call to this function.</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1:8001&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">Request</span><span class="p">(</span><span class="k">struct</span> <span class="n">wsgi_request</span> <span class="o">*</span><span class="n">wsgi_req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// This dummy function should never be called in the fastrouter...</span>
    <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;+++++ %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nl">SPluginConfig</span> <span class="p">:</span> <span class="k">public</span> <span class="n">uwsgi_plugin</span>
<span class="p">{</span>
    <span class="n">SPluginConfig</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;my_router_config&quot;</span><span class="p">;</span>
        <span class="n">modifier1</span> <span class="o">=</span> <span class="mi">251</span><span class="p">;</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">Init</span><span class="p">;</span>
        <span class="n">code_string</span> <span class="o">=</span> <span class="n">CodeString</span><span class="p">;</span>
        <span class="c1">// Plugins with a request function pointer are &quot;request handler plugins&quot; while</span>
        <span class="c1">// the rest of the plugins are &quot;generic plugins&quot;. We install a dummy request</span>
        <span class="c1">// handler function just to force uwsgi to put this plugin into the request</span>
        <span class="c1">// handler plugin table because the --fastrouter-use-code-string commandline</span>
        <span class="c1">// argument that we exploit searches among the request handler plugins.</span>
        <span class="c1">// Again, this request handler function is just a dummy function that should</span>
        <span class="c1">// never be called in the fastrouter...</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">;</span>
        <span class="c1">// Optional, set this only if you want commandline arguments from uwsgi.</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options_cfg</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Note that the name of this exported symbol must be the name of your plugin</span>
<span class="c1">// postfixed with &quot;_plugin&quot; otherwise it doesn&#39;t work. If you build this</span>
<span class="c1">// as an external plugin then the name of the shared object must also be</span>
<span class="c1">// the same (with .so extension) but when you load the external plugin with</span>
<span class="c1">// uwsgi you have to specify only the name of the plugin without the &quot;_plugin&quot;</span>
<span class="c1">// postfix for the --plugin commandline parameter.</span>
<span class="c1">//</span>
<span class="c1">// - plugin name: &quot;my_router_config&quot;</span>
<span class="c1">// - name of the exported symbol that points to the plugin config: &quot;my_router_config_plugin&quot;</span>
<span class="c1">// - name of the shared object file in case of external plugin: &quot;my_router_config_plugin.so&quot;</span>
<span class="c1">// - uwsgi cmdline parameter when loading the external plugin: --plugin my_router_config</span>
<span class="n">SPluginConfig</span> <span class="n">my_router_config_plugin</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">visibility</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">)));</span>
</pre></div>
</div>
<p><em>uwsgiplugin.py:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span><span class="o">=</span><span class="s1">&#39;my_router_config&#39;</span>

<span class="n">CFLAGS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">LDFLAGS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">LIBS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-lstdc++&#39;</span><span class="p">]</span>
<span class="n">GCC_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;my_router_config.cc&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p><em>my_uwsgi.ini:</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">uwsgi</span><span class="p">]</span>
<span class="n">inherit</span> <span class="o">=</span> <span class="n">minimal</span>
<span class="n">main_plugin</span> <span class="o">=</span> <span class="n">corerouter</span><span class="p">,</span> <span class="n">fastrouter</span>
</pre></div>
</div>
<p><em>my_uwsgi_lib.ini:</em> (needed only on cygwin)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">uwsgi</span><span class="p">]</span>
<span class="n">inherit</span> <span class="o">=</span> <span class="n">minimal</span>
<span class="n">main_plugin</span> <span class="o">=</span> <span class="n">corerouter</span><span class="p">,</span> <span class="n">fastrouter</span>
<span class="n">as_shared_library</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>The my_uwsgi_lib.ini file is needed only on cygwin and it is a copy of my_uwsgi.ini with an extra line appended: <code class="docutils literal notranslate"><span class="pre">as_shared_library</span> <span class="pre">=</span> <span class="pre">true</span></code>. You need neither my_uwsgi.ini nor my_uwsgi_lib.ini if you are working with a pre-built new uwsgi binary that supports the –build-plugin commandline parameter but only uwsgi version ~2 and newer have it.</p>
<div class="section" id="building-uwsgi-or-uwsgi-exe-and-libuwsgi-a-on-cygwin">
<h2>Building uwsgi (or uwsgi.exe and libuwsgi.a on cygwin)<a class="headerlink" href="#building-uwsgi-or-uwsgi-exe-and-libuwsgi-a-on-cygwin" title="Permalink to this headline">¶</a></h2>
<p>Of course you can skip this step if you are working with a new uwsgi binary. Otherwise download the uwsgi source (uwsgi-2.0.3.tar.gz in my case) and extract it, then enter the extracted source folder.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~$ wget https://projects.unbit.it/downloads/uwsgi-2.0.3.tar.gz
~$ tar xvf uwsgi-2.0.3.tar.gz
~$ <span class="nb">cd</span> uwsgi-2.0.3
~/uwsgi-2.0.3$
</pre></div>
</div>
<p>The “build system” of uwsgi is a python script called uwsgiconfig.py and when you run it your shell’s current directory must be the extracted uwsgi source dir (where the uwsgiconfig.py is located). From now all commands will be executed in this source directory.</p>
<p>It is possible to build uwsgi with different configurations and its plugins can be built as either embedded plugins or external shared objects. Building external plugins for newer uwsgi releases can be done anytime and you need only an uwsgi binary and the compilers, there is no need for the uwsgi sources. (On cygwin you also need a libuwsgi.a lib file that can be built with a trick). On cygwin we first build libuwsgi.a but on linux you simply skip this step. Then we have to build the uwsgi binary (uwsgi on linux, uwsgi.exe on cygwin).</p>
<p>The uwsgiconfig.py script builds uwsgi on multiple threads. For some reason on my cygwin this multithreaded building fails (terminates without any error messages) and I worked this around by setting the CPUCOUNT env var to 1. You may, or may not need this workaround on cygwin… On linux multithreading build works fine. Now let’s build the cygwin specific libuwsgi.a library:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/uwsgi-2.0.3$ <span class="nb">export</span> <span class="nv">CPUCOUNT</span><span class="o">=</span><span class="m">1</span>
~/uwsgi-2.0.3$ python uwsgiconfig.py --build <span class="nv">$PLUGIN_DIR</span>/my_uwsgi_lib.ini
~/uwsgi-2.0.3$ mv uwsgi.exe libuwsgi.a
</pre></div>
</div>
<p>Note that these steps are needed only on cygwin. Now let’s build uwsgi:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/uwsgi-2.0.3$ python uwsgiconfig.py --build <span class="nv">$PLUGIN_DIR</span>/my_uwsgi.ini
</pre></div>
</div>
<p>The above command produces uwsgi on linux and uwsgi.exe on cygwin. We have used custom ini files to build a minimal uwsgi that serves only as a fastrouter that loads our fastrouter logic plugin. The use of this ini file results in an uwsgi that doesn’t have dependencies on libs like ssl, pcre and it includes only the bare minimum set of uwsgi plugins needed for the fastrouter. From now you don’t need the uwsgi sources (you can even delete them if you want). The only things we have to keep is the uwsgi binary (and libuwsgi.a on cygwin) because building an external uwsgi plugin can be done by running uwsgi with the –build-plugin parameter and the uwsgi binary has an embedded copies of the uwsgiconfig.py and uwsgi.h files needed for a plugin build.</p>
</div>
<div class="section" id="building-our-plugin">
<h2>Building our plugin:<a class="headerlink" href="#building-our-plugin" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/uwsgi-2.0.3$ ./uwsgi --build-plugin <span class="nv">$PLUGIN_DIR</span>
</pre></div>
</div>
<p>Now if you are lucky you have both the uwsgi binary and the my_router_config_plugin.so plugin in the current directory. Building the plugin by executing the uwsgi binary is very useful because this way it automatically uses the same uwsgiconfig.py and uwsgi.h files and the same CFLAGS that were used to build the uwsgi binary itself. Unfortunately older uwsgi releases don’t have the –build-plugin commandline parameter and in that case you have to build the plugin with the uwsgiconfig.py script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/uwsgi-2.0.3$ python uwsgiconfig.py --plugin <span class="nv">$PLUGIN_DIR</span>
</pre></div>
</div>
<p>If you have a newer uwsgi that supports the –build-plugin option then I recommend using that to build your plugin.</p>
</div>
<div class="section" id="using-the-newly-built-uwsgi-and-the-plugin-as-a-fastrouter">
<h2>Using the newly built uwsgi and the plugin as a fastrouter<a class="headerlink" href="#using-the-newly-built-uwsgi-and-the-plugin-as-a-fastrouter" title="Permalink to this headline">¶</a></h2>
<p>I assume that you more or less know about the usage/purpose of uwsgi fastrouter so I only show you how to start and parametrize uwsgi with our newly built plugin:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~/uwsgi-2.0.3$ ./uwsgi --master --fastrouter <span class="m">127</span>.0.0.1:9000 --fastrouter-use-code-string <span class="m">251</span>:: --plugin my_router_config --my-router-cfg-file my_config.cfg
</pre></div>
</div>
<p>The above command starts the fastrouter that listens on loopback 9000 for incoming requests and the –fastrouter-use-code-string commandline parameter instructs the fastrouter to ask plugin modifer=251 (our plugin) for the target gateway for each incoming request. I think the –plugin and –my-router-cfg-file commandline arguments speak for themselves…</p>
<p>The extra argument of the –fastrouter-use-code-string is “251::”. This is basically 3 strings separated by two ‘:’ characters but our plugin doesn’t need (ignores) the second and third string so I provided there empty strings. If you take a look at the linked Darth Vader example it solves the problem using the python plugin that actually utilizes these strings: <a class="reference external" href="https://uwsgi-docs.readthedocs.io/en/latest/Fastrouter.html#way-5-fastrouter-use-code-string">the –fastrouter-use-code-string commandline argument of uwsgi</a></p>
<p>Note that I’ve chosen 251 as the modifier of my plugin because based on my research modifier 1 has a lot to do with <a class="reference external" href="https://uwsgi-docs.readthedocs.io/en/latest/Protocol.html">The uwsgi Protocol</a> and moreover if you take a look at the plugins/example or plugins/cplusplus example plugins in the uwsgi source dir then you will see that those are using modifier1=250 and 251 seems to be a free id. Note that I’ve also tried 0 as the modifier1 that is the default modifier1 used by uwsgi and its very first plugin: the python plugin. This seems to work and it seems that this registers our plugin with modifier1=0 by “overriding the python plugin” but I wanted to be polite so I’ve chosen modifier=251.</p>
</div>
</div>
<div class="section" id="programming-the-routing-logic-in-our-plugin">
<h1>Programming the routing logic in our plugin<a class="headerlink" href="#programming-the-routing-logic-in-our-plugin" title="Permalink to this headline">¶</a></h1>
<p>We started the fastrouter with the “–fastrouter 127.0.0.1:9000 –fastrouter-use-code-string 251::” commandline arguments so it will be listening on loopback port 9000 for incoming requests and it will ask plugin modifier1=251 (our plugin) for the route for each request. I will use nginx to bomb requests on port 9000 of the fastrouter. Here is the location block from my nginx config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>location /test {
    include         uwsgi_params;
    uwsgi_pass      127.0.0.1:9000;
    uwsgi_param     UWSGI_FASTROUTER_KEY    $request_uri;
}
</pre></div>
</div>
<p>So nginx will route all requests coming to url path /test to the fastrouter by setting UWSGI_FASTROUTER_KEY (basically a “cgi variable”) to a user defined string. UWSGI_FASTROUTER_KEY can be anything, you have put something into it that you can use in your plugin to decide where (which gateway) to send the request. In this case I’ve decided to send the $request_uri to my plugin but you can really put there anything you want. If you don’t specify the UWSGI_FASTROUTER_KEY in the nginx config then the fastrouter will use something else instead of it as the fastrouter key (but I think specifying the UWSGI_FASTROUTER_KEY is highly recommended), more on that in the <a class="reference external" href="https://uwsgi-docs.readthedocs.io/en/latest/Fastrouter.html#notes">Notes section of the fastrouter docs</a>.</p>
<p>With the above fastrouter + nginx config when the fastrouter receives a request from nginx it calls the <code class="docutils literal notranslate"><span class="pre">CodeString()</span></code> function of our plugin to ask for the gateway address to use for that request.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span> <span class="nf">CodeString</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">code</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">keylen</span><span class="p">);</span>
</pre></div>
</div>
<p>When the fastrouter calls your <code class="docutils literal notranslate"><span class="pre">CodeString()</span></code> function the values of the function parameters are the following:</p>
<ul class="simple">
<li><p>id: “uwsgi_fastrouter”</p></li>
<li><p>code, function: We used the –fastrouter-use-code-string commandline parameter to pass 3 strings to uwsgi: “251”, “”, and “” with the “251::” argument. The code and function parameters are set to the second and third (empty) strings. You can of course specify something else instead of “251::” to pass something else as the code and function parameters.</p></li>
<li><p>key, keylen: Here you receive the value of the UWSGI_FASTROUTER_KEY you specify in nginx. This is basically the useful stuff on which you can base your routing decisions.</p></li>
</ul>
<p>The function must return with a pointer to a string that contains the gateway address, for example: “127.0.0.1:8001”. On that gateway there must be another uwsgi instance listening on an uwsgi protocolled socket. The pointed string must be valid until the next call to the <code class="docutils literal notranslate"><span class="pre">CodeString</span></code> function. This is usually critical only if you are using extra threads in your plugin because otherwise the fastrouter itself is single threaded async stuff.</p>
</div>
<div class="section" id="victory">
<h1>Victory!!!<a class="headerlink" href="#victory" title="Permalink to this headline">¶</a></h1>
<p>We have reached the end of the tutorial. Now you know how to handle in C/C++ a complex routing problem where Darth Vader wears a t-shirt with your face and you have also learnt how to build a C++ plugin using the uwsgi build system.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Configuring FastRouter using a C++ plugin</a><ul>
<li><a class="reference internal" href="#intro">Intro</a></li>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plugin-sources-and-build-configs">Plugin sources and build configs</a><ul>
<li><a class="reference internal" href="#building-uwsgi-or-uwsgi-exe-and-libuwsgi-a-on-cygwin">Building uwsgi (or uwsgi.exe and libuwsgi.a on cygwin)</a></li>
<li><a class="reference internal" href="#building-our-plugin">Building our plugin:</a></li>
<li><a class="reference internal" href="#using-the-newly-built-uwsgi-and-the-plugin-as-a-fastrouter">Using the newly built uwsgi and the plugin as a fastrouter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#programming-the-routing-logic-in-our-plugin">Programming the routing logic in our plugin</a></li>
<li><a class="reference internal" href="#victory">Victory!!!</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/ConfiguringFastRouterUsingACPPPlugin.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>