
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Setting up Graphite on Ubuntu using the Metrics subsystem &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Serializing accept(), AKA Thundering Herd, AKA the Zeeg Problem" href="../articles/SerializingAccept.html" />
    <link rel="prev" title="Build a dynamic proxy using RPC and internal routing" href="DynamicProxying.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../articles/SerializingAccept.html" title="Serializing accept(), AKA Thundering Herd, AKA the Zeeg Problem"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DynamicProxying.html" title="Build a dynamic proxy using RPC and internal routing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="setting-up-graphite-on-ubuntu-using-the-metrics-subsystem">
<h1>Setting up Graphite on Ubuntu using the Metrics subsystem<a class="headerlink" href="#setting-up-graphite-on-ubuntu-using-the-metrics-subsystem" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will guide you in installing a multi-app server, with each application sending metrics to a central graphite/carbon server.</p>
<p>Graphite is available here: <a class="reference external" href="http://graphite.wikidot.com/">http://graphite.wikidot.com/</a></p>
<p>The uWSGI Metrics subsystem is documented here <a class="reference internal" href="../Metrics.html"><span class="doc">The Metrics subsystem</span></a></p>
<p>The tutorial assumes an Ubuntu Saucy (13.10) release on amd64</p>
<p>While for Graphite we will use Ubuntu official packages, uWSGI core and plugins will be downloaded and installed from official sources</p>
<div class="section" id="installing-graphite-and-the-others-needed-packages">
<h2>Installing Graphite and the others needed packages<a class="headerlink" href="#installing-graphite-and-the-others-needed-packages" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get install python-dev ruby-dev bundler build-essential libpcre3-dev graphite-carbon graphite-web
</pre></div>
</div>
<p>python-dev and ruby-dev are required as we want to support both WSGI and Rack apps.</p>
<p>pcre development headers allow you to build uWSGI with internal routing support (something you always want)</p>
</div>
<div class="section" id="initializing-graphite">
<h2>Initializing Graphite<a class="headerlink" href="#initializing-graphite" title="Permalink to this headline">¶</a></h2>
<p>The first step will be enabling th Carbon server.</p>
<p>The Graphite project is composed by three subsystems: whisper, carbon and the web frontend</p>
<p>Whisper is a data storage format (similar to rrdtool)</p>
<p>Carbon is the server gathering metrics and storing them in whisper files (well it does more, but this is its main purpose)</p>
<p>The web frontend visualize the charts/graphs built from the data gathered by the carbon server.</p>
<p>To enable the carbon server edit <code class="docutils literal notranslate"><span class="pre">/etc/default/graphite-carbon</span></code> and set CARBON_CACHE_ENABLED to true</p>
<p>Before starting the carbon server we need to build its search index.</p>
<p>Just run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo /usr/bin/graphite-build-search-index
</pre></div>
</div>
<p>Then start the carbon server (at the next reboot it will be automatically started)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo /etc/init.d/carbon-cache start
</pre></div>
</div>
</div>
<div class="section" id="building-and-installing-uwsgi">
<h2>Building and Installing uWSGI<a class="headerlink" href="#building-and-installing-uwsgi" title="Permalink to this headline">¶</a></h2>
<p>Download latest stable uWSGI tarball</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>wget https://projects.unbit.it/downloads/uwsgi-latest.tar.gz
</pre></div>
</div>
<p>explode it, and from the created directory run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --build core
</pre></div>
</div>
<p>this will build the uWSGI “core” binary.</p>
<p>We now want to build the python, rack and carbon plugins:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --plugin plugins/python core
python uwsgiconfig.py --plugin plugins/rack core
python uwsgiconfig.py --plugin plugins/carbon core
</pre></div>
</div>
<p>now we have <code class="docutils literal notranslate"><span class="pre">uwsgi</span></code>, <code class="docutils literal notranslate"><span class="pre">python_plugin.so</span></code>, <code class="docutils literal notranslate"><span class="pre">rack_plugin.so</span></code> and <code class="docutils literal notranslate"><span class="pre">carbon_plugin.so</span></code></p>
<p>let’s copy it to system directories:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo mkdir /etc/uwsgi
sudo mkdir /usr/lib/uwsgi
sudo cp uwsgi /usr/bin/uwsgi
sudo cp python_plugin.so /usr/lib/uwsgi
sudo cp rack_plugin.so /usr/lib/uwsgi
sudo cp carbon_plugin.so /usr/lib/uwsgi
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-uwsgi-emperor">
<h2>Setting up the uWSGI Emperor<a class="headerlink" href="#setting-up-the-uwsgi-emperor" title="Permalink to this headline">¶</a></h2>
<p>Create an upstart config file for starting <a class="reference internal" href="../Emperor.html"><span class="doc">The uWSGI Emperor – multi-app deployment</span></a></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Emperor uWSGI script</span>

description <span class="s2">&quot;uWSGI Emperor&quot;</span>
start on runlevel <span class="o">[</span><span class="m">2345</span><span class="o">]</span>
stop on runlevel <span class="o">[</span><span class="m">06</span><span class="o">]</span>

<span class="nb">exec</span> /usr/bin/uwsgi --emperor /etc/uwsgi
</pre></div>
</div>
<p>save it as <code class="docutils literal notranslate"><span class="pre">/etc/init/emperor.conf</span></code> and start the Emperor:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>start emperor
</pre></div>
</div>
<p>From now on, to start uWSGI instances just drop their config files into /etc/uwsgi</p>
</div>
<div class="section" id="spawning-the-graphite-web-interface">
<h2>Spawning the Graphite web interface<a class="headerlink" href="#spawning-the-graphite-web-interface" title="Permalink to this headline">¶</a></h2>
<p>Before starting the graphite web interface (that is a Django app) we need to initialize its database.</p>
<p>Just run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo graphite-manage syncdb
</pre></div>
</div>
<p>this is the standard django syncdb command for manage.py. Just answer the questions to create an admin user.</p>
<p>Now we are ready to create a uWSGI vassal:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugins-dir</span> <span class="o">=</span> <span class="s">/usr/lib/uwsgi</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">python</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">_graphite</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">_graphite</span>
<span class="na">wsgi-file</span> <span class="o">=</span> <span class="s">/usr/share/graphite-web/graphite.wsgi</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:8080</span>
</pre></div>
</div>
<p>Save it as <code class="docutils literal notranslate"><span class="pre">/etc/uwsgi/graphite.ini</span></code></p>
<p>the _graphite user (and group) is created by the graphite ubuntu package. Our uWSGI vassal will run under this privileges.</p>
<p>The web interface will be available on the port 8080 of your server natively speaking HTTP. If you prefer to proxy it,
just change <code class="docutils literal notranslate"><span class="pre">http-socket</span></code> to <code class="docutils literal notranslate"><span class="pre">http</span></code> or place it behind a full webserver like nginx (this step is not covered in this tutorial)</p>
</div>
<div class="section" id="spawning-vassals-sending-metrics-to-graphite">
<h2>Spawning vassals sending metrics to Graphite<a class="headerlink" href="#spawning-vassals-sending-metrics-to-graphite" title="Permalink to this headline">¶</a></h2>
<p>We are now ready to send applications metrics to the carbon/graphite server.</p>
<p>For every vassal file in /etc/uwsgi just be sure to add the following options:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">...</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">carbon</span>
<span class="na">enable-metrics</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">carbon-use-metrics</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">carbon-id</span> <span class="o">=</span> <span class="s">%n</span>
<span class="na">carbon</span> <span class="o">=</span> <span class="s">127.0.0.1:2003</span>
<span class="na">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">carbon-id</span></code> set a meaningful prefix to each metric (%n automatically translates to the name without extension of the vassal file).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">carbon</span></code> option set the address of the carbon server to send metrics to (by default the carbon server binds on port 2003, but you can change it editing
<code class="docutils literal notranslate"><span class="pre">/etc/carbon/carbon.conf</span></code> and restarting the carbon server)</p>
</div>
<div class="section" id="using-graphiti-ruby-sinatra-based-as-alternative-frontend">
<h2>Using Graphiti (Ruby/Sinatra based) as alternative frontend<a class="headerlink" href="#using-graphiti-ruby-sinatra-based-as-alternative-frontend" title="Permalink to this headline">¶</a></h2>
<p>Graphiti is an alternative dashboard/frontend from Graphite writte in Sinatra (a Ruby/Rack framework).</p>
<p>Graphiti requires redis, so be sure a redis server is running in your system.</p>
<p>Running:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo apt-get install redis-server
</pre></div>
</div>
<p>will be enough</p>
<p>First step is cloning the graphiti app (place it where you want/need):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/paperlesspost/graphiti.git
</pre></div>
</div>
<p>then run the bundler tool (if you are not confident with the ruby world it is a tool for managing dependencies)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bundle install
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>if the eventmachine gem installation fails, add “gem ‘eventmachine’” in the Gemfile as the first gem and run bundle update. This will ensure latest eventmachine version will be installed</p>
</div>
<p>After bundle has installed all of the gems, you have to copy the graphiti example configuration:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cp config/settings.yml.example config/settings.yml
</pre></div>
</div>
<p>edit it and set graphite_base_url to the url where the graphite web interface (the django one) is running.</p>
<p>Now we can deploy it on uWSGI</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugins-dir</span> <span class="o">=</span> <span class="s">/usr/lib/uwsgi</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">rack</span>
<span class="na">chdir</span> <span class="o">=</span> <span class="s">&lt;path_to_graphiti&gt;</span>
<span class="na">rack</span> <span class="o">=</span> <span class="s">config.ru</span>
<span class="na">rbrequire</span> <span class="o">=</span> <span class="s">bundler/setup</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9191</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">_graphite</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">_graphite</span>
</pre></div>
</div>
<p>save it as <code class="docutils literal notranslate"><span class="pre">/etc/uwsgi/graphiti.ini</span></code> to let the Emperor deploy it</p>
<p>You can now connect to port 9191 to manage your gathered metrics.</p>
<p>As always you are free to place the instance under a proxy.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>By default the carbon server listens on a public address. Unless you know what you are doing you should point it to a local one (like 127.0.0.1)</p>
<p>uWSGI exports a gazillion of metrics (and more are planned), do not be afraid to use them</p>
<p>There is no security between apps and the carbon server, any apps can write metrics to it. If you are hosting untrusted apps you’d better to use other approcahes (like giving a graphite instance to every user in the system)</p>
<p>The same is true for redis, if you run untrusted apps a shared redis instance is absolutely not a good choice from a secuity point of view</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Setting up Graphite on Ubuntu using the Metrics subsystem</a><ul>
<li><a class="reference internal" href="#installing-graphite-and-the-others-needed-packages">Installing Graphite and the others needed packages</a></li>
<li><a class="reference internal" href="#initializing-graphite">Initializing Graphite</a></li>
<li><a class="reference internal" href="#building-and-installing-uwsgi">Building and Installing uWSGI</a></li>
<li><a class="reference internal" href="#setting-up-the-uwsgi-emperor">Setting up the uWSGI Emperor</a></li>
<li><a class="reference internal" href="#spawning-the-graphite-web-interface">Spawning the Graphite web interface</a></li>
<li><a class="reference internal" href="#spawning-vassals-sending-metrics-to-graphite">Spawning vassals sending metrics to Graphite</a></li>
<li><a class="reference internal" href="#using-graphiti-ruby-sinatra-based-as-alternative-frontend">Using Graphiti (Ruby/Sinatra based) as alternative frontend</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="DynamicProxying.html"
                        title="previous chapter">Build a dynamic proxy using RPC and internal routing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../articles/SerializingAccept.html"
                        title="next chapter">Serializing accept(), AKA Thundering Herd, AKA the Zeeg Problem</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/GraphiteAndMetrics.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../articles/SerializingAccept.html" title="Serializing accept(), AKA Thundering Herd, AKA the Zeeg Problem"
             >next</a> |</li>
        <li class="right" >
          <a href="DynamicProxying.html" title="Build a dynamic proxy using RPC and internal routing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>