
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Writing uWSGI plugins &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="writing-uwsgi-plugins">
<h1>Writing uWSGI plugins<a class="headerlink" href="#writing-uwsgi-plugins" title="Permalink to this headline">¶</a></h1>
<p>This tutorial will introduce you to uWSGI hacking. A bit of C knowledge and UNIX theory is required.</p>
<p>The simplified (and safe) build system used in the tutorial has been added in uWSGI 1.9.21, on older versions you need the raw
procedure (described at the end of the tutorial)</p>
<div class="section" id="what-is-an-uwsgi-plugin">
<h2>What is an uWSGI plugin?<a class="headerlink" href="#what-is-an-uwsgi-plugin" title="Permalink to this headline">¶</a></h2>
<p>uWSGI plugins are standard shared libraries (with the classic .so extension) exposing a specific C structure named “uwsgi_plugin”.</p>
<p>This structure exposes a bunch of handy information (like the name of the plugin) and “hooks”.</p>
<p>Hooks are simple functions registered to be run at specific server phases.</p>
<p>The minimal plugin you can write it is something like this (the ‘foobar’ plugin):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;uwsgi.h&gt;</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">uwsgi_plugin</span> <span class="n">foobar_plugin</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span><span class="s">&quot;foobar&quot;</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>It announces itself as ‘foobar’ and exposes no hooks (yes, it is the most useless plugin out there, except for adding a teensy bit of memory use to uWSGI).</p>
<p>Plugins are not required to define hooks – they can simply expose functions that can be called using uWSGI advanced facilities (read: <span class="xref std std-doc">Hooks</span>).</p>
</div>
<div class="section" id="why-and-when-plugins">
<h2>Why (and when) plugins?<a class="headerlink" href="#why-and-when-plugins" title="Permalink to this headline">¶</a></h2>
<p>Even if uWSGI is able to directly load shared libraries (with <code class="docutils literal notranslate"><span class="pre">--dlopen</span></code>) and call their functions as hooks, sometimes you want to interface with
uWSGI’s internal structures.</p>
</div>
<div class="section" id="the-first-plugin">
<h2>The first plugin<a class="headerlink" href="#the-first-plugin" title="Permalink to this headline">¶</a></h2>
<p>Our first plugin will be a simple “Hello world” one:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;uwsgi.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">foo_init</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">uwsgi_log</span><span class="p">(</span><span class="s">&quot;Hello World</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">uwsgi_plugin</span> <span class="n">foobar_plugin</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;foobar&quot;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">foo_init</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Save it as <code class="docutils literal notranslate"><span class="pre">foobar.c</span></code>.</p>
<p>Build it:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --build-plugin foobar.c
</pre></div>
</div>
<p>You will end up with a <code class="docutils literal notranslate"><span class="pre">foobar_plugin.so</span></code> that you can load in your uWSGI binary.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --plugin ./foobar_plugin.so
</pre></div>
</div>
<p>If all goes well, you should see “Hello World” on your terminal before uWSGI exiting with an error (as no socket is defined).</p>
</div>
<div class="section" id="the-uwsgiplugin-py-file">
<h2>The uwsgiplugin.py file<a class="headerlink" href="#the-uwsgiplugin-py-file" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="how-does-the-magic-happen">
<h2>How does the magic happen?<a class="headerlink" href="#how-does-the-magic-happen" title="Permalink to this headline">¶</a></h2>
<p>As you have seen, the uwsgi binary by itself is able to build plugins without forcing the user/developer to care about build profiles, #ifdef or platform-specific configurations.</p>
<p>This is possible because the uwsgi binary itself contains the raw ‘uwsgi.h’ file as well as the ‘uwsgiconfig.py’ script.</p>
<p>In addition to this the CFLAGS used when building the binary are stored too.</p>
<p>With these 3 components you have all you need to safely build a uWSGI plugin tuned for your uwsgi binary.</p>
</div>
<div class="section" id="general-plugins-vs-request-plugins">
<h2>General plugins VS request plugins<a class="headerlink" href="#general-plugins-vs-request-plugins" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="the-wsgi-request-struct">
<h2>The wsgi_request struct<a class="headerlink" href="#the-wsgi-request-struct" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="headers-body-and-sendfile">
<h2>Headers, body and sendfile<a class="headerlink" href="#headers-body-and-sendfile" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="offloading">
<h2>Offloading<a class="headerlink" href="#offloading" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="available-hooks">
<h2>Available hooks<a class="headerlink" href="#available-hooks" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="defining-options">
<h2>Defining options<a class="headerlink" href="#defining-options" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="using-c">
<h2>Using C++<a class="headerlink" href="#using-c" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="using-objective-c">
<h2>Using Objective-C<a class="headerlink" href="#using-objective-c" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="socket-i-o">
<h2>socket I/O<a class="headerlink" href="#socket-i-o" title="Permalink to this headline">¶</a></h2>
<p>Whenever you make I/O operations on a socket you have to be sure to not-block the currently running thread/core/worker.</p>
<p>The uwsgi API exposes some functions to ensure safety when dealing with I/O. They would be documented here, but aren’t, yet.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Writing uWSGI plugins</a><ul>
<li><a class="reference internal" href="#what-is-an-uwsgi-plugin">What is an uWSGI plugin?</a></li>
<li><a class="reference internal" href="#why-and-when-plugins">Why (and when) plugins?</a></li>
<li><a class="reference internal" href="#the-first-plugin">The first plugin</a></li>
<li><a class="reference internal" href="#the-uwsgiplugin-py-file">The uwsgiplugin.py file</a></li>
<li><a class="reference internal" href="#how-does-the-magic-happen">How does the magic happen?</a></li>
<li><a class="reference internal" href="#general-plugins-vs-request-plugins">General plugins VS request plugins</a></li>
<li><a class="reference internal" href="#the-wsgi-request-struct">The wsgi_request struct</a></li>
<li><a class="reference internal" href="#headers-body-and-sendfile">Headers, body and sendfile</a></li>
<li><a class="reference internal" href="#offloading">Offloading</a></li>
<li><a class="reference internal" href="#available-hooks">Available hooks</a></li>
<li><a class="reference internal" href="#defining-options">Defining options</a></li>
<li><a class="reference internal" href="#using-c">Using C++</a></li>
<li><a class="reference internal" href="#using-objective-c">Using Objective-C</a></li>
<li><a class="reference internal" href="#socket-i-o">socket I/O</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/WritingPlugins.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>