
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>uWSGI Transformations &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="WebSocket support" href="WebSockets.html" />
    <link rel="prev" title="The GeoIP plugin" href="GeoIP.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="WebSockets.html" title="WebSocket support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="GeoIP.html" title="The GeoIP plugin"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="uwsgi-transformations">
<h1>uWSGI Transformations<a class="headerlink" href="#uwsgi-transformations" title="Permalink to this headline">¶</a></h1>
<p>Starting from uWSGI 1.9.7, a “transformations” API has been added to <a class="reference internal" href="InternalRouting.html"><span class="doc">uWSGI internal routing</span></a>.</p>
<p>A transformation is like a filter applied to the response generated by your application.</p>
<p>Transformations can be chained (the output of a transformation will be the input of the following one) and can completely overwrite
response headers.</p>
<p>The most common example of transformation is gzip encoding. The output of your application is passed to a function compressing it with gzip
and setting the Content-Encoding header. This feature rely on 2 external packages: libpcre3-dev, libz-dev on Ubuntu.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">python,transformation_gzip</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="c1">; load the werkzeug test app</span>
<span class="na">module</span> <span class="o">=</span> <span class="s">werkzeug.testapp:test_app</span>
<span class="c1">; if the client supports gzip encoding goto to the gzipper</span>
<span class="na">route-if</span> <span class="o">=</span> <span class="s">contains:${HTTP_ACCEPT_ENCODING};gzip goto:mygzipper</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">last:</span>

<span class="na">route-label</span> <span class="o">=</span> <span class="s">mygzipper</span>
<span class="c1">; pass the response to the gzip transformation</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ gzip:</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cachestore</span></code> routing instruction is a transformation too, so you can cache various states of the response.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">python,transformation_gzip</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="c1">; load the werkezeug test app</span>
<span class="na">module</span> <span class="o">=</span> <span class="s">werkzeug.testapp:test_app</span>
<span class="c1">; create a cache of 100 items</span>
<span class="na">cache</span> <span class="o">=</span> <span class="s">100</span>
<span class="c1">; if the client support gzip encoding goto to the gzipper</span>
<span class="na">route-if</span> <span class="o">=</span> <span class="s">contains:${HTTP_ACCEPT_ENCODING};gzip goto:mygzipper</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ cache:key=werkzeug_homepage</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ cachestore:key=werkzeug_homepage</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">last:</span>

<span class="na">route-label</span> <span class="o">=</span> <span class="s">mygzipper</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ cache:key=werkzeug_homepage.gz</span>
<span class="c1">; first cache the &#39;clean&#39; response (for client not supporting gzip)</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ cachestore:key=werkzeug_homepage</span>
<span class="c1">; then pass the response to the gzip transformation</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ gzip:</span>
<span class="c1">; and cache it again in another item (gzipped)</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/$ cachestore:key=werkzeug_homepage.gz</span>
</pre></div>
</div>
<p>Another common transformation is applying stylesheets to XML files. (see <a class="reference internal" href="XSLT.html"><span class="doc">The XSLT plugin</span></a>)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">toxslt</span></code> transformation is exposed by the <code class="docutils literal notranslate"><span class="pre">xslt</span></code> plugin:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --plugin xslt --http-socket :9090 -w mycd --route-run <span class="s2">&quot;toxslt:stylesheet=t/xslt/cd.xml.xslt,params=foobar=test&amp;agent=\${HTTP_USER_AGENT}&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">mycd</span></code> module here is a simple XML generator. Its output is then passed to the XSLT transformation.</p>
<div class="section" id="streaming-vs-buffering">
<h2>Streaming vs. buffering<a class="headerlink" href="#streaming-vs-buffering" title="Permalink to this headline">¶</a></h2>
<p>Each transformation announces itself as a “streaming” one or a “buffering” one.</p>
<p>Streaming ones are transformations that can be applied to response chunks (parts). An example of a streaming transformation
is gzip (you do not need the whole body to begin compressing it). Buffering transformations are those requiring the full body before applying something to it. XSLT is an example of buffering transformation. Another example of buffering transformations are those used for storing response in some kind of cache.</p>
<p>If your whole pipeline is composed by only “streaming” transformations, your client will receive the output chunk by chunk. On the other hand
a single buffering transformation will make the whole pipeline buffered, so your client will get the output only at the end.</p>
<p>An often using streaming functionality is gzip + chunked:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">transformation_gzip,transformation_chunked</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">gzip:</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">chunked:</span>
<span class="na">...</span>
</pre></div>
</div>
<p>The whole transformation pipeline is composed by streaming plugins, so you will get each HTTP chunk in realtime.</p>
</div>
<div class="section" id="flushing-magic">
<h2>Flushing magic<a class="headerlink" href="#flushing-magic" title="Permalink to this headline">¶</a></h2>
<p>The “flush” transformation is a special one. It allows you to send the current contents of the transformation buffer to the client (without clearing the buffer).</p>
<p>You can use it for implementing streaming mode when buffering will be applied. A common example is having streaming + caching:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">plugins</span> <span class="o">=</span> <span class="s">transformation_toupper,transform_tofile</span>
<span class="c1">; convert each char to uppercase</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">toupper:</span>
<span class="c1">; after each chunk converted to upper case, flush to the client</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">flush:</span>
<span class="c1">; buffer the whole response in memory for finally storing it in a file</span>
<span class="na">route-run</span> <span class="o">=</span> <span class="s">tofile:filename=/tmp/mycache</span>
<span class="na">...</span>
</pre></div>
</div>
<p>You can call flush multiple times and in various parts of the chain. Experiment a bit with it…</p>
</div>
<div class="section" id="available-transformations-last-update-20130504">
<h2>Available transformations (last update 20130504)<a class="headerlink" href="#available-transformations-last-update-20130504" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gzip</span></code>, exposed by the <code class="docutils literal notranslate"><span class="pre">transformation_gzip</span></code> plugin (encode the response buffer to gzip)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">toupper</span></code>, exposed by the <code class="docutils literal notranslate"><span class="pre">transformation_toupper</span></code> plugin (example plugin transforming each character in uppercase)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tofile</span></code>, exposed by the <code class="docutils literal notranslate"><span class="pre">transformation_tofile</span></code> plugin (used for caching to response buffer to a static file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">toxslt</span></code>, exposed by the <code class="docutils literal notranslate"><span class="pre">xslt</span></code> plugin (apply xslt stylesheet to an XML response buffer)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cachestore</span></code>, exposed by the <code class="docutils literal notranslate"><span class="pre">router_cache</span></code> plugin (cache the response buffer in the uWSGI cache)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chunked</span></code>, encode the output in HTTP chunked</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flush</span></code>, flush the current buffer to the client</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memcachedstore</span></code>, store the response buffer in a memcached object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">redisstore</span></code>, store the response buffer in a redis object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">template</span></code>, apply routing translations to each chunk</p></li>
</ul>
</div>
<div class="section" id="working-on">
<h2>Working on<a class="headerlink" href="#working-on" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rpc</span></code>, allows applying rpc functions to a response buffer (limit 64k size)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lua</span></code>, apply a lua function to a response buffer (no limit in size)</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">uWSGI Transformations</a><ul>
<li><a class="reference internal" href="#streaming-vs-buffering">Streaming vs. buffering</a></li>
<li><a class="reference internal" href="#flushing-magic">Flushing magic</a></li>
<li><a class="reference internal" href="#available-transformations-last-update-20130504">Available transformations (last update 20130504)</a></li>
<li><a class="reference internal" href="#working-on">Working on</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="GeoIP.html"
                        title="previous chapter">The GeoIP plugin</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="WebSockets.html"
                        title="next chapter">WebSocket support</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Transformations.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="WebSockets.html" title="WebSocket support"
             >next</a> |</li>
        <li class="right" >
          <a href="GeoIP.html" title="The GeoIP plugin"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>