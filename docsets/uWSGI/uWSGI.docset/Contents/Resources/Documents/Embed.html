
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Embedding an application in uWSGI &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Logging" href="Logging.html" />
    <link rel="prev" title="Running uWSGI instances with Circus" href="Circus.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Logging.html" title="Logging"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Circus.html" title="Running uWSGI instances with Circus"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="embedding-an-application-in-uwsgi">
<h1>Embedding an application in uWSGI<a class="headerlink" href="#embedding-an-application-in-uwsgi" title="Permalink to this headline">¶</a></h1>
<p>Starting from uWSGI 0.9.8.2, you can embed files in the server binary. These
can be any file type, including configuration files.  You can embed directories
too, so by hooking the Python module loader you can transparently import
packages, too.  In this example we’ll be embedding a full Flask project.</p>
<div class="section" id="step-1-creating-the-build-profile">
<h2>Step 1: creating the build profile<a class="headerlink" href="#step-1-creating-the-build-profile" title="Permalink to this headline">¶</a></h2>
<p>We’re assuming you have your uWSGI source at the ready.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">buildconf</span></code> directory, define your profile – let’s call it flask.ini:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">inherit</span> <span class="o">=</span> <span class="s">base</span>
<span class="na">main_plugin</span> <span class="o">=</span> <span class="s">python</span>
<span class="na">bin_name</span> <span class="o">=</span> <span class="s">myapp</span>
<span class="na">embed_files</span> <span class="o">=</span> <span class="s">bootstrap.py,myapp.py</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">myapp.py</span></code> is a simple flask app.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">bootstrap.py</span></code> is included in the source distribution. It will extend the python import subsystem to use files embedded in uWSGI.</p>
<p>Now compile your app-inclusive server. Files will be embedded as symbols in the
executable. Dots and dashes, etc. in filenames are thus transformed to
underscores.</p>
<div class="highlight-xxx notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --build flask
</pre></div>
</div>
<p>As <code class="docutils literal notranslate"><span class="pre">bin_name</span></code> was <code class="docutils literal notranslate"><span class="pre">myapp</span></code>, you can now run</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./myapp --socket :3031 --import sym://bootstrap_py --module myapp:app
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sym://</span></code> pseudoprotocol enables uWSGI to access the binary’s embedded
symbols and data, in this case importing bootstrap.py directly from the binary
image.</p>
</div>
<div class="section" id="step-2-embedding-the-config-file">
<h2>Step 2: embedding the config file<a class="headerlink" href="#step-2-embedding-the-config-file" title="Permalink to this headline">¶</a></h2>
<p>We want our binary to automatically load our Flask app without having to pass a long command line.</p>
<p>Let’s create the configuration – flaskconfig.ini:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">127.0.0.1:3031</span>
<span class="na">import</span> <span class="o">=</span> <span class="s">sym://bootstrap_py</span>
<span class="na">module</span> <span class="o">=</span> <span class="s">myapp:app</span>
</pre></div>
</div>
<p>And add it to the build profile as a config file.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">inherit</span> <span class="o">=</span> <span class="s">default</span>
<span class="na">bin_name</span> <span class="o">=</span> <span class="s">myapp</span>
<span class="na">embed_files</span> <span class="o">=</span> <span class="s">bootstrap.py,myapp.py</span>
<span class="na">embed_config</span> <span class="o">=</span> <span class="s">flaskconfig.ini</span>
</pre></div>
</div>
<p>Then, after you rebuild the server</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --build flask
</pre></div>
</div>
<p>you can now simply launch</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>./myapp
<span class="c1"># Remember that this new binary continues to be able to take parameters and config files:</span>
./myapp --master --processes <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3-embedding-flask-itself">
<h2>Step 3: embedding flask itself<a class="headerlink" href="#step-3-embedding-flask-itself" title="Permalink to this headline">¶</a></h2>
<p>Now, we are ready to kick asses with uWSGI ninja awesomeness.  We want a single
binary embedding all of the Flask modules, including Werkzeug and Jinja2,
Flask’s dependencies.  We need to have these packages’ directories and then
specify them in the build profile.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">inherit</span> <span class="o">=</span> <span class="s">default</span>
<span class="na">bin_name</span> <span class="o">=</span> <span class="s">myapp</span>
<span class="na">embed_files</span> <span class="o">=</span> <span class="s">bootstrap.py,myapp.py,werkzeug=site-packages/werkzeug,jinja2=site-packages/jinja2,flask=site-packages/flask</span>
<span class="na">embed_config</span> <span class="o">=</span> <span class="s">flaskconfig.ini</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This time we have used the form “name=directory” to force symbols to
a specific names to avoid ending up with a clusterfuck like
<code class="docutils literal notranslate"><span class="pre">site_packages_flask___init___py</span></code>.</p>
</div>
<p>Rebuild and re-run. We’re adding –no-site when running to show you that the
embedded modules are being loaded.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --build flask
./myapp --no-site --master --processes <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="section" id="step-4-adding-templates">
<h2>Step 4: adding templates<a class="headerlink" href="#step-4-adding-templates" title="Permalink to this headline">¶</a></h2>
<p>Still not satisfied? WELL YOU SHOULDN’T BE.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">inherit</span> <span class="o">=</span> <span class="s">default</span>
<span class="na">bin_name</span> <span class="o">=</span> <span class="s">myapp</span>
<span class="na">embed_files</span> <span class="o">=</span> <span class="s">bootstrap.py,myapp.py,werkzeug=site-packages/werkzeug,jinja2=site-packages/jinja2,flask=site-packages/flask,templates</span>
<span class="na">embed_config</span> <span class="o">=</span> <span class="s">flaskconfig.ini</span>
</pre></div>
</div>
<p>Templates will be added to the binary… but we’ll need to instruct Flask on
how to load templates from the binary image by creating a custom Jinja2
template loader.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">flask.templating</span> <span class="kn">import</span> <span class="n">DispatchingJinjaLoader</span>

<span class="k">class</span> <span class="nc">SymTemplateLoader</span><span class="p">(</span><span class="n">DispatchingJinjaLoader</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">symbolize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">uwsgi</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">uwsgi</span><span class="o">.</span><span class="n">embedded_data</span><span class="p">(</span><span class="s2">&quot;templates_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolize</span><span class="p">(</span><span class="n">template</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">source</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SymTemplateLoader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">SymTemplateLoader</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;bar/foo.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>POW! BIFF! NINJA AWESOMENESS.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Embedding an application in uWSGI</a><ul>
<li><a class="reference internal" href="#step-1-creating-the-build-profile">Step 1: creating the build profile</a></li>
<li><a class="reference internal" href="#step-2-embedding-the-config-file">Step 2: embedding the config file</a></li>
<li><a class="reference internal" href="#step-3-embedding-flask-itself">Step 3: embedding flask itself</a></li>
<li><a class="reference internal" href="#step-4-adding-templates">Step 4: adding templates</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Circus.html"
                        title="previous chapter">Running uWSGI instances with Circus</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Logging.html"
                        title="next chapter">Logging</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Embed.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Logging.html" title="Logging"
             >next</a> |</li>
        <li class="right" >
          <a href="Circus.html" title="Running uWSGI instances with Circus"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>