
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The uWSGI Legion subsystem &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Locks" href="Locks.html" />
    <link rel="prev" title="uWSGI internal routing" href="InternalRouting.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Locks.html" title="Locks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="InternalRouting.html" title="uWSGI internal routing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-uwsgi-legion-subsystem">
<h1>The uWSGI Legion subsystem<a class="headerlink" href="#the-uwsgi-legion-subsystem" title="Permalink to this headline">¶</a></h1>
<p>As of uWSGI 1.9-dev a new subsystem for clustering has been added: The Legion
subsystem. A Legion is a group of uWSGI nodes constantly fighting for
domination. Each node has a valor value (different from the others, if
possible). The node with the highest valor is the Lord of the Legion (or if
you like a less gaming nerd, more engineer-friendly term: the master). This
constant fight generates 7 kinds of events:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">setup</span></code> - when the legion subsystem is started on a node</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">join</span></code> - the first time quorum is reached, only on the newly joined node</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lord</span></code> - when this node becomes the lord</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unlord</span></code> - when this node loses the lord title</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">death</span></code> - when the legion subsystem is shutting down</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node-joined</span></code> - when any new node joins our legion</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node-left</span></code> - when any node leaves our legion</p></li>
</ol>
<p>You can trigger actions every time such an event rises.</p>
<p><strong>Note</strong>: <code class="docutils literal notranslate"><span class="pre">openssl</span></code> headers must be installed to build uWSGI with Legion support.</p>
<div class="section" id="ip-takeover">
<h2>IP takeover<a class="headerlink" href="#ip-takeover" title="Permalink to this headline">¶</a></h2>
<p>This is a very common configuration for clustered environments. The IP address
is a resource that must be owned by only one node. For this example, that node
is our Lord. If we configure a Legion right (remember, a single uWSGI
instances can be a member of all of the legions you need) we could easily
implement IP takeover.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">clusterip 225.1.1.1:4242 98 bf-cbc:hello</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">clusterip 225.1.1.1:4242</span>

<span class="na">legion-lord</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr add 192.168.173.111/24 dev eth0</span>
<span class="na">legion-lord</span> <span class="o">=</span> <span class="s">clusterip cmd:arping -c 3 -S 192.168.173.111 192.168.173.1</span>

<span class="na">legion-setup</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr del 192.168.173.111/24 dev eth0</span>
<span class="na">legion-unlord</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr del 192.168.173.111/24 dev eth0</span>
<span class="na">legion-death</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr del 192.168.173.111/24 dev eth0</span>
</pre></div>
</div>
<p>In this example we join a legion named <code class="docutils literal notranslate"><span class="pre">clusterip</span></code>. To receive messages from
the other nodes we bind on the multicast address 225.1.1.1:4242. The valor of
this node will be 98 and each message will be encrypted using Blowfish in CBC
with the shared secret <code class="docutils literal notranslate"><span class="pre">hello</span></code>. The <code class="docutils literal notranslate"><span class="pre">legion-node</span></code> option specifies the
destination of our announce messages. As we are using multicast we only need to
specify a single “node”. The last options are the actions to trigger on the
various states of the cluster. For an IP takeover solution we simply rely on
the Linux <code class="docutils literal notranslate"><span class="pre">iproute</span></code> commands to set/unset ip addresses and to send an extra
ARP message to announce the change. Obviously this specific example requires
root privileges or the <code class="docutils literal notranslate"><span class="pre">CAP_NET_ADMIN</span></code> Linux capability, so be sure to not
run untrusted applications on the same uWSGI instance managing IP takeover.</p>
<div class="section" id="the-quorum">
<h3>The Quorum<a class="headerlink" href="#the-quorum" title="Permalink to this headline">¶</a></h3>
<p>To choose a Lord each member of the legion has to cast a vote. When all of the
active members of a legion agree on a Lord, the Lord is elected and the old
Lord is demoted. Every time a new node joins or leaves a legion the quorum is
re-computed and logged to the whole cluster.</p>
</div>
<div class="section" id="choosing-the-lord">
<h3>Choosing the Lord<a class="headerlink" href="#choosing-the-lord" title="Permalink to this headline">¶</a></h3>
<p>Generally the node with the higher valor is chosen as the Lord, but there can
be cases where multiple nodes have the same valor. When a node is started a
UUID is assigned to it. If two nodes with same valor are found the one with the
lexicographically higher UUID wins.</p>
</div>
<div class="section" id="split-brain">
<h3>Split brain<a class="headerlink" href="#split-brain" title="Permalink to this headline">¶</a></h3>
<p>Even though each member of the Legion has to send a checksum of its internal
cluster-membership, the system is still vulnerable to the split brain problem.
If a node loses network connectivity with the cluster, it could believe it is
the only node available and starts going in Lord mode.</p>
<p>For many scenarios this is not optimal. If you have more than 2 nodes in a
legion you may want to consider tuning the quorum level.  The quorum level is
the amount of votes (as opposed to nodes) needed to elect a lord.
<code class="docutils literal notranslate"><span class="pre">legion-quorum</span></code> is the option for the job. You can reduce the split brain
problem asking the Legion subsystem to check for at least 2 votes:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">clusterip 225.1.1.1:4242 98 bf-cbc:hello</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">clusterip 225.1.1.1:4242</span>

<span class="na">legion-quorum</span> <span class="o">=</span> <span class="s">clusterip 2</span>

<span class="na">legion-lord</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr add 192.168.173.111/24 dev eth0</span>
<span class="na">legion-lord</span> <span class="o">=</span> <span class="s">clusterip cmd:arping -c 3 -S 192.168.173.111 192.168.173.1</span>

<span class="na">legion-setup</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr del 192.168.173.111/24 dev eth0</span>
<span class="na">legion-unlord</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr del 192.168.173.111/24 dev eth0</span>
<span class="na">legion-death</span> <span class="o">=</span> <span class="s">clusterip cmd:ip addr del 192.168.173.111/24 dev eth0</span>
</pre></div>
</div>
<p>As of 1.9.7 you can use nodes with valor 0 (concept similar to MongoDB’s
Arbiter Nodes), such nodes will be counted when checking for quorum but may
never become The Lord.  This is useful when you only need a couple nodes while
protecting against split-brain.</p>
</div>
<div class="section" id="actions">
<h3>Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h3>
<p>Each one of the four phases of a legion can trigger an action. The actions
system is modular so you can add new kinds of actions.  Currently the supported
actions are:</p>
</div>
</div>
<div class="section" id="cmd-command">
<h2><code class="docutils literal notranslate"><span class="pre">cmd:&lt;command&gt;</span></code><a class="headerlink" href="#cmd-command" title="Permalink to this headline">¶</a></h2>
<p>Run a shell command.</p>
</div>
<div class="section" id="signal-num">
<h2><code class="docutils literal notranslate"><span class="pre">signal:&lt;num&gt;</span></code><a class="headerlink" href="#signal-num" title="Permalink to this headline">¶</a></h2>
<p>Raise a uWSGI signal.</p>
</div>
<div class="section" id="log-msg">
<h2><code class="docutils literal notranslate"><span class="pre">log:&lt;msg&gt;</span></code><a class="headerlink" href="#log-msg" title="Permalink to this headline">¶</a></h2>
<p>Log a message. For example you could combine the log action with the alarm subsystem to have cluster monitoring for free.</p>
<div class="section" id="multicast-broadcast-and-unicast">
<h3><code class="docutils literal notranslate"><span class="pre">Multicast,</span> <span class="pre">broadcast</span> <span class="pre">and</span> <span class="pre">unicast</span></code><a class="headerlink" href="#multicast-broadcast-and-unicast" title="Permalink to this headline">¶</a></h3>
<p>Even if multicast is probably the easiest way to implement clustering it is not
available in all networks.  If multicast is not an option, you can rely on
normal IP addresses. Just bind to an address and add all of the legion-node
options you need:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.17:4242 98 bf-cbc:hello</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.22:4242</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.30:4242</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.5:4242</span>
</pre></div>
</div>
<p>This is for a cluster of 4 nodes (this node + 3 other nodes)</p>
</div>
<div class="section" id="multiple-legions">
<h3>Multiple Legions<a class="headerlink" href="#multiple-legions" title="Permalink to this headline">¶</a></h3>
<p>You can join multiple legions in the same instance. Just remember to use
different addresses (ports in case of multicast) for each legion.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.17:4242 98 bf-cbc:hello</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.22:4242</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.30:4242</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.5:4242</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">mycluster2 225.1.1.1:4243 99 aes-128-cbc:secret</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster2 225.1.1.1:4243</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">anothercluster 225.1.1.1:4244 91 aes-256-cbc:secret2</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">anothercluster 225.1.1.1:4244</span>
</pre></div>
</div>
</div>
<div class="section" id="security">
<h3>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h3>
<p>Each packet sent by the Legion subsystem is encrypted using a specified cipher,
a preshared secret, and an optional IV (initialization vector). Depending on
cipher, the IV may be a required parameter.  To get the list of supported
ciphers, run <code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">enc</span> <span class="pre">-h</span></code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Each node of a Legion has to use the same encryption parameters.</p>
</div>
<p>To specify the IV just add another parameter to the <strong>legion</strong> option.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>

<span class="na">legion</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.17:4242 98 bf-cbc:hello thisistheiv</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.22:4242</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.30:4242</span>
<span class="na">legion-node</span> <span class="o">=</span> <span class="s">mycluster 192.168.173.5:4242</span>
</pre></div>
</div>
<p>To reduce the impact of replay-based attacks, packets with a timestamp lower
than 30 seconds are rejected. This is a tunable parameter. If you have no
control on the time of all of the nodes you can increase the clock skew
tolerance.</p>
</div>
<div class="section" id="tuning-and-clock-skew">
<h3>Tuning and Clock Skew<a class="headerlink" href="#tuning-and-clock-skew" title="Permalink to this headline">¶</a></h3>
<p>Currently there are three parameters you can tune. These tuables affect all
Legions in the system. The frequency (in seconds) at which each packet is sent
(<strong>legion-freq &lt;secs&gt;</strong>), the amount of seconds after a node not sending
packets is considered dead (<strong>legion-tolerance &lt;secs&gt;</strong>), and the amount of
clock skew between nodes (<strong>legion-skew-tolerance &lt;secs&gt;</strong>). The Legion
subsystem requires tight time synchronization, so the use of NTP or similar is
highly recommended.  By default each packet is sent every 3 seconds, a node is
considered dead after 15 seconds, and a clock skew of 30 seconds is tolerated.
Decreasing skew tolerance should increase security against replay attacks.</p>
</div>
<div class="section" id="lord-scroll-coming-soon">
<h3>Lord scroll (coming soon)<a class="headerlink" href="#lord-scroll-coming-soon" title="Permalink to this headline">¶</a></h3>
<p>The Legion subsystem can be used for a variety of purposes ranging from master
election to node autodiscovery or simple monitoring.  One example is to assign
a “blob of data” (a scroll) to every node, One use of this is to pass
reconfiguration parameters to your app, or to log specific messages.  Currently
the scroll system is being improved upon, so if you have ideas join our mailing
list or IRC channel.</p>
</div>
<div class="section" id="legion-api">
<h3>Legion API<a class="headerlink" href="#legion-api" title="Permalink to this headline">¶</a></h3>
<p>You can know if the instance is a lord of a Legion by simply calling</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">uwsgi_legion_i_am_the_lord</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">legion_name</span><span class="p">);</span>
</pre></div>
</div>
<p>It returns 1 if the current instance is the lord for the specified Legion.</p>
<ul class="simple">
<li><p>The Python plugin exposes it as <code class="docutils literal notranslate"><span class="pre">uwsgi.i_am_the_lord(name)</span></code></p></li>
<li><p>The PSGI plugin exposes it as <code class="docutils literal notranslate"><span class="pre">uwsgi::i_am_the_lord(name)</span></code></p></li>
<li><p>The Rack plugin exposes it as <code class="docutils literal notranslate"><span class="pre">UWSGI::i_am_the_lord(name)</span></code></p></li>
</ul>
<p>Obviously more API functions will be added in the future, feel free to expose your ideas.</p>
</div>
<div class="section" id="stats">
<h3>Stats<a class="headerlink" href="#stats" title="Permalink to this headline">¶</a></h3>
<p>The Legion information is available in the <a class="reference internal" href="StatsServer.html"><span class="doc">The uWSGI Stats Server</span></a>.  Be sure to
understand the difference between “nodes” and “members”. Nodes are the peer you
configure with the <strong>legion-node</strong> option while members are the effective nodes
that joined the cluster.</p>
</div>
<div class="section" id="the-old-clustering-subsystem">
<h3>The old clustering subsystem<a class="headerlink" href="#the-old-clustering-subsystem" title="Permalink to this headline">¶</a></h3>
<p>During 0.9 development cycle a clustering subsystem (based on multicast) was
added. It was very raw, unreliable and very probably no-one used it seriously.
The new method is transforming it in a general API that can use different
backends.  The Legion subsystem can be one of those backends, as well as
projects like corosync or the redhat cluster suite.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The uWSGI Legion subsystem</a><ul>
<li><a class="reference internal" href="#ip-takeover">IP takeover</a><ul>
<li><a class="reference internal" href="#the-quorum">The Quorum</a></li>
<li><a class="reference internal" href="#choosing-the-lord">Choosing the Lord</a></li>
<li><a class="reference internal" href="#split-brain">Split brain</a></li>
<li><a class="reference internal" href="#actions">Actions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cmd-command"><code class="docutils literal notranslate"><span class="pre">cmd:&lt;command&gt;</span></code></a></li>
<li><a class="reference internal" href="#signal-num"><code class="docutils literal notranslate"><span class="pre">signal:&lt;num&gt;</span></code></a></li>
<li><a class="reference internal" href="#log-msg"><code class="docutils literal notranslate"><span class="pre">log:&lt;msg&gt;</span></code></a><ul>
<li><a class="reference internal" href="#multicast-broadcast-and-unicast"><code class="docutils literal notranslate"><span class="pre">Multicast,</span> <span class="pre">broadcast</span> <span class="pre">and</span> <span class="pre">unicast</span></code></a></li>
<li><a class="reference internal" href="#multiple-legions">Multiple Legions</a></li>
<li><a class="reference internal" href="#security">Security</a></li>
<li><a class="reference internal" href="#tuning-and-clock-skew">Tuning and Clock Skew</a></li>
<li><a class="reference internal" href="#lord-scroll-coming-soon">Lord scroll (coming soon)</a></li>
<li><a class="reference internal" href="#legion-api">Legion API</a></li>
<li><a class="reference internal" href="#stats">Stats</a></li>
<li><a class="reference internal" href="#the-old-clustering-subsystem">The old clustering subsystem</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="InternalRouting.html"
                        title="previous chapter">uWSGI internal routing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Locks.html"
                        title="next chapter">Locks</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Legion.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Locks.html" title="Locks"
             >next</a> |</li>
        <li class="right" >
          <a href="InternalRouting.html" title="uWSGI internal routing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>