
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The uWSGI Emperor – multi-app deployment &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Imperial monitors" href="ImperialMonitors.html" />
    <link rel="prev" title="The uWSGI cheaper subsystem – adaptive process spawning" href="Cheaper.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="ImperialMonitors.html" title="Imperial monitors"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Cheaper.html" title="The uWSGI cheaper subsystem – adaptive process spawning"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-uwsgi-emperor-multi-app-deployment">
<h1>The uWSGI Emperor – multi-app deployment<a class="headerlink" href="#the-uwsgi-emperor-multi-app-deployment" title="Permalink to this headline">¶</a></h1>
<p>If you need to deploy a big number of apps on a single server, or a group of
servers, the Emperor mode is just the ticket.  It is a special uWSGI instance
that will monitor specific events and will spawn/stop/reload instances (known
as <span class="xref std std-term">vassals</span>, when managed by an Emperor) on demand.</p>
<p>By default the Emperor will scan specific directories for supported (.ini,
.xml, .yml, .json, etc.) uWSGI configuration files, but it is extensible using
<span class="xref std std-term">imperial monitor</span> plugins.  The <code class="docutils literal notranslate"><span class="pre">dir://</span></code> and <code class="docutils literal notranslate"><span class="pre">glob://</span></code> plugins are
embedded in the core, so they need not be loaded, and are automatically
detected. The <code class="docutils literal notranslate"><span class="pre">dir://</span></code> plugin is the default.</p>
<ul class="simple">
<li><p>Whenever an imperial monitor detects a new configuration file, a new uWSGI instance will be spawned with that configuration.</p></li>
<li><p>Whenever a configuration file is modified (its modification time changed, so <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">--no-dereference</span></code> may be your friend), the corresponding app will be reloaded.</p></li>
<li><p>Whenever a config file is removed, the corresponding app will be stopped.</p></li>
<li><p>If the emperor dies, all the vassals die.</p></li>
<li><p>If a vassal dies for any reason, the emperor will respawn it.</p></li>
</ul>
<p>Multiple sources of configuration may be monitored by specifying <code class="docutils literal notranslate"><span class="pre">--emperor</span></code> multiple times.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See <a class="reference internal" href="ImperialMonitors.html"><span class="doc">Imperial monitors</span></a> for a list of the Imperial Monitor plugins
shipped with uWSGI and how to use them.</p>
</div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="ImperialMonitors.html">Imperial monitors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#dir-scan-a-directory-for-uwsgi-config-files"><code class="docutils literal notranslate"><span class="pre">dir://</span></code> – scan a directory for uWSGI config files</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#glob-monitor-a-shell-pattern"><code class="docutils literal notranslate"><span class="pre">glob://</span></code> – monitor a shell pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#pg-scan-a-postgresql-table-for-configuration"><code class="docutils literal notranslate"><span class="pre">pg://</span></code> – scan a PostgreSQL table for configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#mongodb-scan-mongodb-collections-for-configuration"><code class="docutils literal notranslate"><span class="pre">mongodb://</span></code> – Scan MongoDB collections for configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#amqp-use-an-amqp-compliant-message-queue-to-announce-events"><code class="docutils literal notranslate"><span class="pre">amqp://</span></code> – Use an AMQP compliant message queue to announce events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="ImperialMonitors.html#amqp-with-http">AMQP with HTTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="ImperialMonitors.html#direct-amqp-configuration">Direct AMQP configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#zmq-zeromq"><code class="docutils literal notranslate"><span class="pre">zmq://</span></code> – ZeroMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#zoo-zookeeper"><code class="docutils literal notranslate"><span class="pre">zoo://</span></code> – Zookeeper</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImperialMonitors.html#ldap-ldap"><code class="docutils literal notranslate"><span class="pre">ldap://</span></code> – LDAP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="EmperorProtocol.html">The Emperor protocol</a><ul>
<li class="toctree-l2"><a class="reference internal" href="EmperorProtocol.html#the-protocol">The protocol</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="OnDemandVassals.html">On demand vassals (socket activation)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="OnDemandVassals.html#on-demand-vassals-with-filesystem-based-imperial-monitors">On demand vassals with filesystem-based imperial monitors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="OnDemandVassals.html#emperor-on-demand-extension-ext">–emperor-on-demand-extension &lt;ext&gt;</a></li>
<li class="toctree-l3"><a class="reference internal" href="OnDemandVassals.html#emperor-on-demand-directory-dir">–emperor-on-demand-directory &lt;dir&gt;</a></li>
<li class="toctree-l3"><a class="reference internal" href="OnDemandVassals.html#emperor-on-demand-exec-cmd">–emperor-on-demand-exec &lt;cmd&gt;</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="OnDemandVassals.html#using-on-demand-vassals-with-other-imperial-monitors">Using on demand vassals with other imperial monitors</a></li>
<li class="toctree-l2"><a class="reference internal" href="OnDemandVassals.html#combining-on-demand-vassals-with-idle-and-die-on-idle">Combining on demand vassals with <code class="docutils literal notranslate"><span class="pre">--idle</span></code> and <code class="docutils literal notranslate"><span class="pre">--die-on-idle</span></code></a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="special-configuration-variables">
<h2>Special configuration variables<a class="headerlink" href="#special-configuration-variables" title="Permalink to this headline">¶</a></h2>
<p>Using <a class="reference internal" href="Configuration.html#placeholders"><span class="std std-ref">Placeholders</span></a> and <a class="reference internal" href="Configuration.html#magicvars"><span class="std std-ref">Magic variables</span></a> in conjunction with the Emperor
will probably save you a lot of time and make your configuration more DRY.
Suppose that in /opt/apps there are only <a class="reference external" href="http://djangoproject.com">Django</a> apps.  /opt/apps/app.skel (the
.skel extension is not a known configuration file type to uWSGI and will be
skipped)</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">chdir</span> <span class="o">=</span> <span class="s">/opt/apps/%n</span>
<span class="na">threads</span> <span class="o">=</span> <span class="s">20</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/sockets/%n.sock</span>
<span class="na">env</span> <span class="o">=</span> <span class="s">DJANGO_SETTINGS_MODULE=%n.settings</span>
<span class="na">module</span> <span class="o">=</span> <span class="s">django.core.handlers.wsgi:WSGIHandler()</span>
</pre></div>
</div>
<p>And then for each app create a symlink:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">skel</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">app1</span><span class="o">.</span><span class="n">ini</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">skel</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">app2</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Finally, start the Emperor with the <code class="docutils literal notranslate"><span class="pre">--emperor-nofollow</span></code> option. Now you can reload each vassal separately with the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>touch --no-dereference $INI_FILE
</pre></div>
</div>
</div>
<div class="section" id="passing-configuration-parameters-to-all-vassals">
<h2>Passing configuration parameters to all vassals<a class="headerlink" href="#passing-configuration-parameters-to-all-vassals" title="Permalink to this headline">¶</a></h2>
<p>Starting from 1.9.19 you can pass options using the <code class="docutils literal notranslate"><span class="pre">--vassal-set</span></code> facility</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">vassal-set</span> <span class="o">=</span> <span class="s">processes=8</span>
<span class="na">vassal-set</span> <span class="o">=</span> <span class="s">enable-metrics=1</span>
</pre></div>
</div>
<p>this will add <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">processes=8</span></code> and <code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">enable-metrics=1</span></code> to each vassal</p>
<p>You can force the Emperor to pass options to uWSGI instances using environment
variables too.  Every environment variable of the form <code class="docutils literal notranslate"><span class="pre">UWSGI_VASSAL_xxx</span></code> will be
rewritten in the new instance as <code class="docutils literal notranslate"><span class="pre">UWSGI_xxx</span></code>, with the usual
<a class="reference internal" href="Configuration.html#configenv"><span class="std std-ref">configuration implications</span></a>.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UWSGI_VASSAL_SOCKET</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/%</span><span class="n">n</span><span class="o">.</span><span class="n">sock</span> <span class="n">uwsgi</span> <span class="o">--</span><span class="n">emperor</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span>
</pre></div>
</div>
<p>will let you avoid specifying the socket option in configuration files.</p>
<p>Alternatively, you can use the <code class="docutils literal notranslate"><span class="pre">--vassals-include</span></code> option let each
vassal automatically include a complete config file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uwsgi</span> <span class="o">--</span><span class="n">emperor</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span> <span class="o">--</span><span class="n">vassals</span><span class="o">-</span><span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">uwsgi</span><span class="o">/</span><span class="n">vassals</span><span class="o">-</span><span class="n">default</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Note that if you do this, <code class="docutils literal notranslate"><span class="pre">%n</span></code> (and other magic variables) in the
included file will resolve to the name of the included file, not the
original vassal configuration file. If you want to set options in the
included file using the vassal name, you’ll have to use placeholders.
For example, in the vassal config, you write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">uwsgi</span><span class="p">]</span>
<span class="n">vassal_name</span> <span class="o">=</span> <span class="o">%</span><span class="n">n</span>
<span class="o">...</span> <span class="n">more</span> <span class="n">options</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">vassal-defaults.ini</span></code>, you write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">uwsgi</span><span class="p">]</span>
<span class="n">socket</span> <span class="o">=</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">sockets</span><span class="o">/%</span><span class="p">(</span><span class="n">vassal_name</span><span class="p">)</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
</div>
<div class="section" id="tyrant-mode-secure-multi-user-hosting">
<span id="tyrant"></span><h2>Tyrant mode (secure multi-user hosting)<a class="headerlink" href="#tyrant-mode-secure-multi-user-hosting" title="Permalink to this headline">¶</a></h2>
<p>The emperor is normally run as root, setting the UID and GID in each
instance’s config. The vassal instance then drops privileges before serving
requests. In this mode, if your users have access to their own uWSGI
configuration files, you can’t trust them to set the correct <code class="docutils literal notranslate"><span class="pre">uid</span></code> and
<code class="docutils literal notranslate"><span class="pre">gid</span></code>. You could run the emperor as unprivileged user (with <code class="docutils literal notranslate"><span class="pre">uid</span></code> and
<code class="docutils literal notranslate"><span class="pre">gid</span></code>) but all of the vassals would then run under the same user, as
unprivileged users are not able to promote themselves to other users.  For this
case the Tyrant mode is available – just add the <code class="docutils literal notranslate"><span class="pre">emperor-tyrant</span></code> option.</p>
<p>In Tyrant mode the Emperor will run the vassal using the UID/GID of the vassal
configuration file (or for other Imperial Monitors, by some other method of
configuration).  If Tyrant mode is used, the vassal configuration files must
have UID/GID &gt; 0. An error will occur if the UID or GID is zero, or if the UID
or GID of the configuration of an already running vassal changes.</p>
<div class="section" id="tyrant-mode-for-paranoid-sysadmins-linux-only">
<h3>Tyrant mode for paranoid sysadmins (Linux only)<a class="headerlink" href="#tyrant-mode-for-paranoid-sysadmins-linux-only" title="Permalink to this headline">¶</a></h3>
<p>If you have built a uWSGI version with <a class="reference internal" href="Capabilities.html"><span class="doc">Setting POSIX Capabilities</span></a> options enabled, you
can run the Emperor as unprivileged user but maintaining the minimal amount of
root-capabilities needed to apply the tyrant mode</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">10000</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">10000</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/tmp</span>
<span class="na">emperor-tyrant</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">cap</span> <span class="o">=</span> <span class="s">setgid,setuid</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="loyalty">
<h2>Loyalty<a class="headerlink" href="#loyalty" title="Permalink to this headline">¶</a></h2>
<p>As soon as a vassal manages a request it will became “loyal”. This status is
used by the Emperor to identify bad-behaving vassals and punish them.</p>
</div>
<div class="section" id="throttling">
<h2>Throttling<a class="headerlink" href="#throttling" title="Permalink to this headline">¶</a></h2>
<p>Whenever two or more vassals are spawned in the same second, the Emperor will
start a throttling subsystem to avoid <a class="reference external" href="http://en.wikipedia.org/wiki/Fork_bomb">fork bombing</a>.  The system adds a
throttle delta (specified in milliseconds via the <span class="xref std std-ref">OptionEmperorThrottle</span>
option) whenever it happens, and waits for that duration before spawning a new
vassal.  Every time a new vassal spawns without triggering throttling, the
current throttling duration is halved.</p>
</div>
<div class="section" id="blacklist-system">
<h2>Blacklist system<a class="headerlink" href="#blacklist-system" title="Permalink to this headline">¶</a></h2>
<p>Whenever a non-loyal vassal dies, it is put in a shameful blacklist.  When in a
blacklist, that vassal will be throttled up to a maximum value (tunable via
<span class="xref std std-ref">OptionEmperorMaxThrottle</span>), starting from the default throttle delta of
3.  Whenever a blacklisted vassal dies, its throttling value is increased by
the delta (<span class="xref std std-ref">OptionEmperorThrottle</span>).</p>
<p>You can also empty the blacklist by sending the signal SIGURG to the emperor
process. This will reset the throttle value.</p>
</div>
<div class="section" id="heartbeat-system">
<h2>Heartbeat system<a class="headerlink" href="#heartbeat-system" title="Permalink to this headline">¶</a></h2>
<p>Vassals can voluntarily ask the Emperor to monitor their status.  Workers of
heartbeat-enabled vassals will send “heartbeat” messages to the Emperor. If the
Emperor does not receive heartbeats from an instance for more than N (default
30, <span class="xref std std-ref">OptionEmperorRequiredHeartbeat</span>) seconds, that instance will be
considered hung and thus reloaded.  To enable sending of heartbeat packet in a
vassal, add the <span class="xref std std-ref">OptionHeartbeat</span> option.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If all of your workers are stuck handling perfectly legal requests such as
slow, large file uploads, the Emperor will trigger a reload as if the workers
are hung.  The reload triggered is a graceful one, so you will be able to tune
your config/timeout/mercy for sane behaviour.</p>
</div>
</div>
<div class="section" id="using-linux-namespaces-for-vassals">
<h2>Using Linux namespaces for vassals<a class="headerlink" href="#using-linux-namespaces-for-vassals" title="Permalink to this headline">¶</a></h2>
<p>On Linux you can tell the Emperor to run vassals in “unshared” contexts. That means you can run each vassal with a dedicated view of the filesystems, ipc, uts, networking, pids and uids.</p>
<p>Things you generally do with tools like <code class="docutils literal notranslate"><span class="pre">lxc</span></code> or its abstractions like <code class="docutils literal notranslate"><span class="pre">docker</span></code> are native in uWSGI.</p>
<p>For example if you want to run each vassals in a new namespace:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">emperor-use-clone</span> <span class="o">=</span> <span class="s">fs,net,ipc,pid,uts</span>
</pre></div>
</div>
<p>now each vassal will be able to modify the filesystem layout, networking, hostname and so on without damaging the main system.</p>
<p>A couple of helper daemons are included in the uWSGI distribution to simplify management of jailed vassals. Most notably <a class="reference internal" href="TunTapRouter.html"><span class="doc">The TunTap Router</span></a> allows full user-space networking in jails, while
the <code class="docutils literal notranslate"><span class="pre">forkpty</span> <span class="pre">router</span></code> allows allocation of pseudoterminals in jails</p>
<p>It is not needed to unshare all of the subsystem in your vassals, sometimes you only want to give dedicated ipc and hostname to a vassal and hide from the processes list:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">emperor-use-clone</span> <span class="o">=</span> <span class="s">fs,ipc,pid,uts</span>
</pre></div>
</div>
<p>a vassal could be:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; set the hostname</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">hostname foobar</span>
<span class="c1">; umount /proc and remount to hide processes</span>
<span class="c1">; as we are in the &#39;fs&#39; namespace umounting /proc does not interfere with the main one</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">umount /proc</span>
<span class="na">exec-as-root</span> <span class="o">=</span> <span class="s">mount -t proc none /proc</span>
<span class="c1">; drop privileges</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">foobar</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">foobar</span>
<span class="c1">; bind to the socket</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/myapp.socket</span>
<span class="na">psgi</span> <span class="o">=</span> <span class="s">myapp.pl</span>
</pre></div>
</div>
</div>
<div class="section" id="the-imperial-bureau-of-statistics">
<h2>The Imperial Bureau of Statistics<a class="headerlink" href="#the-imperial-bureau-of-statistics" title="Permalink to this headline">¶</a></h2>
<p>You can enable a statistics/status service for the Emperor by adding the
<span class="xref std std-ref">OptionEmperorStats</span> option with a TCP address. By connecting to that
address, you’ll get a JSON-format blob of statistics.</p>
</div>
<div class="section" id="running-non-uwsgi-apps-or-using-alternative-uwsgis-as-vassals">
<span id="binarypatch"></span><h2>Running non-uWSGI apps or using alternative uWSGIs as vassals<a class="headerlink" href="#running-non-uwsgi-apps-or-using-alternative-uwsgis-as-vassals" title="Permalink to this headline">¶</a></h2>
<p>You can <code class="docutils literal notranslate"><span class="pre">exec()</span></code> a different binary as your vassal using the
<code class="docutils literal notranslate"><span class="pre">privileged-binary-patch</span></code>/<code class="docutils literal notranslate"><span class="pre">unprivileged-binary-patch</span></code> options.  The first
one patches the binary after socket inheritance and shared socket
initialization (so you will be able to use uWSGI-defined sockets).  The second
one patches the binary after privileges drop. In this way you will be able to
use uWSGI’s UID/GID/chroot/namespace/jailing options.  The binary is called
with the same arguments that were passed to the vassal by the Emperor.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; i am a special vassal calling a different binary in a new linux network namespace</span>
<span class="k">[uwsgi]</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">1000</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">1000</span>
<span class="na">unshare</span> <span class="o">=</span> <span class="s">net</span>
<span class="na">unprivileged-binary-patch</span> <span class="o">=</span> <span class="s">/usr/bin/myfunnyserver</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><em>DO NOT DAEMONIZE</em> your apps. If you do so, the Emperor will lose its connection with them.</p>
</div>
<p>The uWSGI arguments are passed to the new binary. If you do not like that
behaviour (or need to pass custom arguments) add <code class="docutils literal notranslate"><span class="pre">-arg</span></code> to the binary patch
option, yielding:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">; i am a special vassal calling a different binary in a new linux network namespace</span>
<span class="c1">; with custom options</span>
<span class="k">[uwsgi]</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">1000</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">1000</span>
<span class="na">unshare</span> <span class="o">=</span> <span class="s">net</span>
<span class="na">unprivileged-binary-patch-arg</span> <span class="o">=</span> <span class="s">ps aux</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1">;nginx example</span>
<span class="k">[uwsgi]</span>
<span class="na">privileged-binary-patch-arg</span> <span class="o">=</span> <span class="s">nginx -g &quot;daemon off;&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Your custom vassal apps can also speak with the emperor using the <a class="reference internal" href="EmperorProtocol.html"><span class="doc">emperor protocol</span></a>.</p>
</div>
</div>
<div class="section" id="integrating-the-emperor-with-the-fastrouter">
<h2>Integrating the Emperor with the FastRouter<a class="headerlink" href="#integrating-the-emperor-with-the-fastrouter" title="Permalink to this headline">¶</a></h2>
<p>The FastRouter is a proxy/load-balancer/router speaking <a class="reference internal" href="Protocol.html"><span class="doc">The uwsgi Protocol</span></a>.  Yann
Malet from <a class="reference external" href="http://lincolnloop.com/">Lincoln Loop</a> has released <a class="reference external" href="https://projects.unbit.it/uwsgi/raw-attachment/wiki/Emperor/lincolnloop.pdf">a draft about massive Emperor +
Fastrouter deployment</a> (PDF) using <a class="reference internal" href="Caching.html"><span class="doc">The uWSGI caching framework</span></a> as a hostname to socket
mapping storage.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>At startup, the emperor <code class="docutils literal notranslate"><span class="pre">chdir()</span></code> to the vassal dir. All vassal instances will start from here.</p></li>
<li><p>If the uwsgi binary is not in your system path you can force its path with <code class="docutils literal notranslate"><span class="pre">binary-path</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">uwsgi</span> <span class="o">--</span><span class="n">emperor</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">apps</span> <span class="o">--</span><span class="n">binary</span><span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">uwsgi</span><span class="o">/</span><span class="n">uwsgi</span>
</pre></div>
</div>
</li>
<li><p>Sending <code class="docutils literal notranslate"><span class="pre">SIGUSR1</span></code> to the emperor will print vassal status in its log.</p></li>
<li><p>Stopping (<code class="docutils literal notranslate"><span class="pre">SIGINT</span></code>/<code class="docutils literal notranslate"><span class="pre">SIGTERM</span></code>/<code class="docutils literal notranslate"><span class="pre">SIGQUIT</span></code>) the Emperor will invoke
Ragnarok and kill all the vassals.</p></li>
<li><p>Sending <code class="docutils literal notranslate"><span class="pre">SIGHUP</span></code> to the Emperor will reload all vassals.</p></li>
<li><p>Sending <code class="docutils literal notranslate"><span class="pre">SIGURG</span></code> to the Emperor will remove all vassals from the blacklist</p></li>
<li><p>The emperor should generally not be run with <code class="docutils literal notranslate"><span class="pre">--master</span></code>, unless master
features like advanced logging are specifically needed.</p></li>
<li><p>The emperor should generally be started at server boot time and left alone,
not reloaded/restarted except for uWSGI upgrades; emperor reloads are a bit
drastic, reloading all vassals at once. Instead vassals should be reloaded
individually when needed, in the manner of the imperial monitor in use.</p></li>
</ul>
</div>
<div class="section" id="todo">
<h2>Todo<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Docs-TODO: Clarify what the “chdir-on-startup” behavior does with
non-filesystem monitors.</p></li>
<li><p>Export more magic vars</p></li>
<li><p>Add support for multiple sections in xml/ini/yaml files (this will allow to
have a single config file for multiple instances)</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The uWSGI Emperor – multi-app deployment</a><ul>
<li><a class="reference internal" href="#special-configuration-variables">Special configuration variables</a></li>
<li><a class="reference internal" href="#passing-configuration-parameters-to-all-vassals">Passing configuration parameters to all vassals</a></li>
<li><a class="reference internal" href="#tyrant-mode-secure-multi-user-hosting">Tyrant mode (secure multi-user hosting)</a><ul>
<li><a class="reference internal" href="#tyrant-mode-for-paranoid-sysadmins-linux-only">Tyrant mode for paranoid sysadmins (Linux only)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#loyalty">Loyalty</a></li>
<li><a class="reference internal" href="#throttling">Throttling</a></li>
<li><a class="reference internal" href="#blacklist-system">Blacklist system</a></li>
<li><a class="reference internal" href="#heartbeat-system">Heartbeat system</a></li>
<li><a class="reference internal" href="#using-linux-namespaces-for-vassals">Using Linux namespaces for vassals</a></li>
<li><a class="reference internal" href="#the-imperial-bureau-of-statistics">The Imperial Bureau of Statistics</a></li>
<li><a class="reference internal" href="#running-non-uwsgi-apps-or-using-alternative-uwsgis-as-vassals">Running non-uWSGI apps or using alternative uWSGIs as vassals</a></li>
<li><a class="reference internal" href="#integrating-the-emperor-with-the-fastrouter">Integrating the Emperor with the FastRouter</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
<li><a class="reference internal" href="#todo">Todo</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Cheaper.html"
                        title="previous chapter">The uWSGI cheaper subsystem – adaptive process spawning</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="ImperialMonitors.html"
                        title="next chapter">Imperial monitors</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Emperor.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="ImperialMonitors.html" title="Imperial monitors"
             >next</a> |</li>
        <li class="right" >
          <a href="Cheaper.html" title="The uWSGI cheaper subsystem – adaptive process spawning"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>