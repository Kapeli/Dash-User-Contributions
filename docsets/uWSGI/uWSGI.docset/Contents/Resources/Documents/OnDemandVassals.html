
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>On demand vassals (socket activation) &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Auto-scaling with Broodlord mode" href="Broodlord.html" />
    <link rel="prev" title="The Emperor protocol" href="EmperorProtocol.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Broodlord.html" title="Auto-scaling with Broodlord mode"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="EmperorProtocol.html" title="The Emperor protocol"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Emperor.html" accesskey="U">The uWSGI Emperor – multi-app deployment</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="on-demand-vassals-socket-activation">
<h1>On demand vassals (socket activation)<a class="headerlink" href="#on-demand-vassals-socket-activation" title="Permalink to this headline">¶</a></h1>
<p>Inspired by the venerable xinetd/inetd approach, you can spawn your vassals
only after the first connection to a specific socket. This feature is available
as of 1.9.1. Combined with –idle/–die-on-idle options, you can have truly
on-demand applications.</p>
<p>When on demand is active for particular vassal, emperor won’t spawn it on start
(or when it’s config changes), but it will rather create socket for that
vassal and monitor if anything connects to it.</p>
<p>At the first connection, the vassal is spawned and the socket passed as the file
descriptor 0. File descriptor 0 is always checked by uWSGI so you do not need to
specify a –socket option in the vassal file. This works automagically for uwsgi
sockets, if you use other protocols (like http or fastcgi) you have to
specify it with the –protocol option</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you will define in your vassal config same socket as used by emperor for
on demand action, vassal will override that socket file. That could lead to
unexpected behaviour, for example on demand activation of that vassal will
work only once.</p>
</div>
<div class="section" id="on-demand-vassals-with-filesystem-based-imperial-monitors">
<h2>On demand vassals with filesystem-based imperial monitors<a class="headerlink" href="#on-demand-vassals-with-filesystem-based-imperial-monitors" title="Permalink to this headline">¶</a></h2>
<p>For filesystem-based imperial monitors, such as <code class="docutils literal notranslate"><span class="pre">dir://</span></code> or <code class="docutils literal notranslate"><span class="pre">glob://</span></code>,
defining on demand vassals involves defining one of three additional settings
for your emperor:</p>
<div class="section" id="emperor-on-demand-extension-ext">
<h3>–emperor-on-demand-extension &lt;ext&gt;<a class="headerlink" href="#emperor-on-demand-extension-ext" title="Permalink to this headline">¶</a></h3>
<p>this will instruct the Emperor to check for a file named &lt;vassal&gt;+&lt;ext&gt;, if the
file is available it will be read and its content used as the socket to wait
for:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --emperor /etc/uwsgi/vassals --emperor-on-demand-extension .socket
</pre></div>
</div>
<p>supposing a myapp.ini file in /etc/uwsgi/vassals, a /etc/uwsgi/vassals/myapp.ini.socket
will be searched for (and its content used as the socket name). Note that
myapp.ini.socket isn’t a socket! This file only contains path for actual socket
(tcp or unix).</p>
</div>
<div class="section" id="emperor-on-demand-directory-dir">
<h3>–emperor-on-demand-directory &lt;dir&gt;<a class="headerlink" href="#emperor-on-demand-directory-dir" title="Permalink to this headline">¶</a></h3>
<p>This is a less-versatile approach supporting only UNIX sockets. Basically the
name (without extension and path) of the vassal is appended to the specified
directory + the .socket extension and used as the on-demand socket:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --emperor /etc/uwsgi/vassals --emperor-on-demand-directory /var/tmp
</pre></div>
</div>
<p>using the previous example, the socket /var/tmp/myapp.socket will be
automatically bound.</p>
</div>
<div class="section" id="emperor-on-demand-exec-cmd">
<h3>–emperor-on-demand-exec &lt;cmd&gt;<a class="headerlink" href="#emperor-on-demand-exec-cmd" title="Permalink to this headline">¶</a></h3>
<p>This is most flexible solution for defining socket for on demand action and
(very probably) you will use it in very big deployments. Every time a new vassal
is added the supplied command is run passing full path to vassal config file as
the first argument. The STDOUT of the command is used as the socket name.</p>
</div>
</div>
<div class="section" id="using-on-demand-vassals-with-other-imperial-monitors">
<h2>Using on demand vassals with other imperial monitors<a class="headerlink" href="#using-on-demand-vassals-with-other-imperial-monitors" title="Permalink to this headline">¶</a></h2>
<p>For some imperial monitors, such as <code class="docutils literal notranslate"><span class="pre">pg://</span></code>, <code class="docutils literal notranslate"><span class="pre">mongodb://</span></code>, <code class="docutils literal notranslate"><span class="pre">zmq://</span></code> socket
for on demand activation is returned by imperial monitor by itself. For example
for <code class="docutils literal notranslate"><span class="pre">pg://</span></code> if executed on database query returns more than 5 fields, 6th
field will be used as socket for on demand activation. Check
<a class="reference internal" href="ImperialMonitors.html"><span class="doc">Imperial monitors</span></a> for more information.</p>
<p>For some imperial monitors, such as <code class="docutils literal notranslate"><span class="pre">amqp://</span></code>, socket activation is not
possible yet.</p>
</div>
<div class="section" id="combining-on-demand-vassals-with-idle-and-die-on-idle">
<h2>Combining on demand vassals with <code class="docutils literal notranslate"><span class="pre">--idle</span></code> and <code class="docutils literal notranslate"><span class="pre">--die-on-idle</span></code><a class="headerlink" href="#combining-on-demand-vassals-with-idle-and-die-on-idle" title="Permalink to this headline">¶</a></h2>
<p>For truly on demand applications, you can add to each vassal <code class="docutils literal notranslate"><span class="pre">--idle</span></code> and
<code class="docutils literal notranslate"><span class="pre">--die-on-idle</span></code> options. This will allow suspend or completely turn off
applications that are no longer requested. <code class="docutils literal notranslate"><span class="pre">--idle</span></code> without
<code class="docutils literal notranslate"><span class="pre">--die-on-idle</span></code> will work pretty much like without emperor, but adding
<code class="docutils literal notranslate"><span class="pre">--die-on-idle</span></code> will give you superpower for completely shutting down
applications and returning back to on-demand mode.</p>
<p>Emperor will simply put vassal back to on-demand mode when it dies gracefully
and turn it back on when there are any requests waiting or socket.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>As mentioned before, you should <strong>never</strong> put in your vassal config file
socket that was passed to emperor for on-demand mode. For unix sockets,
file path that socket lives on will be rewritten with new socket, but old
socket will be still connected to your emperor. Emperor will listen for
connections on that old socket, but all requests will arrive to new one.
That means, if your vassal will be shut down because of idle state, it will
be <strong>never</strong> put back on (emperor won’t receive any connections for
on-demand socket).</p>
<p>For tcp socket, that can cause each request to be handled <strong>twice</strong>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">On demand vassals (socket activation)</a><ul>
<li><a class="reference internal" href="#on-demand-vassals-with-filesystem-based-imperial-monitors">On demand vassals with filesystem-based imperial monitors</a><ul>
<li><a class="reference internal" href="#emperor-on-demand-extension-ext">–emperor-on-demand-extension &lt;ext&gt;</a></li>
<li><a class="reference internal" href="#emperor-on-demand-directory-dir">–emperor-on-demand-directory &lt;dir&gt;</a></li>
<li><a class="reference internal" href="#emperor-on-demand-exec-cmd">–emperor-on-demand-exec &lt;cmd&gt;</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-on-demand-vassals-with-other-imperial-monitors">Using on demand vassals with other imperial monitors</a></li>
<li><a class="reference internal" href="#combining-on-demand-vassals-with-idle-and-die-on-idle">Combining on demand vassals with <code class="docutils literal notranslate"><span class="pre">--idle</span></code> and <code class="docutils literal notranslate"><span class="pre">--die-on-idle</span></code></a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="EmperorProtocol.html"
                        title="previous chapter">The Emperor protocol</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Broodlord.html"
                        title="next chapter">Auto-scaling with Broodlord mode</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/OnDemandVassals.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Broodlord.html" title="Auto-scaling with Broodlord mode"
             >next</a> |</li>
        <li class="right" >
          <a href="EmperorProtocol.html" title="The Emperor protocol"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Emperor.html" >The uWSGI Emperor – multi-app deployment</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>