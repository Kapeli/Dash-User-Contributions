
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>The GridFS plugin &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="The GlusterFS plugin" href="GlusterFS.html" />
    <link rel="prev" title="uWSGI V8 support" href="V8.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="GlusterFS.html" title="The GlusterFS plugin"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="V8.html" title="uWSGI V8 support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-gridfs-plugin">
<h1>The GridFS plugin<a class="headerlink" href="#the-gridfs-plugin" title="Permalink to this headline">¶</a></h1>
<p>Beginning in uWSGI 1.9.5 a “GridFS” plugin is available. It exports both a
request handler and an internal routing function.  Its official modifier is
‘25’. The routing instruction is “gridfs” The plugin is written in C++.</p>
<div class="section" id="requirements-and-install">
<h2>Requirements and install<a class="headerlink" href="#requirements-and-install" title="Permalink to this headline">¶</a></h2>
<p>To build the plugin you need the <code class="docutils literal notranslate"><span class="pre">libmongoclient</span></code> headers (and a functioning
C++ compiler). On a Debian-like system you can do the following.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt-get install mongodb-dev g++
</pre></div>
</div>
<p>A build profile for gridfs is available:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">UWSGI_PROFILE</span><span class="o">=</span>gridfs make
</pre></div>
</div>
<p>Or you can build it as plugin:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>python uwsgiconfig.py --plugin plugins/gridfs
</pre></div>
</div>
<p>For a fast installation of a monolithic build you can use the network
installer:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl http://uwsgi.it/install <span class="p">|</span> bash -s gridfs /tmp/uwsgi
</pre></div>
</div>
<p>This will install a gridfs enabled uwsgi binary.</p>
</div>
<div class="section" id="standalone-quickstart">
<h2>Standalone quickstart<a class="headerlink" href="#standalone-quickstart" title="Permalink to this headline">¶</a></h2>
<p>This is a standalone config that blindly maps the incoming <code class="docutils literal notranslate"><span class="pre">PATH_INFO</span></code> to
items in the GridFS db named “test”:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; you can remove the plugin directive if you are using a uWSGI gridfs monolithic build</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">gridfs</span>
<span class="c1">; bind to http port 9090</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="c1">; force the modifier to be the 25th</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="c1">; map gridfs requests to the &quot;test&quot; db</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">db=test</span>
</pre></div>
</div>
<p>Assuming you have the myfile.txt file stored in your GridFS as “/myfile.txt”,
run the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -D /dev/stdout http://localhost:9090/myfile.txt
</pre></div>
</div>
<p>and you should be able to get it.</p>
</div>
<div class="section" id="the-initial-slash-problem">
<h2>The initial slash problem<a class="headerlink" href="#the-initial-slash-problem" title="Permalink to this headline">¶</a></h2>
<p>Generally <code class="docutils literal notranslate"><span class="pre">PATH_INFO</span></code> is prefixed with a ‘/’. This could cause problems in
GridFS path resolution if you are not storing the items with absolute path
names. To counteract this, you can make the <code class="docutils literal notranslate"><span class="pre">gridfs</span></code> plugin to skip the
initial slash:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; you can remove the plugin directive if you are using a uWSGI gridfs monolithic build</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">gridfs</span>
<span class="c1">; bind to http port 9090</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="c1">; force the modifier to be the 25th</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="c1">; map gridfs requests to the &quot;test&quot; db</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">db=test,skip_slash=1</span>
</pre></div>
</div>
<p>Now instead of searching for /myfile.txt it will search for “myfile.txt”.</p>
</div>
<div class="section" id="multiple-mountpoints-and-servers">
<h2>Multiple mountpoints (and servers)<a class="headerlink" href="#multiple-mountpoints-and-servers" title="Permalink to this headline">¶</a></h2>
<p>You can mount different GridFS databases under different SCRIPT_NAME (or
UWSGI_APPID). If your web server is able to correctly manage the
<code class="docutils literal notranslate"><span class="pre">SCRIPT_NAME</span></code> variable you do not need any additional setup (other than
–gridfs-mount). Otherwise don’t forget to add the –manage-script-name option</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="c1">; you can remove the plugin directive if you are using a uWSGI gridfs monolithic build</span>
<span class="na">plugin</span> <span class="o">=</span> <span class="s">gridfs</span>
<span class="c1">; bind to http port 9090</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="c1">; force the modifier to be the 25th</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="c1">; map gridfs requests to the &quot;test&quot; db</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">db=test,skip_slash=1</span>
<span class="c1">; map /foo to db &quot;wolverine&quot; on server 192.168.173.17:4040</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">mountpoint=/foo,server=192.168.173.17:4040,db=wolverine</span>
<span class="c1">; map /bar to db &quot;storm&quot; on server 192.168.173.30:4040</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">mountpoint=/bar,server=192.168.173.30:4040,db=storm</span>
<span class="c1">; force management of the SCRIPT_NAME variable</span>
<span class="na">manage-script-name</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -D /dev/stdout http://localhost:9090/myfile.txt
curl -D /dev/stdout http://localhost:9090/foo/myfile.txt
curl -D /dev/stdout http://localhost:9090/bar/myfile.txt
</pre></div>
</div>
<p>This way each request will map to a different GridFS server.</p>
</div>
<div class="section" id="replica-sets">
<h2>Replica sets<a class="headerlink" href="#replica-sets" title="Permalink to this headline">¶</a></h2>
<p>If you are using a replica set, you can use it in your uWSGI config with this
syntax: &lt;replica&gt;server1,server2,serverN…</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=rs0/ubuntu64.local\,raring64.local\,mrspurr-2.local,db=test</span>
</pre></div>
</div>
<p>Pay attention to the backslashes used to escape the server list.</p>
</div>
<div class="section" id="prefixes">
<h2>Prefixes<a class="headerlink" href="#prefixes" title="Permalink to this headline">¶</a></h2>
<p>As well as removing the initial slash, you may need to prefix each item name:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=rs0/ubuntu64.local\,raring64.local\,mrspurr-2.local,db=test,prefix=/foobar___</span>
</pre></div>
</div>
<p>A request for /test.txt will be mapped to /foobar___/test.txt</p>
<p>while</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=rs0/ubuntu64.local\,raring64.local\,mrspurr-2.local,db=test,prefix=/foobar___,skip_slash=1</span>
</pre></div>
</div>
<p>will map to /foobar___test.txt</p>
</div>
<div class="section" id="mime-types-and-filenames">
<h2>MIME types and filenames<a class="headerlink" href="#mime-types-and-filenames" title="Permalink to this headline">¶</a></h2>
<p>By default the MIME type of the file is derived from the filename stored in
GridFS. This filename might not map to the effectively requested URI or you may
not want to set a <code class="docutils literal notranslate"><span class="pre">content_type</span></code> for your response. Or you may want to allow
some other system to set it.  If you want to disable MIME type generation just
add <code class="docutils literal notranslate"><span class="pre">no_mime=1</span></code> to the mount options.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=ubuntu64.local,db=test,skip_slash=1,no_mime=1</span>
</pre></div>
</div>
<p>If you want your response to set the filename using the original value (the one
stored in GridFS) add <code class="docutils literal notranslate"><span class="pre">orig_filename=1</span></code></p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=ubuntu64.local,db=test,skip_slash=1,no_mime=1,orig_filename=1</span>
</pre></div>
</div>
</div>
<div class="section" id="timeouts">
<h2>Timeouts<a class="headerlink" href="#timeouts" title="Permalink to this headline">¶</a></h2>
<p>You can set the timeout of the low-level MongoDB operations by adding
<code class="docutils literal notranslate"><span class="pre">timeout=N</span></code> to the options:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="c1">; set a 3 seconds timeout</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=ubuntu64.local,db=test,skip_slash=1,timeout=3</span>
</pre></div>
</div>
</div>
<div class="section" id="md5-and-etag-headers">
<h2>MD5 and ETag headers<a class="headerlink" href="#md5-and-etag-headers" title="Permalink to this headline">¶</a></h2>
<p>GridFS stores an MD5 hash of each file. You can add this info to your response
headers both as ETag (MD5 in hex format) or Content-MD5 (in Base64).  Use
<code class="docutils literal notranslate"><span class="pre">etag=1</span></code> for adding ETag header and <code class="docutils literal notranslate"><span class="pre">md5=1</span></code> for adding Content-MD5. There’s
nothing stopping you from adding both headers to the response.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="c1">; set a 3 seconds timeout</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=ubuntu64.local,db=test,skip_slash=1,timeout=3,etag=1,md5=1</span>
</pre></div>
</div>
</div>
<div class="section" id="multithreading">
<h2>Multithreading<a class="headerlink" href="#multithreading" title="Permalink to this headline">¶</a></h2>
<p>The plugin is fully thread-safe, so consider using multiple threads for
improving concurrency:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">http-socket</span> <span class="o">=</span> <span class="s">:9090</span>
<span class="na">http-socket-modifier1</span> <span class="o">=</span> <span class="s">25</span>
<span class="c1">; set a 3 seconds timeout</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=ubuntu64.local,db=test,skip_slash=1,timeout=3,etag=1,md5=1</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">threads</span> <span class="o">=</span> <span class="s">8</span>
</pre></div>
</div>
<p>This will spawn 2 processes monitored by the master with 8 threads each for a
total of 16 threads.</p>
</div>
<div class="section" id="combining-with-nginx">
<h2>Combining with Nginx<a class="headerlink" href="#combining-with-nginx" title="Permalink to this headline">¶</a></h2>
<p>This is not different from the other plugins:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">include</span> <span class="n">uwsgi_params</span><span class="p">;</span>
    <span class="n">uwsgi_pass</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">3031</span><span class="p">;</span>
    <span class="n">uwsgi_modifier1</span> <span class="mi">25</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Just be sure to set the <code class="docutils literal notranslate"><span class="pre">uwsgi_modifier1</span></code> value to ensure all requests get
routed to GridFS.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">127.0.0.1:3031</span>
<span class="na">gridfs-mount</span> <span class="o">=</span> <span class="s">server=ubuntu64.local,db=test,skip_slash=1,timeout=3,etag=1,md5=1</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">2</span>
<span class="na">threads</span> <span class="o">=</span> <span class="s">8</span>
</pre></div>
</div>
</div>
<div class="section" id="the-gridfs-internal-routing-action">
<h2>The ‘gridfs’ internal routing action<a class="headerlink" href="#the-gridfs-internal-routing-action" title="Permalink to this headline">¶</a></h2>
<p>The plugin exports a ‘gridfs’ action simply returning an item:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">127.0.0.1:3031</span>
<span class="na">route</span> <span class="o">=</span> <span class="s">^/foo/(.+).jpg gridfs:server=192.168.173.17,db=test,itemname=$1.jpg</span>
</pre></div>
</div>
<p>The options are the same as the request plugin’s, with “itemname” being the
only addition. It specifies the name of the object in the GridFS db.</p>
</div>
<div class="section" id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>If you do not specify a server address, 127.0.0.1:27017 is assumed.</p></li>
<li><p>The use of the plugin in async modes is not officially supported, but may work.</p></li>
<li><p>If you do not get why a request is not serving your GridFS item, consider
adding the <code class="docutils literal notranslate"><span class="pre">--gridfs-debug</span></code> option. It will print the requested item in uWSGI
logs.</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">The GridFS plugin</a><ul>
<li><a class="reference internal" href="#requirements-and-install">Requirements and install</a></li>
<li><a class="reference internal" href="#standalone-quickstart">Standalone quickstart</a></li>
<li><a class="reference internal" href="#the-initial-slash-problem">The initial slash problem</a></li>
<li><a class="reference internal" href="#multiple-mountpoints-and-servers">Multiple mountpoints (and servers)</a></li>
<li><a class="reference internal" href="#replica-sets">Replica sets</a></li>
<li><a class="reference internal" href="#prefixes">Prefixes</a></li>
<li><a class="reference internal" href="#mime-types-and-filenames">MIME types and filenames</a></li>
<li><a class="reference internal" href="#timeouts">Timeouts</a></li>
<li><a class="reference internal" href="#md5-and-etag-headers">MD5 and ETag headers</a></li>
<li><a class="reference internal" href="#multithreading">Multithreading</a></li>
<li><a class="reference internal" href="#combining-with-nginx">Combining with Nginx</a></li>
<li><a class="reference internal" href="#the-gridfs-internal-routing-action">The ‘gridfs’ internal routing action</a></li>
<li><a class="reference internal" href="#notes">Notes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="V8.html"
                        title="previous chapter">uWSGI V8 support</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="GlusterFS.html"
                        title="next chapter">The GlusterFS plugin</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/GridFS.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="GlusterFS.html" title="The GlusterFS plugin"
             >next</a> |</li>
        <li class="right" >
          <a href="V8.html" title="uWSGI V8 support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>