
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Auto-scaling with Broodlord mode &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Zerg mode" href="Zerg.html" />
    <link rel="prev" title="On demand vassals (socket activation)" href="OnDemandVassals.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Zerg.html" title="Zerg mode"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="OnDemandVassals.html" title="On demand vassals (socket activation)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="auto-scaling-with-broodlord-mode">
<h1>Auto-scaling with Broodlord mode<a class="headerlink" href="#auto-scaling-with-broodlord-mode" title="Permalink to this headline">¶</a></h1>
<p>Broodlord (taken from Starcraft, like <a class="reference internal" href="Zerg.html"><span class="doc">Zerg mode</span></a> mode) is a way for a vassal to
ask for “reinforcements” to the Emperor. “Reinforcements” are new vassals spawned on demand generally
bound on the same socket. Broodlord mode alone is not very useful. However, when combined with <a class="reference internal" href="Zerg.html"><span class="doc">Zerg mode</span></a>, <span class="xref std std-doc">Idle</span> and <a class="reference internal" href="Emperor.html"><span class="doc">The uWSGI Emperor – multi-app deployment</span></a>
it can be used to implement auto-scaling for your apps.</p>
<p>WARNING: If you are looking for a way to dynamically adapt the number of workers of an instance, check the <a class="reference internal" href="Cheaper.html"><span class="doc">The uWSGI cheaper subsystem – adaptive process spawning</span></a> mode, Broodlord mode is for spawning totally new instances.</p>
<div class="section" id="a-simple-example">
<h2>A ‘simple’ example<a class="headerlink" href="#a-simple-example" title="Permalink to this headline">¶</a></h2>
<p>We’ll start apps with a single worker, adding resources on demand.  Broodlord
mode expects an additional stanza in your config file to be used for zergs.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">:3031</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">vassal-sos-backlog</span> <span class="o">=</span> <span class="s">10</span>
<span class="na">module</span> <span class="o">=</span> <span class="s">werkzeug.testapp:test_app</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">zerg-server</span> <span class="o">=</span> <span class="s">/tmp/broodlord.sock</span>
<span class="na">disable-logging</span> <span class="o">=</span> <span class="s">true</span>

<span class="k">[zerg]</span>
<span class="na">zerg</span> <span class="o">=</span> <span class="s">/tmp/broodlord.sock</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">module</span> <span class="o">=</span> <span class="s">werkzeug.testapp:test_app</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">1</span>
<span class="na">disable-logging</span> <span class="o">=</span> <span class="s">true</span>
<span class="na">idle</span> <span class="o">=</span> <span class="s">30</span>
<span class="na">die-on-idle</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">vassal-sos-backlog</span></code> option (supported only on Linux and TCP sockets)
will ask the Emperor for zergs when the listen queue is higher than the given
value. By default the value is 10. More “vassal-sos-” options will be added in
the future to allow for more specific detect-overload systems.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">[zerg]</span></code> stanza is the config the Emperor will run when a vassal requires
resources.  The <code class="docutils literal notranslate"><span class="pre">die-on-idle</span></code> option will completely destroy the zerg when
inactive for more than 30 seconds.  This configuration shows how to combine the
various uWSGI features to implement different means of scaling.  To run the
Emperor we need to specify how many zerg instances can be run:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>uwsgi --emperor /etc/vassals --emperor-broodlord <span class="m">40</span>
</pre></div>
</div>
<p>This will allow you to run up to 40 additional zerg workers for your apps.</p>
</div>
<div class="section" id="vassal-sos">
<h2><cite>–vassal-sos</cite><a class="headerlink" href="#vassal-sos" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This flag has been added in 2.0.7.</p>
</div>
<p><cite>–vassal-sos</cite> allows the vassal to ask for reinforcement as soon as all of its workers are busy.</p>
<p>The option takes an integer value, the number of seconds to wait between asking for a new reinforcements.</p>
</div>
<div class="section" id="manually-asking-for-reinforcement">
<h2>Manually asking for reinforcement<a class="headerlink" href="#manually-asking-for-reinforcement" title="Permalink to this headline">¶</a></h2>
<p>You can use the master FIFO’s “B” command to force an instance to ask for reinforcements from the Emperor.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> B &gt; /var/run/master.fifo
</pre></div>
</div>
</div>
<div class="section" id="under-the-hood-or-hacking-broodlord-mode">
<h2>Under the hood (or: hacking broodlord mode)<a class="headerlink" href="#under-the-hood-or-hacking-broodlord-mode" title="Permalink to this headline">¶</a></h2>
<p>Technically broodlord mode is a simple message sent by a vassal to “force” the Emperor to spawn another vassal with a ‘:zerg’ suffix in the instance name.</p>
<p>Even if the suffix is ‘:zerg’ this does not mean you need to use Zerg mode. A ‘zerg’ instance could be a completely independent one that simply subscribes
to a router, or binds to a SO_REUSEPORT socket.</p>
<p>This is an example with subscription system.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">127.0.0.1:0</span>
<span class="na">subscribe2</span> <span class="o">=</span> <span class="s">server=127.0.0.1:4040,key=foobar.it</span>
<span class="na">psgi</span> <span class="o">=</span> <span class="s">app.pl</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">4</span>
<span class="na">vassal-sos</span> <span class="o">=</span> <span class="s">3</span>

<span class="k">[zerg]</span>
<span class="na">socket</span> <span class="o">=</span> <span class="s">127.0.0.1:0</span>
<span class="na">subscribe2</span> <span class="o">=</span> <span class="s">server=127.0.0.1:4040,key=foobar.it</span>
<span class="na">psgi</span> <span class="o">=</span> <span class="s">app.pl</span>
<span class="na">idle</span> <span class="o">=</span> <span class="s">60</span>
<span class="na">processes</span> <span class="o">=</span> <span class="s">1</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Auto-scaling with Broodlord mode</a><ul>
<li><a class="reference internal" href="#a-simple-example">A ‘simple’ example</a></li>
<li><a class="reference internal" href="#vassal-sos"><cite>–vassal-sos</cite></a></li>
<li><a class="reference internal" href="#manually-asking-for-reinforcement">Manually asking for reinforcement</a></li>
<li><a class="reference internal" href="#under-the-hood-or-hacking-broodlord-mode">Under the hood (or: hacking broodlord mode)</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="OnDemandVassals.html"
                        title="previous chapter">On demand vassals (socket activation)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Zerg.html"
                        title="next chapter">Zerg mode</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Broodlord.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Zerg.html" title="Zerg mode"
             >next</a> |</li>
        <li class="right" >
          <a href="OnDemandVassals.html" title="On demand vassals (socket activation)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>