
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Using Linux KSM in uWSGI &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Jailing your apps using Linux Namespaces" href="Namespaces.html" />
    <link rel="prev" title="Running uWSGI in a Linux CGroup" href="Cgroups.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Namespaces.html" title="Jailing your apps using Linux Namespaces"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Cgroups.html" title="Running uWSGI in a Linux CGroup"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-linux-ksm-in-uwsgi">
<h1>Using Linux KSM in uWSGI<a class="headerlink" href="#using-linux-ksm-in-uwsgi" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://www.linux-kvm.org/page/KSM">Kernel Samepage Merging</a> is a feature of
Linux kernels &gt;= 2.6.32 which allows processes to share pages of memory with
the same content. This is accomplished by a kernel daemon that periodically
performs scans, comparisons, and, if possible, merges of specific memory areas.
Born as an enhancement for KVM it can be used for processes that use common data
(such as uWSGI processes with language interpreters and standard libraries).</p>
<p>If you are lucky, using KSM may exponentially reduce the memory usage of your
uWSGI instances. Especially in massive <a class="reference internal" href="Emperor.html"><span class="doc">Emperor</span></a> deployments:
enabling KSM for each vassal may result in massive memory savings.
KSM in uWSGI was the idea of Giacomo Bagnoli of <a class="reference external" href="http://www.asidev.com/en/company.html">Asidev s.r.l.</a>. Many thanks to him.</p>
<div class="section" id="enabling-the-ksm-daemon">
<h2>Enabling the KSM daemon<a class="headerlink" href="#enabling-the-ksm-daemon" title="Permalink to this headline">¶</a></h2>
<p>To enable the KSM daemon (<code class="docutils literal notranslate"><span class="pre">ksmd</span></code>), simply set <code class="docutils literal notranslate"><span class="pre">/sys/kernel/mm/ksm/run</span></code> to 1,
like so:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="m">1</span> &gt; /sys/kernel/mm/ksm/run
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember to do this on machine startup, as the KSM daemon does not run by
default.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>KSM is an opt-in feature that has to be explicitly requested by processes,
so just enabling KSM will not be a savior for everything on your machine.</p>
</div>
</div>
<div class="section" id="enabling-ksm-support-in-uwsgi">
<h2>Enabling KSM support in uWSGI<a class="headerlink" href="#enabling-ksm-support-in-uwsgi" title="Permalink to this headline">¶</a></h2>
<p>If you have compiled uWSGI on a kernel with KSM support, you will be able to
use the <code class="docutils literal notranslate"><span class="pre">ksm</span></code> option. This option will instruct uWSGI to register process
memory mappings (via <code class="docutils literal notranslate"><span class="pre">madvise</span></code> syscall) after each request or master cycle.
If no page mapping has changed from the last scan, no expensive syscalls are
used.</p>
</div>
<div class="section" id="performance-impact">
<h2>Performance impact<a class="headerlink" href="#performance-impact" title="Permalink to this headline">¶</a></h2>
<p>Checking for process mappings requires parsing the <code class="docutils literal notranslate"><span class="pre">/proc/self/maps</span></code> file
after each request. In some setups this may hurt performance. You can tune the
frequency of the uWSGI page scanner by passing an argument to the <code class="docutils literal notranslate"><span class="pre">ksm</span></code>
option.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Scan for process mappings every 10 requests (or 10 master cycles)</span>
./uwsgi -s :3031 -M -p <span class="m">8</span> -w myapp --ksm<span class="o">=</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="section" id="check-if-ksm-is-working-well">
<h2>Check if KSM is working well<a class="headerlink" href="#check-if-ksm-is-working-well" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">/sys/kernel/mm/ksm/pages_shared</span></code> and <code class="docutils literal notranslate"><span class="pre">/sys/kernel/mm/ksm/pages_sharing</span></code>
files contain statistics regarding KSM’s efficiency. The higher values, the
less memory consumption for your uWSGI instances.</p>
<div class="section" id="ksm-statistics-with-collectd">
<h3>KSM statistics with collectd<a class="headerlink" href="#ksm-statistics-with-collectd" title="Permalink to this headline">¶</a></h3>
<p>A simple Bash script like this is useful for keeping an eye on KSM’s efficiency:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">export</span> <span class="nv">LC_ALL</span><span class="o">=</span>C

<span class="k">if</span> <span class="o">[</span> -e /sys/kernel/mm/ksm/pages_sharing <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">pages_sharing</span><span class="o">=</span><span class="sb">`</span>cat /sys/kernel/mm/ksm/pages_sharing<span class="sb">`</span><span class="p">;</span>
    <span class="nv">page_size</span><span class="o">=</span><span class="sb">`</span>getconf PAGESIZE<span class="sb">`</span><span class="p">;</span>
    <span class="nv">saved</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;scale=0;</span><span class="nv">$pages_sharing</span><span class="s2"> * </span><span class="nv">$page_size</span><span class="s2">&quot;</span><span class="p">|</span>bc<span class="k">)</span><span class="p">;</span>
    <span class="nb">echo</span> <span class="s2">&quot;PUTVAL &lt;%= cn %&gt;/ksm/gauge-saved interval=60 N:</span><span class="nv">$saved</span><span class="s2">&quot;</span>
<span class="k">fi</span>
</pre></div>
</div>
<p>In your <a class="reference external" href="http://collectd.org/">collectd</a> configuration, add something like
this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">LoadPlugin exec</span>
<span class="na">&lt;Plugin exec&gt;</span>
   <span class="na">Exec &quot;nobody&quot; &quot;/usr/local/bin/ksm_stats.sh&quot;</span>
<span class="na">&lt;/Plugin&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using Linux KSM in uWSGI</a><ul>
<li><a class="reference internal" href="#enabling-the-ksm-daemon">Enabling the KSM daemon</a></li>
<li><a class="reference internal" href="#enabling-ksm-support-in-uwsgi">Enabling KSM support in uWSGI</a></li>
<li><a class="reference internal" href="#performance-impact">Performance impact</a></li>
<li><a class="reference internal" href="#check-if-ksm-is-working-well">Check if KSM is working well</a><ul>
<li><a class="reference internal" href="#ksm-statistics-with-collectd">KSM statistics with collectd</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Cgroups.html"
                        title="previous chapter">Running uWSGI in a Linux CGroup</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Namespaces.html"
                        title="next chapter">Jailing your apps using Linux Namespaces</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/KSM.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Namespaces.html" title="Jailing your apps using Linux Namespaces"
             >next</a> |</li>
        <li class="right" >
          <a href="Cgroups.html" title="Running uWSGI in a Linux CGroup"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>