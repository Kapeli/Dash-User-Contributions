
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Systemd &#8212; uWSGI 2.0 documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Running uWSGI instances with Circus" href="Circus.html" />
    <link rel="prev" title="Running uWSGI via Upstart" href="Upstart.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Circus.html" title="Running uWSGI instances with Circus"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Upstart.html" title="Running uWSGI via Upstart"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="systemd">
<h1>Systemd<a class="headerlink" href="#systemd" title="Permalink to this headline">¶</a></h1>
<p>uWSGI is a new-style daemon for <a class="reference external" href="http://www.freedesktop.org/wiki/Software/systemd">systemd</a>.</p>
<p>It can notify status change and readyness.</p>
<p>When uWSGI detects it is running under systemd, the notification system is enabled.</p>
<div class="section" id="adding-the-emperor-to-systemd">
<h2>Adding the Emperor to systemd<a class="headerlink" href="#adding-the-emperor-to-systemd" title="Permalink to this headline">¶</a></h2>
<p>One approach to integrate uWSGI apps with your init system is using the <a class="reference internal" href="Emperor.html"><span class="doc">Emperor</span></a>.</p>
<p>Your init system will talk only with the Emperor that will rule all of the apps itself.</p>
<p>Create a systemd service file (you can save it as /etc/systemd/system/emperor.uwsgi.service)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be careful with some systemd versions (e.g. 215 in Debian Jessie), since SIGQUIT signal will trash the systemd services. Use KillSignal=SIGTERM + “die-on-term” UWSGI option there.</p>
</div>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">uWSGI Emperor</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target</span>

<span class="k">[Service]</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/root/uwsgi/uwsgi --ini /etc/uwsgi/emperor.ini</span>
<span class="c1"># Requires systemd version 211 or newer</span>
<span class="na">RuntimeDirectory</span><span class="o">=</span><span class="s">uwsgi</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span>
<span class="na">KillSignal</span><span class="o">=</span><span class="s">SIGQUIT</span>
<span class="na">Type</span><span class="o">=</span><span class="s">notify</span>
<span class="na">StandardError</span><span class="o">=</span><span class="s">syslog</span>
<span class="na">NotifyAccess</span><span class="o">=</span><span class="s">all</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
</div>
<p>Then run it</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl start emperor.uwsgi.service
</pre></div>
</div>
<p>And check its status.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl status emperor.uwsgi.service
</pre></div>
</div>
<p>You will see the Emperor reporting the number of governed vassals to systemd (and to you).</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>emperor.uwsgi.service - uWSGI Emperor
 Loaded: loaded <span class="o">(</span>/etc/systemd/system/emperor.uwsgi.service<span class="o">)</span>
       Active: active <span class="o">(</span>running<span class="o">)</span> since Tue, <span class="m">17</span> May <span class="m">2011</span> <span class="m">08</span>:51:31 +0200<span class="p">;</span> 5s ago
Main PID: <span class="m">30567</span> <span class="o">(</span>uwsgi<span class="o">)</span>
       Status: <span class="s2">&quot;The Emperor is governing 1 vassals&quot;</span>
       CGroup: <span class="nv">name</span><span class="o">=</span>systemd:/system/emperor.uwsgi.service
               ├ <span class="m">30567</span> /root/uwsgi/uwsgi --ini /etc/uwsgi/emperor.ini
               ├ <span class="m">30568</span> /root/uwsgi/uwsgi --ini werkzeug.ini
               └ <span class="m">30569</span> /root/uwsgi/uwsgi --ini werkzeug.ini
</pre></div>
</div>
<p>You can stop the Emperor (and all the apps it governs) with</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl stop emperor.uwsgi.service
</pre></div>
</div>
<p>A simple <code class="docutils literal notranslate"><span class="pre">emperor.ini</span></code> could look like this (www-data is just an anonymous user)</p>
<p>NOTE: DO NOT daemonize the Emperor (or the master) unless you know what you are doing!!!</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">emperor</span> <span class="o">=</span> <span class="s">/etc/uwsgi/vassals</span>
<span class="na">uid</span> <span class="o">=</span> <span class="s">www-data</span>
<span class="na">gid</span> <span class="o">=</span> <span class="s">www-data</span>
</pre></div>
</div>
<p>If you want to allow each vassal to run under different privileges, remove the <code class="docutils literal notranslate"><span class="pre">uid</span></code> and <code class="docutils literal notranslate"><span class="pre">gid</span></code> options from the emperor configuration (and please read the Emperor docs!)</p>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>Using the previous service file all of the Emperor messages go to the syslog. You can avoid it by removing the <code class="docutils literal notranslate"><span class="pre">StandardError=syslog</span></code> directive.</p>
<p>If you do that, be sure to set a <code class="docutils literal notranslate"><span class="pre">--logto</span></code> option in your Emperor configuration, otherwise all of your logs will be lost!</p>
</div>
<div class="section" id="putting-sockets-in-run">
<h2>Putting sockets in /run/<a class="headerlink" href="#putting-sockets-in-run" title="Permalink to this headline">¶</a></h2>
<p>On a modern system, /run/ is mounted as a tmpfs and is the right place to put sockets and pidfiles into. To have systemd automatically create a /run/uwsgi/ subdirectory with the correct user/group ownership, as well as cleaning up the directory when the daemon is stopped, add</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">RuntimeDirectory</span><span class="o">=</span><span class="s">uwsgi</span>
</pre></div>
</div>
<p>to the [Service] section of your systemd uwsgi unit file. This <code class="docutils literal notranslate"><span class="pre">RuntimeDirectory</span></code> parameter requires systemd version 211 or newer. For older versions of systemd, create a systemd-tmpfiles configuration file (you can save it as /etc/tmpfiles.d/emperor.uwsgi.conf):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">d /run/uwsgi 0755 www-data www-data -</span>
</pre></div>
</div>
</div>
<div class="section" id="socket-activation">
<h2>Socket activation<a class="headerlink" href="#socket-activation" title="Permalink to this headline">¶</a></h2>
<p>Starting from uWSGI 0.9.8.3 socket activation is available. You can setup systemd to spawn uWSGI instances only after the first socket connection.</p>
<p>Create the required emperor.uwsgi.socket (in <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/emperor.uwsgi.socket</span></code>). Note that the <a href="#id2"><span class="problematic" id="id3">*</span></a>.socket file name must match the <a href="#id4"><span class="problematic" id="id5">*</span></a>.service file name.</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Socket for uWSGI Emperor</span>

<span class="k">[Socket]</span>
<span class="c1"># Change this to your uwsgi application port or unix socket location</span>
<span class="na">ListenStream</span><span class="o">=</span><span class="s">/tmp/uwsgid.sock</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">sockets.target</span>
</pre></div>
</div>
<p>Then disable the service and enable the socket unit.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl disable emperor.uwsgi.service</span>
<span class="c1"># systemctl enable emperor.uwsgi.socket</span>
</pre></div>
</div>
<p>When using Systemd socket activation, you do not need to specify any socket in your uWSGI configuration;
the instance will inherit the socket from Systemd.</p>
<p>To have uWSGI serve HTTP (instead of the binary uwsgi protocol) under Systemd socket activation,
set <code class="docutils literal notranslate"><span class="pre">protocol</span></code> to <code class="docutils literal notranslate"><span class="pre">http</span></code>; for instance, in an INI, do this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">protocol</span> <span class="o">=</span> <span class="s">http</span>
<span class="na">wsgi</span> <span class="o">=</span> <span class="s">...</span>
<span class="na">...</span>
</pre></div>
</div>
</div>
<div class="section" id="one-service-per-app-in-systemd">
<h2>One service per app in systemd<a class="headerlink" href="#one-service-per-app-in-systemd" title="Permalink to this headline">¶</a></h2>
<p>Another approach is to let systemd handle starting individual apps while taking
advantage of systemd template unit files, and of course socket activation. Each
app will run under its own user.</p>
<p><code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/uwsgi-app&#64;.socket</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Socket for uWSGI app %i</span>

<span class="k">[Socket]</span>
<span class="na">ListenStream</span><span class="o">=</span><span class="s">/var/run/uwsgi/%i.socket</span>
<span class="na">SocketUser</span><span class="o">=</span><span class="s">www-%i</span>
<span class="na">SocketGroup</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">SocketMode</span><span class="o">=</span><span class="s">0660</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">sockets.target</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/uwsgi-app&#64;.service</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">%i uWSGI app</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target</span>

<span class="k">[Service]</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/uwsgi \</span>
<span class="s">        --ini /etc/uwsgi/apps-available/%i.ini \</span>
<span class="s">        --socket /var/run/uwsgi/%i.socket</span>
<span class="na">User</span><span class="o">=</span><span class="s">www-%i</span>
<span class="na">Group</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
<span class="na">KillSignal</span><span class="o">=</span><span class="s">SIGQUIT</span>
<span class="na">Type</span><span class="o">=</span><span class="s">notify</span>
<span class="na">StandardError</span><span class="o">=</span><span class="s">syslog</span>
<span class="na">NotifyAccess</span><span class="o">=</span><span class="s">all</span>
</pre></div>
</div>
<p>Now, adding a new app to your system is a matter of creating the appropriate
user and enabling the socket and the service. For instance, if one were to
configure cgit:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>adduser www-cgit --disabled-login --disabled-password <span class="se">\</span>
  --ingroup www-data --home /var/lib/www/cgit --shell /bin/false
systemctl <span class="nb">enable</span> uwsgi-app@cgit.socket
systemctl <span class="nb">enable</span> uwsgi-app@cgit.service
systemctl start uwsgi-app@cgit.socket
</pre></div>
</div>
<p>Then configure the ini file <code class="docutils literal notranslate"><span class="pre">/etc/uwsgi/apps-available/cgit.ini</span></code>:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[uwsgi]</span>
<span class="na">master</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">cheap</span> <span class="o">=</span> <span class="s">True</span>
<span class="na">idle</span> <span class="o">=</span> <span class="s">600</span>
<span class="na">die-on-idle</span> <span class="o">=</span> <span class="s">True # If app is not used often, it will exit and be launched</span>
<span class="s">                   # again by systemd requested by users.</span>

<span class="na">manage-script-name</span> <span class="o">=</span> <span class="s">True</span>

<span class="na">plugins</span> <span class="o">=</span> <span class="s">0:cgi</span>
<span class="na">cgi</span> <span class="o">=</span> <span class="s">/usr/lib/cgit/cgit.cgi</span>
</pre></div>
</div>
<p>And last, if applicable, configure your HTTP server the usual way.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Systemd</a><ul>
<li><a class="reference internal" href="#adding-the-emperor-to-systemd">Adding the Emperor to systemd</a></li>
<li><a class="reference internal" href="#logging">Logging</a></li>
<li><a class="reference internal" href="#putting-sockets-in-run">Putting sockets in /run/</a></li>
<li><a class="reference internal" href="#socket-activation">Socket activation</a></li>
<li><a class="reference internal" href="#one-service-per-app-in-systemd">One service per app in systemd</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Upstart.html"
                        title="previous chapter">Running uWSGI via Upstart</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Circus.html"
                        title="next chapter">Running uWSGI instances with Circus</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/Systemd.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Circus.html" title="Running uWSGI instances with Circus"
             >next</a> |</li>
        <li class="right" >
          <a href="Upstart.html" title="Running uWSGI via Upstart"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">uWSGI 2.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2016, uWSGI.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>