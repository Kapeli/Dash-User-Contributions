
<!DOCTYPE html>

<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>GPU Shader Module (gpu) — Blender Python API</title>
<link href="_static/favicon.ico" rel="shortcut icon"/>
<link href="https://docs.blender.org/api/current/gpu.html" rel="canonical"/>
<script src="_static/js/modernizr.min.js" type="text/javascript"></script>
<script data-url_root="./" id="documentation_options" src="_static/documentation_options.js" type="text/javascript"></script>
<script src="_static/jquery.js" type="text/javascript"></script>
<script src="_static/underscore.js" type="text/javascript"></script>
<script src="_static/doctools.js" type="text/javascript"></script>
<script src="_static/language_data.js" type="text/javascript"></script>
<script src="_static/js/theme.js" type="text/javascript"></script>
<link href="_static/opensearch.xml" rel="search" title="Search within Blender Python API" type="application/opensearchdescription+xml"/>
<link href="_static/css/theme.css" rel="stylesheet" type="text/css"/>
<link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="_static/css/theme_overrides.css" rel="stylesheet" type="text/css"/>
<link href="genindex.html" rel="index" title="Index"/>
<link href="search.html" rel="search" title="Search"/>
<link href="gpu.types.html" rel="next" title="GPU Types (gpu.types)"/>
<link href="blf.html" rel="prev" title="Font Drawing (blf)"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="index.html"> Blender 2.80 Python API
          

          
            
            <img alt="Logo" class="logo" src="_static/blender_logo.svg"/>
</a>
<div class="version">
                f6cb5f54494e
              </div>
<div role="search">
<form action="search.html" class="wy-form" id="rtd-search-form" method="get">
<input name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="info_quickstart.html">Quickstart: new to Blender or scripting and want to get your feet wet?</a></li>
<li class="toctree-l1"><a class="reference internal" href="info_overview.html">API Overview: a more complete explanation of Python integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="info_api_reference.html">API Reference Usage: examples of how to use the API reference docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="info_best_practice.html">Best Practice: Conventions to follow for writing good scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="info_tips_and_tricks.html">Tips and Tricks: Hints to help you while writing scripts for Blender</a></li>
<li class="toctree-l1"><a class="reference internal" href="info_gotcha.html">Gotcha's: some of the problems you may come up against when writing scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="change_log.html">List of changes since last Blender release</a></li>
</ul>
<p class="caption"><span class="caption-text">Application Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="bpy.context.html">Context Access (bpy.context)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.data.html">Data Access (bpy.data)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.ops.html">Operators (bpy.ops)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.types.html">Types (bpy.types)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.utils.html">Utilities (bpy.utils)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.utils.previews.html">bpy.utils submodule (bpy.utils.previews)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.path.html">Path Utilities (bpy.path)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.app.html">Application Data (bpy.app)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy.props.html">Property Definitions (bpy.props)</a></li>
</ul>
<p class="caption"><span class="caption-text">Standalone Modules</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="mathutils.html">Math Types &amp; Utilities (mathutils)</a></li>
<li class="toctree-l1"><a class="reference internal" href="freestyle.html">Freestyle Module (freestyle)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bgl.html">OpenGL Wrapper (bgl)</a></li>
<li class="toctree-l1"><a class="reference internal" href="blf.html">Font Drawing (blf)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">GPU Shader Module (gpu)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu_extras.html">GPU Utilities (gpu_extras)</a></li>
<li class="toctree-l1"><a class="reference internal" href="aud.html">Audio System (aud)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bpy_extras.html">Extra Utilities (bpy_extras)</a></li>
<li class="toctree-l1"><a class="reference internal" href="idprop.types.html">ID Property Access (idprop.types)</a></li>
<li class="toctree-l1"><a class="reference internal" href="bmesh.html">BMesh Module (bmesh)</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="index.html">Blender 2.80 Python API</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a href="index.html">Docs</a> »</li>
<li>GPU Shader Module (gpu)</li>
<li class="wy-breadcrumbs-aside">
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="section" id="module-gpu">
<span id="gpu-shader-module-gpu"></span><h1><a name="//apple_ref/cpp/Module/gpu"></a>GPU Shader Module (gpu)<a class="headerlink" href="#module-gpu" title="Permalink to this headline">¶</a></h1>
<p>This module provides Python wrappers for the GPU implementation in Blender. Some higher level functions can be found in the <cite>gpu_extras</cite> module.</p>
<p>Submodules:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="gpu.types.html">GPU Types (gpu.types)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.shader.html">GPU Shader (gpu.shader)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.matrix.html">GPU Matrix (gpu.matrix)</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.select.html">GPU Select (gpu.select)</a></li>
</ul>
</div>
<div class="section" id="geometry-batches">
<h2>Geometry Batches<a class="headerlink" href="#geometry-batches" title="Permalink to this headline">¶</a></h2>
<p>Geometry is drawn in batches.
A batch contains the necessary data to perform the drawing.
That includes an obligatory <em>Vertex Buffer</em> and an optional <em>Index Buffer</em>,
each of which is described in more detail in the following sections.
A batch also defines a draw type.
Typical draw types are <cite>POINTS</cite>, <cite>LINES</cite> and <cite>TRIS</cite>.
The draw type determines how the data will be interpreted and drawn.</p>
</div>
<div class="section" id="vertex-buffers">
<h2>Vertex Buffers<a class="headerlink" href="#vertex-buffers" title="Permalink to this headline">¶</a></h2>
<p>A <em>Vertex Buffer Object</em> (VBO) (<a class="reference internal" href="gpu.types.html#gpu.types.GPUVertBuf" title="gpu.types.GPUVertBuf"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.types.GPUVertBuf</span></code></a>)
is an array that contains the vertex attributes needed for drawing using a specific shader.
Typical vertex attributes are <em>location</em>, <em>normal</em>, <em>color</em>, and <em>uv</em>.
Every vertex buffer has a <em>Vertex Format</em> (<a class="reference internal" href="gpu.types.html#gpu.types.GPUVertFormat" title="gpu.types.GPUVertFormat"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.types.GPUVertFormat</span></code></a>)
and a length corresponding to the number of vertices in the buffer.
A vertex format describes the attributes stored per vertex and their types.</p>
<p>The following code demonstrates the creation of a vertex buffer that contains 6 vertices.
For each vertex 2 attributes will be stored: The position and the normal.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gpu</span>
<span class="n">vertex_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>
<span class="n">vertex_normals</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="o">...</span><span class="p">]</span>

<span class="n">fmt</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUVertFormat</span><span class="p">()</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">attr_add</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"pos"</span><span class="p">,</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">'F32'</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fetch_mode</span><span class="o">=</span><span class="s1">'FLOAT'</span><span class="p">)</span>
<span class="n">fmt</span><span class="o">.</span><span class="n">attr_add</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"normal"</span><span class="p">,</span> <span class="n">comp_type</span><span class="o">=</span><span class="s1">'F32'</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fetch_mode</span><span class="o">=</span><span class="s1">'FLOAT'</span><span class="p">)</span>

<span class="n">vbo</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUVertBuf</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
<span class="n">vbo</span><span class="o">.</span><span class="n">attr_fill</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"pos"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">vertex_positions</span><span class="p">)</span>
<span class="n">vbo</span><span class="o">.</span><span class="n">attr_fill</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"normal"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">vertex_normals</span><span class="p">)</span>
</pre></div>
</div>
<p>This vertex buffer could be used to draw 6 points, 3 separate lines, 5 consecutive lines, 2 separate triangles, …
E.g. in the case of lines, each two consecutive vertices define a line.
The type that will actually be drawn is determined when the batch is created later.</p>
</div>
<div class="section" id="index-buffers">
<h2>Index Buffers<a class="headerlink" href="#index-buffers" title="Permalink to this headline">¶</a></h2>
<p>Often triangles and lines share one or more vertices.
With only a vertex buffer one would have to store all attributes for the these vertices multiple times.
This is very inefficient because in a connected triangle mesh every vertex is used 6 times on average.
A more efficient approach would be to use an <em>Index Buffer</em> (IBO) (<a class="reference internal" href="gpu.types.html#gpu.types.GPUIndexBuf" title="gpu.types.GPUIndexBuf"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.types.GPUIndexBuf</span></code></a>),
sometimes referred to as <em>Element Buffer</em>.
An <em>Index Buffer</em> is an array that references vertices based on their index in the vertex buffer.</p>
<p>For instance, to draw a rectangle composed of two triangles, one could use an index buffer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">positions</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">indices</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">ibo</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUIndexBuf</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">'TRIS'</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
</pre></div>
</div>
<p>Here the first tuple in <cite>indices</cite> describes which vertices should be used for the first triangle
(same for the second tuple).
Note how the diagonal vertices 1 and 2 are shared between both triangles.</p>
</div>
<div class="section" id="shaders">
<h2>Shaders<a class="headerlink" href="#shaders" title="Permalink to this headline">¶</a></h2>
<p>A shader is a program that runs on the GPU (written in GLSL in our case).
There are multiple types of shaders.
The most important ones are <em>Vertex Shaders</em> and <em>Fragment Shaders</em>.
Typically multiple shaders are linked together into a <em>Program</em>.
However, in the Blender Python API the term <em>Shader</em> refers to an OpenGL Program.
Every <a class="reference internal" href="gpu.types.html#gpu.types.GPUShader" title="gpu.types.GPUShader"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.types.GPUShader</span></code></a> consists of a vertex shader, a fragment shader and an optional geometry shader.
For common drawing tasks there are some built-in shaders accessible from <a class="reference internal" href="gpu.shader.html#gpu.shader.from_builtin" title="gpu.shader.from_builtin"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.shader.from_builtin</span></code></a>
with an identifier such as <cite>2D_UNIFORM_COLOR</cite> or <cite>3D_FLAT_COLOR</cite>.</p>
<p>Every shader defines a set of attributes and uniforms that have to be set in order to use the shader.
Attributes are properties that are set using a vertex buffer and can be different for individual vertices.
Uniforms are properties that are constant per draw call.
They can be set using the <cite>shader.uniform_*</cite> functions after the shader has been bound.</p>
</div>
<div class="section" id="batch-creation">
<h2>Batch Creation<a class="headerlink" href="#batch-creation" title="Permalink to this headline">¶</a></h2>
<p>Batches can be creates by first manually creating VBOs and IBOs.
However, it is recommended to use the <a class="reference internal" href="gpu_extras.batch.html#gpu_extras.batch.batch_for_shader" title="gpu_extras.batch.batch_for_shader"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu_extras.batch.batch_for_shader</span></code></a> function.
It makes sure that all the vertex attributes necessary for a specific shader are provided.
Consequently, the shader has to be passed to the function as well.
When using this function one rarely has to care about the vertex format, VBOs and IBOs created in the background.
This is still something one should know when drawing stuff though.</p>
<p>Since batches can be drawn multiple times, they should be cached and reused whenever possible.</p>
</div>
<div class="section" id="offscreen-rendering">
<h2>Offscreen Rendering<a class="headerlink" href="#offscreen-rendering" title="Permalink to this headline">¶</a></h2>
<p>What one can see on the screen after rendering is called the <em>Front Buffer</em>.
When draw calls are issued, batches are drawn on a <em>Back Buffer</em> that will only be displayed
when all drawing is done and the current back buffer will become the new front buffer.
Sometimes, one might want to draw the batches into a distinct buffer that could be used as
texture to display on another object or to be saved as image on disk.
This is called Offscreen Rendering.
In Blender Offscreen Rendering is done using the <a class="reference internal" href="gpu.types.html#gpu.types.GPUOffScreen" title="gpu.types.GPUOffScreen"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.types.GPUOffScreen</span></code></a> type.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><cite>GPUOffScreen</cite> objects are bound to the OpenGL context they have been created in.
This means that once Blender discards this context (i.e. the window is closed),
the offscreen instance will be freed.</p>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>To try these examples, just copy them into Blenders text editor and execute them.
To keep the examples relatively small, they just register a draw function that can’t easily be removed anymore.
Blender has to be restarted in order to delete the draw handlers.</p>
<div class="section" id="d-lines-with-single-color">
<h3>3D Lines with Single Color<a class="headerlink" href="#d-lines-with-single-color" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">shader</span><span class="o">.</span><span class="n">from_builtin</span><span class="p">(</span><span class="s1">'3D_UNIFORM_COLOR'</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s1">'LINES'</span><span class="p">,</span> <span class="p">{</span><span class="s2">"pos"</span><span class="p">:</span> <span class="n">coords</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"color"</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_VIEW'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="triangle-with-custom-shader">
<h3>Triangle with Custom Shader<a class="headerlink" href="#triangle-with-custom-shader" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">vertex_shader</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">    uniform mat4 viewProjectionMatrix;</span>

<span class="s1">    in vec3 position;</span>
<span class="s1">    out vec3 pos;</span>

<span class="s1">    void main()</span>
<span class="s1">    {</span>
<span class="s1">        pos = position;</span>
<span class="s1">        gl_Position = viewProjectionMatrix * vec4(position, 1.0f);</span>
<span class="s1">    }</span>
<span class="s1">'''</span>

<span class="n">fragment_shader</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">    uniform float brightness;</span>

<span class="s1">    in vec3 pos;</span>

<span class="s1">    void main()</span>
<span class="s1">    {</span>
<span class="s1">        gl_FragColor = vec4(pos * brightness, 1.0);</span>
<span class="s1">    }</span>
<span class="s1">'''</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUShader</span><span class="p">(</span><span class="n">vertex_shader</span><span class="p">,</span> <span class="n">fragment_shader</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s1">'TRIS'</span><span class="p">,</span> <span class="p">{</span><span class="s2">"position"</span><span class="p">:</span> <span class="n">coords</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">region_data</span><span class="o">.</span><span class="n">perspective_matrix</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"viewProjectionMatrix"</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"brightness"</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_VIEW'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="wireframe-cube-using-index-buffer">
<h3>Wireframe Cube using Index Buffer<a class="headerlink" href="#wireframe-cube-using-index-buffer" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span>

<span class="n">indices</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">shader</span><span class="o">.</span><span class="n">from_builtin</span><span class="p">(</span><span class="s1">'3D_UNIFORM_COLOR'</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s1">'LINES'</span><span class="p">,</span> <span class="p">{</span><span class="s2">"pos"</span><span class="p">:</span> <span class="n">coords</span><span class="p">},</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"color"</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_VIEW'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mesh-with-random-vertex-colors">
<h3>Mesh with Random Vertex Colors<a class="headerlink" href="#mesh-with-random-vertex-colors" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">active_object</span><span class="o">.</span><span class="n">data</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">calc_loop_triangles</span><span class="p">()</span>

<span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">'f'</span><span class="p">)</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">loop_triangles</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">'i'</span><span class="p">)</span>

<span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">foreach_get</span><span class="p">(</span>
    <span class="s2">"co"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">loop_triangles</span><span class="o">.</span><span class="n">foreach_get</span><span class="p">(</span>
    <span class="s2">"vertices"</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">loop_triangles</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">vertex_colors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">))]</span>

<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">shader</span><span class="o">.</span><span class="n">from_builtin</span><span class="p">(</span><span class="s1">'3D_SMOOTH_COLOR'</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span>
    <span class="n">shader</span><span class="p">,</span> <span class="s1">'TRIS'</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">"pos"</span><span class="p">:</span> <span class="n">vertices</span><span class="p">,</span> <span class="s2">"color"</span><span class="p">:</span> <span class="n">vertex_colors</span><span class="p">},</span>
    <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_VIEW'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="d-rectangle">
<h3>2D Rectangle<a class="headerlink" href="#d-rectangle" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">vertices</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>

<span class="n">indices</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">shader</span><span class="o">.</span><span class="n">from_builtin</span><span class="p">(</span><span class="s1">'2D_UNIFORM_COLOR'</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s1">'TRIS'</span><span class="p">,</span> <span class="p">{</span><span class="s2">"pos"</span><span class="p">:</span> <span class="n">vertices</span><span class="p">},</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"color"</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_PIXEL'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="d-image">
<h3>2D Image<a class="headerlink" href="#d-image" title="Permalink to this headline">¶</a></h3>
<p>To use this example you have to provide an image that should be displayed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">import</span> <span class="nn">bgl</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">IMAGE_NAME</span> <span class="o">=</span> <span class="s2">"Untitled"</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">IMAGE_NAME</span><span class="p">]</span>

<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">shader</span><span class="o">.</span><span class="n">from_builtin</span><span class="p">(</span><span class="s1">'2D_IMAGE'</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span>
    <span class="n">shader</span><span class="p">,</span> <span class="s1">'TRI_FAN'</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">"pos"</span><span class="p">:</span> <span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)),</span>
        <span class="s2">"texCoord"</span><span class="p">:</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">gl_load</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_TEXTURE0</span><span class="p">)</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">bindcode</span><span class="p">)</span>

    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_int</span><span class="p">(</span><span class="s2">"image"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_PIXEL'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-a-texture-using-offscreen-rendering">
<h3>Generate a texture using Offscreen Rendering<a class="headerlink" href="#generate-a-texture-using-offscreen-rendering" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Create an <a class="reference internal" href="gpu.types.html#gpu.types.GPUOffScreen" title="gpu.types.GPUOffScreen"><code class="xref py py-class docutils literal notranslate"><span class="pre">gpu.types.GPUOffScreen</span></code></a> object.</li>
<li>Draw some circles into it.</li>
<li>Make a new shader for drawing a planar texture in 3D.</li>
<li>Draw the generated texture using the new shader.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">import</span> <span class="nn">bgl</span>
<span class="kn">from</span> <span class="nn">mathutils</span> <span class="k">import</span> <span class="n">Matrix</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>
<span class="kn">from</span> <span class="nn">gpu_extras.presets</span> <span class="k">import</span> <span class="n">draw_circle_2d</span>

<span class="c1"># Create and fill offscreen</span>
<span class="c1">##########################################</span>

<span class="n">offscreen</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUOffScreen</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>

<span class="k">with</span> <span class="n">offscreen</span><span class="o">.</span><span class="n">bind</span><span class="p">():</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glClear</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_COLOR_BUFFER_BIT</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gpu</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">push_pop</span><span class="p">():</span>
        <span class="c1"># reset matrices -&gt; use normalized device coordinates [-1, 1]</span>
        <span class="n">gpu</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">load_matrix</span><span class="p">(</span><span class="n">Matrix</span><span class="o">.</span><span class="n">Identity</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">gpu</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">load_projection_matrix</span><span class="p">(</span><span class="n">Matrix</span><span class="o">.</span><span class="n">Identity</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">amount</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">amount</span><span class="p">,</span> <span class="n">amount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x_pos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">amount</span>
            <span class="n">draw_circle_2d</span><span class="p">((</span><span class="n">x_pos</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>


<span class="c1"># Drawing the generated texture in 3D space</span>
<span class="c1">#############################################</span>

<span class="n">vertex_shader</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">    uniform mat4 modelMatrix;</span>
<span class="s1">    uniform mat4 viewProjectionMatrix;</span>

<span class="s1">    in vec2 position;</span>
<span class="s1">    in vec2 uv;</span>

<span class="s1">    out vec2 uvInterp;</span>

<span class="s1">    void main()</span>
<span class="s1">    {</span>
<span class="s1">        uvInterp = uv;</span>
<span class="s1">        gl_Position = viewProjectionMatrix * modelMatrix * vec4(position, 0.0, 1.0);</span>
<span class="s1">    }</span>
<span class="s1">'''</span>

<span class="n">fragment_shader</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">    uniform sampler2D image;</span>

<span class="s1">    in vec2 uvInterp;</span>

<span class="s1">    void main()</span>
<span class="s1">    {</span>
<span class="s1">        gl_FragColor = texture(image, uvInterp);</span>
<span class="s1">    }</span>
<span class="s1">'''</span>

<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUShader</span><span class="p">(</span><span class="n">vertex_shader</span><span class="p">,</span> <span class="n">fragment_shader</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span>
    <span class="n">shader</span><span class="p">,</span> <span class="s1">'TRI_FAN'</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">"position"</span><span class="p">:</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="s2">"uv"</span><span class="p">:</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="p">},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glActiveTexture</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_TEXTURE0</span><span class="p">)</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glBindTexture</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">offscreen</span><span class="o">.</span><span class="n">color_texture</span><span class="p">)</span>

    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"modelMatrix"</span><span class="p">,</span> <span class="n">Matrix</span><span class="o">.</span><span class="n">Translation</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">@</span> <span class="n">Matrix</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"viewProjectionMatrix"</span><span class="p">,</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">region_data</span><span class="o">.</span><span class="n">perspective_matrix</span><span class="p">)</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"image"</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_VIEW'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="copy-offscreen-rendering-result-back-to-ram">
<h3>Copy Offscreen Rendering result back to RAM<a class="headerlink" href="#copy-offscreen-rendering-result-back-to-ram" title="Permalink to this headline">¶</a></h3>
<p>This will create a new image with the given name.
If it already exists, it will override the existing one.</p>
<p>Currently almost all of the execution time is spent in the last line.
In the future this will hopefully be solved by implementing the Python buffer protocol
for <a class="reference internal" href="bgl.html#bgl.Buffer" title="bgl.Buffer"><code class="xref py py-class docutils literal notranslate"><span class="pre">bgl.Buffer</span></code></a> and <a class="reference internal" href="bpy.types.Image.html#bpy.types.Image.pixels" title="bpy.types.Image.pixels"><code class="xref py py-class docutils literal notranslate"><span class="pre">bpy.types.Image.pixels</span></code></a> (aka <code class="docutils literal notranslate"><span class="pre">bpy_prop_array</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">import</span> <span class="nn">bgl</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">mathutils</span> <span class="k">import</span> <span class="n">Matrix</span>
<span class="kn">from</span> <span class="nn">gpu_extras.presets</span> <span class="k">import</span> <span class="n">draw_circle_2d</span>

<span class="n">IMAGE_NAME</span> <span class="o">=</span> <span class="s2">"Generated Image"</span>
<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">RING_AMOUNT</span> <span class="o">=</span> <span class="mi">10</span>


<span class="n">offscreen</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUOffScreen</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>

<span class="k">with</span> <span class="n">offscreen</span><span class="o">.</span><span class="n">bind</span><span class="p">():</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glClear</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_COLOR_BUFFER_BIT</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gpu</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">push_pop</span><span class="p">():</span>
        <span class="c1"># reset matrices -&gt; use normalized device coordinates [-1, 1]</span>
        <span class="n">gpu</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">load_matrix</span><span class="p">(</span><span class="n">Matrix</span><span class="o">.</span><span class="n">Identity</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">gpu</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">load_projection_matrix</span><span class="p">(</span><span class="n">Matrix</span><span class="o">.</span><span class="n">Identity</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RING_AMOUNT</span><span class="p">):</span>
            <span class="n">draw_circle_2d</span><span class="p">(</span>
                <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">bgl</span><span class="o">.</span><span class="n">Buffer</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_BYTE</span><span class="p">,</span> <span class="n">WIDTH</span> <span class="o">*</span> <span class="n">HEIGHT</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glReadBuffer</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_BACK</span><span class="p">)</span>
    <span class="n">bgl</span><span class="o">.</span><span class="n">glReadPixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="n">bgl</span><span class="o">.</span><span class="n">GL_RGBA</span><span class="p">,</span> <span class="n">bgl</span><span class="o">.</span><span class="n">GL_UNSIGNED_BYTE</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>

<span class="n">offscreen</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">IMAGE_NAME</span> <span class="ow">in</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
    <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">IMAGE_NAME</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">IMAGE_NAME</span><span class="p">]</span>
<span class="n">image</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>
<span class="n">image</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="o">/</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">buffer</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="rendering-the-3d-view-into-a-texture">
<h3>Rendering the 3D View into a Texture<a class="headerlink" href="#rendering-the-3d-view-into-a-texture" title="Permalink to this headline">¶</a></h3>
<p>The scene has to have a camera for this example to work.
You could also make this independent of a specific camera,
but Blender does not expose good functions to create view and projection matrices yet.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">bgl</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">from</span> <span class="nn">gpu_extras.presets</span> <span class="k">import</span> <span class="n">draw_texture_2d</span>

<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">256</span>

<span class="n">offscreen</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUOffScreen</span><span class="p">(</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span>
    <span class="n">scene</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">scene</span>

    <span class="n">view_matrix</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span>

    <span class="n">projection_matrix</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">camera</span><span class="o">.</span><span class="n">calc_matrix_camera</span><span class="p">(</span>
        <span class="n">context</span><span class="o">.</span><span class="n">evaluated_depsgraph_get</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">HEIGHT</span><span class="p">)</span>

    <span class="n">offscreen</span><span class="o">.</span><span class="n">draw_view3d</span><span class="p">(</span>
        <span class="n">scene</span><span class="p">,</span>
        <span class="n">context</span><span class="o">.</span><span class="n">view_layer</span><span class="p">,</span>
        <span class="n">context</span><span class="o">.</span><span class="n">space_data</span><span class="p">,</span>
        <span class="n">context</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
        <span class="n">view_matrix</span><span class="p">,</span>
        <span class="n">projection_matrix</span><span class="p">)</span>

    <span class="n">bgl</span><span class="o">.</span><span class="n">glDisable</span><span class="p">(</span><span class="n">bgl</span><span class="o">.</span><span class="n">GL_DEPTH_TEST</span><span class="p">)</span>
    <span class="n">draw_texture_2d</span><span class="p">(</span><span class="n">offscreen</span><span class="o">.</span><span class="n">color_texture</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_PIXEL'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-shader-for-dotted-3d-line">
<h3>Custom Shader for dotted 3D Line<a class="headerlink" href="#custom-shader-for-dotted-3d-line" title="Permalink to this headline">¶</a></h3>
<p>In this example the arc length (distance to the first point on the line) is calculated in every vertex.
Between the vertex and fragment shader that value is automatically interpolated
for all points that will be visible on the screen.
In the fragment shader the <code class="docutils literal notranslate"><span class="pre">sin</span></code> of the arc length is calculated.
Based on the result a decision is made on whether the fragment should be drawn or not.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">gpu</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">mathutils</span> <span class="k">import</span> <span class="n">Vector</span>
<span class="kn">from</span> <span class="nn">gpu_extras.batch</span> <span class="k">import</span> <span class="n">batch_for_shader</span>

<span class="n">vertex_shader</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">    uniform mat4 u_ViewProjectionMatrix;</span>

<span class="s1">    in vec3 position;</span>
<span class="s1">    in float arcLength;</span>

<span class="s1">    out float v_ArcLength;</span>

<span class="s1">    void main()</span>
<span class="s1">    {</span>
<span class="s1">        v_ArcLength = arcLength;</span>
<span class="s1">        gl_Position = u_ViewProjectionMatrix * vec4(position, 1.0f);</span>
<span class="s1">    }</span>
<span class="s1">'''</span>

<span class="n">fragment_shader</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">    uniform float u_Scale;</span>

<span class="s1">    in float v_ArcLength;</span>

<span class="s1">    void main()</span>
<span class="s1">    {</span>
<span class="s1">        if (step(sin(v_ArcLength * u_Scale), 0.5) == 1) discard;</span>
<span class="s1">        gl_FragColor = vec4(1.0);</span>
<span class="s1">    }</span>
<span class="s1">'''</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vector</span><span class="p">((</span><span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">(),</span> <span class="n">random</span><span class="p">()))</span> <span class="o">*</span> <span class="mi">5</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

<span class="n">arc_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">arc_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arc_lengths</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>

<span class="n">shader</span> <span class="o">=</span> <span class="n">gpu</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">GPUShader</span><span class="p">(</span><span class="n">vertex_shader</span><span class="p">,</span> <span class="n">fragment_shader</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">batch_for_shader</span><span class="p">(</span>
    <span class="n">shader</span><span class="p">,</span> <span class="s1">'LINE_STRIP'</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">"position"</span><span class="p">:</span> <span class="n">coords</span><span class="p">,</span> <span class="s2">"arcLength"</span><span class="p">:</span> <span class="n">arc_lengths</span><span class="p">},</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">draw</span><span class="p">():</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">region_data</span><span class="o">.</span><span class="n">perspective_matrix</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"u_ViewProjectionMatrix"</span><span class="p">,</span> <span class="n">matrix</span><span class="p">)</span>
    <span class="n">shader</span><span class="o">.</span><span class="n">uniform_float</span><span class="p">(</span><span class="s2">"u_Scale"</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>


<span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">SpaceView3D</span><span class="o">.</span><span class="n">draw_handler_add</span><span class="p">(</span><span class="n">draw</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">'WINDOW'</span><span class="p">,</span> <span class="s1">'POST_VIEW'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a accesskey="n" class="btn btn-neutral float-right" href="gpu.types.html" rel="next" title="GPU Types (gpu.types)">Next <span class="fa fa-arrow-circle-right"></span></a>
<a accesskey="p" class="btn btn-neutral float-left" href="blf.html" rel="prev" title="Font Drawing (blf)"><span class="fa fa-arrow-circle-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<p>
        © Copyright Blender Foundation
      <span class="lastupdated">
        Last updated on 07/29/2019.
      </span>
</p>
</div>
</footer>
</div>
</div>
</section>
</div>
<script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>
</body>
</html>